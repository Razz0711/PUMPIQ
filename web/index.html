<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexYpher — AI-Powered Crypto Intelligence</title>
    <meta name="description"
        content="NexYpher is an AI-powered crypto intelligence platform. Real-time analysis, smart trading signals, and market insights powered by multi-model AI.">
    <meta name="keywords" content="crypto, AI, trading, bitcoin, ethereum, solana, DeFi, market analysis, NexYpher">
    <meta property="og:title" content="NexYpher — AI-Powered Crypto Intelligence">
    <meta property="og:description"
        content="Real-time AI crypto analysis, trading signals, and market insights. Your unfair edge in crypto markets.">
    <meta property="og:url" content="https://nexypher.vercel.app">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="NexYpher">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NexYpher — AI-Powered Crypto Intelligence">
    <meta name="twitter:description" content="Real-time AI crypto analysis, trading signals, and market insights.">
    <link rel="canonical" href="https://nexypher.vercel.app">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/design-system.css?v=20260226">
    <style>
        /* ── CSS Reset & Variables ────────────────────────────────── */
        :root {
            --bg-primary: #0a0b0f;
            --bg-secondary: #111318;
            --bg-card: #111318;
            --bg-card-hover: #181c24;
            --border: rgba(255, 255, 255, 0.06);
            --text-primary: #e8eaed;
            --text-secondary: #9aa0ab;
            --text-muted: #5f6672;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.15);
            --green: #00d395;
            --green-bg: rgba(0, 211, 149, 0.1);
            --red: #ff4757;
            --red-bg: rgba(255, 71, 87, 0.1);
            --yellow: #f5a623;
            --purple: #8b5cf6;
            --cyan: #06d6dd;
            --gradient: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 14px;
            line-height: 1.6;
            letter-spacing: 0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a {
            color: var(--accent);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* ── Scrollbar ────────────────────────────────────────────── */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* ── Header ───────────────────────────────────────────────── */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10, 11, 15, 0.92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            padding: 8px 16px 12px;
            border-radius: 0;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.03em;
            transition: all 0.2s;
            border: none;
            background: none;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: transparent;
        }

        .nav-tab.active {
            color: var(--accent);
            background: transparent;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 8px;
            right: 8px;
            height: 2px;
            background: var(--accent);
            border-radius: 2px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-box {
            padding: 8px 14px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 13px;
            width: 220px;
            outline: none;
            transition: border 0.2s;
        }

        .search-box:focus {
            border-color: var(--accent);
        }

        .btn {
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--gradient);
            color: #fff;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            filter: brightness(1.1);
        }

        .btn-outline {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent-glow);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .btn-green {
            background: linear-gradient(135deg, #00d395, #00b37a);
            color: #fff;
            box-shadow: 0 2px 8px rgba(0, 211, 149, 0.15);
        }

        .btn-green:hover {
            box-shadow: 0 0 20px rgba(0, 211, 149, 0.3);
            filter: brightness(1.1);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #e03546);
            color: #fff;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.15);
        }

        .btn-danger:hover {
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
            filter: brightness(1.1);
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
        }

        /* ── Page Container ───────────────────────────────────────── */
        .page {
            display: none;
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page.active {
            display: block;
        }

        /* ── Hero Section ─────────────────────────────────────────── */
        .hero {
            text-align: left;
            padding: 48px 40px 40px;
        }

        .hero-tag {
            color: var(--green);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .hero-title {
            font-size: 42px;
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .hero-desc {
            color: var(--text-secondary);
            font-size: 15px;
            max-width: 640px;
            margin: 0 0 40px 0;
            line-height: 1.6;
        }

        .hero-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 100%;
            margin: 0;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 24px;
            text-align: left;
            transition: border 0.2s;
        }

        .step-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .step-num {
            color: var(--green);
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 12px;
        }

        .step-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .step-desc {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        /* ── Section Titles ───────────────────────────────────────── */
        .section-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .section-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* ── Cards Grid ───────────────────────────────────────────── */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .card:hover {
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.12);
        }

        /* ── Filter Tabs ──────────────────────────────────────────── */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-pill {
            padding: 6px 16px;
            border-radius: 999px;
            font-size: 13px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-pill:hover {
            color: var(--text-primary);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .filter-pill.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* ── Token Feed Table ─────────────────────────────────────── */
        .feed-table {
            width: 100%;
            border-collapse: collapse;
        }

        .feed-table th {
            text-align: left;
            padding: 10px 16px;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .feed-table td {
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 13px;
            vertical-align: middle;
        }

        .feed-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .token-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .token-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .token-name {
            font-weight: 600;
        }

        .token-symbol {
            color: var(--text-muted);
            font-size: 12px;
        }

        .price-positive {
            color: var(--green);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }

        .price-negative {
            color: var(--red);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }

        /* ── AI Recs ──────────────────────────────────────────────── */
        .market-summary-box {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .market-summary-box h4 {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .market-summary-box p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .toggle-row {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 14px 20px;
            flex: 1;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .simple-toggle {
            width: 40px;
            height: 22px;
            border-radius: 11px;
            background: var(--cyan);
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }

        .simple-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            transition: left 0.2s;
        }

        .simple-toggle.off {
            background: var(--text-muted);
        }

        .simple-toggle.off::after {
            left: 2px;
        }

        .simple-toggle:not(.off)::after {
            left: 20px;
        }

        .toggle-label {
            font-weight: 600;
            font-size: 14px;
        }

        .toggle-desc {
            color: var(--text-muted);
            font-size: 12px;
        }

        .score-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .score-circle {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            font-family: 'JetBrains Mono', monospace;
            color: #fff;
            position: absolute;
            top: 16px;
            right: 16px;
        }

        .score-green {
            background: linear-gradient(135deg, #00d395, #00b37a);
            box-shadow: 0 4px 16px rgba(0, 211, 149, 0.35);
        }

        .score-yellow {
            background: linear-gradient(135deg, #f5a623, #e09515);
            box-shadow: 0 4px 16px rgba(245, 166, 35, 0.35);
        }

        .score-red {
            background: linear-gradient(135deg, #ff4757, #e03546);
            box-shadow: 0 4px 16px rgba(255, 71, 87, 0.35);
        }

        .score-purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.35);
        }

        .score-card-name {
            font-weight: 700;
            font-size: 16px;
        }

        .score-card-sym {
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 10px;
        }

        .score-card-summary {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .verdict-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .verdict-STRONG_BUY,
        .verdict-BUY {
            background: rgba(0, 211, 149, 0.1);
            color: var(--green);
        }

        .verdict-HOLD {
            background: rgba(245, 166, 35, 0.1);
            color: var(--yellow);
        }

        .verdict-CAUTION {
            background: rgba(255, 71, 87, 0.1);
            color: var(--red);
        }

        .verdict-AVOID {
            background: rgba(255, 71, 87, 0.1);
            color: var(--red);
        }

        .on-chain-bars {
            margin-top: 10px;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .bar-label {
            font-size: 11px;
            color: var(--text-muted);
            width: 80px;
            flex-shrink: 0;
        }

        .bar-track {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
        }

        .bar-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--cyan);
        }

        /* ── Modal ────────────────────────────────────────────────── */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            padding: 32px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
        }

        .modal h2 {
            font-size: 22px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--accent);
        }

        .form-error {
            color: var(--red);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .form-divider {
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
            margin: 16px 0;
            position: relative;
        }

        .form-divider::before,
        .form-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: calc(50% - 20px);
            height: 1px;
            background: var(--border);
        }

        .form-divider::before {
            left: 0;
        }

        .form-divider::after {
            right: 0;
        }

        /* ── Detail Modal (larger) ────────────────────────────────── */
        .modal-lg {
            max-width: 720px;
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
        }

        .detail-name {
            font-size: 20px;
            font-weight: 700;
        }

        .detail-symbol {
            color: var(--text-muted);
            font-size: 13px;
        }

        .detail-price-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-price {
            font-size: 28px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-box {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 14px;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .metric-value {
            font-size: 15px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .analysis-section {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .analysis-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .analysis-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .score-bar-container {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin-top: 6px;
        }

        .score-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }

        .score-bar.green {
            background: var(--green);
        }

        .score-bar.yellow {
            background: var(--yellow);
        }

        .score-bar.red {
            background: var(--red);
        }

        .ai-box {
            background: var(--bg-card);
            border: 1px solid var(--purple);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 12px;
        }

        .ai-box-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .ai-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            background: var(--purple);
            color: #fff;
            margin-left: 8px;
        }

        .ai-text {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
        }

        /* ── Wallet Section ───────────────────────────────────────── */
        .wallet-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .wallet-addr {
            font-family: monospace;
            font-size: 13px;
            color: var(--accent);
        }

        .wallet-chain {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--accent-glow);
            color: var(--accent);
            font-weight: 600;
        }

        /* ── Wallet Balance Card ──────────────────────────────────── */
        .balance-card {
            background: linear-gradient(135deg, #0d0e14 0%, #0f1520 50%, #0a1510 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(124, 92, 255, 0.03);
        }

        .balance-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: #fff;
            margin-bottom: 16px;
        }

        .balance-amount .currency {
            font-size: 20px;
            color: #7c5cff;
            margin-right: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .balance-actions {
            display: flex;
            gap: 10px;
        }

        .balance-actions .btn {
            flex: 1;
            padding: 10px;
            font-size: 13px;
        }

        /* ── Bank Account Card ────────────────────────────────────── */
        .bank-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .bank-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bank-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #7c5cff, #00d4aa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .bank-name {
            font-weight: 600;
            font-size: 14px;
        }

        .bank-detail {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .bank-verified {
            color: #00d4aa;
            font-size: 11px;
            font-weight: 600;
        }

        /* ── Transaction List ─────────────────────────────────────── */
        .txn-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .txn-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .txn-deposit {
            background: #0a2a1a;
            color: #00d4aa;
        }

        .txn-withdraw {
            background: #2a1a1a;
            color: #ff6b6b;
        }

        .txn-amount {
            font-weight: 600;
            font-size: 14px;
        }

        /* ── Verification Steps ───────────────────────────────────── */
        .verify-steps {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }

        .verify-step {
            flex: 1;
            text-align: center;
            padding: 10px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .verify-step.active {
            border-color: #7c5cff;
            color: #7c5cff;
            background: rgba(124, 92, 255, 0.08);
        }

        .verify-step.done {
            border-color: #00d4aa;
            color: #00d4aa;
            background: rgba(0, 212, 170, 0.08);
        }

        /* ── Portfolio ────────────────────────────────────────────── */
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .portfolio-table th {
            text-align: left;
            padding: 10px 14px;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .portfolio-table td {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 14px;
        }

        /* ── Auto Trader ──────────────────────────────────────────── */
        .trader-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        @media(max-width:768px) {
            .trader-grid {
                grid-template-columns: 1fr;
            }
        }

        .trader-stat-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .trader-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .trader-stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 4px;
        }

        .trader-stat-sub {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .trader-header {
            background: linear-gradient(135deg, #0d1118 0%, #100d18 50%, #0d1510 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .trader-title {
            font-size: 24px;
            font-weight: 700;
        }

        .trader-title span {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-muted);
            margin-left: 8px;
        }

        .trader-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .trader-status.active {
            background: rgba(0, 211, 149, 0.12);
            color: var(--green);
            border: 1px solid rgba(0, 211, 149, 0.25);
        }

        .trader-status.inactive {
            background: rgba(255, 71, 87, 0.1);
            color: var(--red);
            border: 1px solid rgba(255, 71, 87, 0.2);
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            cursor: pointer;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            transition: all 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            left: 2px;
            bottom: 2px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: var(--green);
            border-color: var(--green);
        }

        .toggle-switch input:checked+.toggle-slider::before {
            transform: translateX(24px);
        }

        .position-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 10px;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .position-coin {
            font-weight: 700;
            font-size: 16px;
        }

        .position-badge {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        .position-badge.profit {
            background: rgba(0, 211, 149, 0.1);
            color: var(--green);
        }

        .position-badge.loss {
            background: rgba(255, 71, 87, 0.1);
            color: var(--red);
        }

        .position-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .position-details span {
            display: block;
        }

        .position-details strong {
            color: var(--text-primary);
            font-size: 13px;
        }

        .opp-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .opp-info {
            flex: 1;
        }

        .opp-name {
            font-weight: 600;
            font-size: 14px;
        }

        .opp-detail {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .opp-score {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            margin-left: 12px;
            flex-shrink: 0;
        }

        .opp-score.high {
            background: var(--green-bg);
            color: var(--green);
            border: 2px solid var(--green);
        }

        .opp-score.mid {
            background: rgba(245, 158, 11, 0.1);
            color: var(--yellow);
            border: 2px solid var(--yellow);
        }

        .opp-score.low {
            background: var(--red-bg);
            color: var(--red);
            border: 2px solid var(--red);
        }

        .log-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .log-time {
            color: var(--text-muted);
            font-size: 11px;
        }

        .log-event {
            font-weight: 600;
            margin: 0 6px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        @media(max-width:768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .setting-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
        }

        .setting-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .setting-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .setting-input:focus {
            border-color: var(--accent);
        }

        /* ── Trader Sub-tabs ──────────────────────────────────────── */
        .trader-subtabs {
            display: flex;
            gap: 0;
            margin-top: 20px;
            border-bottom: 2px solid var(--border);
        }

        .trader-subtab {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color .2s;
        }

        .trader-subtab:hover {
            color: var(--text-primary);
        }

        .trader-subtab.active {
            color: var(--accent);
        }

        .trader-subtab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            border-radius: 2px;
        }

        .trader-subpage {
            display: none;
            margin-top: 20px;
        }

        .trader-subpage.active {
            display: block;
        }

        /* ── Strategy Builder (inside trader) ─────────────────────── */
        .sb-row {
            display: grid;
            gap: 16px;
            margin-bottom: 16px;
        }

        .sb-row.two {
            grid-template-columns: 1fr 1fr;
        }

        .sb-row.three {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .sb-row.four {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }

        @media(max-width:900px) {

            .sb-row.two,
            .sb-row.three,
            .sb-row.four {
                grid-template-columns: 1fr;
            }
        }

        .sb-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .sb-card h4 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sb-card h4 .sb-icon {
            font-size: 18px;
        }

        .sb-check-group {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }

        .sb-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .sb-check input {
            accent-color: var(--accent);
        }

        .sb-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sb-pill {
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all .2s;
        }

        .sb-pill.active,
        .sb-pill:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .sb-pill.green.active {
            background: var(--green);
            border-color: var(--green);
        }

        .sb-pill.red.active {
            background: var(--red);
            border-color: var(--red);
        }

        .sb-pill input[type=radio] {
            display: none;
        }

        .sb-time-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .sb-time-row label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .sb-time-row input[type=time] {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .sb-day-pills {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .sb-day {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all .2s;
        }

        .sb-day.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .sb-field {
            margin-bottom: 12px;
        }

        .sb-field label {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .sb-field select,
        .sb-field input[type=number],
        .sb-field input[type=text] {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
        }

        .sb-field select:focus,
        .sb-field input:focus {
            border-color: var(--accent);
        }

        .sb-field .sb-hint {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Exchange card */
        .sb-exchange-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        @media(max-width:700px) {
            .sb-exchange-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .sb-exchange-opt {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            text-align: center;
            transition: all .2s;
            font-size: 12px;
            font-weight: 600;
        }

        .sb-exchange-opt:hover {
            border-color: var(--accent);
        }

        .sb-exchange-opt.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }

        .sb-exchange-opt .sb-fee {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
            font-weight: 400;
        }

        /* Leverage slider */
        .sb-leverage-wrap {
            margin-top: 8px;
        }

        .sb-leverage-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sb-leverage-bar input[type=range] {
            flex: 1;
            accent-color: var(--accent);
            height: 6px;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 3px;
        }

        .sb-leverage-bar input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .sb-leverage-val {
            min-width: 48px;
            text-align: center;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-weight: 700;
            font-size: 14px;
            color: var(--accent);
        }

        .sb-leverage-presets {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .sb-leverage-presets button {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all .15s;
        }

        .sb-leverage-presets button:hover,
        .sb-leverage-presets button.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .sb-liq-price {
            font-size: 12px;
            color: var(--yellow);
            margin-top: 6px;
        }

        /* Indicator tags */
        .sb-indicator-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sb-indicator {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sb-indicator:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .sb-indicator.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        .sb-indicator .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .sb-indicator .dot.green {
            background: var(--green);
        }

        .sb-indicator .dot.yellow {
            background: var(--yellow);
        }

        .sb-indicator .dot.red {
            background: var(--red);
        }

        .sb-indicator .dot.blue {
            background: var(--accent);
        }

        /* Condition builder */
        .sb-condition {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 13px;
        }

        .sb-condition select,
        .sb-condition input {
            padding: 5px 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .sb-condition .sb-cond-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            margin-left: auto;
        }

        .sb-condition .sb-cond-remove:hover {
            color: var(--red);
        }

        /* Kill switch */
        .sb-kill-switch {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .sb-kill-switch label {
            font-size: 13px;
            color: var(--text-secondary);
            flex: 1;
        }

        .sb-kill-switch input[type=number] {
            width: 70px;
            padding: 5px 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        /* Session blocks */
        .sb-session-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        @media(max-width:700px) {
            .sb-session-grid {
                grid-template-columns: 1fr;
            }
        }

        .sb-session {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all .2s;
        }

        .sb-session:hover {
            border-color: var(--accent);
        }

        .sb-session.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .sb-session .sb-session-name {
            font-weight: 700;
            margin-bottom: 2px;
        }

        .sb-session .sb-session-time {
            color: var(--text-muted);
            font-size: 11px;
        }

        /* Market regime */
        .sb-regime-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .sb-regime {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all .2s;
        }

        .sb-regime.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .sb-regime:hover {
            border-color: var(--accent);
        }

        /* Legs */
        .sb-leg {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .sb-leg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .sb-leg-title {
            font-weight: 700;
            font-size: 14px;
        }

        .sb-leg-tag {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            background: var(--accent);
            color: #fff;
            margin-left: 8px;
        }

        .sb-leg-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .sb-leg-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(16, 185, 129, 0.15);
            color: var(--green);
        }

        .sb-leg-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        @media(max-width:700px) {
            .sb-leg-grid {
                grid-template-columns: 1fr;
            }
        }

        .sb-leg-field label {
            font-size: 11px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
        }

        .sb-leg-field select,
        .sb-leg-field input[type=number] {
            width: 100%;
            padding: 7px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .sb-tab-pair {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .sb-tab-opt {
            flex: 1;
            padding: 7px 0;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            background: var(--bg-card);
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            transition: all .15s;
        }

        .sb-tab-opt.buy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--green);
        }

        .sb-tab-opt.sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        .sb-tab-opt.on {
            background: var(--accent);
            color: #fff;
        }

        .sb-num {
            display: flex;
            align-items: center;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .sb-num button {
            width: 32px;
            height: 34px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
        }

        .sb-num button:hover {
            background: var(--accent);
            color: #fff;
        }

        .sb-num input {
            width: 50px;
            text-align: center;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
            padding: 6px 0;
        }

        .sb-leg-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 6px;
        }

        .sb-leg-actions button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color .2s;
        }

        .sb-leg-actions button:hover {
            color: var(--red);
        }

        .sb-leg-actions button.clone:hover {
            color: var(--accent);
        }

        /* Strategies list */
        .strat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strat-info {
            flex: 1;
        }

        .strat-name {
            font-weight: 700;
            font-size: 15px;
        }

        .strat-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .strat-actions {
            display: flex;
            gap: 8px;
        }

        .strat-status-badge {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .strat-status-badge.active {
            background: rgba(0, 211, 149, 0.12);
            color: var(--green);
        }

        .strat-status-badge.paused {
            background: rgba(245, 166, 35, 0.12);
            color: var(--yellow);
        }

        /* ── Loader ───────────────────────────────────────────────── */
        .loader {
            display: flex;
            justify-content: center;
            padding: 60px;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        /* ── Skeleton Loading ─────────────────────────────────────── */
        .skeleton {
            position: relative;
            overflow: hidden;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
        }

        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%)
            }

            100% {
                transform: translateX(100%)
            }
        }

        .skeleton-row {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .skeleton-cell {
            height: 14px;
            border-radius: 4px;
        }

        .skeleton-cell.w-sm {
            width: 40px;
        }

        .skeleton-cell.w-md {
            width: 100px;
        }

        .skeleton-cell.w-lg {
            width: 180px;
        }

        .skeleton-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* ── Error State with Retry ───────────────────────────────── */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .error-state .error-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .error-state .error-msg {
            font-size: 14px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .retry-btn {
            padding: 8px 20px;
            border-radius: var(--radius-sm);
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .retry-btn:hover {
            opacity: 0.85;
        }

        /* ── Responsive ───────────────────────────────────────────── */
        @media (max-width:768px) {
            .hero-steps {
                grid-template-columns: 1fr;
            }

            .hero-title {
                font-size: 32px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .toggle-row {
                flex-direction: column;
            }

            .nav-tabs {
                display: none;
            }

            .header {
                padding: 0 12px;
            }
        }

        /* ── Toast Notifications ──────────────────────────────────── */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            color: #fff;
            min-width: 280px;
            max-width: 420px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 3.7s forwards;
            backdrop-filter: blur(12px);
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.9);
        }

        .toast.warning {
            background: rgba(245, 158, 11, 0.9);
        }

        .toast.info {
            background: rgba(99, 102, 241, 0.85);
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(40px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* ── NexYpher Chat Bot Widget ───────────────────────────────── */
        .bot-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c5cff, #00d4aa);
            border: none;
            cursor: pointer;
            color: #fff;
            font-size: 26px;
            box-shadow: 0 6px 24px rgba(124, 92, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .bot-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 32px rgba(124, 92, 255, 0.7);
        }

        .bot-fab.has-dot::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 10px;
            height: 10px;
            background: var(--green);
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
        }

        .bot-window {
            position: fixed;
            bottom: 90px;
            right: 24px;
            z-index: 9001;
            width: 400px;
            max-width: calc(100vw - 32px);
            height: 520px;
            max-height: calc(100vh - 120px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: none;
            flex-direction: column;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: botSlideIn 0.25s ease;
        }

        .bot-window.open {
            display: flex;
        }

        @keyframes botSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #7c5cff22, #00d4aa11);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bot-header-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c5cff, #00d4aa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .bot-header-info h3 {
            margin: 0;
            font-size: 15px;
            color: var(--text-primary);
        }

        .bot-header-info p {
            margin: 2px 0 0;
            font-size: 11px;
            color: var(--green);
        }

        .bot-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .bot-close:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .bot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }

        .bot-msg {
            max-width: 88%;
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 13.5px;
            line-height: 1.65;
            word-break: break-word;
        }

        .bot-msg.bot {
            align-self: flex-start;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
        }

        .bot-msg.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #7c5cff, #6347e0);
            border-bottom-right-radius: 4px;
            color: #fff;
        }

        .bot-msg.bot .bot-sources {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ── Bot Rich Content Styles ────────────────────────────────── */
        .bot-msg.bot h3 {
            font-size: 13.5px;
            font-weight: 700;
            margin: 14px 0 6px 0;
            color: var(--accent);
            letter-spacing: 0.2px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .bot-msg.bot h3:first-child {
            margin-top: 4px;
        }

        .bot-msg.bot table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0 12px;
            font-size: 12px;
            line-height: 1.5;
        }

        .bot-msg.bot thead th {
            text-align: left;
            padding: 6px 8px;
            font-weight: 600;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            background: rgba(124, 92, 255, 0.05);
        }

        .bot-msg.bot tbody td {
            padding: 5px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            color: var(--text-secondary);
            font-size: 12px;
        }

        .bot-msg.bot tbody tr:hover {
            background: rgba(124, 92, 255, 0.04);
        }

        .bot-msg.bot hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 12px 0;
        }

        .bot-msg.bot .bot-insight-box {
            background: rgba(124, 92, 255, 0.06);
            border: 1px solid rgba(124, 92, 255, 0.15);
            border-radius: 10px;
            padding: 10px 14px;
            margin: 8px 0;
            font-size: 12.5px;
            line-height: 1.6;
        }

        .bot-msg.bot .price-up {
            color: #10b981;
            font-weight: 600;
        }

        .bot-msg.bot .price-down {
            color: #ef4444;
            font-weight: 600;
        }

        .bot-msg.bot .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .bot-msg.bot .metric-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        .bot-msg.bot .metric-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 12.5px;
        }

        .bot-msg.bot .bot-footer {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 10.5px;
            color: var(--text-muted);
            font-style: italic;
            line-height: 1.5;
        }

        .bot-typing {
            align-self: flex-start;
            padding: 12px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            border-bottom-left-radius: 4px;
            display: none;
        }

        .bot-typing.show {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .bot-typing span {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: botDot 1.4s infinite;
        }

        .bot-typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .bot-typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes botDot {

            0%,
            60%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            30% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .bot-input-area {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--bg-primary);
        }

        .bot-input-area input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 13.5px;
            outline: none;
        }

        .bot-input-area input:focus {
            border-color: var(--accent);
        }

        .bot-input-area input::placeholder {
            color: var(--text-muted);
        }

        .bot-send {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #7c5cff, #00d4aa);
            color: #fff;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .bot-send:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .bot-send:hover:not(:disabled) {
            opacity: 0.9;
        }

        .bot-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 16px 12px;
        }

        .bot-chip {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        /* ══════════════════════════════════════════════════════════════ */
        /* MODULE SHOWCASE & ENHANCED FEATURES                          */
        /* ══════════════════════════════════════════════════════════════ */

        /* ── Live Stats Banner ────────────────────────────────────── */
        .live-stats-banner {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        @media(max-width:768px) {
            .live-stats-banner {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .live-stat-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .live-stat-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .live-stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }

        .live-stat-value {
            font-size: 28px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .live-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            margin-top: 4px;
        }

        .live-stat-change {
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }

        /* ── Module Showcase Grid ─────────────────────────────────── */
        .module-showcase {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        @media(max-width:900px) {
            .module-showcase {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media(max-width:600px) {
            .module-showcase {
                grid-template-columns: 1fr;
            }
        }

        .module-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .module-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .module-card.glow-green {
            border-left: 3px solid var(--green);
        }

        .module-card.glow-blue {
            border-left: 3px solid var(--accent);
        }

        .module-card.glow-purple {
            border-left: 3px solid var(--purple);
        }

        .module-card.glow-cyan {
            border-left: 3px solid var(--cyan);
        }

        .module-card.glow-yellow {
            border-left: 3px solid var(--yellow);
        }

        .module-card.glow-red {
            border-left: 3px solid var(--red);
        }

        .module-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .module-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .module-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .module-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .module-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .module-status-dot {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* ── Market Regime Banner ─────────────────────────────────── */
        .regime-banner {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .regime-indicator {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
            border: 3px solid transparent;
            animation: regimeGlow 3s infinite;
        }

        .regime-indicator.bullish {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--green);
        }

        .regime-indicator.bearish {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--red);
        }

        .regime-indicator.sideways {
            background: rgba(245, 158, 11, 0.15);
            border-color: var(--yellow);
        }

        .regime-indicator.volatile {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--purple);
        }

        .regime-indicator.accumulation {
            background: rgba(6, 182, 212, 0.15);
            border-color: var(--cyan);
        }

        @keyframes regimeGlow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
            }

            50% {
                box-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
            }
        }

        .regime-info {
            flex: 1;
        }

        .regime-title {
            font-size: 20px;
            font-weight: 800;
            text-transform: capitalize;
        }

        .regime-sub {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .regime-coins {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .regime-coin-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 14px;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .regime-coin-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .regime-coin-regime {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ── AI Thought Summary ──────────────────────────────────── */
        .thought-summary-box {
            background: linear-gradient(135deg, rgba(124, 92, 255, 0.06) 0%, rgba(6, 182, 212, 0.04) 100%);
            border: 1px solid rgba(124, 92, 255, 0.2);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
        }

        .thought-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .thought-header h3 {
            font-size: 16px;
            font-weight: 700;
        }

        .thought-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            background: rgba(124, 92, 255, 0.15);
            color: var(--purple);
            letter-spacing: 0.5px;
        }

        .thought-content {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .thought-steps {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .thought-step {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
        }

        .thought-step-num {
            font-size: 10px;
            font-weight: 700;
            color: var(--cyan);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .thought-step-text {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ── Enhanced AI Recommendation Cards ─────────────────────── */
        .enhanced-rec-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            transition: border-color 0.3s;
        }

        .enhanced-rec-card:hover {
            border-color: var(--accent);
        }

        .rec-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .rec-card-info {
            flex: 1;
        }

        .rec-card-token {
            font-size: 18px;
            font-weight: 700;
        }

        .rec-card-ticker {
            color: var(--text-muted);
            font-size: 13px;
            margin-left: 6px;
        }

        .rec-card-price {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .rec-confidence {
            text-align: center;
            min-width: 72px;
        }

        .rec-confidence-ring {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 4px;
        }

        .rec-confidence-value {
            font-size: 16px;
            font-weight: 800;
        }

        .rec-confidence-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .rec-thesis {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
            border-left: 3px solid var(--accent);
        }

        .rec-data-points {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .rec-data-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            background: rgba(6, 182, 212, 0.1);
            color: var(--cyan);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .rec-risk-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .rec-entry-exit {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 12px;
        }

        @media(max-width:768px) {
            .rec-entry-exit {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .rec-entry-item {
            text-align: center;
        }

        .rec-entry-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .rec-entry-value {
            font-size: 13px;
            font-weight: 700;
            margin-top: 2px;
        }

        .rec-verdict-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        /* ── Learning Loop Dashboard ──────────────────────────────── */
        .learning-hero {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(139, 92, 246, 0.08));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
        }

        .learning-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.06), transparent 70%);
            border-radius: 50%;
        }

        .learning-hero-title {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .learning-hero-desc {
            font-size: 14px;
            color: var(--text-muted);
            max-width: 600px;
            line-height: 1.5;
        }

        .learning-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0 0;
            flex-wrap: wrap;
        }

        .learning-actions .btn {
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            padding: 10px 18px;
        }

        .learning-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media(max-width:768px) {
            .learning-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .learning-stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .learning-stat:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .learning-stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .learning-stat-value {
            font-size: 28px;
            font-weight: 800;
        }

        .learning-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .learning-stat-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--purple));
            transition: width 0.6s ease;
        }

        /* Accuracy Gauges */
        .accuracy-gauges {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 28px;
        }

        @media(max-width:768px) {
            .accuracy-gauges {
                grid-template-columns: 1fr;
            }
        }

        .accuracy-gauge-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 28px;
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .accuracy-gauge-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--green), var(--accent));
        }

        .accuracy-ring {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 16px;
            background: conic-gradient(var(--green) var(--pct), rgba(255, 255, 255, 0.06) var(--pct));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 40px rgba(0, 211, 149, 0.2), 0 0 80px rgba(0, 211, 149, 0.08);
            transition: all 0.6s ease;
            filter: drop-shadow(0 0 12px rgba(0, 211, 149, 0.25));
        }

        .accuracy-ring::after {
            content: '';
            width: 112px;
            height: 112px;
            border-radius: 50%;
            background: var(--bg-card);
            position: absolute;
        }

        .accuracy-ring-text {
            position: relative;
            z-index: 1;
            font-size: 28px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .accuracy-gauge-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .accuracy-gauge-sub {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Regime cards */
        .regime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .regime-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.25s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .regime-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }

        .regime-name {
            font-size: 13px;
            font-weight: 700;
            text-transform: capitalize;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .regime-pct {
            font-size: 26px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }

        .regime-detail {
            font-size: 11px;
            color: var(--text-muted);
        }

        .regime-bar {
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.06);
            margin-top: 10px;
            overflow: hidden;
        }

        .regime-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.6s ease;
        }

        /* Prediction cards */
        .prediction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }

        .prediction-row:last-child {
            border-bottom: none;
        }

        .prediction-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .prediction-ticker {
            font-weight: 700;
            font-size: 14px;
            min-width: 70px;
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .prediction-verdict {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .prediction-pnl {
            font-weight: 800;
            font-size: 15px;
            min-width: 80px;
            text-align: right;
        }

        /* Adjustment cards enhanced */
        .adjustment-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 12px;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .adjustment-card:hover {
            border-color: var(--accent);
        }

        .adjustment-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 3px;
        }

        .adjustment-card.adj-decrease::before {
            background: var(--red);
        }

        .adjustment-card.adj-increase::before {
            background: var(--green);
        }

        .adjustment-card.adj-hold::before {
            background: var(--yellow);
        }

        .adjustment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .adjustment-type {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .adjustment-type.increase {
            background: rgba(16, 185, 129, 0.12);
            color: var(--green);
        }

        .adjustment-type.decrease {
            background: rgba(239, 68, 68, 0.12);
            color: var(--red);
        }

        .adjustment-type.hold {
            background: rgba(245, 158, 11, 0.12);
            color: var(--yellow);
        }

        .adjustment-detail {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .adjustment-reason {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            font-style: italic;
        }

        /* Section panels */
        .learning-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .learning-panel-header {
            padding: 18px 20px;
            font-size: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.01);
        }

        .learning-panel-body {
            padding: 0;
        }

        .learning-panel-body.padded {
            padding: 20px;
        }

        /* Token search */
        .token-search-wrap {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .token-search-wrap input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border 0.2s;
        }

        .token-search-wrap input:focus {
            border-color: var(--accent);
        }

        .token-search-wrap .btn {
            border-radius: 10px;
        }

        /* ── Market Insights Page ──────────────────────────────────── */
        .insight-hero {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.08), rgba(59, 130, 246, 0.06));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
        }

        .insight-hero::before {
            content: '';
            position: absolute;
            top: -60px;
            right: -40px;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.08), transparent 70%);
            border-radius: 50%;
        }

        .insight-hero::after {
            content: '';
            position: absolute;
            bottom: -80px;
            left: -60px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(6, 182, 212, 0.06), transparent 70%);
            border-radius: 50%;
        }

        .insight-hero-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--purple), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .insight-hero-desc {
            font-size: 14px;
            color: var(--text-muted);
            max-width: 600px;
            line-height: 1.6;
            position: relative;
        }

        .insight-search-wrap {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            position: relative;
        }

        .insight-search-input {
            flex: 1;
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 20px 14px 44px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .insight-search-input:focus {
            border-color: var(--purple);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
        }

        .insight-search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .insight-analyze-btn {
            background: var(--gradient);
            border: none;
            color: #fff;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .insight-analyze-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        .insight-analyze-btn:active {
            transform: translateY(0);
        }

        .insight-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            position: relative;
        }

        .insight-chip {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .insight-chip:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--purple);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .insight-chip-icon {
            font-size: 16px;
        }

        /* Insight results */
        .insight-token-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .insight-token-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient);
        }

        .insight-token-img {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 2px solid var(--border);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .insight-token-name {
            font-size: 24px;
            font-weight: 800;
        }

        .insight-token-sym {
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .insight-token-price {
            font-size: 28px;
            font-weight: 800;
        }

        .insight-token-change {
            font-size: 14px;
            font-weight: 600;
            margin-top: 2px;
        }

        .insight-score-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        @media(max-width:900px) {
            .insight-score-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .insight-score-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.25s ease;
        }

        .insight-score-card:hover {
            border-color: var(--purple);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .insight-score-icon {
            font-size: 12px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }

        .insight-score-value {
            font-size: 28px;
            font-weight: 800;
        }

        .insight-score-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .insight-score-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            transition: width 0.6s ease;
        }

        /* Insight panels */
        .insight-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .insight-panel-header {
            padding: 18px 20px;
            font-size: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.01);
        }

        .insight-panel-body {
            padding: 20px;
        }

        .insight-ta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .insight-ta-row:last-child {
            border-bottom: none;
        }

        .insight-ta-label {
            color: var(--text-muted);
            font-size: 13px;
        }

        .insight-ta-value {
            font-weight: 700;
            font-size: 14px;
        }

        .insight-ta-badge {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .insight-news-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .insight-news-item:last-child {
            border-bottom: none;
        }

        .insight-news-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .insight-ai-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(59, 130, 246, 0.04));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .insight-ai-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--purple), var(--accent));
        }

        .insight-ai-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            font-size: 16px;
            font-weight: 700;
        }

        .insight-ai-text {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .insight-market-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .insight-market-row:last-child {
            border-bottom: none;
        }

        .insight-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .insight-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .insight-empty-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .insight-empty-desc {
            font-size: 13px;
            color: var(--text-muted);
            max-width: 420px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .insight-features {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .insight-feature-tag {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* ── Personalization / Settings Page ──────────────────────── */
        .settings-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pref-slider-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .pref-slider-label {
            width: 140px;
            font-size: 13px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .pref-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
        }

        .pref-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid var(--bg-primary);
        }

        .pref-slider-value {
            width: 40px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--accent);
        }

        .pref-chip-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .pref-chip {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .pref-chip:hover {
            border-color: var(--text-muted);
        }

        .pref-chip.selected {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        /* ── Section Divider ──────────────────────────────────────── */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 32px 0 20px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* ── Floating Gradient Orbs (decoration) ──────────────────── */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            pointer-events: none;
            opacity: 0.07;
        }

        .orb-1 {
            width: 300px;
            height: 300px;
            background: #3b82f6;
            top: -100px;
            left: -100px;
        }

        .orb-2 {
            width: 250px;
            height: 250px;
            background: #8b5cf6;
            top: 200px;
            right: -50px;
        }

        .orb-3 {
            width: 200px;
            height: 200px;
            background: #06b6d4;
            bottom: -50px;
            left: 30%;
        }

        .bot-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ═══════════════════════════════════════════════════════════ */
        /* TRADINGVIEW WIDGET STYLES                                   */
        /* ═══════════════════════════════════════════════════════════ */

        /* Ticker Tape */
        .tv-ticker-tape-wrap {
            position: sticky;
            top: 56px;
            z-index: 90;
            background: linear-gradient(135deg, rgba(10, 14, 23, 0.95), rgba(26, 31, 46, 0.95));
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            overflow: hidden;
            min-height: 0;
            height: 36px;
            transition: height 0.3s ease, opacity 0.3s ease;
        }

        .tv-ticker-tape-wrap.tv-collapsed {
            height: 0 !important;
            min-height: 0;
            border: none;
            pointer-events: none;
            opacity: 0;
        }

        .tv-ticker-tape-wrap iframe {
            pointer-events: auto;
        }

        /* TV Loading / Error states */
        .tv-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 200px;
            color: var(--text-muted);
            font-size: 13px;
            gap: 12px;
        }

        .tv-loading .spinner {
            width: 28px;
            height: 28px;
        }

        .tv-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 200px;
            color: var(--text-muted);
            font-size: 13px;
            gap: 12px;
            text-align: center;
            padding: 24px;
        }

        .tv-error-icon {
            font-size: 32px;
            opacity: 0.5;
        }

        .tv-retry-btn {
            padding: 8px 20px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tv-retry-btn:hover {
            background: var(--accent);
            color: #fff;
        }

        /* Chart Container */
        .tv-chart-container {
            margin: 16px 0 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-card);
            overflow: hidden;
            animation: tvSlideIn 0.4s ease;
        }

        @keyframes tvSlideIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tv-chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(139, 92, 246, 0.08));
            border-bottom: 1px solid var(--border);
        }

        .tv-chart-label {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tv-chart-timeframes {
            display: flex;
            gap: 6px;
        }

        .tv-tf-btn {
            padding: 5px 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tv-tf-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(59, 130, 246, 0.08);
        }

        .tv-tf-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
        }

        .tv-tf-sm {
            padding: 3px 8px;
            font-size: 11px;
        }

        /* Technical Analysis Widget Box */
        .tv-ta-row {
            margin-bottom: 20px;
        }

        .tv-ta-box {
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-card);
            overflow: hidden;
        }

        .tv-ta-box-header {
            padding: 12px 16px;
            font-weight: 700;
            font-size: 14px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(6, 182, 212, 0.08));
            border-bottom: 1px solid var(--border);
        }

        /* Market Overview */
        .tv-market-overview {
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-card);
            overflow: hidden;
            padding: 12px;
        }

        /* Heatmap */
        .tv-heatmap-container {
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-card);
            overflow: hidden;
        }

        /* P&L Heatmap Treemap */
        .pnl-heatmap-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            min-height: 220px;
            border-radius: var(--radius);
            overflow: hidden;
        }
        .pnl-heatmap-tile {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            overflow: hidden;
            min-width: 60px;
            min-height: 60px;
            padding: 6px 4px;
            text-align: center;
        }
        .pnl-heatmap-tile:hover {
            transform: scale(1.04);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 2;
        }
        .pnl-heatmap-tile .tile-symbol {
            font-weight: 700;
            font-size: 13px;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            line-height: 1.2;
        }
        .pnl-heatmap-tile .tile-pnl {
            font-weight: 600;
            font-size: 16px;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            line-height: 1.3;
        }
        .pnl-heatmap-tile .tile-amount {
            font-size: 10px;
            color: rgba(255,255,255,0.7);
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }
        .pnl-heatmap-tile .tile-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 8px;
            padding: 1px 5px;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            color: rgba(255,255,255,0.8);
            font-weight: 600;
        }
        .pnl-heatmap-tooltip {
            position: fixed;
            z-index: 9999;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            font-size: 13px;
            max-width: 240px;
            display: none;
        }
        .pnl-heatmap-tooltip .tip-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 2px 0;
        }
        .pnl-heatmap-tooltip .tip-label { color: var(--text-muted); }
        .pnl-heatmap-tooltip .tip-value { font-weight: 600; }

        /* Modal Chart */
        .tv-modal-chart-wrap {
            margin: 16px 0;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-card);
            overflow: hidden;
        }

        /* TradingView Attribution Override (dark theme) */
        .tradingview-widget-copyright {
            display: none !important;
        }

        /* Responsive */
        @media (max-width:768px) {
            .tv-chart-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .tv-chart-timeframes {
                flex-wrap: wrap;
            }

            .tv-ticker-tape-wrap {
                top: 48px;
            }
        }

        /* ── Live Feed Styles ───────────────────────────────────── */
        .feed-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            transition: background 0.15s;
        }
        .feed-item:hover { background: var(--bg-secondary); }
        .feed-item:last-child { border-bottom: none; }
        .feed-action {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            min-width: 52px;
            text-align: center;
        }
        .feed-action.buy, .feed-action.long { background: var(--green); }
        .feed-action.sell, .feed-action.cover, .feed-action.short { background: var(--red); }
        .feed-time { color: var(--text-muted); font-size: 11px; min-width: 70px; }
        .feed-amount { color: var(--text-secondary); font-size: 12px; margin-left: auto; }

        /* ── Cycle Log Styles ───────────────────────────────────── */
        .cycle-item {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .cycle-item:last-child { border-bottom: none; }
        .cycle-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .cycle-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }
        .cycle-badge.ok { background: rgba(16,185,129,0.15); color: var(--green); }
        .cycle-badge.disabled, .cycle-badge.paused { background: rgba(239,68,68,0.1); color: var(--red); }
        .cycle-actions { margin-top: 4px; font-size: 12px; color: var(--text-secondary); line-height: 1.6; }

        @media(max-width:768px) {
            .trader-grid[style*="repeat(5"] { grid-template-columns: repeat(2, 1fr) !important; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
</head>

<body>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- HEADER                                                     -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="header">
        <div class="logo" onclick="navigate('market')">NexYpher</div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-page="market">Market</button>
            <button class="nav-tab" data-page="insights">AI Insights</button>
            <button class="nav-tab" data-page="learning">Learning</button>
            <button class="nav-tab" data-page="trader">Auto Trader</button>
            <button class="nav-tab" data-page="contact">Contact</button>
            <span class="nx-paper-indicator" id="nxPaperNav">&#x1F4CB; Paper Mode Active</span>
        </div>
        <div class="header-right">
            <input class="search-box" id="globalSearch" placeholder="Search tokens..."
                onkeydown="if(event.key==='Enter')doSearch()">
            <button class="nx-watchlist-nav-btn" id="navWatchlistBtn" onclick="navigate('watchlist')" title="My Watchlist" style="display:none">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                <span class="nx-wl-count" id="navWlCount">0</span>
            </button>
            <div id="authArea">
                <button class="btn btn-primary" onclick="showAuthModal('login')">Login</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- TRADINGVIEW TICKER TAPE                                    -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="tv-ticker-tape-wrap" id="tvTickerWrap">
        <iframe id="tvTickerFrame" style="width:100%;height:46px;border:none;display:block;pointer-events:auto"
            frameborder="0" allowtransparency="true" scrolling="no"></iframe>
    </div>
    <script>
        (function () {
            var cfg = { symbols: [{ proName: "BINANCE:BTCUSDT", title: "Bitcoin" }, { proName: "BINANCE:ETHUSDT", title: "Ethereum" }, { proName: "BINANCE:SOLUSDT", title: "Solana" }, { proName: "BINANCE:XRPUSDT", title: "XRP" }, { proName: "BINANCE:DOGEUSDT", title: "Doge" }, { proName: "BINANCE:ADAUSDT", title: "Cardano" }, { proName: "BINANCE:AVAXUSDT", title: "AVAX" }, { proName: "BINANCE:LINKUSDT", title: "Chainlink" }, { proName: "BINANCE:DOTUSDT", title: "Polkadot" }, { proName: "BINANCE:MATICUSDT", title: "Polygon" }], showSymbolLogo: true, isTransparent: true, displayMode: "adaptive", colorTheme: "dark", locale: "en" };
            var wrap = document.getElementById('tvTickerWrap');
            var f = document.getElementById('tvTickerFrame');
            var loaded = false;
            f.src = 'https://s.tradingview.com/embed-widget/ticker-tape/?locale=en#' + encodeURIComponent(JSON.stringify(cfg));
            f.onload = function () { loaded = true; };
            f.onerror = function () { wrap.classList.add('tv-collapsed'); };
            // Fallback: collapse if not loaded after 15s
            setTimeout(function () {
                if (!loaded) wrap.classList.add('tv-collapsed');
            }, 15000);
        })();
    </script>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- HOME PAGE                                                  -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-home">
        <div class="hero" style="position:relative;overflow:hidden">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>
            <div class="orb orb-3"></div>
            <div class="hero-tag">AI-POWERED CRYPTO INTELLIGENCE</div>
            <h1 class="hero-title">See through the noise.</h1>
            <p class="hero-desc">
                NexYpher fuses real-time data, multi-model AI reasoning, and transparent analytics to give you an unfair
                edge in crypto markets.
            </p>
            <div class="hero-steps">
                <div class="step-card">
                    <div class="step-num">01</div>
                    <div class="step-title">Browse</div>
                    <div class="step-desc">Scan 1000+ tokens with live price feeds and
                        market cap data.</div>
                </div>
                <div class="step-card">
                    <div class="step-num">02</div>
                    <div class="step-title">Analyze</div>
                    <div class="step-desc">AI scores every token using 15+ indicators — RSI, MACD, volume anomalies,
                        news sentiment & more.</div>
                </div>
                <div class="step-card">
                    <div class="step-num">03</div>
                    <div class="step-title">Act</div>
                    <div class="step-desc">Auto-trade with AI-managed positions, stop-loss, take-profit, and full
                        blockchain audit trail.</div>
                </div>
            </div>
        </div>

        <!-- ── Live Platform Stats ─────────────────────────────── -->
        <div class="section-divider">Live Platform Metrics</div>
        <div class="live-stats-banner">
            <div class="live-stat-card">
                <div class="live-stat-value" id="homeStatTokens">--</div>
                <div class="live-stat-label">Tokens Tracked</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-value" id="homeStatAIScans">--</div>
                <div class="live-stat-label">AI Analyses Run</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-value" id="homeStatRegime">--</div>
                <div class="live-stat-label">Market Regime</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-value" id="homeStatAutoTrades">--</div>
                <div class="live-stat-label">Auto Trades Today</div>
            </div>
        </div>

        <!-- ── Module Showcase ─────────────────────────────────── -->
        <div class="section-divider">Platform Modules</div>
        <div class="module-showcase">
            <div class="module-card glow-purple" onclick="navigate('ai')">
                <div class="module-status-dot"></div>
                <div class="module-icon"></div>
                <div class="module-title">AI Recommendation Engine</div>
                <div class="module-desc">Multi-model AI pipeline with GPT + Gemini reasoning, confidence scoring, and
                    transparent thought summaries.</div>
                <div class="module-tags">
                    <span class="module-tag">Orchestrator</span>
                    <span class="module-tag">Confidence</span>
                    <span class="module-tag">NLG</span>
                </div>
            </div>
            <div class="module-card glow-cyan" onclick="navigate('market')">
                <div class="module-status-dot"></div>
                <div class="module-icon"></div>
                <div class="module-title">Real-Time Crypto Data Layer</div>
                <div class="module-desc">Live feeds from CoinGecko, on-chain data, and news aggregators powering every
                    analysis in real-time.</div>
                <div class="module-tags">
                    <span class="module-tag">CoinGecko</span>
                    <span class="module-tag">On-Chain</span>
                    <span class="module-tag">News</span>
                </div>
            </div>
            <div class="module-card glow-green" onclick="navigate('insights')">
                <div class="module-status-dot"></div>
                <div class="module-icon"></div>
                <div class="module-title">Intelligent Market Analysis</div>
                <div class="module-desc">15+ technical indicators including RSI, MACD, Bollinger Bands, market regime
                    detection, and breakout quality scoring.</div>
                <div class="module-tags">
                    <span class="module-tag">TA Suite</span>
                    <span class="module-tag">Regime</span>
                    <span class="module-tag">Breakout</span>
                </div>
            </div>
            <div class="module-card glow-blue" onclick="navigate('settings')">
                <div class="module-status-dot"></div>
                <div class="module-icon"></div>
                <div class="module-title">Auth & Personalization</div>
                <div class="module-desc">JWT authentication, user preferences, risk profiles, watchlists, and AI
                    sensitivity controls.</div>
                <div class="module-tags">
                    <span class="module-tag">JWT Auth</span>
                    <span class="module-tag">Risk Profile</span>
                    <span class="module-tag">Watchlist</span>
                </div>
            </div>
            <div class="module-card glow-yellow" onclick="navigate('trader')">
                <div class="module-status-dot"></div>
                <div class="module-icon"></div>
                <div class="module-title">AI-Assisted Auto-Trading</div>
                <div class="module-desc">Autonomous trading with position management, stop-loss/take-profit, risk
                    controls, and blockchain-verified transactions.</div>
                <div class="module-tags">
                    <span class="module-tag">Auto Trade</span>
                    <span class="module-tag">Risk Mgmt</span>
                    <span class="module-tag">Blockchain</span>
                </div>
            </div>
            <div class="module-card glow-red" onclick="navigate('learning')">
                <div class="module-status-dot"></div>
                <div class="module-icon"></div>
                <div class="module-title">Continuous Learning Loop</div>
                <div class="module-desc">AI tracks its own predictions, evaluates accuracy over time, and auto-adjusts
                    strategies based on performance.</div>
                <div class="module-tags">
                    <span class="module-tag">Accuracy</span>
                    <span class="module-tag">Feedback</span>
                    <span class="module-tag">Self-Improve</span>
                </div>
            </div>
        </div>

        <!-- Trending Pills -->
        <div style="margin-bottom:24px">
            <h3 style="font-size:14px;margin-bottom:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.05em">Trending</h3>
            <div id="trendingBar" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>

        <!-- Quick Market Table -->
        <div class="section-header-row">
            <div class="section-header-left">
                <div class="section-title">Top Coins</div>
                <div class="section-desc">Live market data from CoinGecko</div>
            </div>
            <div class="section-header-right">
                <span class="live-indicator">Live</span>
            </div>
        </div>
        <div style="overflow-x:auto">
            <table class="feed-table" id="homeMarketTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Token</th>
                        <th>Price</th>
                        <th>24h</th>
                        <th>Market Cap</th>
                        <th>Volume</th>
                    </tr>
                </thead>
                <tbody id="homeMarketBody"></tbody>
            </table>
        </div>
    </div>

    <!-- (old page-feed removed — merged into Market sub-tabs) -->
    <div class="page" id="page-feed"></div>

    <!-- (old page-ai removed — merged into AI Insights page) -->
    <div class="page" id="page-ai"></div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- INSIGHTS PAGE                                              -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-insights">
        <!-- Global Market Mini-banner (from AI Recs) -->
        <div class="market-summary-box" style="margin-bottom:16px">
            <h4>Global Market (CoinGecko)</h4>
            <p id="aiMarketGlobal">Loading market data...</p>
        </div>

        <!-- Hero -->
        <div class="insight-hero">
            <div class="insight-hero-title">AI Insights</div>
            <div class="insight-hero-desc">
                Deep technical analysis with 15+ indicators — RSI, MACD, Bollinger Bands, support/resistance, market
                regime detection, news sentiment, and AI-powered recommendations.
            </div>

            <!-- AI Scan All (merged from AI Recs) -->
            <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
                <div class="toggle-item" style="display:flex;align-items:center;gap:6px">
                    <div class="simple-toggle" id="toggleOnchain" onclick="toggleSwitch(this)"></div>
                    <span style="font-size:12px;color:var(--text-muted)">On-Chain</span>
                </div>
                <div class="toggle-item" style="display:flex;align-items:center;gap:6px">
                    <div class="simple-toggle" id="toggleTechnical" onclick="toggleSwitch(this)"></div>
                    <span style="font-size:12px;color:var(--text-muted)">Technical</span>
                </div>
                <button class="btn btn-green btn-sm" onclick="loadAIRecs()">Quick Scan All</button>
                <button class="btn btn-primary btn-sm" onclick="loadEnhancedAIRecs()">Enhanced AI Scan</button>
            </div>

            <!-- Single coin search -->
            <div class="insight-search-wrap">
                <span class="insight-search-icon"></span>
                <input class="insight-search-input" id="insightSearch"
                    placeholder="Search any coin — bitcoin, ethereum, solana, dogecoin..."
                    onkeydown="if(event.key==='Enter')loadInsightAnalysis()">
                <button class="insight-analyze-btn" onclick="loadInsightAnalysis()">Deep Analyze</button>
            </div>
            <div class="insight-chips">
                <div class="insight-chip" onclick="quickInsight('bitcoin')"><span class="insight-chip-icon">₿</span>
                    Bitcoin</div>
                <div class="insight-chip" onclick="quickInsight('ethereum')"><span class="insight-chip-icon">Ξ</span>
                    Ethereum</div>
                <div class="insight-chip" onclick="quickInsight('solana')"><span class="insight-chip-icon">◎</span>
                    Solana</div>
                <div class="insight-chip" onclick="quickInsight('ripple')"><span class="insight-chip-icon">✕</span> XRP
                </div>
                <div class="insight-chip" onclick="quickInsight('dogecoin')"><span class="insight-chip-icon">🐕</span>
                    Doge</div>
                <div class="insight-chip" onclick="quickInsight('cardano')"><span class="insight-chip-icon">₳</span>
                    Cardano</div>
                <div class="insight-chip" onclick="quickInsight('avalanche-2')"><span
                        class="insight-chip-icon">🔺</span> AVAX</div>
                <div class="insight-chip" onclick="quickInsight('chainlink')"><span class="insight-chip-icon">🔗</span>
                    LINK</div>
            </div>
        </div>

        <!-- AI Scan Results (merged from AI Recs page) -->
        <div id="aiTimestamp" style="color:var(--text-muted);font-size:12px;margin-bottom:12px"></div>

        <!-- AI Thought Summary (from Enhanced endpoint) -->
        <div class="thought-summary-box" id="aiThoughtBox" style="display:none">
            <div class="thought-header">
                <span style="font-size:22px"></span>
                <h3>AI Thought Summary</h3>
                <span class="thought-badge">TRANSPARENT REASONING</span>
            </div>
            <div class="thought-content" id="aiThoughtContent"></div>
            <div class="thought-steps" id="aiThoughtSteps"></div>
        </div>

        <!-- Market Summary -->
        <div class="market-summary-box" id="aiSummaryBox" style="display:none">
            <h4>Market Summary</h4>
            <p id="aiSummaryText"></p>
        </div>

        <!-- Enhanced Scored Tokens (for enhanced mode) -->
        <div id="aiEnhancedCards" style="display:none"></div>

        <!-- Scored Tokens (quick mode) -->
        <div class="cards-grid" id="aiCards"></div>

        <!-- Results -->
        <div id="insightResult" style="display:none">
            <!-- Token header card -->
            <div class="insight-token-card" id="insightTokenCard">
                <img class="insight-token-img" id="insightTokenImg" src="" alt="">
                <div>
                    <div class="insight-token-name" id="insightTokenName"></div>
                    <div class="insight-token-sym" id="insightTokenSymbol"></div>
                </div>
                <div style="margin-left:auto;text-align:right">
                    <div class="insight-token-price" id="insightTokenPrice"></div>
                    <div class="insight-token-change" id="insightTokenChange"></div>
                </div>
            </div>

            <!-- TradingView Advanced Chart -->
            <div class="tv-chart-container" id="insightTVChart" style="display:none">
                <div class="tv-chart-header">
                    <span class="tv-chart-label">Live Chart</span>
                    <div class="tv-chart-timeframes">
                        <button class="tv-tf-btn active" onclick="switchInsightTF('1', this)">1m</button>
                        <button class="tv-tf-btn" onclick="switchInsightTF('5', this)">5m</button>
                        <button class="tv-tf-btn" onclick="switchInsightTF('15', this)">15m</button>
                        <button class="tv-tf-btn" onclick="switchInsightTF('60', this)">1H</button>
                        <button class="tv-tf-btn" onclick="switchInsightTF('240', this)">4H</button>
                        <button class="tv-tf-btn" onclick="switchInsightTF('D', this)">1D</button>
                        <button class="tv-tf-btn" onclick="switchInsightTF('W', this)">1W</button>
                    </div>
                </div>
                <div id="insightTVChartWidget" style="height:420px;border-radius:0 0 12px 12px;overflow:hidden"></div>
            </div>

            <!-- TradingView Technical Analysis Widget -->
            <div class="tv-ta-row" id="insightTVTA" style="display:none">
                <div class="tv-ta-box">
                    <div class="tv-ta-box-header">TradingView Technical Analysis</div>
                    <div id="insightTVTAWidget" style="height:280px;overflow:hidden"></div>
                </div>
            </div>

            <!-- Score cards -->
            <div class="insight-score-grid">
                <div class="insight-score-card">
                    <div class="insight-score-icon">TA</div>
                    <div class="insight-score-value" id="insightTAScore">--</div>
                    <div class="insight-score-label">TA Score (0-10)</div>
                    <div class="insight-score-bar" id="insightTABar" style="width:0%;background:var(--accent)"></div>
                </div>
                <div class="insight-score-card">
                    <div class="insight-score-icon">RSI</div>
                    <div class="insight-score-value" id="insightRSI">--</div>
                    <div class="insight-score-label">RSI (14)</div>
                    <div class="insight-score-bar" id="insightRSIBar" style="width:0%;background:var(--green)"></div>
                </div>
                <div class="insight-score-card">
                    <div class="insight-score-icon">TD</div>
                    <div class="insight-score-value" id="insightTrend">--</div>
                    <div class="insight-score-label">Trend Direction</div>
                    <div class="insight-score-bar" id="insightTrendBar" style="width:100%;background:var(--purple)">
                    </div>
                </div>
                <div class="insight-score-card">
                    <div class="insight-score-icon">NS</div>
                    <div class="insight-score-value" id="insightNewsSentiment">--</div>
                    <div class="insight-score-label">News Sentiment</div>
                    <div class="insight-score-bar" id="insightSentBar" style="width:50%;background:var(--yellow)"></div>
                </div>
            </div>

            <!-- Technical + News side by side -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
                <div class="insight-panel">
                    <div class="insight-panel-header">Technical Indicators</div>
                    <div class="insight-panel-body" id="insightTAContent"></div>
                </div>
                <div class="insight-panel">
                    <div class="insight-panel-header">News & Sentiment</div>
                    <div class="insight-panel-body">
                        <div id="insightNewsNarrative"
                            style="font-size:14px;margin-bottom:16px;color:var(--text-secondary);line-height:1.6;font-style:italic">
                        </div>
                        <div id="insightHeadlines"></div>
                    </div>
                </div>
            </div>

            <!-- AI Recommendation -->
            <div class="insight-ai-box" id="insightAIBox" style="display:none">
                <div class="insight-ai-header">AI Recommendation</div>
                <div class="insight-ai-text" id="insightAIText"></div>
            </div>

            <!-- Market Data -->
            <div class="insight-panel">
                <div class="insight-panel-header">Market Data</div>
                <div class="insight-panel-body" id="insightMarketContent"></div>
            </div>

            <!-- Backtest Strategy Analysis -->
            <div class="insight-panel" id="insightBacktestPanel" style="display:none">
                <div class="insight-panel-header">Backtest Strategy Analysis</div>
                <div class="insight-panel-body" id="insightBacktestContent"></div>
            </div>
        </div>

        <!-- Empty state -->
        <div id="insightEmpty" class="insight-empty">
            <div class="insight-empty-icon"></div>
            <div class="insight-empty-title">Search any cryptocurrency for deep analysis</div>
            <div class="insight-empty-desc">
                Get real-time technical analysis with RSI, MACD, Bollinger Bands, support/resistance levels, market
                regime detection, news sentiment, and AI-powered trading recommendations.
            </div>
            <div class="insight-features">
                <span class="insight-feature-tag">RSI</span>
                <span class="insight-feature-tag">MACD</span>
                <span class="insight-feature-tag">Bollinger Bands</span>
                <span class="insight-feature-tag">Support/Resistance</span>
                <span class="insight-feature-tag">Trend Detection</span>
                <span class="insight-feature-tag">News Sentiment</span>
                <span class="insight-feature-tag">AI Recommendations</span>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- LEARNING PAGE                                              -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-learning">
        <!-- Hero -->
        <div class="learning-hero">
            <div class="learning-hero-title">AI Learning Loop</div>
            <div class="learning-hero-desc">
                Track how NexYpher's AI evolves over time. Every prediction is recorded, evaluated against actual market
                movements, and used to refine future trading strategies.
            </div>
            <div class="learning-actions">
                <button class="btn btn-primary" onclick="loadLearningStats()">Refresh Stats</button>
                <button class="btn btn-outline" onclick="triggerLearningEvaluation()">Evaluate Predictions</button>
                <button class="btn btn-outline" onclick="loadStrategyAdjustments()">Strategy Adjustments</button>
            </div>
        </div>

        <!-- Accuracy Gauges -->
        <div class="accuracy-gauges">
            <div class="accuracy-gauge-card">
                <div class="accuracy-gauge-label">24-Hour Accuracy</div>
                <div class="accuracy-ring" id="learningAccuracyRing" style="--pct:0%">
                    <span class="accuracy-ring-text" id="learningAccuracyPct">--</span>
                </div>
                <div class="accuracy-gauge-sub" id="learningAccSub24">Evaluating predictions after 24 hours</div>
            </div>
            <div class="accuracy-gauge-card">
                <div class="accuracy-gauge-label">7-Day Accuracy</div>
                <div class="accuracy-ring" id="learningAccuracyRing7d" style="--pct:0%">
                    <span class="accuracy-ring-text" id="learningAccuracyPct7d">--</span>
                </div>
                <div class="accuracy-gauge-sub" id="learningAccSub7d">Evaluating predictions after 7 days</div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="learning-grid" style="grid-template-columns:repeat(6,1fr);margin-bottom:28px">
            <div class="learning-stat">
                <div class="learning-stat-icon"></div>
                <div class="learning-stat-value" id="learnTotalPreds">0</div>
                <div class="learning-stat-label">Total Predictions</div>
                <div class="learning-stat-bar" id="learnBarTotal" style="width:0%"></div>
            </div>
            <div class="learning-stat">
                <div class="learning-stat-icon"></div>
                <div class="learning-stat-value" id="learnEvaluated24h">0</div>
                <div class="learning-stat-label">Evaluated (24h)</div>
                <div class="learning-stat-bar" id="learnBar24h" style="width:0%"></div>
            </div>
            <div class="learning-stat">
                <div class="learning-stat-icon"></div>
                <div class="learning-stat-value" id="learnEvaluated7d">0</div>
                <div class="learning-stat-label">Evaluated (7d)</div>
                <div class="learning-stat-bar" id="learnBar7d" style="width:0%"></div>
            </div>
            <div class="learning-stat">
                <div class="learning-stat-icon"></div>
                <div class="learning-stat-value" id="learnAvgPnl">0%</div>
                <div class="learning-stat-label">Avg P&L (24h)</div>
                <div class="learning-stat-bar" style="width:100%"></div>
            </div>
            <div class="learning-stat">
                <div class="learning-stat-icon"></div>
                <div class="learning-stat-value" id="learnConfCorrect">0</div>
                <div class="learning-stat-label">Avg Conf (Correct)</div>
                <div class="learning-stat-bar" style="width:100%"></div>
            </div>
            <div class="learning-stat">
                <div class="learning-stat-icon"></div>
                <div class="learning-stat-value" id="learnConfIncorrect">0</div>
                <div class="learning-stat-label">Avg Conf (Wrong)</div>
                <div class="learning-stat-bar" style="width:100%"></div>
            </div>
        </div>

        <!-- Regime Accuracy -->
        <div class="learning-panel">
            <div class="learning-panel-header">Accuracy by Market Regime</div>
            <div class="learning-panel-body padded" id="learningRegimeStats">
                <div class="empty-state">
                    <p>Click "Refresh Stats" to load data</p>
                </div>
            </div>
        </div>

        <!-- Direction Accuracy -->
        <div class="learning-panel">
            <div class="learning-panel-header">Accuracy by Strategy Direction</div>
            <div class="learning-panel-body padded" id="learningDirectionStats">
                <div class="empty-state">
                    <p>Click "Refresh Stats" to load data</p>
                </div>
            </div>
        </div>

        <!-- Best / Worst Predictions -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="learning-panel">
                <div class="learning-panel-header">Best Predictions (7d)</div>
                <div class="learning-panel-body" id="learningBest">
                    <div class="empty-state" style="padding:24px">
                        <p>No data yet</p>
                    </div>
                </div>
            </div>
            <div class="learning-panel">
                <div class="learning-panel-header">Worst Predictions (7d)</div>
                <div class="learning-panel-body" id="learningWorst">
                    <div class="empty-state" style="padding:24px">
                        <p>No data yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Adjustments -->
        <div class="learning-panel">
            <div class="learning-panel-header">AI Strategy Adjustments</div>
            <div class="learning-panel-body padded" id="learningAdjustments">
                <div class="empty-state">
                    <p>Click "Strategy Adjustments" to load AI recommendations</p>
                </div>
            </div>
        </div>

        <!-- Token Lookup -->
        <div class="learning-panel" style="margin-top:20px">
            <div class="learning-panel-header">Token Track Record</div>
            <div class="learning-panel-body padded">
                <div class="token-search-wrap">
                    <input id="learningTokenSearch" placeholder="Enter token ticker (e.g. BTC, ETH, SOL)..."
                        onkeydown="if(event.key==='Enter')loadTokenTrackRecord()">
                    <button class="btn btn-primary" onclick="loadTokenTrackRecord()">Look Up</button>
                </div>
                <div id="learningTokenResult"></div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- MARKET PAGE (detailed CoinGecko)                           -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page active" id="page-market">
        <!-- My Watchlist -->
        <div id="marketWatchlistSection" class="market-watchlist-section" style="display:none">
            <div class="market-watchlist-pills" id="marketWatchlistPills"></div>
        </div>

        <div class="section-header-row">
            <div class="section-header-left">
                <div class="section-title">AI Market Scanner</div>
                <div class="section-desc">Coins ranked by AI opportunity score — momentum, volume, trend signals & recovery potential</div>
            </div>
            <div class="section-header-right">
                <span class="live-indicator">Live</span>
            </div>
        </div>

        <!-- Market Sub-tabs: Top Coins | DEX Feed -->
        <div class="trader-subtabs" style="margin-bottom:20px">
            <button class="trader-subtab active" onclick="switchMarketTab('coins')">Top Coins</button>
            <button class="trader-subtab" onclick="switchMarketTab('dex')">DEX Feed</button>
        </div>

        <!-- SUB: Top Coins (CoinGecko) -->
        <div id="marketSub-coins">

        <!-- TradingView Market Overview Widget -->
        <div class="tv-market-overview" style="margin-bottom:24px">
            <iframe id="tvMarketOverview" style="width:100%;height:400px;border:none;display:block" frameborder="0"
                allowtransparency="true"></iframe>
        </div>

        <!-- TradingView Crypto Heatmap -->
        <div class="tv-heatmap-container" style="margin-bottom:24px">
            <div class="tv-chart-header" style="margin-bottom:0;border-radius:12px 12px 0 0">
                <span class="tv-chart-label">Crypto Heatmap</span>
            </div>
            <iframe id="tvHeatmap" style="width:100%;height:350px;border:none;display:block;border-radius:0 0 12px 12px"
                frameborder="0" allowtransparency="true"></iframe>
        </div>

        <div id="trendingMarket" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px"></div>

        <div style="overflow-x:auto">
            <table class="feed-table">
                <thead>
                    <tr>
                        <th>AI Score</th>
                        <th>Token</th>
                        <th>Verdict</th>
                        <th>Price</th>
                        <th>24h</th>
                        <th>7d</th>
                        <th>Signal</th>
                    </tr>
                </thead>
                <tbody id="marketBody"></tbody>
            </table>
        </div>
        </div><!-- /marketSub-coins -->

        <!-- SUB: DEX Feed (DexScreener) -->
        <div id="marketSub-dex" style="display:none">
            <div class="section-desc" id="feedCount">Live token feed from DexScreener</div>
            <div class="filter-bar">
                <div class="filter-pill active" data-sort="volume" onclick="setFeedSort(this)">Volume</div>
                <div class="filter-pill" data-sort="newest" onclick="setFeedSort(this)">Newest</div>
                <div class="filter-pill" data-sort="price" onclick="setFeedSort(this)">Price</div>
                <div class="filter-pill" data-sort="trades" onclick="setFeedSort(this)">Trades</div>
                <div style="width:1px;height:24px;background:var(--border);margin:0 8px"></div>
                <div class="filter-pill active" data-status="all" onclick="setFeedStatus(this)">All</div>
                <div class="filter-pill" data-status="active" onclick="setFeedStatus(this)">Active</div>
                <div class="filter-pill" data-status="graduated" onclick="setFeedStatus(this)">Graduated</div>
                <div style="flex:1"></div>
                <input class="search-box" style="width:180px" placeholder="Search feed..." oninput="filterFeedLocal(this.value)">
            </div>
            <div style="overflow-x:auto">
                <table class="feed-table">
                    <thead>
                        <tr><th>Token</th><th>Price</th><th>24h</th><th>Volume</th><th>Liquidity</th><th>Trades</th><th>Age</th></tr>
                    </thead>
                    <tbody id="feedBody"></tbody>
                </table>
            </div>
        </div><!-- /marketSub-dex -->
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- AUTO TRADER PAGE                                           -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-trader">
        <div class="trader-header">
            <div>
                <div class="trader-title">Auto Trader <span class="badge-paper" style="font-size:12px;padding:4px 12px;border-radius:6px;border:1px solid #6c63ff">&#x1F4CB; PAPER MODE</span></div>
                <div style="color:rgba(255,255,255,0.3);font-size:12px;margin-top:4px">Using simulated paper balance — no real funds at risk</div>
                <div id="blockchainStatusBadge" style="margin-top:4px"></div>
            </div>
            <div style="display:flex;align-items:center;gap:16px">
                <div id="traderStatusBadge" class="trader-status active">● Active</div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoTradeToggle" checked onchange="toggleAutoTrade()">
                    <span class="toggle-slider"></span>
                </label>
                <button class="btn btn-outline btn-sm" onclick="refreshTraderDashboard()" id="traderRefreshBtn" title="Refresh Dashboard" style="padding:6px 12px;font-size:14px;border-radius:10px;min-width:auto">Refresh</button>
            </div>
        </div>

        <!-- Paper Mode Onboarding Banner -->
        <div class="nx-onboarding-banner" id="nxOnboardingBanner" style="display:none">
            <div>
                <strong>&#x1F4CB; You are in Paper Trading Mode</strong><br>
                All trades use simulated money for AI training.
                <span id="nxOnboardingWallet"></span>
            </div>
            <button class="nx-onboarding-dismiss" onclick="dismissOnboarding()">Got it — don't show again</button>
        </div>

        <!-- ── Sub-tabs ── -->
        <div class="trader-subtabs">
            <button class="trader-subtab active" onclick="switchTraderTab('live')">Live Trading</button>
            <button class="trader-subtab" onclick="switchTraderTab('builder')">Strategy Builder</button>
            <button class="trader-subtab" onclick="switchTraderTab('strategies')">My Strategies</button>
        </div>

        <!-- ═══════════════ SUB-PAGE: LIVE TRADING ═══════════════ -->
        <div class="trader-subpage active" id="traderSub-live">
            <!-- Stats Cards -->
            <div class="trader-grid" style="grid-template-columns:repeat(4,1fr);margin-top:0">
                <div class="trader-stat-card">
                    <div class="trader-stat-label" style="display:flex;align-items:center;gap:6px">Paper Balance
                        <span style="position:relative;cursor:help" title="This balance is simulated for AI training. Your real wallet is separate and unaffected.">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        </span>
                    </div>
                    <div class="trader-stat-value" id="traderBalance">$0</div>
                    <div class="trader-stat-sub" id="traderReturn">0% return</div>
                </div>
                <div class="trader-stat-card">
                    <div class="trader-stat-label">Total P&L</div>
                    <div class="trader-stat-value" id="traderPnl">$0.00</div>
                    <div class="trader-stat-sub" id="traderWinRate">Win rate: --</div>
                </div>
                <div class="trader-stat-card">
                    <div class="trader-stat-label">Open Positions</div>
                    <div class="trader-stat-value" id="traderOpenCount">0</div>
                    <div class="trader-stat-sub" id="traderInvested">$0 invested</div>
                </div>
                <div class="trader-stat-card">
                    <div class="trader-stat-label">Total Trades</div>
                    <div class="trader-stat-value" id="traderTradeCount">0</div>
                    <div class="trader-stat-sub" id="traderBestWorst">Best: -- | Worst: --</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="runTradeCycle()">Run Trade Cycle</button>
                <button class="btn btn-outline" onclick="runResearch()">Research Market</button>
                <button class="btn btn-outline" onclick="showManualBuyModal()">Manual Buy</button>
                <button class="btn btn-outline" onclick="showTraderSettings()">Settings</button>
                <button class="btn btn-danger btn-sm" onclick="resetTrading()" style="margin-left:auto">Reset
                    Stats</button>
            </div>

            <!-- ── TODAY'S QUICK STATS ─────────────────────────────── -->
            <div style="margin-top:20px">
                <h3 style="font-size:16px;margin-bottom:10px;display:flex;align-items:center;gap:8px">
                    Today's Performance
                    <span id="todayStatsTime" style="font-size:11px;color:var(--text-muted);font-weight:400"></span>
                </h3>
                <div class="trader-grid" style="grid-template-columns:repeat(5,1fr);margin-top:0;gap:10px">
                    <div class="trader-stat-card" style="padding:14px;text-align:center">
                        <div class="trader-stat-label">Trades Today</div>
                        <div class="trader-stat-value" id="qsTrades" style="font-size:22px">0</div>
                        <div class="trader-stat-sub" id="qsBuySell" style="font-size:11px">0 buys / 0 sells</div>
                    </div>
                    <div class="trader-stat-card" style="padding:14px;text-align:center">
                        <div class="trader-stat-label">Today P&L</div>
                        <div class="trader-stat-value" id="qsPnl" style="font-size:22px">$0</div>
                        <div class="trader-stat-sub" id="qsWinLoss" style="font-size:11px">0W / 0L</div>
                    </div>
                    <div class="trader-stat-card" style="padding:14px;text-align:center">
                        <div class="trader-stat-label">Avg Hold Time</div>
                        <div class="trader-stat-value" id="qsHoldTime" style="font-size:22px">0m</div>
                        <div class="trader-stat-sub" style="font-size:11px">per position</div>
                    </div>
                    <div class="trader-stat-card" style="padding:14px;text-align:center">
                        <div class="trader-stat-label">Best Trade</div>
                        <div class="trader-stat-value" id="qsBest" style="font-size:22px;color:var(--green)">$0</div>
                        <div class="trader-stat-sub" style="font-size:11px">today</div>
                    </div>
                    <div class="trader-stat-card" style="padding:14px;text-align:center">
                        <div class="trader-stat-label">Volume</div>
                        <div class="trader-stat-value" id="qsVolume" style="font-size:22px">$0</div>
                        <div class="trader-stat-sub" id="qsClosed" style="font-size:11px">0 closed</div>
                    </div>
                </div>
            </div>

            <!-- ── LIVE TRADE FEED ─────────────────────────────────── -->
            <div style="margin-top:24px">
                <h3 style="font-size:16px;margin-bottom:10px;display:flex;align-items:center;gap:8px">
                    Live Trade Feed
                    <span class="live-pulse" style="width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 2s infinite"></span>
                </h3>
                <div id="liveFeedContainer" style="max-height:280px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:0">
                    <div class="empty-state" style="padding:20px"><p>Loading feed...</p></div>
                </div>
            </div>

            <!-- ── P&L PERFORMANCE CHART ───────────────────────────── -->
            <div style="margin-top:24px">
                <h3 style="font-size:16px;margin-bottom:10px;display:flex;align-items:center;gap:8px">
                    P&L Performance
                    <select id="chartDaysSelect" onchange="loadPnlChart()" style="margin-left:auto;background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px">
                        <option value="7">7 days</option>
                        <option value="14" selected>14 days</option>
                        <option value="30">30 days</option>
                    </select>
                </h3>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
                    <canvas id="pnlChart" height="220" style="width:100%"></canvas>
                    <div id="pnlChartEmpty" style="display:none;text-align:center;padding:40px;color:var(--text-muted)">No P&L data yet — trades will appear here</div>
                </div>
            </div>

            <!-- ── P&L HEATMAP (TREEMAP) ──────────────────────────── -->
            <div style="margin-top:24px">
                <h3 style="font-size:16px;margin-bottom:10px;display:flex;align-items:center;gap:8px">
                    P&L Heatmap
                    <span style="font-size:11px;color:var(--text-muted);font-weight:400">Tile size = position size &bull; Color = your P&L %</span>
                    <select id="heatmapDaysSelect" onchange="loadPnlHeatmap()" style="margin-left:auto;background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="90">All Time</option>
                    </select>
                </h3>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:12px">
                    <div id="pnlHeatmapGrid" class="pnl-heatmap-grid">
                        <div class="empty-state" style="padding:40px;width:100%;text-align:center"><p>Loading heatmap...</p></div>
                    </div>
                    <!-- Legend -->
                    <div style="display:flex;align-items:center;gap:6px;margin-top:10px;justify-content:center;font-size:11px;color:var(--text-muted)">
                        <span>Loss</span>
                        <div style="display:flex;gap:2px">
                            <div style="width:20px;height:10px;border-radius:2px;background:#b71c1c"></div>
                            <div style="width:20px;height:10px;border-radius:2px;background:#c62828"></div>
                            <div style="width:20px;height:10px;border-radius:2px;background:#e53935"></div>
                            <div style="width:20px;height:10px;border-radius:2px;background:#555"></div>
                            <div style="width:20px;height:10px;border-radius:2px;background:#2e7d32"></div>
                            <div style="width:20px;height:10px;border-radius:2px;background:#388e3c"></div>
                            <div style="width:20px;height:10px;border-radius:2px;background:#1b5e20"></div>
                        </div>
                        <span>Profit</span>
                    </div>
                </div>
            </div>
            <div class="pnl-heatmap-tooltip" id="heatmapTooltip"></div>

            <!-- ── CYCLE LOG ───────────────────────────────────────── -->
            <div style="margin-top:24px">
                <h3 style="font-size:16px;margin-bottom:10px">Auto-Trade Cycle Log</h3>
                <div id="cycleLogContainer" style="max-height:320px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:0">
                    <div class="empty-state" style="padding:20px"><p>Cycle log loads when auto-trader runs...</p></div>
                </div>
            </div>

            <!-- Open Positions -->
            <div style="margin-top:24px">
                <h3 style="font-size:18px;margin-bottom:12px">Open Positions</h3>
                <div id="traderPositions">
                    <div class="empty-state">
                        <p>No open positions</p>
                    </div>
                </div>
            </div>

            <!-- AI Opportunities -->
            <div style="margin-top:24px">
                <h3 style="font-size:18px;margin-bottom:12px">AI Opportunities</h3>
                <div id="traderOpportunities">
                    <div class="empty-state">
                        <p>Click "Research Market" to find opportunities</p>
                    </div>
                </div>
            </div>

            <!-- Trade History & Log tabs -->
            <div style="margin-top:24px">
                <div class="nx-history-tabs" id="tradeHistoryMainTabs">
                    <button class="nx-history-tab active" onclick="switchHistoryView('paper')">&#x1F4CB; Paper Trades</button>
                    <button class="nx-history-tab" onclick="switchHistoryView('wallet')">&#x26D3; Wallet Transactions</button>
                </div>
                <div id="tradeHistoryPaperView">
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <button class="btn btn-sm btn-outline" onclick="loadTraderHistory()" id="histTabBtn">Trade
                            History</button>
                        <button class="btn btn-sm btn-outline" onclick="loadTraderLog()" id="logTabBtn">AI Log</button>
                        <button class="btn btn-sm btn-outline" onclick="loadClosedPositions()" id="closedTabBtn">Closed
                            Positions</button>
                    </div>
                    <div id="traderHistoryArea"></div>
                    <div class="nx-history-footer">These are simulated trades using paper money. No real funds were used.</div>
                </div>
                <div id="tradeHistoryWalletView" style="display:none">
                    <div id="walletHistoryArea"><div class="empty-state"><p>Connect a wallet to see on-chain transactions</p></div></div>
                    <div class="nx-history-footer">Real on-chain transactions from your connected wallet.</div>
                </div>
            </div>
        </div>

        <!-- ═══════════════ SUB-PAGE: STRATEGY BUILDER ═══════════════ -->
        <div class="trader-subpage" id="traderSub-builder">

            <!-- ROW 1: Strategy Template + Exchange & Market -->
            <div class="sb-row two">
                <div class="sb-card">
                    <h4><span class="sb-icon">📋</span> Strategy Template</h4>
                    <div class="sb-field">
                        <label>Strategy Type</label>
                        <select id="sbStratType" onchange="sbTemplateChanged()">
                            <option value="custom" selected>Custom Strategy</option>
                            <option value="grid">Grid Trading</option>
                            <option value="dca">DCA Bot</option>
                            <option value="momentum">Momentum</option>
                            <option value="mean_reversion">Mean Reversion</option>
                            <option value="scalping">Scalping</option>
                            <option value="swing">Swing Trading</option>
                            <option value="funding_farm">🏦 Funding Rate Farm</option>
                            <option value="breakout">💥 Breakout</option>
                        </select>
                        <div class="sb-hint" id="sbTemplateHint">Build your own custom trading strategy from scratch
                        </div>
                    </div>
                    <div class="sb-field" style="margin-top:12px">
                        <label>Timeframe</label>
                        <div class="sb-pills" id="sbTimeframePills">
                            <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf"
                                    value="1m"> 1m</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf"
                                    value="5m"> 5m</label>
                            <label class="sb-pill active" onclick="sbPickPill(this,'sbTf')"><input type="radio"
                                    name="sbTf" value="15m" checked> 15m</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf"
                                    value="1h"> 1h</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf"
                                    value="4h"> 4h</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf"
                                    value="1d"> 1D</label>
                        </div>
                    </div>
                </div>
                <div class="sb-card">
                    <h4><span class="sb-icon">🏦</span> Exchange & Market</h4>
                    <div class="sb-field">
                        <label>Exchange</label>
                        <div class="sb-exchange-grid">
                            <div class="sb-exchange-opt active" onclick="sbPickExchange(this)" data-exchange="binance">
                                Binance<div class="sb-fee">Maker 0.02%</div>
                            </div>
                            <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="bybit">Bybit<div
                                    class="sb-fee">Maker 0.02%</div>
                            </div>
                            <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="okx">OKX<div
                                    class="sb-fee">Maker 0.02%</div>
                            </div>
                            <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="coinbase">
                                Coinbase<div class="sb-fee">Maker 0.04%</div>
                            </div>
                            <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="kraken">Kraken
                                <div class="sb-fee">Maker 0.02%</div>
                            </div>
                            <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="kucoin">KuCoin
                                <div class="sb-fee">Maker 0.02%</div>
                            </div>
                        </div>
                    </div>
                    <div class="sb-field" style="margin-top:10px">
                        <label>Market Type</label>
                        <div class="sb-pills">
                            <label class="sb-pill active" onclick="sbPickPill(this,'sbMkt');sbMarketChanged()"><input
                                    type="radio" name="sbMkt" value="spot" checked> Spot</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbMkt');sbMarketChanged()"><input
                                    type="radio" name="sbMkt" value="futures"> Perpetual Futures</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 2: Instruments + Position Config -->
            <div class="sb-row two">
                <div class="sb-card">
                    <h4><span class="sb-icon">🪙</span> Instruments</h4>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center" id="sbInstrumentChips">
                        <span class="sb-pill active" data-pair="BTC/USDT">BTC/USDT <button onclick="sbRemoveInstr(this)"
                                style="background:none;border:none;color:inherit;cursor:pointer;margin-left:4px;font-size:14px">&times;</button></span>
                        <button class="sb-pill" onclick="sbToggleInstrDD()" id="sbAddInstrBtn">+ Add</button>
                    </div>
                    <div id="sbInstrDD"
                        style="display:none;margin-top:8px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:8px;max-height:180px;overflow-y:auto">
                        <input type="text" placeholder="Search pairs..." oninput="sbFilterInstr(this.value)"
                            style="width:100%;padding:6px 10px;margin-bottom:6px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px">
                        <div id="sbInstrList">
                            <div class="sb-instr-item" data-pair="BTC/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">BTC/USDT</div>
                            <div class="sb-instr-item" data-pair="ETH/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">ETH/USDT</div>
                            <div class="sb-instr-item" data-pair="SOL/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">SOL/USDT</div>
                            <div class="sb-instr-item" data-pair="BNB/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">BNB/USDT</div>
                            <div class="sb-instr-item" data-pair="XRP/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">XRP/USDT</div>
                            <div class="sb-instr-item" data-pair="DOGE/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">DOGE/USDT</div>
                            <div class="sb-instr-item" data-pair="ADA/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">ADA/USDT</div>
                            <div class="sb-instr-item" data-pair="AVAX/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">AVAX/USDT</div>
                            <div class="sb-instr-item" data-pair="LINK/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">LINK/USDT</div>
                            <div class="sb-instr-item" data-pair="MATIC/USDT" onclick="sbSelectInstr(this)"
                                style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">MATIC/USDT
                            </div>
                        </div>
                    </div>
                    <div class="sb-field" style="margin-top:14px">
                        <label>Order Type</label>
                        <div class="sb-pills" id="sbOrderPills">
                            <label class="sb-pill active" onclick="sbPickPill(this,'sbOrder')"><input type="radio"
                                    name="sbOrder" value="market" checked> Market</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbOrder')"><input type="radio"
                                    name="sbOrder" value="limit"> Limit</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbOrder')"><input type="radio"
                                    name="sbOrder" value="stop_limit"> Stop-Limit</label>
                        </div>
                    </div>
                    <div class="sb-field" style="margin-top:10px">
                        <label>Stablecoin Base</label>
                        <div class="sb-pills">
                            <label class="sb-pill active" onclick="sbPickPill(this,'sbBase')"><input type="radio"
                                    name="sbBase" value="USDT" checked> USDT</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbBase')"><input type="radio" name="sbBase"
                                    value="USDC"> USDC</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbBase')"><input type="radio" name="sbBase"
                                    value="BUSD"> BUSD</label>
                        </div>
                    </div>
                </div>
                <div class="sb-card">
                    <h4><span class="sb-icon">⚙️</span> Position Configuration</h4>
                    <div class="sb-field">
                        <label>Position Side</label>
                        <div class="sb-pills">
                            <label class="sb-pill green active" onclick="sbPickPill(this,'sbSide')"><input type="radio"
                                    name="sbSide" value="long" checked> 🟢 Long</label>
                            <label class="sb-pill red" onclick="sbPickPill(this,'sbSide')"><input type="radio"
                                    name="sbSide" value="short"> 🔴 Short</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbSide')"><input type="radio" name="sbSide"
                                    value="both"> ↕️ Both</label>
                        </div>
                    </div>
                    <div class="sb-field">
                        <label>Position Size (USDT)</label>
                        <div class="sb-num" style="width:100%">
                            <button onclick="sbQty(this,-100)">−</button>
                            <input type="number" id="sbPosSize" value="100" min="1" style="flex:1;width:auto">
                            <button onclick="sbQty(this,100)">+</button>
                        </div>
                    </div>
                    <!-- Futures-only: Leverage & Margin -->
                    <div id="sbFuturesConfig" style="display:none">
                        <div class="sb-field">
                            <label>Leverage</label>
                            <div class="sb-leverage-wrap">
                                <div class="sb-leverage-bar">
                                    <input type="range" id="sbLeverage" min="1" max="125" value="5"
                                        oninput="sbLeverageChanged()">
                                    <span class="sb-leverage-val" id="sbLevVal">5x</span>
                                </div>
                                <div class="sb-leverage-presets">
                                    <button onclick="sbSetLev(1)">1x</button>
                                    <button onclick="sbSetLev(2)">2x</button>
                                    <button class="active" onclick="sbSetLev(5)">5x</button>
                                    <button onclick="sbSetLev(10)">10x</button>
                                    <button onclick="sbSetLev(25)">25x</button>
                                    <button onclick="sbSetLev(50)">50x</button>
                                    <button onclick="sbSetLev(100)">100x</button>
                                </div>
                            </div>
                            <div class="sb-liq-price" id="sbLiqPrice">Est. Liquidation: ~$0 (depends on entry)</div>
                        </div>
                        <div class="sb-field">
                            <label>Margin Mode</label>
                            <div class="sb-pills">
                                <label class="sb-pill active" onclick="sbPickPill(this,'sbMargin')"><input type="radio"
                                        name="sbMargin" value="isolated" checked> Isolated</label>
                                <label class="sb-pill" onclick="sbPickPill(this,'sbMargin')"><input type="radio"
                                        name="sbMargin" value="cross"> Cross</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 3: Entry Indicators + Exit Rules -->
            <div class="sb-row two">
                <div class="sb-card">
                    <h4><span class="sb-icon">📡</span> Entry Conditions</h4>
                    <div class="sb-field">
                        <label>Select Indicators</label>
                        <div class="sb-indicator-grid">
                            <div class="sb-indicator active" onclick="sbToggleIndicator(this)" data-ind="rsi"><span
                                    class="dot blue"></span> RSI</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="macd"><span
                                    class="dot blue"></span> MACD</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="ema_cross"><span
                                    class="dot blue"></span> EMA Cross</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="bb"><span
                                    class="dot blue"></span> Bollinger</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="volume"><span
                                    class="dot green"></span> Volume Spike</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="funding"><span
                                    class="dot yellow"></span> Funding Rate</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="cvd"><span
                                    class="dot green"></span> CVD</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="whale"><span
                                    class="dot red"></span> Whale Alert</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="exchange_flow"><span
                                    class="dot red"></span> Exchange Flow</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="btc_dom"><span
                                    class="dot yellow"></span> BTC Dominance</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="fear_greed"><span
                                    class="dot yellow"></span> Fear & Greed</div>
                            <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="social"><span
                                    class="dot green"></span> Social Sentiment</div>
                        </div>
                    </div>
                    <div class="sb-field" style="margin-top:12px">
                        <label>Entry Rules <button class="btn btn-sm btn-outline" onclick="sbAddCondition('entry')"
                                style="margin-left:8px;font-size:11px">+ Add Rule</button></label>
                        <div id="sbEntryConditions">
                            <div class="sb-condition">
                                <select>
                                    <option>RSI</option>
                                    <option>MACD</option>
                                    <option>EMA</option>
                                    <option>Volume</option>
                                    <option>Funding Rate</option>
                                    <option>Price</option>
                                </select>
                                <select>
                                    <option>crosses below</option>
                                    <option>crosses above</option>
                                    <option>is above</option>
                                    <option>is below</option>
                                    <option>increases by</option>
                                </select>
                                <input type="number" value="30" style="width:60px">
                                <span style="color:var(--text-muted)">→ BUY</span>
                                <button class="sb-cond-remove"
                                    onclick="this.closest('.sb-condition').remove()">×</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sb-card">
                    <h4><span class="sb-icon">🎯</span> Exit & Stop-Loss</h4>
                    <div class="sb-field">
                        <label>Stop-Loss Method</label>
                        <div class="sb-pills">
                            <label class="sb-pill active" onclick="sbPickPill(this,'sbSL')"><input type="radio"
                                    name="sbSL" value="percent" checked> Fixed %</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbSL')"><input type="radio" name="sbSL"
                                    value="atr"> ATR-Based</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbSL')"><input type="radio" name="sbSL"
                                    value="trailing"> Trailing</label>
                        </div>
                    </div>
                    <div class="sb-leg-grid" style="margin-top:10px">
                        <div class="sb-leg-field">
                            <label>Stop Loss %</label>
                            <input type="number" id="sbSLVal" value="3" placeholder="3">
                        </div>
                        <div class="sb-leg-field">
                            <label>Take Profit %</label>
                            <input type="number" id="sbTPVal" value="6" placeholder="6">
                        </div>
                        <div class="sb-leg-field">
                            <label>Trail Distance %</label>
                            <input type="number" id="sbTrailVal" value="1" placeholder="1">
                        </div>
                    </div>
                    <div class="sb-field" style="margin-top:12px">
                        <label>Exit Rules <button class="btn btn-sm btn-outline" onclick="sbAddCondition('exit')"
                                style="margin-left:8px;font-size:11px">+ Add Rule</button></label>
                        <div id="sbExitConditions">
                            <div class="sb-condition">
                                <select>
                                    <option>RSI</option>
                                    <option>MACD</option>
                                    <option>EMA</option>
                                    <option>Volume</option>
                                    <option>Funding Rate</option>
                                    <option>Price</option>
                                    <option>Time</option>
                                </select>
                                <select>
                                    <option>crosses above</option>
                                    <option>crosses below</option>
                                    <option>is above</option>
                                    <option>is below</option>
                                    <option>after minutes</option>
                                </select>
                                <input type="number" value="70" style="width:60px">
                                <span style="color:var(--text-muted)">→ SELL</span>
                                <button class="sb-cond-remove"
                                    onclick="this.closest('.sb-condition').remove()">×</button>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:12px">
                        <label class="sb-check"><input type="checkbox" id="sbMoveSlCost"> Move SL to breakeven after
                            TP1</label>
                        <label class="sb-check" style="margin-top:6px"><input type="checkbox" id="sbReEntry"> Re-entry
                            after SL hit (max 2x)</label>
                    </div>
                </div>
            </div>

            <!-- ROW 4: Risk Management + Schedule & Sessions -->
            <div class="sb-row two">
                <div class="sb-card">
                    <h4><span class="sb-icon">🛡️</span> Risk Management</h4>
                    <div class="sb-leg-grid">
                        <div class="sb-leg-field">
                            <label>Max Drawdown %</label>
                            <input type="number" id="sbMaxDD" value="10" placeholder="10">
                        </div>
                        <div class="sb-leg-field">
                            <label>Daily Loss Limit %</label>
                            <input type="number" id="sbDailyLoss" value="5" placeholder="5">
                        </div>
                        <div class="sb-leg-field">
                            <label>Max Open Positions</label>
                            <input type="number" id="sbMaxPos" value="3" placeholder="3">
                        </div>
                    </div>
                    <div class="sb-leg-grid" style="margin-top:10px">
                        <div class="sb-leg-field">
                            <label>Max Position Size %</label>
                            <input type="number" id="sbMaxPosSize" value="25" placeholder="25">
                        </div>
                        <div class="sb-leg-field">
                            <label>Max Daily Trades</label>
                            <input type="number" id="sbMaxTrades" value="10" placeholder="10">
                        </div>
                        <div class="sb-leg-field">
                            <label>Cooldown (min)</label>
                            <input type="number" id="sbCooldown" value="5" placeholder="5">
                        </div>
                    </div>
                    <div class="sb-field" style="margin-top:14px">
                        <label>Volatility Filter</label>
                        <div class="sb-check-group">
                            <label class="sb-check"><input type="checkbox" id="sbVolFilter" checked> Pause if ATR >
                                threshold</label>
                            <input type="number" id="sbVolThreshold" value="5"
                                style="width:60px;padding:4px 8px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px"
                                placeholder="%">
                        </div>
                    </div>

                    <!-- Kill Switches -->
                    <div style="margin-top:14px">
                        <label
                            style="font-size:12px;color:var(--red);font-weight:700;margin-bottom:8px;display:block">🚨
                            Kill Switches</label>
                        <div class="sb-kill-switch">
                            <label><input type="checkbox" id="sbKillFlash" checked
                                    style="accent-color:var(--red);margin-right:6px"> Flash Crash Protection — Halt if
                                price drops</label>
                            <input type="number" id="sbKillFlashVal" value="15" placeholder="%">
                            <span style="font-size:11px;color:var(--text-muted)">% in 1min</span>
                        </div>
                        <div class="sb-kill-switch">
                            <label><input type="checkbox" id="sbKillCircuit" checked
                                    style="accent-color:var(--red);margin-right:6px"> Circuit Breaker — Stop if market
                                drops</label>
                            <input type="number" id="sbKillCircuitVal" value="10" placeholder="%">
                            <span style="font-size:11px;color:var(--text-muted)">% in 1hr</span>
                        </div>
                        <div class="sb-kill-switch">
                            <label><input type="checkbox" id="sbKillDepeg"
                                    style="accent-color:var(--red);margin-right:6px"> Stablecoin Depeg Monitor — Halt if
                                USDT &lt;</label>
                            <input type="number" id="sbKillDepegVal" value="0.98" step="0.01" placeholder="0.98">
                        </div>
                    </div>
                </div>
                <div class="sb-card">
                    <h4><span class="sb-icon">🕐</span> Schedule & Market Regime</h4>
                    <div class="sb-field">
                        <label>Trading Sessions</label>
                        <div class="sb-session-grid">
                            <div class="sb-session active" onclick="this.classList.toggle('active')">
                                <div class="sb-session-name">🌏 Asia</div>
                                <div class="sb-session-time">00:00 – 08:00 UTC</div>
                            </div>
                            <div class="sb-session active" onclick="this.classList.toggle('active')">
                                <div class="sb-session-name">🌍 Europe</div>
                                <div class="sb-session-time">08:00 – 16:00 UTC</div>
                            </div>
                            <div class="sb-session active" onclick="this.classList.toggle('active')">
                                <div class="sb-session-name">🌎 US</div>
                                <div class="sb-session-time">14:00 – 22:00 UTC</div>
                            </div>
                        </div>
                    </div>
                    <div class="sb-field">
                        <label>Active Days (24/7 Market)</label>
                        <div class="sb-day-pills">
                            <div class="sb-day active" onclick="this.classList.toggle('active')">M</div>
                            <div class="sb-day active" onclick="this.classList.toggle('active')">T</div>
                            <div class="sb-day active" onclick="this.classList.toggle('active')">W</div>
                            <div class="sb-day active" onclick="this.classList.toggle('active')">T</div>
                            <div class="sb-day active" onclick="this.classList.toggle('active')">F</div>
                            <div class="sb-day active" onclick="this.classList.toggle('active')">S</div>
                            <div class="sb-day active" onclick="this.classList.toggle('active')">S</div>
                        </div>
                        <div class="sb-hint" style="margin-top:4px">Crypto trades 24/7 — all days active by default
                        </div>
                    </div>
                    <div class="sb-field">
                        <label>Market Regime Filter</label>
                        <div class="sb-regime-grid">
                            <div class="sb-regime active" onclick="this.classList.toggle('active')" data-regime="bull">
                                📈 Bull</div>
                            <div class="sb-regime active" onclick="this.classList.toggle('active')" data-regime="bear">
                                📉 Bear</div>
                            <div class="sb-regime active" onclick="this.classList.toggle('active')"
                                data-regime="sideways">➡️ Sideways</div>
                            <div class="sb-regime" onclick="this.classList.toggle('active')" data-regime="high_vol">🌊
                                High Vol</div>
                        </div>
                        <div class="sb-hint">Strategy runs only in selected market conditions</div>
                    </div>
                    <div class="sb-field">
                        <label>Crypto Cycle Awareness</label>
                        <div class="sb-check-group" style="gap:8px 16px">
                            <label class="sb-check"><input type="checkbox" id="sbHalving"> Bitcoin Halving Cycle</label>
                            <label class="sb-check"><input type="checkbox" id="sbAltSeason"> Alt Season
                                Detection</label>
                            <label class="sb-check"><input type="checkbox" id="sbFearGreed" checked> Fear & Greed
                                Filter</label>
                            <label class="sb-check"><input type="checkbox" id="sbBtcCorr"> BTC Correlation Guard</label>
                        </div>
                    </div>
                    <div class="sb-field">
                        <label>Sleep Mode</label>
                        <div class="sb-time-row">
                            <div><label>Pause From</label><br><input type="time" id="sbSleepFrom" value="02:00"></div>
                            <div><label>Pause Until</label><br><input type="time" id="sbSleepTo" value="06:00"></div>
                            <label class="sb-check" style="margin-left:12px"><input type="checkbox" id="sbSleepEnabled">
                                Enable</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 5: Advanced Crypto Features (full width) -->
            <div class="sb-row">
                <div class="sb-card">
                    <h4><span class="sb-icon">🔬</span> Advanced Crypto Features</h4>
                    <div class="sb-check-group" style="gap:10px 24px">
                        <label class="sb-check"><input type="checkbox" id="sbDCA"> 📉 DCA on Dip (add to position on
                            -5%)</label>
                        <label class="sb-check"><input type="checkbox" id="sbMartingale"> 🎰 Martingale (double after
                            loss)</label>
                        <label class="sb-check"><input type="checkbox" id="sbGridMode"> 📊 Grid Mode (buy/sell at
                            intervals)</label>
                        <label class="sb-check"><input type="checkbox" id="sbFundingFarm"> 🏦 Funding Rate
                            Farming</label>
                        <label class="sb-check"><input type="checkbox" id="sbPairsHedge"> ↔️ Pairs Hedging (long/short
                            offset)</label>
                        <label class="sb-check"><input type="checkbox" id="sbBtcDomRotate"> 🔄 BTC Dom Rotation (exit
                            alts when BTC dom rises)</label>
                        <label class="sb-check"><input type="checkbox" id="sbAutoDeleverage"> ⚠️ Auto-Deleverage near
                            liquidation</label>
                        <label class="sb-check"><input type="checkbox" id="sbSlippageModel"> 📐 Slippage Model (adjust
                            for low-cap coins)</label>
                    </div>
                </div>
            </div>

            <!-- Save / Deploy Bar -->
            <div
                style="display:flex;gap:12px;align-items:center;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:4px">
                <input type="text" id="sbStratName" placeholder="Strategy Name"
                    style="flex:1;padding:10px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
                <button class="btn btn-outline" onclick="sbSaveStrategy()">💾 Save Strategy</button>
                <button class="btn btn-primary" onclick="sbDeployStrategy()">🚀 Deploy Live</button>
            </div>
        </div>

        <!-- ═══════════════ SUB-PAGE: MY STRATEGIES ═══════════════ -->
        <div class="trader-subpage" id="traderSub-strategies">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <h3 style="font-size:18px">📋 My Strategies</h3>
                <button class="btn btn-primary btn-sm" onclick="switchTraderTab('builder')">+ New Strategy</button>
            </div>
            <div id="sbStrategiesList">
                <div class="empty-state">
                    <p>No strategies yet. Create one in the Strategy Builder.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- SETTINGS PAGE                                              -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-settings">
        <div class="sett-page">
            <h2 class="sett-title">Settings</h2>
            <div class="sett-subtitle">Manage your preferences, trading defaults, and integrations</div>

            <div class="sett-grid">
                <!-- Sidebar -->
                <nav class="sett-sidebar">
                    <button class="sett-nav active" onclick="switchSettingsTab('general', this)">
                        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="9" r="7"/><path d="M9 6v3l2 2"/></svg>
                        General
                    </button>
                    <button class="sett-nav" onclick="switchSettingsTab('appearance', this)">
                        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="9" r="7"/><path d="M9 2a7 7 0 000 14V2z"/></svg>
                        Appearance
                    </button>
                    <button class="sett-nav" onclick="switchSettingsTab('notifications', this)">
                        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 7a5 5 0 0110 0c0 4 2 5 2 5H2s2-1 2-5zM7 14a2 2 0 004 0"/></svg>
                        Notifications
                    </button>
                    <button class="sett-nav" onclick="switchSettingsTab('trading', this)">
                        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 13l4-4 3 3 7-8"/><path d="M12 4h4v4"/></svg>
                        Trading
                    </button>
                    <button class="sett-nav" onclick="switchSettingsTab('risk', this)">
                        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 2l7 13H2L9 2z"/><path d="M9 7v3M9 12.5v.5"/></svg>
                        Risk Management
                    </button>
                    <button class="sett-nav" onclick="switchSettingsTab('apikeys', this)">
                        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="7" cy="7" r="3"/><path d="M9.5 9.5l6 6M13 13l2-2M14.5 14.5l2-2"/></svg>
                        API Keys
                    </button>
                    <button class="sett-nav" onclick="switchSettingsTab('privacy', this)">
                        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="8" width="10" height="8" rx="1"/><path d="M6 8V5a3 3 0 016 0v3"/></svg>
                        Data &amp; Privacy
                    </button>
                </nav>

                <!-- Content -->
                <div class="sett-content">

                    <!-- GENERAL -->
                    <div class="sett-panel active" id="settingsPanel-general">
                        <div class="sett-panel-head">General</div>
                        <div class="sett-panel-desc">Basic preferences for your account</div>

                        <div class="sett-group">
                            <div class="sett-group-label">Exchange</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Default Exchange</div>
                                    <div class="sett-row-hint">Primary exchange for trading</div>
                                </div>
                                <select id="settDefaultExchange" class="sett-select">
                                    <option value="binance">Binance</option>
                                    <option value="bybit" selected>Bybit</option>
                                    <option value="okx">OKX</option>
                                    <option value="coinbase">Coinbase</option>
                                    <option value="kraken">Kraken</option>
                                    <option value="kucoin">KuCoin</option>
                                </select>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Default Stablecoin</div>
                                    <div class="sett-row-hint">Quote currency for pairs</div>
                                </div>
                                <select id="settDefaultStable" class="sett-select">
                                    <option value="USDT" selected>USDT</option>
                                    <option value="USDC">USDC</option>
                                    <option value="BUSD">BUSD</option>
                                </select>
                            </div>
                        </div>

                        <div class="sett-group">
                            <div class="sett-group-label">Display</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Currency</div>
                                    <div class="sett-row-hint">Display currency for portfolio values</div>
                                </div>
                                <select id="settDisplayCurrency" class="sett-select">
                                    <option value="USD" selected>USD ($)</option>
                                    <option value="EUR">EUR (&euro;)</option>
                                    <option value="GBP">GBP (&pound;)</option>
                                    <option value="BTC">BTC (&#8383;)</option>
                                </select>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Timezone</div>
                                    <div class="sett-row-hint">Times shown in your local zone</div>
                                </div>
                                <select id="settTimezone" class="sett-select">
                                    <option value="auto" selected>Auto (Browser)</option>
                                    <option value="UTC">UTC</option>
                                    <option value="EST">EST</option>
                                    <option value="PST">PST</option>
                                    <option value="IST">IST</option>
                                    <option value="JST">JST</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- APPEARANCE -->
                    <div class="sett-panel" id="settingsPanel-appearance">
                        <div class="sett-panel-head">Appearance</div>
                        <div class="sett-panel-desc">Theme and visual preferences</div>

                        <div class="sett-group">
                            <div class="sett-group-label">Theme</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Color Theme</div>
                                    <div class="sett-row-hint">Choose your preferred theme</div>
                                </div>
                                <select id="settTheme" class="sett-select" onchange="applyTheme(this.value)">
                                    <option value="dark" selected>Dark</option>
                                    <option value="light">Light</option>
                                    <option value="midnight">Midnight</option>
                                </select>
                            </div>
                        </div>

                        <div class="sett-group">
                            <div class="sett-group-label">Accent Color</div>
                            <div class="sett-swatches">
                                <button class="sett-swatch active" onclick="setAccent(this,'#6c63ff')" style="background:#6c63ff"></button>
                                <button class="sett-swatch" onclick="setAccent(this,'#00d395')" style="background:#00d395"></button>
                                <button class="sett-swatch" onclick="setAccent(this,'#3b82f6')" style="background:#3b82f6"></button>
                                <button class="sett-swatch" onclick="setAccent(this,'#e17055')" style="background:#e17055"></button>
                                <button class="sett-swatch" onclick="setAccent(this,'#f59e0b')" style="background:#f59e0b"></button>
                            </div>
                        </div>
                    </div>

                    <!-- NOTIFICATIONS -->
                    <div class="sett-panel" id="settingsPanel-notifications">
                        <div class="sett-panel-head">Notifications</div>
                        <div class="sett-panel-desc">Control what alerts you receive</div>

                        <div class="sett-group">
                            <div class="sett-group-label">Alerts</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Price Alerts</div>
                                    <div class="sett-row-hint">Get notified on significant price moves</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settPriceAlerts" checked><span class="sett-toggle-track"></span></label>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">AI Recommendations</div>
                                    <div class="sett-row-hint">Alerts when AI detects opportunities</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settAIAlerts" checked><span class="sett-toggle-track"></span></label>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Trade Execution</div>
                                    <div class="sett-row-hint">Notifications for filled orders</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settTradeAlerts" checked><span class="sett-toggle-track"></span></label>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Whale Movements</div>
                                    <div class="sett-row-hint">Large transaction alerts</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settWhaleAlerts"><span class="sett-toggle-track"></span></label>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Daily Portfolio Summary</div>
                                    <div class="sett-row-hint">End-of-day performance digest</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settDailySummary" checked><span class="sett-toggle-track"></span></label>
                            </div>
                        </div>
                    </div>

                    <!-- TRADING -->
                    <div class="sett-panel" id="settingsPanel-trading">
                        <div class="sett-panel-head">Trading</div>
                        <div class="sett-panel-desc">Default parameters for trade execution</div>

                        <div class="sett-group">
                            <div class="sett-group-label">Order Defaults</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Default Leverage</div>
                                    <div class="sett-row-hint">Applied to new positions</div>
                                </div>
                                <select id="settDefaultLeverage" class="sett-select">
                                    <option value="1">1x</option>
                                    <option value="2">2x</option>
                                    <option value="5" selected>5x</option>
                                    <option value="10">10x</option>
                                    <option value="25">25x</option>
                                </select>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Default Position Size</div>
                                    <div class="sett-row-hint">Percentage of portfolio per trade</div>
                                </div>
                                <select id="settPositionSize" class="sett-select">
                                    <option value="1">1%</option>
                                    <option value="2" selected>2%</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                </select>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Default Timeframe</div>
                                    <div class="sett-row-hint">Chart &amp; analysis timeframe</div>
                                </div>
                                <select id="settTimeframe" class="sett-select">
                                    <option value="5m">5 min</option>
                                    <option value="15m" selected>15 min</option>
                                    <option value="1h">1 hour</option>
                                    <option value="4h">4 hours</option>
                                    <option value="1d">1 day</option>
                                </select>
                            </div>
                        </div>

                        <div class="sett-group">
                            <div class="sett-group-label">Automation</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Auto Stop-Loss</div>
                                    <div class="sett-row-hint">Automatically set SL on every trade</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settAutoSL" checked><span class="sett-toggle-track"></span></label>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Auto Take-Profit</div>
                                    <div class="sett-row-hint">Automatically set TP targets</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settAutoTP" checked><span class="sett-toggle-track"></span></label>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Paper Trading Mode</div>
                                    <div class="sett-row-hint">Execute trades with simulated funds</div>
                                </div>
                                <div class="sett-row-right">
                                    <label class="sett-toggle"><input type="checkbox" id="settPaperTrading" onchange="togglePaperWarning(this)"><span class="sett-toggle-track"></span></label>
                                </div>
                            </div>
                            <div class="sett-paper-warn" id="paperTradingWarn" style="display:none">
                                <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="#f59e0b" stroke-width="1.5"><path d="M9 2l7 13H2L9 2z"/><path d="M9 7v3M9 12.5v.5"/></svg>
                                Paper mode is active — no real funds will be used
                            </div>
                        </div>
                    </div>

                    <!-- RISK MANAGEMENT -->
                    <div class="sett-panel" id="settingsPanel-risk">
                        <div class="sett-panel-head">Risk Management</div>
                        <div class="sett-panel-desc">Protect your capital with safety controls</div>

                        <div class="sett-group">
                            <div class="sett-group-label">Limits</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Max Daily Loss</div>
                                    <div class="sett-row-hint">Stop trading after this loss amount</div>
                                </div>
                                <div class="sett-input-wrap">
                                    <span class="sett-input-prefix">$</span>
                                    <input type="number" id="settMaxDailyLoss" class="sett-input" value="500" min="0" step="50">
                                </div>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Max Trades / Day</div>
                                    <div class="sett-row-hint">Limit number of daily trades</div>
                                </div>
                                <input type="number" id="settMaxDailyTrades" class="sett-input" value="10" min="1" max="100">
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Max Position Size</div>
                                    <div class="sett-row-hint">Maximum % of portfolio per trade</div>
                                </div>
                                <select id="settMaxPositionSize" class="sett-select">
                                    <option value="2">2%</option>
                                    <option value="5" selected>5%</option>
                                    <option value="10">10%</option>
                                    <option value="25">25%</option>
                                </select>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Stop Loss Default</div>
                                    <div class="sett-row-hint">Default SL percentage for new trades</div>
                                </div>
                                <select id="settDefaultSL" class="sett-select">
                                    <option value="1">1%</option>
                                    <option value="2">2%</option>
                                    <option value="3" selected>3%</option>
                                    <option value="5">5%</option>
                                </select>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Take Profit Default</div>
                                    <div class="sett-row-hint">Default TP percentage for new trades</div>
                                </div>
                                <select id="settDefaultTP" class="sett-select">
                                    <option value="3">3%</option>
                                    <option value="6" selected>6%</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                </select>
                            </div>
                        </div>

                        <div class="sett-group">
                            <div class="sett-group-label">Kill Switch</div>
                            <div class="sett-row sett-killswitch" id="killSwitchRow">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Emergency Kill Switch</div>
                                    <div class="sett-row-hint">Close all positions &amp; halt trading immediately</div>
                                </div>
                                <label class="sett-toggle sett-toggle-danger"><input type="checkbox" id="settKillSwitch" onchange="toggleKillSwitch(this)"><span class="sett-toggle-track"></span></label>
                            </div>
                        </div>
                    </div>

                    <!-- API KEYS -->
                    <div class="sett-panel" id="settingsPanel-apikeys">
                        <div class="sett-panel-head">API Keys</div>
                        <div class="sett-panel-desc">Connect exchange API keys for live trading</div>

                        <div class="sett-api-warn">
                            <svg width="14" height="14" viewBox="0 0 18 18" fill="none" stroke="#f59e0b" stroke-width="1.5"><path d="M9 2l7 13H2L9 2z"/><path d="M9 7v3M9 12.5v.5"/></svg>
                            Use read-only API keys whenever possible. Never share your secret key.
                        </div>

                        <div class="sett-group">
                            <div class="sett-group-label">Connected Keys</div>
                            <div id="settApiKeysList"></div>
                        </div>

                        <div class="sett-group">
                            <div class="sett-group-label">Add New Key</div>
                            <div class="sett-exchange-pills" id="settExchangePills">
                                <button class="sett-pill active" onclick="selectExchangePill(this,'Binance')">Binance</button>
                                <button class="sett-pill" onclick="selectExchangePill(this,'Coinbase')">Coinbase</button>
                                <button class="sett-pill" onclick="selectExchangePill(this,'Kraken')">Kraken</button>
                                <button class="sett-pill" onclick="selectExchangePill(this,'OKX')">OKX</button>
                                <button class="sett-pill" onclick="selectExchangePill(this,'Bybit')">Bybit</button>
                            </div>
                            <input type="hidden" id="settApiExchange" value="Binance">
                            <div class="sett-row" style="border-bottom:none;padding-bottom:0">
                                <div class="sett-row-info"><div class="sett-row-label">API Key</div></div>
                                <input type="password" id="settApiKey" placeholder="Enter API Key" class="sett-input" style="width:220px">
                            </div>
                            <div class="sett-row" style="border-bottom:none;padding-bottom:0">
                                <div class="sett-row-info"><div class="sett-row-label">API Secret</div></div>
                                <input type="password" id="settApiSecret" placeholder="Enter API Secret" class="sett-input" style="width:220px">
                            </div>
                            <div style="margin-top:10px">
                                <button class="sett-btn-primary" onclick="saveApiKey()">Save API Key</button>
                            </div>
                        </div>
                    </div>

                    <!-- DATA & PRIVACY -->
                    <div class="sett-panel" id="settingsPanel-privacy">
                        <div class="sett-panel-head">Data &amp; Privacy</div>
                        <div class="sett-panel-desc">Control how your data is used</div>

                        <div class="sett-group">
                            <div class="sett-group-label">Data Sharing</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Share Trade History for AI</div>
                                    <div class="sett-row-hint">Help improve AI models with anonymized data</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settShareData" checked><span class="sett-toggle-track"></span></label>
                            </div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Analytics Cookies</div>
                                    <div class="sett-row-hint">Usage analytics to improve the platform</div>
                                </div>
                                <label class="sett-toggle"><input type="checkbox" id="settAnalytics" checked><span class="sett-toggle-track"></span></label>
                            </div>
                        </div>

                        <div class="sett-group">
                            <div class="sett-group-label">Data Export</div>
                            <div class="sett-row">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Export Trade History</div>
                                    <div class="sett-row-hint">Download all your data as CSV</div>
                                </div>
                                <button class="sett-btn-outline" onclick="exportTradeData()">
                                    <svg width="13" height="13" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12v3h12v-3M9 3v9M5 8l4 4 4-4"/></svg>
                                    Download CSV
                                </button>
                            </div>
                        </div>

                        <div class="sett-group sett-danger-zone">
                            <div class="sett-group-label" style="color:#ff4757">Danger Zone</div>
                            <div class="sett-row" style="border-bottom:none">
                                <div class="sett-row-info">
                                    <div class="sett-row-label">Delete Account</div>
                                    <div class="sett-row-hint">Permanently remove your account and all data</div>
                                </div>
                                <button class="sett-btn-danger" onclick="confirmDeleteAccount()">Delete Account</button>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="sett-footer">
                        <button class="sett-btn-outline" onclick="resetSettings()">Reset to Default</button>
                        <button class="sett-btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- CONTACT PAGE                                               -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-contact">
        <div class="contact-page-wrap">
            <!-- Heading -->
            <h1 class="contact-heading">Contact Us</h1>
            <p class="contact-subtitle">Have a question or feedback? We typically respond within 24 hours.</p>

            <!-- Send a Query Form -->
            <form class="contact-form" id="contactForm" onsubmit="submitContactForm(event)">
                <div class="contact-field">
                    <label class="contact-label" for="contactName">Your Name</label>
                    <input type="text" id="contactName" class="contact-input" placeholder="John Doe" required>
                </div>
                <div class="contact-field">
                    <label class="contact-label" for="contactEmail">Your Email</label>
                    <input type="email" id="contactEmail" class="contact-input" placeholder="john@example.com" required>
                </div>
                <div class="contact-field">
                    <label class="contact-label" for="contactSubject">Subject</label>
                    <select id="contactSubject" class="contact-input">
                        <option value="general">General Inquiry</option>
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="trading">Trading Support</option>
                        <option value="billing">Billing</option>
                        <option value="partnership">Partnership</option>
                    </select>
                </div>
                <div class="contact-field">
                    <label class="contact-label" for="contactMessage">Message</label>
                    <textarea id="contactMessage" class="contact-input" placeholder="Tell us what's on your mind..." required></textarea>
                </div>
                <button type="submit" class="contact-submit-btn" id="contactSubmitBtn">
                    <span id="contactBtnText">Send Message</span>
                    <span id="contactBtnSpinner" class="contact-spinner" style="display:none"></span>
                </button>
            </form>
            <div id="contactFormStatus" style="display:none"></div>

            <!-- Divider -->
            <div class="contact-divider">
                <span class="contact-divider-text">or reach us directly</span>
            </div>

            <!-- Contact Links -->
            <div class="contact-links">
                <a href="https://wa.me/917061001946" class="contact-link" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    WhatsApp
                </a>
                <a href="https://linkedin.com/company/nexypher" class="contact-link" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                    LinkedIn
                </a>
                <a href="https://twitter.com/nexypher" class="contact-link" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    X (Twitter)
                </a>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- PROFILE PAGE — Bloomberg Terminal Style                    -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-profile">
        <div class="pro-wrap">

            <!-- ── Section 1: Compact Identity Bar ── -->
            <div class="pro-identity-bar">
                <div class="pro-id-left">
                    <div class="pro-avatar-sm" id="profilePhotoWrap" onclick="document.getElementById('profilePhotoInput').click()">
                        <div class="pro-avatar-initials" id="profileAvatarLarge"></div>
                        <img class="pro-avatar-img" id="profilePhotoImg" style="display:none" alt="Profile">
                        <input type="file" id="profilePhotoInput" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="handleProfilePhoto(event)">
                    </div>
                    <div class="pro-id-info">
                        <div class="pro-id-name-row">
                            <span class="pro-id-name" id="profileTitle">User</span>
                            <span class="pro-verify-badge" id="profileVerifyBadge"></span>
                            <span class="pro-paper-tag">PAPER</span>
                        </div>
                        <div class="pro-id-meta" id="profileMemberSince">Member since Feb 2026</div>
                    </div>
                </div>
                <div class="pro-id-right">
                    <button class="pro-id-btn" onclick="showEditProfileModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        Edit Profile
                    </button>
                </div>
            </div>

            <!-- ── Section 2: Stats Row ── -->
            <div class="pro-stats-row">
                <div class="pro-stat-cell">
                    <div class="pro-stat-accent" style="background:#6c63ff"></div>
                    <div class="pro-stat-label">Balance</div>
                    <div class="pro-stat-value" id="proBalanceVal">$0.00</div>
                </div>
                <div class="pro-stat-cell">
                    <div class="pro-stat-accent" style="background:#00d395"></div>
                    <div class="pro-stat-label">Total P&L</div>
                    <div class="pro-stat-value" id="proTotalPnl">$0.00</div>
                </div>
                <div class="pro-stat-cell">
                    <div class="pro-stat-accent" style="background:#3b82f6"></div>
                    <div class="pro-stat-label">Win Rate</div>
                    <div class="pro-stat-value" id="proWinRate">0%</div>
                </div>
                <div class="pro-stat-cell">
                    <div class="pro-stat-accent" style="background:#f59e0b"></div>
                    <div class="pro-stat-label">Trades</div>
                    <div class="pro-stat-value" id="proTotalTrades">0</div>
                </div>
                <div class="pro-stat-cell">
                    <div class="pro-stat-accent" style="background:#00d395"></div>
                    <div class="pro-stat-label">Best Trade</div>
                    <div class="pro-stat-value pro-positive" id="proBestTrade">$0.00</div>
                </div>
            </div>
            <div class="pro-balance-actions">
                <button class="pro-ghost-btn" onclick="showDepositModal()">+ Add Funds</button>
                <button class="pro-ghost-btn" onclick="showWithdrawModal()">Withdraw</button>
                <button class="pro-ghost-btn" onclick="showTransactionsModal()">History</button>
            </div>

            <!-- ── Section 3: Portfolio (Full Width) ── -->
            <div class="pro-portfolio-section">
                <div class="pro-col-header">
                    <h3 class="pro-section-label">Portfolio</h3>
                    <div style="display:flex;gap:8px">
                        <button class="pro-ghost-btn nx-import-btn" id="syncWalletBtn" onclick="syncPortfolioFromWallet()" style="display:none">Import from Wallet
                            <span class="nx-tipbox nx-tipbox-import"><span class="nx-tipbox-arrow"></span><strong style="color:#fff;font-weight:600;display:block;margin-bottom:4px">Read Only Import</strong><span style="color:rgba(255,255,255,0.6)">Imports wallet holdings for display only.</span><br><span style="color:rgba(255,255,255,0.6)">Auto Trader will NEVER trade these assets.</span><div class="nx-tipbox-safe">✓ Real wallet is completely isolated</div></span>
                        </button>
                        <button class="pro-ghost-btn" onclick="showPortfolioModal()">+ Add Position</button>
                    </div>
                </div>
                <div id="portfolioSyncStatus" style="display:none;font-size:11px;color:rgba(255,255,255,0.3);margin-bottom:8px;font-family:'Inter',sans-serif"></div>
                <table class="pro-portfolio-table">
                    <thead>
                        <tr><th>Coin</th><th>Amount</th><th>Avg Price</th><th>Current</th><th>PnL</th></tr>
                    </thead>
                    <tbody id="portfolioBody"></tbody>
                </table>
            </div>

            <!-- ── Section 4: Wallet & Bank (Two Column, Always Visible) ── -->
            <div class="pro-wallet-bank-grid">
                <!-- Left: Connected Wallet -->
                <div class="pro-wb-card">
                    <div class="pro-col-header">
                        <h3 class="pro-section-label">Connected Wallet</h3>
                        <button class="pro-ghost-btn" onclick="showWalletModal()">+ Add Wallet</button>
                    </div>
                    <div id="walletList">
                        <div class="profile-empty-state">No wallets connected yet</div>
                    </div>
                    <div id="walletTxSection"></div>
                </div>
                <!-- Right: Linked Bank -->
                <div class="pro-wb-card">
                    <div class="pro-col-header">
                        <h3 class="pro-section-label">Linked Bank</h3>
                        <button class="pro-ghost-btn" onclick="showBankModal()">+ Add Bank Account</button>
                    </div>
                    <div id="bankList">
                        <div class="pro-bank-empty">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="1.5"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg>
                            <span>No bank accounts linked</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- WATCHLIST PAGE — Full Token Discovery                      -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="page" id="page-watchlist">
        <div class="wl-wrap">
            <div class="wl-header">
                <div class="wl-header-left">
                    <h2 class="wl-title">My Watchlist <span class="wl-count" id="wlCountBadge">0</span></h2>
                </div>
                <div class="wl-header-right">
                    <input class="wl-search" id="wlSearchInput" placeholder="Search watched tokens..." oninput="filterWatchlistCards()">
                    <button class="wl-add-btn" id="wlAddBtn" onclick="showWatchlistAddModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        Add
                    </button>
                </div>
            </div>
            <div class="wl-filters">
                <button class="wl-filter active" data-filter="all" onclick="setWlFilter(this)">All</button>
                <button class="wl-filter" data-filter="gainers" onclick="setWlFilter(this)">Gainers 24h</button>
                <button class="wl-filter" data-filter="losers" onclick="setWlFilter(this)">Losers 24h</button>
                <button class="wl-filter" data-filter="volume" onclick="setWlFilter(this)">Most Volume</button>
                <button class="wl-filter" data-filter="ai" onclick="setWlFilter(this)">AI Score ↑</button>
            </div>
            <div class="wl-grid" id="wlGrid">
                <!-- Token cards rendered by JS -->
            </div>
            <div class="wl-empty" id="wlEmpty" style="display:none">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                <div class="wl-empty-title">No coins in your watchlist</div>
                <div class="wl-empty-desc">Star any token from the Market page or click Add above</div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- EDIT PROFILE MODAL                                         -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal ep-modal">
            <button class="modal-close" onclick="closeModal('editProfileModal')">&times;</button>
            <h2 style="font-size:18px;font-weight:700;margin:0">Edit Profile</h2>
            <p style="font-size:13px;color:rgba(255,255,255,0.35);margin:4px 0 20px">Manage your account details</p>

            <!-- Profile Photo -->
            <div class="ep-section">
                <div style="display:flex;align-items:center;gap:16px">
                    <div class="ep-photo-circle" id="epPhotoCircle" onclick="document.getElementById('profilePhotoInput').click()">
                        <div class="profile-avatar-lg ep-avatar" id="epAvatarInitials"></div>
                        <img class="ep-avatar-img" id="epAvatarImg" style="display:none" alt="">
                    </div>
                    <a href="#" class="ep-link" onclick="event.preventDefault();document.getElementById('profilePhotoInput').click()">Change Photo</a>
                </div>
            </div>

            <!-- Username -->
            <div class="ep-section">
                <label class="ep-label">Username</label>
                <input class="form-input ep-input" id="epUsername" placeholder="Username" autocomplete="off">
                <div class="ep-helper" id="epUsernameError" style="color:#ff4757;display:none">Min 3 characters, no spaces</div>
            </div>

            <!-- Email -->
            <div class="ep-section">
                <label class="ep-label">Email Address</label>
                <div class="ep-email-row">
                    <input class="form-input ep-input ep-readonly" id="epEmail" readonly>
                    <span class="ep-email-badge" id="epEmailBadge"></span>
                </div>
                <div class="ep-helper">To change your email, contact support</div>
            </div>

            <!-- Password -->
            <div class="ep-section">
                <label class="ep-label">Password</label>
                <div class="ep-password-display" id="epPasswordDisplay">
                    <span style="letter-spacing:3px;color:rgba(255,255,255,0.3)">••••••••</span>
                    <a href="#" class="ep-link" onclick="event.preventDefault();togglePasswordChange()">Change Password &rarr;</a>
                </div>
                <div class="ep-password-form" id="epPasswordForm" style="display:none">
                    <input class="form-input ep-input" id="epCurrentPassword" type="password" placeholder="Current password">
                    <input class="form-input ep-input" id="epNewPassword" type="password" placeholder="New password">
                    <input class="form-input ep-input" id="epConfirmPassword" type="password" placeholder="Confirm new password">
                    <div class="ep-helper">8+ chars, 1 number, 1 special character</div>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button class="profile-btn-primary" style="padding:6px 16px;height:auto;font-size:12px" onclick="updatePassword()">Update Password</button>
                        <a href="#" class="ep-link" style="font-size:12px;padding-top:6px" onclick="event.preventDefault();togglePasswordChange()">Cancel</a>
                    </div>
                </div>
            </div>

            <!-- Member Since -->
            <div class="ep-section">
                <label class="ep-label">Member Since</label>
                <div style="font-size:13px;color:rgba(255,255,255,0.35);font-family:'Inter',sans-serif" id="epMemberSince">February 2026</div>
            </div>

            <!-- Danger Zone -->
            <div class="ep-section ep-danger">
                <div class="ep-danger-header" onclick="this.parentElement.classList.toggle('expanded')">
                    <span>&#9654; Danger Zone</span>
                </div>
                <div class="ep-danger-body">
                    <button class="ep-delete-btn" onclick="confirmDeleteAccount()">Delete Account</button>
                    <div class="ep-helper" style="margin-top:8px">This will permanently delete your account, trading history, and AI training data. This action cannot be undone.</div>
                </div>
            </div>

            <!-- Save -->
            <button class="ep-save-btn" onclick="saveEditProfile()">Save Changes</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- AUTH MODAL                                                 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
            <h2 id="authTitle">Login</h2>
            <div id="authError" class="form-error"></div>

            <div id="registerFields" style="display:none">
                <div class="form-group">
                    <label>Username</label>
                    <input class="form-input" id="regUsername" placeholder="Choose a username">
                </div>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input class="form-input" id="authEmail" type="email" placeholder="you@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input class="form-input" id="authPassword" type="password"
                    placeholder="Min 8 chars, 1 uppercase, 1 digit" onkeydown="if(event.key==='Enter')submitAuth()">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:8px;transition:opacity 0.2s" id="authSubmitBtn"
                onclick="submitAuth()">Login</button>

            <p id="forgotPassLink" style="text-align:right;margin-top:8px;font-size:13px;">
                <a href="#" style="color:#7c5cff" onclick="showForgotPassword(event)">Forgot password?</a>
            </p>

            <div class="form-divider">or</div>
            <p style="text-align:center;font-size:13px;color:var(--text-secondary)">
                <span id="authToggleText">Don't have an account?</span>
                <a href="#" id="authToggleLink" onclick="toggleAuthMode(event)">Register</a>
            </p>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- FORGOT PASSWORD MODAL                                      -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="forgotModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('forgotModal')">&times;</button>
            <h2>Reset Password</h2>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Enter your email and we'll send
                you a reset link.</p>
            <div id="forgotError" class="form-error"></div>
            <div id="forgotSuccess"
                style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input class="form-input" id="forgotEmail" type="email" placeholder="you@example.com">
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="submitForgotPassword()">Send Reset
                Link</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- WALLET ADD MODAL                                           -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="walletModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('walletModal')">&times;</button>
            <h2>Connect Wallet</h2>
            <div class="form-group">
                <label>Wallet Address</label>
                <input class="form-input" id="walletAddr" placeholder="0x... or SOL address">
            </div>
            <div class="form-group">
                <label>Chain</label>
                <select class="form-input" id="walletChain">
                    <option value="ethereum">Ethereum</option>
                    <option value="solana">Solana</option>
                    <option value="base">Base</option>
                    <option value="polygon">Polygon</option>
                    <option value="bsc">BSC</option>
                </select>
            </div>
            <div class="form-group">
                <label>Label (optional)</label>
                <input class="form-input" id="walletLabel" placeholder="e.g. My MetaMask">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addWallet()">Add Wallet</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- ADD BANK ACCOUNT MODAL                                     -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="bankModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('bankModal')">&times;</button>
            <h2>🏦 Link Bank Account</h2>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Your bank details are verified
                instantly and stored securely.</p>

            <div class="verify-steps" id="bankSteps">
                <div class="verify-step active" id="bankStep1">1. Details</div>
                <div class="verify-step" id="bankStep2">2. Send OTP</div>
                <div class="verify-step" id="bankStep3">3. Verify OTP</div>
                <div class="verify-step" id="bankStep4">4. Linked ✓</div>
            </div>

            <div id="bankError" class="form-error"></div>
            <div id="bankSuccess"
                style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;">
            </div>

            <div id="bankFormFields">
                <div class="form-group">
                    <label>Account Holder Name</label>
                    <input class="form-input" id="bankHolder" placeholder="As on bank passbook">
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input class="form-input" id="bankAccNum" placeholder="9-18 digit account number" maxlength="18">
                </div>
                <div class="form-group">
                    <label>Confirm Account Number</label>
                    <input class="form-input" id="bankAccNumConfirm" placeholder="Re-enter account number"
                        maxlength="18">
                </div>
                <div class="form-group">
                    <label>IFSC Code</label>
                    <input class="form-input" id="bankIFSC" placeholder="e.g. SBIN0001234" maxlength="11"
                        style="text-transform:uppercase">
                </div>
                <div class="form-group">
                    <label>Bank Name</label>
                    <input class="form-input" id="bankName" placeholder="e.g. State Bank of India">
                </div>
                <div class="form-group">
                    <label>📱 Phone Number (linked to bank account)</label>
                    <input class="form-input" id="bankPhone" placeholder="e.g. 9876543210" maxlength="13">
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px">OTP will be sent to this number
                        for verification</div>
                </div>
                <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="sendBankOTP()">📲 Send OTP to
                    Verify Phone</button>
            </div>

            <!-- OTP Verification Step for Bank -->
            <div id="bankOTPStep" style="display:none">
                <div style="text-align:center;padding:12px 0">
                    <div style="font-size:36px;margin-bottom:8px">📲</div>
                    <p style="color:var(--text-secondary);font-size:13px">Enter the 6-digit OTP sent to <strong
                            id="bankOTPPhone">••••••••</strong></p>
                    <input class="form-input" id="bankOTPCode" placeholder="Enter 6-digit OTP" maxlength="6"
                        style="text-align:center;font-size:24px;letter-spacing:8px;margin:12px auto;max-width:240px">
                    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                        <button class="btn btn-primary" style="flex:1;max-width:200px" onclick="verifyBankOTPAndAdd()">✅
                            Verify & Link</button>
                    </div>
                    <button class="btn btn-outline btn-sm" style="margin-top:12px" onclick="resendBankOTP()">🔄 Resend
                        OTP</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- DEPOSIT MODAL                                              -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="depositModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('depositModal')">&times;</button>
            <h2>💰 Add Money to Wallet</h2>
            <div id="depositError" class="form-error"></div>
            <div id="depositSuccess"
                style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;">
            </div>

            <div id="depositNoBanks" style="display:none;text-align:center;padding:20px;color:var(--text-muted);">
                <p>No bank account linked yet.</p>
                <button class="btn btn-primary" style="margin-top:12px"
                    onclick="closeModal('depositModal');showBankModal()">Link Bank Account</button>
            </div>

            <div id="depositFields">
                <div class="form-group">
                    <label>Select Bank Account</label>
                    <select class="form-input" id="depositBank"></select>
                </div>
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input class="form-input" id="depositAmount" type="number" min="1" step="any"
                        placeholder="Enter amount">
                </div>
                <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                    <button class="btn btn-outline btn-sm" onclick="setDepositAmount(500)">$500</button>
                    <button class="btn btn-outline btn-sm" onclick="setDepositAmount(1000)">$1,000</button>
                    <button class="btn btn-outline btn-sm" onclick="setDepositAmount(5000)">$5,000</button>
                    <button class="btn btn-outline btn-sm" onclick="setDepositAmount(10000)">$10,000</button>
                    <button class="btn btn-outline btn-sm" onclick="setDepositAmount(50000)">$50,000</button>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="sendDepositOTP()">Send OTP &
                    Proceed</button>
            </div>

            <!-- OTP Step -->
            <div id="depositOTPStep" style="display:none">
                <div
                    style="text-align:center;padding:16px 0;margin-bottom:16px;background:var(--bg-secondary);border-radius:var(--radius)">
                    <div style="font-size:32px;margin-bottom:8px">🔐</div>
                    <div style="font-size:14px;color:var(--text-secondary)">OTP sent to</div>
                    <div id="depositOTPPhone" style="font-size:18px;font-weight:700;margin-top:4px">••••••••00</div>
                </div>
                <div class="form-group">
                    <label>Enter 6-digit OTP</label>
                    <input class="form-input" id="depositOTP" type="text" maxlength="6" placeholder="000000"
                        style="text-align:center;font-size:24px;letter-spacing:8px;font-weight:700">
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-primary" style="flex:1" onclick="submitDeposit()">✅ Verify & Deposit</button>
                    <button class="btn btn-outline" onclick="resendOTP('deposit')">🔄 Resend</button>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center">OTP expires in 5
                    minutes</div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- WITHDRAW MODAL                                             -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('withdrawModal')">&times;</button>
            <h2>📤 Withdraw to Bank</h2>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">Available: <strong>$<span
                        id="withdrawAvailable">0.00</span></strong></p>
            <div id="withdrawError" class="form-error"></div>
            <div id="withdrawSuccess"
                style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;">
            </div>

            <div id="withdrawFields">
                <div class="form-group">
                    <label>Select Bank Account</label>
                    <select class="form-input" id="withdrawBank"></select>
                </div>
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input class="form-input" id="withdrawAmount" type="number" min="1" step="any"
                        placeholder="Enter amount">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="sendWithdrawOTP()">Send OTP &
                    Proceed</button>
            </div>

            <!-- OTP Step -->
            <div id="withdrawOTPStep" style="display:none">
                <div
                    style="text-align:center;padding:16px 0;margin-bottom:16px;background:var(--bg-secondary);border-radius:var(--radius)">
                    <div style="font-size:32px;margin-bottom:8px">🔐</div>
                    <div style="font-size:14px;color:var(--text-secondary)">OTP sent to</div>
                    <div id="withdrawOTPPhone" style="font-size:18px;font-weight:700;margin-top:4px">••••••••00</div>
                </div>
                <div class="form-group">
                    <label>Enter 6-digit OTP</label>
                    <input class="form-input" id="withdrawOTP" type="text" maxlength="6" placeholder="000000"
                        style="text-align:center;font-size:24px;letter-spacing:8px;font-weight:700">
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-primary" style="flex:1" onclick="submitWithdraw()">✅ Verify &
                        Withdraw</button>
                    <button class="btn btn-outline" onclick="resendOTP('withdraw')">🔄 Resend</button>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center">OTP expires in 5
                    minutes</div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- TRANSACTIONS MODAL                                         -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="transactionsModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('transactionsModal')">&times;</button>
            <h2>📋 Transaction History</h2>
            <div id="transactionsList" style="max-height:400px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- PORTFOLIO ADD MODAL                                        -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="portfolioModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('portfolioModal')">&times;</button>
            <h2>Add Position</h2>
            <p style="color:rgba(255,255,255,0.35);font-size:12px;margin-bottom:16px;line-height:1.5">Enter position details manually. This is for tracking purposes only.</p>
            <div class="form-group">
                <label>Coin ID (e.g. bitcoin, solana)</label>
                <input class="form-input" id="pfCoinId" placeholder="bitcoin">
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input class="form-input" id="pfAmount" type="number" step="any" placeholder="0.5">
            </div>
            <div class="form-group">
                <label>Avg Buy Price ($)</label>
                <input class="form-input" id="pfPrice" type="number" step="any" placeholder="65000">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addPortfolioItem()">Add
                Position</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- TOKEN DETAIL MODAL                                         -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal modal-lg">
            <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
            <div id="detailContent">
                <div class="loader">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- JAVASCRIPT                                                 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <script>
        // ── State ─────────────────────────────────────────────────────
        let currentUser = null;
        let authToken = localStorage.getItem('nexypher_token') || null;
        let currentPage = 'home';
        let feedSort = 'volume';
        let feedStatus = 'all';
        let feedData = [];

        const API = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? '' : 'https://nexypher-api.onrender.com';

        // ── TradingView Symbol Mapping ────────────────────────────────
        const TV_SYMBOL_MAP = {
            'bitcoin': 'BINANCE:BTCUSDT',
            'ethereum': 'BINANCE:ETHUSDT',
            'solana': 'BINANCE:SOLUSDT',
            'ripple': 'BINANCE:XRPUSDT',
            'dogecoin': 'BINANCE:DOGEUSDT',
            'cardano': 'BINANCE:ADAUSDT',
            'avalanche-2': 'BINANCE:AVAXUSDT',
            'chainlink': 'BINANCE:LINKUSDT',
            'polkadot': 'BINANCE:DOTUSDT',
            'matic-network': 'BINANCE:MATICUSDT',
            'litecoin': 'BINANCE:LTCUSDT',
            'uniswap': 'BINANCE:UNIUSDT',
            'shiba-inu': 'BINANCE:SHIBUSDT',
            'tron': 'BINANCE:TRXUSDT',
            'stellar': 'BINANCE:XLMUSDT',
            'cosmos': 'BINANCE:ATOMUSDT',
            'monero': 'BINANCE:XMRUSDT',
            'near': 'BINANCE:NEARUSDT',
            'aptos': 'BINANCE:APTUSDT',
            'arbitrum': 'BINANCE:ARBUSDT',
            'optimism': 'BINANCE:OPUSDT',
            'filecoin': 'BINANCE:FILUSDT',
            'aave': 'BINANCE:AAVEUSDT',
            'the-graph': 'BINANCE:GRTUSDT',
            'render-token': 'BINANCE:RENDERUSDT',
            'injective-protocol': 'BINANCE:INJUSDT',
            'sui': 'BINANCE:SUIUSDT',
            'pepe': 'BINANCE:PEPEUSDT',
            'bitcoin-cash': 'BINANCE:BCHUSDT',
            'internet-computer': 'BINANCE:ICPUSDT',
            'hedera-hashgraph': 'BINANCE:HBARUSDT',
            'vechain': 'BINANCE:VETUSDT',
            'fantom': 'BINANCE:FTMUSDT',
            'algorand': 'BINANCE:ALGOUSDT',
            'sei-network': 'BINANCE:SEIUSDT',
            'bonk': 'BINANCE:BONKUSDT',
            'floki': 'BINANCE:FLOKIUSDT',
            'celestia': 'BINANCE:TIAUSDT',
            'jupiter': 'BINANCE:JUPUSDT',
            'ondo-finance': 'BINANCE:ONDOUSDT',
        };

        let currentInsightSymbol = '';
        let currentInsightTF = 'D';

        function getTVSymbol(coinId, symbol) {
            if (TV_SYMBOL_MAP[coinId]) return TV_SYMBOL_MAP[coinId];
            // Fallback: try constructing from symbol
            if (symbol) return 'BINANCE:' + symbol.toUpperCase() + 'USDT';
            return null;
        }

        function renderTVAdvancedChart(containerId, symbol, interval) {
            const container = document.getElementById(containerId);
            if (!container || !symbol) return;
            container.innerHTML = '<div class="tv-loading"><div class="spinner"></div><div>Loading chart...</div></div>';

            const frameId = 'tv_' + containerId + '_' + Date.now();
            const params = new URLSearchParams({
                frameElementId: frameId,
                symbol: symbol,
                interval: interval || 'D',
                theme: 'dark',
                style: '1',
                locale: 'en',
                allow_symbol_change: '1',
                calendar: '0',
                save_image: '0',
                hide_volume: '0',
                backgroundColor: 'rgba(26, 31, 46, 1)',
                gridColor: 'rgba(255, 255, 255, 0.04)',
                utm_source: location.hostname,
                utm_medium: 'widget_new',
                utm_campaign: 'chart'
            });

            const iframe = document.createElement('iframe');
            iframe.id = frameId;
            iframe.src = 'https://s.tradingview.com/widgetembed/?' + params.toString();
            iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allowtransparency', 'true');
            iframe.setAttribute('allowfullscreen', '');

            const loadTimeout = setTimeout(() => {
                if (container.querySelector('.tv-loading')) {
                    container.innerHTML = `<div class="tv-error">
                <div class="tv-error-icon">📊</div>
                <div>Chart is taking longer than usual to load</div>
                <button class="tv-retry-btn" onclick="renderTVAdvancedChart('${containerId}','${symbol}','${interval || 'D'}')">↻ Retry</button>
            </div>`;
                }
            }, 20000);

            iframe.onload = () => {
                clearTimeout(loadTimeout);
                const loading = container.querySelector('.tv-loading');
                if (loading) loading.remove();
            };

            container.innerHTML = '';
            container.appendChild(iframe);
        }

        function renderTVTechnicalAnalysis(containerId, symbol) {
            const container = document.getElementById(containerId);
            if (!container || !symbol) return;
            container.innerHTML = '<div class="tv-loading"><div class="spinner"></div><div>Loading analysis...</div></div>';

            const config = JSON.stringify({
                interval: '1D', width: '100%', isTransparent: true, height: '100%',
                symbol: symbol, showIntervalTabs: true, displayMode: 'single',
                locale: 'en', colorTheme: 'dark'
            });

            const iframe = document.createElement('iframe');
            iframe.src = 'https://s.tradingview.com/embed-widget/technical-analysis/?locale=en#' + encodeURIComponent(config);
            iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allowtransparency', 'true');

            const loadTimeout = setTimeout(() => {
                if (container.querySelector('.tv-loading')) {
                    container.innerHTML = `<div class="tv-error">
                <div class="tv-error-icon">🔮</div>
                <div>Technical analysis unavailable</div>
                <button class="tv-retry-btn" onclick="renderTVTechnicalAnalysis('${containerId}','${symbol}')">↻ Retry</button>
            </div>`;
                }
            }, 20000);

            iframe.onload = () => {
                clearTimeout(loadTimeout);
                const loading = container.querySelector('.tv-loading');
                if (loading) loading.remove();
            };

            container.innerHTML = '';
            container.appendChild(iframe);
        }

        function renderTVMiniChart(containerId, symbol) {
            const container = document.getElementById(containerId);
            if (!container || !symbol) return;
            container.innerHTML = '';

            const config = JSON.stringify({
                symbol: symbol, width: '100%', height: '100%', locale: 'en',
                dateRange: '1M', colorTheme: 'dark', isTransparent: true, autosize: true
            });

            const iframe = document.createElement('iframe');
            iframe.src = 'https://s.tradingview.com/embed-widget/mini-symbol-overview/?locale=en#' + encodeURIComponent(config);
            iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allowtransparency', 'true');
            container.appendChild(iframe);
        }

        function switchInsightTF(tf, btn) {
            currentInsightTF = tf;
            document.querySelectorAll('.tv-tf-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            if (currentInsightSymbol) {
                renderTVAdvancedChart('insightTVChartWidget', currentInsightSymbol, tf);
            }
        }

        async function api(path, opts = {}) {
            const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
            if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

            // Retry once on 500 (handles Vercel cold-start / init race)
            for (let attempt = 0; attempt < 2; attempt++) {
                try {
                    const resp = await fetch(API + path, { ...opts, headers });
                    if (resp.status === 500 && attempt === 0) {
                        await new Promise(r => setTimeout(r, 1500));
                        continue;  // retry once
                    }
                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        throw new Error(err.detail || resp.statusText || 'Server error');
                    }
                    return resp.json();
                } catch (e) {
                    if (attempt === 0 && (e.message === 'Failed to fetch' || e.message === 'Load failed')) {
                        await new Promise(r => setTimeout(r, 2000));
                        continue;  // retry once on network error (cold start)
                    }
                    throw e;
                }
            }
        }

        // ── UI Helpers ────────────────────────────────────────────────
        function skeletonRows(cols, rows = 5) {
            const sizes = ['w-sm', 'w-md', 'w-lg', 'w-md', 'w-md', 'w-sm'];
            return Array.from({ length: rows }, () =>
                `<tr>${Array.from({ length: cols }, (_, i) =>
                    `<td><div class="skeleton skeleton-cell ${sizes[i % sizes.length]}" style="height:14px">&nbsp;</div></td>`
                ).join('')}</tr>`
            ).join('');
        }

        function errorWithRetry(message, retryFn) {
            return `<div class="error-state">
        <div class="error-icon">⚠️</div>
        <div class="error-msg">${message}</div>
        <button class="retry-btn" onclick="${retryFn}">↻ Retry</button>
    </div>`;
        }

        function debounce(fn, ms = 300) {
            let timer;
            return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); };
        }

        function fmt(n) {
            if (n == null || isNaN(n)) return '-';
            if (n >= 1e9) return '$' + (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
            if (n >= 1e3) return '$' + (n / 1e3).toFixed(2) + 'K';
            if (n >= 1) return '$' + n.toFixed(2);
            if (n >= 0.001) return '$' + n.toFixed(4);
            return '$' + n.toFixed(8);
        }

        function fmtPct(n) {
            if (n == null) return '-';
            const cls = n >= 0 ? 'price-positive' : 'price-negative';
            const arrow = n >= 0 ? '▲' : '▼';
            return `<span class="${cls}">${arrow} ${Math.abs(n).toFixed(2)}%</span>`;
        }

        function scoreColor(s) {
            if (s >= 7) return 'green'; if (s >= 4) return 'yellow'; return 'red';
        }

        // ── Navigation ────────────────────────────────────────────────
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => navigate(tab.dataset.page));
        });

        function navigate(page) {
            if ((page === 'profile' || page === 'watchlist') && !currentUser) {
                showAuthModal('login');
                return;
            }
            // Redirect removed pages to their merged destinations
            if (page === 'home') page = 'market';
            if (page === 'feed') page = 'market';
            if (page === 'ai') page = 'insights';

            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + page)?.classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.page === page);
            });

            // Load data for page
            if (page === 'market') { loadMarket(); }
            else if (page === 'insights') { loadAIGlobal(); }
            else if (page === 'learning') { loadLearningStats(); loadStrategyAdjustments(); }
            else if (page === 'trader') { loadTraderDashboard(); }
            else if (page === 'settings') { loadSettings(); }
            else if (page === 'contact') { /* static page */ }
            else if (page === 'profile') { loadProfile(); }
            else if (page === 'watchlist') { loadWatchlistPage(); }

            // Paper mode indicator
            var paperNav = document.getElementById('nxPaperNav');
            if (paperNav) paperNav.classList.toggle('visible', page === 'trader');
            // Onboarding banner
            if (page === 'trader' && typeof window._nxShowOnboarding === 'function') window._nxShowOnboarding();
        }

        // ── Auth ──────────────────────────────────────────────────────
        let authMode = 'login';

        function showAuthModal(mode) {
            authMode = mode;
            document.getElementById('authTitle').textContent = mode === 'login' ? 'Login' : 'Create Account';
            document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Login' : 'Register';
            document.getElementById('registerFields').style.display = mode === 'register' ? 'block' : 'none';
            document.getElementById('forgotPassLink').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('authToggleText').textContent = mode === 'login' ? "Don't have an account?" : "Already have an account?";
            document.getElementById('authToggleLink').textContent = mode === 'login' ? 'Register' : 'Login';
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authModal').classList.add('active');
            // Focus first visible input
            setTimeout(() => {
                if (mode === 'register') document.getElementById('regUsername').focus();
                else document.getElementById('authEmail').focus();
            }, 100);
        }

        function toggleAuthMode(e) {
            e.preventDefault();
            showAuthModal(authMode === 'login' ? 'register' : 'login');
        }

        async function submitAuth() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const errEl = document.getElementById('authError');
            const btn = document.getElementById('authSubmitBtn');

            // Validation
            if (!email) { errEl.textContent = 'Please enter your email'; errEl.style.display = 'block'; return; }
            if (!password || password.length < 8) { errEl.textContent = 'Password must be at least 8 characters with 1 uppercase letter and 1 digit'; errEl.style.display = 'block'; return; }
            if (authMode === 'register') {
                const username = document.getElementById('regUsername').value.trim();
                if (!username) { errEl.textContent = 'Please enter a username'; errEl.style.display = 'block'; return; }
            }

            // Show loading state
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = authMode === 'login' ? 'Logging in...' : 'Creating account...';
            btn.style.opacity = '0.7';
            errEl.style.display = 'none';

            try {
                let data;
                if (authMode === 'login') {
                    data = await api('/api/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ email, password }),
                    });
                } else {
                    const username = document.getElementById('regUsername').value.trim();
                    data = await api('/api/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({ email, password, username }),
                    });

                    // Show verification message after registration
                    if (data.verification_sent) {
                        errEl.style.color = '#00d4aa';
                        errEl.innerHTML = '✅ Account created! Check <strong>' + email + '</strong> for a verification link before logging in.';
                        errEl.style.display = 'block';
                        btn.disabled = false;
                        btn.textContent = originalText;
                        btn.style.opacity = '1';
                        // Switch to login mode after showing message
                        setTimeout(() => showAuthModal('login'), 4000);
                        return;
                    }
                }

                authToken = data.access_token;
                localStorage.setItem('nexypher_token', authToken);
                currentUser = data.user;
                updateAuthUI();
                closeModal('authModal');
            } catch (e) {
                const msg = e.message || 'Something went wrong. Please try again.';
                // Handle email verification required (403)
                if (msg.includes('verify your email')) {
                    errEl.style.color = '#ff9900';
                    errEl.innerHTML = '📧 ' + msg + '<br><a href="#" style="color:#7c5cff;font-size:12px;margin-top:6px;display:inline-block" onclick="resendVerificationFromLogin(\'' + email + '\')">Resend verification email</a>';
                } else {
                    errEl.style.color = '#ff4d4d';
                    errEl.textContent = msg;
                }
                errEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.opacity = '1';
            }
        }

        // ── Forgot Password ──────────────────────────────────────────
        function showForgotPassword(e) {
            e.preventDefault();
            closeModal('authModal');
            document.getElementById('forgotError').style.display = 'none';
            document.getElementById('forgotSuccess').style.display = 'none';
            document.getElementById('forgotEmail').value = document.getElementById('authEmail').value || '';
            document.getElementById('forgotModal').classList.add('active');
        }

        async function submitForgotPassword() {
            const email = document.getElementById('forgotEmail').value;
            const errEl = document.getElementById('forgotError');
            const succEl = document.getElementById('forgotSuccess');
            errEl.style.display = 'none';
            succEl.style.display = 'none';

            if (!email) { errEl.textContent = 'Please enter your email'; errEl.style.display = 'block'; return; }

            try {
                const data = await api('/api/auth/forgot-password', {
                    method: 'POST',
                    body: JSON.stringify({ email }),
                });
                succEl.textContent = data.message;
                succEl.style.display = 'block';
            } catch (e) {
                errEl.textContent = e.message;
                errEl.style.display = 'block';
            }
        }

        // ── Resend Verification ──────────────────────────────────────
        async function resendVerification() {
            try {
                const data = await api('/api/auth/resend-verification', { method: 'POST' });
                alert(data.message || 'Verification email sent!');
            } catch (e) {
                alert(e.message || 'Failed to send verification email');
            }
        }

        async function resendVerificationFromLogin(email) {
            const errEl = document.getElementById('authError');
            try {
                const data = await api('/api/auth/resend-verification-by-email', {
                    method: 'POST',
                    body: JSON.stringify({ email }),
                });
                errEl.style.color = '#00d4aa';
                errEl.innerHTML = data.message || 'Verification email sent! Check your inbox.';
            } catch (e) {
                errEl.innerHTML = e.message || 'Failed to resend';
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('nexypher_token');
            updateAuthUI();
            navigate('home');
        }

        function getProfilePhoto() {
            return localStorage.getItem('nexypher_profile_photo') || null;
        }

        function updateAuthUI() {
            const area = document.getElementById('authArea');
            const navWlBtn = document.getElementById('navWatchlistBtn');
            if (currentUser) {
                if (navWlBtn) { navWlBtn.style.display = 'flex'; updateWatchlistNavCount((currentUser.watchlist||[]).length); }
                const initials = (currentUser.username || currentUser.email).slice(0, 2).toUpperCase();
                const displayName = currentUser.username || currentUser.email.split('@')[0];
                const photo = getProfilePhoto();
                const avatarContent = photo
                    ? `<img src="${photo}" class="user-menu-avatar-img" alt="">`
                    : `<div class="user-menu-avatar">${initials}</div>`;
                area.innerHTML = `
            <div class="user-menu" id="userMenu">
                <div class="user-menu-trigger" onclick="toggleUserMenu(event)">
                    ${avatarContent}
                    <span class="user-menu-name">${displayName}</span>
                    <svg class="user-menu-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                </div>
                <div class="user-menu-dropdown">
                    <div class="user-menu-header">
                        <span class="user-menu-header-name">${displayName}</span>
                        <span class="user-menu-header-status">Paper Mode</span>
                    </div>
                    <div class="user-menu-divider"></div>
                    <button class="user-menu-item" onclick="navigate('profile'); closeUserMenu()">
                        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="5" r="3"/><path d="M2 14c0-3 2.7-5 6-5s6 2 6 5"/></svg>
                        Profile
                    </button>
                    <button class="user-menu-item" onclick="openPnlHeatmap(); closeUserMenu()">
                        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="4" height="4" rx="0.5"/><rect x="6" y="1" width="4" height="4" rx="0.5"/><rect x="11" y="1" width="4" height="4" rx="0.5"/><rect x="1" y="6" width="4" height="4" rx="0.5"/><rect x="6" y="6" width="4" height="4" rx="0.5"/><rect x="11" y="6" width="4" height="4" rx="0.5"/><rect x="1" y="11" width="4" height="4" rx="0.5"/><rect x="6" y="11" width="4" height="4" rx="0.5"/><rect x="11" y="11" width="4" height="4" rx="0.5"/></svg>
                        P&amp;L Heatmap
                    </button>
                    <button class="user-menu-item" onclick="navigate('settings'); closeUserMenu()">
                        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="2"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M2.9 2.9l1.4 1.4M11.7 11.7l1.4 1.4M13.1 2.9l-1.4 1.4M4.3 11.7l-1.4 1.4"/></svg>
                        Settings
                    </button>
                    <div class="user-menu-divider"></div>
                    <button class="user-menu-item danger" onclick="logout(); closeUserMenu()">
                        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2H3a1 1 0 00-1 1v10a1 1 0 001 1h3M11 11l3-3-3-3M14 8H6"/></svg>
                        Log out
                    </button>
                </div>
            </div>`;
            } else {
                if (navWlBtn) navWlBtn.style.display = 'none';
                area.innerHTML = '<button class="btn btn-primary" onclick="showAuthModal(\'login\')">Login</button>';
            }
        }

        function toggleUserMenu(e) {
            e.stopPropagation();
            document.getElementById('userMenu').classList.toggle('open');
        }
        function closeUserMenu() {
            const m = document.getElementById('userMenu');
            if (m) m.classList.remove('open');
        }
        document.addEventListener('click', function(e) {
            const m = document.getElementById('userMenu');
            if (m && !m.contains(e.target)) m.classList.remove('open');
        });

        async function checkAuth() {
            if (!authToken) return;
            try {
                currentUser = await api('/api/auth/me');
                updateAuthUI();
            } catch {
                authToken = null;
                localStorage.removeItem('nexypher_token');
            }
        }

        // ── Modals ────────────────────────────────────────────────────
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Close modals on backdrop click
        document.querySelectorAll('.modal-overlay').forEach(ov => {
            ov.addEventListener('click', e => {
                if (e.target === ov) ov.classList.remove('active');
            });
        });

        // ── Wallet ────────────────────────────────────────────────────
        function showWalletModal() {
            document.getElementById('walletModal').classList.add('active');
        }

        async function addWallet() {
            const address = document.getElementById('walletAddr').value;
            const chain = document.getElementById('walletChain').value;
            const label = document.getElementById('walletLabel').value;
            if (!address) return;
            try {
                await api('/api/wallet/add', {
                    method: 'POST',
                    body: JSON.stringify({ address, chain, label }),
                });
                closeModal('walletModal');
                loadProfile();
            } catch (e) {
                alert(e.message);
            }
        }

        async function removeWallet(addr, chain) {
            try {
                await api(`/api/wallet/${encodeURIComponent(addr)}?chain=${chain}`, { method: 'DELETE' });
                loadProfile();
            } catch (e) {
                alert(e.message);
            }
        }

        // ── Bank Accounts ──────────────────────────────────────────────
        function showBankModal() {
            document.getElementById('bankError').style.display = 'none';
            document.getElementById('bankSuccess').style.display = 'none';
            document.getElementById('bankFormFields').style.display = 'block';
            document.getElementById('bankOTPStep').style.display = 'none';
            document.getElementById('bankStep1').className = 'verify-step active';
            document.getElementById('bankStep2').className = 'verify-step';
            document.getElementById('bankStep3').className = 'verify-step';
            document.getElementById('bankStep4').className = 'verify-step';
            ['bankHolder', 'bankAccNum', 'bankAccNumConfirm', 'bankIFSC', 'bankName', 'bankPhone'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('bankModal').classList.add('active');
        }

        // Auto-detect bank from IFSC
        document.addEventListener('DOMContentLoaded', () => {
            const ifscEl = document.getElementById('bankIFSC');
            if (ifscEl) {
                ifscEl.addEventListener('input', function () {
                    const prefix = this.value.toUpperCase().substring(0, 4);
                    const banks = {
                        'SBIN': 'State Bank of India', 'HDFC': 'HDFC Bank', 'ICIC': 'ICICI Bank',
                        'UTIB': 'Axis Bank', 'PUNB': 'Punjab National Bank', 'CNRB': 'Canara Bank',
                        'UBIN': 'Union Bank of India', 'BARB': 'Bank of Baroda', 'KKBK': 'Kotak Mahindra Bank',
                        'YESB': 'Yes Bank', 'INDB': 'IndusInd Bank', 'FDRL': 'Federal Bank',
                        'IOBA': 'Indian Overseas Bank', 'IDIB': 'Indian Bank', 'BKID': 'Bank of India',
                    };
                    if (banks[prefix]) document.getElementById('bankName').value = banks[prefix];
                });
            }
        });

        // Cached bank form data for OTP step
        let pendingBankData = null;

        async function sendBankOTP() {
            const holder = document.getElementById('bankHolder').value.trim();
            const accNum = document.getElementById('bankAccNum').value.trim();
            const accConfirm = document.getElementById('bankAccNumConfirm').value.trim();
            const ifsc = document.getElementById('bankIFSC').value.trim().toUpperCase();
            const bankName = document.getElementById('bankName').value.trim();
            const phone = document.getElementById('bankPhone').value.trim();
            const errEl = document.getElementById('bankError');
            errEl.style.display = 'none';

            // Client-side checks
            if (!holder || !accNum || !ifsc || !bankName) {
                errEl.textContent = 'All fields are required'; errEl.style.display = 'block'; return;
            }
            if (accNum !== accConfirm) {
                errEl.textContent = 'Account numbers do not match'; errEl.style.display = 'block'; return;
            }
            if (!phone || phone.replace(/[\s\-]/g, '').length < 10) {
                errEl.textContent = 'A valid 10-digit phone number is required'; errEl.style.display = 'block'; return;
            }

            // Step 2: Sending OTP
            document.getElementById('bankStep1').className = 'verify-step done';
            document.getElementById('bankStep2').className = 'verify-step active';

            try {
                // First verify bank details format
                const verifyResult = await api('/api/bank/verify', {
                    method: 'POST',
                    body: JSON.stringify({ account_holder: holder, account_number: accNum, ifsc_code: ifsc, bank_name: bankName, phone_number: phone }),
                });
                if (!verifyResult.verified) {
                    document.getElementById('bankStep2').className = 'verify-step';
                    document.getElementById('bankStep1').className = 'verify-step active';
                    errEl.textContent = verifyResult.errors.join(', '); errEl.style.display = 'block'; return;
                }

                // Send OTP to phone
                const otpResult = await api('/api/bank/send-otp', {
                    method: 'POST',
                    body: JSON.stringify({ phone_number: phone, action: 'bank_verify' }),
                });

                // Cache form data
                pendingBankData = { holder, accNum, ifsc, bankName, phone };

                // Show OTP step
                document.getElementById('bankStep2').className = 'verify-step done';
                document.getElementById('bankStep3').className = 'verify-step active';
                document.getElementById('bankFormFields').style.display = 'none';
                document.getElementById('bankOTPPhone').textContent = '••••••' + (otpResult.phone_last4 || phone.slice(-4));
                document.getElementById('bankOTPCode').value = '';
                document.getElementById('bankOTPStep').style.display = 'block';

                // Auto-fill OTP in demo mode
                if (otpResult.otp_code_debug) {
                    document.getElementById('bankOTPCode').value = otpResult.otp_code_debug;
                }
            } catch (e) {
                document.getElementById('bankStep2').className = 'verify-step';
                document.getElementById('bankStep1').className = 'verify-step active';
                errEl.textContent = e.message; errEl.style.display = 'block';
            }
        }

        async function verifyBankOTPAndAdd() {
            if (!pendingBankData) return;
            const otp_code = document.getElementById('bankOTPCode').value.trim();
            const errEl = document.getElementById('bankError');
            const successEl = document.getElementById('bankSuccess');
            errEl.style.display = 'none';

            if (!otp_code || otp_code.length !== 6) {
                errEl.textContent = 'Enter the 6-digit OTP'; errEl.style.display = 'block'; return;
            }

            try {
                const addResult = await api('/api/bank/add', {
                    method: 'POST',
                    body: JSON.stringify({
                        account_holder: pendingBankData.holder,
                        account_number: pendingBankData.accNum,
                        ifsc_code: pendingBankData.ifsc,
                        bank_name: pendingBankData.bankName,
                        phone_number: pendingBankData.phone,
                        otp_code: otp_code,
                    }),
                });

                document.getElementById('bankStep3').className = 'verify-step done';
                document.getElementById('bankStep4').className = 'verify-step done';
                document.getElementById('bankOTPStep').style.display = 'none';
                successEl.innerHTML = `✅ <strong>${addResult.bank_name}</strong> account ending in ****${addResult.last4} linked successfully!<br><span style="font-size:12px;color:var(--text-muted)">📱 OTP verified for ••••••${addResult.phone_last4 || pendingBankData.phone.slice(-4)}</span>`;
                successEl.style.display = 'block';
                pendingBankData = null;

                // Refresh profile after delay
                setTimeout(() => { closeModal('bankModal'); loadProfile(); }, 2000);
            } catch (e) {
                errEl.textContent = e.message; errEl.style.display = 'block';
            }
        }

        async function resendBankOTP() {
            if (!pendingBankData) return;
            try {
                const res = await api('/api/bank/send-otp', {
                    method: 'POST',
                    body: JSON.stringify({ phone_number: pendingBankData.phone, action: 'bank_verify' }),
                });
                document.getElementById('bankOTPCode').value = '';
                alert('New OTP sent!');
                // Auto-fill in demo mode
                if (res.otp_code_debug) {
                    document.getElementById('bankOTPCode').value = res.otp_code_debug;
                }
            } catch (e) {
                alert('Failed to resend: ' + e.message);
            }
        }

        async function removeBank(bankId) {
            if (!confirm('Remove this bank account?')) return;
            try {
                await api(`/api/bank/${bankId}`, { method: 'DELETE' });
                loadProfile();
            } catch (e) { alert(e.message); }
        }

        // ── Deposit / Withdraw ─────────────────────────────────────────
        function populateBankSelect(selectId) {
            const sel = document.getElementById(selectId);
            const banks = (currentUser && currentUser.bank_accounts) || [];
            sel.innerHTML = banks.filter(b => b.verified)
                .map(b => `<option value="${b.id}">${b.bank_name} ••••${b.account_last4}</option>`)
                .join('');
            return banks.filter(b => b.verified).length;
        }

        function showDepositModal() {
            document.getElementById('depositError').style.display = 'none';
            document.getElementById('depositSuccess').style.display = 'none';
            document.getElementById('depositAmount').value = '';
            document.getElementById('depositOTPStep').style.display = 'none';
            const count = populateBankSelect('depositBank');
            document.getElementById('depositNoBanks').style.display = count === 0 ? 'block' : 'none';
            document.getElementById('depositFields').style.display = count > 0 ? 'block' : 'none';
            document.getElementById('depositModal').classList.add('active');
        }

        function showWithdrawModal() {
            document.getElementById('withdrawError').style.display = 'none';
            document.getElementById('withdrawSuccess').style.display = 'none';
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawOTPStep').style.display = 'none';
            document.getElementById('withdrawAvailable').textContent = formatUSD(currentUser?.wallet_balance || 0);
            populateBankSelect('withdrawBank');
            document.getElementById('withdrawFields').style.display = 'block';
            document.getElementById('withdrawModal').classList.add('active');
        }

        function setDepositAmount(amt) {
            document.getElementById('depositAmount').value = amt;
        }

        function formatUSD(n) {
            return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ── OTP Flow ──────────────────────────────────────────────────
        let pendingDepositData = null;
        let pendingWithdrawData = null;

        async function sendDepositOTP() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const bank_id = parseInt(document.getElementById('depositBank').value);
            const errEl = document.getElementById('depositError');
            errEl.style.display = 'none';

            if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; errEl.style.display = 'block'; return; }

            try {
                const res = await api('/api/otp/send', {
                    method: 'POST',
                    body: JSON.stringify({ bank_id, action: 'deposit' }),
                });
                pendingDepositData = { amount, bank_id };
                document.getElementById('depositFields').style.display = 'none';
                document.getElementById('depositOTPPhone').textContent = '••••••' + (res.phone_last4 || '••');
                document.getElementById('depositOTP').value = '';
                document.getElementById('depositOTPStep').style.display = 'block';

                // Auto-fill OTP in demo mode
                if (res.otp_code_debug) {
                    document.getElementById('depositOTP').value = res.otp_code_debug;
                }
            } catch (e) {
                errEl.textContent = e.message; errEl.style.display = 'block';
            }
        }

        async function sendWithdrawOTP() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const bank_id = parseInt(document.getElementById('withdrawBank').value);
            const errEl = document.getElementById('withdrawError');
            errEl.style.display = 'none';

            if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; errEl.style.display = 'block'; return; }

            try {
                const res = await api('/api/otp/send', {
                    method: 'POST',
                    body: JSON.stringify({ bank_id, action: 'withdraw' }),
                });
                pendingWithdrawData = { amount, bank_id };
                document.getElementById('withdrawFields').style.display = 'none';
                document.getElementById('withdrawOTPPhone').textContent = '••••••' + (res.phone_last4 || '••');
                document.getElementById('withdrawOTP').value = '';
                document.getElementById('withdrawOTPStep').style.display = 'block';

                // Auto-fill OTP in demo mode
                if (res.otp_code_debug) {
                    document.getElementById('withdrawOTP').value = res.otp_code_debug;
                }
            } catch (e) {
                errEl.textContent = e.message; errEl.style.display = 'block';
            }
        }

        async function resendOTP(action) {
            const bank_id = action === 'deposit'
                ? parseInt(document.getElementById('depositBank').value)
                : parseInt(document.getElementById('withdrawBank').value);
            try {
                const res = await api('/api/otp/send', {
                    method: 'POST',
                    body: JSON.stringify({ bank_id, action }),
                });
                const phoneEl = document.getElementById(action === 'deposit' ? 'depositOTPPhone' : 'withdrawOTPPhone');
                phoneEl.textContent = '••••••' + (res.phone_last4 || '••');
                alert('New OTP sent!');
                // Auto-fill in demo mode
                if (res.otp_code_debug) {
                    document.getElementById(action === 'deposit' ? 'depositOTP' : 'withdrawOTP').value = res.otp_code_debug;
                }
            } catch (e) {
                alert('Failed to resend: ' + e.message);
            }
        }

        async function submitDeposit() {
            if (!pendingDepositData) return;
            const otp_code = document.getElementById('depositOTP').value.trim();
            const errEl = document.getElementById('depositError');
            const successEl = document.getElementById('depositSuccess');
            errEl.style.display = 'none'; successEl.style.display = 'none';

            if (!otp_code || otp_code.length !== 6) { errEl.textContent = 'Enter the 6-digit OTP'; errEl.style.display = 'block'; return; }

            try {
                const res = await api('/api/wallet/deposit', {
                    method: 'POST',
                    body: JSON.stringify({ amount: pendingDepositData.amount, bank_id: pendingDepositData.bank_id, otp_code }),
                });
                const hashInfo = res.tx_hash ? `<br><span style="font-family:monospace;font-size:11px;color:var(--primary);cursor:pointer" title="${res.tx_hash}" onclick="copyHash('${res.tx_hash}')">🔗 TX: ${res.tx_hash.slice(0, 10)}…${res.tx_hash.slice(-8)} 📋</span>` : '';
                successEl.innerHTML = `✅ $${formatUSD(pendingDepositData.amount)} deposited successfully! New balance: <strong>$${formatUSD(res.new_balance)}</strong>${hashInfo}`;
                successEl.style.display = 'block';
                document.getElementById('depositOTPStep').style.display = 'none';
                // Update local state
                if (currentUser) currentUser.wallet_balance = res.new_balance;
                const balEl = document.getElementById('proBalanceVal');
                if (balEl) balEl.textContent = '$' + formatUSD(res.new_balance);
                pendingDepositData = null;
                setTimeout(() => { closeModal('depositModal'); document.getElementById('depositFields').style.display = 'block'; }, 4000);
            } catch (e) {
                errEl.textContent = e.message; errEl.style.display = 'block';
            }
        }

        async function submitWithdraw() {
            if (!pendingWithdrawData) return;
            const otp_code = document.getElementById('withdrawOTP').value.trim();
            const errEl = document.getElementById('withdrawError');
            const successEl = document.getElementById('withdrawSuccess');
            errEl.style.display = 'none'; successEl.style.display = 'none';

            if (!otp_code || otp_code.length !== 6) { errEl.textContent = 'Enter the 6-digit OTP'; errEl.style.display = 'block'; return; }

            try {
                const res = await api('/api/wallet/withdraw', {
                    method: 'POST',
                    body: JSON.stringify({ amount: pendingWithdrawData.amount, bank_id: pendingWithdrawData.bank_id, otp_code }),
                });
                const wdHashInfo = res.tx_hash ? `<br><span style="font-family:monospace;font-size:11px;color:var(--primary);cursor:pointer" title="${res.tx_hash}" onclick="copyHash('${res.tx_hash}')">🔗 TX: ${res.tx_hash.slice(0, 10)}…${res.tx_hash.slice(-8)} 📋</span>` : '';
                successEl.innerHTML = `✅ $${formatUSD(pendingWithdrawData.amount)} withdrawal initiated. New balance: <strong>$${formatUSD(res.new_balance)}</strong>${wdHashInfo}`;
                successEl.style.display = 'block';
                document.getElementById('withdrawOTPStep').style.display = 'none';
                if (currentUser) currentUser.wallet_balance = res.new_balance;
                const balEl2 = document.getElementById('proBalanceVal');
                if (balEl2) balEl2.textContent = '$' + formatUSD(res.new_balance);
                pendingWithdrawData = null;
                setTimeout(() => { closeModal('withdrawModal'); document.getElementById('withdrawFields').style.display = 'block'; }, 4000);
            } catch (e) {
                errEl.textContent = e.message; errEl.style.display = 'block';
            }
        }

        async function showTransactionsModal() {
            document.getElementById('transactionsModal').classList.add('active');
            const list = document.getElementById('transactionsList');
            list.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
            try {
                const txns = await api('/api/wallet/transactions?limit=30');
                if (txns.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>No transactions yet</p></div>';
                    return;
                }
                list.innerHTML = txns.map(t => {
                    const hash = t.tx_hash || '';
                    const shortHash = hash ? hash.slice(0, 8) + '…' + hash.slice(-6) : '';
                    const typeLabel = t.type === 'deposit' ? '⬆ Deposit' : t.type === 'signup_bonus' ? '🎁 Bonus' : '⬇ Withdraw';
                    const typeCls = t.type === 'deposit' || t.type === 'signup_bonus' ? 'txn-deposit' : 'txn-withdraw';
                    return `
            <div class="txn-item">
                <div>
                    <span class="txn-type ${typeCls}">${typeLabel}</span>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${t.description}</div>
                    <div style="font-size:11px;color:var(--text-muted)">${new Date(t.created_at).toLocaleString()}</div>
                    ${hash ? `<div style="font-size:11px;font-family:monospace;margin-top:3px">
                        🔗 <span title="${hash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${hash}')">${shortHash}</span>
                        <span data-hash="${hash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${hash}')">📋</span>
                    </div>` : ''}
                </div>
                <div class="txn-amount" style="color:${t.type === 'deposit' || t.type === 'signup_bonus' ? '#00d4aa' : '#ff6b6b'}">
                    ${t.type === 'withdraw' ? '-' : '+'}$${formatUSD(t.amount)}
                </div>
            </div>`;
                }).join('');
            } catch (e) {
                list.innerHTML = `<div class="empty-state"><p>Error loading transactions</p></div>`;
            }
        }

        // ── Portfolio ─────────────────────────────────────────────────
        function showPortfolioModal() {
            document.getElementById('portfolioModal').classList.add('active');
        }

        async function addPortfolioItem() {
            const coin_id = document.getElementById('pfCoinId').value;
            const amount = parseFloat(document.getElementById('pfAmount').value);
            const avg_price = parseFloat(document.getElementById('pfPrice').value);
            if (!coin_id || isNaN(amount)) return;
            try {
                await api(`/api/portfolio?coin_id=${encodeURIComponent(coin_id)}&amount=${amount}&avg_price=${avg_price}`, {
                    method: 'POST',
                });
                closeModal('portfolioModal');
                loadProfile();
            } catch (e) {
                alert(e.message);
            }
        }

        // ── Profile ───────────────────────────────────────────────────
        function handleProfilePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { showToast('Image must be under 2MB', 'error'); return; }
            const reader = new FileReader();
            reader.onload = function(ev) {
                const dataUrl = ev.target.result;
                localStorage.setItem('nexypher_profile_photo', dataUrl);
                applyProfilePhoto(dataUrl);
                updateAuthUI(); // sync navbar avatar
            };
            reader.readAsDataURL(file);
        }

        function applyProfilePhoto(dataUrl) {
            const img = document.getElementById('profilePhotoImg');
            const initials = document.getElementById('profileAvatarLarge');
            if (dataUrl) {
                img.src = dataUrl;
                img.style.display = 'block';
                if (initials) initials.style.display = 'none';
            } else {
                img.style.display = 'none';
                if (initials) initials.style.display = 'flex';
            }
        }

        function toggleProfileEdit() {
            showEditProfileModal();
        }

        // ── Edit Profile Modal ─────────────────────────────────────
        function showEditProfileModal() {
            if (!currentUser) return;
            const savedName = localStorage.getItem('nexypher_display_name');
            const uname = savedName || currentUser.username || currentUser.email.split('@')[0];
            document.getElementById('epUsername').value = uname;
            document.getElementById('epEmail').value = currentUser.email;

            // Photo in modal
            const photo = getProfilePhoto();
            const epImg = document.getElementById('epAvatarImg');
            const epInit = document.getElementById('epAvatarInitials');
            if (photo) {
                epImg.src = photo; epImg.style.display = 'block';
                if (epInit) epInit.style.display = 'none';
            } else {
                epImg.style.display = 'none';
                if (epInit) { epInit.style.display = 'flex'; epInit.textContent = (currentUser.username || currentUser.email).slice(0,2).toUpperCase(); }
            }

            // Email badge
            const badge = document.getElementById('epEmailBadge');
            if (currentUser.email_verified) {
                badge.innerHTML = '<span class="ep-badge-verified">&#10003; Verified</span>';
            } else {
                badge.innerHTML = '<span class="ep-badge-unverified">&#9888; Not Verified</span> <a href="#" class="ep-resend" onclick="event.preventDefault();resendVerification()">Resend</a>';
            }

            // Member since
            const created = currentUser.created_at ? new Date(currentUser.created_at) : new Date();
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('epMemberSince').textContent = months[created.getMonth()] + ' ' + created.getFullYear();

            // Reset password form
            document.getElementById('epPasswordForm').style.display = 'none';
            document.getElementById('epPasswordDisplay').style.display = 'flex';

            document.getElementById('editProfileModal').classList.add('active');
        }

        function togglePasswordChange() {
            const form = document.getElementById('epPasswordForm');
            const disp = document.getElementById('epPasswordDisplay');
            if (form.style.display === 'none') {
                form.style.display = 'flex'; disp.style.display = 'none';
            } else {
                form.style.display = 'none'; disp.style.display = 'flex';
            }
        }

        async function updatePassword() {
            const cur = document.getElementById('epCurrentPassword').value;
            const np = document.getElementById('epNewPassword').value;
            const cp = document.getElementById('epConfirmPassword').value;
            if (!cur || !np || !cp) { showToast('Fill all password fields', 'error'); return; }
            if (np !== cp) { showToast('Passwords do not match', 'error'); return; }
            if (np.length < 8 || !/\d/.test(np) || !/[!@#$%^&*(),.?":{}|<>]/.test(np)) {
                showToast('Password needs 8+ chars, 1 number, 1 special character', 'error'); return;
            }
            try {
                await api('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: cur, new_password: np })
                });
                showToast('Password updated', 'success');
                togglePasswordChange();
            } catch (e) { showToast(e.message || 'Failed to update password', 'error'); }
        }

        function confirmDeleteAccount() {
            if (!confirm('Are you sure? This will permanently delete your account, trading history, and AI training data. This cannot be undone.')) return;
            api('/api/auth/delete-account', { method: 'DELETE' })
                .then(() => { logout(); showToast('Account deleted', 'success'); })
                .catch(e => showToast(e.message || 'Failed to delete account', 'error'));
        }

        async function saveEditProfile() {
            const newName = document.getElementById('epUsername').value.trim();
            if (!newName || newName.length < 3 || /\s/.test(newName)) {
                document.getElementById('epUsernameError').style.display = 'block';
                return;
            }
            document.getElementById('epUsernameError').style.display = 'none';
            document.getElementById('profileTitle').textContent = newName;
            localStorage.setItem('nexypher_display_name', newName);
            updateAuthUI();
            closeModal('editProfileModal');
            showToast('Profile updated successfully', 'success');
        }

        async function saveProfileEdit() {
            saveEditProfile();
        }

        async function loadProfile() {
            if (!currentUser) return;
            const savedName = localStorage.getItem('nexypher_display_name');
            const uname = savedName || currentUser.username || currentUser.email.split('@')[0];
            document.getElementById('profileTitle').textContent = uname;

            // Verification badge
            const badge = document.getElementById('profileVerifyBadge');
            if (badge) {
                if (currentUser.email_verified) {
                    badge.innerHTML = '&#9679; Verified';
                    badge.className = 'pro-verify-badge badge-verified';
                } else {
                    badge.innerHTML = '&#9679; Email unverified';
                    badge.className = 'pro-verify-badge badge-unverified';
                }
            }

            // Member since
            const msEl = document.getElementById('profileMemberSince');
            if (msEl) {
                const created = currentUser.created_at ? new Date(currentUser.created_at) : new Date();
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                msEl.textContent = 'Member since ' + months[created.getMonth()] + ' ' + created.getFullYear();
            }

            // Profile avatar / photo
            const initials = (currentUser.username || currentUser.email).slice(0, 2).toUpperCase();
            const avatarEl = document.getElementById('profileAvatarLarge');
            if (avatarEl) avatarEl.textContent = initials;
            const photo = getProfilePhoto();
            applyProfilePhoto(photo);

            const banks = currentUser.bank_accounts || [];
            const wallets = currentUser.wallets || [];
            const wlist = currentUser.watchlist || [];

            // ── Trading Performance Hero ──
            try {
                const perf = await api('/api/trader/performance');
                const balance = currentUser.wallet_balance || 0;
                document.getElementById('proBalanceVal').textContent = '$' + formatUSD(balance);
                const totalPnl = (perf.realized_pnl || 0) + (perf.unrealized_pnl || 0);
                const pnlEl = document.getElementById('proTotalPnl');
                pnlEl.textContent = (totalPnl >= 0 ? '+$' : '-$') + formatUSD(Math.abs(totalPnl));
                pnlEl.className = 'pro-stat-value ' + (totalPnl >= 0 ? 'pro-positive' : 'pro-negative');

                const wrEl = document.getElementById('proWinRate');
                wrEl.textContent = (perf.win_rate || 0) + '%';

                document.getElementById('proTotalTrades').textContent = perf.total_trades || 0;

                const bestEl = document.getElementById('proBestTrade');
                bestEl.textContent = '+$' + formatUSD(perf.best_trade || 0);
            } catch (e) {
                console.warn('Profile perf load failed:', e);
                document.getElementById('proBalanceVal').textContent = '$' + formatUSD(currentUser.wallet_balance || 0);
            }

            // ── Bank Accounts (visible section) ──
            const bl = document.getElementById('bankList');
            if (banks.length === 0) {
                bl.innerHTML = '<div class="pro-bank-empty"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="1.5"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg><span>No bank accounts linked</span></div>';
            } else {
                bl.innerHTML = banks.map(b => `
            <div class="bank-card">
                <div class="bank-info">
                    <div class="bank-icon">${b.bank_name.charAt(0)}</div>
                    <div>
                        <div class="bank-name">${b.bank_name}</div>
                        <div class="bank-detail">${b.account_holder} &bull; ****${b.account_last4} &bull; ${b.ifsc_code}</div>
                        <span class="bank-verified">${b.verified ? 'Verified' : 'Pending'}</span>
                    </div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeBank(${b.id})">Remove</button>
            </div>
        `).join('');
            }

            // ── Wallets (visible section) ──
            const wl = document.getElementById('walletList');
            if (window._nxWalletEngine) {
                window._nxWalletEngine.renderWallets(wallets);
                if (wallets.length > 0) window._nxWalletEngine.startRefresh();
            } else if (wallets.length === 0) {
                wl.innerHTML = '<div class="profile-empty-state">No wallets connected yet</div>';
            } else {
                wl.innerHTML = wallets.map(w => `
            <div class="wallet-card">
                <div>
                    <span class="wallet-addr">${w.address}</span>
                    <span class="wallet-chain">${w.chain}</span>
                    ${w.label ? '<span style="color:var(--text-muted);font-size:12px;margin-left:8px">' + w.label + '</span>' : ''}
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeWallet('${w.address}','${w.chain}')">Remove</button>
            </div>
        `).join('');
            }

            // ── Portfolio ──
            try {
                const portfolio = await api('/api/portfolio');
                const pb = document.getElementById('portfolioBody');
                if (portfolio.length === 0) {
                    pb.innerHTML = '<tr><td colspan="5" class="profile-empty-state" style="border:none">No positions yet</td></tr>';
                } else {
                    pb.innerHTML = portfolio.map(p => `
                <tr>
                    <td style="font-weight:600">${p.coin_id.toUpperCase()}</td>
                    <td>${p.amount}</td>
                    <td>${fmt(p.avg_buy_price)}</td>
                    <td>${fmt(p.current_price)}</td>
                    <td class="${p.pnl >= 0 ? 'price-positive' : 'price-negative'}">${p.pnl >= 0 ? '+' : ''}${fmt(p.pnl)} (${p.pnl_pct.toFixed(1)}%)</td>
                </tr>
            `).join('');
                }
            } catch (e) {
                console.error('Portfolio error:', e);
            }

            // ── Update navbar watchlist count ──
            updateWatchlistNavCount(wlist.length);

            // Market page watchlist pills
            renderMarketWatchlist(wlist);
        }

        // ── Navbar Watchlist Count ──
        function updateWatchlistNavCount(count) {
            const btn = document.getElementById('navWatchlistBtn');
            const badge = document.getElementById('navWlCount');
            const wlCountBadge = document.getElementById('wlCountBadge');
            if (btn) btn.style.display = currentUser ? 'flex' : 'none';
            if (badge) badge.textContent = count || 0;
            if (wlCountBadge) wlCountBadge.textContent = count || 0;
        }

        // ══════════════════════════════════════════════════════════
        // WATCHLIST PAGE — Full Token Discovery
        // ══════════════════════════════════════════════════════════
        let _wlPageData = [];
        let _wlCurrentFilter = 'all';

        const _coinIdMap = {
            'btc':'bitcoin','bitcoin':'bitcoin','eth':'ethereum','ethereum':'ethereum',
            'sol':'solana','solana':'solana','xrp':'ripple','ripple':'ripple',
            'doge':'dogecoin','dogecoin':'dogecoin','bnb':'binancecoin','binancecoin':'binancecoin',
            'ada':'cardano','cardano':'cardano','avax':'avalanche-2','avalanche':'avalanche-2',
            'link':'chainlink','chainlink':'chainlink','uni':'uniswap','uniswap':'uniswap',
            'matic':'matic-network','dot':'polkadot','polkadot':'polkadot',
            'ltc':'litecoin','litecoin':'litecoin','atom':'cosmos','cosmos':'cosmos',
            'near':'near','sui':'sui','apt':'aptos','aptos':'aptos',
            'shib':'shiba-inu','pepe':'pepe','arb':'arbitrum','op':'optimism',
            'ton':'the-open-network','trx':'tron','xlm':'stellar',
        };
        const _invalidCoins = ['add','a','b','','test','null','undefined'];

        function cleanWatchlist(list) {
            if (!Array.isArray(list)) return [];
            return list.filter(c => c && typeof c === 'string' && c.length >= 2 && !_invalidCoins.includes(c.toLowerCase()) && !/\s/.test(c));
        }

        async function resolveCoinId(input) {
            const lower = input.toLowerCase().trim();
            if (_coinIdMap[lower]) return _coinIdMap[lower];
            // Try CoinGecko search
            try {
                const resp = await fetch(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(lower)}`);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.coins && data.coins.length > 0) return data.coins[0].id;
                }
            } catch (e) { console.warn('CoinGecko search failed:', e); }
            return null;
        }

        async function removeFromWatchlist(coinId) {
            return api(`/api/watchlist/${coinId}`, { method: 'DELETE' });
        }

        async function loadWatchlistPage() {
            if (!currentUser) return;
            let wlist = cleanWatchlist(currentUser.watchlist || []);
            // Sync cleaned list back if we removed invalid entries
            if (wlist.length !== (currentUser.watchlist || []).length) {
                currentUser.watchlist = wlist;
            }
            updateWatchlistNavCount(wlist.length);

            const grid = document.getElementById('wlGrid');
            const empty = document.getElementById('wlEmpty');

            if (wlist.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            // Check cache first
            const cacheKey = 'watchlist_cache';
            const cacheTimeKey = 'watchlist_cache_time';
            const cached = localStorage.getItem(cacheKey);
            const cacheTime = parseInt(localStorage.getItem(cacheTimeKey) || '0');
            const cacheAge = Date.now() - cacheTime;

            if (cached && cacheAge < 60000) {
                try {
                    _wlPageData = JSON.parse(cached);
                    renderWatchlistCards(_wlPageData);
                    return;
                } catch(e) { /* fall through to fetch */ }
            }

            // Show cached while loading if available
            if (cached && cacheAge >= 60000) {
                try {
                    _wlPageData = JSON.parse(cached);
                    renderWatchlistCards(_wlPageData);
                } catch(e) { /* ignore */ }
            } else {
                grid.innerHTML = wlist.map(() => '<div class="wl-skeleton"></div>').join('');
            }

            try {
                const validIds = wlist.filter(id => id && id.length > 1 && id !== 'add');
                if (validIds.length === 0) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
                const ids = validIds.join(',');
                const resp = await fetch(
                    `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&per_page=50&page=1&sparkline=true&price_change_percentage=24h,7d`,
                    { headers: { 'Accept': 'application/json' } }
                );
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                _wlPageData = data || [];
                // Cache on success
                localStorage.setItem(cacheKey, JSON.stringify(_wlPageData));
                localStorage.setItem(cacheTimeKey, Date.now().toString());
                renderWatchlistCards(_wlPageData);
            } catch (e) {
                console.error('Watchlist page load failed:', e);
                // If we already showed cached data, don't overwrite
                if (_wlPageData.length > 0) return;
                // Show error card
                grid.innerHTML = `<div style="background:rgba(255,71,87,0.04);border:1px solid rgba(255,71,87,0.1);border-radius:10px;padding:20px;text-align:center">
                    <div style="font-size:16px;color:rgba(255,71,87,0.5);margin-bottom:6px">\u26A0</div>
                    <div style="font-size:13px;font-weight:600;color:rgba(255,255,255,0.5)">Unable to load market data</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.25);margin-top:4px">CoinGecko API may be rate limited. Data will refresh automatically.</div>
                    <button onclick="loadWatchlistPage()" style="background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:6px 14px;font-size:12px;color:rgba(255,255,255,0.4);margin-top:12px;cursor:pointer;font-family:'Inter',sans-serif">Retry</button>
                </div>`;
            }
        }

        function renderWatchlistCards(data) {
            const grid = document.getElementById('wlGrid');
            const empty = document.getElementById('wlEmpty');
            if (!data || data.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            grid.innerHTML = data.map((c, i) => {
                const ch24 = c.price_change_percentage_24h || 0;
                const ch7d = c.price_change_percentage_7d_in_currency || 0;
                const chColor = ch24 >= 0 ? '#00d395' : '#ff4757';
                const chSign = ch24 >= 0 ? '+' : '';
                const aiScore = Math.min(99, Math.max(1, Math.round((c.market_cap_rank ? (100 - c.market_cap_rank) : 50) + ch24 * 0.5)));
                const aiClass = aiScore >= 65 ? 'high' : aiScore >= 35 ? 'mid' : 'low';
                const signal = ch24 > 3 ? 'LONG' : ch24 < -3 ? 'SHORT' : 'HOLD';
                const sigClass = signal === 'LONG' ? 'long' : signal === 'SHORT' ? 'short' : 'hold';
                const sparkPts = buildSparklinePath(c.sparkline_in_7d?.price || [], 200, 48);
                const sparkColor = ch7d >= 0 ? '#00d395' : '#ff4757';
                const verdict = signal === 'LONG' ? 'Bullish momentum detected' : signal === 'SHORT' ? 'Bearish pressure building' : 'Consolidation phase';

                return `<div class="wl-card" style="animation-delay:${i * 50}ms" data-coin="${c.id}" data-change24="${ch24}" data-volume="${c.total_volume || 0}" data-ai="${aiScore}">
                    <div class="wl-card-head">
                        <div class="wl-card-icon"><img src="${c.image}" alt="" onerror="this.style.display='none';this.parentElement.textContent='${c.symbol.slice(0,2).toUpperCase()}'"></div>
                        <div class="wl-card-name">
                            <div class="wl-card-name-text">${c.name}</div>
                            <div class="wl-card-symbol">${c.symbol.toUpperCase()} #${c.market_cap_rank || '--'}</div>
                        </div>
                        <div class="wl-card-badges">
                            <span class="wl-ai-score ${aiClass}">AI ${aiScore}</span>
                            <span class="wl-signal-badge ${sigClass}">${signal}</span>
                        </div>
                    </div>
                    <div class="wl-card-price-row">
                        <span class="wl-card-price">$${c.current_price?.toLocaleString() || '0'}</span>
                        <span class="wl-card-change" style="color:${chColor}">${chSign}${ch24.toFixed(1)}%</span>
                    </div>
                    <div class="wl-card-stats">
                        <div class="wl-card-stat"><div class="wl-card-stat-label">Market Cap</div><div class="wl-card-stat-value">${fmtCompact(c.market_cap)}</div></div>
                        <div class="wl-card-stat"><div class="wl-card-stat-label">Volume 24h</div><div class="wl-card-stat-value">${fmtCompact(c.total_volume)}</div></div>
                        <div class="wl-card-stat"><div class="wl-card-stat-label">7d Change</div><div class="wl-card-stat-value" style="color:${ch7d >= 0 ? '#00d395' : '#ff4757'}">${ch7d >= 0 ? '+' : ''}${ch7d.toFixed(1)}%</div></div>
                        <div class="wl-card-stat"><div class="wl-card-stat-label">Rank</div><div class="wl-card-stat-value">#${c.market_cap_rank || '--'}</div></div>
                    </div>
                    <div class="wl-card-sparkline">
                        <svg viewBox="0 0 200 48" preserveAspectRatio="none"><polyline points="${sparkPts}" fill="none" stroke="${sparkColor}" stroke-width="1.5" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="wl-card-footer">
                        <span class="wl-card-verdict">${verdict}</span>
                        <button class="wl-card-analyze" onclick="event.stopPropagation();openToken('${c.id}','${c.name}')">Analyze</button>
                        <button class="wl-card-remove-btn" onclick="event.stopPropagation();removeFromWatchlistPage('${c.id}')" title="Remove">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function buildSparklinePath(prices, w, h) {
            if (!prices || prices.length < 2) return '0,24 200,24';
            const min = Math.min(...prices), max = Math.max(...prices);
            const range = max - min || 1;
            return prices.map((p, i) => {
                const x = (i / (prices.length -1)) * w;
                const y = h - ((p - min) / range) * (h - 4) - 2;
                return `${x.toFixed(1)},${y.toFixed(1)}`;
            }).join(' ');
        }

        function fmtCompact(n) {
            if (!n) return '--';
            if (n >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
            if (n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
            if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
            if (n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
            return '$' + n.toFixed(0);
        }

        // Watchlist filter
        function setWlFilter(btn) {
            document.querySelectorAll('.wl-filter').forEach(f => f.classList.remove('active'));
            btn.classList.add('active');
            _wlCurrentFilter = btn.dataset.filter;
            applyWlFilter();
        }
        function applyWlFilter() {
            let filtered = [..._wlPageData];
            if (_wlCurrentFilter === 'gainers') filtered = filtered.filter(c => (c.price_change_percentage_24h || 0) > 0).sort((a,b) => (b.price_change_percentage_24h||0)-(a.price_change_percentage_24h||0));
            else if (_wlCurrentFilter === 'losers') filtered = filtered.filter(c => (c.price_change_percentage_24h || 0) < 0).sort((a,b) => (a.price_change_percentage_24h||0)-(b.price_change_percentage_24h||0));
            else if (_wlCurrentFilter === 'volume') filtered.sort((a,b) => (b.total_volume||0)-(a.total_volume||0));
            else if (_wlCurrentFilter === 'ai') filtered.sort((a,b) => { const as = Math.round((100-(a.market_cap_rank||50))+(a.price_change_percentage_24h||0)*0.5); const bs = Math.round((100-(b.market_cap_rank||50))+(b.price_change_percentage_24h||0)*0.5); return bs-as; });
            renderWatchlistCards(filtered);
        }

        // Watchlist search filter
        function filterWatchlistCards() {
            const q = (document.getElementById('wlSearchInput')?.value || '').toLowerCase();
            if (!q) { renderWatchlistCards(_wlPageData); return; }
            renderWatchlistCards(_wlPageData.filter(c => c.name.toLowerCase().includes(q) || c.symbol.toLowerCase().includes(q) || c.id.toLowerCase().includes(q)));
        }

        // Remove from watchlist page
        async function removeFromWatchlistPage(coinId) {
            try {
                await removeFromWatchlist(coinId);
                _wlPageData = _wlPageData.filter(c => c.id !== coinId);
                applyWlFilter();
                updateWatchlistNavCount(_wlPageData.length);
            } catch(e) { console.error(e); }
        }

        // Show add watchlist modal with validation
        async function showWatchlistAddModal() {
            const q = prompt('Enter coin name or ticker (e.g. bitcoin, sol, eth):');
            if (!q) return;
            const val = q.trim().toLowerCase();
            if (!val || val.length < 2 || _invalidCoins.includes(val)) {
                showToast('Invalid coin name. Try a ticker like "sol" or full name like "solana"', 'error');
                return;
            }
            // Resolve to proper CoinGecko ID
            const coinId = await resolveCoinId(val);
            if (!coinId) {
                showToast('Coin not found. Try the full name (e.g. "bitcoin" instead of "btc")', 'error');
                return;
            }
            try {
                await api(`/api/watchlist/${coinId}`, { method: 'POST' });
                await checkAuth();
                loadWatchlistPage();
                showToast(coinId + ' added to watchlist', 'success');
            } catch (e) {
                showToast(e.message || 'Failed to add', 'error');
            }
        }

        function renderMarketWatchlist(wlist) {
            const section = document.getElementById('marketWatchlistSection');
            const pills = document.getElementById('marketWatchlistPills');
            if (!section || !pills) return;
            if (!wlist || wlist.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            pills.innerHTML = wlist.map(c => `<span class="mw-pill" onclick="openToken('${c}','${c}')"><span class="mw-pill-name">${c.toUpperCase()}</span></span>`).join('')
                + '<span class="mw-pill mw-pill-add" onclick="navigate(\'profile\')">+ Add to Watchlist</span>';
        }

        // ── Home Data ─────────────────────────────────────────────────
        async function loadHomeData() {
            const body = document.getElementById('homeMarketBody');
            body.innerHTML = skeletonRows(6, 8);

            // ── Fetch platform stats for the stat cards ──
            try {
                const stats = await api('/api/platform/stats');
                const el = (id) => document.getElementById(id);
                if (stats.tokens_tracked !== undefined) el('homeStatTokens').textContent = stats.tokens_tracked.toLocaleString();
                if (stats.ai_analyses_run !== undefined) el('homeStatAIScans').textContent = stats.ai_analyses_run.toLocaleString();
                if (stats.market_regime) el('homeStatRegime').textContent = stats.market_regime;
                if (stats.auto_trades_today !== undefined) el('homeStatAutoTrades').textContent = stats.auto_trades_today.toLocaleString();
            } catch (e) {
                console.warn('Platform stats unavailable:', e.message);
            }

            try {
                const [coins, trending] = await Promise.all([
                    api('/api/market/top?limit=10'),
                    api('/api/market/trending'),
                ]);

                // Trending bar
                const bar = document.getElementById('trendingBar');
                bar.innerHTML = trending.map(t => `
            <div class="filter-pill" style="cursor:pointer" onclick="openToken('${t.coin_id}','${t.name}')">
                🔥 ${t.name} <span style="color:var(--text-muted)">${t.symbol}</span>
            </div>
        `).join('');

                // Market table
                body.innerHTML = coins.map(c => `
            <tr style="cursor:pointer" onclick="openToken('${c.coin_id}','${c.name}')">
                <td style="font-weight:700;color:${c.ai_score >= 65 ? 'var(--green)' : c.ai_score >= 45 ? '#4ade80' : c.ai_score >= 25 ? 'var(--yellow)' : 'var(--text-muted)'}">${c.ai_score}</td>
                <td>
                    <div class="token-info">
                        <div class="token-icon">${c.symbol.slice(0, 2)}</div>
                        <div><div class="token-name">${c.name} ${c.trending ? '🔥' : ''}</div><div class="token-symbol">${c.symbol}</div></div>
                    </div>
                </td>
                <td>${fmt(c.price)}</td>
                <td>${fmtPct(c.price_change_24h)}</td>
                <td><span style="color:${c.ai_verdict?.includes('BUY') ? 'var(--green)' : c.ai_verdict?.includes('SELL') ? 'var(--red)' : 'var(--text-muted)'};font-weight:600;font-size:12px">${c.ai_verdict || '-'}</span></td>
                <td>${fmt(c.volume_24h)}</td>
            </tr>
        `).join('');
            } catch (e) {
                console.error('Home data error:', e);
                body.innerHTML = `<tr><td colspan="6">${errorWithRetry('Failed to load market data — ' + e.message, 'loadHomeData()')}</td></tr>`;
            }
        }

        // ── Token Feed ────────────────────────────────────────────────
        function setFeedSort(el) {
            document.querySelectorAll('[data-sort]').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            feedSort = el.dataset.sort;
            loadFeed();
        }

        function setFeedStatus(el) {
            document.querySelectorAll('[data-status]').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            feedStatus = el.dataset.status;
            loadFeed();
        }

        async function loadFeed() {
            const body = document.getElementById('feedBody');
            body.innerHTML = skeletonRows(7, 10);

            try {
                feedData = await api(`/api/feed/tokens?sort=${feedSort}&status=${feedStatus}&limit=50`);
                document.getElementById('feedCount').textContent = `${feedData.length} live tokens`;
                renderFeed(feedData);
            } catch (e) {
                body.innerHTML = `<tr><td colspan="7">${errorWithRetry('Failed to load feed — ' + e.message, 'loadFeed()')}</td></tr>`;
            }
        }

        function renderFeed(data) {
            const body = document.getElementById('feedBody');
            body.innerHTML = data.map(t => `
        <tr style="cursor:pointer" onclick="openToken('${t.symbol.toLowerCase()}','${t.name}')">
            <td>
                <div class="token-info">
                    <div class="token-icon">${t.symbol.slice(0, 2)}</div>
                    <div>
                        <div class="token-name">${t.name}</div>
                        <div class="token-symbol">$${t.symbol}</div>
                    </div>
                </div>
            </td>
            <td>${fmt(t.price)}</td>
            <td>${fmtPct(t.price_change_24h)}</td>
            <td>${fmt(t.volume_24h)}</td>
            <td>${fmt(t.liquidity)}</td>
            <td>${t.trades_count}</td>
            <td style="color:var(--text-muted)">${t.age || '-'}</td>
        </tr>
    `).join('');
        }

        const filterFeedLocal = debounce(function (q) {
            if (!q) return renderFeed(feedData);
            const f = feedData.filter(t => t.name.toLowerCase().includes(q.toLowerCase()) || t.symbol.toLowerCase().includes(q.toLowerCase()));
            renderFeed(f);
        }, 200);

        // ── AI Recommendations ────────────────────────────────────────
        async function loadAIGlobal() {
            try {
                const coins = await api('/api/market/top?limit=3');
                const txt = coins.map(c => `${c.name}: ${fmt(c.price)} (${c.price_change_24h >= 0 ? '+' : ''}${c.price_change_24h.toFixed(2)}%)`).join(' | ');
                document.getElementById('aiMarketGlobal').textContent = txt;
            } catch {
                document.getElementById('aiMarketGlobal').innerHTML = '<span style="color:var(--red)">Failed to load market data.</span>';
            }
        }

        function toggleSwitch(el) {
            el.classList.toggle('off');
        }

        async function loadAIRecs() {
            const onchain = !document.getElementById('toggleOnchain').classList.contains('off');
            const technical = !document.getElementById('toggleTechnical').classList.contains('off');
            const cards = document.getElementById('aiCards');
            cards.style.display = 'block';
            cards.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
            document.getElementById('aiSummaryBox').style.display = 'none';
            document.getElementById('aiThoughtBox').style.display = 'none';
            document.getElementById('aiEnhancedCards').style.display = 'none';

            try {
                const data = await api(`/api/ai/recommendations?enable_onchain=${onchain}&enable_technical=${technical}`);

                document.getElementById('aiTimestamp').textContent = `Results from ${new Date(data.timestamp).toLocaleString()}`;
                document.getElementById('aiSummaryText').textContent = data.market_summary;
                document.getElementById('aiSummaryBox').style.display = 'block';

                cards.innerHTML = data.tokens.map(t => {
                    const sColor = t.score >= 70 ? 'score-green' : (t.score >= 40 ? 'score-yellow' : 'score-red');
                    const vClass = 'verdict-' + t.verdict.replace(' ', '_');

                    let barsHtml = '';
                    if (t.on_chain && Object.keys(t.on_chain).length) {
                        barsHtml = '<div class="on-chain-bars">';
                        for (const [k, v] of Object.entries(t.on_chain)) {
                            const pct = Math.min(100, (v / 25) * 100);
                            barsHtml += `
                        <div class="bar-row">
                            <div class="bar-label">${k.replace(/_/g, ' ')}</div>
                            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
                        </div>`;
                        }
                        barsHtml += '</div>';
                    }

                    return `
                <div class="score-card">
                    <div class="score-circle ${sColor}">${t.score}</div>
                    <div class="score-card-name">${t.name}</div>
                    <div class="score-card-sym">$${t.symbol}</div>
                    <div class="score-card-summary">${t.summary}</div>
                    <span class="verdict-badge ${vClass}">${t.verdict}</span>
                    ${t.risk_flags.length ? '<div style="margin-top:8px;font-size:12px;color:var(--red)">⚠ ' + t.risk_flags.join(', ') + '</div>' : ''}
                    ${barsHtml}
                </div>
            `;
                }).join('');
            } catch (e) {
                cards.innerHTML = errorWithRetry('AI analysis failed \u2014 ' + e.message, 'loadAIRecs()');
            }
        }

        // ── Enhanced AI Recommendations (with Thought Summary) ────
        async function loadEnhancedAIRecs() {
            const cards = document.getElementById('aiCards');
            const enhCards = document.getElementById('aiEnhancedCards');
            const thoughtBox = document.getElementById('aiThoughtBox');
            cards.innerHTML = ''; cards.style.display = 'none';
            enhCards.style.display = 'block';
            enhCards.innerHTML = '<div class="loader"><div class="spinner"></div><div style="margin-top:12px;color:var(--text-muted);font-size:13px">Running enhanced AI pipeline — this may take 15-30s...</div></div>';
            thoughtBox.style.display = 'none';
            document.getElementById('aiSummaryBox').style.display = 'none';

            try {
                const data = await api('/api/ai/enhanced-recommendations?num=5');

                document.getElementById('aiTimestamp').textContent = `Enhanced results from ${new Date(data.timestamp).toLocaleString()}`;

                // Thought Summary
                if (data.overall_ai_thought) {
                    thoughtBox.style.display = 'block';
                    const thoughts = data.overall_ai_thought.split('\n').filter(l => l.trim());
                    document.getElementById('aiThoughtContent').innerHTML = `<p style="color:var(--text-secondary);font-size:14px;line-height:1.6;margin:0">${thoughts[0] || ''}</p>`;
                    const stepsHtml = thoughts.slice(1).map((step, i) => `
                        <div class="thought-step">
                            <span class="thought-step-num">${i + 1}</span>
                            <span>${step}</span>
                        </div>
                    `).join('');
                    document.getElementById('aiThoughtSteps').innerHTML = stepsHtml;
                }

                // Market condition summary
                document.getElementById('aiSummaryText').textContent = `Market Condition: ${data.market_condition || 'Unknown'} | ${data.tokens_analyzed || 0} tokens analyzed`;
                document.getElementById('aiSummaryBox').style.display = 'block';

                // Enhanced recommendation cards
                if (!data.recommendations || data.recommendations.length === 0) {
                    enhCards.innerHTML = '<div class="empty-state"><p>No recommendations generated. Try adjusting your query.</p></div>';
                    return;
                }

                enhCards.innerHTML = '<div class="cards-grid">' + data.recommendations.map(r => {
                    const confPct = Math.round((r.confidence || 0) * 100);
                    const sColor = confPct >= 70 ? 'score-green' : (confPct >= 40 ? 'score-yellow' : 'score-red');
                    const verdictCls = 'verdict-' + (r.verdict || 'hold').replace(' ', '_');
                    const riskColors = { low: 'var(--green)', medium: 'var(--yellow)', high: 'var(--red)' };
                    const riskColor = riskColors[(r.risk_level || '').toLowerCase()] || 'var(--text-muted)';

                    let entryExitHtml = '';
                    if (r.entry_exit) {
                        const e = r.entry_exit;
                        entryExitHtml = `
                        <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.03);border-radius:10px;border:1px solid rgba(255,255,255,0.06)">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;font-weight:600">ENTRY / EXIT</div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:12px">
                                <div>Entry: <span style="color:var(--green)">${fmt(e.entry_low)} – ${fmt(e.entry_high)}</span></div>
                                <div>Stop Loss: <span style="color:var(--red)">${fmt(e.stop_loss)}</span></div>
                                <div>Target 1: <span style="color:var(--accent)">${fmt(e.target_1)}</span></div>
                                <div>Target 2: <span style="color:var(--accent)">${fmt(e.target_2)}</span></div>
                            </div>
                        </div>`;
                    }

                    let dataPointsHtml = '';
                    if (r.key_data_points && r.key_data_points.length) {
                        dataPointsHtml = `<div style="margin-top:8px;font-size:12px;color:var(--text-secondary)">
                            ${r.key_data_points.slice(0, 3).map(dp => `<div style="padding:2px 0">• ${dp}</div>`).join('')}
                        </div>`;
                    }

                    let risksHtml = '';
                    if (r.risks_and_concerns && r.risks_and_concerns.length) {
                        risksHtml = `<div style="margin-top:6px;font-size:12px;color:var(--red)">
                            ${r.risks_and_concerns.slice(0, 2).map(rc => `<div>⚠ ${rc}</div>`).join('')}
                        </div>`;
                    }

                    return `
                    <div class="score-card" style="cursor:pointer" onclick="openToken('${(r.token_ticker || '').toLowerCase()}','${r.token_name || ''}')">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <div class="score-circle ${sColor}">${confPct}</div>
                            <span style="padding:3px 8px;border-radius:8px;font-size:11px;font-weight:600;background:${riskColor}22;color:${riskColor}">${(r.risk_level || 'unknown').toUpperCase()} RISK</span>
                        </div>
                        <div class="score-card-name">${r.token_name || 'Unknown'}</div>
                        <div class="score-card-sym">$${r.token_ticker || '??'} ${r.current_price ? '• ' + fmt(r.current_price) : ''}</div>
                        <div class="score-card-summary" style="margin-top:6px">${r.core_thesis || 'No thesis available'}</div>
                        <span class="verdict-badge ${verdictCls}">${r.verdict || 'HOLD'}</span>
                        ${dataPointsHtml}
                        ${risksHtml}
                        ${entryExitHtml}
                        ${r.ai_thought_summary ? `<div style="margin-top:8px;padding:8px;background:rgba(124,92,255,0.08);border-radius:8px;font-size:12px;color:var(--text-secondary);border-left:3px solid var(--purple)">🧠 ${r.ai_thought_summary}</div>` : ''}
                    </div>`;
                }).join('') + '</div>';

            } catch (e) {
                enhCards.innerHTML = errorWithRetry('Enhanced AI analysis failed — ' + e.message, 'loadEnhancedAIRecs()');
            }
        }

        // ── Market Page ───────────────────────────────────────────────
        let marketTVInitialized = false;
        let currentMarketTab = 'coins';

        function switchMarketTab(tab) {
            currentMarketTab = tab;
            document.getElementById('marketSub-coins').style.display = tab === 'coins' ? 'block' : 'none';
            document.getElementById('marketSub-dex').style.display = tab === 'dex' ? 'block' : 'none';
            // Update sub-tab buttons
            const parent = document.getElementById('page-market');
            parent.querySelectorAll('.trader-subtab').forEach((b, i) => {
                b.classList.toggle('active', (i === 0 && tab === 'coins') || (i === 1 && tab === 'dex'));
            });
            if (tab === 'dex' && !document.getElementById('feedBody').innerHTML.trim()) loadFeed();
        }

        function initMarketTVWidgets() {
            if (marketTVInitialized) return;
            marketTVInitialized = true;

            // Market Overview
            const overviewCfg = { colorTheme: "dark", dateRange: "1D", showChart: true, locale: "en", width: "100%", height: "400", largeChartUrl: "", isTransparent: true, showSymbolLogo: true, showFloatingTooltip: true, tabs: [{ title: "Crypto", symbols: [{ s: "BINANCE:BTCUSDT", d: "Bitcoin" }, { s: "BINANCE:ETHUSDT", d: "Ethereum" }, { s: "BINANCE:SOLUSDT", d: "Solana" }, { s: "BINANCE:XRPUSDT", d: "XRP" }, { s: "BINANCE:DOGEUSDT", d: "Doge" }, { s: "BINANCE:ADAUSDT", d: "Cardano" }, { s: "BINANCE:AVAXUSDT", d: "AVAX" }, { s: "BINANCE:LINKUSDT", d: "Chainlink" }, { s: "BINANCE:DOTUSDT", d: "Polkadot" }, { s: "BINANCE:MATICUSDT", d: "Polygon" }], originalTitle: "Crypto" }] };
            const f1 = document.getElementById('tvMarketOverview');
            if (f1) f1.src = 'https://s.tradingview.com/embed-widget/market-overview/?locale=en#' + encodeURIComponent(JSON.stringify(overviewCfg));

            // Heatmap
            const heatCfg = { dataSource: "Crypto", blockSize: "market_cap_calc", blockColor: "change", locale: "en", symbolUrl: "", colorTheme: "dark", hasTopBar: false, isZoomEnabled: true, hasSymbolTooltip: true, isMonoSize: false, width: "100%", height: "350" };
            const f2 = document.getElementById('tvHeatmap');
            if (f2) f2.src = 'https://s.tradingview.com/embed-widget/crypto-coins-heatmap/?locale=en#' + encodeURIComponent(JSON.stringify(heatCfg));
        }

        async function loadMarket() {
            initMarketTVWidgets();
            const body = document.getElementById('marketBody');
            body.innerHTML = '<tr><td colspan="7"><div class="loader"><div class="spinner"></div></div></td></tr>';

            try {
                const [coins, trending] = await Promise.all([
                    api('/api/market/top?limit=50'),
                    api('/api/market/trending'),
                ]);

                // Trending
                document.getElementById('trendingMarket').innerHTML = trending.map(t => `
            <div class="filter-pill" style="cursor:pointer" onclick="openToken('${t.coin_id}','${t.name}')">
                🔥 ${t.name}
            </div>
        `).join('');

                const verdictColor = v => {
                    if (v.includes('STRONG BUY')) return 'var(--green)';
                    if (v.includes('BUY')) return '#4ade80';
                    if (v.includes('STRONG SELL')) return 'var(--red)';
                    if (v.includes('SELL')) return '#f87171';
                    if (v === 'CAUTION') return 'var(--yellow)';
                    return 'var(--text-muted)';
                };
                const scoreColor = s => s >= 65 ? 'var(--green)' : s >= 45 ? '#4ade80' : s >= 25 ? 'var(--yellow)' : 'var(--text-muted)';
                const signalBadge = (sig) => {
                    if (sig === 'long') return '<span style="background:#16a34a22;color:#4ade80;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:600">▲ LONG</span>';
                    if (sig === 'short') return '<span style="background:#dc262622;color:#f87171;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:600">▼ SHORT</span>';
                    return '<span style="background:#ffffff11;color:var(--text-muted);padding:2px 8px;border-radius:8px;font-size:11px">— FLAT</span>';
                };

                body.innerHTML = coins.map(c => `
            <tr style="cursor:pointer" onclick="openToken('${c.coin_id}','${c.name}')">
                <td>
                    <div style="font-size:18px;font-weight:700;color:${scoreColor(c.ai_score)}">${c.ai_score}</div>
                    <div style="font-size:10px;color:var(--text-muted)">/100</div>
                </td>
                <td>
                    <div class="token-info">
                        <div class="token-icon">${c.symbol.slice(0, 2)}</div>
                        <div>
                            <div class="token-name">${c.name} ${c.trending ? '🔥' : ''}</div>
                            <div class="token-symbol">${c.symbol} • ${fmt(c.price)}</div>
                        </div>
                    </div>
                </td>
                <td><span style="color:${verdictColor(c.ai_verdict)};font-weight:600;font-size:12px">${c.ai_verdict}</span></td>
                <td>${fmt(c.price)}</td>
                <td>${fmtPct(c.price_change_24h)}</td>
                <td>${fmtPct(c.price_change_7d || 0)}</td>
                <td>${signalBadge(c.ai_signal)}</td>
            </tr>
        `).join('');
            } catch (e) {
                body.innerHTML = `<tr><td colspan="7" class="empty-state">${e.message}</td></tr>`;
            }
        }

        // ── Insights Page ─────────────────────────────────────────────
        function quickInsight(coinId) {
            document.getElementById('insightSearch').value = coinId;
            loadInsightAnalysis();
        }

        async function loadInsightAnalysis() {
            const coinId = document.getElementById('insightSearch').value.trim().toLowerCase();
            if (!coinId) { showToast('Enter a coin name (e.g. bitcoin, ethereum)', 'error'); return; }

            document.getElementById('insightEmpty').style.display = 'none';
            const resultEl = document.getElementById('insightResult');
            resultEl.style.display = 'block';

            // Show loading
            let loadingOverlay = document.getElementById('insightLoading');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'insightLoading';
                loadingOverlay.innerHTML = '<div class="loader"><div class="spinner"></div></div><div style="margin-top:16px;font-size:14px;color:var(--text-muted)">Analyzing ' + coinId + '...</div>';
                loadingOverlay.style.cssText = 'position:absolute;inset:0;background:var(--bg-primary);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;border-radius:var(--radius);min-height:300px';
                resultEl.style.position = 'relative';
                resultEl.appendChild(loadingOverlay);
            } else {
                loadingOverlay.innerHTML = '<div class="loader"><div class="spinner"></div></div><div style="margin-top:16px;font-size:14px;color:var(--text-muted)">Analyzing ' + coinId + '...</div>';
            }
            loadingOverlay.style.display = 'flex';

            // Highlight active chip
            document.querySelectorAll('.insight-chip').forEach(c => c.style.borderColor = 'rgba(255,255,255,0.08)');
            document.querySelectorAll('.insight-chip').forEach(c => {
                if (c.getAttribute('onclick')?.includes(coinId)) c.style.borderColor = 'var(--purple)';
            });

            try {
                const d = await api('/api/token/' + encodeURIComponent(coinId));

                // Token header
                const img = document.getElementById('insightTokenImg');
                if (d.image) { img.src = d.image; img.style.display = 'block'; }
                else { img.style.display = 'none'; }
                document.getElementById('insightTokenName').textContent = d.name;
                document.getElementById('insightTokenSymbol').textContent = d.symbol + (d.rank ? ' • Rank #' + d.rank : '');
                document.getElementById('insightTokenPrice').textContent = fmt(d.price);
                const chgEl = document.getElementById('insightTokenChange');
                const ch24 = d.price_change_24h || 0;
                chgEl.innerHTML = `<span style="color:${ch24 >= 0 ? 'var(--green)' : 'var(--red)'}">${ch24 >= 0 ? '▲' : '▼'} ${Math.abs(ch24).toFixed(2)}% (24h)</span>`;

                // TradingView Chart
                const tvSymbol = getTVSymbol(coinId, d.symbol);
                if (tvSymbol) {
                    currentInsightSymbol = tvSymbol;
                    currentInsightTF = 'D';
                    document.getElementById('insightTVChart').style.display = 'block';
                    document.querySelectorAll('.tv-tf-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('.tv-tf-btn[onclick*="\'D\'"]')?.classList.add('active');
                    renderTVAdvancedChart('insightTVChartWidget', tvSymbol, 'D');

                    // TradingView Technical Analysis widget
                    document.getElementById('insightTVTA').style.display = 'block';
                    renderTVTechnicalAnalysis('insightTVTAWidget', tvSymbol);
                } else {
                    document.getElementById('insightTVChart').style.display = 'none';
                    document.getElementById('insightTVTA').style.display = 'none';
                }

                // Score cards
                const taScore = d.ta_score || 0;
                const rsi = d.ta_rsi || 0;
                document.getElementById('insightTAScore').textContent = taScore.toFixed(1);
                document.getElementById('insightTAScore').style.color = taScore >= 7 ? 'var(--green)' : taScore >= 4 ? 'var(--yellow)' : 'var(--red)';
                document.getElementById('insightTABar').style.width = (taScore * 10) + '%';
                document.getElementById('insightTABar').style.background = taScore >= 7 ? 'var(--green)' : taScore >= 4 ? 'var(--yellow)' : 'var(--red)';

                document.getElementById('insightRSI').textContent = rsi.toFixed(1);
                document.getElementById('insightRSI').style.color = rsi > 70 ? 'var(--red)' : rsi < 30 ? 'var(--green)' : 'var(--text-primary)';
                document.getElementById('insightRSIBar').style.width = rsi + '%';
                document.getElementById('insightRSIBar').style.background = rsi > 70 ? 'var(--red)' : rsi < 30 ? 'var(--green)' : 'var(--accent)';

                const trend = d.ta_trend || 'unknown';
                document.getElementById('insightTrend').textContent = trend;
                document.getElementById('insightTrend').style.color = trend.toLowerCase().includes('bull') || trend.toLowerCase().includes('up') ? 'var(--green)' :
                    trend.toLowerCase().includes('bear') || trend.toLowerCase().includes('down') ? 'var(--red)' : 'var(--yellow)';
                document.getElementById('insightTrendBar').style.background = trend.toLowerCase().includes('bull') ? 'var(--green)' :
                    trend.toLowerCase().includes('bear') ? 'var(--red)' : 'var(--purple)';

                const sentimentVal = d.news_sentiment;
                document.getElementById('insightNewsSentiment').textContent = sentimentVal != null ? (sentimentVal >= 0 ? '+' : '') + sentimentVal.toFixed(2) : '--';
                document.getElementById('insightNewsSentiment').style.color = sentimentVal > 0 ? 'var(--green)' : sentimentVal < 0 ? 'var(--red)' : 'var(--text-primary)';
                document.getElementById('insightSentBar').style.width = Math.min(100, Math.max(10, (sentimentVal + 1) * 50)) + '%';
                document.getElementById('insightSentBar').style.background = sentimentVal > 0 ? 'var(--green)' : sentimentVal < 0 ? 'var(--red)' : 'var(--yellow)';

                // Technical indicators - enhanced rows
                const taRows = [
                    { label: 'RSI (14)', value: rsi.toFixed(1), badge: d.ta_rsi_label || '', badgeColor: rsi > 70 ? 'var(--red)' : rsi < 30 ? 'var(--green)' : 'var(--accent)' },
                    { label: 'Trend', value: trend, badge: '', badgeColor: '' },
                    { label: 'MACD', value: d.ta_macd || '--', badge: '', badgeColor: '' },
                    { label: 'Pattern', value: d.ta_pattern || 'None', badge: '', badgeColor: '' },
                    { label: 'Support', value: d.ta_support ? '$' + d.ta_support.toLocaleString(undefined, { maximumFractionDigits: 6 }) : '--', badge: '', badgeColor: '' },
                    { label: 'Resistance', value: d.ta_resistance ? '$' + d.ta_resistance.toLocaleString(undefined, { maximumFractionDigits: 6 }) : '--', badge: '', badgeColor: '' },
                    {
                        label: 'TA Score', value: taScore.toFixed(1) + ' / 10', badge: taScore >= 7 ? 'STRONG' : taScore >= 4 ? 'MODERATE' : 'WEAK',
                        badgeColor: taScore >= 7 ? 'var(--green)' : taScore >= 4 ? 'var(--yellow)' : 'var(--red)'
                    },
                ];
                document.getElementById('insightTAContent').innerHTML = taRows.map(r => `
            <div class="insight-ta-row">
                <span class="insight-ta-label">${r.label}</span>
                <div style="display:flex;align-items:center;gap:8px">
                    <span class="insight-ta-value">${r.value}</span>
                    ${r.badge ? `<span class="insight-ta-badge" style="background:${r.badgeColor}22;color:${r.badgeColor}">${r.badge}</span>` : ''}
                </div>
            </div>
        `).join('');

                // News
                document.getElementById('insightNewsNarrative').textContent = d.news_narrative || 'No narrative available at this time.';
                const headlines = d.news_headlines || [];
                document.getElementById('insightHeadlines').innerHTML = headlines.length
                    ? headlines.map(h => {
                        const sentColor = 'var(--accent)';
                        return `<div class="insight-news-item"><div class="insight-news-dot" style="background:${sentColor}"></div><span>${h}</span></div>`;
                    }).join('')
                    : '<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:13px">No recent headlines found</div>';

                // AI Recommendation
                if (d.ai_available && d.ai_recommendation) {
                    document.getElementById('insightAIBox').style.display = 'block';
                    document.getElementById('insightAIText').textContent = d.ai_recommendation;
                } else {
                    document.getElementById('insightAIBox').style.display = 'none';
                }

                // Market data table - enhanced
                const mCapStr = d.market_cap ? '$' + (d.market_cap >= 1e9 ? (d.market_cap / 1e9).toFixed(2) + 'B' : d.market_cap >= 1e6 ? (d.market_cap / 1e6).toFixed(2) + 'M' : d.market_cap.toLocaleString()) : '--';
                const volStr = d.volume_24h ? '$' + (d.volume_24h >= 1e9 ? (d.volume_24h / 1e9).toFixed(2) + 'B' : d.volume_24h >= 1e6 ? (d.volume_24h / 1e6).toFixed(2) + 'M' : d.volume_24h.toLocaleString()) : '--';
                const mktRows = [
                    { label: 'Market Cap', value: mCapStr, icon: '💎' },
                    { label: '24h Volume', value: volStr, icon: '📊' },
                    { label: 'All-Time High', value: d.ath ? '$' + d.ath.toLocaleString(undefined, { maximumFractionDigits: 6 }) : '--', icon: '🏔️' },
                    { label: 'Circulating Supply', value: d.circulating_supply ? d.circulating_supply.toLocaleString() + ' ' + d.symbol : '--', icon: '🔄' },
                    { label: 'Rank', value: d.rank ? '#' + d.rank : '--', icon: '🏆' },
                    { label: '24h Change', value: `<span style="color:${ch24 >= 0 ? 'var(--green)' : 'var(--red)'}">${ch24 >= 0 ? '+' : ''}${ch24.toFixed(2)}%</span>`, icon: '📈' },
                    { label: '7d Change', value: d.price_change_7d != null ? `<span style="color:${d.price_change_7d >= 0 ? 'var(--green)' : 'var(--red)'}">${d.price_change_7d >= 0 ? '+' : ''}${d.price_change_7d.toFixed(2)}%</span>` : '--', icon: '📅' },
                ];
                document.getElementById('insightMarketContent').innerHTML = mktRows.map(r => `
            <div class="insight-market-row">
                <span style="color:var(--text-muted);font-size:13px;display:flex;align-items:center;gap:8px"><span>${r.icon}</span>${r.label}</span>
                <span style="font-weight:700;font-size:14px">${r.value}</span>
            </div>
        `).join('');

                // Backtest Strategy Analysis
                const btPanel = document.getElementById('insightBacktestPanel');
                if (d.backtest_strategy_direction || d.backtest_detected_trend) {
                    btPanel.style.display = 'block';
                    const trend = d.backtest_detected_trend || 'unknown';
                    const dir = d.backtest_strategy_direction || 'N/A';
                    const tier = d.backtest_token_tier || 'unknown';
                    const tested = d.backtest_strategies_tested || [];
                    const verified = d.backtest_verified;

                    const trendColors = { uptrend: 'var(--green)', downtrend: 'var(--red)', sideways: 'var(--accent)' };
                    const trendIcons = { uptrend: '📈', downtrend: '📉', sideways: '↔️' };
                    const dirColors = { LONG: '#22c55e', SHORT: '#ef4444', RANGE: '#f59e0b' };
                    const tierIcons = { major: '🏛️', mid: '🏢', micro: '🧬' };

                    let btHtml = '';
                    // Status badge
                    btHtml += `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                <span style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-weight:700;font-size:13px;background:${verified ? 'rgba(34,197,94,0.15)' : 'rgba(251,191,36,0.15)'};color:${verified ? 'var(--green)' : '#fbbf24'}">
                    ${verified ? '✅ BACKTEST VERIFIED' : '⚠️ BACKTEST WARNING'}
                </span>
                <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:12px;background:rgba(255,255,255,0.05);color:var(--text-muted)">
                    ${tierIcons[tier] || '📊'} ${tier.charAt(0).toUpperCase() + tier.slice(1)} Cap
                </span>
            </div>`;

                    // Trend + Direction badges
                    btHtml += `<div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
                <div style="flex:1;min-width:120px;background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,0.06)">
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Detected Trend</div>
                    <div style="font-size:18px;font-weight:800;color:${trendColors[trend] || 'var(--text-secondary)'}">${trendIcons[trend] || '❓'} ${trend.toUpperCase()}</div>
                </div>
                <div style="flex:1;min-width:120px;background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,0.06)">
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Best Strategy</div>
                    <div style="font-size:18px;font-weight:800;color:${dirColors[dir] || 'var(--text-secondary)'}">${dir === 'LONG' ? '🟢' : dir === 'SHORT' ? '🔴' : '🟡'} ${dir}</div>
                </div>
            </div>`;

                    // Backtest stats row
                    const wr = d.backtest_win_rate != null ? d.backtest_win_rate.toFixed(1) + '%' : '--';
                    const ret = d.backtest_total_return != null ? (d.backtest_total_return >= 0 ? '+' : '') + d.backtest_total_return.toFixed(2) + '%' : '--';
                    const dd = d.backtest_max_drawdown != null ? d.backtest_max_drawdown.toFixed(1) + '%' : '--';
                    const sr = d.backtest_sharpe_ratio != null ? d.backtest_sharpe_ratio.toFixed(2) : '--';
                    const trades = d.backtest_total_trades != null ? d.backtest_total_trades : '--';

                    btHtml += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin-bottom:14px">
                ${[
                            { label: 'Win Rate', val: wr, color: d.backtest_win_rate >= 50 ? 'var(--green)' : 'var(--red)' },
                            { label: 'Return', val: ret, color: d.backtest_total_return >= 0 ? 'var(--green)' : 'var(--red)' },
                            { label: 'Max DD', val: dd, color: 'var(--red)' },
                            { label: 'Sharpe', val: sr, color: d.backtest_sharpe_ratio >= 1 ? 'var(--green)' : 'var(--text-muted)' },
                            { label: 'Trades', val: trades, color: 'var(--text-secondary)' },
                        ].map(s => `<div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px 6px;text-align:center;border:1px solid rgba(255,255,255,0.05)">
                    <div style="font-size:10px;color:var(--text-muted);margin-bottom:3px">${s.label}</div>
                    <div style="font-size:14px;font-weight:700;color:${s.color}">${s.val}</div>
                </div>`).join('')}
            </div>`;

                    // Strategies tested
                    if (tested.length > 0) {
                        btHtml += `<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Strategies Tested:</div>
                <div style="display:flex;gap:6px;flex-wrap:wrap">
                    ${tested.map(s => `<span style="padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;background:${s === dir ? (dirColors[s] || 'var(--accent)') + '22' : 'rgba(255,255,255,0.05)'};color:${s === dir ? dirColors[s] || 'var(--accent)' : 'var(--text-muted)'};border:1px solid ${s === dir ? (dirColors[s] || 'var(--accent)') + '44' : 'rgba(255,255,255,0.08)'}">${s}${s === dir ? ' ✓' : ''}</span>`).join('')}
                </div>`;
                    }

                    document.getElementById('insightBacktestContent').innerHTML = btHtml;
                } else {
                    btPanel.style.display = 'none';
                }

                // Hide loading
                const overlay = document.getElementById('insightLoading');
                if (overlay) overlay.style.display = 'none';
            } catch (e) {
                const overlay = document.getElementById('insightLoading');
                if (overlay) overlay.style.display = 'none';
                document.getElementById('insightResult').innerHTML = `
            <div class="insight-empty" style="padding:48px">
                <div class="insight-empty-icon">❌</div>
                <div class="insight-empty-title">${e.message || 'Token not found'}</div>
                <div class="insight-empty-desc">Try using the CoinGecko ID (e.g. "bitcoin", "ethereum", "solana"). The name must match exactly.</div>
            </div>`;
                document.getElementById('insightResult').style.display = 'block';
            }
        }

        // Allow Enter key in insight search
        document.addEventListener('DOMContentLoaded', () => {
            const el2 = document.getElementById('learningTokenSearch');
            if (el2) el2.addEventListener('keydown', e => { if (e.key === 'Enter') loadTokenTrackRecord(); });
        });

        // ── Learning Page ─────────────────────────────────────────────
        async function loadLearningStats() {
            try {
                console.log('[Learning] Fetching stats from:', API + '/api/ai/learning/stats');
                const stats = await api('/api/ai/learning/stats');
                console.log('[Learning] Got stats:', JSON.stringify(stats));

                // Stats values
                const total = stats.total_predictions || 0;
                const eval24 = stats.evaluated_24h || 0;
                const eval7d = stats.evaluated_7d || 0;
                document.getElementById('learnTotalPreds').textContent = total;
                document.getElementById('learnEvaluated24h').textContent = eval24;
                document.getElementById('learnEvaluated7d').textContent = eval7d;
                const avgPnl = stats.avg_pnl_24h || 0;
                document.getElementById('learnAvgPnl').textContent = (avgPnl >= 0 ? '+' : '') + avgPnl.toFixed(2) + '%';
                document.getElementById('learnAvgPnl').style.color = avgPnl >= 0 ? 'var(--green)' : 'var(--red)';
                document.getElementById('learnConfCorrect').textContent = (stats.avg_confidence_correct || 0).toFixed(1);
                document.getElementById('learnConfIncorrect').textContent = (stats.avg_confidence_incorrect || 0).toFixed(1);

                // Animate stat bars
                const pctEval = total > 0 ? (eval24 / total * 100) : 0;
                document.getElementById('learnBarTotal').style.width = '100%';
                document.getElementById('learnBar24h').style.width = pctEval.toFixed(0) + '%';
                document.getElementById('learnBar7d').style.width = (total > 0 ? eval7d / total * 100 : 0).toFixed(0) + '%';

                // 24h Accuracy ring
                const acc24 = stats.accuracy_24h || 0;
                document.getElementById('learningAccuracyPct').textContent = acc24.toFixed(1) + '%';
                document.getElementById('learningAccuracyRing').style.setProperty('--pct', acc24 + '%');
                document.getElementById('learningAccSub24').textContent = `${eval24} predictions evaluated — ${acc24 >= 55 ? 'AI is performing well' : acc24 >= 45 ? 'Average accuracy' : 'Below target, adjusting...'}`;

                // 7d Accuracy ring
                const acc7d = stats.accuracy_7d || 0;
                document.getElementById('learningAccuracyPct7d').textContent = acc7d.toFixed(1) + '%';
                document.getElementById('learningAccuracyRing7d').style.setProperty('--pct', acc7d + '%');
                document.getElementById('learningAccSub7d').textContent = `${eval7d} predictions evaluated over 7 days`;

                // Regime accuracy — enhanced cards
                const regimeDiv = document.getElementById('learningRegimeStats');
                const regimes = stats.regime_accuracy || {};
                if (Object.keys(regimes).length === 0) {
                    regimeDiv.innerHTML = '<div class="empty-state"><p>No regime data available yet. The AI needs more evaluated predictions to analyze market regime performance.</p></div>';
                } else {
                    regimeDiv.innerHTML = '<div class="regime-grid">' +
                        Object.entries(regimes).map(([regime, data]) => {
                            const color = data.accuracy >= 55 ? 'var(--green)' : data.accuracy >= 45 ? 'var(--yellow)' : 'var(--red)';
                            const emoji = regime === 'bullish' ? '📈' : regime === 'bearish' ? '📉' : regime === 'volatile' ? '🌊' : regime === 'sideways' ? '➡️' : regime === 'accumulation' ? '🔄' : '📊';
                            return `
                        <div class="regime-card">
                            <div class="regime-name">${emoji} ${regime}</div>
                            <div class="regime-pct" style="color:${color}">${data.accuracy}%</div>
                            <div class="regime-detail">${data.correct}/${data.total} correct predictions</div>
                            <div class="regime-bar">
                                <div class="regime-bar-fill" style="width:${data.accuracy}%;background:${color}"></div>
                            </div>
                        </div>
                    `;
                        }).join('') + '</div>';
                }

                // Direction accuracy cards
                const dirDiv = document.getElementById('learningDirectionStats');
                const directions = stats.direction_accuracy || {};
                if (Object.keys(directions).length === 0) {
                    dirDiv.innerHTML = '<div class="empty-state"><p>No direction data yet. The AI needs evaluated predictions to track per-direction accuracy.</p></div>';
                } else {
                    const dirColors = { LONG: '#22c55e', SHORT: '#ef4444', RANGE: '#f59e0b' };
                    const dirIcons = { LONG: '🟢', SHORT: '🔴', RANGE: '🟡' };
                    dirDiv.innerHTML = '<div class="regime-grid">' +
                        Object.entries(directions).map(([dir, data]) => {
                            const color = data.accuracy >= 55 ? 'var(--green)' : data.accuracy >= 45 ? 'var(--yellow)' : 'var(--red)';
                            const pnlColor = data.avg_pnl >= 0 ? 'var(--green)' : 'var(--red)';
                            return `
                        <div class="regime-card">
                            <div class="regime-name">${dirIcons[dir] || '📊'} ${dir}</div>
                            <div class="regime-pct" style="color:${color}">${data.accuracy}%</div>
                            <div class="regime-detail">${data.correct}/${data.total} correct | Avg P&L: <span style="color:${pnlColor}">${data.avg_pnl >= 0 ? '+' : ''}${data.avg_pnl}%</span></div>
                            <div class="regime-bar">
                                <div class="regime-bar-fill" style="width:${data.accuracy}%;background:${dirColors[dir] || color}"></div>
                            </div>
                        </div>
                    `;
                        }).join('') + '</div>';
                }

                // Best predictions — enhanced cards
                const bestDiv = document.getElementById('learningBest');
                const best = stats.best_predictions || [];
                bestDiv.innerHTML = best.length ? best.map((b, i) => `
            <div class="prediction-row">
                <span style="color:var(--text-muted);font-size:12px;width:20px">${i + 1}.</span>
                <span class="prediction-ticker">${b.token_ticker}</span>
                <span class="prediction-verdict" style="background:rgba(16,185,129,0.12);color:var(--green)">${b.verdict || 'Buy'}</span>
                <span class="prediction-pnl" style="color:var(--green)">${b.pnl_pct_7d != null ? '+' + b.pnl_pct_7d.toFixed(2) + '%' : '--'}</span>
            </div>
        `).join('') : '<div class="empty-state" style="padding:24px"><p>No 7d data yet — predictions need 7 days to evaluate</p></div>';

                // Worst predictions
                const worstDiv = document.getElementById('learningWorst');
                const worst = stats.worst_predictions || [];
                worstDiv.innerHTML = worst.length ? worst.map((w, i) => `
            <div class="prediction-row">
                <span style="color:var(--text-muted);font-size:12px;width:20px">${i + 1}.</span>
                <span class="prediction-ticker">${w.token_ticker}</span>
                <span class="prediction-verdict" style="background:rgba(239,68,68,0.12);color:var(--red)">${w.verdict || 'Buy'}</span>
                <span class="prediction-pnl" style="color:var(--red)">${w.pnl_pct_7d != null ? w.pnl_pct_7d.toFixed(2) + '%' : '--'}</span>
            </div>
        `).join('') : '<div class="empty-state" style="padding:24px"><p>No 7d data yet</p></div>';

            } catch (e) {
                console.error('Learning stats error:', e);
                // Show the actual error to the user instead of silent zeros
                const errMsg = e.message || 'Could not load learning stats';
                document.getElementById('learnTotalPreds').textContent = '!';
                document.getElementById('learnEvaluated24h').textContent = '-';
                document.getElementById('learnEvaluated7d').textContent = '-';
                document.getElementById('learningRegimeStats').innerHTML =
                    '<div class="empty-state"><p style="color:var(--red)">⚠️ ' + errMsg + '</p></div>';
                document.getElementById('learningDirectionStats').innerHTML =
                    '<div class="empty-state"><p style="color:var(--red)">⚠️ ' + errMsg + '</p></div>';
                document.getElementById('learningBest').innerHTML =
                    '<div class="empty-state" style="padding:24px"><p style="color:var(--red)">⚠️ ' + errMsg + '</p></div>';
                document.getElementById('learningWorst').innerHTML =
                    '<div class="empty-state" style="padding:24px"><p style="color:var(--red)">⚠️ ' + errMsg + '</p></div>';
            }
        }

        async function triggerLearningEvaluation() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '⏳ Evaluating...';
                const result = await api('/api/ai/learning/evaluate', { method: 'POST' });
                const msg = result.message || `Evaluated ${(result.evaluated_24h || 0)} (24h) and ${(result.evaluated_7d || 0)} (7d) predictions`;
                btn.textContent = '✅ Done!';
                setTimeout(() => { btn.textContent = '⚡ Evaluate Predictions'; btn.disabled = false; }, 2000);
                loadLearningStats();
                showToast(msg, 'success');
            } catch (e) {
                event.target.textContent = '⚡ Evaluate Predictions';
                event.target.disabled = false;
                showToast('Evaluation error: ' + (e.message || 'Unknown error'), 'error');
            }
        }

        async function loadStrategyAdjustments() {
            const div = document.getElementById('learningAdjustments');
            div.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });

            try {
                const result = await api('/api/ai/learning/adjustments');
                const adjustments = result.adjustments || [];
                if (adjustments.length === 0) {
                    div.innerHTML = `
                <div class="empty-state" style="padding:36px;text-align:center">
                    <div style="font-size:48px;margin-bottom:16px">✅</div>
                    <p style="font-size:18px;font-weight:700;margin-bottom:8px">All Systems Optimal</p>
                    <p style="font-size:13px;color:var(--text-muted);max-width:400px;margin:0 auto;line-height:1.6">
                        AI performance is on track. Adjustments appear when the AI detects patterns like low accuracy in specific market regimes or poor confidence calibration.
                    </p>
                    <p style="font-size:12px;color:var(--text-muted);margin-top:16px;opacity:0.7">
                        The AI needs at least 5-10 evaluated predictions to generate meaningful strategy adjustments.
                    </p>
                </div>`;
                    return;
                }
                div.innerHTML = adjustments.map(a => {
                    const aType = a.type || a.adjustment_type || 'info';
                    const typeClass = aType.includes('reduction') ? 'adj-decrease' : aType.includes('increase') ? 'adj-increase' : 'adj-hold';
                    const badgeClass = aType.includes('reduction') ? 'decrease' : aType.includes('increase') ? 'increase' : 'hold';
                    const icon = badgeClass === 'decrease' ? '⬇️' : badgeClass === 'increase' ? '⬆️' : '🔄';
                    return `
                <div class="adjustment-card ${typeClass}">
                    <div class="adjustment-header">
                        <span>${icon}</span>
                        <span class="adjustment-type ${badgeClass}">${aType.replace(/_/g, ' ')}</span>
                        ${a.market_regime ? '<span style="font-size:11px;color:var(--text-muted);margin-left:auto">Regime: ' + a.market_regime + '</span>' : ''}
                    </div>
                    <div class="adjustment-detail">${a.description}</div>
                    <div class="adjustment-reason">💡 ${a.reason}</div>
                </div>
            `;
                }).join('');
            } catch (e) {
                div.innerHTML = '<div class="empty-state"><p style="color:var(--red)">⚠️ ' + (e.message || 'Could not load adjustments') + '</p></div>';
            }
        }

        async function loadTokenTrackRecord() {
            const ticker = document.getElementById('learningTokenSearch').value.trim().toUpperCase();
            if (!ticker) { showToast('Enter a token ticker (e.g. BTC, ETH)', 'error'); return; }
            const div = document.getElementById('learningTokenResult');
            div.innerHTML = '<div class="loader"><div class="spinner"></div></div>';

            try {
                const result = await api('/api/ai/learning/token/' + encodeURIComponent(ticker));
                const r = result.track_record || result;
                if (!r || r.predictions === 0) {
                    div.innerHTML = `<div class="empty-state" style="padding:24px;text-align:center">
                <div style="font-size:36px;margin-bottom:12px">🔍</div>
                <p>No predictions found for <strong>${ticker}</strong></p>
                <p style="font-size:12px;color:var(--text-muted);margin-top:8px">Try BTC, ETH, SOL, XRP, or other tracked tokens</p>
            </div>`;
                    return;
                }
                const accColor = (r.accuracy || 0) >= 55 ? 'var(--green)' : (r.accuracy || 0) >= 45 ? 'var(--yellow)' : 'var(--red)';
                const pnlVal = r.avg_pnl_24h || 0;
                div.innerHTML = `
            <div style="margin-top:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <span style="font-size:24px;font-weight:800">${ticker}</span>
                    <span style="font-size:13px;color:var(--text-muted)">Track record across all predictions</span>
                </div>
                <div class="learning-grid" style="grid-template-columns:repeat(4,1fr)">
                    <div class="learning-stat">
                        <div class="learning-stat-icon">🔮</div>
                        <div class="learning-stat-value">${r.predictions}</div>
                        <div class="learning-stat-label">Predictions</div>
                    </div>
                    <div class="learning-stat">
                        <div class="learning-stat-icon">✅</div>
                        <div class="learning-stat-value">${r.evaluated || 0}</div>
                        <div class="learning-stat-label">Evaluated</div>
                    </div>
                    <div class="learning-stat">
                        <div class="learning-stat-icon">🎯</div>
                        <div class="learning-stat-value" style="color:${accColor}">${r.accuracy != null ? r.accuracy + '%' : '--'}</div>
                        <div class="learning-stat-label">Accuracy</div>
                    </div>
                    <div class="learning-stat">
                        <div class="learning-stat-icon">${pnlVal >= 0 ? '📈' : '📉'}</div>
                        <div class="learning-stat-value" style="color:${pnlVal >= 0 ? 'var(--green)' : 'var(--red)'}">${pnlVal >= 0 ? '+' : ''}${pnlVal.toFixed(2)}%</div>
                        <div class="learning-stat-label">Avg P&L 24h</div>
                    </div>
                </div>
                ${r.recent && r.recent.length > 0 ? `
                <div class="learning-panel" style="margin-top:16px">
                    <div class="learning-panel-header">📋 Recent Predictions</div>
                    <div class="learning-panel-body">
                        ${r.recent.map(p => {
                    const pnl = p.pnl_pct_24h;
                    const correct = p.direction_correct_24h;
                    return `<div class="prediction-row">
                                <span style="font-size:12px;color:var(--text-muted);width:130px">${new Date(p.created_at).toLocaleDateString()}</span>
                                <span class="prediction-verdict" style="background:${p.verdict?.includes('Buy') ? 'rgba(16,185,129,0.12)' : 'rgba(239,68,68,0.12)'};color:${p.verdict?.includes('Buy') ? 'var(--green)' : 'var(--red)'}">${p.verdict || '--'}</span>
                                <span style="font-size:12px;color:var(--text-muted)">Conf: ${(p.confidence || 0).toFixed(1)}</span>
                                <span style="font-size:12px;color:var(--text-muted)">$${(p.price_at_prediction || 0).toLocaleString()}</span>
                                <span class="prediction-pnl" style="color:${pnl != null ? (pnl >= 0 ? 'var(--green)' : 'var(--red)') : 'var(--text-muted)'}">${pnl != null ? (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + '%' : 'Pending'}</span>
                                <span style="font-size:16px">${correct === 1 ? '✅' : correct === 0 ? '❌' : '⏳'}</span>
                            </div>`;
                }).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
            } catch (e) {
                div.innerHTML = '<div class="empty-state"><p style="color:var(--red)">⚠️ ' + (e.message || 'Error looking up token') + '</p></div>';
            }
        }

        // ── Token Detail ──────────────────────────────────────────────
        async function openToken(coinId, name) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');
            modal.classList.add('active');
            content.innerHTML = '<div class="loader"><div class="spinner"></div></div>';

            try {
                const d = await api('/api/token/' + encodeURIComponent(coinId));
                const chgCls = d.price_change_24h >= 0 ? 'price-positive' : 'price-negative';

                let html = `
        <div class="detail-header">
            <div class="detail-avatar">${d.symbol.slice(0, 2)}</div>
            <div>
                <div class="detail-name">${d.name}</div>
                <div class="detail-symbol">${d.symbol}${d.rank ? ' · Rank #' + d.rank : ''}</div>
            </div>
            ${currentUser ? '<button class="btn btn-sm btn-outline" style="margin-left:auto" onclick="addWatchlist(\'' + coinId + '\')">★ Watch</button>' : ''}
        </div>

        <div class="detail-price-row">
            <span class="detail-price">${fmt(d.price)}</span>
            <span class="${chgCls}" style="font-size:18px;font-weight:600">
                ${d.price_change_24h >= 0 ? '▲' : '▼'} ${Math.abs(d.price_change_24h).toFixed(2)}% (24h)
            </span>
        </div>

        <div class="metrics-grid">
            <div class="metric-box"><div class="metric-label">Market Cap</div><div class="metric-value">${fmt(d.market_cap)}</div></div>
            <div class="metric-box"><div class="metric-label">Volume 24h</div><div class="metric-value">${fmt(d.volume_24h)}</div></div>
            <div class="metric-box"><div class="metric-label">All-Time High</div><div class="metric-value">${fmt(d.ath)}</div></div>
        </div>`;

                // TradingView Chart in Modal
                const modalTVSymbol = getTVSymbol(coinId, d.symbol);
                if (modalTVSymbol) {
                    html += `
            <div class="tv-modal-chart-wrap">
                <div class="tv-chart-header" style="border-radius:12px 12px 0 0;margin-bottom:0">
                    <span class="tv-chart-label">📈 Live Chart — ${d.symbol}</span>
                    <div class="tv-chart-timeframes" style="gap:4px">
                        <button class="tv-tf-btn tv-tf-sm" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','15')">15m</button>
                        <button class="tv-tf-btn tv-tf-sm" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','60')">1H</button>
                        <button class="tv-tf-btn tv-tf-sm active" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','D')">1D</button>
                        <button class="tv-tf-btn tv-tf-sm" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','W')">1W</button>
                    </div>
                </div>
                <div id="modalTVChart" style="height:350px;border-radius:0 0 12px 12px;overflow:hidden"></div>
            </div>`;
                }

                // TA
                if (d.ta_trend && d.ta_trend !== 'unknown') {
                    const taColor = scoreColor(d.ta_score);
                    html += `
            <div class="analysis-section">
                <div class="analysis-title">📊 Technical Analysis</div>
                <div class="analysis-row"><span>Score</span><span>${d.ta_score.toFixed(1)} / 10</span></div>
                <div class="score-bar-container"><div class="score-bar ${taColor}" style="width:${d.ta_score * 10}%"></div></div>
                <div class="analysis-row" style="margin-top:10px"><span>Trend</span><span>${d.ta_trend}</span></div>
                <div class="analysis-row"><span>RSI (14)</span><span>${d.ta_rsi.toFixed(1)} (${d.ta_rsi_label})</span></div>
                <div class="analysis-row"><span>MACD</span><span>${d.ta_macd}</span></div>
                <div class="analysis-row"><span>Pattern</span><span>${d.ta_pattern || 'None'}</span></div>
                <div class="analysis-row"><span>Support</span><span>${fmt(d.ta_support)}</span></div>
                <div class="analysis-row"><span>Resistance</span><span>${fmt(d.ta_resistance)}</span></div>
            </div>`;
                }

                // Backtest Strategy Analysis
                if (d.backtest_strategy_direction || d.backtest_detected_trend) {
                    const btTrend = d.backtest_detected_trend || 'unknown';
                    const btDir = d.backtest_strategy_direction || 'N/A';
                    const btVerified = d.backtest_verified;
                    const wr = d.backtest_win_rate != null ? d.backtest_win_rate.toFixed(1) + '%' : '--';
                    const btRet = d.backtest_total_return != null ? (d.backtest_total_return >= 0 ? '+' : '') + d.backtest_total_return.toFixed(2) + '%' : '--';
                    const dd = d.backtest_max_drawdown != null ? d.backtest_max_drawdown.toFixed(1) + '%' : '--';
                    const sr = d.backtest_sharpe_ratio != null ? d.backtest_sharpe_ratio.toFixed(2) : '--';
                    const tColors = { uptrend: 'var(--green)', downtrend: 'var(--red)', sideways: 'var(--accent)' };
                    const dColors = { LONG: '#22c55e', SHORT: '#ef4444', RANGE: '#f59e0b' };
                    html += `
            <div class="analysis-section">
                <div class="analysis-title">🔬 Backtest Analysis</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <span style="padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700;background:${btVerified ? 'rgba(34,197,94,0.15)' : 'rgba(251,191,36,0.15)'};color:${btVerified ? 'var(--green)' : '#fbbf24'}">
                        ${btVerified ? '✅ VERIFIED' : '⚠️ UNVERIFIED'}
                    </span>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
                    <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06)">
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:3px">Trend</div>
                        <div style="font-size:16px;font-weight:800;color:${tColors[btTrend] || 'var(--text-secondary)'}">${btTrend.toUpperCase()}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06)">
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:3px">Strategy</div>
                        <div style="font-size:16px;font-weight:800;color:${dColors[btDir] || 'var(--text-secondary)'}">${btDir}</div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">
                    <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 4px;text-align:center"><div style="font-size:9px;color:var(--text-muted)">Win Rate</div><div style="font-size:13px;font-weight:700;color:${d.backtest_win_rate >= 50 ? 'var(--green)' : 'var(--red)'}">${wr}</div></div>
                    <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 4px;text-align:center"><div style="font-size:9px;color:var(--text-muted)">Return</div><div style="font-size:13px;font-weight:700;color:${d.backtest_total_return >= 0 ? 'var(--green)' : 'var(--red)'}">${btRet}</div></div>
                    <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 4px;text-align:center"><div style="font-size:9px;color:var(--text-muted)">Max DD</div><div style="font-size:13px;font-weight:700;color:var(--red)">${dd}</div></div>
                    <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 4px;text-align:center"><div style="font-size:9px;color:var(--text-muted)">Sharpe</div><div style="font-size:13px;font-weight:700;color:${d.backtest_sharpe_ratio >= 1 ? 'var(--green)' : 'var(--text-muted)'}">${sr}</div></div>
                </div>
            </div>`;
                }

                // News
                const newsColor = scoreColor(d.news_score);
                html += `
        <div class="analysis-section">
            <div class="analysis-title">📰 News & Sentiment</div>
            <div class="analysis-row"><span>Score</span><span>${d.news_score.toFixed(1)} / 10</span></div>
            <div class="score-bar-container"><div class="score-bar ${newsColor}" style="width:${d.news_score * 10}%"></div></div>
            <div class="analysis-row" style="margin-top:10px"><span>Narrative</span><span>${d.news_narrative || 'Neutral'}</span></div>
        </div>`;

                if (d.news_headlines?.length) {
                    html += '<div class="analysis-section"><div class="analysis-title">📌 Headlines</div>';
                    d.news_headlines.forEach(h => {
                        html += `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0;border-bottom:1px solid var(--border)">• ${h}</div>`;
                    });
                    html += '</div>';
                }

                // AI
                if (d.ai_available && d.ai_recommendation) {
                    html += `
            <div class="ai-box">
                <div class="ai-box-title">🤖 AI Recommendation <span class="ai-badge">GEMINI</span></div>
                <div class="ai-text">${d.ai_recommendation}</div>
            </div>`;
                } else {
                    html += `
            <div class="ai-box" style="opacity:0.6">
                <div class="ai-box-title">🤖 AI Recommendation <span class="ai-badge" style="background:var(--text-muted)">OFFLINE</span></div>
                <div class="ai-text">AI analysis unavailable. Set a GEMINI_API_KEY with quota to enable.</div>
            </div>`;
                }

                // Full Analysis & Trade button (always visible)
                html += `
        <div style="margin-top:20px;text-align:center">
            <button class="btn btn-primary" style="width:100%;padding:14px;font-size:16px;font-weight:700;border-radius:12px;background:linear-gradient(135deg,#7c5cff,#00d4aa);border:none;cursor:pointer;letter-spacing:0.5px" onclick="closeModal('detailModal'); navigate('insights'); document.getElementById('insightSearch').value='${coinId}'; loadInsightAnalysis()">
                📊 Full Analysis & Trade
            </button>
        </div>`;

                content.innerHTML = html;

                // Render TradingView chart inside modal after DOM update
                if (modalTVSymbol && document.getElementById('modalTVChart')) {
                    setTimeout(() => renderTVAdvancedChart('modalTVChart', modalTVSymbol, 'D'), 100);
                }
            } catch (e) {
                content.innerHTML = `<div class="empty-state"><h3>Error loading token</h3><p>${e.message}</p></div>`;
            }
        }

        async function addWatchlist(coinId) {
            if (!currentUser) return showAuthModal('login');
            try {
                const data = await api(`/api/watchlist/${coinId}`, { method: 'POST' });
                currentUser.watchlist = data.watchlist;
                alert('Added to watchlist!');
            } catch (e) {
                alert(e.message);
            }
        }

        // ── Search ────────────────────────────────────────────────────
        async function doSearch() {
            const q = document.getElementById('globalSearch').value.trim();
            if (!q) return;

            // Try to open as CoinGecko token first
            navigate('market');
            openToken(q.toLowerCase(), q);
        }

        // ══════════════════════════════════════════════════════════════
        // TOAST NOTIFICATIONS
        // ══════════════════════════════════════════════════════════════

        function showToast(message, type = 'info') {
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        // ══════════════════════════════════════════════════════════════
        // AUTO TRADER FUNCTIONS
        // ══════════════════════════════════════════════════════════════

        async function loadTraderDashboard() {
            if (!currentUser) { showAuthModal('login'); return; }
            loadBlockchainStatus();
            try {
                const [perf, positions, autoStatus] = await Promise.all([
                    api('/api/trader/performance'),
                    api('/api/trader/positions'),
                    fetch(API + '/api/autotrader/status').then(r => r.json()).catch(() => ({ running: true })),
                ]);

                // Stats
                document.getElementById('traderBalance').textContent = '$' + formatUSD(perf.wallet_balance);
                const totalPnl = (perf.realized_pnl || 0) + (perf.unrealized_pnl || 0);
                const retCls = totalPnl >= 0 ? 'color:var(--green)' : 'color:var(--red)';
                document.getElementById('traderReturn').innerHTML = `<span style="${retCls}">P&L: $${formatUSD(totalPnl)}</span>`;

                const pnlCls = perf.realized_pnl >= 0 ? 'color:var(--green)' : 'color:var(--red)';
                document.getElementById('traderPnl').innerHTML = `<span style="${pnlCls}">$${formatUSD(perf.realized_pnl)}</span>`;
                document.getElementById('traderWinRate').textContent = `Win rate: ${perf.win_rate}% (${perf.winning_trades}W / ${perf.losing_trades}L)`;

                document.getElementById('traderOpenCount').textContent = perf.open_positions;
                document.getElementById('traderInvested').textContent = `$${formatUSD(perf.invested_in_positions)} invested`;

                document.getElementById('traderTradeCount').textContent = perf.total_trades;
                document.getElementById('traderBestWorst').textContent = `Best: $${formatUSD(perf.best_trade)} | Worst: $${formatUSD(perf.worst_trade)}`;

                // Toggle state — always show Active since server auto-trader runs 24/7
                const isRunning = autoStatus.running !== false; // default true
                const badge = document.getElementById('traderStatusBadge');
                const toggle = document.getElementById('autoTradeToggle');
                toggle.checked = isRunning;
                if (isRunning) {
                    badge.className = 'trader-status active';
                    badge.textContent = '● Active';
                } else {
                    badge.className = 'trader-status inactive';
                    badge.textContent = '● Inactive';
                }

                // Open Positions
                renderTraderPositions(positions.open || []);

                // Load extended dashboard sections (non-blocking)
                loadTodayQuickStats();
                loadLiveFeed();
                loadPnlChart();
                loadPnlHeatmap();
                loadCycleLog();

            } catch (e) {
                console.error('Trader load failed:', e);
            }
        }

        async function refreshTraderDashboard() {
            const btn = document.getElementById('traderRefreshBtn');
            if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; btn.textContent = '⏳'; }
            try {
                await loadTraderDashboard();
                showToast('Dashboard refreshed', 'success');
            } catch (e) {
                showToast('Refresh failed', 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.style.opacity = '1'; btn.textContent = '🔄'; }
            }
        }

        // ── TODAY'S QUICK STATS ──────────────────────────────────
        async function loadTodayQuickStats() {
            try {
                const s = await fetch(API + '/api/trader/today-stats').then(r => r.ok ? r.json() : null).catch(() => null);
                if (!s) return;
                document.getElementById('qsTrades').textContent = s.today_trades;
                document.getElementById('qsBuySell').textContent = `${s.today_buys} buys / ${s.today_sells} sells`;
                const pnlEl = document.getElementById('qsPnl');
                pnlEl.textContent = `${s.today_pnl >= 0 ? '+' : ''}$${formatUSD(Math.abs(s.today_pnl))}`;
                pnlEl.style.color = s.today_pnl >= 0 ? 'var(--green)' : 'var(--red)';
                document.getElementById('qsWinLoss').textContent = `${s.today_wins}W / ${s.today_losses}L`;
                document.getElementById('qsHoldTime').textContent = s.avg_hold_minutes > 0 ? `${s.avg_hold_minutes}m` : s.open_count > 0 ? `${s.open_count} open` : '--';
                const bestEl = document.getElementById('qsBest');
                bestEl.textContent = s.today_best > 0 ? `+$${formatUSD(s.today_best)}` : (s.unrealized_pnl ? `$${formatUSD(s.unrealized_pnl)}` : '$0');
                bestEl.style.color = s.today_best > 0 ? 'var(--green)' : s.unrealized_pnl > 0 ? 'var(--green)' : s.unrealized_pnl < 0 ? 'var(--red)' : 'var(--text-muted)';
                document.getElementById('qsVolume').textContent = `$${formatUSD(s.today_volume)}`;
                document.getElementById('qsClosed').textContent = s.today_closed_count > 0 ? `${s.today_closed_count} closed` : `${s.open_count || 0} open`;
                document.getElementById('todayStatsTime').textContent = `Updated ${new Date().toLocaleTimeString()}`;
            } catch (e) { console.warn('Quick stats load failed:', e); }
        }

        // ── LIVE TRADE FEED ──────────────────────────────────────
        async function loadLiveFeed() {
            try {
                const feed = await fetch(API + '/api/trader/live-feed?limit=15').then(r => r.ok ? r.json() : []).catch(() => []);
                const el = document.getElementById('liveFeedContainer');
                if (!feed.length) {
                    el.innerHTML = '<div class="empty-state" style="padding:20px"><p>No trades yet — the bot is scanning markets...</p></div>';
                    return;
                }
                el.innerHTML = feed.map(f => {
                    const actionCls = f.action.toLowerCase();
                    const dir = f.direction;
                    const hash = f.tx_hash || '';
                    const shortHash = hash ? hash.slice(0, 8) + '…' : '';
                    const time = new Date(f.time);
                    const ago = _timeAgo(time);
                    return `<div class="feed-item">
                        <span class="feed-action ${actionCls}">${f.action}</span>
                        <strong style="min-width:60px">${f.symbol}</strong>
                        <span style="color:var(--text-muted)">@</span>
                        <span>$${f.price < 1 ? f.price.toFixed(6) : f.price.toFixed(2)}</span>
                        <span style="color:${dir==='LONG'?'var(--green)':'var(--red)'};font-size:11px;font-weight:600">${dir === 'LONG' ? '▲' : '▼'} ${dir}</span>
                        ${hash ? `<span style="font-family:monospace;font-size:10px;color:var(--text-muted);cursor:pointer" onclick="verifyHash('${hash}')" title="${hash}">🔗${shortHash}</span>` : ''}
                        <span class="feed-amount">$${formatUSD(f.amount)}</span>
                        <span class="feed-time">${ago}</span>
                    </div>`;
                }).join('');
            } catch (e) {
                console.warn('Live feed load failed:', e);
                const el = document.getElementById('liveFeedContainer');
                if (el) el.innerHTML = '<div class="empty-state" style="padding:20px"><p>No trades yet — the bot is scanning markets...</p></div>';
            }
        }

        function _timeAgo(date) {
            const s = Math.floor((Date.now() - date.getTime()) / 1000);
            if (s < 60) return `${s}s ago`;
            if (s < 3600) return `${Math.floor(s/60)}m ago`;
            if (s < 86400) return `${Math.floor(s/3600)}h ago`;
            return `${Math.floor(s/86400)}d ago`;
        }

        // ── P&L PERFORMANCE CHART ────────────────────────────────
        let _pnlChartInstance = null;
        async function loadPnlChart() {
            try {
                const days = parseInt(document.getElementById('chartDaysSelect').value) || 14;
                const data = await fetch(API + `/api/trader/pnl-chart?days=${days}`).then(r => r.ok ? r.json() : []).catch(() => []);
                const canvas = document.getElementById('pnlChart');
                const emptyEl = document.getElementById('pnlChartEmpty');

                if (!data.length || data.every(d => d.cumulative_pnl === 0 && d.daily_pnl === 0)) {
                    canvas.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                canvas.style.display = 'block';
                emptyEl.style.display = 'none';

                const labels = data.map(d => d.date.slice(5)); // MM-DD
                const cumData = data.map(d => d.cumulative_pnl);
                const dailyData = data.map(d => d.daily_pnl);

                if (_pnlChartInstance) _pnlChartInstance.destroy();

                const ctx = canvas.getContext('2d');
                _pnlChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Cumulative P&L',
                                data: cumData,
                                borderColor: '#6c5ce7',
                                backgroundColor: 'rgba(108,92,231,0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 2,
                                borderWidth: 2,
                            },
                            {
                                label: 'Daily P&L',
                                data: dailyData,
                                type: 'bar',
                                backgroundColor: dailyData.map(v => v >= 0 ? 'rgba(16,185,129,0.5)' : 'rgba(239,68,68,0.5)'),
                                borderRadius: 3,
                                barPercentage: 0.5,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#aaa', font: { size: 11 } } },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: $${ctx.raw.toLocaleString(undefined, {minimumFractionDigits:2})}`,
                                },
                            },
                        },
                        scales: {
                            x: { ticks: { color: '#666', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                            y: {
                                ticks: {
                                    color: '#666',
                                    font: { size: 10 },
                                    callback: (v) => '$' + v.toLocaleString(),
                                },
                                grid: { color: 'rgba(255,255,255,0.05)' },
                            },
                        },
                    },
                });
            } catch (e) {
                console.warn('P&L chart load failed:', e);
                const emptyEl = document.getElementById('pnlChartEmpty');
                if (emptyEl) { emptyEl.style.display = 'block'; emptyEl.textContent = 'No P&L data yet — trades will appear here'; }
                const canvas = document.getElementById('pnlChart');
                if (canvas) canvas.style.display = 'none';
            }
        }

        // ── P&L HEATMAP (TREEMAP) ────────────────────────────────
        function _pnlColor(pct) {
            // Returns background color based on P&L percentage
            if (pct <= -5)  return '#b71c1c';  // deep red
            if (pct <= -3)  return '#c62828';
            if (pct <= -1)  return '#e53935';
            if (pct < -0.2) return '#ef5350';
            if (pct <= 0.2) return '#555';      // neutral
            if (pct < 1)    return '#43a047';
            if (pct < 3)    return '#2e7d32';
            if (pct < 5)    return '#388e3c';
            return '#1b5e20';                   // deep green
        }

        async function loadPnlHeatmap() {
            const grid = document.getElementById('pnlHeatmapGrid');
            if (!grid) return;
            try {
                const days = parseInt(document.getElementById('heatmapDaysSelect')?.value) || 30;
                const data = await fetch(API + `/api/trader/pnl-heatmap?days=${days}`).then(r => r.ok ? r.json() : []).catch(() => []);

                if (!data.length) {
                    grid.innerHTML = '<div class="empty-state" style="padding:40px;width:100%;text-align:center"><p>No trade data yet — P&L heatmap will appear after your first trades</p></div>';
                    return;
                }

                // Squarified treemap layout (simplified)
                const totalSize = data.reduce((s, d) => s + d.position_size, 0) || 1;
                const containerW = grid.offsetWidth || 600;
                const containerH = Math.max(260, Math.min(400, data.length * 30));
                grid.style.height = containerH + 'px';

                // Simple flex-ratio approach: each tile gets proportional area
                let html = '';
                const tooltip = document.getElementById('heatmapTooltip');

                data.forEach((d, i) => {
                    const ratio = d.position_size / totalSize;
                    // Use flex-basis for proportional sizing
                    const areaFraction = ratio * 100;
                    const bgColor = _pnlColor(d.pnl_pct);
                    const pnlSign = d.pnl >= 0 ? '+' : '';
                    const pnlPctSign = d.pnl_pct >= 0 ? '+' : '';

                    // Determine tile sizing class
                    let fontSize = ratio > 0.15 ? 'large' : ratio > 0.07 ? 'medium' : 'small';
                    let symbolSize = fontSize === 'large' ? '16px' : fontSize === 'medium' ? '13px' : '11px';
                    let pnlSize = fontSize === 'large' ? '20px' : fontSize === 'medium' ? '15px' : '12px';
                    let showAmount = ratio > 0.04;

                    html += `<div class="pnl-heatmap-tile" 
                        style="flex:${Math.max(areaFraction, 2)} 1 0;background:${bgColor};min-height:${ratio > 0.15 ? 120 : ratio > 0.07 ? 80 : 55}px"
                        data-idx="${i}"
                        onmouseenter="showHeatmapTip(event, ${i})"
                        onmousemove="moveHeatmapTip(event)"
                        onmouseleave="hideHeatmapTip()">
                        ${d.status === 'open' ? '<span class="tile-badge">OPEN</span>' : ''}
                        <span class="tile-symbol" style="font-size:${symbolSize}">${d.symbol}</span>
                        <span class="tile-pnl" style="font-size:${pnlSize}">${pnlPctSign}${d.pnl_pct.toFixed(1)}%</span>
                        ${showAmount ? `<span class="tile-amount">${pnlSign}$${Math.abs(d.pnl).toFixed(2)}</span>` : ''}
                    </div>`;
                });

                grid.innerHTML = html;

                // Store data for tooltip access
                window._heatmapData = data;

            } catch (e) {
                console.warn('P&L heatmap load failed:', e);
                grid.innerHTML = '<div class="empty-state" style="padding:40px;width:100%;text-align:center"><p>Failed to load heatmap</p></div>';
            }
        }

        function showHeatmapTip(e, idx) {
            const d = window._heatmapData?.[idx];
            if (!d) return;
            const tip = document.getElementById('heatmapTooltip');
            const pnlColor = d.pnl >= 0 ? 'var(--green)' : 'var(--red)';
            const sign = d.pnl >= 0 ? '+' : '';
            tip.innerHTML = `
                <div style="font-weight:700;font-size:15px;margin-bottom:6px">${d.symbol} <span style="font-size:11px;color:var(--text-muted)">${d.coin}</span></div>
                <div class="tip-row"><span class="tip-label">P&L</span><span class="tip-value" style="color:${pnlColor}">${sign}$${d.pnl.toFixed(2)}</span></div>
                <div class="tip-row"><span class="tip-label">P&L %</span><span class="tip-value" style="color:${pnlColor}">${sign}${d.pnl_pct.toFixed(2)}%</span></div>
                <div class="tip-row"><span class="tip-label">Position</span><span class="tip-value">$${d.position_size.toFixed(2)}</span></div>
                <div class="tip-row"><span class="tip-label">Trades</span><span class="tip-value">${d.trades}</span></div>
                <div class="tip-row"><span class="tip-label">Status</span><span class="tip-value">${d.status === 'open' ? '🟢 Open' : '⚪ Closed'}</span></div>
            `;
            tip.style.display = 'block';
            moveHeatmapTip(e);
        }

        function moveHeatmapTip(e) {
            const tip = document.getElementById('heatmapTooltip');
            if (!tip || tip.style.display === 'none') return;
            const x = Math.min(e.clientX + 14, window.innerWidth - 260);
            const y = Math.min(e.clientY + 14, window.innerHeight - 200);
            tip.style.left = x + 'px';
            tip.style.top = y + 'px';
        }

        function hideHeatmapTip() {
            const tip = document.getElementById('heatmapTooltip');
            if (tip) tip.style.display = 'none';
        }

        // ── CYCLE LOG ────────────────────────────────────────────
        async function loadCycleLog() {
            try {
                const cycles = await fetch(API + '/api/trader/cycle-log').then(r => r.json());
                const el = document.getElementById('cycleLogContainer');
                if (!cycles.length) {
                    el.innerHTML = '<div class="empty-state" style="padding:20px"><p>No cycles recorded yet — auto-trader will log cycles here</p></div>';
                    return;
                }
                el.innerHTML = cycles.map(c => {
                    const time = new Date(c.time);
                    const statusCls = c.status === 'ok' ? 'ok' : (c.status === 'disabled' || c.status === 'paused') ? 'disabled' : 'ok';
                    const port = c.portfolio || {};
                    const portText = port.total_positions !== undefined
                        ? `${port.long_positions || 0}L / ${port.short_positions || 0}S (${port.total_positions}/${port.max_slots || 15})`
                        : '';
                    return `<div class="cycle-item">
                        <div class="cycle-header">
                            <span style="color:var(--text-muted);font-size:11px;min-width:50px">#${c.cycle}</span>
                            <span class="cycle-badge ${statusCls}">${c.status.toUpperCase()}</span>
                            <span style="font-size:12px">🆕 ${c.new_trades} trades</span>
                            <span style="font-size:12px">📝 ${c.positions_updated} updated</span>
                            ${portText ? `<span style="font-size:11px;color:var(--text-muted)">📊 ${portText}</span>` : ''}
                            <span class="feed-time" style="margin-left:auto">${time.toLocaleTimeString()}</span>
                        </div>
                        ${c.actions && c.actions.length ? `<div class="cycle-actions">${c.actions.map(a => `<div>→ ${a}</div>`).join('')}</div>` : ''}
                    </div>`;
                }).join('');
            } catch (e) {
                console.warn('Cycle log load failed:', e);
                const el = document.getElementById('cycleLogContainer');
                if (el) el.innerHTML = '<div class="empty-state" style="padding:20px"><p>No cycles recorded yet — auto-trader will log cycles here</p></div>';
            }
        }

        // Auto-refresh trader dashboard every 30 seconds when on Auto Trader page
        let _traderRefreshInterval = null;
        function startTraderAutoRefresh() {
            stopTraderAutoRefresh();
            _traderRefreshInterval = setInterval(() => {
                const traderPage = document.getElementById('page-autotrader');
                if (traderPage && traderPage.classList.contains('active') && currentUser) {
                    loadTraderDashboard();
                }
            }, 30000); // 30 seconds
        }
        function stopTraderAutoRefresh() {
            if (_traderRefreshInterval) { clearInterval(_traderRefreshInterval); _traderRefreshInterval = null; }
        }
        // Start auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', startTraderAutoRefresh);

        function renderTraderPositions(positions) {
            const el = document.getElementById('traderPositions');
            if (!positions.length) {
                el.innerHTML = '<div class="empty-state" style="padding:20px"><p>No open positions — the bot scans every 30s and will execute automatically</p></div>';
                return;
            }

            // Portfolio summary bar
            const longs = positions.filter(p => (p.side || 'long') === 'long').length;
            const shorts = positions.filter(p => (p.side || 'long') === 'short').length;
            const totalInvested = positions.reduce((s, p) => s + p.invested_amount, 0);
            const totalPnl = positions.reduce((s, p) => s + p.pnl, 0);
            const summaryHtml = `
            <div style="display:flex;gap:12px;margin-bottom:14px;padding:10px 14px;background:var(--bg-secondary);border-radius:10px;font-size:13px;flex-wrap:wrap;align-items:center">
                <span style="color:var(--text-muted)">📊 Portfolio:</span>
                <span style="color:var(--green)">▲ ${longs} LONG</span>
                <span style="color:var(--red)">▼ ${shorts} SHORT</span>
                <span style="color:var(--text-muted)">|</span>
                <span>Invested: <strong>$${formatUSD(totalInvested)}</strong></span>
                <span style="color:${totalPnl >= 0 ? 'var(--green)' : 'var(--red)'}">P&L: <strong>${totalPnl >= 0 ? '+' : ''}$${formatUSD(Math.abs(totalPnl))}</strong></span>
                <span style="color:var(--text-muted)">| Slots: ${positions.length}/15</span>
            </div>`;

            el.innerHTML = summaryHtml + positions.map(p => {
                const pnlCls = p.pnl >= 0 ? 'profit' : 'loss';
                const pnlSign = p.pnl >= 0 ? '+' : '';
                const posHash = p.tx_hash || '';
                const posShortHash = posHash ? posHash.slice(0, 8) + '…' + posHash.slice(-6) : '';
                const side = (p.side || 'long').toUpperCase();
                const sideColor = side === 'SHORT' ? 'var(--red)' : 'var(--green)';
                const sideIcon = side === 'SHORT' ? '▼' : '▲';
                const closeLabel = side === 'SHORT' ? 'Cover' : 'Sell';

                // Countdown timer calculation
                const openedAt = new Date(p.opened_at || p.created_at);
                const expiresAt = new Date(openedAt.getTime() + 60 * 60 * 1000); // 1 hour
                const now = new Date();
                const msRemaining = Math.max(0, expiresAt - now);
                const minRemaining = Math.floor(msRemaining / 60000);
                const secRemaining = Math.floor((msRemaining % 60000) / 1000);
                const timeStr = msRemaining > 0 ? `${minRemaining}m ${secRemaining}s` : 'EXPIRED';
                const timeColor = minRemaining <= 5 ? 'var(--red)' : minRemaining <= 15 ? '#f39c12' : 'var(--green)';
                const timeBg = minRemaining <= 5 ? 'rgba(255,71,87,0.12)' : 'transparent';

                return `
        <div class="position-card" style="border-left:3px solid ${sideColor}">
            <div class="position-header">
                <div class="position-coin">
                    <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;color:#fff;background:${sideColor};margin-right:6px">${sideIcon} ${side}</span>
                    ${p.symbol} <span style="color:var(--text-muted);font-weight:400;font-size:13px">${p.coin_name}</span>
                </div>
                <div style="display:flex;align-items:center;gap:10px">
                    <span class="position-badge ${pnlCls}">${pnlSign}$${Math.abs(p.pnl).toFixed(2)} (${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%)</span>
                    <button class="btn btn-sm btn-danger" onclick="sellPosition(${p.id})">${closeLabel}</button>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin:6px 0;padding:5px 10px;background:${timeBg};border-radius:6px;font-size:12px">
                <span style="color:var(--text-muted)">⏱ Auto-close in:</span>
                <strong style="color:${timeColor}" data-countdown="${expiresAt.toISOString()}">${timeStr}</strong>
                ${minRemaining <= 5 && msRemaining > 0 ? '<span style="color:var(--red);font-size:11px">⚠️ Closing soon!</span>' : ''}
            </div>
            <div class="position-details">
                <div><span>Entry Price</span><strong>$${p.entry_price.toFixed(2)}</strong></div>
                <div><span>Current</span><strong>$${p.current_price.toFixed(2)}</strong></div>
                <div><span>Quantity</span><strong>${p.quantity.toFixed(6)}</strong></div>
                <div><span>Invested</span><strong>$${formatUSD(p.invested_amount)}</strong></div>
                <div><span>Stop Loss</span><strong>$${p.stop_loss.toFixed(2)}</strong></div>
                <div><span>Take Profit</span><strong>$${p.take_profit.toFixed(2)}</strong></div>
            </div>
            ${posHash ? `<div style="margin-top:6px;font-family:monospace;font-size:11px;color:var(--text-muted)">
                🔗 <span title="${posHash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${posHash}')">${posShortHash}</span>
                <span data-hash="${posHash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${posHash}')">📋</span>
            </div>` : ''}
            <div style="margin-top:8px;padding:8px;background:var(--bg-primary);border-radius:6px;font-size:12px;color:var(--text-secondary);line-height:1.5">
                <strong style="color:var(--accent)">🤖 AI Analysis:</strong> ${p.ai_reasoning}
            </div>
        </div>`;
            }).join('');

            // Start countdown timer updates
            _startCountdownTimers();
        }

        // Live countdown timers for position auto-close
        let _countdownInterval = null;
        function _startCountdownTimers() {
            if (_countdownInterval) clearInterval(_countdownInterval);
            _countdownInterval = setInterval(() => {
                document.querySelectorAll('[data-countdown]').forEach(el => {
                    const expires = new Date(el.dataset.countdown);
                    const ms = Math.max(0, expires - new Date());
                    const min = Math.floor(ms / 60000);
                    const sec = Math.floor((ms % 60000) / 1000);
                    if (ms <= 0) {
                        el.textContent = 'CLOSING...';
                        el.style.color = 'var(--red)';
                    } else {
                        el.textContent = `${min}m ${sec}s`;
                        el.style.color = min <= 5 ? 'var(--red)' : min <= 15 ? '#f39c12' : 'var(--green)';
                    }
                });
            }, 1000);
        }

        async function toggleAutoTrade() {
            if (!currentUser) return;
            const badge = document.getElementById('traderStatusBadge');
            const toggle = document.getElementById('autoTradeToggle');
            const isEnabling = toggle.checked;

            if (isEnabling) {
                badge.className = 'trader-status active';
                badge.textContent = '⏳ Starting...';
            }

            try {
                const data = await api('/api/trader/toggle', { method: 'POST' });

                if (data.auto_trade_enabled) {
                    badge.className = 'trader-status active';
                    badge.textContent = '● Active';

                    // Update wallet balance immediately
                    if (data.wallet_balance !== undefined) {
                        document.getElementById('traderBalance').textContent = '$' + formatUSD(data.wallet_balance);
                    }

                    // Show first cycle results
                    if (data.cycle) {
                        const cycle = data.cycle;
                        if (cycle.status === 'no_funds') {
                            showToast('⚠️ Wallet is empty — deposit funds to start auto-trading', 'warning');
                        } else if (cycle.actions?.length) {
                            showToast(`Auto Trader active! ${cycle.actions.length} trade(s) executed`, 'success');
                        } else if (cycle.new_trades === 0 && cycle.positions_updated >= 0) {
                            showToast('Auto Trader active! Monitoring markets for opportunities...', 'success');
                        } else {
                            showToast('Auto Trader is now running!', 'success');
                        }
                    }

                    // Refresh entire dashboard with latest data
                    loadTraderDashboard();
                } else {
                    badge.className = 'trader-status inactive';
                    badge.textContent = '● Inactive';
                    showToast('Auto Trader stopped', 'info');
                }
            } catch (e) {
                // Revert toggle on error
                toggle.checked = !isEnabling;
                badge.className = isEnabling ? 'trader-status inactive' : 'trader-status active';
                badge.textContent = isEnabling ? '● Inactive' : '● Active';
                alert(e.message);
            }
        }

        async function runTradeCycle() {
            if (!currentUser) return showAuthModal('login');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '⏳ Running...';
            try {
                const result = await api('/api/trader/run-cycle', { method: 'POST' });
                let msg = `Status: ${result.status || 'done'}\n`;
                if (result.actions?.length) {
                    msg += result.actions.join('\n');
                } else if (result.message) {
                    msg += result.message;
                } else {
                    msg += `Positions updated: ${result.positions_updated || 0}, New trades: ${result.new_trades || 0}`;
                }
                alert(msg);
                loadTraderDashboard();
            } catch (e) { alert('Error: ' + e.message); }
            finally {
                btn.disabled = false;
                btn.textContent = '⚡ Run Trade Cycle';
            }
        }

        async function runResearch() {
            if (!currentUser) return showAuthModal('login');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '🔍 Researching...';
            try {
                const data = await api('/api/trader/research');
                const el = document.getElementById('traderOpportunities');
                if (!data.opportunities?.length) {
                    el.innerHTML = '<div class="empty-state"><p>No opportunities found right now</p></div>';
                    return;
                }
                el.innerHTML = data.opportunities.map(o => {
                    const scoreCls = o.score >= 60 ? 'high' : o.score >= 35 ? 'mid' : 'low';
                    const side = (o.side || 'long').toUpperCase();
                    const sideColor = side === 'SHORT' ? '#ff4757' : '#2ed573';
                    const sideIcon = side === 'SHORT' ? '▼' : '▲';
                    return `
            <div class="opp-card" style="border-left:3px solid ${sideColor}">
                <div class="opp-info">
                    <div class="opp-name">
                        <span style="display:inline-block;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:700;color:#fff;background:${sideColor};margin-right:4px">${sideIcon} ${side}</span>
                        ${o.symbol} <span style="color:var(--text-muted);font-weight:400">${o.name}</span>
                    </div>
                    <div class="opp-detail">$${o.price.toFixed(4)} | 24h: ${o.change_24h >= 0 ? '+' : ''}${o.change_24h.toFixed(1)}% | Vol: $${(o.volume_24h / 1000).toFixed(0)}K</div>
                    <div class="opp-detail" style="margin-top:4px">💡 ${o.reasoning}</div>
                </div>
                <div class="opp-score ${scoreCls}">${o.score}</div>
            </div>`;
                }).join('');
            } catch (e) { alert('Research failed: ' + e.message); }
            finally {
                btn.disabled = false;
                btn.textContent = '🔍 Research Market';
            }
        }

        async function sellPosition(posId) {
            if (!confirm('Sell this position?')) return;
            try {
                const result = await api(`/api/trader/sell/${posId}`, { method: 'POST' });
                const hashLine = result.tx_hash ? `\n\n🔗 TX Hash:\n${result.tx_hash}` : '';
                alert(`Sold! P&L: $${result.pnl.toFixed(2)} (${result.pnl_pct >= 0 ? '+' : ''}${result.pnl_pct.toFixed(1)}%)${hashLine}`);
                loadTraderDashboard();
            } catch (e) { alert(e.message); }
        }

        function showManualBuyModal() {
            if (!currentUser) return showAuthModal('login');
            const html = `
        <h2>🛒 Buy Crypto</h2>
        <div class="form-group"><label>Coin ID (e.g. bitcoin, ethereum, solana)</label>
            <input class="form-input" id="manualBuyCoin" placeholder="bitcoin"></div>
        <div class="form-group"><label>Amount ($)</label>
            <input class="form-input" id="manualBuyAmount" type="number" placeholder="5000">
            <div style="display:flex;gap:6px;margin-top:6px">
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=1000">$1K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=5000">$5K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=10000">$10K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=20000">$20K</button>
            </div>
        </div>
        <button class="btn btn-green" style="width:100%;margin-top:8px" onclick="submitManualBuy()">Buy Now</button>
    `;
            showDynamicModal(html);
        }

        async function submitManualBuy() {
            const coin_id = document.getElementById('manualBuyCoin').value.trim().toLowerCase();
            const amount = parseFloat(document.getElementById('manualBuyAmount').value);
            if (!coin_id || !amount || amount <= 0) return alert('Enter coin and amount');
            try {
                const result = await api('/api/trader/buy', {
                    method: 'POST',
                    body: JSON.stringify({ coin_id, amount }),
                });
                closeDynamicModal();
                const hashLine = result.tx_hash ? `\n\n🔗 TX Hash:\n${result.tx_hash}` : '';
                alert(`✅ Buy order placed for $${amount.toLocaleString()}${hashLine}`);
                loadTraderDashboard();
            } catch (e) { alert(e.message); }
        }

        function showDynamicModal(html) {
            let overlay = document.getElementById('dynamicModal');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'dynamicModal';
                overlay.className = 'modal-overlay';
                overlay.innerHTML = '<div class="modal" id="dynamicModalContent"></div>';
                overlay.addEventListener('click', e => { if (e.target === overlay) closeDynamicModal(); });
                document.body.appendChild(overlay);
            }
            document.getElementById('dynamicModalContent').innerHTML = `<button class="modal-close" onclick="closeDynamicModal()">&times;</button>` + html;
            overlay.classList.add('active');
        }
        function closeDynamicModal() {
            document.getElementById('dynamicModal')?.classList.remove('active');
        }

        function showTraderSettings() {
            if (!currentUser) return showAuthModal('login');
            api('/api/trader/settings').then(s => {
                const html = `
            <h2>⚙️ Trading Settings</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Max Trade Size (%)</div>
                    <input class="setting-input" id="setMaxTrade" type="number" value="${s.max_trade_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Daily Loss Limit (%)</div>
                    <input class="setting-input" id="setDailyLoss" type="number" value="${s.daily_loss_limit_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Max Open Positions</div>
                    <input class="setting-input" id="setMaxPos" type="number" value="${s.max_open_positions}" min="1" max="20">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Stop Loss (%)</div>
                    <input class="setting-input" id="setStopLoss" type="number" value="${s.stop_loss_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Take Profit (%)</div>
                    <input class="setting-input" id="setTakeProfit" type="number" value="${s.take_profit_pct}" min="1" max="200">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Cooldown (minutes)</div>
                    <input class="setting-input" id="setCooldown" type="number" value="${s.cooldown_minutes}" min="0" max="60">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Min Market Cap ($)</div>
                    <input class="setting-input" id="setMinMcap" type="number" value="${s.min_market_cap}">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Risk Level</div>
                    <select class="setting-input" id="setRiskLevel">
                        <option value="conservative" ${s.risk_level === 'conservative' ? 'selected' : ''}>Conservative</option>
                        <option value="balanced" ${s.risk_level === 'balanced' || s.risk_level === 'moderate' ? 'selected' : ''}>Balanced</option>
                        <option value="aggressive" ${s.risk_level === 'aggressive' ? 'selected' : ''}>Aggressive</option>
                    </select>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px">
                        Aggressive = bypass backtest gate, lower score threshold, faster trades
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="saveTraderSettings()">Save Settings</button>
        `;
                showDynamicModal(html);
            });
        }

        async function saveTraderSettings() {
            try {
                await api('/api/trader/settings', {
                    method: 'POST',
                    body: JSON.stringify({
                        max_trade_pct: parseFloat(document.getElementById('setMaxTrade').value),
                        daily_loss_limit_pct: parseFloat(document.getElementById('setDailyLoss').value),
                        max_open_positions: parseInt(document.getElementById('setMaxPos').value),
                        stop_loss_pct: parseFloat(document.getElementById('setStopLoss').value),
                        take_profit_pct: parseFloat(document.getElementById('setTakeProfit').value),
                        cooldown_minutes: parseInt(document.getElementById('setCooldown').value),
                        min_market_cap: parseFloat(document.getElementById('setMinMcap').value),
                        risk_level: document.getElementById('setRiskLevel').value,
                    }),
                });
                closeDynamicModal();
                alert('Settings saved!');
            } catch (e) { alert(e.message); }
        }

        async function resetTrading() {
            if (!confirm('Reset trading? This will close all open positions and refund invested amounts to your wallet.')) return;
            try {
                await api('/api/trader/reset', { method: 'POST' });
                alert('Trading stats reset! Open positions refunded to wallet.');
                loadTraderDashboard();
            } catch (e) { alert(e.message); }
        }

        function copyHash(hash) {
            navigator.clipboard.writeText(hash).then(() => {
                const btn = document.querySelector(`[data-hash="${hash}"]`);
                if (btn) { btn.textContent = '✓'; setTimeout(() => btn.textContent = '📋', 1200); }
            });
        }

        async function verifyHash(hash) {
            try {
                const res = await api(`/api/verify-tx/${hash}`);
                let msg = '';
                if (res.found && res.verified) {
                    msg = `✅ VERIFIED (Local)\n\nSource: ${res.source}\nHash: ${hash}\n\nThis transaction is authentic and has not been tampered with.`;
                } else if (res.found) {
                    msg = `⚠️ INTEGRITY WARNING\n\nHash: ${hash}\nThe hash does not match the transaction data.`;
                } else {
                    msg = `❌ NOT FOUND\n\nHash: ${hash}\nNo transaction found with this hash.`;
                }
                // Show on-chain status
                if (res.on_chain && res.on_chain.exists) {
                    msg += `\n\n⛓ ON-CHAIN VERIFIED (${res.on_chain.network})\nRecorder: ${res.on_chain.recorder}\nType: ${res.on_chain.tx_type}\nSymbol: ${res.on_chain.symbol}\nAmount: $${res.on_chain.amount_usd.toFixed(2)}`;
                    if (res.on_chain.explorer_url) msg += `\nExplorer: ${res.on_chain.explorer_url}`;
                } else if (res.on_chain && !res.on_chain.exists) {
                    msg += `\n\n⏳ Not yet recorded on-chain (${res.on_chain.network})`;
                } else {
                    msg += `\n\n🔗 Blockchain: Not configured (local hash only)`;
                }
                alert(msg);
            } catch (e) { alert('Error verifying: ' + e.message); }
        }

        async function loadBlockchainStatus() {
            try {
                const status = await api('/api/blockchain/status');
                const el = document.getElementById('blockchainStatusBadge');
                if (!el) return;
                if (status.enabled) {
                    el.innerHTML = `<span style="color:var(--green);font-size:12px">⛓ ${status.network} · ${status.on_chain_tx_count || 0} on-chain</span>`;
                } else {
                    el.innerHTML = `<span style="color:var(--text-muted);font-size:12px">⛓ Local hashes only</span>`;
                }
            } catch (e) { }
        }

        async function loadTraderHistory() {
            try {
                const trades = await api('/api/trader/history?limit=25');
                const el = document.getElementById('traderHistoryArea');
                if (!trades.length) { el.innerHTML = '<div class="empty-state"><p>No trades yet</p></div>'; return; }
                el.innerHTML = `<table class="feed-table"><thead><tr><th></th><th>Time</th><th>Action</th><th>Coin</th><th>Price</th><th>Amount</th><th>Score</th><th>TX Hash</th></tr></thead><tbody>` +
                    trades.map(t => {
                        const actionCls = t.action === 'BUY' ? 'color:var(--green)' : 'color:var(--red)';
                        const hash = t.tx_hash || '';
                        const shortHash = hash ? hash.slice(0, 8) + '…' + hash.slice(-6) : 'N/A';
                        return `<tr style="background:rgba(108,99,255,0.03)">
                    <td><span class="badge-paper">PAPER</span></td>
                    <td style="font-size:12px">${new Date(t.created_at).toLocaleString()}</td>
                    <td style="${actionCls};font-weight:600">${t.action}</td>
                    <td>${t.symbol}</td>
                    <td>$${t.price.toFixed(2)}</td>
                    <td>$${formatUSD(t.amount)}</td>
                    <td>${t.ai_score}/100</td>
                    <td style="font-family:monospace;font-size:11px">
                        ${hash ? `<span title="${hash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${hash}')">${shortHash}</span>
                        <span data-hash="${hash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${hash}')">📋</span>` : 'N/A'}
                    </td>
                </tr>`;
                    }).join('') + '</tbody></table>';
            } catch (e) { console.error(e); }
        }

        async function loadTraderLog() {
            try {
                const logs = await api('/api/trader/log?limit=30');
                const el = document.getElementById('traderHistoryArea');
                if (!logs.length) { el.innerHTML = '<div class="empty-state"><p>No log entries yet</p></div>'; return; }
                el.innerHTML = logs.map(l => `
            <div class="log-item">
                <span class="log-time">${new Date(l.created_at).toLocaleString()}</span>
                <span class="log-event">[${l.event}]</span>
                <span>${l.details}</span>
            </div>
        `).join('');
            } catch (e) { console.error(e); }
        }

        async function loadClosedPositions() {
            try {
                const data = await api('/api/trader/positions');
                const closed = data.closed || [];
                const el = document.getElementById('traderHistoryArea');
                if (!closed.length) { el.innerHTML = '<div class="empty-state"><p>No closed positions yet</p></div>'; return; }
                el.innerHTML = closed.map(p => {
                    const pnlCls = p.pnl >= 0 ? 'profit' : 'loss';
                    const sign = p.pnl >= 0 ? '+' : '';
                    const clHash = p.tx_hash || '';
                    const clShortHash = clHash ? clHash.slice(0, 8) + '…' + clHash.slice(-6) : '';
                    const side = (p.side || 'long').toUpperCase();
                    const sideColor = side === 'SHORT' ? 'var(--red)' : 'var(--green)';
                    const sideIcon = side === 'SHORT' ? '▼' : '▲';
                    return `
            <div class="position-card" style="border-left:3px solid ${sideColor};background:rgba(108,99,255,0.03)">
                <div class="position-header">
                    <div class="position-coin">
                        <span class="badge-paper" style="margin-right:6px">PAPER</span>
                        <span style="display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;color:#fff;background:${sideColor};margin-right:4px">${sideIcon} ${side}</span>
                        ${p.symbol} <span style="color:var(--text-muted);font-weight:400;font-size:13px">${p.coin_name}</span>
                    </div>
                    <span class="position-badge ${pnlCls}">${sign}$${Math.abs(p.pnl).toFixed(2)} (${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%)</span>
                </div>
                <div class="position-details">
                    <div><span>Entry</span><strong>$${p.entry_price.toFixed(2)}</strong></div>
                    <div><span>Exit</span><strong>$${p.current_price.toFixed(2)}</strong></div>
                    <div><span>Invested</span><strong>$${formatUSD(p.invested_amount)}</strong></div>
                </div>
                <div style="margin-top:6px;font-size:11px;color:var(--text-muted)">Closed: ${new Date(p.closed_at).toLocaleString()}</div>
                ${clHash ? `<div style="font-family:monospace;font-size:11px;margin-top:3px;color:var(--text-muted)">
                    🔗 <span title="${clHash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${clHash}')">${clShortHash}</span>
                    <span data-hash="${clHash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${clHash}')">📋</span>
                </div>` : ''}
            </div>`;
                }).join('');
            } catch (e) { console.error(e); }
        }

        // ══════════════════════════════════════════════════════════════
        // CONTACT FORM
        // ══════════════════════════════════════════════════════════════

        function submitContactForm(e) {
            if (e) e.preventDefault();
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const subject = document.getElementById('contactSubject').value;
            const message = document.getElementById('contactMessage').value.trim();

            if (!name || !email || !message) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('Please enter a valid email', 'error');
                return;
            }

            const btn = document.getElementById('contactSubmitBtn');
            const btnText = document.getElementById('contactBtnText');
            const spinner = document.getElementById('contactBtnSpinner');
            const statusEl = document.getElementById('contactFormStatus');

            // Loading state
            btn.disabled = true;
            btnText.textContent = 'Sending...';
            spinner.style.display = 'inline-block';
            statusEl.style.display = 'none';

            const subjectMap = { general: 'General Inquiry', bug: 'Bug Report', feature: 'Feature Request', trading: 'Trading Support', billing: 'Billing', partnership: 'Partnership' };

            fetch(API + '/api/contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    subject: subjectMap[subject] || subject,
                    message: message
                })
            }).then(function(res) {
                if (!res.ok) throw new Error('Server error');
                return res.json();
            }).then(function() {
                btn.disabled = false;
                btnText.textContent = 'Send Message';
                spinner.style.display = 'none';
                statusEl.className = 'contact-status contact-status-success';
                statusEl.innerHTML = '&#10003; Message sent successfully! We\'ll get back to you soon.';
                statusEl.style.display = 'block';
                document.getElementById('contactForm').reset();
                setTimeout(function() { statusEl.style.display = 'none'; }, 5000);
            }).catch(function(err) {
                btn.disabled = false;
                btnText.textContent = 'Send Message';
                spinner.style.display = 'none';
                statusEl.className = 'contact-status contact-status-error';
                statusEl.innerHTML = '&#10007; Something went wrong. Please try again.';
                statusEl.style.display = 'block';
                console.error('Contact form error:', err);
                setTimeout(function() { statusEl.style.display = 'none'; }, 5000);
            });
        }

        // ══════════════════════════════════════════════════════════════
        // SETTINGS FUNCTIONS
        // ══════════════════════════════════════════════════════════════

        function switchSettingsTab(tab, el) {
            document.querySelectorAll('.sett-nav').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.sett-panel').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            const panel = document.getElementById('settingsPanel-' + tab);
            if (panel) panel.classList.add('active');
        }

        function selectExchangePill(el, exchange) {
            document.querySelectorAll('.sett-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('settApiExchange').value = exchange;
        }

        function togglePaperWarning(cb) {
            document.getElementById('paperTradingWarn').style.display = cb.checked ? 'flex' : 'none';
        }

        function toggleKillSwitch(cb) {
            const row = document.getElementById('killSwitchRow');
            if (cb.checked) {
                row.classList.add('active');
                showToast('Kill Switch ACTIVATED — all trading halted', 'error');
            } else {
                row.classList.remove('active');
                showToast('Kill Switch deactivated', 'info');
            }
        }

        function exportTradeData() {
            showToast('Preparing CSV export...', 'info');
            // Simulate export
            setTimeout(() => {
                const csv = 'Date,Pair,Side,Price,Amount,PnL\n2025-01-15,BTC/USDT,LONG,96500,0.1,+245.00\n';
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'nexypher_trades.csv'; a.click();
                URL.revokeObjectURL(url);
                showToast('Trade history exported!', 'success');
            }, 800);
        }

        async function loadSettings() {
            // Load local settings (theme, accent)
            const saved = JSON.parse(localStorage.getItem('nexypher_settings') || '{}');
            if (saved.theme) { document.getElementById('settTheme').value = saved.theme; }
            const accent = saved.accent || '#6c63ff';
            document.querySelectorAll('.sett-swatch').forEach(s => {
                const bg = rgbToHex(s.style.backgroundColor);
                s.classList.toggle('active', bg === accent);
            });
            loadApiKeysDisplay();

            // Load backend preferences if logged in
            if (currentUser) {
                try {
                    const prefs = await api('/api/user/preferences');
                    if (prefs.dark_mode !== undefined) {
                        document.getElementById('settTheme').value = prefs.dark_mode ? 'dark' : 'light';
                    }
                    document.getElementById('settPriceAlerts').checked = prefs.notification_email !== false;
                    document.getElementById('settAIAlerts').checked = prefs.notification_push !== false;
                    document.getElementById('settTradeAlerts').checked = prefs.notification_email !== false;
                } catch (e) {
                    console.warn('Could not load backend preferences:', e.message);
                }
            }
        }

        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            const m = rgb.match(/\d+/g);
            if (!m) return rgb;
            return '#' + m.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme === 'light') {
                root.style.setProperty('--bg-primary', '#f5f5f7');
                root.style.setProperty('--bg-secondary', '#ffffff');
                root.style.setProperty('--bg-card', '#ffffff');
                root.style.setProperty('--text-primary', '#1a1a2e');
                root.style.setProperty('--text-secondary', '#4a4a5a');
                root.style.setProperty('--text-muted', '#7a7a8a');
                root.style.setProperty('--border', '#e0e0e5');
            } else if (theme === 'midnight') {
                root.style.setProperty('--bg-primary', '#0a0a14');
                root.style.setProperty('--bg-secondary', '#0f0f1e');
                root.style.setProperty('--bg-card', '#111128');
                root.style.setProperty('--text-primary', '#e8e8f0');
                root.style.setProperty('--text-secondary', '#a0a0b8');
                root.style.setProperty('--text-muted', '#6a6a82');
                root.style.setProperty('--border', '#1e1e3a');
            } else {
                // dark (default) - reset to original
                root.style.setProperty('--bg-primary', '#0f1117');
                root.style.setProperty('--bg-secondary', '#1a1d27');
                root.style.setProperty('--bg-card', '#1e2230');
                root.style.setProperty('--text-primary', '#e8e8f0');
                root.style.setProperty('--text-secondary', '#a0a4b8');
                root.style.setProperty('--text-muted', '#6b7080');
                root.style.setProperty('--border', '#2a2e3e');
            }
        }

        function setAccent(el, color) {
            document.documentElement.style.setProperty('--primary', color);
            document.querySelectorAll('.sett-swatch').forEach(s => {
                s.classList.remove('active');
            });
            el.classList.add('active');
        }

        async function saveSettings() {
            const theme = document.getElementById('settTheme').value;
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();

            // Save visual settings to localStorage
            const localSettings = { theme, accent: accentColor };
            localStorage.setItem('nexypher_settings', JSON.stringify(localSettings));
            applyTheme(theme);

            // Save preferences to backend if logged in
            if (currentUser) {
                try {
                    await api('/api/user/preferences', {
                        method: 'PUT',
                        body: JSON.stringify({
                            dark_mode: theme !== 'light',
                            notification_email: document.getElementById('settPriceAlerts').checked,
                            notification_push: document.getElementById('settAIAlerts').checked,
                        }),
                    });
                    showToast('Settings saved to your account!', 'success');
                } catch (e) {
                    console.warn('Backend save failed:', e.message);
                    showToast('Settings saved locally (login to sync)', 'info');
                }
            } else {
                showToast('Settings saved locally (login to sync)', 'info');
            }
        }

        async function resetSettings() {
            localStorage.removeItem('nexypher_settings');
            applyTheme('dark');
            document.documentElement.style.setProperty('--primary', '#6c63ff');
            if (currentUser) {
                try {
                    await api('/api/user/preferences', {
                        method: 'PUT',
                        body: JSON.stringify({
                            dark_mode: true,
                            notification_email: true,
                            notification_push: true,
                        }),
                    });
                } catch (e) { console.warn('Backend reset failed:', e.message); }
            }
            loadSettings();
            showToast('Settings reset to defaults', 'info');
        }

        function saveApiKey() {
            const exchange = document.getElementById('settApiExchange').value;
            const key = document.getElementById('settApiKey').value.trim();
            const secret = document.getElementById('settApiSecret').value.trim();
            if (!key || !secret) { showToast('Enter both API Key and Secret', 'error'); return; }
            const keys = JSON.parse(localStorage.getItem('nexypher_api_keys') || '[]');
            const existing = keys.findIndex(k => k.exchange === exchange);
            const entry = { exchange, key: key.slice(0, 6) + '...' + key.slice(-4), added: new Date().toISOString() };
            if (existing >= 0) keys[existing] = entry; else keys.push(entry);
            localStorage.setItem('nexypher_api_keys', JSON.stringify(keys));
            document.getElementById('settApiKey').value = '';
            document.getElementById('settApiSecret').value = '';
            loadApiKeysDisplay();
            showToast(`${exchange} API key saved`, 'success');
        }

        function loadApiKeysDisplay() {
            const keys = JSON.parse(localStorage.getItem('nexypher_api_keys') || '[]');
            const container = document.getElementById('settApiKeysList');
            if (!keys.length) { container.innerHTML = '<div style="color:#555a6a;font-size:12px">No API keys connected yet</div>'; return; }
            container.innerHTML = keys.map(k => `
        <div class="sett-api-key-row">
            <span><strong>${k.exchange}</strong> — ${k.key}</span>
            <button onclick="removeApiKey('${k.exchange}')" title="Remove">&#128465;</button>
        </div>
    `).join('');
        }

        function removeApiKey(exchange) {
            let keys = JSON.parse(localStorage.getItem('nexypher_api_keys') || '[]');
            keys = keys.filter(k => k.exchange !== exchange);
            localStorage.setItem('nexypher_api_keys', JSON.stringify(keys));
            loadApiKeysDisplay();
            showToast(`${exchange} API key removed`, 'info');
        }

        // Apply saved settings on page load
        (function initSettings() {
            const saved = JSON.parse(localStorage.getItem('nexypher_settings') || '{}');
            if (saved.theme) applyTheme(saved.theme);
            if (saved.accent) document.documentElement.style.setProperty('--primary', saved.accent);
            else document.documentElement.style.setProperty('--primary', '#6c63ff');
        })();

        // ══════════════════════════════════════════════════════════════
        // STRATEGY BUILDER FUNCTIONS (Crypto-Native)
        // ══════════════════════════════════════════════════════════════

        function switchTraderTab(tab) {
            document.querySelectorAll('.trader-subtab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.trader-subpage').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('traderSub-' + tab)?.classList.add('active');
            if (tab === 'strategies') sbLoadStrategies();
        }

        // ── Generic pill picker ──
        function sbPickPill(el, groupName) {
            const parent = el.closest('.sb-pills') || el.parentElement;
            parent.querySelectorAll('.sb-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            const radio = el.querySelector('input[type=radio]');
            if (radio) radio.checked = true;
        }

        // ── Exchange picker ──
        function sbPickExchange(el) {
            document.querySelectorAll('.sb-exchange-opt').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        // ── Market type toggle (show/hide futures config) ──
        function sbMarketChanged() {
            const mkt = document.querySelector('input[name="sbMkt"]:checked')?.value;
            const fc = document.getElementById('sbFuturesConfig');
            if (fc) fc.style.display = mkt === 'futures' ? 'block' : 'none';
        }

        // ── Leverage ──
        function sbLeverageChanged() {
            const val = document.getElementById('sbLeverage').value;
            document.getElementById('sbLevVal').textContent = val + 'x';
            // Update preset highlights
            document.querySelectorAll('.sb-leverage-presets button').forEach(b => {
                b.classList.toggle('active', b.textContent === val + 'x');
            });
            // Estimated liquidation
            const posSize = parseFloat(document.getElementById('sbPosSize')?.value) || 100;
            const liqDist = (100 / val).toFixed(1);
            document.getElementById('sbLiqPrice').textContent =
                `Est. Liquidation: ~${liqDist}% from entry (${val}x leverage on $${posSize})`;
        }

        function sbSetLev(val) {
            document.getElementById('sbLeverage').value = val;
            sbLeverageChanged();
        }

        // ── Template hints ──
        const SB_TEMPLATE_HINTS = {
            custom: 'Build your own custom trading strategy from scratch',
            grid: 'Place buy/sell orders at set intervals — works great in ranging markets',
            dca: 'Dollar-cost average into positions at regular intervals or on dips',
            momentum: 'Follow strong trends using RSI, MACD and volume breakouts',
            mean_reversion: 'Trade price bounces back to mean using Bollinger Bands',
            scalping: 'Quick in/out trades on 1m–5m charts with tight stops',
            swing: 'Multi-day positions based on 4h/1D chart patterns',
            funding_farm: 'Earn funding fees by longing when funding is negative',
            breakout: 'Enter on price breakouts above resistance with volume confirmation',
        };
        function sbTemplateChanged() {
            const t = document.getElementById('sbStratType').value;
            document.getElementById('sbTemplateHint').textContent = SB_TEMPLATE_HINTS[t] || '';
        }

        // ── Indicator toggle ──
        function sbToggleIndicator(el) {
            el.classList.toggle('active');
        }

        // ── Add entry/exit condition ──
        function sbAddCondition(type) {
            const container = document.getElementById(type === 'entry' ? 'sbEntryConditions' : 'sbExitConditions');
            const action = type === 'entry' ? '→ BUY' : '→ SELL';
            const html = `<div class="sb-condition">
        <select><option>RSI</option><option>MACD</option><option>EMA</option><option>Volume</option><option>Funding Rate</option><option>Price</option><option>BTC Dom</option><option>Fear & Greed</option>${type === 'exit' ? '<option>Time</option>' : ''}</select>
        <select><option>crosses above</option><option>crosses below</option><option>is above</option><option>is below</option><option>increases by</option><option>decreases by</option></select>
        <input type="number" value="" style="width:60px" placeholder="val">
        <span style="color:var(--text-muted)">${action}</span>
        <button class="sb-cond-remove" onclick="this.closest('.sb-condition').remove()">×</button>
    </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        // ── Instrument Management ──
        function sbToggleInstrDD() {
            const dd = document.getElementById('sbInstrDD');
            dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
        }

        function sbSelectInstr(el) {
            const pair = el.getAttribute('data-pair');
            const chips = document.getElementById('sbInstrumentChips');
            if (chips.querySelector(`[data-pair="${pair}"]`)) return;
            const chip = document.createElement('span');
            chip.className = 'sb-pill active';
            chip.setAttribute('data-pair', pair);
            chip.innerHTML = `${pair} <button onclick="sbRemoveInstr(this)" style="background:none;border:none;color:inherit;cursor:pointer;margin-left:4px;font-size:14px">&times;</button>`;
            chips.insertBefore(chip, document.getElementById('sbAddInstrBtn'));
            el.style.opacity = '0.4';
        }

        function sbRemoveInstr(btn) {
            const chip = btn.parentElement;
            const pair = chip.getAttribute('data-pair');
            chip.remove();
            const item = document.querySelector(`#sbInstrList [data-pair="${pair}"]`);
            if (item) item.style.opacity = '1';
        }

        function sbFilterInstr(q) {
            q = q.toLowerCase();
            document.querySelectorAll('#sbInstrList .sb-instr-item').forEach(i => {
                i.style.display = i.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        // ── Qty helper ──
        function sbQty(btn, delta) {
            const inp = btn.parentElement.querySelector('input');
            inp.value = Math.max(0, (parseFloat(inp.value) || 0) + delta);
        }

        // ── Save Strategy (crypto-native) ──
        async function sbSaveStrategy() {
            if (!currentUser) { showAuthModal('login'); return; }
            const name = document.getElementById('sbStratName').value.trim();
            if (!name) { showToast('Enter a strategy name', 'error'); return; }

            // Collect instruments
            const instrChips = document.querySelectorAll('#sbInstrumentChips .sb-pill[data-pair]');
            const instruments = Array.from(instrChips).map(c => c.getAttribute('data-pair'));

            // Strategy type & template
            const strategyType = document.getElementById('sbStratType').value;
            const timeframe = document.querySelector('input[name="sbTf"]:checked')?.value || '15m';

            // Exchange & market
            const exchange = document.querySelector('.sb-exchange-opt.active')?.getAttribute('data-exchange') || 'binance';
            const marketType = document.querySelector('input[name="sbMkt"]:checked')?.value || 'spot';
            const orderType = document.querySelector('input[name="sbOrder"]:checked')?.value || 'market';
            const stablecoinBase = document.querySelector('input[name="sbBase"]:checked')?.value || 'USDT';

            // Position config
            const positionSide = document.querySelector('input[name="sbSide"]:checked')?.value || 'long';
            const positionSize = parseFloat(document.getElementById('sbPosSize')?.value) || 100;
            const leverage = parseInt(document.getElementById('sbLeverage')?.value) || 1;
            const marginMode = document.querySelector('input[name="sbMargin"]:checked')?.value || 'isolated';

            // Entry indicators
            const activeIndicators = Array.from(document.querySelectorAll('.sb-indicator.active')).map(i => i.getAttribute('data-ind'));

            // Entry/exit conditions
            const entryConditions = [];
            document.querySelectorAll('#sbEntryConditions .sb-condition').forEach(c => {
                const sels = c.querySelectorAll('select');
                const inp = c.querySelector('input');
                entryConditions.push({
                    indicator: sels[0]?.value, operator: sels[1]?.value,
                    value: parseFloat(inp?.value) || 0
                });
            });
            const exitConditions = [];
            document.querySelectorAll('#sbExitConditions .sb-condition').forEach(c => {
                const sels = c.querySelectorAll('select');
                const inp = c.querySelector('input');
                exitConditions.push({
                    indicator: sels[0]?.value, operator: sels[1]?.value,
                    value: parseFloat(inp?.value) || 0
                });
            });

            // SL/TP
            const slMethod = document.querySelector('input[name="sbSL"]:checked')?.value || 'percent';
            const slVal = parseFloat(document.getElementById('sbSLVal')?.value) || 3;
            const tpVal = parseFloat(document.getElementById('sbTPVal')?.value) || 6;
            const trailVal = parseFloat(document.getElementById('sbTrailVal')?.value) || 1;

            // Risk management
            const riskConfig = {
                max_drawdown: parseFloat(document.getElementById('sbMaxDD')?.value) || 10,
                daily_loss_limit: parseFloat(document.getElementById('sbDailyLoss')?.value) || 5,
                max_open_positions: parseInt(document.getElementById('sbMaxPos')?.value) || 3,
                max_position_size_pct: parseFloat(document.getElementById('sbMaxPosSize')?.value) || 25,
                max_daily_trades: parseInt(document.getElementById('sbMaxTrades')?.value) || 10,
                cooldown_min: parseInt(document.getElementById('sbCooldown')?.value) || 5,
                volatility_filter: document.getElementById('sbVolFilter')?.checked || false,
                volatility_threshold: parseFloat(document.getElementById('sbVolThreshold')?.value) || 5,
            };

            // Kill switches
            const killSwitches = {
                flash_crash: document.getElementById('sbKillFlash')?.checked || false,
                flash_crash_pct: parseFloat(document.getElementById('sbKillFlashVal')?.value) || 15,
                circuit_breaker: document.getElementById('sbKillCircuit')?.checked || false,
                circuit_breaker_pct: parseFloat(document.getElementById('sbKillCircuitVal')?.value) || 10,
                stablecoin_depeg: document.getElementById('sbKillDepeg')?.checked || false,
                depeg_threshold: parseFloat(document.getElementById('sbKillDepegVal')?.value) || 0.98,
            };

            // Schedule
            const sessions = Array.from(document.querySelectorAll('.sb-session.active')).map(s => s.querySelector('.sb-session-name')?.textContent?.trim());
            const activeDays = Array.from(document.querySelectorAll('.sb-day.active')).map((d, i) => ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'][i]);
            const regimes = Array.from(document.querySelectorAll('.sb-regime.active')).map(r => r.getAttribute('data-regime'));
            const sleepEnabled = document.getElementById('sbSleepEnabled')?.checked || false;
            const sleepFrom = document.getElementById('sbSleepFrom')?.value || '';
            const sleepTo = document.getElementById('sbSleepTo')?.value || '';

            // Cycle awareness
            const cycleConfig = {
                halving: document.getElementById('sbHalving')?.checked || false,
                alt_season: document.getElementById('sbAltSeason')?.checked || false,
                fear_greed_filter: document.getElementById('sbFearGreed')?.checked || false,
                btc_correlation: document.getElementById('sbBtcCorr')?.checked || false,
            };

            // Advanced features
            const advancedConfig = {
                dca: document.getElementById('sbDCA')?.checked || false,
                martingale: document.getElementById('sbMartingale')?.checked || false,
                grid_mode: document.getElementById('sbGridMode')?.checked || false,
                funding_farm: document.getElementById('sbFundingFarm')?.checked || false,
                pairs_hedge: document.getElementById('sbPairsHedge')?.checked || false,
                btc_dom_rotate: document.getElementById('sbBtcDomRotate')?.checked || false,
                auto_deleverage: document.getElementById('sbAutoDeleverage')?.checked || false,
                slippage_model: document.getElementById('sbSlippageModel')?.checked || false,
                move_sl_to_cost: document.getElementById('sbMoveSlCost')?.checked || false,
                re_entry: document.getElementById('sbReEntry')?.checked || false,
            };

            // Build legs array (single leg from position config)
            const legs = [{
                leg_number: 1,
                position: positionSide,
                market_type: marketType,
                leverage: leverage,
                margin_mode: marginMode,
                qty: positionSize,
                sl_method: slMethod,
                stop_loss: slVal,
                take_profit: tpVal,
                trail_distance: trailVal,
                entry_conditions: entryConditions,
                exit_conditions: exitConditions,
                indicators: activeIndicators,
            }];

            const body = {
                name,
                description: SB_TEMPLATE_HINTS[strategyType] || '',
                instruments,
                legs,
                strategy_type: strategyType,
                order_type: orderType,
                risk_config: { ...riskConfig, kill_switches: killSwitches, sessions, active_days: activeDays, market_regimes: regimes, sleep: { enabled: sleepEnabled, from: sleepFrom, to: sleepTo }, cycle: cycleConfig },
                advanced_config: { ...advancedConfig, exchange, stablecoin_base: stablecoinBase, timeframe },
            };

            try {
                const res = await fetch(API + '/api/algo/strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify(body),
                });
                if (!res.ok) { const err = await res.json().catch(() => ({})); showToast(err.detail || 'Failed to save', 'error'); return; }
                showToast(`Strategy "${name}" saved!`, 'success');
                document.getElementById('sbStratName').value = '';
                // Switch to My Strategies tab
                document.querySelectorAll('.trader-subtab').forEach(t => t.classList.toggle('active', t.textContent.includes('My Strategies')));
                document.querySelectorAll('.trader-subpage').forEach(p => p.classList.remove('active'));
                document.getElementById('traderSub-strategies')?.classList.add('active');
                sbLoadStrategies();
            } catch (e) { console.error(e); showToast('Failed to save strategy', 'error'); }
        }

        async function sbDeployStrategy() {
            showToast('Save your strategy first, then deploy from My Strategies', 'info');
        }

        // ── Load & Manage Strategies ──
        async function sbLoadStrategies() {
            if (!currentUser) return;
            try {
                const res = await fetch(API + '/api/algo/strategies', {
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (!res.ok) return;
                const strategies = await res.json();
                const container = document.getElementById('sbStrategiesList');
                if (!strategies.length) {
                    container.innerHTML = '<div class="empty-state"><p>No strategies yet. Create one in the Strategy Builder.</p></div>';
                    return;
                }
                container.innerHTML = strategies.map(s => {
                    const legsArr = typeof s.legs === 'string' ? JSON.parse(s.legs || '[]') : (s.legs || []);
                    const advConfig = typeof s.advanced_config === 'string' ? JSON.parse(s.advanced_config || '{}') : (s.advanced_config || {});
                    return `
            <div class="strat-card">
                <div class="strat-info">
                    <div class="strat-name">${s.name}</div>
                    <div class="strat-meta">
                        ${advConfig.exchange ? advConfig.exchange.toUpperCase() + ' · ' : ''}
                        ${s.instruments || ''} · ${s.strategy_type || 'custom'} · ${advConfig.timeframe || '15m'}
                        ${legsArr[0]?.leverage > 1 ? ' · ' + legsArr[0].leverage + 'x' : ''}
                    </div>
                </div>
                <div class="strat-actions">
                    <span class="strat-status-badge ${s.status === 'active' ? 'active' : 'paused'}">${s.status || 'draft'}</span>
                    <button class="btn btn-sm btn-outline" onclick="sbToggleStrat(${s.id},'${s.status}')">${s.status === 'active' ? '⏸ Pause' : '▶ Activate'}</button>
                    <button class="btn btn-sm btn-danger" onclick="sbDeleteStrat(${s.id})">🗑</button>
                </div>
            </div>`;
                }).join('');
            } catch (e) { console.error(e); }
        }

        async function sbToggleStrat(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'paused' : 'active';
            try {
                await fetch(API + '/api/algo/strategies/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ status: newStatus }),
                });
                showToast(`Strategy ${newStatus}`, 'success');
                sbLoadStrategies();
            } catch (e) { showToast('Failed to update', 'error'); }
        }

        async function sbDeleteStrat(id) {
            if (!confirm('Delete this strategy?')) return;
            try {
                await fetch(API + '/api/algo/strategies/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                showToast('Strategy deleted', 'info');
                sbLoadStrategies();
            } catch (e) { showToast('Failed to delete', 'error'); }
        }

        // Close dropdowns on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('#sbInstrDD') && !e.target.closest('#sbAddInstrBtn')) {
                const dd = document.getElementById('sbInstrDD');
                if (dd) dd.style.display = 'none';
            }
        });

        // ── Init ──────────────────────────────────────────────────────
        checkAuth();
        loadMarket();

        // Keyboard shortcut
        document.addEventListener('keydown', e => {
            if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                document.getElementById('globalSearch').focus();
            }
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
        });

        // ══════════════════════════════════════════════════════════════
        // NEXYPHER WEB INSIGHT BOT
        // ══════════════════════════════════════════════════════════════

        const BOT_SUGGESTIONS = [
            "How is the crypto market today?",
            "Analyze Bitcoin right now",
            "What's trending in crypto?",
            "Should I look at Solana?",
            "ETH price analysis",
            "Top gainers today",
        ];

        function toggleBotWindow() {
            const win = document.getElementById('botWindow');
            const isOpen = win.classList.contains('open');
            if (isOpen) {
                win.classList.remove('open');
            } else {
                if (!currentUser) { showAuthModal('login'); return; }
                win.classList.add('open');
                const msgs = document.getElementById('botMessages');
                if (msgs.children.length === 0) {
                    appendBotMessage(
                        "Hey! 👋 I'm **NexYpher Bot** — your crypto intelligence assistant.\n\n" +
                        "I fetch **live data** from CoinGecko, DexScreener & news to answer your questions. Try asking about any coin, market trends, or trading insights!",
                        []
                    );
                    renderBotSuggestions();
                }
                setTimeout(() => document.getElementById('botInput').focus(), 100);
            }
        }

        function renderBotSuggestions() {
            const el = document.getElementById('botSuggestions');
            el.innerHTML = BOT_SUGGESTIONS.map(s =>
                `<div class="bot-chip" onclick="askBotFromChip(this)">${s}</div>`
            ).join('');
        }

        function askBotFromChip(chip) {
            const q = chip.textContent;
            document.getElementById('botInput').value = q;
            document.getElementById('botSuggestions').innerHTML = '';
            sendBotMessage();
        }

        function appendUserMessage(text) {
            const msgs = document.getElementById('botMessages');
            const div = document.createElement('div');
            div.className = 'bot-msg user';
            div.textContent = text;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function appendBotMessage(text, sources, mode) {
            const msgs = document.getElementById('botMessages');
            const div = document.createElement('div');
            div.className = 'bot-msg bot';

            // ── Rich Markdown → HTML Renderer ──
            let html = '';
            const blocks = text.split('\n');
            let inTable = false;
            let tableRows = [];

            function flushTable() {
                if (!tableRows.length) return '';
                // tableRows[0] = header, tableRows[1] = separator, rest = body
                let t = '<table><thead><tr>';
                const headers = tableRows[0].split('|').map(c => c.trim()).filter(Boolean);
                headers.forEach(h => { t += `<th>${formatInline(h)}</th>`; });
                t += '</tr></thead><tbody>';
                for (let i = 2; i < tableRows.length; i++) {
                    const cells = tableRows[i].split('|').map(c => c.trim()).filter(Boolean);
                    t += '<tr>';
                    cells.forEach(c => { t += `<td>${formatInline(c)}</td>`; });
                    t += '</tr>';
                }
                t += '</tbody></table>';
                tableRows = [];
                return t;
            }

            function formatInline(s) {
                return s
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    // Color price changes: 🟢 +X% green, 🔴 -X% red
                    .replace(/🟢\s*([+\-]?[\d.]+%)/g, '<span class="price-up">▲ $1</span>')
                    .replace(/🔴\s*([+\-]?[\d.]+%)/g, '<span class="price-down">▼ $1</span>');
            }

            for (let i = 0; i < blocks.length; i++) {
                const line = blocks[i];

                // Table row detection
                if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
                    if (!inTable) inTable = true;
                    tableRows.push(line.trim());
                    continue;
                } else if (inTable) {
                    html += flushTable();
                    inTable = false;
                }

                // Horizontal rule
                if (line.trim() === '---') {
                    html += '<hr>';
                    continue;
                }

                // H3 headers
                if (line.trim().startsWith('### ')) {
                    const hText = line.trim().slice(4);
                    html += `<h3>${formatInline(hText)}</h3>`;
                    continue;
                }

                // Empty line
                if (!line.trim()) {
                    continue;
                }

                // Bullet points
                if (/^[•\-]\s/.test(line.trim())) {
                    html += `<div style="padding:2px 0 2px 6px;">${formatInline(line.trim())}</div>`;
                    continue;
                }

                // Regular paragraph
                html += `<div style="padding:2px 0;">${formatInline(line)}</div>`;
            }

            // Flush any remaining table
            if (inTable) html += flushTable();

            // Mode badge
            if (mode === 'data') {
                html += '<div style="margin-top:10px;"><span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;background:rgba(245,158,11,0.12);color:#f59e0b;border:1px solid rgba(245,158,11,0.25);letter-spacing:0.3px;">📊 Live Data Mode</span></div>';
            } else if (mode === 'ai') {
                html += '<div style="margin-top:10px;"><span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;background:rgba(124,92,255,0.12);color:#7c5cff;border:1px solid rgba(124,92,255,0.25);letter-spacing:0.3px;">🤖 AI + Live Data</span></div>';
            }

            if (sources && sources.length) {
                html += '<div class="bot-sources">📡 Sources: ' +
                    sources.map(s => s.replace(/^[📊📈🔥📰🔗]\s?/, '')).slice(0, 3).join(' · ') +
                    '</div>';
            }
            div.innerHTML = html;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function showBotTyping(show) {
            const el = document.getElementById('botTyping');
            el.classList.toggle('show', show);
            if (show) {
                const msgs = document.getElementById('botMessages');
                msgs.scrollTop = msgs.scrollHeight;
            }
        }

        async function sendBotMessage() {
            const input = document.getElementById('botInput');
            const btn = document.getElementById('botSendBtn');
            const question = input.value.trim();
            if (!question || !currentUser) return;

            input.value = '';
            btn.disabled = true;
            document.getElementById('botSuggestions').innerHTML = '';

            appendUserMessage(question);
            showBotTyping(true);

            try {
                const data = await api('/api/bot/ask', {
                    method: 'POST',
                    body: JSON.stringify({ question }),
                });
                showBotTyping(false);
                appendBotMessage(data.answer, data.sources || [], data.mode);
            } catch (e) {
                showBotTyping(false);
                appendBotMessage('❌ ' + (e.message || 'Something went wrong. Please try again.'), []);
            } finally {
                btn.disabled = false;
                input.focus();
            }
        }

    </script>

    <!-- NexYpher Bot Widget -->
    <button class="bot-fab has-dot" onclick="toggleBotWindow()" title="NexYpher Bot">🤖</button>
    <div class="bot-window" id="botWindow">
        <div class="bot-header">
            <div class="bot-header-icon">🤖</div>
            <div class="bot-header-info">
                <h3>NexYpher Bot</h3>
                <p>● Online — Live Web Insights</p>
            </div>
            <button class="bot-close" onclick="toggleBotWindow()">✕</button>
        </div>
        <div class="bot-messages" id="botMessages">
        </div>
        <div class="bot-typing" id="botTyping">
            <span></span><span></span><span></span>
        </div>
        <div class="bot-suggestions" id="botSuggestions"></div>
        <div class="bot-input-area">
            <input type="text" id="botInput" placeholder="Ask about any crypto..." autocomplete="off"
                onkeydown="if(event.key==='Enter')sendBotMessage()">
            <button class="bot-send" id="botSendBtn" onclick="sendBotMessage()">➤</button>
        </div>
    </div>

    <!-- ═══ P&L HEATMAP MODAL ═══ -->
    <div class="hm-overlay" id="hmOverlay" onclick="closePnlHeatmap(event)">
        <div class="hm-modal" onclick="event.stopPropagation()">
            <div class="hm-header">
                <div>
                    <div class="hm-title" id="hmTitle">Paper Trading P&amp;L Heatmap <span class="badge-paper">PAPER</span></div>
                    <div class="hm-subtitle" id="hmSubtitle">Your simulated profit &amp; loss activity over the past year</div>
                </div>
                <button class="hm-close" onclick="closePnlHeatmap()">&times;</button>
            </div>
            <div class="hm-view-toggle" id="hmViewToggle">
                <button class="hm-view-btn active" data-view="paper" onclick="window._hmSwitchView('paper')">Paper Trading</button>
                <button class="hm-view-btn" data-view="real" onclick="window._hmSwitchView('real')">Real Wallet</button>
            </div>
            <div class="hm-stats" id="hmStats"></div>
            <div class="hm-year-tabs" id="hmYearTabs"></div>
            <div class="hm-grid-wrap" id="hmGridWrap"></div>
            <div class="hm-legend" id="hmLegend">
                <span class="hm-legend-label">Loss</span>
                <span class="hm-legend-sq" style="background:rgba(255,71,87,0.15)"></span>
                <span class="hm-legend-sq" style="background:rgba(255,71,87,0.35)"></span>
                <span class="hm-legend-sq" style="background:rgba(255,71,87,0.55)"></span>
                <span class="hm-legend-sq" style="background:rgba(255,71,87,0.75)"></span>
                <span class="hm-legend-sq" style="background:#ff4757"></span>
                <span class="hm-legend-gap"></span>
                <span class="hm-legend-sq" style="background:rgba(0,211,149,0.15)"></span>
                <span class="hm-legend-sq" style="background:rgba(0,211,149,0.35)"></span>
                <span class="hm-legend-sq" style="background:rgba(0,211,149,0.55)"></span>
                <span class="hm-legend-sq" style="background:rgba(0,211,149,0.75)"></span>
                <span class="hm-legend-sq" style="background:#00d395"></span>
                <span class="hm-legend-label">Profit</span>
            </div>
        </div>
    </div>
    <div class="hm-tooltip" id="hmTooltip" style="display:none"></div>

    <script>
    // ══════════════════════════════════════════════════════════════
    // P&L HEATMAP — Pure JS + CSS Grid
    // ══════════════════════════════════════════════════════════════
    (function() {
        let hmData = {};
        let hmYear = new Date().getFullYear();
        let pinnedCell = null;
        const DAY_LABELS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const MONTH_LABELS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const MONTH_SHORT = ['J','F','M','A','M','J','J','A','S','O','N','D'];

        function pnlColor(val) {
            if (val === null || val === undefined) return 'rgba(255,255,255,0.05)';
            const a = Math.abs(val);
            if (val >= 0) {
                if (a === 0) return 'rgba(255,255,255,0.05)';
                if (a <= 100) return 'rgba(0,211,149,0.25)';
                if (a <= 500) return 'rgba(0,211,149,0.5)';
                if (a <= 1000) return 'rgba(0,211,149,0.75)';
                return '#00d395';
            } else {
                if (a <= 100) return 'rgba(255,71,87,0.25)';
                if (a <= 500) return 'rgba(255,71,87,0.5)';
                if (a <= 1000) return 'rgba(255,71,87,0.75)';
                return '#ff4757';
            }
        }
        function pnlShadow(val) {
            if (val === null || val === undefined) return '';
            const a = Math.abs(val);
            if (a > 1000) {
                return val >= 0 ? '0 0 6px rgba(0,211,149,0.4)' : '0 0 6px rgba(255,71,87,0.4)';
            }
            return '';
        }

        function formatPnl(v) {
            if (v === null || v === undefined) return '$0.00';
            const sign = v >= 0 ? '+' : '-';
            return sign + '$' + Math.abs(v).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
        }

        function dateFmt(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return days[d.getDay()] + ', ' + months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
        }

        function getWeeksForYear(year) {
            const jan1 = new Date(year, 0, 1);
            const dec31 = new Date(year, 11, 31);
            // Start from the Monday of the week containing Jan 1
            let startDay = jan1.getDay(); // 0=Sun
            let mondayOffset = startDay === 0 ? -6 : 1 - startDay;
            const gridStart = new Date(year, 0, 1 + mondayOffset);
            const cells = [];
            const current = new Date(gridStart);
            // Generate cells until we pass Dec 31
            while (current <= dec31 || cells.length % 7 !== 0) {
                const iso = current.toISOString().slice(0, 10);
                const inYear = current.getFullYear() === year;
                cells.push({ date: iso, inYear, dayOfWeek: current.getDay(), month: current.getMonth(), jsDate: new Date(current) });
                current.setDate(current.getDate() + 1);
                if (cells.length > 380) break; // safety
            }
            return cells;
        }

        function renderStats(data) {
            let profitDays = 0, lossDays = 0, best = 0, worst = 0;
            for (const d of data) {
                if (d.pnl > 0) { profitDays++; if (d.pnl > best) best = d.pnl; }
                if (d.pnl < 0) { lossDays++; if (d.pnl < worst) worst = d.pnl; }
            }
            document.getElementById('hmStats').innerHTML = `
                <div class="hm-stat"><div class="hm-stat-label">Total Profit Days</div><div class="hm-stat-value" style="color:#00d395">${profitDays}</div></div>
                <div class="hm-stat"><div class="hm-stat-label">Total Loss Days</div><div class="hm-stat-value" style="color:#ff4757">${lossDays}</div></div>
                <div class="hm-stat"><div class="hm-stat-label">Best Day</div><div class="hm-stat-value" style="color:#00d395">${formatPnl(best)}</div></div>
                <div class="hm-stat"><div class="hm-stat-label">Worst Day</div><div class="hm-stat-value" style="color:#ff4757">${formatPnl(worst)}</div></div>
            `;
        }

        function renderYearTabs() {
            const years = [2024, 2025, 2026];
            document.getElementById('hmYearTabs').innerHTML = years.map(y =>
                `<button class="hm-year-btn${y === hmYear ? ' active' : ''}" onclick="window._hmSelectYear(${y})">${y}</button>`
            ).join('');
        }

        function renderGrid(data) {
            const lookup = {};
            for (const d of data) lookup[d.date] = d;
            const cells = getWeeksForYear(hmYear);

            if (!data.length) {
                document.getElementById('hmGridWrap').innerHTML = '<div class="hm-empty">No trading data yet — start trading to see your P&amp;L heatmap</div>';
                return;
            }

            // Re-order cells: Mon=0 ... Sun=6
            // JS getDay: 0=Sun,1=Mon...6=Sat → we want Mon=0,Tue=1,...Sun=6
            function weekRow(jsDay) { return jsDay === 0 ? 6 : jsDay - 1; }

            // Compute month label positions
            const numWeeks = Math.ceil(cells.length / 7);
            const monthStarts = [];
            let lastMonth = -1;
            for (let i = 0; i < cells.length; i++) {
                const c = cells[i];
                if (c.inYear && c.month !== lastMonth) {
                    const weekIdx = Math.floor(i / 7);
                    monthStarts.push({ month: c.month, week: weekIdx });
                    lastMonth = c.month;
                }
            }

            const isMobile = window.innerWidth < 640;
            const mLabels = isMobile ? MONTH_SHORT : MONTH_LABELS;

            // Build month labels row
            let monthRow = '<div class="hm-month-row" style="grid-template-columns: 28px repeat(' + numWeeks + ', 1fr)">';
            monthRow += '<div></div>'; // spacer for day labels
            let mIdx = 0;
            for (let w = 0; w < numWeeks; w++) {
                if (mIdx < monthStarts.length && monthStarts[mIdx].week === w) {
                    monthRow += '<div class="hm-month-label">' + mLabels[monthStarts[mIdx].month] + '</div>';
                    mIdx++;
                } else {
                    monthRow += '<div></div>';
                }
            }
            monthRow += '</div>';

            // Build grid: 7 rows × numWeeks cols, with day labels on left
            let grid = '<div class="hm-grid" style="grid-template-columns: 28px repeat(' + numWeeks + ', 1fr)">';
            for (let row = 0; row < 7; row++) {
                // Day label: show Mon, Wed, Fri
                const showLabel = (row === 0 || row === 2 || row === 4);
                grid += '<div class="hm-day-label">' + (showLabel ? DAY_LABELS[row] : '') + '</div>';
                for (let w = 0; w < numWeeks; w++) {
                    const cellIdx = w * 7 + row;
                    if (cellIdx < cells.length) {
                        const c = cells[cellIdx];
                        // Re-map: cells are ordered Sun-Sat, but we stored them sequentially from Monday
                        // Actually we iterated day by day, so cells[0] is the start Monday
                        // We need cells by (week, dayOfWeekMon-indexed)
                        // Let me recalculate:
                        const actualIdx = w * 7 + row; // row=0 is first day of that week chunk
                        if (actualIdx < cells.length && cells[actualIdx].inYear) {
                            const cell = cells[actualIdx];
                            const d = lookup[cell.date];
                            const val = d ? d.pnl : null;
                            const bg = pnlColor(val);
                            const shadow = pnlShadow(val);
                            grid += `<div class="hm-cell" data-date="${cell.date}" data-pnl="${val !== null ? val : ''}" data-trades="${d ? d.trades : 0}" data-wr="${d ? d.win_rate : 0}" style="background:${bg};${shadow ? 'box-shadow:' + shadow : ''}" onmouseenter="window._hmShowTip(event, this)" onmouseleave="window._hmHideTip(event)" onclick="window._hmPinTip(event, this)"></div>`;
                        } else {
                            grid += '<div class="hm-cell hm-cell-outside"></div>';
                        }
                    } else {
                        grid += '<div class="hm-cell hm-cell-outside"></div>';
                    }
                }
            }
            grid += '</div>';

            document.getElementById('hmGridWrap').innerHTML = monthRow + grid;
        }

        // Tooltip
        window._hmShowTip = function(e, el) {
            if (pinnedCell) return;
            showTip(e, el);
        };
        window._hmHideTip = function(e) {
            if (pinnedCell) return;
            document.getElementById('hmTooltip').style.display = 'none';
        };
        window._hmPinTip = function(e, el) {
            e.stopPropagation();
            if (pinnedCell === el) {
                unpinTip();
                return;
            }
            if (pinnedCell) pinnedCell.style.outline = '';
            pinnedCell = el;
            el.style.outline = '2px solid rgba(255,255,255,0.4)';
            showTip(e, el, true);
        };
        function unpinTip() {
            if (pinnedCell) pinnedCell.style.outline = '';
            pinnedCell = null;
            document.getElementById('hmTooltip').style.display = 'none';
        }
        function showTip(e, el, pinned) {
            const date = el.dataset.date;
            const pnl = el.dataset.pnl;
            const trades = parseInt(el.dataset.trades) || 0;
            const wr = parseInt(el.dataset.wr) || 0;
            if (!date) return;
            const hasPnl = pnl !== '' && pnl !== undefined;
            const pnlVal = hasPnl ? parseFloat(pnl) : null;
            const pnlColor = pnlVal !== null ? (pnlVal >= 0 ? '#00d395' : '#ff4757') : 'rgba(255,255,255,0.35)';
            const tip = document.getElementById('hmTooltip');
            tip.innerHTML = `
                <div class="hm-tip-date">${dateFmt(date)}</div>
                <div class="hm-tip-pnl" style="color:${pnlColor}">\u{1F4CB} Paper P&L: ${hasPnl ? formatPnl(pnlVal) : 'No data'}</div>
                ${trades > 0 ? `<div class="hm-tip-meta">${trades} trade${trades !== 1 ? 's' : ''} (simulated)</div><div class="hm-tip-meta">Win rate: ${wr}%</div>` : ''}
                <div style="font-size:10px;color:rgba(108,99,255,0.7);margin-top:4px">Simulated trades \u2014 not real money</div>
                ${pinned ? '<button class="hm-tip-close" onclick="window._hmUnpin()">&times;</button>' : ''}
            `;
            // Position near the cell
            const rect = el.getBoundingClientRect();
            let left = rect.left + rect.width / 2;
            let top = rect.top - 8;
            tip.style.display = 'block';
            const tw = tip.offsetWidth;
            const th = tip.offsetHeight;
            left = Math.max(8, Math.min(left - tw / 2, window.innerWidth - tw - 8));
            top = top - th;
            if (top < 8) top = rect.bottom + 8;
            tip.style.left = left + 'px';
            tip.style.top = top + 'px';
        }
        window._hmUnpin = function() { unpinTip(); };

        // Year select
        window._hmSelectYear = function(y) {
            hmYear = y;
            renderYearTabs();
            loadHeatmapData();
        };
        window._hmGetYear = function() { return hmYear; };

        async function loadHeatmapData() {
            try {
                const data = await api('/api/trader/heatmap?year=' + hmYear);
                hmData = data || [];
                renderStats(hmData);
                renderGrid(hmData);
            } catch(err) {
                console.error('Heatmap load error:', err, err.message);
                document.getElementById('hmGridWrap').innerHTML = '<div class="hm-empty">Failed to load data — check console for details</div>';
                renderStats([]);
            }
        }

        // Open / Close
        window.openPnlHeatmap = function() {
            unpinTip();
            hmYear = new Date().getFullYear();
            document.getElementById('hmOverlay').classList.add('open');
            document.body.style.overflow = 'hidden';
            renderYearTabs();
            loadHeatmapData();
        };
        window.closePnlHeatmap = function(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('hmOverlay').classList.remove('open');
            document.body.style.overflow = '';
            unpinTip();
        };
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('hmOverlay').classList.contains('open')) {
                closePnlHeatmap();
            }
        });
    })();
    </script>

    <!-- Confirmation Dialog -->
    <div class="nx-confirm-overlay" id="nxConfirmOverlay">
        <div class="nx-confirm-box">
            <div class="nx-confirm-title" id="nxConfirmTitle">Remove Wallet?</div>
            <div class="nx-confirm-msg" id="nxConfirmMsg">This won't affect your actual funds.</div>
            <div class="nx-confirm-actions">
                <button class="nx-confirm-cancel" onclick="nxConfirmClose()">Cancel</button>
                <button class="nx-confirm-remove" id="nxConfirmAction" onclick="nxConfirmExec()">Remove</button>
            </div>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════
         WALLET ENGINE + PAPER/LIVE DIFFERENTIATION
         ══════════════════════════════════════════════════════════════ -->
    <script>
    (function() {
        'use strict';

        // ── State ──
        let connectedWallets = []; // from DB
        let liveWalletState = {}; // { address: { balance, usdValue, network, chainId, tokens, txs, connected } }
        let walletRefreshTimer = null;
        let _nxConfirmCb = null;

        const METAMASK_ICON = '<svg class="nx-wallet-provider-icon" viewBox="0 0 35 33" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M32.96 1l-13.14 9.72 2.45-5.73z" fill="#E2761B" stroke="#E2761B" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.66 1l13.02 9.82L13.35 4.99zM28.23 23.53l-3.5 5.36 7.49 2.06 2.15-7.3zM.64 23.65l2.13 7.3 7.49-2.06-3.5-5.36z" fill="#E4761B" stroke="#E4761B" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.93 14.51l-2.09 3.15 7.44.34-.26-8-5.09 4.51zM25.07 14.51l-5.17-4.58-.17 8.07 7.43-.34-2.09-3.15zM10.26 28.89l4.49-2.16-3.88-3.03zM20.25 26.73l4.49 2.16-.61-5.19z" fill="#E4761B" stroke="#E4761B" stroke-linecap="round" stroke-linejoin="round"/><path d="M24.74 28.89l-4.49-2.16.36 2.93-.04 1.23zM10.26 28.89l4.17 2 -.04-1.23.36-2.93z" fill="#D7C1B3" stroke="#D7C1B3" stroke-linecap="round" stroke-linejoin="round"/><path d="M14.52 21.86l-3.75-1.1 2.65-1.21zM20.48 21.86l1.1-2.31 2.65 1.21z" fill="#233447" stroke="#233447" stroke-linecap="round" stroke-linejoin="round"/></svg>';

        const NETWORK_MAP = {
            '0x1':   { name: 'Ethereum Mainnet', cls: 'ethereum',  explorer: 'https://etherscan.io' },
            '0x89':  { name: 'Polygon',          cls: 'polygon',   explorer: 'https://polygonscan.com' },
            '0x38':  { name: 'BSC',              cls: 'bsc',       explorer: 'https://bscscan.com' },
            '0xa4b1':{ name: 'Arbitrum',          cls: 'arbitrum',  explorer: 'https://arbiscan.io' },
            '0x2105':{ name: 'Base',              cls: 'base',      explorer: 'https://basescan.org' },
        };

        function getNetwork(chainId) {
            const hex = typeof chainId === 'number' ? '0x' + chainId.toString(16) : chainId;
            if (NETWORK_MAP[hex]) return NETWORK_MAP[hex];
            // Testnets
            const testNets = ['0x5', '0xaa36a7', '0x13881', '0x61', '0x66eed', '0x14a33', '0x7a69'];
            if (testNets.includes(hex)) return { name: 'Testnet', cls: 'testnet', explorer: 'https://etherscan.io' };
            return { name: 'Unknown (' + hex + ')', cls: 'ethereum', explorer: 'https://etherscan.io' };
        }

        function truncAddr(addr) {
            if (!addr) return '';
            const isMobile = window.innerWidth < 640;
            return addr.slice(0, 6) + '...' + addr.slice(isMobile ? -4 : -5);
        }

        // ── Confirmation dialog ──
        window.nxConfirmClose = function() {
            document.getElementById('nxConfirmOverlay').classList.remove('open');
            _nxConfirmCb = null;
        };
        window.nxConfirmExec = function() {
            if (_nxConfirmCb) _nxConfirmCb();
            nxConfirmClose();
        };
        function showConfirm(title, msg, btnLabel, cb) {
            document.getElementById('nxConfirmTitle').textContent = title;
            document.getElementById('nxConfirmMsg').textContent = msg;
            document.getElementById('nxConfirmAction').textContent = btnLabel;
            _nxConfirmCb = cb;
            document.getElementById('nxConfirmOverlay').classList.add('open');
        }

        // ── Copy address ──
        window.nxCopyAddr = function(addr, btnEl) {
            navigator.clipboard.writeText(addr).then(() => {
                const tip = btnEl.querySelector('.copied-tip');
                if (tip) { tip.classList.add('show'); setTimeout(() => tip.classList.remove('show'), 2000); }
            });
        };

        // ── Wallet balance reading via ethers.js ──
        async function readWalletBalance(address) {
            if (typeof ethers === 'undefined' || !window.ethereum) return null;
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const balance = await provider.getBalance(address);
                const ethBal = parseFloat(ethers.formatEther(balance));
                // Get ETH price from CoinGecko
                let usdVal = 0;
                try {
                    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                    const data = await res.json();
                    usdVal = ethBal * (data.ethereum?.usd || 0);
                } catch(e) { /* ignore price fetch failure */ }
                return { ethBalance: ethBal, usdValue: usdVal };
            } catch(e) {
                console.warn('Wallet balance read error:', e);
                return null;
            }
        }

        async function detectNetwork() {
            if (!window.ethereum) return null;
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                return getNetwork(chainId);
            } catch(e) { return null; }
        }

        // ── Fetch transactions from Etherscan ──
        async function fetchWalletTransactions(address, network) {
            const explorer = network?.explorer || 'https://etherscan.io';
            // Use public Etherscan API (rate-limited)
            const apiBase = explorer.replace('https://', 'https://api.');
            try {
                const res = await fetch(`${apiBase}/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&page=1&offset=10&sort=desc`);
                const data = await res.json();
                if (data.status === '1' && data.result) return data.result;
                return [];
            } catch(e) {
                console.warn('Tx fetch error:', e);
                return [];
            }
        }

        // ── Fetch ERC-20 tokens (using public Etherscan tokentx) ──
        async function fetchTokenBalances(address, network) {
            const explorer = network?.explorer || 'https://etherscan.io';
            const apiBase = explorer.replace('https://', 'https://api.');
            try {
                const res = await fetch(`${apiBase}/api?module=account&action=tokentx&address=${address}&startblock=0&endblock=99999999&page=1&offset=50&sort=desc`);
                const data = await res.json();
                if (data.status === '1' && data.result) {
                    // Aggregate unique tokens
                    const tokens = {};
                    for (const tx of data.result) {
                        const sym = tx.tokenSymbol || 'UNKNOWN';
                        if (!tokens[sym]) tokens[sym] = { symbol: sym, name: tx.tokenName, decimals: parseInt(tx.tokenDecimal) || 18 };
                    }
                    return Object.values(tokens);
                }
                return [];
            } catch(e) { return []; }
        }

        // ── Render wallet card ──
        function renderEnhancedWalletCard(wallet, state) {
            const addr = wallet.address;
            const net = state?.network || getNetwork('0x1');
            const connected = state?.connected !== false;
            const isTestnet = net.cls === 'testnet';

            if (!connected) {
                return `
                <div class="nx-wallet-card">
                    <div class="nx-wallet-disconnected">
                        <div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:6px">Wallet disconnected</div>
                        <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:rgba(255,255,255,0.25)">${truncAddr(addr)}</div>
                        <button class="nx-wallet-reconnect-btn" onclick="reconnectWallet('${addr}')">Reconnect</button>
                    </div>
                </div>`;
            }

            const ethBal = state?.ethBalance != null ? state.ethBalance.toFixed(4) : '—';
            const usdVal = state?.usdValue != null ? '$' + state.usdValue.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}) : '—';
            const tokenCount = state?.tokens?.length || 0;

            return `
            <div class="nx-wallet-card">
                ${isTestnet ? '<div class="nx-wallet-testnet-warn">\u26A0 You are on a testnet \u2014 balances are not real</div>' : ''}
                <div class="nx-wallet-top">
                    <div class="nx-wallet-provider">
                        ${METAMASK_ICON}
                        MetaMask
                    </div>
                    <div class="nx-wallet-status-row">
                        <span class="nx-wallet-network-badge ${net.cls}">${net.name}</span>
                        <span class="${connected ? 'nx-wallet-connected-dot' : 'nx-wallet-disconnected-dot'}"></span>
                    </div>
                </div>
                <div class="nx-wallet-addr-row">
                    <span class="nx-wallet-addr">${truncAddr(addr)}</span>
                    <span class="badge-live">LIVE</span>
                    <button class="nx-wallet-addr-btn" onclick="nxCopyAddr('${addr}', this)">Copy <span class="copied-tip">Copied!</span></button>
                    <a class="nx-wallet-addr-btn" href="${net.explorer}/address/${addr}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();window.open('${net.explorer}/address/${addr}','_blank');return false;" style="text-decoration:none">View</a>
                </div>
                <div class="nx-wallet-info-grid">
                    <div class="nx-wallet-info-item">
                        <span class="nx-wallet-info-label">ETH Balance</span>
                        <span class="nx-wallet-info-value teal">${ethBal} ETH</span>
                    </div>
                    <div class="nx-wallet-info-item">
                        <span class="nx-wallet-info-label" style="color:rgba(0,211,149,0.5)">REAL BALANCE</span>
                        <span class="nx-wallet-info-value">\u2248 ${usdVal}</span>
                    </div>
                    <div class="nx-wallet-info-item">
                        <span class="nx-wallet-info-label">Tokens</span>
                        <span class="nx-wallet-info-value">${tokenCount} asset${tokenCount !== 1 ? 's' : ''}</span>
                    </div>
                </div>
                <div style="background:rgba(0,211,149,0.06);border:1px solid rgba(0,211,149,0.15);border-radius:6px;padding:8px 12px;font-size:11px;color:rgba(0,211,149,0.7);margin-bottom:16px;font-family:'Inter',sans-serif">\uD83D\uDC41 Read Only \u2014 NexYpher cannot move or trade your funds</div>
                <div class="nx-wallet-actions">
                    <a class="nx-etherscan-btn" href="${net.explorer}/address/${addr}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();window.open('${net.explorer}/address/${addr}','_blank');return false;">View on Etherscan &#x2197;</a>
                    <button class="nx-wallet-remove-btn" onclick="confirmRemoveWallet('${addr}','${wallet.chain}')">Remove</button>
                </div>
            </div>`;
        }

        // ── Render transaction history ──
        function renderTransactions(txs, address, network) {
            if (!txs || !txs.length) return '<div class="nx-tx-loading">No transactions found</div>';
            const explorer = network?.explorer || 'https://etherscan.io';
            let html = '';
            for (const tx of txs.slice(0, 10)) {
                const isIn = tx.to && tx.to.toLowerCase() === address.toLowerCase();
                const icon = isIn ? '\u2193 IN' : '\u2191 OUT';
                const iconCls = isIn ? 'tx-in' : 'tx-out';
                const amtCls = isIn ? 'tx-in' : 'tx-out';
                const ethAmt = tx.value ? (parseFloat(tx.value) / 1e18).toFixed(4) : '0';
                const sign = isIn ? '+' : '-';
                const date = tx.timeStamp ? new Date(parseInt(tx.timeStamp) * 1000).toLocaleDateString() : '';
                const success = tx.isError === '0' || tx.txreceipt_status === '1';
                const hash = tx.hash || '';
                const shortHash = hash ? hash.slice(0, 10) + '...' + hash.slice(-6) : '';
                html += `
                <div class="nx-tx-row">
                    <div class="nx-tx-icon ${iconCls}">${icon}</div>
                    <div class="nx-tx-details">
                        <a class="nx-tx-hash" href="${explorer}/tx/${hash}" target="_blank" rel="noopener">${shortHash}</a>
                        <div class="nx-tx-date">${date}</div>
                    </div>
                    <div class="nx-tx-amount ${amtCls}">${sign}${ethAmt} ETH</div>
                    <span class="nx-tx-status ${success ? 'success' : 'failed'}">${success ? '\u2713 Success' : '\u2717 Failed'}</span>
                </div>`;
            }
            html += `<a class="nx-tx-view-all" href="${explorer}/address/${address}" target="_blank" rel="noopener">View all on Etherscan \u2192</a>`;
            return html;
        }

        // ── Update wallet list rendering ──
        window._nxRenderWallets = function(wallets) {
            connectedWallets = wallets || [];
            const wl = document.getElementById('walletList');
            const txSection = document.getElementById('walletTxSection');

            if (connectedWallets.length === 0) {
                wl.innerHTML = '<div class="profile-empty-state">No wallets connected yet</div>';
                if (txSection) txSection.innerHTML = '';
                return;
            }

            let cardsHtml = '';
            for (const w of connectedWallets) {
                const state = liveWalletState[w.address.toLowerCase()] || {};
                cardsHtml += renderEnhancedWalletCard(w, state);
            }
            wl.innerHTML = cardsHtml;

            // Show sync button if wallets exist
            const syncBtn = document.getElementById('syncWalletBtn');
            if (syncBtn) syncBtn.style.display = connectedWallets.length > 0 ? 'inline-block' : 'none';

            // Render transactions for first wallet
            if (txSection && connectedWallets.length > 0) {
                const firstAddr = connectedWallets[0].address.toLowerCase();
                const state = liveWalletState[firstAddr] || {};
                if (state.txs && state.txs.length) {
                    txSection.innerHTML = `
                    <div class="nx-tx-section">
                        <div class="nx-tx-header">
                            <span class="nx-tx-title">Wallet Transactions <span class="badge-live">LIVE</span></span>
                        </div>
                        ${renderTransactions(state.txs, connectedWallets[0].address, state.network)}
                    </div>`;
                } else {
                    txSection.innerHTML = '';
                }
            }
        };

        // ── Refresh live wallet data ──
        async function refreshLiveWalletData() {
            if (!connectedWallets.length || typeof ethers === 'undefined') return;
            const network = await detectNetwork();

            for (const w of connectedWallets) {
                const addr = w.address.toLowerCase();
                const balData = await readWalletBalance(w.address);
                const tokens = await fetchTokenBalances(w.address, network);
                const txs = await fetchWalletTransactions(w.address, network);

                liveWalletState[addr] = {
                    ...(liveWalletState[addr] || {}),
                    ethBalance: balData?.ethBalance ?? null,
                    usdValue: balData?.usdValue ?? null,
                    network: network,
                    tokens: tokens,
                    txs: txs,
                    connected: true,
                    lastRefresh: Date.now()
                };
            }
            // Re-render
            window._nxRenderWallets(connectedWallets);
        }

        // ── Start auto-refresh every 30s ──
        function startWalletRefresh() {
            if (walletRefreshTimer) clearInterval(walletRefreshTimer);
            refreshLiveWalletData();
            walletRefreshTimer = setInterval(refreshLiveWalletData, 30000);
        }

        // ── Listen for MetaMask events ──
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function(accounts) {
                if (!accounts.length) {
                    // Wallet disconnected
                    for (const key of Object.keys(liveWalletState)) {
                        liveWalletState[key].connected = false;
                    }
                    window._nxRenderWallets(connectedWallets);
                } else {
                    refreshLiveWalletData();
                }
            });
            window.ethereum.on('chainChanged', function() {
                refreshLiveWalletData();
            });
        }

        // ── Reconnect wallet ──
        window.reconnectWallet = async function(addr) {
            if (!window.ethereum) { showToast('MetaMask not detected', 'error'); return; }
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const lk = addr.toLowerCase();
                if (liveWalletState[lk]) liveWalletState[lk].connected = true;
                refreshLiveWalletData();
                showToast('Wallet reconnected', 'success');
            } catch(e) {
                showToast('Connection rejected', 'error');
            }
        };

        // ── Confirm remove wallet ──
        window.confirmRemoveWallet = function(addr, chain) {
            showConfirm(
                'Remove this wallet?',
                "This won\u2019t affect your actual funds. Your wallet and its contents remain safe.",
                'Remove',
                function() { removeWallet(addr, chain); }
            );
        };

        // ── Sync portfolio from wallet ──
        window.syncPortfolioFromWallet = async function() {
            if (!connectedWallets.length) { showToast('Connect a wallet first', 'error'); return; }
            const statusEl = document.getElementById('portfolioSyncStatus');
            if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Syncing from wallet...'; }

            const addr = connectedWallets[0].address;
            const lk = addr.toLowerCase();
            const state = liveWalletState[lk] || {};

            // Refresh data if stale
            if (!state.lastRefresh || Date.now() - state.lastRefresh > 60000) {
                await refreshLiveWalletData();
            }

            const tokens = state.tokens || [];
            if (!tokens.length && !state.ethBalance) {
                if (statusEl) statusEl.textContent = 'No tokens found in wallet';
                return;
            }

            // Show synced info
            const relTime = state.lastRefresh ? getRelativeTime(state.lastRefresh) : 'just now';
            if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Last synced: ' + relTime; }
            showToast('Portfolio synced from wallet — ' + (tokens.length || 0) + ' token(s) found', 'success');
        };

        function getRelativeTime(ts) {
            const diff = Math.floor((Date.now() - ts) / 1000);
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + ' min' + (Math.floor(diff/60) > 1 ? 's' : '') + ' ago';
            return Math.floor(diff / 3600) + ' hour' + (Math.floor(diff/3600) > 1 ? 's' : '') + ' ago';
        }

        // ── Trade history view switching ──
        window.switchHistoryView = function(view) {
            const tabs = document.querySelectorAll('#tradeHistoryMainTabs .nx-history-tab');
            tabs.forEach(t => t.classList.remove('active'));
            if (view === 'paper') {
                tabs[0].classList.add('active');
                document.getElementById('tradeHistoryPaperView').style.display = 'block';
                document.getElementById('tradeHistoryWalletView').style.display = 'none';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('tradeHistoryPaperView').style.display = 'none';
                document.getElementById('tradeHistoryWalletView').style.display = 'block';
                // Load wallet txs
                loadWalletHistoryForTrader();
            }
        };

        async function loadWalletHistoryForTrader() {
            const el = document.getElementById('walletHistoryArea');
            if (!connectedWallets.length) {
                el.innerHTML = '<div class="empty-state"><p>Connect a wallet to see on-chain transactions</p></div>';
                return;
            }
            el.innerHTML = '<div class="nx-tx-loading">Loading wallet transactions...</div>';
            const addr = connectedWallets[0].address;
            const lk = addr.toLowerCase();
            const state = liveWalletState[lk] || {};
            if (!state.txs) {
                const network = await detectNetwork();
                state.txs = await fetchWalletTransactions(addr, network);
                state.network = network;
                liveWalletState[lk] = state;
            }
            el.innerHTML = renderTransactions(state.txs, addr, state.network);
        }

        // ── Navbar paper mode indicator ──
        window._nxUpdatePaperNav = function(page) {
            const el = document.getElementById('nxPaperNav');
            if (el) {
                el.classList.toggle('visible', page === 'trader');
            }
        };

        // ── Onboarding banner ──
        window.dismissOnboarding = function() {
            localStorage.setItem('paper_mode_banner_dismissed', 'true');
            const el = document.getElementById('nxOnboardingBanner');
            if (el) el.style.display = 'none';
        };
        window._nxShowOnboarding = function() {
            if (localStorage.getItem('paper_mode_banner_dismissed') === 'true') return;
            const el = document.getElementById('nxOnboardingBanner');
            if (!el) return;
            // Add wallet info if available
            if (connectedWallets.length) {
                const wSpan = document.getElementById('nxOnboardingWallet');
                if (wSpan) wSpan.textContent = 'Your connected wallet (' + truncAddr(connectedWallets[0].address) + ') is completely separate and safe.';
            }
            el.style.display = 'flex';
        };

        // ── Hook into page navigation ──
        const origNavigate = window.navigate;
        if (typeof origNavigate === 'function') {
            window.navigate = function(page) {
                origNavigate(page);
                window._nxUpdatePaperNav(page);
                if (page === 'trader') window._nxShowOnboarding();
            };
        }

        // ── Heatmap view switching ──
        let hmCurrentView = 'paper';
        window._hmSwitchView = function(view) {
            hmCurrentView = view;
            const btns = document.querySelectorAll('#hmViewToggle .hm-view-btn');
            btns.forEach(b => b.classList.toggle('active', b.dataset.view === view));
            const titleEl = document.getElementById('hmTitle');
            const subEl = document.getElementById('hmSubtitle');
            const legendEl = document.getElementById('hmLegend');

            if (view === 'paper') {
                titleEl.innerHTML = 'Paper Trading P&L Heatmap <span class="badge-paper">PAPER</span>';
                subEl.textContent = 'Your simulated profit & loss activity over the past year';
                legendEl.innerHTML = `
                    <span class="hm-legend-label">Loss</span>
                    <span class="hm-legend-sq" style="background:rgba(255,71,87,0.15)"></span>
                    <span class="hm-legend-sq" style="background:rgba(255,71,87,0.35)"></span>
                    <span class="hm-legend-sq" style="background:rgba(255,71,87,0.55)"></span>
                    <span class="hm-legend-sq" style="background:rgba(255,71,87,0.75)"></span>
                    <span class="hm-legend-sq" style="background:#ff4757"></span>
                    <span class="hm-legend-gap"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,211,149,0.15)"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,211,149,0.35)"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,211,149,0.55)"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,211,149,0.75)"></span>
                    <span class="hm-legend-sq" style="background:#00d395"></span>
                    <span class="hm-legend-label">Profit</span>`;
                window._hmSelectYear(window._hmGetYear ? window._hmGetYear() : new Date().getFullYear());
            } else {
                titleEl.innerHTML = 'Real Wallet Transaction Heatmap <span class="badge-live">LIVE</span>';
                subEl.textContent = 'On-chain transaction activity from your connected wallet';
                legendEl.innerHTML = `
                    <span class="hm-legend-label">Outgoing</span>
                    <span class="hm-legend-sq" style="background:rgba(255,152,0,0.15)"></span>
                    <span class="hm-legend-sq" style="background:rgba(255,152,0,0.35)"></span>
                    <span class="hm-legend-sq" style="background:rgba(255,152,0,0.55)"></span>
                    <span class="hm-legend-sq" style="background:rgba(255,152,0,0.75)"></span>
                    <span class="hm-legend-sq" style="background:#ff9800"></span>
                    <span class="hm-legend-gap"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,188,212,0.15)"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,188,212,0.35)"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,188,212,0.55)"></span>
                    <span class="hm-legend-sq" style="background:rgba(0,188,212,0.75)"></span>
                    <span class="hm-legend-sq" style="background:#00bcd4"></span>
                    <span class="hm-legend-label">Incoming</span>`;
                loadRealWalletHeatmap();
            }
        };

        async function loadRealWalletHeatmap() {
            const statsEl = document.getElementById('hmStats');
            const gridEl = document.getElementById('hmGridWrap');
            if (!connectedWallets.length) {
                statsEl.innerHTML = '';
                gridEl.innerHTML = '<div class="hm-empty">Connect a wallet to see real transaction heatmap</div>';
                return;
            }
            gridEl.innerHTML = '<div class="hm-empty">Loading on-chain data...</div>';
            const addr = connectedWallets[0].address;
            const lk = addr.toLowerCase();
            const state = liveWalletState[lk] || {};
            if (!state.txs) {
                const network = await detectNetwork();
                state.txs = await fetchWalletTransactions(addr, network);
                state.network = network;
                liveWalletState[lk] = state;
            }
            if (!state.txs || !state.txs.length) {
                statsEl.innerHTML = '';
                gridEl.innerHTML = '<div class="hm-empty">No on-chain transactions found</div>';
                return;
            }
            // Aggregate by date
            const daily = {};
            for (const tx of state.txs) {
                if (!tx.timeStamp) continue;
                const d = new Date(parseInt(tx.timeStamp) * 1000);
                const key = d.toISOString().slice(0, 10);
                if (!daily[key]) daily[key] = { incoming: 0, outgoing: 0, count: 0 };
                const ethVal = parseFloat(tx.value || '0') / 1e18;
                const isIn = tx.to && tx.to.toLowerCase() === addr;
                if (isIn) daily[key].incoming += ethVal;
                else daily[key].outgoing += ethVal;
                daily[key].count++;
            }
            // Show stats
            let inDays = 0, outDays = 0, totalIn = 0, totalOut = 0;
            for (const [, v] of Object.entries(daily)) {
                if (v.incoming > 0) { inDays++; totalIn += v.incoming; }
                if (v.outgoing > 0) { outDays++; totalOut += v.outgoing; }
            }
            statsEl.innerHTML = `
                <div class="hm-stat"><div class="hm-stat-label">Incoming Days</div><div class="hm-stat-value" style="color:#00bcd4">${inDays}</div></div>
                <div class="hm-stat"><div class="hm-stat-label">Outgoing Days</div><div class="hm-stat-value" style="color:#ff9800">${outDays}</div></div>
                <div class="hm-stat"><div class="hm-stat-label">Total Received</div><div class="hm-stat-value" style="color:#00bcd4">${totalIn.toFixed(3)} ETH</div></div>
                <div class="hm-stat"><div class="hm-stat-label">Total Sent</div><div class="hm-stat-value" style="color:#ff9800">${totalOut.toFixed(3)} ETH</div></div>`;
            gridEl.innerHTML = '<div class="hm-empty" style="color:rgba(0,188,212,0.5)">Real wallet heatmap grid \u2014 ' + Object.keys(daily).length + ' day(s) with activity</div>';
        }

        // ── Expose for profile loading ──
        window._nxWalletEngine = {
            startRefresh: startWalletRefresh,
            renderWallets: function(w) { window._nxRenderWallets(w); },
            getConnected: function() { return connectedWallets; },
            getLiveState: function() { return liveWalletState; }
        };

    })();
    </script>

</body>

</html>