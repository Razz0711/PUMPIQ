<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PumpIQ — AI-Powered Crypto Intelligence</title>
<style>
/* ── CSS Reset & Variables ────────────────────────────────── */
:root {
    --bg-primary: #0a0e17;
    --bg-secondary: #111827;
    --bg-card: #1a1f2e;
    --bg-card-hover: #212738;
    --border: #2a3042;
    --text-primary: #e5e7eb;
    --text-secondary: #9ca3af;
    --text-muted: #6b7280;
    --accent: #3b82f6;
    --accent-glow: rgba(59,130,246,0.15);
    --green: #10b981;
    --green-bg: rgba(16,185,129,0.1);
    --red: #ef4444;
    --red-bg: rgba(239,68,68,0.1);
    --yellow: #f59e0b;
    --purple: #8b5cf6;
    --cyan: #06b6d4;
    --gradient: linear-gradient(135deg, #3b82f6, #8b5cf6);
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
}
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ── Scrollbar ────────────────────────────────────────────── */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:var(--bg-primary); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* ── Header ───────────────────────────────────────────────── */
.header {
    position: sticky; top:0; z-index:100;
    background: rgba(10,14,23,0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 60px;
    display: flex; align-items:center; justify-content:space-between;
}
.logo {
    font-size:22px; font-weight:800;
    background: var(--gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    cursor: pointer;
}
.nav-tabs { display:flex; gap:4px; }
.nav-tab {
    padding: 8px 16px; border-radius:var(--radius-sm);
    color:var(--text-secondary); cursor:pointer;
    font-size:14px; font-weight:500; transition:all 0.2s;
    border: none; background: none;
}
.nav-tab:hover { color:var(--text-primary); background:var(--bg-card); }
.nav-tab.active {
    color:var(--accent); background:var(--accent-glow);
}
.header-right { display:flex; align-items:center; gap:12px; }
.search-box {
    padding: 8px 14px; border-radius:20px;
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-primary); font-size:13px; width:220px;
    outline:none; transition:border 0.2s;
}
.search-box:focus { border-color:var(--accent); }
.btn {
    padding: 8px 18px; border-radius:var(--radius-sm);
    font-size:13px; font-weight:600; cursor:pointer;
    border:none; transition:all 0.2s;
}
.btn-primary {
    background:var(--gradient); color:#fff;
}
.btn-primary:hover { opacity:0.9; }
.btn-outline {
    background:transparent; color:var(--accent);
    border:1px solid var(--accent);
}
.btn-outline:hover { background:var(--accent-glow); }
.btn-green { background:var(--green); color:#fff; }
.btn-green:hover { opacity:0.9; }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-danger { background:var(--red); color:#fff; }

.user-badge {
    display:flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:20px;
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-secondary); font-size:13px; cursor:pointer;
}
.user-avatar {
    width:28px; height:28px; border-radius:50%;
    background:var(--gradient); display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:12px; font-weight:700;
}

/* ── Page Container ───────────────────────────────────────── */
.page { display:none; padding:24px; max-width:1200px; margin:0 auto; }
.page.active { display:block; }

/* ── Hero Section ─────────────────────────────────────────── */
.hero {
    text-align:center; padding:60px 20px 40px;
}
.hero-tag {
    color:var(--cyan); font-size:13px; font-weight:700; letter-spacing:2px;
    text-transform:uppercase; margin-bottom:16px;
}
.hero-title {
    font-size:48px; font-weight:900; line-height:1.1; margin-bottom:16px;
    color:var(--text-primary);
}
.hero-desc {
    color:var(--text-secondary); font-size:16px; max-width:600px; margin:0 auto 40px;
    line-height:1.6;
}
.hero-steps {
    display:grid; grid-template-columns:repeat(3,1fr); gap:20px;
    max-width:900px; margin:0 auto;
}
.step-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px;
    text-align:left; transition:border 0.2s;
}
.step-card:hover { border-color:var(--accent); }
.step-num {
    color:var(--cyan); font-size:12px; font-weight:700; margin-bottom:8px;
}
.step-title { font-size:18px; font-weight:700; margin-bottom:8px; }
.step-desc { color:var(--text-secondary); font-size:13px; line-height:1.5; }

/* ── Section Titles ───────────────────────────────────────── */
.section-title {
    font-size:24px; font-weight:800; margin-bottom:6px;
}
.section-desc {
    color:var(--text-secondary); font-size:14px; margin-bottom:20px;
}

/* ── Cards Grid ───────────────────────────────────────────── */
.cards-grid {
    display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr));
    gap:16px;
}
.card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px;
    cursor:pointer; transition:all 0.2s;
}
.card:hover { background:var(--bg-card-hover); border-color:var(--accent); }

/* ── Filter Tabs ──────────────────────────────────────────── */
.filter-bar {
    display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; align-items:center;
}
.filter-pill {
    padding:6px 16px; border-radius:20px; font-size:13px;
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-secondary); cursor:pointer; transition:all 0.2s;
}
.filter-pill:hover { color:var(--text-primary); border-color:var(--text-muted); }
.filter-pill.active { background:var(--accent); color:#fff; border-color:var(--accent); }

/* ── Token Feed Table ─────────────────────────────────────── */
.feed-table { width:100%; border-collapse:collapse; }
.feed-table th {
    text-align:left; padding:12px 16px; font-size:12px;
    color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;
    border-bottom:1px solid var(--border);
}
.feed-table td {
    padding:14px 16px; border-bottom:1px solid var(--border);
    font-size:14px; vertical-align:middle;
}
.feed-table tr:hover { background:var(--bg-card); }
.token-info { display:flex; align-items:center; gap:10px; }
.token-icon {
    width:36px; height:36px; border-radius:50%;
    background:var(--gradient); display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:12px; font-weight:700; flex-shrink:0;
}
.token-name { font-weight:600; }
.token-symbol { color:var(--text-muted); font-size:12px; }
.price-positive { color:var(--green); }
.price-negative { color:var(--red); }

/* ── AI Recs ──────────────────────────────────────────────── */
.market-summary-box {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; margin-bottom:20px;
}
.market-summary-box h4 { font-size:14px; color:var(--text-muted); margin-bottom:8px; }
.market-summary-box p { color:var(--text-secondary); font-size:14px; line-height:1.6; }

.toggle-row { display:flex; gap:24px; margin-bottom:20px; }
.toggle-item {
    display:flex; align-items:center; gap:10px;
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:14px 20px; flex:1;
}
.simple-toggle {
    width:40px; height:22px; border-radius:11px;
    background:var(--cyan); position:relative; cursor:pointer; flex-shrink:0;
}
.simple-toggle::after {
    content:''; position:absolute; top:2px; left:2px;
    width:18px; height:18px; border-radius:50%; background:#fff;
    transition: left 0.2s;
}
.simple-toggle.off { background:var(--text-muted); }
.simple-toggle.off::after { left:2px; }
.simple-toggle:not(.off)::after { left:20px; }
.toggle-label { font-weight:600; font-size:14px; }
.toggle-desc { color:var(--text-muted); font-size:12px; }

.score-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; position:relative;
}
.score-circle {
    width:52px; height:52px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-weight:800; font-size:18px; color:#fff;
    position:absolute; top:16px; right:16px;
}
.score-green { background:var(--green); }
.score-yellow { background:var(--yellow); }
.score-red { background:var(--red); }
.score-purple { background:var(--purple); }
.score-card-name { font-weight:700; font-size:16px; }
.score-card-sym { color:var(--text-muted); font-size:13px; margin-bottom:10px; }
.score-card-summary { color:var(--text-secondary); font-size:13px; line-height:1.5; margin-bottom:12px; }
.verdict-badge {
    display:inline-block; padding:4px 10px; border-radius:4px;
    font-size:12px; font-weight:700;
}
.verdict-STRONG_BUY, .verdict-BUY { background:var(--green-bg); color:var(--green); }
.verdict-HOLD { background:rgba(245,158,11,0.1); color:var(--yellow); }
.verdict-CAUTION { background:var(--red-bg); color:var(--red); }
.verdict-AVOID { background:var(--red-bg); color:var(--red); }

.on-chain-bars { margin-top:10px; }
.bar-row { display:flex; align-items:center; gap:8px; margin-bottom:4px; }
.bar-label { font-size:11px; color:var(--text-muted); width:80px; flex-shrink:0; }
.bar-track { flex:1; height:6px; background:var(--border); border-radius:3px; }
.bar-fill { height:100%; border-radius:3px; background:var(--cyan); }

/* ── Leaderboard ──────────────────────────────────────────── */
.lb-table { width:100%; border-collapse:collapse; }
.lb-table th {
    text-align:left; padding:12px 16px; font-size:12px;
    color:var(--text-muted); text-transform:uppercase;
    border-bottom:1px solid var(--border);
}
.lb-table td {
    padding:14px 16px; border-bottom:1px solid var(--border); font-size:14px;
}
.lb-table tr:hover { background:var(--bg-card); }
.trader-addr { color:var(--accent); font-family:monospace; font-size:13px; }

/* ── Modal ────────────────────────────────────────────────── */
.modal-overlay {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
    z-index:200; justify-content:center; align-items:flex-start;
    padding:40px 20px; overflow-y:auto;
}
.modal-overlay.active { display:flex; }
.modal {
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:16px; width:100%; max-width:500px;
    padding:32px; position:relative;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.modal-close {
    position:absolute; top:16px; right:16px;
    background:none; border:none; color:var(--text-muted);
    font-size:20px; cursor:pointer;
}
.modal h2 { font-size:22px; margin-bottom:20px; }
.form-group { margin-bottom:16px; }
.form-group label {
    display:block; font-size:13px; color:var(--text-secondary);
    margin-bottom:6px; font-weight:500;
}
.form-input {
    width:100%; padding:10px 14px; border-radius:var(--radius-sm);
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-primary); font-size:14px; outline:none;
}
.form-input:focus { border-color:var(--accent); }
.form-error { color:var(--red); font-size:12px; margin-top:4px; display:none; }
.form-divider {
    text-align:center; color:var(--text-muted); font-size:13px;
    margin:16px 0; position:relative;
}
.form-divider::before, .form-divider::after {
    content:''; position:absolute; top:50%;
    width:calc(50% - 20px); height:1px; background:var(--border);
}
.form-divider::before { left:0; }
.form-divider::after { right:0; }

/* ── Detail Modal (larger) ────────────────────────────────── */
.modal-lg { max-width:720px; }
.detail-header { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
.detail-avatar {
    width:48px; height:48px; border-radius:50%;
    background:var(--gradient); display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:16px; font-weight:700;
}
.detail-name { font-size:20px; font-weight:700; }
.detail-symbol { color:var(--text-muted); font-size:13px; }
.detail-price-row { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
.detail-price { font-size:28px; font-weight:800; }
.metrics-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px; }
.metric-box {
    background:var(--bg-card); border-radius:var(--radius-sm); padding:14px;
}
.metric-label { font-size:11px; color:var(--text-muted); margin-bottom:4px; }
.metric-value { font-size:15px; font-weight:600; }
.analysis-section {
    background:var(--bg-card); border-radius:var(--radius); padding:16px;
    margin-bottom:12px;
}
.analysis-title { font-size:14px; font-weight:700; margin-bottom:10px; }
.analysis-row {
    display:flex; justify-content:space-between; padding:4px 0;
    font-size:13px; color:var(--text-secondary);
}
.score-bar-container { height:6px; background:var(--border); border-radius:3px; margin-top:6px; }
.score-bar { height:100%; border-radius:3px; transition:width 0.5s; }
.score-bar.green { background:var(--green); }
.score-bar.yellow { background:var(--yellow); }
.score-bar.red { background:var(--red); }
.ai-box {
    background:var(--bg-card); border:1px solid var(--purple);
    border-radius:var(--radius); padding:16px; margin-top:12px;
}
.ai-box-title { font-size:14px; font-weight:700; margin-bottom:8px; }
.ai-badge {
    display:inline-block; padding:2px 8px; border-radius:4px;
    font-size:10px; font-weight:700; background:var(--purple); color:#fff;
    margin-left:8px;
}
.ai-text { color:var(--text-secondary); font-size:13px; line-height:1.6; }

/* ── Wallet Section ───────────────────────────────────────── */
.wallet-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px;
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:8px;
}
.wallet-addr { font-family:monospace; font-size:13px; color:var(--accent); }
.wallet-chain {
    font-size:11px; padding:2px 8px; border-radius:4px;
    background:var(--accent-glow); color:var(--accent); font-weight:600;
}

/* ── Wallet Balance Card ──────────────────────────────────── */
.balance-card {
    background: linear-gradient(135deg, #1a1040 0%, #0d2137 50%, #0a2a1a 100%);
    border: 1px solid #2a2a4a;
    border-radius: 16px; padding: 28px;
    margin-bottom: 24px; position: relative; overflow: hidden;
}
.balance-card::before {
    content: ''; position: absolute; top: -40px; right: -40px;
    width: 120px; height: 120px; border-radius: 50%;
    background: rgba(124,92,255,0.08);
}
.balance-label { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.balance-amount { font-size: 36px; font-weight: 700; color: #fff; margin-bottom: 16px; }
.balance-amount .currency { font-size: 20px; color: #7c5cff; margin-right: 4px; }
.balance-actions { display: flex; gap: 10px; }
.balance-actions .btn { flex: 1; padding: 10px; font-size: 13px; }

/* ── Bank Account Card ────────────────────────────────────── */
.bank-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px;
}
.bank-info { display: flex; align-items: center; gap: 12px; }
.bank-icon {
    width: 40px; height: 40px; border-radius: 10px;
    background: linear-gradient(135deg, #7c5cff, #00d4aa);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; font-weight: 700; color: #fff;
}
.bank-name { font-weight: 600; font-size: 14px; }
.bank-detail { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.bank-verified { color: #00d4aa; font-size: 11px; font-weight: 600; }

/* ── Transaction List ─────────────────────────────────────── */
.txn-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0; border-bottom: 1px solid var(--border);
}
.txn-type { font-size: 12px; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
.txn-deposit { background: #0a2a1a; color: #00d4aa; }
.txn-withdraw { background: #2a1a1a; color: #ff6b6b; }
.txn-amount { font-weight: 600; font-size: 14px; }

/* ── Verification Steps ───────────────────────────────────── */
.verify-steps { display: flex; gap: 8px; margin: 16px 0; }
.verify-step {
    flex: 1; text-align: center; padding: 10px 8px;
    border-radius: 8px; font-size: 11px; font-weight: 600;
    background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted);
}
.verify-step.active { border-color: #7c5cff; color: #7c5cff; background: rgba(124,92,255,0.08); }
.verify-step.done { border-color: #00d4aa; color: #00d4aa; background: rgba(0,212,170,0.08); }

/* ── Portfolio ────────────────────────────────────────────── */
.portfolio-table { width:100%; border-collapse:collapse; }
.portfolio-table th {
    text-align:left; padding:10px 14px; font-size:12px;
    color:var(--text-muted); text-transform:uppercase;
    border-bottom:1px solid var(--border);
}
.portfolio-table td {
    padding:12px 14px; border-bottom:1px solid var(--border); font-size:14px;
}

/* ── Auto Trader ──────────────────────────────────────────── */
.trader-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px; }
@media(max-width:768px) { .trader-grid { grid-template-columns:1fr; } }
.trader-stat-card {
    background: var(--bg-card); border:1px solid var(--border);
    border-radius: var(--radius); padding:20px;
}
.trader-stat-label { font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
.trader-stat-value { font-size:28px; font-weight:700; margin-top:4px; }
.trader-stat-sub { font-size:12px; color:var(--text-secondary); margin-top:4px; }

.trader-header {
    background: linear-gradient(135deg, #0d1a2d 0%, #1a0d2e 50%, #0d2a1a 100%);
    border: 1px solid #2a2a4a; border-radius:16px; padding:24px;
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;
}
.trader-title { font-size:24px; font-weight:700; }
.trader-title span { font-size:14px; font-weight:400; color:var(--text-muted); margin-left:8px; }
.trader-status {
    padding:6px 16px; border-radius:20px; font-size:13px; font-weight:600;
    display:inline-flex; align-items:center; gap:6px;
}
.trader-status.active { background:rgba(16,185,129,0.15); color:var(--green); border:1px solid rgba(16,185,129,0.3); }
.trader-status.inactive { background:rgba(239,68,68,0.1); color:var(--red); border:1px solid rgba(239,68,68,0.2); }

.toggle-switch {
    position:relative; width:52px; height:28px; cursor:pointer;
}
.toggle-switch input { display:none; }
.toggle-slider {
    position:absolute; top:0; left:0; right:0; bottom:0;
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:14px; transition:all 0.3s;
}
.toggle-slider::before {
    content:''; position:absolute; width:22px; height:22px;
    left:2px; bottom:2px; background:#fff; border-radius:50%;
    transition:transform 0.3s;
}
.toggle-switch input:checked + .toggle-slider {
    background:var(--green); border-color:var(--green);
}
.toggle-switch input:checked + .toggle-slider::before {
    transform:translateX(24px);
}

.position-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px; margin-bottom:10px;
}
.position-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.position-coin { font-weight:700; font-size:16px; }
.position-badge {
    padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600;
}
.position-badge.profit { background:var(--green-bg); color:var(--green); }
.position-badge.loss { background:var(--red-bg); color:var(--red); }
.position-details { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; font-size:12px; color:var(--text-secondary); }
.position-details span { display:block; }
.position-details strong { color:var(--text-primary); font-size:13px; }

.opp-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:14px; margin-bottom:8px;
    display:flex; justify-content:space-between; align-items:center;
}
.opp-info { flex:1; }
.opp-name { font-weight:600; font-size:14px; }
.opp-detail { font-size:12px; color:var(--text-secondary); margin-top:2px; }
.opp-score {
    width:48px; height:48px; border-radius:50%; display:flex;
    align-items:center; justify-content:center; font-weight:700;
    font-size:16px; margin-left:12px; flex-shrink:0;
}
.opp-score.high { background:var(--green-bg); color:var(--green); border:2px solid var(--green); }
.opp-score.mid { background:rgba(245,158,11,0.1); color:var(--yellow); border:2px solid var(--yellow); }
.opp-score.low { background:var(--red-bg); color:var(--red); border:2px solid var(--red); }

.log-item { padding:8px 0; border-bottom:1px solid var(--border); font-size:13px; }
.log-time { color:var(--text-muted); font-size:11px; }
.log-event { font-weight:600; margin:0 6px; }

.settings-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
@media(max-width:768px) { .settings-grid { grid-template-columns:1fr; } }
.setting-item {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:14px;
}
.setting-label { font-size:12px; color:var(--text-muted); margin-bottom:6px; }
.setting-input {
    width:100%; padding:8px 12px; background:var(--bg-secondary);
    border:1px solid var(--border); border-radius:6px;
    color:var(--text-primary); font-size:14px; outline:none;
}
.setting-input:focus { border-color:var(--accent); }

/* ── Loader ───────────────────────────────────────────────── */
.loader { display:flex; justify-content:center; padding:60px; }
.spinner {
    width:36px; height:36px; border:3px solid var(--border);
    border-top-color:var(--accent); border-radius:50%;
    animation:spin 0.8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

.empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
.empty-state h3 { font-size:18px; margin-bottom:8px; color:var(--text-secondary); }

/* ── Responsive ───────────────────────────────────────────── */
@media (max-width:768px) {
    .hero-steps { grid-template-columns:1fr; }
    .hero-title { font-size:32px; }
    .metrics-grid { grid-template-columns:1fr; }
    .toggle-row { flex-direction:column; }
    .nav-tabs { display:none; }
    .header { padding:0 12px; }
}

/* ── Toast Notifications ──────────────────────────────────── */
.toast-container {
    position:fixed; top:20px; right:20px; z-index:10000;
    display:flex; flex-direction:column; gap:8px;
}
.toast {
    padding:12px 20px; border-radius:10px; font-size:14px; color:#fff;
    min-width:280px; max-width:420px; box-shadow:0 8px 24px rgba(0,0,0,0.4);
    animation: toastIn 0.3s ease, toastOut 0.3s ease 3.7s forwards;
    backdrop-filter:blur(12px);
}
.toast.success { background:rgba(16,185,129,0.9); }
.toast.warning { background:rgba(245,158,11,0.9); }
.toast.info { background:rgba(99,102,241,0.85); }
.toast.error { background:rgba(239,68,68,0.9); }
@keyframes toastIn { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }
@keyframes toastOut { from { opacity:1; } to { opacity:0; transform:translateY(-10px); } }

/* ── PumpIQ Chat Bot Widget ───────────────────────────────── */
.bot-fab {
    position:fixed; bottom:24px; right:24px; z-index:9000;
    width:56px; height:56px; border-radius:50%;
    background:linear-gradient(135deg, #7c5cff, #00d4aa);
    border:none; cursor:pointer; color:#fff; font-size:26px;
    box-shadow:0 6px 24px rgba(124,92,255,0.5);
    display:flex; align-items:center; justify-content:center;
    transition:transform 0.2s, box-shadow 0.2s;
}
.bot-fab:hover { transform:scale(1.1); box-shadow:0 8px 32px rgba(124,92,255,0.7); }
.bot-fab.has-dot::after {
    content:''; position:absolute; top:6px; right:6px; width:10px; height:10px;
    background:var(--green); border-radius:50%; border:2px solid var(--bg-primary);
}

.bot-window {
    position:fixed; bottom:90px; right:24px; z-index:9001;
    width:400px; max-width:calc(100vw - 32px); height:520px; max-height:calc(100vh - 120px);
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:16px; display:none; flex-direction:column;
    box-shadow:0 16px 48px rgba(0,0,0,0.5); overflow:hidden;
    animation:botSlideIn 0.25s ease;
}
.bot-window.open { display:flex; }
@keyframes botSlideIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

.bot-header {
    padding:16px 20px; background:linear-gradient(135deg, #7c5cff22, #00d4aa11);
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
}
.bot-header-icon {
    width:36px; height:36px; border-radius:50%;
    background:linear-gradient(135deg, #7c5cff, #00d4aa);
    display:flex; align-items:center; justify-content:center; font-size:18px;
}
.bot-header-info h3 { margin:0; font-size:15px; color:var(--text-primary); }
.bot-header-info p { margin:2px 0 0; font-size:11px; color:var(--green); }
.bot-close {
    margin-left:auto; background:none; border:none; color:var(--text-muted);
    font-size:20px; cursor:pointer; padding:4px 8px; border-radius:6px;
}
.bot-close:hover { background:var(--bg-card); color:var(--text-primary); }

.bot-messages {
    flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px;
    scroll-behavior:smooth;
}
.bot-msg {
    max-width:88%; padding:12px 16px; border-radius:14px;
    font-size:13.5px; line-height:1.65; word-break:break-word;
}
.bot-msg.bot {
    align-self:flex-start; background:var(--bg-card); border:1px solid var(--border);
    border-bottom-left-radius:4px; color:var(--text-primary);
}
.bot-msg.user {
    align-self:flex-end; background:linear-gradient(135deg, #7c5cff, #6347e0);
    border-bottom-right-radius:4px; color:#fff;
}
.bot-msg.bot .bot-sources {
    margin-top:10px; padding-top:8px; border-top:1px solid var(--border);
    font-size:11px; color:var(--text-muted);
}

/* ── Bot Rich Content Styles ────────────────────────────────── */
.bot-msg.bot h3 {
    font-size:13.5px; font-weight:700; margin:14px 0 6px 0;
    color:var(--accent); letter-spacing:0.2px;
    padding-bottom:4px; border-bottom:1px solid var(--border);
}
.bot-msg.bot h3:first-child { margin-top:4px; }
.bot-msg.bot table {
    width:100%; border-collapse:collapse; margin:8px 0 12px;
    font-size:12px; line-height:1.5;
}
.bot-msg.bot thead th {
    text-align:left; padding:6px 8px; font-weight:600; font-size:11px;
    color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;
    border-bottom:2px solid var(--border); background:rgba(124,92,255,0.05);
}
.bot-msg.bot tbody td {
    padding:5px 8px; border-bottom:1px solid rgba(255,255,255,0.04);
    color:var(--text-secondary); font-size:12px;
}
.bot-msg.bot tbody tr:hover { background:rgba(124,92,255,0.04); }
.bot-msg.bot hr {
    border:none; border-top:1px solid var(--border); margin:12px 0;
}
.bot-msg.bot .bot-insight-box {
    background:rgba(124,92,255,0.06); border:1px solid rgba(124,92,255,0.15);
    border-radius:10px; padding:10px 14px; margin:8px 0;
    font-size:12.5px; line-height:1.6;
}
.bot-msg.bot .price-up { color:#10b981; font-weight:600; }
.bot-msg.bot .price-down { color:#ef4444; font-weight:600; }
.bot-msg.bot .metric-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:3px 0; border-bottom:1px solid rgba(255,255,255,0.03);
}
.bot-msg.bot .metric-label { color:var(--text-muted); font-size:12px; }
.bot-msg.bot .metric-value { color:var(--text-primary); font-weight:600; font-size:12.5px; }
.bot-msg.bot .bot-footer {
    margin-top:10px; padding-top:8px; border-top:1px solid var(--border);
    font-size:10.5px; color:var(--text-muted); font-style:italic; line-height:1.5;
}
.bot-typing {
    align-self:flex-start; padding:12px 18px; background:var(--bg-card);
    border:1px solid var(--border); border-radius:14px; border-bottom-left-radius:4px;
    display:none;
}
.bot-typing.show { display:flex; gap:5px; align-items:center; }
.bot-typing span {
    width:7px; height:7px; border-radius:50%; background:var(--text-muted);
    animation:botDot 1.4s infinite;
}
.bot-typing span:nth-child(2) { animation-delay:0.2s; }
.bot-typing span:nth-child(3) { animation-delay:0.4s; }
@keyframes botDot { 0%,60%,100% { opacity:0.3; transform:scale(0.8); } 30% { opacity:1; transform:scale(1.1); } }

.bot-input-area {
    padding:12px 16px; border-top:1px solid var(--border);
    display:flex; gap:8px; align-items:center; background:var(--bg-primary);
}
.bot-input-area input {
    flex:1; background:var(--bg-card); border:1px solid var(--border);
    border-radius:10px; padding:10px 14px; color:var(--text-primary);
    font-size:13.5px; outline:none;
}
.bot-input-area input:focus { border-color:var(--accent); }
.bot-input-area input::placeholder { color:var(--text-muted); }
.bot-send {
    width:38px; height:38px; border-radius:10px; border:none; cursor:pointer;
    background:linear-gradient(135deg, #7c5cff, #00d4aa); color:#fff;
    font-size:16px; display:flex; align-items:center; justify-content:center;
    transition:opacity 0.2s;
}
.bot-send:disabled { opacity:0.4; cursor:not-allowed; }
.bot-send:hover:not(:disabled) { opacity:0.9; }

.bot-suggestions {
    display:flex; flex-wrap:wrap; gap:6px; padding:0 16px 12px;
}
.bot-chip {
    padding:6px 12px; border-radius:20px; font-size:12px; cursor:pointer;
    background:var(--bg-card); border:1px solid var(--border); color:var(--text-secondary);
    transition:all 0.2s;
}
.bot-chip:hover { border-color:var(--accent); color:var(--accent); }
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- HEADER                                                     -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="header">
    <div class="logo" onclick="navigate('home')">PumpIQ</div>
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="home">Home</button>
        <button class="nav-tab" data-page="feed">Token Feed</button>
        <button class="nav-tab" data-page="ai">AI Recs</button>
        <button class="nav-tab" data-page="leaderboard">Leaderboard</button>
        <button class="nav-tab" data-page="market">Market</button>
        <button class="nav-tab" data-page="trader">🤖 Auto Trader</button>
    </div>
    <div class="header-right">
        <input class="search-box" id="globalSearch" placeholder="Search tokens..." onkeydown="if(event.key==='Enter')doSearch()">
        <div id="authArea">
            <button class="btn btn-primary" onclick="showAuthModal('login')">Login</button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- HOME PAGE                                                  -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page active" id="page-home">
    <div class="hero">
        <div class="hero-tag">AI-POWERED ANALYTICS</div>
        <h1 class="hero-title">See through the noise.</h1>
        <p class="hero-desc">
            PumpIQ scores every token across idea quality, on-chain health, and technical signals
            — so you can trade with signal, not hype.
        </p>
        <div class="hero-steps">
            <div class="step-card">
                <div class="step-num">01</div>
                <div class="step-title">Browse</div>
                <div class="step-desc">Live feed of all tokens on DexScreener with real-time data from Solana, Base, and more.</div>
            </div>
            <div class="step-card">
                <div class="step-num">02</div>
                <div class="step-title">Analyze</div>
                <div class="step-desc">AI evaluates on-chain health, holder behavior, technical indicators, and bonding curve math.</div>
            </div>
            <div class="step-card">
                <div class="step-num">03</div>
                <div class="step-title">Decide</div>
                <div class="step-desc">Get a PumpIQ Score (0-100), risk flags, and a one-line verdict for every token.</div>
            </div>
        </div>
    </div>

    <!-- Trending Pills -->
    <div style="margin-bottom:24px">
        <h3 style="font-size:16px;margin-bottom:12px;color:var(--text-secondary)">🔥 Trending</h3>
        <div id="trendingBar" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- Quick Market Table -->
    <div class="section-title">Top Coins</div>
    <div class="section-desc">Live market data from CoinGecko</div>
    <div style="overflow-x:auto">
        <table class="feed-table" id="homeMarketTable">
            <thead><tr><th>#</th><th>Token</th><th>Price</th><th>24h</th><th>Market Cap</th><th>Volume</th></tr></thead>
            <tbody id="homeMarketBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- TOKEN FEED PAGE                                            -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-feed">
    <div class="section-title">Token Feed</div>
    <div class="section-desc" id="feedCount">Live tokens from DexScreener</div>

    <div class="filter-bar">
        <div class="filter-pill active" data-sort="volume" onclick="setFeedSort(this)">Volume</div>
        <div class="filter-pill" data-sort="newest" onclick="setFeedSort(this)">Newest</div>
        <div class="filter-pill" data-sort="price" onclick="setFeedSort(this)">Price</div>
        <div class="filter-pill" data-sort="trades" onclick="setFeedSort(this)">Trades</div>
        <div style="width:1px;height:24px;background:var(--border);margin:0 8px"></div>
        <div class="filter-pill active" data-status="all" onclick="setFeedStatus(this)">All</div>
        <div class="filter-pill" data-status="active" onclick="setFeedStatus(this)">Active</div>
        <div class="filter-pill" data-status="graduated" onclick="setFeedStatus(this)">Graduated</div>
        <div style="flex:1"></div>
        <input class="search-box" style="width:180px" placeholder="Search feed..." oninput="filterFeedLocal(this.value)">
    </div>

    <div style="overflow-x:auto">
        <table class="feed-table">
            <thead><tr><th>Token</th><th>Price</th><th>24h</th><th>Volume</th><th>Liquidity</th><th>Trades</th><th>Age</th></tr></thead>
            <tbody id="feedBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- AI RECOMMENDATIONS PAGE                                    -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-ai">
    <div class="section-title">AI Recommendations</div>
    <div class="section-desc">Configure data sources and let AI find the best tokens right now.</div>

    <!-- CoinGecko Market Summary Mini -->
    <div class="market-summary-box" style="margin-bottom:16px">
        <h4>Global Market (CoinGecko)</h4>
        <p id="aiMarketGlobal">Loading market data...</p>
    </div>

    <!-- Toggles -->
    <div class="toggle-row">
        <div class="toggle-item">
            <div class="simple-toggle" id="toggleOnchain" onclick="toggleSwitch(this)"></div>
            <div>
                <div class="toggle-label">On-Chain</div>
                <div class="toggle-desc">Holders, volume, curve progress, creator activity</div>
            </div>
        </div>
        <div class="toggle-item">
            <div class="simple-toggle" id="toggleTechnical" onclick="toggleSwitch(this)"></div>
            <div>
                <div class="toggle-label">Technical</div>
                <div class="toggle-desc">Price momentum, trade velocity, trend direction</div>
            </div>
        </div>
    </div>

    <button class="btn btn-green" onclick="loadAIRecs()" style="margin-bottom:20px">Analyze</button>

    <div id="aiTimestamp" style="color:var(--text-muted);font-size:12px;margin-bottom:12px"></div>

    <!-- Market Summary -->
    <div class="market-summary-box" id="aiSummaryBox" style="display:none">
        <h4>Market Summary</h4>
        <p id="aiSummaryText"></p>
    </div>

    <!-- Scored Tokens -->
    <div class="cards-grid" id="aiCards"></div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- LEADERBOARD PAGE                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-leaderboard">
    <div class="section-title">Leaderboard</div>
    <div class="section-desc">Top traders by realized PnL on DexScreener</div>

    <div style="overflow-x:auto">
        <table class="lb-table">
            <thead><tr><th>#</th><th>Trader</th><th>PnL (USD)</th><th>Spent</th><th>Received</th><th>Trades</th><th>Win Rate</th></tr></thead>
            <tbody id="lbBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- MARKET PAGE (detailed CoinGecko)                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-market">
    <div class="section-title">Market Overview</div>
    <div class="section-desc">Top coins by market cap — click any row for deep analysis</div>

    <div id="trendingMarket" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px"></div>

    <div style="overflow-x:auto">
        <table class="feed-table">
            <thead><tr><th>#</th><th>Token</th><th>Price</th><th>24h</th><th>Market Cap</th><th>Volume 24h</th></tr></thead>
            <tbody id="marketBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- AUTO TRADER PAGE                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-trader">
    <div class="trader-header">
        <div>
            <div class="trader-title">🤖 Auto Trader <span>Live Trading</span></div>
            <div style="color:var(--text-secondary);font-size:13px;margin-top:4px">AI-powered autonomous trading using your real wallet balance</div>
        </div>
        <div style="display:flex;align-items:center;gap:16px">
            <div id="traderStatusBadge" class="trader-status inactive">● Inactive</div>
            <label class="toggle-switch">
                <input type="checkbox" id="autoTradeToggle" onchange="toggleAutoTrade()">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="trader-grid" style="grid-template-columns:repeat(4,1fr);margin-top:16px">
        <div class="trader-stat-card">
            <div class="trader-stat-label">Wallet Balance</div>
            <div class="trader-stat-value" id="traderBalance">$0</div>
            <div class="trader-stat-sub" id="traderReturn">0% return</div>
        </div>
        <div class="trader-stat-card">
            <div class="trader-stat-label">Total P&L</div>
            <div class="trader-stat-value" id="traderPnl">$0.00</div>
            <div class="trader-stat-sub" id="traderWinRate">Win rate: --</div>
        </div>
        <div class="trader-stat-card">
            <div class="trader-stat-label">Open Positions</div>
            <div class="trader-stat-value" id="traderOpenCount">0</div>
            <div class="trader-stat-sub" id="traderInvested">$0 invested</div>
        </div>
        <div class="trader-stat-card">
            <div class="trader-stat-label">Total Trades</div>
            <div class="trader-stat-value" id="traderTradeCount">0</div>
            <div class="trader-stat-sub" id="traderBestWorst">Best: -- | Worst: --</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="runTradeCycle()">⚡ Run Trade Cycle</button>
        <button class="btn btn-outline" onclick="runResearch()">🔍 Research Market</button>
        <button class="btn btn-outline" onclick="showManualBuyModal()">🛒 Manual Buy</button>
        <button class="btn btn-outline" onclick="showTraderSettings()">⚙️ Settings</button>
        <button class="btn btn-danger btn-sm" onclick="resetTrading()" style="margin-left:auto">🔄 Reset Stats</button>
    </div>

    <!-- Open Positions -->
    <div style="margin-top:24px">
        <h3 style="font-size:18px;margin-bottom:12px">📈 Open Positions</h3>
        <div id="traderPositions"><div class="empty-state"><p>No open positions</p></div></div>
    </div>

    <!-- AI Opportunities -->
    <div style="margin-top:24px">
        <h3 style="font-size:18px;margin-bottom:12px">🎯 AI Opportunities</h3>
        <div id="traderOpportunities"><div class="empty-state"><p>Click "Research Market" to find opportunities</p></div></div>
    </div>

    <!-- Trade History & Log tabs -->
    <div style="margin-top:24px">
        <div style="display:flex;gap:8px;margin-bottom:12px">
            <button class="btn btn-sm btn-outline" onclick="loadTraderHistory()" id="histTabBtn">📋 Trade History</button>
            <button class="btn btn-sm btn-outline" onclick="loadTraderLog()" id="logTabBtn">📝 AI Log</button>
            <button class="btn btn-sm btn-outline" onclick="loadClosedPositions()" id="closedTabBtn">📊 Closed Positions</button>
        </div>
        <div id="traderHistoryArea"></div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- PROFILE PAGE (visible when logged in)                      -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-profile">
    <div class="section-title" id="profileTitle">My Profile</div>
    <div class="section-desc" id="profileEmail"></div>

    <!-- Wallet Balance Card -->
    <div class="balance-card" style="margin-top:20px">
        <div class="balance-label">Wallet Balance</div>
        <div class="balance-amount"><span class="currency">$</span><span id="walletBalanceDisplay">0.00</span></div>
        <div class="balance-actions">
            <button class="btn btn-primary" onclick="showDepositModal()">+ Add Money</button>
            <button class="btn btn-outline" onclick="showWithdrawModal()">Withdraw</button>
            <button class="btn btn-outline" onclick="showTransactionsModal()">History</button>
        </div>
    </div>

    <!-- Bank Accounts -->
    <div style="margin-top:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:18px">🏦 Linked Bank Accounts</h3>
            <button class="btn btn-outline btn-sm" onclick="showBankModal()">+ Add Bank</button>
        </div>
        <div id="bankList"></div>
    </div>

    <!-- Wallets -->
    <div style="margin-top:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:18px">Connected Wallets</h3>
            <button class="btn btn-outline btn-sm" onclick="showWalletModal()">+ Add Wallet</button>
        </div>
        <div id="walletList"></div>
    </div>

    <!-- Portfolio -->
    <div style="margin-top:32px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:18px">Portfolio</h3>
            <button class="btn btn-outline btn-sm" onclick="showPortfolioModal()">+ Add Position</button>
        </div>
        <table class="portfolio-table">
            <thead><tr><th>Coin</th><th>Amount</th><th>Avg Price</th><th>Current</th><th>PnL</th></tr></thead>
            <tbody id="portfolioBody"></tbody>
        </table>
    </div>

    <!-- Watchlist -->
    <div style="margin-top:32px">
        <h3 style="font-size:18px;margin-bottom:12px">Watchlist</h3>
        <div id="watchlistArea"></div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- AUTH MODAL                                                 -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="authModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
        <h2 id="authTitle">Login</h2>
        <div id="authError" class="form-error"></div>

        <div id="registerFields" style="display:none">
            <div class="form-group">
                <label>Username</label>
                <input class="form-input" id="regUsername" placeholder="Choose a username">
            </div>
        </div>
        <div class="form-group">
            <label>Email</label>
            <input class="form-input" id="authEmail" type="email" placeholder="you@example.com">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input class="form-input" id="authPassword" type="password" placeholder="Min 6 characters">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px" id="authSubmitBtn" onclick="submitAuth()">Login</button>

        <p id="forgotPassLink" style="text-align:right;margin-top:8px;font-size:13px;">
            <a href="#" style="color:#7c5cff" onclick="showForgotPassword(event)">Forgot password?</a>
        </p>

        <div class="form-divider">or</div>
        <p style="text-align:center;font-size:13px;color:var(--text-secondary)">
            <span id="authToggleText">Don't have an account?</span>
            <a href="#" id="authToggleLink" onclick="toggleAuthMode(event)">Register</a>
        </p>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- FORGOT PASSWORD MODAL                                      -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="forgotModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('forgotModal')">&times;</button>
        <h2>Reset Password</h2>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Enter your email and we'll send you a reset link.</p>
        <div id="forgotError" class="form-error"></div>
        <div id="forgotSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>
        <div class="form-group">
            <label>Email</label>
            <input class="form-input" id="forgotEmail" type="email" placeholder="you@example.com">
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="submitForgotPassword()">Send Reset Link</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- WALLET ADD MODAL                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="walletModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('walletModal')">&times;</button>
        <h2>Connect Wallet</h2>
        <div class="form-group">
            <label>Wallet Address</label>
            <input class="form-input" id="walletAddr" placeholder="0x... or SOL address">
        </div>
        <div class="form-group">
            <label>Chain</label>
            <select class="form-input" id="walletChain">
                <option value="ethereum">Ethereum</option>
                <option value="solana">Solana</option>
                <option value="base">Base</option>
                <option value="polygon">Polygon</option>
                <option value="bsc">BSC</option>
            </select>
        </div>
        <div class="form-group">
            <label>Label (optional)</label>
            <input class="form-input" id="walletLabel" placeholder="e.g. My MetaMask">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addWallet()">Add Wallet</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- ADD BANK ACCOUNT MODAL                                     -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="bankModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('bankModal')">&times;</button>
        <h2>🏦 Link Bank Account</h2>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Your bank details are verified instantly and stored securely.</p>

        <div class="verify-steps" id="bankSteps">
            <div class="verify-step active" id="bankStep1">1. Enter Details</div>
            <div class="verify-step" id="bankStep2">2. Verify</div>
            <div class="verify-step" id="bankStep3">3. Linked ✓</div>
        </div>

        <div id="bankError" class="form-error"></div>
        <div id="bankSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>

        <div id="bankFormFields">
            <div class="form-group">
                <label>Account Holder Name</label>
                <input class="form-input" id="bankHolder" placeholder="As on bank passbook">
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input class="form-input" id="bankAccNum" placeholder="9-18 digit account number" maxlength="18">
            </div>
            <div class="form-group">
                <label>Confirm Account Number</label>
                <input class="form-input" id="bankAccNumConfirm" placeholder="Re-enter account number" maxlength="18">
            </div>
            <div class="form-group">
                <label>IFSC Code</label>
                <input class="form-input" id="bankIFSC" placeholder="e.g. SBIN0001234" maxlength="11" style="text-transform:uppercase">
            </div>
            <div class="form-group">
                <label>Bank Name</label>
                <input class="form-input" id="bankName" placeholder="e.g. State Bank of India">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="verifyAndAddBank()">Verify & Link Account</button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- DEPOSIT MODAL                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="depositModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('depositModal')">&times;</button>
        <h2>💰 Add Money to Wallet</h2>
        <div id="depositError" class="form-error"></div>
        <div id="depositSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>

        <div id="depositNoBanks" style="display:none;text-align:center;padding:20px;color:var(--text-muted);">
            <p>No bank account linked yet.</p>
            <button class="btn btn-primary" style="margin-top:12px" onclick="closeModal('depositModal');showBankModal()">Link Bank Account</button>
        </div>

        <div id="depositFields">
            <div class="form-group">
                <label>Select Bank Account</label>
                <select class="form-input" id="depositBank"></select>
            </div>
            <div class="form-group">
                <label>Amount ($)</label>
                <input class="form-input" id="depositAmount" type="number" min="1" step="any" placeholder="Enter amount">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(500)">$500</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(1000)">$1,000</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(5000)">$5,000</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(10000)">$10,000</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(50000)">$50,000</button>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="submitDeposit()">Deposit</button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- WITHDRAW MODAL                                             -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="withdrawModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('withdrawModal')">&times;</button>
        <h2>📤 Withdraw to Bank</h2>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">Available: <strong>$<span id="withdrawAvailable">0.00</span></strong></p>
        <div id="withdrawError" class="form-error"></div>
        <div id="withdrawSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>

        <div id="withdrawFields">
            <div class="form-group">
                <label>Select Bank Account</label>
                <select class="form-input" id="withdrawBank"></select>
            </div>
            <div class="form-group">
                <label>Amount ($)</label>
                <input class="form-input" id="withdrawAmount" type="number" min="1" step="any" placeholder="Enter amount">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="submitWithdraw()">Withdraw</button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- TRANSACTIONS MODAL                                         -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="transactionsModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('transactionsModal')">&times;</button>
        <h2>📋 Transaction History</h2>
        <div id="transactionsList" style="max-height:400px;overflow-y:auto;"></div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- PORTFOLIO ADD MODAL                                        -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="portfolioModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('portfolioModal')">&times;</button>
        <h2>Add Position</h2>
        <div class="form-group">
            <label>Coin ID (e.g. bitcoin, solana)</label>
            <input class="form-input" id="pfCoinId" placeholder="bitcoin">
        </div>
        <div class="form-group">
            <label>Amount</label>
            <input class="form-input" id="pfAmount" type="number" step="any" placeholder="0.5">
        </div>
        <div class="form-group">
            <label>Avg Buy Price ($)</label>
            <input class="form-input" id="pfPrice" type="number" step="any" placeholder="65000">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addPortfolioItem()">Add Position</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- TOKEN DETAIL MODAL                                         -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="detailModal">
    <div class="modal modal-lg">
        <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
        <div id="detailContent"><div class="loader"><div class="spinner"></div></div></div>
    </div>
</div>


<!-- ═══════════════════════════════════════════════════════════ -->
<!-- JAVASCRIPT                                                 -->
<!-- ═══════════════════════════════════════════════════════════ -->
<script>
// ── State ─────────────────────────────────────────────────────
let currentUser = null;
let authToken = localStorage.getItem('pumpiq_token') || null;
let currentPage = 'home';
let feedSort = 'volume';
let feedStatus = 'all';
let feedData = [];

const API = '';

async function api(path, opts = {}) {
    const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
    if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
    const resp = await fetch(API + path, { ...opts, headers });
    if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || resp.statusText);
    }
    return resp.json();
}

function fmt(n) {
    if (n == null || isNaN(n)) return '-';
    if (n >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
    if (n >= 1e3) return '$' + (n/1e3).toFixed(2) + 'K';
    if (n >= 1) return '$' + n.toFixed(2);
    if (n >= 0.001) return '$' + n.toFixed(4);
    return '$' + n.toFixed(8);
}

function fmtPct(n) {
    if (n == null) return '-';
    const cls = n >= 0 ? 'price-positive' : 'price-negative';
    const arrow = n >= 0 ? '▲' : '▼';
    return `<span class="${cls}">${arrow} ${Math.abs(n).toFixed(2)}%</span>`;
}

function scoreColor(s) {
    if (s >= 7) return 'green'; if (s >= 4) return 'yellow'; return 'red';
}

// ── Navigation ────────────────────────────────────────────────
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => navigate(tab.dataset.page));
});

function navigate(page) {
    if (page === 'profile' && !currentUser) {
        showAuthModal('login');
        return;
    }
    currentPage = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page)?.classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.page === page);
    });

    // Load data for page
    if (page === 'home') { loadHomeData(); }
    else if (page === 'feed') { loadFeed(); }
    else if (page === 'ai') { loadAIGlobal(); }
    else if (page === 'leaderboard') { loadLeaderboard(); }
    else if (page === 'market') { loadMarket(); }
    else if (page === 'trader') { loadTraderDashboard(); }
    else if (page === 'profile') { loadProfile(); }
}

// ── Auth ──────────────────────────────────────────────────────
let authMode = 'login';

function showAuthModal(mode) {
    authMode = mode;
    document.getElementById('authTitle').textContent = mode === 'login' ? 'Login' : 'Create Account';
    document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Login' : 'Register';
    document.getElementById('registerFields').style.display = mode === 'register' ? 'block' : 'none';
    document.getElementById('forgotPassLink').style.display = mode === 'login' ? 'block' : 'none';
    document.getElementById('authToggleText').textContent = mode === 'login' ? "Don't have an account?" : "Already have an account?";
    document.getElementById('authToggleLink').textContent = mode === 'login' ? 'Register' : 'Login';
    document.getElementById('authError').style.display = 'none';
    document.getElementById('authModal').classList.add('active');
}

function toggleAuthMode(e) {
    e.preventDefault();
    showAuthModal(authMode === 'login' ? 'register' : 'login');
}

async function submitAuth() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    const errEl = document.getElementById('authError');

    try {
        let data;
        if (authMode === 'login') {
            data = await api('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password }),
            });
        } else {
            const username = document.getElementById('regUsername').value;
            data = await api('/api/auth/register', {
                method: 'POST',
                body: JSON.stringify({ email, password, username }),
            });
        }

        authToken = data.access_token;
        localStorage.setItem('pumpiq_token', authToken);
        currentUser = data.user;
        updateAuthUI();
        closeModal('authModal');
    } catch (e) {
        errEl.style.color = '#ff4d4d';
        errEl.textContent = e.message;
        errEl.style.display = 'block';
    }
}

// ── Forgot Password ──────────────────────────────────────────
function showForgotPassword(e) {
    e.preventDefault();
    closeModal('authModal');
    document.getElementById('forgotError').style.display = 'none';
    document.getElementById('forgotSuccess').style.display = 'none';
    document.getElementById('forgotEmail').value = document.getElementById('authEmail').value || '';
    document.getElementById('forgotModal').classList.add('active');
}

async function submitForgotPassword() {
    const email = document.getElementById('forgotEmail').value;
    const errEl = document.getElementById('forgotError');
    const succEl = document.getElementById('forgotSuccess');
    errEl.style.display = 'none';
    succEl.style.display = 'none';

    if (!email) { errEl.textContent = 'Please enter your email'; errEl.style.display = 'block'; return; }

    try {
        const data = await api('/api/auth/forgot-password', {
            method: 'POST',
            body: JSON.stringify({ email }),
        });
        succEl.textContent = data.message;
        succEl.style.display = 'block';
    } catch (e) {
        errEl.textContent = e.message;
        errEl.style.display = 'block';
    }
}

// ── Resend Verification ──────────────────────────────────────
async function resendVerification() {
    try {
        const data = await api('/api/auth/resend-verification', { method: 'POST' });
        alert(data.message || 'Verification email sent!');
    } catch (e) {
        alert(e.message || 'Failed to send verification email');
    }
}

async function resendVerificationFromLogin(email) {
    const errEl = document.getElementById('authError');
    try {
        const data = await api('/api/auth/resend-verification-by-email', {
            method: 'POST',
            body: JSON.stringify({ email }),
        });
        errEl.style.color = '#00d4aa';
        errEl.innerHTML = data.message || 'Verification email sent! Check your inbox.';
    } catch (e) {
        errEl.innerHTML = e.message || 'Failed to resend';
    }
}

function logout() {
    authToken = null;
    currentUser = null;
    localStorage.removeItem('pumpiq_token');
    updateAuthUI();
    navigate('home');
}

function updateAuthUI() {
    const area = document.getElementById('authArea');
    if (currentUser) {
        const initials = (currentUser.username || currentUser.email).slice(0, 2).toUpperCase();
        area.innerHTML = `
            <div class="user-badge" onclick="navigate('profile')">
                <div class="user-avatar">${initials}</div>
                <span>${currentUser.username || currentUser.email}</span>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()">Logout</button>
        `;
    } else {
        area.innerHTML = '<button class="btn btn-primary" onclick="showAuthModal(\'login\')">Login</button>';
    }
}

async function checkAuth() {
    if (!authToken) return;
    try {
        currentUser = await api('/api/auth/me');
        updateAuthUI();
    } catch {
        authToken = null;
        localStorage.removeItem('pumpiq_token');
    }
}

// ── Modals ────────────────────────────────────────────────────
function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// Close modals on backdrop click
document.querySelectorAll('.modal-overlay').forEach(ov => {
    ov.addEventListener('click', e => {
        if (e.target === ov) ov.classList.remove('active');
    });
});

// ── Wallet ────────────────────────────────────────────────────
function showWalletModal() {
    document.getElementById('walletModal').classList.add('active');
}

async function addWallet() {
    const address = document.getElementById('walletAddr').value;
    const chain = document.getElementById('walletChain').value;
    const label = document.getElementById('walletLabel').value;
    if (!address) return;
    try {
        await api('/api/wallet/add', {
            method: 'POST',
            body: JSON.stringify({ address, chain, label }),
        });
        closeModal('walletModal');
        loadProfile();
    } catch (e) {
        alert(e.message);
    }
}

async function removeWallet(addr, chain) {
    try {
        await api(`/api/wallet/${encodeURIComponent(addr)}?chain=${chain}`, { method: 'DELETE' });
        loadProfile();
    } catch (e) {
        alert(e.message);
    }
}

// ── Bank Accounts ──────────────────────────────────────────────
function showBankModal() {
    document.getElementById('bankError').style.display = 'none';
    document.getElementById('bankSuccess').style.display = 'none';
    document.getElementById('bankFormFields').style.display = 'block';
    document.getElementById('bankStep1').className = 'verify-step active';
    document.getElementById('bankStep2').className = 'verify-step';
    document.getElementById('bankStep3').className = 'verify-step';
    ['bankHolder','bankAccNum','bankAccNumConfirm','bankIFSC','bankName'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('bankModal').classList.add('active');
}

// Auto-detect bank from IFSC
document.addEventListener('DOMContentLoaded', () => {
    const ifscEl = document.getElementById('bankIFSC');
    if (ifscEl) {
        ifscEl.addEventListener('input', function() {
            const prefix = this.value.toUpperCase().substring(0, 4);
            const banks = {
                'SBIN':'State Bank of India','HDFC':'HDFC Bank','ICIC':'ICICI Bank',
                'UTIB':'Axis Bank','PUNB':'Punjab National Bank','CNRB':'Canara Bank',
                'UBIN':'Union Bank of India','BARB':'Bank of Baroda','KKBK':'Kotak Mahindra Bank',
                'YESB':'Yes Bank','INDB':'IndusInd Bank','FDRL':'Federal Bank',
                'IOBA':'Indian Overseas Bank','IDIB':'Indian Bank','BKID':'Bank of India',
            };
            if (banks[prefix]) document.getElementById('bankName').value = banks[prefix];
        });
    }
});

async function verifyAndAddBank() {
    const holder = document.getElementById('bankHolder').value.trim();
    const accNum = document.getElementById('bankAccNum').value.trim();
    const accConfirm = document.getElementById('bankAccNumConfirm').value.trim();
    const ifsc = document.getElementById('bankIFSC').value.trim().toUpperCase();
    const bankName = document.getElementById('bankName').value.trim();
    const errEl = document.getElementById('bankError');
    const successEl = document.getElementById('bankSuccess');
    errEl.style.display = 'none';
    successEl.style.display = 'none';

    // Client-side checks
    if (!holder || !accNum || !ifsc || !bankName) {
        errEl.textContent = 'All fields are required'; errEl.style.display = 'block'; return;
    }
    if (accNum !== accConfirm) {
        errEl.textContent = 'Account numbers do not match'; errEl.style.display = 'block'; return;
    }

    // Step 2: Verifying
    document.getElementById('bankStep1').className = 'verify-step done';
    document.getElementById('bankStep2').className = 'verify-step active';

    try {
        // Verify first
        const verifyResult = await api('/api/bank/verify', {
            method: 'POST',
            body: JSON.stringify({ account_holder: holder, account_number: accNum, ifsc_code: ifsc, bank_name: bankName }),
        });
        if (!verifyResult.verified) {
            document.getElementById('bankStep2').className = 'verify-step';
            document.getElementById('bankStep1').className = 'verify-step active';
            errEl.textContent = verifyResult.errors.join(', '); errEl.style.display = 'block'; return;
        }

        // Add the account
        const addResult = await api('/api/bank/add', {
            method: 'POST',
            body: JSON.stringify({ account_holder: holder, account_number: accNum, ifsc_code: ifsc, bank_name: bankName }),
        });

        document.getElementById('bankStep2').className = 'verify-step done';
        document.getElementById('bankStep3').className = 'verify-step done';
        document.getElementById('bankFormFields').style.display = 'none';
        successEl.innerHTML = `✅ <strong>${addResult.bank_name}</strong> account ending in ****${addResult.last4} linked successfully!`;
        successEl.style.display = 'block';

        // Refresh profile after delay
        setTimeout(() => { closeModal('bankModal'); loadProfile(); }, 2000);
    } catch (e) {
        document.getElementById('bankStep2').className = 'verify-step';
        document.getElementById('bankStep1').className = 'verify-step active';
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function removeBank(bankId) {
    if (!confirm('Remove this bank account?')) return;
    try {
        await api(`/api/bank/${bankId}`, { method: 'DELETE' });
        loadProfile();
    } catch (e) { alert(e.message); }
}

// ── Deposit / Withdraw ─────────────────────────────────────────
function populateBankSelect(selectId) {
    const sel = document.getElementById(selectId);
    const banks = (currentUser && currentUser.bank_accounts) || [];
    sel.innerHTML = banks.filter(b => b.verified)
        .map(b => `<option value="${b.id}">${b.bank_name} ••••${b.account_last4}</option>`)
        .join('');
    return banks.filter(b => b.verified).length;
}

function showDepositModal() {
    document.getElementById('depositError').style.display = 'none';
    document.getElementById('depositSuccess').style.display = 'none';
    document.getElementById('depositAmount').value = '';
    const count = populateBankSelect('depositBank');
    document.getElementById('depositNoBanks').style.display = count === 0 ? 'block' : 'none';
    document.getElementById('depositFields').style.display = count > 0 ? 'block' : 'none';
    document.getElementById('depositModal').classList.add('active');
}

function showWithdrawModal() {
    document.getElementById('withdrawError').style.display = 'none';
    document.getElementById('withdrawSuccess').style.display = 'none';
    document.getElementById('withdrawAmount').value = '';
    document.getElementById('withdrawAvailable').textContent = formatUSD(currentUser?.wallet_balance || 0);
    populateBankSelect('withdrawBank');
    document.getElementById('withdrawModal').classList.add('active');
}

function setDepositAmount(amt) {
    document.getElementById('depositAmount').value = amt;
}

function formatUSD(n) {
    return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

async function submitDeposit() {
    const amount = parseFloat(document.getElementById('depositAmount').value);
    const bank_id = parseInt(document.getElementById('depositBank').value);
    const errEl = document.getElementById('depositError');
    const successEl = document.getElementById('depositSuccess');
    errEl.style.display = 'none'; successEl.style.display = 'none';

    if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; errEl.style.display = 'block'; return; }

    try {
        const res = await api('/api/wallet/deposit', {
            method: 'POST',
            body: JSON.stringify({ amount, bank_id }),
        });
        successEl.innerHTML = `✅ $${formatUSD(amount)} deposited successfully! New balance: <strong>$${formatUSD(res.new_balance)}</strong>`;
        successEl.style.display = 'block';
        document.getElementById('depositFields').style.display = 'none';
        // Update local state
        if (currentUser) currentUser.wallet_balance = res.new_balance;
        document.getElementById('walletBalanceDisplay').textContent = formatUSD(res.new_balance);
        setTimeout(() => { closeModal('depositModal'); document.getElementById('depositFields').style.display = 'block'; }, 2500);
    } catch (e) {
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function submitWithdraw() {
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    const bank_id = parseInt(document.getElementById('withdrawBank').value);
    const errEl = document.getElementById('withdrawError');
    const successEl = document.getElementById('withdrawSuccess');
    errEl.style.display = 'none'; successEl.style.display = 'none';

    if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; errEl.style.display = 'block'; return; }

    try {
        const res = await api('/api/wallet/withdraw', {
            method: 'POST',
            body: JSON.stringify({ amount, bank_id }),
        });
        successEl.innerHTML = `✅ $${formatUSD(amount)} withdrawal initiated. New balance: <strong>$${formatUSD(res.new_balance)}</strong>`;
        successEl.style.display = 'block';
        document.getElementById('withdrawFields').style.display = 'none';
        if (currentUser) currentUser.wallet_balance = res.new_balance;
        document.getElementById('walletBalanceDisplay').textContent = formatUSD(res.new_balance);
        setTimeout(() => { closeModal('withdrawModal'); document.getElementById('withdrawFields').style.display = 'block'; }, 2500);
    } catch (e) {
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function showTransactionsModal() {
    document.getElementById('transactionsModal').classList.add('active');
    const list = document.getElementById('transactionsList');
    list.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
    try {
        const txns = await api('/api/wallet/transactions?limit=30');
        if (txns.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No transactions yet</p></div>';
            return;
        }
        list.innerHTML = txns.map(t => `
            <div class="txn-item">
                <div>
                    <span class="txn-type ${t.type === 'deposit' ? 'txn-deposit' : 'txn-withdraw'}">
                        ${t.type === 'deposit' ? '⬆ Deposit' : '⬇ Withdraw'}
                    </span>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${t.description}</div>
                    <div style="font-size:11px;color:var(--text-muted)">${new Date(t.created_at).toLocaleString()}</div>
                </div>
                <div class="txn-amount" style="color:${t.type === 'deposit' ? '#00d4aa' : '#ff6b6b'}">
                    ${t.type === 'deposit' ? '+' : '-'}$${formatUSD(t.amount)}
                </div>
            </div>
        `).join('');
    } catch (e) {
        list.innerHTML = `<div class="empty-state"><p>Error loading transactions</p></div>`;
    }
}

// ── Portfolio ─────────────────────────────────────────────────
function showPortfolioModal() {
    document.getElementById('portfolioModal').classList.add('active');
}

async function addPortfolioItem() {
    const coin_id = document.getElementById('pfCoinId').value;
    const amount = parseFloat(document.getElementById('pfAmount').value);
    const avg_price = parseFloat(document.getElementById('pfPrice').value);
    if (!coin_id || isNaN(amount)) return;
    try {
        await api(`/api/portfolio?coin_id=${encodeURIComponent(coin_id)}&amount=${amount}&avg_price=${avg_price}`, {
            method: 'POST',
        });
        closeModal('portfolioModal');
        loadProfile();
    } catch (e) {
        alert(e.message);
    }
}

// ── Profile ───────────────────────────────────────────────────
async function loadProfile() {
    if (!currentUser) return;
    document.getElementById('profileTitle').textContent = currentUser.username + "'s Profile";
    document.getElementById('profileEmail').textContent = currentUser.email;

    // Email verification banner
    let verifyBanner = document.getElementById('verifyBanner');
    if (!verifyBanner) {
        verifyBanner = document.createElement('div');
        verifyBanner.id = 'verifyBanner';
        document.getElementById('profileEmail').after(verifyBanner);
    }
    if (currentUser.email_verified) {
        verifyBanner.innerHTML = '<span style="color:#00d4aa;font-size:13px;">\u2705 Email verified</span>';
    } else {
        verifyBanner.innerHTML = '<div style="background:#2a1a00;border:1px solid #ff9900;border-radius:8px;padding:10px 16px;margin-top:8px;font-size:13px;color:#ffcc00;">'
            + '\u26A0\uFE0F Email not verified &mdash; <a href="#" style="color:#7c5cff;" onclick="resendVerification()">Resend verification email</a></div>';
    }

    // Wallet Balance
    document.getElementById('walletBalanceDisplay').textContent = formatUSD(currentUser.wallet_balance || 0);

    // Bank Accounts
    const banks = currentUser.bank_accounts || [];
    const bl = document.getElementById('bankList');
    if (banks.length === 0) {
        bl.innerHTML = '<div class="empty-state" style="padding:20px"><p>No bank accounts linked yet</p><p style="font-size:12px;margin-top:4px">Link a bank account to add money to your wallet</p></div>';
    } else {
        bl.innerHTML = banks.map(b => `
            <div class="bank-card">
                <div class="bank-info">
                    <div class="bank-icon">${b.bank_name.charAt(0)}</div>
                    <div>
                        <div class="bank-name">${b.bank_name}</div>
                        <div class="bank-detail">${b.account_holder} &bull; ****${b.account_last4} &bull; ${b.ifsc_code}</div>
                        <span class="bank-verified">${b.verified ? '\u2705 Verified' : '\u23f3 Pending'}</span>
                    </div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeBank(${b.id})">Remove</button>
            </div>
        `).join('');
    }

    // Wallets
    const wallets = currentUser.wallets || [];
    const wl = document.getElementById('walletList');
    if (wallets.length === 0) {
        wl.innerHTML = '<div class="empty-state"><p>No wallets connected yet</p></div>';
    } else {
        wl.innerHTML = wallets.map(w => `
            <div class="wallet-card">
                <div>
                    <span class="wallet-addr">${w.address}</span>
                    <span class="wallet-chain">${w.chain}</span>
                    ${w.label ? '<span style="color:var(--text-muted);font-size:12px;margin-left:8px">' + w.label + '</span>' : ''}
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeWallet('${w.address}','${w.chain}')">Remove</button>
            </div>
        `).join('');
    }

    // Portfolio
    try {
        const portfolio = await api('/api/portfolio');
        const pb = document.getElementById('portfolioBody');
        if (portfolio.length === 0) {
            pb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px">No positions yet</td></tr>';
        } else {
            pb.innerHTML = portfolio.map(p => `
                <tr>
                    <td style="font-weight:600">${p.coin_id.toUpperCase()}</td>
                    <td>${p.amount}</td>
                    <td>${fmt(p.avg_buy_price)}</td>
                    <td>${fmt(p.current_price)}</td>
                    <td class="${p.pnl >= 0 ? 'price-positive' : 'price-negative'}">${p.pnl >= 0 ? '+' : ''}${fmt(p.pnl)} (${p.pnl_pct.toFixed(1)}%)</td>
                </tr>
            `).join('');
        }
    } catch (e) {
        console.error('Portfolio error:', e);
    }

    // Watchlist
    const wlArea = document.getElementById('watchlistArea');
    const wlist = currentUser.watchlist || [];
    if (wlist.length === 0) {
        wlArea.innerHTML = '<div class="empty-state"><p>Watchlist empty — click ★ on any token to add</p></div>';
    } else {
        wlArea.innerHTML = wlist.map(c => `
            <span class="filter-pill" style="cursor:pointer" onclick="openToken('${c}','${c}')">${c}</span>
        `).join(' ');
    }
}

// ── Home Data ─────────────────────────────────────────────────
async function loadHomeData() {
    try {
        const [coins, trending] = await Promise.all([
            api('/api/market/top?limit=10'),
            api('/api/market/trending'),
        ]);

        // Trending bar
        const bar = document.getElementById('trendingBar');
        bar.innerHTML = trending.map(t => `
            <div class="filter-pill" style="cursor:pointer" onclick="openToken('${t.coin_id}','${t.name}')">
                🔥 ${t.name} <span style="color:var(--text-muted)">${t.symbol}</span>
            </div>
        `).join('');

        // Market table
        const body = document.getElementById('homeMarketBody');
        body.innerHTML = coins.map(c => `
            <tr style="cursor:pointer" onclick="openToken('${c.coin_id}','${c.name}')">
                <td>${c.rank || '-'}</td>
                <td>
                    <div class="token-info">
                        <div class="token-icon">${c.symbol.slice(0,2)}</div>
                        <div><div class="token-name">${c.name}</div><div class="token-symbol">${c.symbol}</div></div>
                    </div>
                </td>
                <td>${fmt(c.price)}</td>
                <td>${fmtPct(c.price_change_24h)}</td>
                <td>${fmt(c.market_cap)}</td>
                <td>${fmt(c.volume_24h)}</td>
            </tr>
        `).join('');
    } catch (e) {
        console.error('Home data error:', e);
    }
}

// ── Token Feed ────────────────────────────────────────────────
function setFeedSort(el) {
    document.querySelectorAll('[data-sort]').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    feedSort = el.dataset.sort;
    loadFeed();
}

function setFeedStatus(el) {
    document.querySelectorAll('[data-status]').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    feedStatus = el.dataset.status;
    loadFeed();
}

async function loadFeed() {
    const body = document.getElementById('feedBody');
    body.innerHTML = '<tr><td colspan="7"><div class="loader"><div class="spinner"></div></div></td></tr>';

    try {
        feedData = await api(`/api/feed/tokens?sort=${feedSort}&status=${feedStatus}&limit=50`);
        document.getElementById('feedCount').textContent = `${feedData.length} tokens on DexScreener`;
        renderFeed(feedData);
    } catch (e) {
        body.innerHTML = `<tr><td colspan="7" class="empty-state">${e.message}</td></tr>`;
    }
}

function renderFeed(data) {
    const body = document.getElementById('feedBody');
    body.innerHTML = data.map(t => `
        <tr style="cursor:pointer" onclick="window.open('https://dexscreener.com/solana/${t.address}','_blank')">
            <td>
                <div class="token-info">
                    <div class="token-icon">${t.symbol.slice(0,2)}</div>
                    <div>
                        <div class="token-name">${t.name}</div>
                        <div class="token-symbol">$${t.symbol}</div>
                    </div>
                </div>
            </td>
            <td>${fmt(t.price)}</td>
            <td>${fmtPct(t.price_change_24h)}</td>
            <td>${fmt(t.volume_24h)}</td>
            <td>${fmt(t.liquidity)}</td>
            <td>${t.trades_count}</td>
            <td style="color:var(--text-muted)">${t.age || '-'}</td>
        </tr>
    `).join('');
}

function filterFeedLocal(q) {
    if (!q) return renderFeed(feedData);
    const f = feedData.filter(t => t.name.toLowerCase().includes(q.toLowerCase()) || t.symbol.toLowerCase().includes(q.toLowerCase()));
    renderFeed(f);
}

// ── AI Recommendations ────────────────────────────────────────
async function loadAIGlobal() {
    try {
        const coins = await api('/api/market/top?limit=3');
        const txt = coins.map(c => `${c.name}: ${fmt(c.price)} (${c.price_change_24h >= 0 ? '+' : ''}${c.price_change_24h.toFixed(2)}%)`).join(' | ');
        document.getElementById('aiMarketGlobal').textContent = txt;
    } catch {
        document.getElementById('aiMarketGlobal').innerHTML = '<span style="color:var(--red)">Failed to load market data.</span>';
    }
}

function toggleSwitch(el) {
    el.classList.toggle('off');
}

async function loadAIRecs() {
    const onchain = !document.getElementById('toggleOnchain').classList.contains('off');
    const technical = !document.getElementById('toggleTechnical').classList.contains('off');
    const cards = document.getElementById('aiCards');
    cards.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
    document.getElementById('aiSummaryBox').style.display = 'none';

    try {
        const data = await api(`/api/ai/recommendations?enable_onchain=${onchain}&enable_technical=${technical}`);

        document.getElementById('aiTimestamp').textContent = `Results from ${new Date(data.timestamp).toLocaleString()}`;
        document.getElementById('aiSummaryText').textContent = data.market_summary;
        document.getElementById('aiSummaryBox').style.display = 'block';

        cards.innerHTML = data.tokens.map(t => {
            const sColor = t.score >= 70 ? 'score-green' : (t.score >= 40 ? 'score-yellow' : 'score-red');
            const vClass = 'verdict-' + t.verdict.replace(' ', '_');

            let barsHtml = '';
            if (t.on_chain && Object.keys(t.on_chain).length) {
                barsHtml = '<div class="on-chain-bars">';
                for (const [k, v] of Object.entries(t.on_chain)) {
                    const pct = Math.min(100, (v / 25) * 100);
                    barsHtml += `
                        <div class="bar-row">
                            <div class="bar-label">${k.replace(/_/g,' ')}</div>
                            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
                        </div>`;
                }
                barsHtml += '</div>';
            }

            return `
                <div class="score-card">
                    <div class="score-circle ${sColor}">${t.score}</div>
                    <div class="score-card-name">${t.name}</div>
                    <div class="score-card-sym">$${t.symbol}</div>
                    <div class="score-card-summary">${t.summary}</div>
                    <span class="verdict-badge ${vClass}">${t.verdict}</span>
                    ${t.risk_flags.length ? '<div style="margin-top:8px;font-size:12px;color:var(--red)">⚠ ' + t.risk_flags.join(', ') + '</div>' : ''}
                    ${barsHtml}
                </div>
            `;
        }).join('');
    } catch (e) {
        cards.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${e.message}</p></div>`;
    }
}

// ── Leaderboard ───────────────────────────────────────────────
async function loadLeaderboard() {
    const body = document.getElementById('lbBody');
    body.innerHTML = '<tr><td colspan="7"><div class="loader"><div class="spinner"></div></div></td></tr>';

    try {
        const entries = await api('/api/leaderboard?limit=25');
        body.innerHTML = entries.map(e => `
            <tr>
                <td>${e.rank}</td>
                <td class="trader-addr">${e.trader}</td>
                <td class="${e.pnl >= 0 ? 'price-positive' : 'price-negative'}" style="font-weight:600">
                    ${e.pnl >= 0 ? '+' : ''}${fmt(e.pnl)}
                </td>
                <td>${fmt(e.spent)}</td>
                <td>${fmt(e.received)}</td>
                <td>${e.trades}</td>
                <td>${e.win_rate}%</td>
            </tr>
        `).join('');
    } catch (e) {
        body.innerHTML = `<tr><td colspan="7" class="empty-state">${e.message}</td></tr>`;
    }
}

// ── Market Page ───────────────────────────────────────────────
async function loadMarket() {
    const body = document.getElementById('marketBody');
    body.innerHTML = '<tr><td colspan="6"><div class="loader"><div class="spinner"></div></div></td></tr>';

    try {
        const [coins, trending] = await Promise.all([
            api('/api/market/top?limit=50'),
            api('/api/market/trending'),
        ]);

        // Trending
        document.getElementById('trendingMarket').innerHTML = trending.map(t => `
            <div class="filter-pill" style="cursor:pointer" onclick="openToken('${t.coin_id}','${t.name}')">
                🔥 ${t.name}
            </div>
        `).join('');

        body.innerHTML = coins.map(c => `
            <tr style="cursor:pointer" onclick="openToken('${c.coin_id}','${c.name}')">
                <td>${c.rank || '-'}</td>
                <td>
                    <div class="token-info">
                        <div class="token-icon">${c.symbol.slice(0,2)}</div>
                        <div><div class="token-name">${c.name}</div><div class="token-symbol">${c.symbol}</div></div>
                    </div>
                </td>
                <td>${fmt(c.price)}</td>
                <td>${fmtPct(c.price_change_24h)}</td>
                <td>${fmt(c.market_cap)}</td>
                <td>${fmt(c.volume_24h)}</td>
            </tr>
        `).join('');
    } catch (e) {
        body.innerHTML = `<tr><td colspan="6" class="empty-state">${e.message}</td></tr>`;
    }
}

// ── Token Detail ──────────────────────────────────────────────
async function openToken(coinId, name) {
    const modal = document.getElementById('detailModal');
    const content = document.getElementById('detailContent');
    modal.classList.add('active');
    content.innerHTML = '<div class="loader"><div class="spinner"></div></div>';

    try {
        const d = await api('/api/token/' + encodeURIComponent(coinId));
        const chgCls = d.price_change_24h >= 0 ? 'price-positive' : 'price-negative';

        let html = `
        <div class="detail-header">
            <div class="detail-avatar">${d.symbol.slice(0,2)}</div>
            <div>
                <div class="detail-name">${d.name}</div>
                <div class="detail-symbol">${d.symbol}${d.rank ? ' · Rank #' + d.rank : ''}</div>
            </div>
            ${currentUser ? '<button class="btn btn-sm btn-outline" style="margin-left:auto" onclick="addWatchlist(\'' + coinId + '\')">★ Watch</button>' : ''}
        </div>

        <div class="detail-price-row">
            <span class="detail-price">${fmt(d.price)}</span>
            <span class="${chgCls}" style="font-size:18px;font-weight:600">
                ${d.price_change_24h >= 0 ? '▲' : '▼'} ${Math.abs(d.price_change_24h).toFixed(2)}% (24h)
            </span>
        </div>

        <div class="metrics-grid">
            <div class="metric-box"><div class="metric-label">Market Cap</div><div class="metric-value">${fmt(d.market_cap)}</div></div>
            <div class="metric-box"><div class="metric-label">Volume 24h</div><div class="metric-value">${fmt(d.volume_24h)}</div></div>
            <div class="metric-box"><div class="metric-label">All-Time High</div><div class="metric-value">${fmt(d.ath)}</div></div>
        </div>`;

        // TA
        if (d.ta_trend && d.ta_trend !== 'unknown') {
            const taColor = scoreColor(d.ta_score);
            html += `
            <div class="analysis-section">
                <div class="analysis-title">📊 Technical Analysis</div>
                <div class="analysis-row"><span>Score</span><span>${d.ta_score.toFixed(1)} / 10</span></div>
                <div class="score-bar-container"><div class="score-bar ${taColor}" style="width:${d.ta_score*10}%"></div></div>
                <div class="analysis-row" style="margin-top:10px"><span>Trend</span><span>${d.ta_trend}</span></div>
                <div class="analysis-row"><span>RSI (14)</span><span>${d.ta_rsi.toFixed(1)} (${d.ta_rsi_label})</span></div>
                <div class="analysis-row"><span>MACD</span><span>${d.ta_macd}</span></div>
                <div class="analysis-row"><span>Pattern</span><span>${d.ta_pattern || 'None'}</span></div>
                <div class="analysis-row"><span>Support</span><span>${fmt(d.ta_support)}</span></div>
                <div class="analysis-row"><span>Resistance</span><span>${fmt(d.ta_resistance)}</span></div>
            </div>`;
        }

        // News
        const newsColor = scoreColor(d.news_score);
        html += `
        <div class="analysis-section">
            <div class="analysis-title">📰 News & Sentiment</div>
            <div class="analysis-row"><span>Score</span><span>${d.news_score.toFixed(1)} / 10</span></div>
            <div class="score-bar-container"><div class="score-bar ${newsColor}" style="width:${d.news_score*10}%"></div></div>
            <div class="analysis-row" style="margin-top:10px"><span>Narrative</span><span>${d.news_narrative || 'Neutral'}</span></div>
        </div>`;

        if (d.news_headlines?.length) {
            html += '<div class="analysis-section"><div class="analysis-title">📌 Headlines</div>';
            d.news_headlines.forEach(h => {
                html += `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0;border-bottom:1px solid var(--border)">• ${h}</div>`;
            });
            html += '</div>';
        }

        // AI
        if (d.ai_available && d.ai_recommendation) {
            html += `
            <div class="ai-box">
                <div class="ai-box-title">🤖 AI Recommendation <span class="ai-badge">GEMINI</span></div>
                <div class="ai-text">${d.ai_recommendation}</div>
            </div>`;
        } else {
            html += `
            <div class="ai-box" style="opacity:0.6">
                <div class="ai-box-title">🤖 AI Recommendation <span class="ai-badge" style="background:var(--text-muted)">OFFLINE</span></div>
                <div class="ai-text">AI analysis unavailable. Set a GEMINI_API_KEY with quota to enable.</div>
            </div>`;
        }

        content.innerHTML = html;
    } catch (e) {
        content.innerHTML = `<div class="empty-state"><h3>Error loading token</h3><p>${e.message}</p></div>`;
    }
}

async function addWatchlist(coinId) {
    if (!currentUser) return showAuthModal('login');
    try {
        const data = await api(`/api/watchlist/${coinId}`, { method: 'POST' });
        currentUser.watchlist = data.watchlist;
        alert('Added to watchlist!');
    } catch (e) {
        alert(e.message);
    }
}

// ── Search ────────────────────────────────────────────────────
async function doSearch() {
    const q = document.getElementById('globalSearch').value.trim();
    if (!q) return;

    // Try to open as CoinGecko token first
    navigate('market');
    openToken(q.toLowerCase(), q);
}

// ══════════════════════════════════════════════════════════════
// TOAST NOTIFICATIONS
// ══════════════════════════════════════════════════════════════

function showToast(message, type = 'info') {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 4000);
}

// ══════════════════════════════════════════════════════════════
// AUTO TRADER FUNCTIONS
// ══════════════════════════════════════════════════════════════

async function loadTraderDashboard() {
    if (!currentUser) { showAuthModal('login'); return; }
    try {
        const [perf, positions] = await Promise.all([
            api('/api/trader/performance'),
            api('/api/trader/positions'),
        ]);

        // Stats
        document.getElementById('traderBalance').textContent = '$' + formatUSD(perf.wallet_balance);
        const totalPnl = (perf.realized_pnl || 0) + (perf.unrealized_pnl || 0);
        const retCls = totalPnl >= 0 ? 'color:var(--green)' : 'color:var(--red)';
        document.getElementById('traderReturn').innerHTML = `<span style="${retCls}">P&L: $${formatUSD(totalPnl)}</span>`;
        
        const pnlCls = perf.realized_pnl >= 0 ? 'color:var(--green)' : 'color:var(--red)';
        document.getElementById('traderPnl').innerHTML = `<span style="${pnlCls}">$${formatUSD(perf.realized_pnl)}</span>`;
        document.getElementById('traderWinRate').textContent = `Win rate: ${perf.win_rate}% (${perf.winning_trades}W / ${perf.losing_trades}L)`;

        document.getElementById('traderOpenCount').textContent = perf.open_positions;
        document.getElementById('traderInvested').textContent = `$${formatUSD(perf.invested_in_positions)} invested`;

        document.getElementById('traderTradeCount').textContent = perf.total_trades;
        document.getElementById('traderBestWorst').textContent = `Best: $${formatUSD(perf.best_trade)} | Worst: $${formatUSD(perf.worst_trade)}`;

        // Toggle state
        const settings = await api('/api/trader/settings');
        document.getElementById('autoTradeToggle').checked = !!settings.auto_trade_enabled;
        const badge = document.getElementById('traderStatusBadge');
        if (settings.auto_trade_enabled) {
            badge.className = 'trader-status active';
            badge.textContent = '● Active';
        } else {
            badge.className = 'trader-status inactive';
            badge.textContent = '● Inactive';
        }

        // Open Positions
        renderTraderPositions(positions.open || []);

    } catch(e) {
        console.error('Trader load failed:', e);
    }
}

function renderTraderPositions(positions) {
    const el = document.getElementById('traderPositions');
    if (!positions.length) {
        el.innerHTML = '<div class="empty-state" style="padding:20px"><p>No open positions — the bot will buy when it finds opportunities</p></div>';
        return;
    }
    el.innerHTML = positions.map(p => {
        const pnlCls = p.pnl >= 0 ? 'profit' : 'loss';
        const pnlSign = p.pnl >= 0 ? '+' : '';
        return `
        <div class="position-card">
            <div class="position-header">
                <div class="position-coin">${p.symbol} <span style="color:var(--text-muted);font-weight:400;font-size:13px">${p.coin_name}</span></div>
                <div style="display:flex;align-items:center;gap:10px">
                    <span class="position-badge ${pnlCls}">${pnlSign}$${Math.abs(p.pnl).toFixed(2)} (${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%)</span>
                    <button class="btn btn-sm btn-danger" onclick="sellPosition(${p.id})">Sell</button>
                </div>
            </div>
            <div class="position-details">
                <div><span>Entry Price</span><strong>$${p.entry_price.toFixed(2)}</strong></div>
                <div><span>Current</span><strong>$${p.current_price.toFixed(2)}</strong></div>
                <div><span>Quantity</span><strong>${p.quantity.toFixed(6)}</strong></div>
                <div><span>Invested</span><strong>$${formatUSD(p.invested_amount)}</strong></div>
                <div><span>Stop Loss</span><strong>$${p.stop_loss.toFixed(2)}</strong></div>
                <div><span>Take Profit</span><strong>$${p.take_profit.toFixed(2)}</strong></div>
            </div>
            <div style="margin-top:8px;padding:8px;background:var(--bg-primary);border-radius:6px;font-size:12px;color:var(--text-secondary);line-height:1.5">
                <strong style="color:var(--accent)">🤖 AI Analysis:</strong> ${p.ai_reasoning}
            </div>
        </div>`;
    }).join('');
}

async function toggleAutoTrade() {
    if (!currentUser) return;
    const badge = document.getElementById('traderStatusBadge');
    const toggle = document.getElementById('autoTradeToggle');
    const isEnabling = toggle.checked;

    if (isEnabling) {
        badge.className = 'trader-status active';
        badge.textContent = '⏳ Starting...';
    }

    try {
        const data = await api('/api/trader/toggle', { method: 'POST' });

        if (data.auto_trade_enabled) {
            badge.className = 'trader-status active';
            badge.textContent = '● Active';

            // Update wallet balance immediately
            if (data.wallet_balance !== undefined) {
                document.getElementById('traderBalance').textContent = '$' + formatUSD(data.wallet_balance);
            }

            // Show first cycle results
            if (data.cycle) {
                const cycle = data.cycle;
                if (cycle.status === 'no_funds') {
                    showToast('⚠️ Wallet is empty — deposit funds to start auto-trading', 'warning');
                } else if (cycle.actions?.length) {
                    showToast(`🤖 Auto Trader active! ${cycle.actions.length} trade(s) executed`, 'success');
                } else if (cycle.new_trades === 0 && cycle.positions_updated >= 0) {
                    showToast('🤖 Auto Trader active! Monitoring markets for opportunities...', 'success');
                } else {
                    showToast('🤖 Auto Trader is now running!', 'success');
                }
            }

            // Refresh entire dashboard with latest data
            loadTraderDashboard();
        } else {
            badge.className = 'trader-status inactive';
            badge.textContent = '● Inactive';
            showToast('Auto Trader stopped', 'info');
        }
    } catch(e) {
        // Revert toggle on error
        toggle.checked = !isEnabling;
        badge.className = isEnabling ? 'trader-status inactive' : 'trader-status active';
        badge.textContent = isEnabling ? '● Inactive' : '● Active';
        alert(e.message);
    }
}

async function runTradeCycle() {
    if (!currentUser) return showAuthModal('login');
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '⏳ Running...';
    try {
        const result = await api('/api/trader/run-cycle', { method: 'POST' });
        let msg = `Status: ${result.status || 'done'}\n`;
        if (result.actions?.length) {
            msg += result.actions.join('\n');
        } else if (result.message) {
            msg += result.message;
        } else {
            msg += `Positions updated: ${result.positions_updated || 0}, New trades: ${result.new_trades || 0}`;
        }
        alert(msg);
        loadTraderDashboard();
    } catch(e) { alert('Error: ' + e.message); }
    finally {
        btn.disabled = false;
        btn.textContent = '⚡ Run Trade Cycle';
    }
}

async function runResearch() {
    if (!currentUser) return showAuthModal('login');
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '🔍 Researching...';
    try {
        const data = await api('/api/trader/research');
        const el = document.getElementById('traderOpportunities');
        if (!data.opportunities?.length) {
            el.innerHTML = '<div class="empty-state"><p>No opportunities found right now</p></div>';
            return;
        }
        el.innerHTML = data.opportunities.map(o => {
            const scoreCls = o.score >= 60 ? 'high' : o.score >= 35 ? 'mid' : 'low';
            return `
            <div class="opp-card">
                <div class="opp-info">
                    <div class="opp-name">${o.symbol} <span style="color:var(--text-muted);font-weight:400">${o.name}</span></div>
                    <div class="opp-detail">$${o.price.toFixed(4)} | 24h: ${o.change_24h >= 0 ? '+' : ''}${o.change_24h.toFixed(1)}% | Vol: $${(o.volume_24h/1000).toFixed(0)}K</div>
                    <div class="opp-detail" style="margin-top:4px">💡 ${o.reasoning}</div>
                </div>
                <div class="opp-score ${scoreCls}">${o.score}</div>
            </div>`;
        }).join('');
    } catch(e) { alert('Research failed: ' + e.message); }
    finally {
        btn.disabled = false;
        btn.textContent = '🔍 Research Market';
    }
}

async function sellPosition(posId) {
    if (!confirm('Sell this position?')) return;
    try {
        const result = await api(`/api/trader/sell/${posId}`, { method: 'POST' });
        alert(`Sold! P&L: $${result.pnl.toFixed(2)} (${result.pnl_pct >= 0 ? '+' : ''}${result.pnl_pct.toFixed(1)}%)`);
        loadTraderDashboard();
    } catch(e) { alert(e.message); }
}

function showManualBuyModal() {
    if (!currentUser) return showAuthModal('login');
    const html = `
        <h2>🛒 Buy Crypto</h2>
        <div class="form-group"><label>Coin ID (e.g. bitcoin, ethereum, solana)</label>
            <input class="form-input" id="manualBuyCoin" placeholder="bitcoin"></div>
        <div class="form-group"><label>Amount ($)</label>
            <input class="form-input" id="manualBuyAmount" type="number" placeholder="5000">
            <div style="display:flex;gap:6px;margin-top:6px">
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=1000">$1K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=5000">$5K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=10000">$10K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=20000">$20K</button>
            </div>
        </div>
        <button class="btn btn-green" style="width:100%;margin-top:8px" onclick="submitManualBuy()">Buy Now</button>
    `;
    showDynamicModal(html);
}

async function submitManualBuy() {
    const coin_id = document.getElementById('manualBuyCoin').value.trim().toLowerCase();
    const amount = parseFloat(document.getElementById('manualBuyAmount').value);
    if (!coin_id || !amount || amount <= 0) return alert('Enter coin and amount');
    try {
        await api('/api/trader/buy', {
            method: 'POST',
            body: JSON.stringify({ coin_id, amount }),
        });
        closeDynamicModal();
        alert(`Buy order placed for $${amount.toLocaleString()}`);
        loadTraderDashboard();
    } catch(e) { alert(e.message); }
}

function showDynamicModal(html) {
    let overlay = document.getElementById('dynamicModal');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'dynamicModal';
        overlay.className = 'modal-overlay';
        overlay.innerHTML = '<div class="modal" id="dynamicModalContent"></div>';
        overlay.addEventListener('click', e => { if (e.target === overlay) closeDynamicModal(); });
        document.body.appendChild(overlay);
    }
    document.getElementById('dynamicModalContent').innerHTML = `<button class="modal-close" onclick="closeDynamicModal()">&times;</button>` + html;
    overlay.classList.add('active');
}
function closeDynamicModal() {
    document.getElementById('dynamicModal')?.classList.remove('active');
}

function showTraderSettings() {
    if (!currentUser) return showAuthModal('login');
    api('/api/trader/settings').then(s => {
        const html = `
            <h2>⚙️ Trading Settings</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Max Trade Size (%)</div>
                    <input class="setting-input" id="setMaxTrade" type="number" value="${s.max_trade_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Daily Loss Limit (%)</div>
                    <input class="setting-input" id="setDailyLoss" type="number" value="${s.daily_loss_limit_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Max Open Positions</div>
                    <input class="setting-input" id="setMaxPos" type="number" value="${s.max_open_positions}" min="1" max="20">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Stop Loss (%)</div>
                    <input class="setting-input" id="setStopLoss" type="number" value="${s.stop_loss_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Take Profit (%)</div>
                    <input class="setting-input" id="setTakeProfit" type="number" value="${s.take_profit_pct}" min="5" max="200">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Cooldown (minutes)</div>
                    <input class="setting-input" id="setCooldown" type="number" value="${s.cooldown_minutes}" min="1" max="60">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Min Market Cap ($)</div>
                    <input class="setting-input" id="setMinMcap" type="number" value="${s.min_market_cap}">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Risk Level</div>
                    <select class="setting-input" id="setRiskLevel">
                        <option value="conservative" ${s.risk_level==='conservative'?'selected':''}>Conservative</option>
                        <option value="moderate" ${s.risk_level==='moderate'?'selected':''}>Moderate</option>
                        <option value="aggressive" ${s.risk_level==='aggressive'?'selected':''}>Aggressive</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="saveTraderSettings()">Save Settings</button>
        `;
        showDynamicModal(html);
    });
}

async function saveTraderSettings() {
    try {
        await api('/api/trader/settings', {
            method: 'POST',
            body: JSON.stringify({
                max_trade_pct: parseFloat(document.getElementById('setMaxTrade').value),
                daily_loss_limit_pct: parseFloat(document.getElementById('setDailyLoss').value),
                max_open_positions: parseInt(document.getElementById('setMaxPos').value),
                stop_loss_pct: parseFloat(document.getElementById('setStopLoss').value),
                take_profit_pct: parseFloat(document.getElementById('setTakeProfit').value),
                cooldown_minutes: parseInt(document.getElementById('setCooldown').value),
                min_market_cap: parseFloat(document.getElementById('setMinMcap').value),
                risk_level: document.getElementById('setRiskLevel').value,
            }),
        });
        closeDynamicModal();
        alert('Settings saved!');
    } catch(e) { alert(e.message); }
}

async function resetTrading() {
    if (!confirm('Reset trading? This will close all open positions and refund invested amounts to your wallet.')) return;
    try {
        await api('/api/trader/reset', { method: 'POST' });
        alert('Trading stats reset! Open positions refunded to wallet.');
        loadTraderDashboard();
    } catch(e) { alert(e.message); }
}

async function loadTraderHistory() {
    try {
        const trades = await api('/api/trader/history?limit=25');
        const el = document.getElementById('traderHistoryArea');
        if (!trades.length) { el.innerHTML = '<div class="empty-state"><p>No trades yet</p></div>'; return; }
        el.innerHTML = `<table class="feed-table"><thead><tr><th>Time</th><th>Action</th><th>Coin</th><th>Price</th><th>Amount</th><th>Score</th></tr></thead><tbody>` +
            trades.map(t => {
                const actionCls = t.action === 'BUY' ? 'color:var(--green)' : 'color:var(--red)';
                return `<tr>
                    <td style="font-size:12px">${new Date(t.created_at).toLocaleString()}</td>
                    <td style="${actionCls};font-weight:600">${t.action}</td>
                    <td>${t.symbol}</td>
                    <td>$${t.price.toFixed(2)}</td>
                    <td>$${formatUSD(t.amount)}</td>
                    <td>${t.ai_score}/100</td>
                </tr>`;
            }).join('') + '</tbody></table>';
    } catch(e) { console.error(e); }
}

async function loadTraderLog() {
    try {
        const logs = await api('/api/trader/log?limit=30');
        const el = document.getElementById('traderHistoryArea');
        if (!logs.length) { el.innerHTML = '<div class="empty-state"><p>No log entries yet</p></div>'; return; }
        el.innerHTML = logs.map(l => `
            <div class="log-item">
                <span class="log-time">${new Date(l.created_at).toLocaleString()}</span>
                <span class="log-event">[${l.event}]</span>
                <span>${l.details}</span>
            </div>
        `).join('');
    } catch(e) { console.error(e); }
}

async function loadClosedPositions() {
    try {
        const data = await api('/api/trader/positions');
        const closed = data.closed || [];
        const el = document.getElementById('traderHistoryArea');
        if (!closed.length) { el.innerHTML = '<div class="empty-state"><p>No closed positions yet</p></div>'; return; }
        el.innerHTML = closed.map(p => {
            const pnlCls = p.pnl >= 0 ? 'profit' : 'loss';
            const sign = p.pnl >= 0 ? '+' : '';
            return `
            <div class="position-card">
                <div class="position-header">
                    <div class="position-coin">${p.symbol} <span style="color:var(--text-muted);font-weight:400;font-size:13px">${p.coin_name}</span></div>
                    <span class="position-badge ${pnlCls}">${sign}$${Math.abs(p.pnl).toFixed(2)} (${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%)</span>
                </div>
                <div class="position-details">
                    <div><span>Entry</span><strong>$${p.entry_price.toFixed(2)}</strong></div>
                    <div><span>Exit</span><strong>$${p.current_price.toFixed(2)}</strong></div>
                    <div><span>Invested</span><strong>$${formatUSD(p.invested_amount)}</strong></div>
                </div>
                <div style="margin-top:6px;font-size:11px;color:var(--text-muted)">Closed: ${new Date(p.closed_at).toLocaleString()}</div>
            </div>`;
        }).join('');
    } catch(e) { console.error(e); }
}

// ── Init ──────────────────────────────────────────────────────
checkAuth();
loadHomeData();

// Keyboard shortcut
document.addEventListener('keydown', e => {
    if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        document.getElementById('globalSearch').focus();
    }
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    }
});

// ══════════════════════════════════════════════════════════════
// PUMPIQ WEB INSIGHT BOT
// ══════════════════════════════════════════════════════════════

const BOT_SUGGESTIONS = [
    "How is the crypto market today?",
    "Analyze Bitcoin right now",
    "What's trending in crypto?",
    "Should I look at Solana?",
    "ETH price analysis",
    "Top gainers today",
];

function toggleBotWindow() {
    const win = document.getElementById('botWindow');
    const isOpen = win.classList.contains('open');
    if (isOpen) {
        win.classList.remove('open');
    } else {
        if (!currentUser) { showAuthModal('login'); return; }
        win.classList.add('open');
        const msgs = document.getElementById('botMessages');
        if (msgs.children.length === 0) {
            appendBotMessage(
                "Hey! 👋 I'm **PumpIQ Bot** — your crypto intelligence assistant.\n\n" +
                "I fetch **live data** from CoinGecko, DexScreener & news to answer your questions. Try asking about any coin, market trends, or trading insights!",
                []
            );
            renderBotSuggestions();
        }
        setTimeout(() => document.getElementById('botInput').focus(), 100);
    }
}

function renderBotSuggestions() {
    const el = document.getElementById('botSuggestions');
    el.innerHTML = BOT_SUGGESTIONS.map(s =>
        `<div class="bot-chip" onclick="askBotFromChip(this)">${s}</div>`
    ).join('');
}

function askBotFromChip(chip) {
    const q = chip.textContent;
    document.getElementById('botInput').value = q;
    document.getElementById('botSuggestions').innerHTML = '';
    sendBotMessage();
}

function appendUserMessage(text) {
    const msgs = document.getElementById('botMessages');
    const div = document.createElement('div');
    div.className = 'bot-msg user';
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
}

function appendBotMessage(text, sources, mode) {
    const msgs = document.getElementById('botMessages');
    const div = document.createElement('div');
    div.className = 'bot-msg bot';

    // ── Rich Markdown → HTML Renderer ──
    let html = '';
    const blocks = text.split('\n');
    let inTable = false;
    let tableRows = [];

    function flushTable() {
        if (!tableRows.length) return '';
        // tableRows[0] = header, tableRows[1] = separator, rest = body
        let t = '<table><thead><tr>';
        const headers = tableRows[0].split('|').map(c => c.trim()).filter(Boolean);
        headers.forEach(h => { t += `<th>${formatInline(h)}</th>`; });
        t += '</tr></thead><tbody>';
        for (let i = 2; i < tableRows.length; i++) {
            const cells = tableRows[i].split('|').map(c => c.trim()).filter(Boolean);
            t += '<tr>';
            cells.forEach(c => { t += `<td>${formatInline(c)}</td>`; });
            t += '</tr>';
        }
        t += '</tbody></table>';
        tableRows = [];
        return t;
    }

    function formatInline(s) {
        return s
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            // Color price changes: 🟢 +X% green, 🔴 -X% red
            .replace(/🟢\s*([+\-]?[\d.]+%)/g, '<span class="price-up">▲ $1</span>')
            .replace(/🔴\s*([+\-]?[\d.]+%)/g, '<span class="price-down">▼ $1</span>');
    }

    for (let i = 0; i < blocks.length; i++) {
        const line = blocks[i];

        // Table row detection
        if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
            if (!inTable) inTable = true;
            tableRows.push(line.trim());
            continue;
        } else if (inTable) {
            html += flushTable();
            inTable = false;
        }

        // Horizontal rule
        if (line.trim() === '---') {
            html += '<hr>';
            continue;
        }

        // H3 headers
        if (line.trim().startsWith('### ')) {
            const hText = line.trim().slice(4);
            html += `<h3>${formatInline(hText)}</h3>`;
            continue;
        }

        // Empty line
        if (!line.trim()) {
            continue;
        }

        // Bullet points
        if (/^[•\-]\s/.test(line.trim())) {
            html += `<div style="padding:2px 0 2px 6px;">${formatInline(line.trim())}</div>`;
            continue;
        }

        // Regular paragraph
        html += `<div style="padding:2px 0;">${formatInline(line)}</div>`;
    }

    // Flush any remaining table
    if (inTable) html += flushTable();

    // Mode badge
    if (mode === 'data') {
        html += '<div style="margin-top:10px;"><span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;background:rgba(245,158,11,0.12);color:#f59e0b;border:1px solid rgba(245,158,11,0.25);letter-spacing:0.3px;">📊 Live Data Mode</span></div>';
    } else if (mode === 'ai') {
        html += '<div style="margin-top:10px;"><span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;background:rgba(124,92,255,0.12);color:#7c5cff;border:1px solid rgba(124,92,255,0.25);letter-spacing:0.3px;">🤖 AI + Live Data</span></div>';
    }

    if (sources && sources.length) {
        html += '<div class="bot-sources">📡 Sources: ' +
            sources.map(s => s.replace(/^[📊📈🔥📰🔗]\s?/, '')).slice(0, 3).join(' · ') +
            '</div>';
    }
    div.innerHTML = html;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
}

function showBotTyping(show) {
    const el = document.getElementById('botTyping');
    el.classList.toggle('show', show);
    if (show) {
        const msgs = document.getElementById('botMessages');
        msgs.scrollTop = msgs.scrollHeight;
    }
}

async function sendBotMessage() {
    const input = document.getElementById('botInput');
    const btn = document.getElementById('botSendBtn');
    const question = input.value.trim();
    if (!question || !currentUser) return;

    input.value = '';
    btn.disabled = true;
    document.getElementById('botSuggestions').innerHTML = '';

    appendUserMessage(question);
    showBotTyping(true);

    try {
        const data = await api('/api/bot/ask', {
            method: 'POST',
            body: JSON.stringify({ question }),
        });
        showBotTyping(false);
        appendBotMessage(data.answer, data.sources || [], data.mode);
    } catch(e) {
        showBotTyping(false);
        appendBotMessage('❌ ' + (e.message || 'Something went wrong. Please try again.'), []);
    } finally {
        btn.disabled = false;
        input.focus();
    }
}

</script>

<!-- PumpIQ Bot Widget -->
<button class="bot-fab has-dot" onclick="toggleBotWindow()" title="PumpIQ Bot">🤖</button>
<div class="bot-window" id="botWindow">
    <div class="bot-header">
        <div class="bot-header-icon">🤖</div>
        <div class="bot-header-info">
            <h3>PumpIQ Bot</h3>
            <p>● Online — Live Web Insights</p>
        </div>
        <button class="bot-close" onclick="toggleBotWindow()">✕</button>
    </div>
    <div class="bot-messages" id="botMessages">
    </div>
    <div class="bot-typing" id="botTyping">
        <span></span><span></span><span></span>
    </div>
    <div class="bot-suggestions" id="botSuggestions"></div>
    <div class="bot-input-area">
        <input type="text" id="botInput" placeholder="Ask about any crypto..." autocomplete="off"
               onkeydown="if(event.key==='Enter')sendBotMessage()">
        <button class="bot-send" id="botSendBtn" onclick="sendBotMessage()">➤</button>
    </div>
</div>

</body>
</html>
