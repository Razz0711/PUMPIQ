<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PumpIQ — AI-Powered Crypto Intelligence</title>
<style>
/* ── CSS Reset & Variables ────────────────────────────────── */
:root {
    --bg-primary: #0a0e17;
    --bg-secondary: #111827;
    --bg-card: #1a1f2e;
    --bg-card-hover: #212738;
    --border: #2a3042;
    --text-primary: #e5e7eb;
    --text-secondary: #9ca3af;
    --text-muted: #6b7280;
    --accent: #3b82f6;
    --accent-glow: rgba(59,130,246,0.15);
    --green: #10b981;
    --green-bg: rgba(16,185,129,0.1);
    --red: #ef4444;
    --red-bg: rgba(239,68,68,0.1);
    --yellow: #f59e0b;
    --purple: #8b5cf6;
    --cyan: #06b6d4;
    --gradient: linear-gradient(135deg, #3b82f6, #8b5cf6);
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
}
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ── Scrollbar ────────────────────────────────────────────── */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:var(--bg-primary); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* ── Header ───────────────────────────────────────────────── */
.header {
    position: sticky; top:0; z-index:100;
    background: rgba(10,14,23,0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 60px;
    display: flex; align-items:center; justify-content:space-between;
}
.logo {
    font-size:22px; font-weight:800;
    background: var(--gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    cursor: pointer;
}
.nav-tabs { display:flex; gap:4px; }
.nav-tab {
    padding: 8px 16px; border-radius:var(--radius-sm);
    color:var(--text-secondary); cursor:pointer;
    font-size:14px; font-weight:500; transition:all 0.2s;
    border: none; background: none;
}
.nav-tab:hover { color:var(--text-primary); background:var(--bg-card); }
.nav-tab.active {
    color:var(--accent); background:var(--accent-glow);
}
.header-right { display:flex; align-items:center; gap:12px; }
.search-box {
    padding: 8px 14px; border-radius:20px;
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-primary); font-size:13px; width:220px;
    outline:none; transition:border 0.2s;
}
.search-box:focus { border-color:var(--accent); }
.btn {
    padding: 8px 18px; border-radius:var(--radius-sm);
    font-size:13px; font-weight:600; cursor:pointer;
    border:none; transition:all 0.2s;
}
.btn-primary {
    background:var(--gradient); color:#fff;
}
.btn-primary:hover { opacity:0.9; }
.btn-outline {
    background:transparent; color:var(--accent);
    border:1px solid var(--accent);
}
.btn-outline:hover { background:var(--accent-glow); }
.btn-green { background:var(--green); color:#fff; }
.btn-green:hover { opacity:0.9; }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-danger { background:var(--red); color:#fff; }
.btn:disabled { cursor:not-allowed; opacity:0.6; }

.user-badge {
    display:flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:20px;
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-secondary); font-size:13px; cursor:pointer;
}
.user-avatar {
    width:28px; height:28px; border-radius:50%;
    background:var(--gradient); display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:12px; font-weight:700;
}

/* ── Page Container ───────────────────────────────────────── */
.page { display:none; padding:24px; max-width:1200px; margin:0 auto; }
.page.active { display:block; }

/* ── Hero Section ─────────────────────────────────────────── */
.hero {
    text-align:center; padding:60px 20px 40px;
}
.hero-tag {
    color:var(--cyan); font-size:13px; font-weight:700; letter-spacing:2px;
    text-transform:uppercase; margin-bottom:16px;
}
.hero-title {
    font-size:48px; font-weight:900; line-height:1.1; margin-bottom:16px;
    color:var(--text-primary);
}
.hero-desc {
    color:var(--text-secondary); font-size:16px; max-width:600px; margin:0 auto 40px;
    line-height:1.6;
}
.hero-steps {
    display:grid; grid-template-columns:repeat(3,1fr); gap:20px;
    max-width:900px; margin:0 auto;
}
.step-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px;
    text-align:left; transition:border 0.2s;
}
.step-card:hover { border-color:var(--accent); }
.step-num {
    color:var(--cyan); font-size:12px; font-weight:700; margin-bottom:8px;
}
.step-title { font-size:18px; font-weight:700; margin-bottom:8px; }
.step-desc { color:var(--text-secondary); font-size:13px; line-height:1.5; }

/* ── Section Titles ───────────────────────────────────────── */
.section-title {
    font-size:24px; font-weight:800; margin-bottom:6px;
}
.section-desc {
    color:var(--text-secondary); font-size:14px; margin-bottom:20px;
}

/* ── Cards Grid ───────────────────────────────────────────── */
.cards-grid {
    display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr));
    gap:16px;
}
.card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px;
    cursor:pointer; transition:all 0.2s;
}
.card:hover { background:var(--bg-card-hover); border-color:var(--accent); }

/* ── Filter Tabs ──────────────────────────────────────────── */
.filter-bar {
    display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; align-items:center;
}
.filter-pill {
    padding:6px 16px; border-radius:20px; font-size:13px;
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-secondary); cursor:pointer; transition:all 0.2s;
}
.filter-pill:hover { color:var(--text-primary); border-color:var(--text-muted); }
.filter-pill.active { background:var(--accent); color:#fff; border-color:var(--accent); }

/* ── Token Feed Table ─────────────────────────────────────── */
.feed-table { width:100%; border-collapse:collapse; }
.feed-table th {
    text-align:left; padding:12px 16px; font-size:12px;
    color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;
    border-bottom:1px solid var(--border);
}
.feed-table td {
    padding:14px 16px; border-bottom:1px solid var(--border);
    font-size:14px; vertical-align:middle;
}
.feed-table tr:hover { background:var(--bg-card); }
.token-info { display:flex; align-items:center; gap:10px; }
.token-icon {
    width:36px; height:36px; border-radius:50%;
    background:var(--gradient); display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:12px; font-weight:700; flex-shrink:0;
}
.token-name { font-weight:600; }
.token-symbol { color:var(--text-muted); font-size:12px; }
.price-positive { color:var(--green); }
.price-negative { color:var(--red); }

/* ── AI Recs ──────────────────────────────────────────────── */
.market-summary-box {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; margin-bottom:20px;
}
.market-summary-box h4 { font-size:14px; color:var(--text-muted); margin-bottom:8px; }
.market-summary-box p { color:var(--text-secondary); font-size:14px; line-height:1.6; }

.toggle-row { display:flex; gap:24px; margin-bottom:20px; }
.toggle-item {
    display:flex; align-items:center; gap:10px;
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:14px 20px; flex:1;
}
.simple-toggle {
    width:40px; height:22px; border-radius:11px;
    background:var(--cyan); position:relative; cursor:pointer; flex-shrink:0;
}
.simple-toggle::after {
    content:''; position:absolute; top:2px; left:2px;
    width:18px; height:18px; border-radius:50%; background:#fff;
    transition: left 0.2s;
}
.simple-toggle.off { background:var(--text-muted); }
.simple-toggle.off::after { left:2px; }
.simple-toggle:not(.off)::after { left:20px; }
.toggle-label { font-weight:600; font-size:14px; }
.toggle-desc { color:var(--text-muted); font-size:12px; }

.score-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; position:relative;
}
.score-circle {
    width:52px; height:52px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-weight:800; font-size:18px; color:#fff;
    position:absolute; top:16px; right:16px;
}
.score-green { background:var(--green); }
.score-yellow { background:var(--yellow); }
.score-red { background:var(--red); }
.score-purple { background:var(--purple); }
.score-card-name { font-weight:700; font-size:16px; }
.score-card-sym { color:var(--text-muted); font-size:13px; margin-bottom:10px; }
.score-card-summary { color:var(--text-secondary); font-size:13px; line-height:1.5; margin-bottom:12px; }
.verdict-badge {
    display:inline-block; padding:4px 10px; border-radius:4px;
    font-size:12px; font-weight:700;
}
.verdict-STRONG_BUY, .verdict-BUY { background:var(--green-bg); color:var(--green); }
.verdict-HOLD { background:rgba(245,158,11,0.1); color:var(--yellow); }
.verdict-CAUTION { background:var(--red-bg); color:var(--red); }
.verdict-AVOID { background:var(--red-bg); color:var(--red); }

.on-chain-bars { margin-top:10px; }
.bar-row { display:flex; align-items:center; gap:8px; margin-bottom:4px; }
.bar-label { font-size:11px; color:var(--text-muted); width:80px; flex-shrink:0; }
.bar-track { flex:1; height:6px; background:var(--border); border-radius:3px; }
.bar-fill { height:100%; border-radius:3px; background:var(--cyan); }

/* ── Leaderboard ──────────────────────────────────────────── */
.lb-table { width:100%; border-collapse:collapse; }
.lb-table th {
    text-align:left; padding:12px 16px; font-size:12px;
    color:var(--text-muted); text-transform:uppercase;
    border-bottom:1px solid var(--border);
}
.lb-table td {
    padding:14px 16px; border-bottom:1px solid var(--border); font-size:14px;
}
.lb-table tr:hover { background:var(--bg-card); }
.trader-addr { color:var(--accent); font-family:monospace; font-size:13px; }

/* ── Modal ────────────────────────────────────────────────── */
.modal-overlay {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
    z-index:200; justify-content:center; align-items:flex-start;
    padding:40px 20px; overflow-y:auto;
}
.modal-overlay.active { display:flex; }
.modal {
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:16px; width:100%; max-width:500px;
    padding:32px; position:relative;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.modal-close {
    position:absolute; top:16px; right:16px;
    background:none; border:none; color:var(--text-muted);
    font-size:20px; cursor:pointer;
}
.modal h2 { font-size:22px; margin-bottom:20px; }
.form-group { margin-bottom:16px; }
.form-group label {
    display:block; font-size:13px; color:var(--text-secondary);
    margin-bottom:6px; font-weight:500;
}
.form-input {
    width:100%; padding:10px 14px; border-radius:var(--radius-sm);
    background:var(--bg-card); border:1px solid var(--border);
    color:var(--text-primary); font-size:14px; outline:none;
}
.form-input:focus { border-color:var(--accent); }
.form-error { color:var(--red); font-size:12px; margin-top:4px; display:none; }
.form-divider {
    text-align:center; color:var(--text-muted); font-size:13px;
    margin:16px 0; position:relative;
}
.form-divider::before, .form-divider::after {
    content:''; position:absolute; top:50%;
    width:calc(50% - 20px); height:1px; background:var(--border);
}
.form-divider::before { left:0; }
.form-divider::after { right:0; }

/* ── Detail Modal (larger) ────────────────────────────────── */
.modal-lg { max-width:720px; }
.detail-header { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
.detail-avatar {
    width:48px; height:48px; border-radius:50%;
    background:var(--gradient); display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:16px; font-weight:700;
}
.detail-name { font-size:20px; font-weight:700; }
.detail-symbol { color:var(--text-muted); font-size:13px; }
.detail-price-row { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
.detail-price { font-size:28px; font-weight:800; }
.metrics-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px; }
.metric-box {
    background:var(--bg-card); border-radius:var(--radius-sm); padding:14px;
}
.metric-label { font-size:11px; color:var(--text-muted); margin-bottom:4px; }
.metric-value { font-size:15px; font-weight:600; }
.analysis-section {
    background:var(--bg-card); border-radius:var(--radius); padding:16px;
    margin-bottom:12px;
}
.analysis-title { font-size:14px; font-weight:700; margin-bottom:10px; }
.analysis-row {
    display:flex; justify-content:space-between; padding:4px 0;
    font-size:13px; color:var(--text-secondary);
}
.score-bar-container { height:6px; background:var(--border); border-radius:3px; margin-top:6px; }
.score-bar { height:100%; border-radius:3px; transition:width 0.5s; }
.score-bar.green { background:var(--green); }
.score-bar.yellow { background:var(--yellow); }
.score-bar.red { background:var(--red); }
.ai-box {
    background:var(--bg-card); border:1px solid var(--purple);
    border-radius:var(--radius); padding:16px; margin-top:12px;
}
.ai-box-title { font-size:14px; font-weight:700; margin-bottom:8px; }
.ai-badge {
    display:inline-block; padding:2px 8px; border-radius:4px;
    font-size:10px; font-weight:700; background:var(--purple); color:#fff;
    margin-left:8px;
}
.ai-text { color:var(--text-secondary); font-size:13px; line-height:1.6; }

/* ── Wallet Section ───────────────────────────────────────── */
.wallet-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px;
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:8px;
}
.wallet-addr { font-family:monospace; font-size:13px; color:var(--accent); }
.wallet-chain {
    font-size:11px; padding:2px 8px; border-radius:4px;
    background:var(--accent-glow); color:var(--accent); font-weight:600;
}

/* ── Wallet Balance Card ──────────────────────────────────── */
.balance-card {
    background: linear-gradient(135deg, #1a1040 0%, #0d2137 50%, #0a2a1a 100%);
    border: 1px solid #2a2a4a;
    border-radius: 16px; padding: 28px;
    margin-bottom: 24px; position: relative; overflow: hidden;
}
.balance-card::before {
    content: ''; position: absolute; top: -40px; right: -40px;
    width: 120px; height: 120px; border-radius: 50%;
    background: rgba(124,92,255,0.08);
}
.balance-label { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.balance-amount { font-size: 36px; font-weight: 700; color: #fff; margin-bottom: 16px; }
.balance-amount .currency { font-size: 20px; color: #7c5cff; margin-right: 4px; }
.balance-actions { display: flex; gap: 10px; }
.balance-actions .btn { flex: 1; padding: 10px; font-size: 13px; }

/* ── Bank Account Card ────────────────────────────────────── */
.bank-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px;
}
.bank-info { display: flex; align-items: center; gap: 12px; }
.bank-icon {
    width: 40px; height: 40px; border-radius: 10px;
    background: linear-gradient(135deg, #7c5cff, #00d4aa);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; font-weight: 700; color: #fff;
}
.bank-name { font-weight: 600; font-size: 14px; }
.bank-detail { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.bank-verified { color: #00d4aa; font-size: 11px; font-weight: 600; }

/* ── Transaction List ─────────────────────────────────────── */
.txn-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0; border-bottom: 1px solid var(--border);
}
.txn-type { font-size: 12px; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
.txn-deposit { background: #0a2a1a; color: #00d4aa; }
.txn-withdraw { background: #2a1a1a; color: #ff6b6b; }
.txn-amount { font-weight: 600; font-size: 14px; }

/* ── Verification Steps ───────────────────────────────────── */
.verify-steps { display: flex; gap: 8px; margin: 16px 0; }
.verify-step {
    flex: 1; text-align: center; padding: 10px 8px;
    border-radius: 8px; font-size: 11px; font-weight: 600;
    background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted);
}
.verify-step.active { border-color: #7c5cff; color: #7c5cff; background: rgba(124,92,255,0.08); }
.verify-step.done { border-color: #00d4aa; color: #00d4aa; background: rgba(0,212,170,0.08); }

/* ── Portfolio ────────────────────────────────────────────── */
.portfolio-table { width:100%; border-collapse:collapse; }
.portfolio-table th {
    text-align:left; padding:10px 14px; font-size:12px;
    color:var(--text-muted); text-transform:uppercase;
    border-bottom:1px solid var(--border);
}
.portfolio-table td {
    padding:12px 14px; border-bottom:1px solid var(--border); font-size:14px;
}

/* ── Auto Trader ──────────────────────────────────────────── */
.trader-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px; }
@media(max-width:768px) { .trader-grid { grid-template-columns:1fr; } }
.trader-stat-card {
    background: var(--bg-card); border:1px solid var(--border);
    border-radius: var(--radius); padding:20px;
}
.trader-stat-label { font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
.trader-stat-value { font-size:28px; font-weight:700; margin-top:4px; }
.trader-stat-sub { font-size:12px; color:var(--text-secondary); margin-top:4px; }

.trader-header {
    background: linear-gradient(135deg, #0d1a2d 0%, #1a0d2e 50%, #0d2a1a 100%);
    border: 1px solid #2a2a4a; border-radius:16px; padding:24px;
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;
}
.trader-title { font-size:24px; font-weight:700; }
.trader-title span { font-size:14px; font-weight:400; color:var(--text-muted); margin-left:8px; }
.trader-status {
    padding:6px 16px; border-radius:20px; font-size:13px; font-weight:600;
    display:inline-flex; align-items:center; gap:6px;
}
.trader-status.active { background:rgba(16,185,129,0.15); color:var(--green); border:1px solid rgba(16,185,129,0.3); }
.trader-status.inactive { background:rgba(239,68,68,0.1); color:var(--red); border:1px solid rgba(239,68,68,0.2); }

.toggle-switch {
    position:relative; width:52px; height:28px; cursor:pointer;
}
.toggle-switch input { display:none; }
.toggle-slider {
    position:absolute; top:0; left:0; right:0; bottom:0;
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:14px; transition:all 0.3s;
}
.toggle-slider::before {
    content:''; position:absolute; width:22px; height:22px;
    left:2px; bottom:2px; background:#fff; border-radius:50%;
    transition:transform 0.3s;
}
.toggle-switch input:checked + .toggle-slider {
    background:var(--green); border-color:var(--green);
}
.toggle-switch input:checked + .toggle-slider::before {
    transform:translateX(24px);
}

.position-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px; margin-bottom:10px;
}
.position-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.position-coin { font-weight:700; font-size:16px; }
.position-badge {
    padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600;
}
.position-badge.profit { background:var(--green-bg); color:var(--green); }
.position-badge.loss { background:var(--red-bg); color:var(--red); }
.position-details { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; font-size:12px; color:var(--text-secondary); }
.position-details span { display:block; }
.position-details strong { color:var(--text-primary); font-size:13px; }

.opp-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:14px; margin-bottom:8px;
    display:flex; justify-content:space-between; align-items:center;
}
.opp-info { flex:1; }
.opp-name { font-weight:600; font-size:14px; }
.opp-detail { font-size:12px; color:var(--text-secondary); margin-top:2px; }
.opp-score {
    width:48px; height:48px; border-radius:50%; display:flex;
    align-items:center; justify-content:center; font-weight:700;
    font-size:16px; margin-left:12px; flex-shrink:0;
}
.opp-score.high { background:var(--green-bg); color:var(--green); border:2px solid var(--green); }
.opp-score.mid { background:rgba(245,158,11,0.1); color:var(--yellow); border:2px solid var(--yellow); }
.opp-score.low { background:var(--red-bg); color:var(--red); border:2px solid var(--red); }

.log-item { padding:8px 0; border-bottom:1px solid var(--border); font-size:13px; }
.log-time { color:var(--text-muted); font-size:11px; }
.log-event { font-weight:600; margin:0 6px; }

.settings-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
@media(max-width:768px) { .settings-grid { grid-template-columns:1fr; } }
.setting-item {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:14px;
}
.setting-label { font-size:12px; color:var(--text-muted); margin-bottom:6px; }
.setting-input {
    width:100%; padding:8px 12px; background:var(--bg-secondary);
    border:1px solid var(--border); border-radius:6px;
    color:var(--text-primary); font-size:14px; outline:none;
}
.setting-input:focus { border-color:var(--accent); }

/* ── Trader Sub-tabs ──────────────────────────────────────── */
.trader-subtabs { display:flex; gap:0; margin-top:20px; border-bottom:2px solid var(--border); }
.trader-subtab {
    padding:12px 24px; font-size:14px; font-weight:600; color:var(--text-muted);
    background:none; border:none; cursor:pointer; position:relative;
    transition:color .2s;
}
.trader-subtab:hover { color:var(--text-primary); }
.trader-subtab.active { color:var(--accent); }
.trader-subtab.active::after {
    content:''; position:absolute; bottom:-2px; left:0; right:0;
    height:2px; background:var(--accent); border-radius:2px;
}
.trader-subpage { display:none; margin-top:20px; }
.trader-subpage.active { display:block; }

/* ── Strategy Builder (inside trader) ─────────────────────── */
.sb-row { display:grid; gap:16px; margin-bottom:16px; }
.sb-row.two { grid-template-columns:1fr 1fr; }
.sb-row.three { grid-template-columns:1fr 1fr 1fr; }
.sb-row.four { grid-template-columns:1fr 1fr 1fr 1fr; }
@media(max-width:900px) { .sb-row.two, .sb-row.three, .sb-row.four { grid-template-columns:1fr; } }
.sb-card {
    background: var(--bg-card); border:1px solid var(--border);
    border-radius: var(--radius); padding:20px;
}
.sb-card h4 { font-size:15px; font-weight:700; margin-bottom:14px; color:var(--text-primary); display:flex; align-items:center; gap:8px; }
.sb-card h4 .sb-icon { font-size:18px; }
.sb-check-group { display:flex; gap:14px; flex-wrap:wrap; }
.sb-check {
    display:flex; align-items:center; gap:6px; font-size:13px;
    color:var(--text-secondary); cursor:pointer;
}
.sb-check input { accent-color:var(--accent); }
.sb-pills { display:flex; gap:8px; flex-wrap:wrap; }
.sb-pill {
    padding:8px 18px; border-radius:20px; font-size:13px; font-weight:600;
    background:var(--bg-secondary); border:1px solid var(--border);
    color:var(--text-muted); cursor:pointer; transition:all .2s;
}
.sb-pill.active, .sb-pill:hover { background:var(--accent); color:#fff; border-color:var(--accent); }
.sb-pill.green.active { background:var(--green); border-color:var(--green); }
.sb-pill.red.active { background:var(--red); border-color:var(--red); }
.sb-pill input[type=radio] { display:none; }
.sb-time-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
.sb-time-row label { font-size:12px; color:var(--text-muted); }
.sb-time-row input[type=time] {
    padding:6px 10px; background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:6px; color:var(--text-primary); font-size:13px;
}
.sb-day-pills { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
.sb-day {
    width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-size:11px; font-weight:700; background:var(--bg-secondary); border:1px solid var(--border);
    color:var(--text-muted); cursor:pointer; transition:all .2s;
}
.sb-day.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.sb-field { margin-bottom:12px; }
.sb-field label { font-size:12px; color:var(--text-muted); display:block; margin-bottom:5px; font-weight:600; }
.sb-field select, .sb-field input[type=number], .sb-field input[type=text] {
    width:100%; padding:8px 12px; background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:6px; color:var(--text-primary); font-size:13px; outline:none;
}
.sb-field select:focus, .sb-field input:focus { border-color:var(--accent); }
.sb-field .sb-hint { font-size:10px; color:var(--text-muted); margin-top:3px; }

/* Exchange card */
.sb-exchange-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
@media(max-width:700px) { .sb-exchange-grid { grid-template-columns:1fr 1fr; } }
.sb-exchange-opt {
    padding:10px; border-radius:8px; border:1px solid var(--border);
    background:var(--bg-secondary); cursor:pointer; text-align:center;
    transition:all .2s; font-size:12px; font-weight:600;
}
.sb-exchange-opt:hover { border-color:var(--accent); }
.sb-exchange-opt.active { border-color:var(--accent); background:rgba(99,102,241,0.1); color:var(--accent); }
.sb-exchange-opt .sb-fee { font-size:10px; color:var(--text-muted); margin-top:2px; font-weight:400; }

/* Leverage slider */
.sb-leverage-wrap { margin-top:8px; }
.sb-leverage-bar { display:flex; align-items:center; gap:12px; }
.sb-leverage-bar input[type=range] {
    flex:1; accent-color:var(--accent); height:6px;
    -webkit-appearance:none; background:var(--border); border-radius:3px;
}
.sb-leverage-bar input[type=range]::-webkit-slider-thumb {
    -webkit-appearance:none; width:18px; height:18px; background:var(--accent);
    border-radius:50%; cursor:pointer;
}
.sb-leverage-val {
    min-width:48px; text-align:center; padding:4px 10px; background:var(--bg-secondary);
    border:1px solid var(--border); border-radius:6px; font-weight:700; font-size:14px;
    color:var(--accent);
}
.sb-leverage-presets { display:flex; gap:6px; margin-top:8px; }
.sb-leverage-presets button {
    padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600;
    background:var(--bg-secondary); border:1px solid var(--border);
    color:var(--text-muted); cursor:pointer; transition:all .15s;
}
.sb-leverage-presets button:hover, .sb-leverage-presets button.active {
    background:var(--accent); color:#fff; border-color:var(--accent);
}
.sb-liq-price { font-size:12px; color:var(--yellow); margin-top:6px; }

/* Indicator tags */
.sb-indicator-grid { display:flex; gap:8px; flex-wrap:wrap; }
.sb-indicator {
    padding:6px 14px; border-radius:16px; font-size:12px; font-weight:600;
    background:var(--bg-secondary); border:1px solid var(--border);
    color:var(--text-muted); cursor:pointer; transition:all .2s;
    display:flex; align-items:center; gap:5px;
}
.sb-indicator:hover { border-color:var(--accent); color:var(--text-primary); }
.sb-indicator.active { background:rgba(99,102,241,0.15); border-color:var(--accent); color:var(--accent); }
.sb-indicator .dot { width:6px; height:6px; border-radius:50%; }
.sb-indicator .dot.green { background:var(--green); }
.sb-indicator .dot.yellow { background:var(--yellow); }
.sb-indicator .dot.red { background:var(--red); }
.sb-indicator .dot.blue { background:var(--accent); }

/* Condition builder */
.sb-condition {
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:8px; padding:10px 14px; margin-bottom:8px;
    display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size:13px;
}
.sb-condition select, .sb-condition input {
    padding:5px 8px; background:var(--bg-card); border:1px solid var(--border);
    border-radius:4px; color:var(--text-primary); font-size:12px;
}
.sb-condition .sb-cond-remove {
    background:none; border:none; color:var(--text-muted); cursor:pointer;
    font-size:16px; margin-left:auto;
}
.sb-condition .sb-cond-remove:hover { color:var(--red); }

/* Kill switch */
.sb-kill-switch {
    display:flex; align-items:center; gap:12px; padding:12px 16px;
    background:rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.2);
    border-radius:8px; margin-bottom:8px;
}
.sb-kill-switch label { font-size:13px; color:var(--text-secondary); flex:1; }
.sb-kill-switch input[type=number] {
    width:70px; padding:5px 8px; background:var(--bg-card); border:1px solid var(--border);
    border-radius:4px; color:var(--text-primary); font-size:12px;
}

/* Session blocks */
.sb-session-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px; }
@media(max-width:700px) { .sb-session-grid { grid-template-columns:1fr; } }
.sb-session {
    padding:8px 12px; border-radius:8px; border:1px solid var(--border);
    background:var(--bg-secondary); cursor:pointer; font-size:12px; transition:all .2s;
}
.sb-session:hover { border-color:var(--accent); }
.sb-session.active { border-color:var(--accent); background:rgba(99,102,241,0.1); }
.sb-session .sb-session-name { font-weight:700; margin-bottom:2px; }
.sb-session .sb-session-time { color:var(--text-muted); font-size:11px; }

/* Market regime */
.sb-regime-grid { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.sb-regime {
    padding:6px 14px; border-radius:16px; font-size:12px; font-weight:600;
    background:var(--bg-secondary); border:1px solid var(--border);
    color:var(--text-muted); cursor:pointer; transition:all .2s;
}
.sb-regime.active { border-color:var(--accent); color:var(--accent); background:rgba(99,102,241,0.1); }
.sb-regime:hover { border-color:var(--accent); }

/* Legs */
.sb-leg {
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:16px; margin-bottom:12px;
    position:relative;
}
.sb-leg-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.sb-leg-title { font-weight:700; font-size:14px; }
.sb-leg-tag {
    display:inline-block; padding:2px 10px; border-radius:10px; font-size:11px;
    font-weight:700; background:var(--accent); color:#fff; margin-left:8px;
}
.sb-leg-sub { font-size:11px; color:var(--text-muted); margin-top:2px; }
.sb-leg-badge {
    padding:3px 10px; border-radius:10px; font-size:11px; font-weight:600;
    background:rgba(16,185,129,0.15); color:var(--green);
}
.sb-leg-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
@media(max-width:700px) { .sb-leg-grid { grid-template-columns:1fr; } }
.sb-leg-field label { font-size:11px; color:var(--text-muted); display:block; margin-bottom:4px; }
.sb-leg-field select, .sb-leg-field input[type=number] {
    width:100%; padding:7px 10px; background:var(--bg-card); border:1px solid var(--border);
    border-radius:6px; color:var(--text-primary); font-size:13px;
}
.sb-tab-pair { display:flex; border-radius:8px; overflow:hidden; border:1px solid var(--border); }
.sb-tab-opt {
    flex:1; padding:7px 0; text-align:center; font-size:12px; font-weight:700;
    background:var(--bg-card); color:var(--text-muted); border:none; cursor:pointer;
    transition:all .15s;
}
.sb-tab-opt.buy { background:rgba(16,185,129,0.2); color:var(--green); }
.sb-tab-opt.sell { background:rgba(239,68,68,0.2); color:var(--red); }
.sb-tab-opt.on { background:var(--accent); color:#fff; }
.sb-num {
    display:flex; align-items:center; border:1px solid var(--border);
    border-radius:6px; overflow:hidden;
}
.sb-num button {
    width:32px; height:34px; background:var(--bg-card); border:none;
    color:var(--text-primary); font-size:16px; cursor:pointer;
}
.sb-num button:hover { background:var(--accent); color:#fff; }
.sb-num input {
    width:50px; text-align:center; border:none; background:var(--bg-secondary);
    color:var(--text-primary); font-size:13px; padding:6px 0;
}
.sb-leg-actions {
    position:absolute; top:12px; right:12px; display:flex; gap:6px;
}
.sb-leg-actions button {
    background:none; border:none; font-size:16px; cursor:pointer;
    color:var(--text-muted); transition:color .2s;
}
.sb-leg-actions button:hover { color:var(--red); }
.sb-leg-actions button.clone:hover { color:var(--accent); }

/* Strategies list */
.strat-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px; margin-bottom:10px;
    display:flex; justify-content:space-between; align-items:center;
}
.strat-info { flex:1; }
.strat-name { font-weight:700; font-size:15px; }
.strat-meta { font-size:12px; color:var(--text-muted); margin-top:4px; }
.strat-actions { display:flex; gap:8px; }
.strat-status-badge {
    padding:3px 12px; border-radius:12px; font-size:11px; font-weight:600;
}
.strat-status-badge.active { background:rgba(16,185,129,0.15); color:var(--green); }
.strat-status-badge.paused { background:rgba(245,158,11,0.15); color:var(--yellow); }

/* ── Loader ───────────────────────────────────────────────── */
.loader { display:flex; justify-content:center; padding:60px; }
.spinner {
    width:36px; height:36px; border:3px solid var(--border);
    border-top-color:var(--accent); border-radius:50%;
    animation:spin 0.8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

.empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
.empty-state h3 { font-size:18px; margin-bottom:8px; color:var(--text-secondary); }

/* ── Skeleton Loading ─────────────────────────────────────── */
.skeleton { position:relative; overflow:hidden; background:var(--bg-card); border-radius:var(--radius-sm); }
.skeleton::after {
    content:''; position:absolute; top:0; left:0; right:0; bottom:0;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
    animation:shimmer 1.5s infinite;
}
@keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
.skeleton-row { display:flex; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); }
.skeleton-cell { height:14px; border-radius:4px; }
.skeleton-cell.w-sm { width:40px; }
.skeleton-cell.w-md { width:100px; }
.skeleton-cell.w-lg { width:180px; }
.skeleton-circle { width:32px; height:32px; border-radius:50%; flex-shrink:0; }

/* ── Error State with Retry ───────────────────────────────── */
.error-state {
    text-align:center; padding:40px 20px; color:var(--text-muted);
}
.error-state .error-icon { font-size:36px; margin-bottom:12px; }
.error-state .error-msg { font-size:14px; margin-bottom:16px; color:var(--text-secondary); }
.retry-btn {
    padding:8px 20px; border-radius:var(--radius-sm);
    background:var(--accent); color:#fff; border:none;
    cursor:pointer; font-size:13px; font-weight:600;
    transition:opacity 0.2s;
}
.retry-btn:hover { opacity:0.85; }

/* ── Responsive ───────────────────────────────────────────── */
@media (max-width:768px) {
    .hero-steps { grid-template-columns:1fr; }
    .hero-title { font-size:32px; }
    .metrics-grid { grid-template-columns:1fr; }
    .toggle-row { flex-direction:column; }
    .nav-tabs { display:none; }
    .header { padding:0 12px; }
}

/* ── Toast Notifications ──────────────────────────────────── */
.toast-container {
    position:fixed; top:20px; right:20px; z-index:10000;
    display:flex; flex-direction:column; gap:8px;
}
.toast {
    padding:12px 20px; border-radius:10px; font-size:14px; color:#fff;
    min-width:280px; max-width:420px; box-shadow:0 8px 24px rgba(0,0,0,0.4);
    animation: toastIn 0.3s ease, toastOut 0.3s ease 3.7s forwards;
    backdrop-filter:blur(12px);
}
.toast.success { background:rgba(16,185,129,0.9); }
.toast.warning { background:rgba(245,158,11,0.9); }
.toast.info { background:rgba(99,102,241,0.85); }
.toast.error { background:rgba(239,68,68,0.9); }
@keyframes toastIn { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }
@keyframes toastOut { from { opacity:1; } to { opacity:0; transform:translateY(-10px); } }

/* ── PumpIQ Chat Bot Widget ───────────────────────────────── */
.bot-fab {
    position:fixed; bottom:24px; right:24px; z-index:9000;
    width:56px; height:56px; border-radius:50%;
    background:linear-gradient(135deg, #7c5cff, #00d4aa);
    border:none; cursor:pointer; color:#fff; font-size:26px;
    box-shadow:0 6px 24px rgba(124,92,255,0.5);
    display:flex; align-items:center; justify-content:center;
    transition:transform 0.2s, box-shadow 0.2s;
}
.bot-fab:hover { transform:scale(1.1); box-shadow:0 8px 32px rgba(124,92,255,0.7); }
.bot-fab.has-dot::after {
    content:''; position:absolute; top:6px; right:6px; width:10px; height:10px;
    background:var(--green); border-radius:50%; border:2px solid var(--bg-primary);
}

.bot-window {
    position:fixed; bottom:90px; right:24px; z-index:9001;
    width:400px; max-width:calc(100vw - 32px); height:520px; max-height:calc(100vh - 120px);
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:16px; display:none; flex-direction:column;
    box-shadow:0 16px 48px rgba(0,0,0,0.5); overflow:hidden;
    animation:botSlideIn 0.25s ease;
}
.bot-window.open { display:flex; }
@keyframes botSlideIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

.bot-header {
    padding:16px 20px; background:linear-gradient(135deg, #7c5cff22, #00d4aa11);
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
}
.bot-header-icon {
    width:36px; height:36px; border-radius:50%;
    background:linear-gradient(135deg, #7c5cff, #00d4aa);
    display:flex; align-items:center; justify-content:center; font-size:18px;
}
.bot-header-info h3 { margin:0; font-size:15px; color:var(--text-primary); }
.bot-header-info p { margin:2px 0 0; font-size:11px; color:var(--green); }
.bot-close {
    margin-left:auto; background:none; border:none; color:var(--text-muted);
    font-size:20px; cursor:pointer; padding:4px 8px; border-radius:6px;
}
.bot-close:hover { background:var(--bg-card); color:var(--text-primary); }

.bot-messages {
    flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px;
    scroll-behavior:smooth;
}
.bot-msg {
    max-width:88%; padding:12px 16px; border-radius:14px;
    font-size:13.5px; line-height:1.65; word-break:break-word;
}
.bot-msg.bot {
    align-self:flex-start; background:var(--bg-card); border:1px solid var(--border);
    border-bottom-left-radius:4px; color:var(--text-primary);
}
.bot-msg.user {
    align-self:flex-end; background:linear-gradient(135deg, #7c5cff, #6347e0);
    border-bottom-right-radius:4px; color:#fff;
}
.bot-msg.bot .bot-sources {
    margin-top:10px; padding-top:8px; border-top:1px solid var(--border);
    font-size:11px; color:var(--text-muted);
}

/* ── Bot Rich Content Styles ────────────────────────────────── */
.bot-msg.bot h3 {
    font-size:13.5px; font-weight:700; margin:14px 0 6px 0;
    color:var(--accent); letter-spacing:0.2px;
    padding-bottom:4px; border-bottom:1px solid var(--border);
}
.bot-msg.bot h3:first-child { margin-top:4px; }
.bot-msg.bot table {
    width:100%; border-collapse:collapse; margin:8px 0 12px;
    font-size:12px; line-height:1.5;
}
.bot-msg.bot thead th {
    text-align:left; padding:6px 8px; font-weight:600; font-size:11px;
    color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;
    border-bottom:2px solid var(--border); background:rgba(124,92,255,0.05);
}
.bot-msg.bot tbody td {
    padding:5px 8px; border-bottom:1px solid rgba(255,255,255,0.04);
    color:var(--text-secondary); font-size:12px;
}
.bot-msg.bot tbody tr:hover { background:rgba(124,92,255,0.04); }
.bot-msg.bot hr {
    border:none; border-top:1px solid var(--border); margin:12px 0;
}
.bot-msg.bot .bot-insight-box {
    background:rgba(124,92,255,0.06); border:1px solid rgba(124,92,255,0.15);
    border-radius:10px; padding:10px 14px; margin:8px 0;
    font-size:12.5px; line-height:1.6;
}
.bot-msg.bot .price-up { color:#10b981; font-weight:600; }
.bot-msg.bot .price-down { color:#ef4444; font-weight:600; }
.bot-msg.bot .metric-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:3px 0; border-bottom:1px solid rgba(255,255,255,0.03);
}
.bot-msg.bot .metric-label { color:var(--text-muted); font-size:12px; }
.bot-msg.bot .metric-value { color:var(--text-primary); font-weight:600; font-size:12.5px; }
.bot-msg.bot .bot-footer {
    margin-top:10px; padding-top:8px; border-top:1px solid var(--border);
    font-size:10.5px; color:var(--text-muted); font-style:italic; line-height:1.5;
}
.bot-typing {
    align-self:flex-start; padding:12px 18px; background:var(--bg-card);
    border:1px solid var(--border); border-radius:14px; border-bottom-left-radius:4px;
    display:none;
}
.bot-typing.show { display:flex; gap:5px; align-items:center; }
.bot-typing span {
    width:7px; height:7px; border-radius:50%; background:var(--text-muted);
    animation:botDot 1.4s infinite;
}
.bot-typing span:nth-child(2) { animation-delay:0.2s; }
.bot-typing span:nth-child(3) { animation-delay:0.4s; }
@keyframes botDot { 0%,60%,100% { opacity:0.3; transform:scale(0.8); } 30% { opacity:1; transform:scale(1.1); } }

.bot-input-area {
    padding:12px 16px; border-top:1px solid var(--border);
    display:flex; gap:8px; align-items:center; background:var(--bg-primary);
}
.bot-input-area input {
    flex:1; background:var(--bg-card); border:1px solid var(--border);
    border-radius:10px; padding:10px 14px; color:var(--text-primary);
    font-size:13.5px; outline:none;
}
.bot-input-area input:focus { border-color:var(--accent); }
.bot-input-area input::placeholder { color:var(--text-muted); }
.bot-send {
    width:38px; height:38px; border-radius:10px; border:none; cursor:pointer;
    background:linear-gradient(135deg, #7c5cff, #00d4aa); color:#fff;
    font-size:16px; display:flex; align-items:center; justify-content:center;
    transition:opacity 0.2s;
}
.bot-send:disabled { opacity:0.4; cursor:not-allowed; }
.bot-send:hover:not(:disabled) { opacity:0.9; }

.bot-suggestions {
    display:flex; flex-wrap:wrap; gap:6px; padding:0 16px 12px;
}
.bot-chip {
    padding:6px 12px; border-radius:20px; font-size:12px; cursor:pointer;
    background:var(--bg-card); border:1px solid var(--border); color:var(--text-secondary);
    transition:all 0.2s;
}

/* ══════════════════════════════════════════════════════════════ */
/* MODULE SHOWCASE & ENHANCED FEATURES                          */
/* ══════════════════════════════════════════════════════════════ */

/* ── Live Stats Banner ────────────────────────────────────── */
.live-stats-banner {
    display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
    margin-bottom:32px;
}
@media(max-width:768px) { .live-stats-banner { grid-template-columns:repeat(2,1fr); } }
.live-stat-card {
    background: var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:18px 20px;
    position:relative; overflow:hidden;
    transition:border-color 0.3s, transform 0.2s;
}
.live-stat-card:hover { border-color:var(--accent); transform:translateY(-2px); }
.live-stat-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    background:var(--gradient); opacity:0.8;
}
.live-stat-icon {
    font-size:28px; margin-bottom:8px; display:block;
}
.live-stat-value {
    font-size:24px; font-weight:800; color:var(--text-primary);
    font-variant-numeric:tabular-nums;
}
.live-stat-label {
    font-size:11px; color:var(--text-muted); text-transform:uppercase;
    letter-spacing:1px; margin-top:4px;
}
.live-stat-change {
    font-size:11px; font-weight:600; margin-top:4px;
}

/* ── Module Showcase Grid ─────────────────────────────────── */
.module-showcase {
    display:grid; grid-template-columns:repeat(3,1fr); gap:16px;
    margin-bottom:32px;
}
@media(max-width:900px) { .module-showcase { grid-template-columns:repeat(2,1fr); } }
@media(max-width:600px) { .module-showcase { grid-template-columns:1fr; } }
.module-card {
    background: var(--bg-card); border:1px solid var(--border);
    border-radius:16px; padding:24px; cursor:pointer;
    position:relative; overflow:hidden;
    transition:all 0.3s ease;
}
.module-card:hover {
    border-color:var(--accent); transform:translateY(-4px);
    box-shadow:0 12px 40px rgba(59,130,246,0.15);
}
.module-card.glow-green { border-left:3px solid var(--green); }
.module-card.glow-blue { border-left:3px solid var(--accent); }
.module-card.glow-purple { border-left:3px solid var(--purple); }
.module-card.glow-cyan { border-left:3px solid var(--cyan); }
.module-card.glow-yellow { border-left:3px solid var(--yellow); }
.module-card.glow-red { border-left:3px solid var(--red); }
.module-icon { font-size:32px; margin-bottom:12px; }
.module-title { font-size:16px; font-weight:700; margin-bottom:6px; }
.module-desc { font-size:12px; color:var(--text-secondary); line-height:1.5; margin-bottom:12px; }
.module-tags { display:flex; flex-wrap:wrap; gap:4px; }
.module-tag {
    padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600;
    background:rgba(59,130,246,0.1); color:var(--accent);
    text-transform:uppercase; letter-spacing:0.5px;
}
.module-status-dot {
    position:absolute; top:16px; right:16px;
    width:8px; height:8px; border-radius:50%; background:var(--green);
    box-shadow:0 0 8px rgba(16,185,129,0.6);
    animation:pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

/* ── Market Regime Banner ─────────────────────────────────── */
.regime-banner {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px 24px;
    margin-bottom:24px;
    display:flex; align-items:center; gap:20px; flex-wrap:wrap;
}
.regime-indicator {
    width:64px; height:64px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:28px; flex-shrink:0;
    border:3px solid transparent;
    animation:regimeGlow 3s infinite;
}
.regime-indicator.bullish { background:rgba(16,185,129,0.15); border-color:var(--green); }
.regime-indicator.bearish { background:rgba(239,68,68,0.15); border-color:var(--red); }
.regime-indicator.sideways { background:rgba(245,158,11,0.15); border-color:var(--yellow); }
.regime-indicator.volatile { background:rgba(139,92,246,0.15); border-color:var(--purple); }
.regime-indicator.accumulation { background:rgba(6,182,212,0.15); border-color:var(--cyan); }
@keyframes regimeGlow {
    0%,100% { box-shadow:0 0 15px rgba(59,130,246,0.2); }
    50% { box-shadow:0 0 25px rgba(59,130,246,0.4); }
}
.regime-info { flex:1; }
.regime-title { font-size:20px; font-weight:800; text-transform:capitalize; }
.regime-sub { font-size:13px; color:var(--text-secondary); margin-top:4px; }
.regime-coins { display:flex; gap:12px; flex-wrap:wrap; }
.regime-coin-chip {
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:8px 14px;
    font-size:12px; display:flex; flex-direction:column; gap:2px;
}
.regime-coin-name { font-weight:600; color:var(--text-primary); }
.regime-coin-regime { font-size:10px; text-transform:uppercase; letter-spacing:0.5px; }

/* ── AI Thought Summary ──────────────────────────────────── */
.thought-summary-box {
    background:linear-gradient(135deg, rgba(124,92,255,0.06) 0%, rgba(6,182,212,0.04) 100%);
    border:1px solid rgba(124,92,255,0.2);
    border-radius:var(--radius); padding:24px; margin-bottom:20px;
}
.thought-header {
    display:flex; align-items:center; gap:10px; margin-bottom:16px;
}
.thought-header h3 { font-size:16px; font-weight:700; }
.thought-badge {
    padding:3px 10px; border-radius:12px; font-size:10px; font-weight:700;
    background:rgba(124,92,255,0.15); color:var(--purple); letter-spacing:0.5px;
}
.thought-content { color:var(--text-secondary); font-size:13px; line-height:1.7; white-space:pre-wrap; }
.thought-steps {
    display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
    gap:12px; margin-top:16px;
}
.thought-step {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:14px;
}
.thought-step-num {
    font-size:10px; font-weight:700; color:var(--cyan); margin-bottom:4px;
    text-transform:uppercase; letter-spacing:1px;
}
.thought-step-text { font-size:12px; color:var(--text-secondary); line-height:1.5; }

/* ── Enhanced AI Recommendation Cards ─────────────────────── */
.enhanced-rec-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:16px; padding:24px; margin-bottom:16px;
    transition:border-color 0.3s;
}
.enhanced-rec-card:hover { border-color:var(--accent); }
.rec-card-header {
    display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;
}
.rec-card-info { flex:1; }
.rec-card-token { font-size:18px; font-weight:700; }
.rec-card-ticker { color:var(--text-muted); font-size:13px; margin-left:6px; }
.rec-card-price { font-size:14px; color:var(--text-secondary); margin-top:2px; }
.rec-confidence {
    text-align:center; min-width:72px;
}
.rec-confidence-ring {
    width:56px; height:56px; border-radius:50%; position:relative;
    display:flex; align-items:center; justify-content:center;
    margin:0 auto 4px;
}
.rec-confidence-value { font-size:16px; font-weight:800; }
.rec-confidence-label { font-size:10px; color:var(--text-muted); }
.rec-thesis {
    background:var(--bg-secondary); border-radius:var(--radius-sm);
    padding:12px 16px; font-size:13px; color:var(--text-secondary);
    line-height:1.6; margin-bottom:12px; border-left:3px solid var(--accent);
}
.rec-data-points {
    display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px;
}
.rec-data-pill {
    padding:4px 10px; border-radius:12px; font-size:11px;
    background:rgba(6,182,212,0.1); color:var(--cyan); border:1px solid rgba(6,182,212,0.2);
}
.rec-risk-pill {
    padding:4px 10px; border-radius:12px; font-size:11px;
    background:rgba(239,68,68,0.1); color:var(--red); border:1px solid rgba(239,68,68,0.2);
}
.rec-entry-exit {
    display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
    background:var(--bg-secondary); border-radius:var(--radius-sm); padding:12px;
}
@media(max-width:768px) { .rec-entry-exit { grid-template-columns:repeat(3,1fr); } }
.rec-entry-item { text-align:center; }
.rec-entry-label { font-size:10px; color:var(--text-muted); text-transform:uppercase; }
.rec-entry-value { font-size:13px; font-weight:700; margin-top:2px; }
.rec-verdict-bar {
    display:flex; align-items:center; justify-content:space-between;
    margin-top:12px; padding-top:12px; border-top:1px solid var(--border);
}

/* ── Learning Loop Dashboard ──────────────────────────────── */
.learning-hero {
    background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(139,92,246,0.08));
    border:1px solid rgba(59,130,246,0.2);
    border-radius:var(--radius); padding:28px; margin-bottom:28px;
    position:relative; overflow:hidden;
}
.learning-hero::before {
    content:''; position:absolute; top:-50%; right:-30%; width:300px; height:300px;
    background:radial-gradient(circle, rgba(59,130,246,0.06), transparent 70%);
    border-radius:50%;
}
.learning-hero-title {
    font-size:26px; font-weight:800; margin-bottom:6px;
    background:linear-gradient(135deg, var(--accent), var(--purple));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.learning-hero-desc {
    font-size:14px; color:var(--text-muted); max-width:600px; line-height:1.5;
}
.learning-actions {
    display:flex; gap:10px; margin:20px 0 0; flex-wrap:wrap;
}
.learning-actions .btn { border-radius:10px; font-weight:600; font-size:13px; padding:10px 18px; }

.learning-grid {
    display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
    margin-bottom:24px;
}
@media(max-width:768px) { .learning-grid { grid-template-columns:repeat(2,1fr); } }
.learning-stat {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; text-align:center;
    transition:all 0.25s ease; position:relative; overflow:hidden;
}
.learning-stat:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.15); }
.learning-stat-icon { font-size:28px; margin-bottom:8px; }
.learning-stat-value { font-size:28px; font-weight:800; }
.learning-stat-label { font-size:12px; color:var(--text-muted); margin-top:4px; }
.learning-stat-bar {
    position:absolute; bottom:0; left:0; height:3px;
    background:linear-gradient(90deg, var(--accent), var(--purple));
    transition:width 0.6s ease;
}

/* Accuracy Gauges */
.accuracy-gauges {
    display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:28px;
}
@media(max-width:768px) { .accuracy-gauges { grid-template-columns:1fr; } }
.accuracy-gauge-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:28px; text-align:center;
    position:relative; overflow:hidden;
}
.accuracy-gauge-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, var(--green), var(--accent));
}
.accuracy-ring {
    width:140px; height:140px; border-radius:50%; margin:0 auto 16px;
    background:conic-gradient(var(--green) var(--pct), rgba(255,255,255,0.06) var(--pct));
    display:flex; align-items:center; justify-content:center;
    position:relative; box-shadow:0 0 30px rgba(16,185,129,0.1);
    transition:all 0.6s ease;
}
.accuracy-ring::after {
    content:''; width:112px; height:112px; border-radius:50%;
    background:var(--bg-card); position:absolute;
}
.accuracy-ring-text {
    position:relative; z-index:1;
    font-size:28px; font-weight:800; color:var(--text-primary);
}
.accuracy-gauge-label {
    font-size:14px; font-weight:600; color:var(--text-secondary); margin-bottom:4px;
}
.accuracy-gauge-sub {
    font-size:12px; color:var(--text-muted);
}

/* Regime cards */
.regime-grid {
    display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:12px;
}
.regime-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px; text-align:center;
    transition:all 0.25s ease;
}
.regime-card:hover { border-color:var(--accent); transform:translateY(-1px); }
.regime-name {
    font-size:13px; font-weight:700; text-transform:capitalize;
    margin-bottom:8px; color:var(--text-secondary);
}
.regime-pct {
    font-size:26px; font-weight:800; margin-bottom:4px;
}
.regime-detail {
    font-size:11px; color:var(--text-muted);
}
.regime-bar {
    height:4px; border-radius:2px; background:rgba(255,255,255,0.06);
    margin-top:10px; overflow:hidden;
}
.regime-bar-fill {
    height:100%; border-radius:2px; transition:width 0.6s ease;
}

/* Prediction cards */
.prediction-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:12px 16px; border-bottom:1px solid var(--border);
    transition:background 0.15s ease;
}
.prediction-row:last-child { border-bottom:none; }
.prediction-row:hover { background:rgba(255,255,255,0.02); }
.prediction-ticker {
    font-weight:700; font-size:14px; min-width:70px;
}
.prediction-verdict {
    font-size:11px; padding:3px 8px; border-radius:6px; font-weight:600;
}
.prediction-pnl {
    font-weight:800; font-size:15px; min-width:80px; text-align:right;
}

/* Adjustment cards enhanced */
.adjustment-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:18px; margin-bottom:12px;
    transition:all 0.25s ease; position:relative; overflow:hidden;
}
.adjustment-card:hover { border-color:var(--accent); }
.adjustment-card::before {
    content:''; position:absolute; top:0; left:0; bottom:0; width:3px;
}
.adjustment-card.adj-decrease::before { background:var(--red); }
.adjustment-card.adj-increase::before { background:var(--green); }
.adjustment-card.adj-hold::before { background:var(--yellow); }
.adjustment-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.adjustment-type {
    padding:3px 10px; border-radius:6px; font-size:10px; font-weight:700;
    text-transform:uppercase; letter-spacing:0.5px;
}
.adjustment-type.increase { background:rgba(16,185,129,0.12); color:var(--green); }
.adjustment-type.decrease { background:rgba(239,68,68,0.12); color:var(--red); }
.adjustment-type.hold { background:rgba(245,158,11,0.12); color:var(--yellow); }
.adjustment-detail { font-size:13px; color:var(--text-secondary); line-height:1.6; }
.adjustment-reason { font-size:11px; color:var(--text-muted); margin-top:8px; font-style:italic; }

/* Section panels */
.learning-panel {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); margin-bottom:20px; overflow:hidden;
}
.learning-panel-header {
    padding:18px 20px; font-size:15px; font-weight:700;
    display:flex; align-items:center; gap:10px;
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.01);
}
.learning-panel-body { padding:0; }
.learning-panel-body.padded { padding:20px; }

/* Token search */
.token-search-wrap {
    display:flex; gap:10px; margin-bottom:16px;
}
.token-search-wrap input {
    flex:1; background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:10px; padding:12px 16px; color:var(--text-primary);
    font-size:14px; outline:none; transition:border 0.2s;
}
.token-search-wrap input:focus { border-color:var(--accent); }
.token-search-wrap .btn { border-radius:10px; }

/* ── Market Insights Page ──────────────────────────────────── */
.insight-hero {
    background:linear-gradient(135deg, rgba(139,92,246,0.1), rgba(6,182,212,0.08), rgba(59,130,246,0.06));
    border:1px solid rgba(139,92,246,0.2);
    border-radius:var(--radius); padding:32px; margin-bottom:28px;
    position:relative; overflow:hidden;
}
.insight-hero::before {
    content:''; position:absolute; top:-60px; right:-40px; width:250px; height:250px;
    background:radial-gradient(circle, rgba(139,92,246,0.08), transparent 70%);
    border-radius:50%;
}
.insight-hero::after {
    content:''; position:absolute; bottom:-80px; left:-60px; width:300px; height:300px;
    background:radial-gradient(circle, rgba(6,182,212,0.06), transparent 70%);
    border-radius:50%;
}
.insight-hero-title {
    font-size:28px; font-weight:800; margin-bottom:6px;
    background:linear-gradient(135deg, var(--purple), var(--cyan));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    position:relative;
}
.insight-hero-desc {
    font-size:14px; color:var(--text-muted); max-width:600px; line-height:1.6;
    position:relative;
}
.insight-search-wrap {
    display:flex; gap:12px; margin-top:24px; position:relative;
}
.insight-search-input {
    flex:1; background:rgba(17,24,39,0.8); border:1px solid var(--border);
    border-radius:12px; padding:14px 20px 14px 44px; color:var(--text-primary);
    font-size:15px; outline:none; transition:all 0.3s ease;
    backdrop-filter:blur(8px);
}
.insight-search-input:focus {
    border-color:var(--purple); box-shadow:0 0 20px rgba(139,92,246,0.15);
}
.insight-search-icon {
    position:absolute; left:16px; top:50%; transform:translateY(-50%);
    font-size:18px; color:var(--text-muted); pointer-events:none;
}
.insight-analyze-btn {
    background:var(--gradient); border:none; color:#fff; padding:14px 28px;
    border-radius:12px; font-weight:700; font-size:14px; cursor:pointer;
    transition:all 0.3s ease; white-space:nowrap;
}
.insight-analyze-btn:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(59,130,246,0.3); }
.insight-analyze-btn:active { transform:translateY(0); }

.insight-chips {
    display:flex; gap:10px; flex-wrap:wrap; margin-top:20px; position:relative;
}
.insight-chip {
    background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
    border-radius:10px; padding:8px 16px; font-size:13px; font-weight:600;
    color:var(--text-secondary); cursor:pointer; transition:all 0.25s ease;
    display:flex; align-items:center; gap:6px;
}
.insight-chip:hover {
    background:rgba(139,92,246,0.1); border-color:var(--purple);
    color:var(--text-primary); transform:translateY(-1px);
}
.insight-chip-icon { font-size:16px; }

/* Insight results */
.insight-token-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px; margin-bottom:20px;
    display:flex; align-items:center; gap:20px;
    position:relative; overflow:hidden;
}
.insight-token-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    background:var(--gradient);
}
.insight-token-img {
    width:56px; height:56px; border-radius:50%;
    border:2px solid var(--border); box-shadow:0 0 20px rgba(0,0,0,0.3);
}
.insight-token-name { font-size:24px; font-weight:800; }
.insight-token-sym { color:var(--text-muted); font-size:13px; font-weight:600; text-transform:uppercase; }
.insight-token-price { font-size:28px; font-weight:800; }
.insight-token-change { font-size:14px; font-weight:600; margin-top:2px; }

.insight-score-grid {
    display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:20px;
}
@media(max-width:900px) { .insight-score-grid { grid-template-columns:repeat(2,1fr); } }
.insight-score-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; text-align:center;
    position:relative; overflow:hidden; transition:all 0.25s ease;
}
.insight-score-card:hover { border-color:var(--purple); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.15); }
.insight-score-icon { font-size:28px; margin-bottom:8px; }
.insight-score-value { font-size:28px; font-weight:800; }
.insight-score-label { font-size:12px; color:var(--text-muted); margin-top:4px; }
.insight-score-bar {
    position:absolute; bottom:0; left:0; height:3px;
    transition:width 0.6s ease;
}

/* Insight panels */
.insight-panel {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); margin-bottom:20px; overflow:hidden;
}
.insight-panel-header {
    padding:18px 20px; font-size:15px; font-weight:700;
    display:flex; align-items:center; gap:10px;
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.01);
}
.insight-panel-body { padding:20px; }
.insight-ta-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.04);
}
.insight-ta-row:last-child { border-bottom:none; }
.insight-ta-label { color:var(--text-muted); font-size:13px; }
.insight-ta-value { font-weight:700; font-size:14px; }
.insight-ta-badge {
    padding:3px 10px; border-radius:6px; font-size:11px; font-weight:700;
    text-transform:uppercase;
}

.insight-news-item {
    padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.04);
    font-size:13px; color:var(--text-secondary); line-height:1.5;
    display:flex; align-items:flex-start; gap:10px;
}
.insight-news-item:last-child { border-bottom:none; }
.insight-news-dot {
    width:6px; height:6px; border-radius:50%; margin-top:6px; flex-shrink:0;
}

.insight-ai-box {
    background:linear-gradient(135deg, rgba(139,92,246,0.06), rgba(59,130,246,0.04));
    border:1px solid rgba(139,92,246,0.2);
    border-radius:var(--radius); padding:24px; margin-bottom:20px;
    position:relative; overflow:hidden;
}
.insight-ai-box::before {
    content:''; position:absolute; top:0; left:0; bottom:0; width:3px;
    background:linear-gradient(180deg, var(--purple), var(--accent));
}
.insight-ai-header {
    display:flex; align-items:center; gap:10px; margin-bottom:14px;
    font-size:16px; font-weight:700;
}
.insight-ai-text {
    font-size:14px; line-height:1.8; color:var(--text-secondary); white-space:pre-wrap;
}

.insight-market-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.04);
}
.insight-market-row:last-child { border-bottom:none; }

.insight-empty {
    text-align:center; padding:60px 20px;
}
.insight-empty-icon {
    font-size:64px; margin-bottom:20px; opacity:0.6;
}
.insight-empty-title {
    font-size:18px; font-weight:700; margin-bottom:10px; color:var(--text-primary);
}
.insight-empty-desc {
    font-size:13px; color:var(--text-muted); max-width:420px; margin:0 auto; line-height:1.6;
}
.insight-features {
    display:flex; gap:16px; justify-content:center; flex-wrap:wrap; margin-top:24px;
}
.insight-feature-tag {
    background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06);
    border-radius:8px; padding:6px 14px; font-size:12px; color:var(--text-muted);
    font-weight:500;
}

/* ── Personalization / Settings Page ──────────────────────── */
.settings-section {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px; margin-bottom:20px;
}
.settings-section-title {
    font-size:16px; font-weight:700; margin-bottom:16px;
    display:flex; align-items:center; gap:8px;
}
.pref-slider-row {
    display:flex; align-items:center; gap:16px; margin-bottom:16px;
}
.pref-slider-label { width:140px; font-size:13px; color:var(--text-secondary); flex-shrink:0; }
.pref-slider {
    flex:1; -webkit-appearance:none; appearance:none;
    height:6px; border-radius:3px; background:var(--border); outline:none;
}
.pref-slider::-webkit-slider-thumb {
    -webkit-appearance:none; appearance:none;
    width:18px; height:18px; border-radius:50%;
    background:var(--accent); cursor:pointer; border:2px solid var(--bg-primary);
}
.pref-slider-value {
    width:40px; text-align:center; font-weight:700; font-size:14px;
    color:var(--accent);
}
.pref-chip-group { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
.pref-chip {
    padding:8px 16px; border-radius:var(--radius-sm);
    background:var(--bg-secondary); border:2px solid var(--border);
    color:var(--text-secondary); font-size:13px; cursor:pointer;
    transition:all 0.2s; font-weight:500;
}
.pref-chip:hover { border-color:var(--text-muted); }
.pref-chip.selected {
    border-color:var(--accent); color:var(--accent);
    background:var(--accent-glow);
}

/* ── Section Divider ──────────────────────────────────────── */
.section-divider {
    display:flex; align-items:center; gap:16px;
    margin:32px 0 20px; color:var(--text-muted); font-size:13px;
    font-weight:600; text-transform:uppercase; letter-spacing:1px;
}
.section-divider::after {
    content:''; flex:1; height:1px; background:var(--border);
}

/* ── Floating Gradient Orbs (decoration) ──────────────────── */
.orb {
    position:absolute; border-radius:50%; filter:blur(80px); pointer-events:none; opacity:0.07;
}
.orb-1 { width:300px; height:300px; background:#3b82f6; top:-100px; left:-100px; }
.orb-2 { width:250px; height:250px; background:#8b5cf6; top:200px; right:-50px; }
.orb-3 { width:200px; height:200px; background:#06b6d4; bottom:-50px; left:30%; }
.bot-chip:hover { border-color:var(--accent); color:var(--accent); }

/* ═══════════════════════════════════════════════════════════ */
/* TRADINGVIEW WIDGET STYLES                                   */
/* ═══════════════════════════════════════════════════════════ */

/* Ticker Tape */
.tv-ticker-tape-wrap {
    position:sticky; top:60px; z-index:90;
    background:linear-gradient(135deg, rgba(10,14,23,0.95), rgba(26,31,46,0.95));
    border-bottom:1px solid var(--border);
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
    overflow:hidden;
    min-height:0;
    height:46px;
    transition:height 0.3s ease, opacity 0.3s ease;
}
.tv-ticker-tape-wrap.tv-collapsed {
    height:0 !important;
    min-height:0;
    border:none;
    pointer-events:none;
    opacity:0;
}
.tv-ticker-tape-wrap iframe {
    pointer-events:auto;
}

/* TV Loading / Error states */
.tv-loading {
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    height:100%;min-height:200px;color:var(--text-muted);font-size:13px;gap:12px;
}
.tv-loading .spinner { width:28px;height:28px; }
.tv-error {
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    height:100%;min-height:200px;color:var(--text-muted);font-size:13px;gap:12px;
    text-align:center;padding:24px;
}
.tv-error-icon { font-size:32px; opacity:0.5; }
.tv-retry-btn {
    padding:8px 20px;border:1px solid var(--accent);background:transparent;
    color:var(--accent);border-radius:8px;cursor:pointer;font-size:13px;
    font-weight:600;transition:all 0.2s;
}
.tv-retry-btn:hover { background:var(--accent);color:#fff; }

/* Chart Container */
.tv-chart-container {
    margin:16px 0 20px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:var(--bg-card);
    overflow:hidden;
    animation:tvSlideIn 0.4s ease;
}
@keyframes tvSlideIn {
    from { opacity:0; transform:translateY(12px); }
    to { opacity:1; transform:translateY(0); }
}

.tv-chart-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 16px;
    background:linear-gradient(135deg, rgba(59,130,246,0.08), rgba(139,92,246,0.08));
    border-bottom:1px solid var(--border);
}

.tv-chart-label {
    font-weight:700;
    font-size:14px;
    color:var(--text-primary);
    display:flex;
    align-items:center;
    gap:6px;
}

.tv-chart-timeframes {
    display:flex;
    gap:6px;
}

.tv-tf-btn {
    padding:5px 12px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--text-secondary);
    font-size:12px;
    font-weight:600;
    border-radius:6px;
    cursor:pointer;
    transition:all 0.15s ease;
}
.tv-tf-btn:hover {
    border-color:var(--accent);
    color:var(--accent);
    background:rgba(59,130,246,0.08);
}
.tv-tf-btn.active {
    background:var(--accent);
    color:#fff;
    border-color:var(--accent);
    box-shadow:0 0 12px rgba(59,130,246,0.3);
}
.tv-tf-sm {
    padding:3px 8px;
    font-size:11px;
}

/* Technical Analysis Widget Box */
.tv-ta-row {
    margin-bottom:20px;
}
.tv-ta-box {
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:var(--bg-card);
    overflow:hidden;
}
.tv-ta-box-header {
    padding:12px 16px;
    font-weight:700;
    font-size:14px;
    background:linear-gradient(135deg, rgba(139,92,246,0.08), rgba(6,182,212,0.08));
    border-bottom:1px solid var(--border);
}

/* Market Overview */
.tv-market-overview {
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:var(--bg-card);
    overflow:hidden;
    padding:12px;
}

/* Heatmap */
.tv-heatmap-container {
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:var(--bg-card);
    overflow:hidden;
}

/* Modal Chart */
.tv-modal-chart-wrap {
    margin:16px 0;
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:var(--bg-card);
    overflow:hidden;
}

/* TradingView Attribution Override (dark theme) */
.tradingview-widget-copyright {
    display:none !important;
}

/* Responsive */
@media (max-width:768px) {
    .tv-chart-header {
        flex-direction:column;
        gap:8px;
        align-items:flex-start;
    }
    .tv-chart-timeframes {
        flex-wrap:wrap;
    }
    .tv-ticker-tape-wrap {
        top:48px;
    }
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- HEADER                                                     -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="header">
    <div class="logo" onclick="navigate('home')">PumpIQ</div>
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="home">Home</button>
        <button class="nav-tab" data-page="feed">Token Feed</button>
        <button class="nav-tab" data-page="ai">AI Recs</button>
        <button class="nav-tab" data-page="insights">🧠 Insights</button>
        <button class="nav-tab" data-page="learning">📊 Learning</button>
        <button class="nav-tab" data-page="leaderboard">Leaderboard</button>
        <button class="nav-tab" data-page="market">Market</button>
        <button class="nav-tab" data-page="trader">🤖 Auto Trader</button>
        <button class="nav-tab" data-page="settings">⚙️</button>
    </div>
    <div class="header-right">
        <input class="search-box" id="globalSearch" placeholder="Search tokens..." onkeydown="if(event.key==='Enter')doSearch()">
        <div id="authArea">
            <button class="btn btn-primary" onclick="showAuthModal('login')">Login</button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- TRADINGVIEW TICKER TAPE                                    -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="tv-ticker-tape-wrap" id="tvTickerWrap">
    <iframe id="tvTickerFrame" style="width:100%;height:46px;border:none;display:block;pointer-events:auto"
        frameborder="0" allowtransparency="true" scrolling="no"></iframe>
</div>
<script>
(function() {
    var cfg = {symbols:[{proName:"BINANCE:BTCUSDT",title:"Bitcoin"},{proName:"BINANCE:ETHUSDT",title:"Ethereum"},{proName:"BINANCE:SOLUSDT",title:"Solana"},{proName:"BINANCE:XRPUSDT",title:"XRP"},{proName:"BINANCE:DOGEUSDT",title:"Doge"},{proName:"BINANCE:ADAUSDT",title:"Cardano"},{proName:"BINANCE:AVAXUSDT",title:"AVAX"},{proName:"BINANCE:LINKUSDT",title:"Chainlink"},{proName:"BINANCE:DOTUSDT",title:"Polkadot"},{proName:"BINANCE:MATICUSDT",title:"Polygon"}],showSymbolLogo:true,isTransparent:true,displayMode:"adaptive",colorTheme:"dark",locale:"en"};
    var wrap = document.getElementById('tvTickerWrap');
    var f = document.getElementById('tvTickerFrame');
    var loaded = false;
    f.src = 'https://s.tradingview.com/embed-widget/ticker-tape/?locale=en#' + encodeURIComponent(JSON.stringify(cfg));
    f.onload = function() { loaded = true; };
    f.onerror = function() { wrap.classList.add('tv-collapsed'); };
    // Fallback: collapse if not loaded after 15s
    setTimeout(function() {
        if (!loaded) wrap.classList.add('tv-collapsed');
    }, 15000);
})();
</script>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- HOME PAGE                                                  -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page active" id="page-home">
    <div class="hero" style="position:relative;overflow:hidden">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="hero-tag">AI-POWERED CRYPTO INTELLIGENCE</div>
        <h1 class="hero-title">See through the noise.</h1>
        <p class="hero-desc">
            PumpIQ fuses real-time data, multi-model AI reasoning, and transparent analytics to give you an unfair edge in crypto markets.
        </p>
        <div class="hero-steps">
            <div class="step-card">
                <div class="step-num">STEP 01</div>
                <div class="step-title">🔍 Browse</div>
                <div class="step-desc">Scan 1000+ tokens from CoinGecko + DexScreener with live price feeds and market cap data.</div>
            </div>
            <div class="step-card">
                <div class="step-num">STEP 02</div>
                <div class="step-title">🧠 Analyze</div>
                <div class="step-desc">AI scores every token using 15+ indicators — RSI, MACD, volume anomalies, news sentiment & more.</div>
            </div>
            <div class="step-card">
                <div class="step-num">STEP 03</div>
                <div class="step-title">⚡ Act</div>
                <div class="step-desc">Auto-trade with AI-managed positions, stop-loss, take-profit, and full blockchain audit trail.</div>
            </div>
        </div>
    </div>

    <!-- ── Live Platform Stats ─────────────────────────────── -->
    <div class="section-divider">📊 Live Platform Metrics</div>
    <div class="live-stats-banner">
        <div class="live-stat-card">
            <span class="live-stat-icon">🪙</span>
            <div class="live-stat-value" id="homeStatTokens">--</div>
            <div class="live-stat-label">Tokens Tracked</div>
        </div>
        <div class="live-stat-card">
            <span class="live-stat-icon">🧠</span>
            <div class="live-stat-value" id="homeStatAIScans">--</div>
            <div class="live-stat-label">AI Analyses Run</div>
        </div>
        <div class="live-stat-card">
            <span class="live-stat-icon">📈</span>
            <div class="live-stat-value" id="homeStatRegime">--</div>
            <div class="live-stat-label">Market Regime</div>
        </div>
        <div class="live-stat-card">
            <span class="live-stat-icon">🤖</span>
            <div class="live-stat-value" id="homeStatAutoTrades">--</div>
            <div class="live-stat-label">Auto Trades Today</div>
        </div>
    </div>

    <!-- ── Module Showcase ─────────────────────────────────── -->
    <div class="section-divider">🔌 Platform Modules — All Active</div>
    <div class="module-showcase">
        <div class="module-card glow-purple" onclick="navigate('ai')">
            <div class="module-status-dot"></div>
            <div class="module-icon">🧠</div>
            <div class="module-title">AI Recommendation Engine</div>
            <div class="module-desc">Multi-model AI pipeline with GPT + Gemini reasoning, confidence scoring, and transparent thought summaries.</div>
            <div class="module-tags">
                <span class="module-tag">Orchestrator</span>
                <span class="module-tag">Confidence</span>
                <span class="module-tag">NLG</span>
            </div>
        </div>
        <div class="module-card glow-cyan" onclick="navigate('market')">
            <div class="module-status-dot"></div>
            <div class="module-icon">📡</div>
            <div class="module-title">Real-Time Crypto Data Layer</div>
            <div class="module-desc">Live feeds from CoinGecko, DexScreener, and news aggregators powering every analysis in real-time.</div>
            <div class="module-tags">
                <span class="module-tag">CoinGecko</span>
                <span class="module-tag">DexScreener</span>
                <span class="module-tag">News</span>
            </div>
        </div>
        <div class="module-card glow-green" onclick="navigate('insights')">
            <div class="module-status-dot"></div>
            <div class="module-icon">📊</div>
            <div class="module-title">Intelligent Market Analysis</div>
            <div class="module-desc">15+ technical indicators including RSI, MACD, Bollinger Bands, market regime detection, and breakout quality scoring.</div>
            <div class="module-tags">
                <span class="module-tag">TA Suite</span>
                <span class="module-tag">Regime</span>
                <span class="module-tag">Breakout</span>
            </div>
        </div>
        <div class="module-card glow-blue" onclick="navigate('settings')">
            <div class="module-status-dot"></div>
            <div class="module-icon">👤</div>
            <div class="module-title">Auth & Personalization</div>
            <div class="module-desc">JWT authentication, user preferences, risk profiles, watchlists, and AI sensitivity controls.</div>
            <div class="module-tags">
                <span class="module-tag">JWT Auth</span>
                <span class="module-tag">Risk Profile</span>
                <span class="module-tag">Watchlist</span>
            </div>
        </div>
        <div class="module-card glow-yellow" onclick="navigate('trader')">
            <div class="module-status-dot"></div>
            <div class="module-icon">🤖</div>
            <div class="module-title">AI-Assisted Auto-Trading</div>
            <div class="module-desc">Autonomous trading with position management, stop-loss/take-profit, risk controls, and blockchain-verified transactions.</div>
            <div class="module-tags">
                <span class="module-tag">Auto Trade</span>
                <span class="module-tag">Risk Mgmt</span>
                <span class="module-tag">Blockchain</span>
            </div>
        </div>
        <div class="module-card glow-red" onclick="navigate('learning')">
            <div class="module-status-dot"></div>
            <div class="module-icon">🔄</div>
            <div class="module-title">Continuous Learning Loop</div>
            <div class="module-desc">AI tracks its own predictions, evaluates accuracy over time, and auto-adjusts strategies based on performance.</div>
            <div class="module-tags">
                <span class="module-tag">Accuracy</span>
                <span class="module-tag">Feedback</span>
                <span class="module-tag">Self-Improve</span>
            </div>
        </div>
    </div>

    <!-- Trending Pills -->
    <div style="margin-bottom:24px">
        <h3 style="font-size:16px;margin-bottom:12px;color:var(--text-secondary)">🔥 Trending</h3>
        <div id="trendingBar" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- Quick Market Table -->
    <div class="section-title">Top Coins</div>
    <div class="section-desc">Live market data from CoinGecko</div>
    <div style="overflow-x:auto">
        <table class="feed-table" id="homeMarketTable">
            <thead><tr><th>#</th><th>Token</th><th>Price</th><th>24h</th><th>Market Cap</th><th>Volume</th></tr></thead>
            <tbody id="homeMarketBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- TOKEN FEED PAGE                                            -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-feed">
    <div class="section-title">Token Feed</div>
    <div class="section-desc" id="feedCount">Live tokens from DexScreener</div>

    <div class="filter-bar">
        <div class="filter-pill active" data-sort="volume" onclick="setFeedSort(this)">Volume</div>
        <div class="filter-pill" data-sort="newest" onclick="setFeedSort(this)">Newest</div>
        <div class="filter-pill" data-sort="price" onclick="setFeedSort(this)">Price</div>
        <div class="filter-pill" data-sort="trades" onclick="setFeedSort(this)">Trades</div>
        <div style="width:1px;height:24px;background:var(--border);margin:0 8px"></div>
        <div class="filter-pill active" data-status="all" onclick="setFeedStatus(this)">All</div>
        <div class="filter-pill" data-status="active" onclick="setFeedStatus(this)">Active</div>
        <div class="filter-pill" data-status="graduated" onclick="setFeedStatus(this)">Graduated</div>
        <div style="flex:1"></div>
        <input class="search-box" style="width:180px" placeholder="Search feed..." oninput="filterFeedLocal(this.value)">
    </div>

    <div style="overflow-x:auto">
        <table class="feed-table">
            <thead><tr><th>Token</th><th>Price</th><th>24h</th><th>Volume</th><th>Liquidity</th><th>Trades</th><th>Age</th></tr></thead>
            <tbody id="feedBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- AI RECOMMENDATIONS PAGE                                    -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-ai">
    <div class="section-title">AI Recommendations</div>
    <div class="section-desc">Configure data sources and let AI find the best tokens right now.</div>

    <!-- CoinGecko Market Summary Mini -->
    <div class="market-summary-box" style="margin-bottom:16px">
        <h4>Global Market (CoinGecko)</h4>
        <p id="aiMarketGlobal">Loading market data...</p>
    </div>

    <!-- Toggles -->
    <div class="toggle-row">
        <div class="toggle-item">
            <div class="simple-toggle" id="toggleOnchain" onclick="toggleSwitch(this)"></div>
            <div>
                <div class="toggle-label">On-Chain</div>
                <div class="toggle-desc">Holders, volume, curve progress, creator activity</div>
            </div>
        </div>
        <div class="toggle-item">
            <div class="simple-toggle" id="toggleTechnical" onclick="toggleSwitch(this)"></div>
            <div>
                <div class="toggle-label">Technical</div>
                <div class="toggle-desc">Price momentum, trade velocity, trend direction</div>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
        <button class="btn btn-green" onclick="loadAIRecs()">🔍 Quick Analyze</button>
        <button class="btn btn-primary" onclick="loadEnhancedAIRecs()">🧠 Enhanced AI (with Thought Summary)</button>
    </div>

    <div id="aiTimestamp" style="color:var(--text-muted);font-size:12px;margin-bottom:12px"></div>

    <!-- AI Thought Summary (from Enhanced endpoint) -->
    <div class="thought-summary-box" id="aiThoughtBox" style="display:none">
        <div class="thought-header">
            <span style="font-size:22px">🧠</span>
            <h3>AI Thought Summary</h3>
            <span class="thought-badge">TRANSPARENT REASONING</span>
        </div>
        <div class="thought-content" id="aiThoughtContent"></div>
        <div class="thought-steps" id="aiThoughtSteps"></div>
    </div>

    <!-- Market Summary -->
    <div class="market-summary-box" id="aiSummaryBox" style="display:none">
        <h4>Market Summary</h4>
        <p id="aiSummaryText"></p>
    </div>

    <!-- Enhanced Scored Tokens (for enhanced mode) -->
    <div id="aiEnhancedCards" style="display:none"></div>

    <!-- Scored Tokens (quick mode) -->
    <div class="cards-grid" id="aiCards"></div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- INSIGHTS PAGE                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-insights">
    <!-- Hero -->
    <div class="insight-hero">
        <div class="insight-hero-title">🧠 Market Insights</div>
        <div class="insight-hero-desc">
            Deep technical analysis with 15+ indicators — RSI, MACD, Bollinger Bands, support/resistance, market regime detection, news sentiment, and AI-powered recommendations.
        </div>
        <div class="insight-search-wrap">
            <span class="insight-search-icon">🔍</span>
            <input class="insight-search-input" id="insightSearch" placeholder="Search any coin — bitcoin, ethereum, solana, dogecoin..."
                   onkeydown="if(event.key==='Enter')loadInsightAnalysis()">
            <button class="insight-analyze-btn" onclick="loadInsightAnalysis()">⚡ Analyze</button>
        </div>
        <div class="insight-chips">
            <div class="insight-chip" onclick="quickInsight('bitcoin')"><span class="insight-chip-icon">₿</span> Bitcoin</div>
            <div class="insight-chip" onclick="quickInsight('ethereum')"><span class="insight-chip-icon">Ξ</span> Ethereum</div>
            <div class="insight-chip" onclick="quickInsight('solana')"><span class="insight-chip-icon">◎</span> Solana</div>
            <div class="insight-chip" onclick="quickInsight('ripple')"><span class="insight-chip-icon">✕</span> XRP</div>
            <div class="insight-chip" onclick="quickInsight('dogecoin')"><span class="insight-chip-icon">🐕</span> Doge</div>
            <div class="insight-chip" onclick="quickInsight('cardano')"><span class="insight-chip-icon">₳</span> Cardano</div>
            <div class="insight-chip" onclick="quickInsight('avalanche-2')"><span class="insight-chip-icon">🔺</span> AVAX</div>
            <div class="insight-chip" onclick="quickInsight('chainlink')"><span class="insight-chip-icon">🔗</span> LINK</div>
        </div>
    </div>

    <!-- Results -->
    <div id="insightResult" style="display:none">
        <!-- Token header card -->
        <div class="insight-token-card" id="insightTokenCard">
            <img class="insight-token-img" id="insightTokenImg" src="" alt="">
            <div>
                <div class="insight-token-name" id="insightTokenName"></div>
                <div class="insight-token-sym" id="insightTokenSymbol"></div>
            </div>
            <div style="margin-left:auto;text-align:right">
                <div class="insight-token-price" id="insightTokenPrice"></div>
                <div class="insight-token-change" id="insightTokenChange"></div>
            </div>
        </div>

        <!-- TradingView Advanced Chart -->
        <div class="tv-chart-container" id="insightTVChart" style="display:none">
            <div class="tv-chart-header">
                <span class="tv-chart-label">📈 Live Chart</span>
                <div class="tv-chart-timeframes">
                    <button class="tv-tf-btn active" onclick="switchInsightTF('1', this)">1m</button>
                    <button class="tv-tf-btn" onclick="switchInsightTF('5', this)">5m</button>
                    <button class="tv-tf-btn" onclick="switchInsightTF('15', this)">15m</button>
                    <button class="tv-tf-btn" onclick="switchInsightTF('60', this)">1H</button>
                    <button class="tv-tf-btn" onclick="switchInsightTF('240', this)">4H</button>
                    <button class="tv-tf-btn" onclick="switchInsightTF('D', this)">1D</button>
                    <button class="tv-tf-btn" onclick="switchInsightTF('W', this)">1W</button>
                </div>
            </div>
            <div id="insightTVChartWidget" style="height:420px;border-radius:0 0 12px 12px;overflow:hidden"></div>
        </div>

        <!-- TradingView Technical Analysis Widget -->
        <div class="tv-ta-row" id="insightTVTA" style="display:none">
            <div class="tv-ta-box">
                <div class="tv-ta-box-header">🔮 TradingView Technical Analysis</div>
                <div id="insightTVTAWidget" style="height:280px;overflow:hidden"></div>
            </div>
        </div>

        <!-- Score cards -->
        <div class="insight-score-grid">
            <div class="insight-score-card">
                <div class="insight-score-icon">📊</div>
                <div class="insight-score-value" id="insightTAScore">--</div>
                <div class="insight-score-label">TA Score (0-10)</div>
                <div class="insight-score-bar" id="insightTABar" style="width:0%;background:var(--accent)"></div>
            </div>
            <div class="insight-score-card">
                <div class="insight-score-icon">📈</div>
                <div class="insight-score-value" id="insightRSI">--</div>
                <div class="insight-score-label">RSI (14)</div>
                <div class="insight-score-bar" id="insightRSIBar" style="width:0%;background:var(--green)"></div>
            </div>
            <div class="insight-score-card">
                <div class="insight-score-icon">💹</div>
                <div class="insight-score-value" id="insightTrend">--</div>
                <div class="insight-score-label">Trend Direction</div>
                <div class="insight-score-bar" id="insightTrendBar" style="width:100%;background:var(--purple)"></div>
            </div>
            <div class="insight-score-card">
                <div class="insight-score-icon">📰</div>
                <div class="insight-score-value" id="insightNewsSentiment">--</div>
                <div class="insight-score-label">News Sentiment</div>
                <div class="insight-score-bar" id="insightSentBar" style="width:50%;background:var(--yellow)"></div>
            </div>
        </div>

        <!-- Technical + News side by side -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="insight-panel">
                <div class="insight-panel-header">📉 Technical Indicators</div>
                <div class="insight-panel-body" id="insightTAContent"></div>
            </div>
            <div class="insight-panel">
                <div class="insight-panel-header">📰 News & Sentiment</div>
                <div class="insight-panel-body">
                    <div id="insightNewsNarrative" style="font-size:14px;margin-bottom:16px;color:var(--text-secondary);line-height:1.6;font-style:italic"></div>
                    <div id="insightHeadlines"></div>
                </div>
            </div>
        </div>

        <!-- AI Recommendation -->
        <div class="insight-ai-box" id="insightAIBox" style="display:none">
            <div class="insight-ai-header">🤖 AI Recommendation</div>
            <div class="insight-ai-text" id="insightAIText"></div>
        </div>

        <!-- Market Data -->
        <div class="insight-panel">
            <div class="insight-panel-header">💰 Market Data</div>
            <div class="insight-panel-body" id="insightMarketContent"></div>
        </div>
    </div>

    <!-- Empty state -->
    <div id="insightEmpty" class="insight-empty">
        <div class="insight-empty-icon">🔍</div>
        <div class="insight-empty-title">Search any cryptocurrency for deep analysis</div>
        <div class="insight-empty-desc">
            Get real-time technical analysis with RSI, MACD, Bollinger Bands, support/resistance levels, market regime detection, news sentiment, and AI-powered trading recommendations.
        </div>
        <div class="insight-features">
            <span class="insight-feature-tag">RSI</span>
            <span class="insight-feature-tag">MACD</span>
            <span class="insight-feature-tag">Bollinger Bands</span>
            <span class="insight-feature-tag">Support/Resistance</span>
            <span class="insight-feature-tag">Trend Detection</span>
            <span class="insight-feature-tag">News Sentiment</span>
            <span class="insight-feature-tag">AI Recommendations</span>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- LEARNING PAGE                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-learning">
    <!-- Hero -->
    <div class="learning-hero">
        <div class="learning-hero-title">🧠 AI Learning Loop</div>
        <div class="learning-hero-desc">
            Track how PumpIQ's AI evolves over time. Every prediction is recorded, evaluated against actual market movements, and used to refine future trading strategies.
        </div>
        <div class="learning-actions">
            <button class="btn btn-primary" onclick="loadLearningStats()">📊 Refresh Stats</button>
            <button class="btn btn-outline" onclick="triggerLearningEvaluation()">⚡ Evaluate Predictions</button>
            <button class="btn btn-outline" onclick="loadStrategyAdjustments()">🔧 Strategy Adjustments</button>
        </div>
    </div>

    <!-- Accuracy Gauges -->
    <div class="accuracy-gauges">
        <div class="accuracy-gauge-card">
            <div class="accuracy-gauge-label">24-Hour Accuracy</div>
            <div class="accuracy-ring" id="learningAccuracyRing" style="--pct:0%">
                <span class="accuracy-ring-text" id="learningAccuracyPct">--</span>
            </div>
            <div class="accuracy-gauge-sub" id="learningAccSub24">Evaluating predictions after 24 hours</div>
        </div>
        <div class="accuracy-gauge-card">
            <div class="accuracy-gauge-label">7-Day Accuracy</div>
            <div class="accuracy-ring" id="learningAccuracyRing7d" style="--pct:0%">
                <span class="accuracy-ring-text" id="learningAccuracyPct7d">--</span>
            </div>
            <div class="accuracy-gauge-sub" id="learningAccSub7d">Evaluating predictions after 7 days</div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="learning-grid" style="grid-template-columns:repeat(6,1fr);margin-bottom:28px">
        <div class="learning-stat">
            <div class="learning-stat-icon">🔮</div>
            <div class="learning-stat-value" id="learnTotalPreds">0</div>
            <div class="learning-stat-label">Total Predictions</div>
            <div class="learning-stat-bar" id="learnBarTotal" style="width:0%"></div>
        </div>
        <div class="learning-stat">
            <div class="learning-stat-icon">✅</div>
            <div class="learning-stat-value" id="learnEvaluated24h">0</div>
            <div class="learning-stat-label">Evaluated (24h)</div>
            <div class="learning-stat-bar" id="learnBar24h" style="width:0%"></div>
        </div>
        <div class="learning-stat">
            <div class="learning-stat-icon">📅</div>
            <div class="learning-stat-value" id="learnEvaluated7d">0</div>
            <div class="learning-stat-label">Evaluated (7d)</div>
            <div class="learning-stat-bar" id="learnBar7d" style="width:0%"></div>
        </div>
        <div class="learning-stat">
            <div class="learning-stat-icon">📈</div>
            <div class="learning-stat-value" id="learnAvgPnl">0%</div>
            <div class="learning-stat-label">Avg P&L (24h)</div>
            <div class="learning-stat-bar" style="width:100%"></div>
        </div>
        <div class="learning-stat">
            <div class="learning-stat-icon">🎯</div>
            <div class="learning-stat-value" id="learnConfCorrect">0</div>
            <div class="learning-stat-label">Avg Conf (Correct)</div>
            <div class="learning-stat-bar" style="width:100%"></div>
        </div>
        <div class="learning-stat">
            <div class="learning-stat-icon">❌</div>
            <div class="learning-stat-value" id="learnConfIncorrect">0</div>
            <div class="learning-stat-label">Avg Conf (Wrong)</div>
            <div class="learning-stat-bar" style="width:100%"></div>
        </div>
    </div>

    <!-- Regime Accuracy -->
    <div class="learning-panel">
        <div class="learning-panel-header">📊 Accuracy by Market Regime</div>
        <div class="learning-panel-body padded" id="learningRegimeStats">
            <div class="empty-state"><p>Click "Refresh Stats" to load data</p></div>
        </div>
    </div>

    <!-- Best / Worst Predictions -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
        <div class="learning-panel">
            <div class="learning-panel-header">🏆 Best Predictions (7d)</div>
            <div class="learning-panel-body" id="learningBest">
                <div class="empty-state" style="padding:24px"><p>No data yet</p></div>
            </div>
        </div>
        <div class="learning-panel">
            <div class="learning-panel-header">💀 Worst Predictions (7d)</div>
            <div class="learning-panel-body" id="learningWorst">
                <div class="empty-state" style="padding:24px"><p>No data yet</p></div>
            </div>
        </div>
    </div>

    <!-- Strategy Adjustments -->
    <div class="learning-panel">
        <div class="learning-panel-header">🔧 AI Strategy Adjustments</div>
        <div class="learning-panel-body padded" id="learningAdjustments">
            <div class="empty-state"><p>Click "Strategy Adjustments" to load AI recommendations</p></div>
        </div>
    </div>

    <!-- Token Lookup -->
    <div class="learning-panel" style="margin-top:20px">
        <div class="learning-panel-header">🔍 Token Track Record</div>
        <div class="learning-panel-body padded">
            <div class="token-search-wrap">
                <input id="learningTokenSearch" placeholder="Enter token ticker (e.g. BTC, ETH, SOL)..." 
                       onkeydown="if(event.key==='Enter')loadTokenTrackRecord()">
                <button class="btn btn-primary" onclick="loadTokenTrackRecord()">🔍 Look Up</button>
            </div>
            <div id="learningTokenResult"></div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- LEADERBOARD PAGE                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-leaderboard">
    <div class="section-title">Leaderboard</div>
    <div class="section-desc">Top traders by realized PnL on DexScreener</div>

    <div style="overflow-x:auto">
        <table class="lb-table">
            <thead><tr><th>#</th><th>Trader</th><th>PnL (USD)</th><th>Spent</th><th>Received</th><th>Trades</th><th>Win Rate</th></tr></thead>
            <tbody id="lbBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- MARKET PAGE (detailed CoinGecko)                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-market">
    <div class="section-title">Market Overview</div>
    <div class="section-desc">Top coins by market cap — click any row for deep analysis</div>

    <!-- TradingView Market Overview Widget -->
    <div class="tv-market-overview" style="margin-bottom:24px">
        <iframe id="tvMarketOverview" style="width:100%;height:400px;border:none;display:block"
            frameborder="0" allowtransparency="true"></iframe>
    </div>

    <!-- TradingView Crypto Heatmap -->
    <div class="tv-heatmap-container" style="margin-bottom:24px">
        <div class="tv-chart-header" style="margin-bottom:0;border-radius:12px 12px 0 0">
            <span class="tv-chart-label">🔥 Crypto Heatmap</span>
        </div>
        <iframe id="tvHeatmap" style="width:100%;height:350px;border:none;display:block;border-radius:0 0 12px 12px"
            frameborder="0" allowtransparency="true"></iframe>
    </div>

    <div id="trendingMarket" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px"></div>

    <div style="overflow-x:auto">
        <table class="feed-table">
            <thead><tr><th>#</th><th>Token</th><th>Price</th><th>24h</th><th>Market Cap</th><th>Volume 24h</th></tr></thead>
            <tbody id="marketBody"></tbody>
        </table>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- AUTO TRADER PAGE                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-trader">
    <div class="trader-header">
        <div>
            <div class="trader-title">🤖 Auto Trader <span>Live Trading</span></div>
            <div style="color:var(--text-secondary);font-size:13px;margin-top:4px">AI-powered autonomous trading with strategy builder and real wallet balance</div>
            <div id="blockchainStatusBadge" style="margin-top:4px"></div>
        </div>
        <div style="display:flex;align-items:center;gap:16px">
            <div id="traderStatusBadge" class="trader-status inactive">● Inactive</div>
            <label class="toggle-switch">
                <input type="checkbox" id="autoTradeToggle" onchange="toggleAutoTrade()">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <!-- ── Sub-tabs ── -->
    <div class="trader-subtabs">
        <button class="trader-subtab active" onclick="switchTraderTab('live')">⚡ Live Trading</button>
        <button class="trader-subtab" onclick="switchTraderTab('builder')">🛠️ Strategy Builder</button>
        <button class="trader-subtab" onclick="switchTraderTab('strategies')">📋 My Strategies</button>
    </div>

    <!-- ═══════════════ SUB-PAGE: LIVE TRADING ═══════════════ -->
    <div class="trader-subpage active" id="traderSub-live">
        <!-- Stats Cards -->
        <div class="trader-grid" style="grid-template-columns:repeat(4,1fr);margin-top:0">
            <div class="trader-stat-card">
                <div class="trader-stat-label">Wallet Balance</div>
                <div class="trader-stat-value" id="traderBalance">$0</div>
                <div class="trader-stat-sub" id="traderReturn">0% return</div>
            </div>
            <div class="trader-stat-card">
                <div class="trader-stat-label">Total P&L</div>
                <div class="trader-stat-value" id="traderPnl">$0.00</div>
                <div class="trader-stat-sub" id="traderWinRate">Win rate: --</div>
            </div>
            <div class="trader-stat-card">
                <div class="trader-stat-label">Open Positions</div>
                <div class="trader-stat-value" id="traderOpenCount">0</div>
                <div class="trader-stat-sub" id="traderInvested">$0 invested</div>
            </div>
            <div class="trader-stat-card">
                <div class="trader-stat-label">Total Trades</div>
                <div class="trader-stat-value" id="traderTradeCount">0</div>
                <div class="trader-stat-sub" id="traderBestWorst">Best: -- | Worst: --</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="runTradeCycle()">⚡ Run Trade Cycle</button>
            <button class="btn btn-outline" onclick="runResearch()">🔍 Research Market</button>
            <button class="btn btn-outline" onclick="showManualBuyModal()">🛒 Manual Buy</button>
            <button class="btn btn-outline" onclick="showTraderSettings()">⚙️ Settings</button>
            <button class="btn btn-danger btn-sm" onclick="resetTrading()" style="margin-left:auto">🔄 Reset Stats</button>
        </div>

        <!-- Open Positions -->
        <div style="margin-top:24px">
            <h3 style="font-size:18px;margin-bottom:12px">📈 Open Positions</h3>
            <div id="traderPositions"><div class="empty-state"><p>No open positions</p></div></div>
        </div>

        <!-- AI Opportunities -->
        <div style="margin-top:24px">
            <h3 style="font-size:18px;margin-bottom:12px">🎯 AI Opportunities</h3>
            <div id="traderOpportunities"><div class="empty-state"><p>Click "Research Market" to find opportunities</p></div></div>
        </div>

        <!-- Trade History & Log tabs -->
        <div style="margin-top:24px">
            <div style="display:flex;gap:8px;margin-bottom:12px">
                <button class="btn btn-sm btn-outline" onclick="loadTraderHistory()" id="histTabBtn">📋 Trade History</button>
                <button class="btn btn-sm btn-outline" onclick="loadTraderLog()" id="logTabBtn">📝 AI Log</button>
                <button class="btn btn-sm btn-outline" onclick="loadClosedPositions()" id="closedTabBtn">📊 Closed Positions</button>
            </div>
            <div id="traderHistoryArea"></div>
        </div>
    </div>

    <!-- ═══════════════ SUB-PAGE: STRATEGY BUILDER ═══════════════ -->
    <div class="trader-subpage" id="traderSub-builder">

        <!-- ROW 1: Strategy Template + Exchange & Market -->
        <div class="sb-row two">
            <div class="sb-card">
                <h4><span class="sb-icon">📋</span> Strategy Template</h4>
                <div class="sb-field">
                    <label>Strategy Type</label>
                    <select id="sbStratType" onchange="sbTemplateChanged()">
                        <option value="custom" selected>Custom Strategy</option>
                        <option value="grid">📊 Grid Trading</option>
                        <option value="dca">💰 DCA Bot</option>
                        <option value="momentum">🚀 Momentum</option>
                        <option value="mean_reversion">🔄 Mean Reversion</option>
                        <option value="scalping">⚡ Scalping</option>
                        <option value="swing">📈 Swing Trading</option>
                        <option value="funding_farm">🏦 Funding Rate Farm</option>
                        <option value="breakout">💥 Breakout</option>
                    </select>
                    <div class="sb-hint" id="sbTemplateHint">Build your own custom trading strategy from scratch</div>
                </div>
                <div class="sb-field" style="margin-top:12px">
                    <label>Timeframe</label>
                    <div class="sb-pills" id="sbTimeframePills">
                        <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf" value="1m"> 1m</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf" value="5m"> 5m</label>
                        <label class="sb-pill active" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf" value="15m" checked> 15m</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf" value="1h"> 1h</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf" value="4h"> 4h</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbTf')"><input type="radio" name="sbTf" value="1d"> 1D</label>
                    </div>
                </div>
            </div>
            <div class="sb-card">
                <h4><span class="sb-icon">🏦</span> Exchange & Market</h4>
                <div class="sb-field">
                    <label>Exchange</label>
                    <div class="sb-exchange-grid">
                        <div class="sb-exchange-opt active" onclick="sbPickExchange(this)" data-exchange="binance">Binance<div class="sb-fee">Maker 0.02%</div></div>
                        <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="bybit">Bybit<div class="sb-fee">Maker 0.02%</div></div>
                        <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="okx">OKX<div class="sb-fee">Maker 0.02%</div></div>
                        <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="coinbase">Coinbase<div class="sb-fee">Maker 0.04%</div></div>
                        <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="kraken">Kraken<div class="sb-fee">Maker 0.02%</div></div>
                        <div class="sb-exchange-opt" onclick="sbPickExchange(this)" data-exchange="kucoin">KuCoin<div class="sb-fee">Maker 0.02%</div></div>
                    </div>
                </div>
                <div class="sb-field" style="margin-top:10px">
                    <label>Market Type</label>
                    <div class="sb-pills">
                        <label class="sb-pill active" onclick="sbPickPill(this,'sbMkt');sbMarketChanged()"><input type="radio" name="sbMkt" value="spot" checked> Spot</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbMkt');sbMarketChanged()"><input type="radio" name="sbMkt" value="futures"> Perpetual Futures</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 2: Instruments + Position Config -->
        <div class="sb-row two">
            <div class="sb-card">
                <h4><span class="sb-icon">🪙</span> Instruments</h4>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center" id="sbInstrumentChips">
                    <span class="sb-pill active" data-pair="BTC/USDT">BTC/USDT <button onclick="sbRemoveInstr(this)" style="background:none;border:none;color:inherit;cursor:pointer;margin-left:4px;font-size:14px">&times;</button></span>
                    <button class="sb-pill" onclick="sbToggleInstrDD()" id="sbAddInstrBtn">+ Add</button>
                </div>
                <div id="sbInstrDD" style="display:none;margin-top:8px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:8px;max-height:180px;overflow-y:auto">
                    <input type="text" placeholder="Search pairs..." oninput="sbFilterInstr(this.value)" style="width:100%;padding:6px 10px;margin-bottom:6px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px">
                    <div id="sbInstrList">
                        <div class="sb-instr-item" data-pair="BTC/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">BTC/USDT</div>
                        <div class="sb-instr-item" data-pair="ETH/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">ETH/USDT</div>
                        <div class="sb-instr-item" data-pair="SOL/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">SOL/USDT</div>
                        <div class="sb-instr-item" data-pair="BNB/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">BNB/USDT</div>
                        <div class="sb-instr-item" data-pair="XRP/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">XRP/USDT</div>
                        <div class="sb-instr-item" data-pair="DOGE/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">DOGE/USDT</div>
                        <div class="sb-instr-item" data-pair="ADA/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">ADA/USDT</div>
                        <div class="sb-instr-item" data-pair="AVAX/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">AVAX/USDT</div>
                        <div class="sb-instr-item" data-pair="LINK/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">LINK/USDT</div>
                        <div class="sb-instr-item" data-pair="MATIC/USDT" onclick="sbSelectInstr(this)" style="padding:6px 10px;cursor:pointer;border-radius:4px;font-size:13px">MATIC/USDT</div>
                    </div>
                </div>
                <div class="sb-field" style="margin-top:14px">
                    <label>Order Type</label>
                    <div class="sb-pills" id="sbOrderPills">
                        <label class="sb-pill active" onclick="sbPickPill(this,'sbOrder')"><input type="radio" name="sbOrder" value="market" checked> Market</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbOrder')"><input type="radio" name="sbOrder" value="limit"> Limit</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbOrder')"><input type="radio" name="sbOrder" value="stop_limit"> Stop-Limit</label>
                    </div>
                </div>
                <div class="sb-field" style="margin-top:10px">
                    <label>Stablecoin Base</label>
                    <div class="sb-pills">
                        <label class="sb-pill active" onclick="sbPickPill(this,'sbBase')"><input type="radio" name="sbBase" value="USDT" checked> USDT</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbBase')"><input type="radio" name="sbBase" value="USDC"> USDC</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbBase')"><input type="radio" name="sbBase" value="BUSD"> BUSD</label>
                    </div>
                </div>
            </div>
            <div class="sb-card">
                <h4><span class="sb-icon">⚙️</span> Position Configuration</h4>
                <div class="sb-field">
                    <label>Position Side</label>
                    <div class="sb-pills">
                        <label class="sb-pill green active" onclick="sbPickPill(this,'sbSide')"><input type="radio" name="sbSide" value="long" checked> 🟢 Long</label>
                        <label class="sb-pill red" onclick="sbPickPill(this,'sbSide')"><input type="radio" name="sbSide" value="short"> 🔴 Short</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbSide')"><input type="radio" name="sbSide" value="both"> ↕️ Both</label>
                    </div>
                </div>
                <div class="sb-field">
                    <label>Position Size (USDT)</label>
                    <div class="sb-num" style="width:100%">
                        <button onclick="sbQty(this,-100)">−</button>
                        <input type="number" id="sbPosSize" value="100" min="1" style="flex:1;width:auto">
                        <button onclick="sbQty(this,100)">+</button>
                    </div>
                </div>
                <!-- Futures-only: Leverage & Margin -->
                <div id="sbFuturesConfig" style="display:none">
                    <div class="sb-field">
                        <label>Leverage</label>
                        <div class="sb-leverage-wrap">
                            <div class="sb-leverage-bar">
                                <input type="range" id="sbLeverage" min="1" max="125" value="5" oninput="sbLeverageChanged()">
                                <span class="sb-leverage-val" id="sbLevVal">5x</span>
                            </div>
                            <div class="sb-leverage-presets">
                                <button onclick="sbSetLev(1)">1x</button>
                                <button onclick="sbSetLev(2)">2x</button>
                                <button class="active" onclick="sbSetLev(5)">5x</button>
                                <button onclick="sbSetLev(10)">10x</button>
                                <button onclick="sbSetLev(25)">25x</button>
                                <button onclick="sbSetLev(50)">50x</button>
                                <button onclick="sbSetLev(100)">100x</button>
                            </div>
                        </div>
                        <div class="sb-liq-price" id="sbLiqPrice">Est. Liquidation: ~$0 (depends on entry)</div>
                    </div>
                    <div class="sb-field">
                        <label>Margin Mode</label>
                        <div class="sb-pills">
                            <label class="sb-pill active" onclick="sbPickPill(this,'sbMargin')"><input type="radio" name="sbMargin" value="isolated" checked> Isolated</label>
                            <label class="sb-pill" onclick="sbPickPill(this,'sbMargin')"><input type="radio" name="sbMargin" value="cross"> Cross</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3: Entry Indicators + Exit Rules -->
        <div class="sb-row two">
            <div class="sb-card">
                <h4><span class="sb-icon">📡</span> Entry Conditions</h4>
                <div class="sb-field">
                    <label>Select Indicators</label>
                    <div class="sb-indicator-grid">
                        <div class="sb-indicator active" onclick="sbToggleIndicator(this)" data-ind="rsi"><span class="dot blue"></span> RSI</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="macd"><span class="dot blue"></span> MACD</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="ema_cross"><span class="dot blue"></span> EMA Cross</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="bb"><span class="dot blue"></span> Bollinger</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="volume"><span class="dot green"></span> Volume Spike</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="funding"><span class="dot yellow"></span> Funding Rate</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="cvd"><span class="dot green"></span> CVD</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="whale"><span class="dot red"></span> Whale Alert</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="exchange_flow"><span class="dot red"></span> Exchange Flow</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="btc_dom"><span class="dot yellow"></span> BTC Dominance</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="fear_greed"><span class="dot yellow"></span> Fear & Greed</div>
                        <div class="sb-indicator" onclick="sbToggleIndicator(this)" data-ind="social"><span class="dot green"></span> Social Sentiment</div>
                    </div>
                </div>
                <div class="sb-field" style="margin-top:12px">
                    <label>Entry Rules <button class="btn btn-sm btn-outline" onclick="sbAddCondition('entry')" style="margin-left:8px;font-size:11px">+ Add Rule</button></label>
                    <div id="sbEntryConditions">
                        <div class="sb-condition">
                            <select><option>RSI</option><option>MACD</option><option>EMA</option><option>Volume</option><option>Funding Rate</option><option>Price</option></select>
                            <select><option>crosses below</option><option>crosses above</option><option>is above</option><option>is below</option><option>increases by</option></select>
                            <input type="number" value="30" style="width:60px">
                            <span style="color:var(--text-muted)">→ BUY</span>
                            <button class="sb-cond-remove" onclick="this.closest('.sb-condition').remove()">×</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sb-card">
                <h4><span class="sb-icon">🎯</span> Exit & Stop-Loss</h4>
                <div class="sb-field">
                    <label>Stop-Loss Method</label>
                    <div class="sb-pills">
                        <label class="sb-pill active" onclick="sbPickPill(this,'sbSL')"><input type="radio" name="sbSL" value="percent" checked> Fixed %</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbSL')"><input type="radio" name="sbSL" value="atr"> ATR-Based</label>
                        <label class="sb-pill" onclick="sbPickPill(this,'sbSL')"><input type="radio" name="sbSL" value="trailing"> Trailing</label>
                    </div>
                </div>
                <div class="sb-leg-grid" style="margin-top:10px">
                    <div class="sb-leg-field">
                        <label>Stop Loss %</label>
                        <input type="number" id="sbSLVal" value="3" placeholder="3">
                    </div>
                    <div class="sb-leg-field">
                        <label>Take Profit %</label>
                        <input type="number" id="sbTPVal" value="6" placeholder="6">
                    </div>
                    <div class="sb-leg-field">
                        <label>Trail Distance %</label>
                        <input type="number" id="sbTrailVal" value="1" placeholder="1">
                    </div>
                </div>
                <div class="sb-field" style="margin-top:12px">
                    <label>Exit Rules <button class="btn btn-sm btn-outline" onclick="sbAddCondition('exit')" style="margin-left:8px;font-size:11px">+ Add Rule</button></label>
                    <div id="sbExitConditions">
                        <div class="sb-condition">
                            <select><option>RSI</option><option>MACD</option><option>EMA</option><option>Volume</option><option>Funding Rate</option><option>Price</option><option>Time</option></select>
                            <select><option>crosses above</option><option>crosses below</option><option>is above</option><option>is below</option><option>after minutes</option></select>
                            <input type="number" value="70" style="width:60px">
                            <span style="color:var(--text-muted)">→ SELL</span>
                            <button class="sb-cond-remove" onclick="this.closest('.sb-condition').remove()">×</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top:12px">
                    <label class="sb-check"><input type="checkbox" id="sbMoveSlCost"> Move SL to breakeven after TP1</label>
                    <label class="sb-check" style="margin-top:6px"><input type="checkbox" id="sbReEntry"> Re-entry after SL hit (max 2x)</label>
                </div>
            </div>
        </div>

        <!-- ROW 4: Risk Management + Schedule & Sessions -->
        <div class="sb-row two">
            <div class="sb-card">
                <h4><span class="sb-icon">🛡️</span> Risk Management</h4>
                <div class="sb-leg-grid">
                    <div class="sb-leg-field">
                        <label>Max Drawdown %</label>
                        <input type="number" id="sbMaxDD" value="10" placeholder="10">
                    </div>
                    <div class="sb-leg-field">
                        <label>Daily Loss Limit %</label>
                        <input type="number" id="sbDailyLoss" value="5" placeholder="5">
                    </div>
                    <div class="sb-leg-field">
                        <label>Max Open Positions</label>
                        <input type="number" id="sbMaxPos" value="3" placeholder="3">
                    </div>
                </div>
                <div class="sb-leg-grid" style="margin-top:10px">
                    <div class="sb-leg-field">
                        <label>Max Position Size %</label>
                        <input type="number" id="sbMaxPosSize" value="25" placeholder="25">
                    </div>
                    <div class="sb-leg-field">
                        <label>Max Daily Trades</label>
                        <input type="number" id="sbMaxTrades" value="10" placeholder="10">
                    </div>
                    <div class="sb-leg-field">
                        <label>Cooldown (min)</label>
                        <input type="number" id="sbCooldown" value="5" placeholder="5">
                    </div>
                </div>
                <div class="sb-field" style="margin-top:14px">
                    <label>Volatility Filter</label>
                    <div class="sb-check-group">
                        <label class="sb-check"><input type="checkbox" id="sbVolFilter" checked> Pause if ATR > threshold</label>
                        <input type="number" id="sbVolThreshold" value="5" style="width:60px;padding:4px 8px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px" placeholder="%">
                    </div>
                </div>

                <!-- Kill Switches -->
                <div style="margin-top:14px">
                    <label style="font-size:12px;color:var(--red);font-weight:700;margin-bottom:8px;display:block">🚨 Kill Switches</label>
                    <div class="sb-kill-switch">
                        <label><input type="checkbox" id="sbKillFlash" checked style="accent-color:var(--red);margin-right:6px"> Flash Crash Protection — Halt if price drops</label>
                        <input type="number" id="sbKillFlashVal" value="15" placeholder="%">
                        <span style="font-size:11px;color:var(--text-muted)">% in 1min</span>
                    </div>
                    <div class="sb-kill-switch">
                        <label><input type="checkbox" id="sbKillCircuit" checked style="accent-color:var(--red);margin-right:6px"> Circuit Breaker — Stop if market drops</label>
                        <input type="number" id="sbKillCircuitVal" value="10" placeholder="%">
                        <span style="font-size:11px;color:var(--text-muted)">% in 1hr</span>
                    </div>
                    <div class="sb-kill-switch">
                        <label><input type="checkbox" id="sbKillDepeg" style="accent-color:var(--red);margin-right:6px"> Stablecoin Depeg Monitor — Halt if USDT &lt;</label>
                        <input type="number" id="sbKillDepegVal" value="0.98" step="0.01" placeholder="0.98">
                    </div>
                </div>
            </div>
            <div class="sb-card">
                <h4><span class="sb-icon">🕐</span> Schedule & Market Regime</h4>
                <div class="sb-field">
                    <label>Trading Sessions</label>
                    <div class="sb-session-grid">
                        <div class="sb-session active" onclick="this.classList.toggle('active')">
                            <div class="sb-session-name">🌏 Asia</div>
                            <div class="sb-session-time">00:00 – 08:00 UTC</div>
                        </div>
                        <div class="sb-session active" onclick="this.classList.toggle('active')">
                            <div class="sb-session-name">🌍 Europe</div>
                            <div class="sb-session-time">08:00 – 16:00 UTC</div>
                        </div>
                        <div class="sb-session active" onclick="this.classList.toggle('active')">
                            <div class="sb-session-name">🌎 US</div>
                            <div class="sb-session-time">14:00 – 22:00 UTC</div>
                        </div>
                    </div>
                </div>
                <div class="sb-field">
                    <label>Active Days (24/7 Market)</label>
                    <div class="sb-day-pills">
                        <div class="sb-day active" onclick="this.classList.toggle('active')">M</div>
                        <div class="sb-day active" onclick="this.classList.toggle('active')">T</div>
                        <div class="sb-day active" onclick="this.classList.toggle('active')">W</div>
                        <div class="sb-day active" onclick="this.classList.toggle('active')">T</div>
                        <div class="sb-day active" onclick="this.classList.toggle('active')">F</div>
                        <div class="sb-day active" onclick="this.classList.toggle('active')">S</div>
                        <div class="sb-day active" onclick="this.classList.toggle('active')">S</div>
                    </div>
                    <div class="sb-hint" style="margin-top:4px">Crypto trades 24/7 — all days active by default</div>
                </div>
                <div class="sb-field">
                    <label>Market Regime Filter</label>
                    <div class="sb-regime-grid">
                        <div class="sb-regime active" onclick="this.classList.toggle('active')" data-regime="bull">📈 Bull</div>
                        <div class="sb-regime active" onclick="this.classList.toggle('active')" data-regime="bear">📉 Bear</div>
                        <div class="sb-regime active" onclick="this.classList.toggle('active')" data-regime="sideways">➡️ Sideways</div>
                        <div class="sb-regime" onclick="this.classList.toggle('active')" data-regime="high_vol">🌊 High Vol</div>
                    </div>
                    <div class="sb-hint">Strategy runs only in selected market conditions</div>
                </div>
                <div class="sb-field">
                    <label>Crypto Cycle Awareness</label>
                    <div class="sb-check-group" style="gap:8px 16px">
                        <label class="sb-check"><input type="checkbox" id="sbHalving"> Bitcoin Halving Cycle</label>
                        <label class="sb-check"><input type="checkbox" id="sbAltSeason"> Alt Season Detection</label>
                        <label class="sb-check"><input type="checkbox" id="sbFearGreed" checked> Fear & Greed Filter</label>
                        <label class="sb-check"><input type="checkbox" id="sbBtcCorr"> BTC Correlation Guard</label>
                    </div>
                </div>
                <div class="sb-field">
                    <label>Sleep Mode</label>
                    <div class="sb-time-row">
                        <div><label>Pause From</label><br><input type="time" id="sbSleepFrom" value="02:00"></div>
                        <div><label>Pause Until</label><br><input type="time" id="sbSleepTo" value="06:00"></div>
                        <label class="sb-check" style="margin-left:12px"><input type="checkbox" id="sbSleepEnabled"> Enable</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 5: Advanced Crypto Features (full width) -->
        <div class="sb-row">
            <div class="sb-card">
                <h4><span class="sb-icon">🔬</span> Advanced Crypto Features</h4>
                <div class="sb-check-group" style="gap:10px 24px">
                    <label class="sb-check"><input type="checkbox" id="sbDCA"> 📉 DCA on Dip (add to position on -5%)</label>
                    <label class="sb-check"><input type="checkbox" id="sbMartingale"> 🎰 Martingale (double after loss)</label>
                    <label class="sb-check"><input type="checkbox" id="sbGridMode"> 📊 Grid Mode (buy/sell at intervals)</label>
                    <label class="sb-check"><input type="checkbox" id="sbFundingFarm"> 🏦 Funding Rate Farming</label>
                    <label class="sb-check"><input type="checkbox" id="sbPairsHedge"> ↔️ Pairs Hedging (long/short offset)</label>
                    <label class="sb-check"><input type="checkbox" id="sbBtcDomRotate"> 🔄 BTC Dom Rotation (exit alts when BTC dom rises)</label>
                    <label class="sb-check"><input type="checkbox" id="sbAutoDeleverage"> ⚠️ Auto-Deleverage near liquidation</label>
                    <label class="sb-check"><input type="checkbox" id="sbSlippageModel"> 📐 Slippage Model (adjust for low-cap coins)</label>
                </div>
            </div>
        </div>

        <!-- Save / Deploy Bar -->
        <div style="display:flex;gap:12px;align-items:center;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:4px">
            <input type="text" id="sbStratName" placeholder="Strategy Name" style="flex:1;padding:10px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
            <button class="btn btn-outline" onclick="sbSaveStrategy()">💾 Save Strategy</button>
            <button class="btn btn-primary" onclick="sbDeployStrategy()">🚀 Deploy Live</button>
        </div>
    </div>

    <!-- ═══════════════ SUB-PAGE: MY STRATEGIES ═══════════════ -->
    <div class="trader-subpage" id="traderSub-strategies">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="font-size:18px">📋 My Strategies</h3>
            <button class="btn btn-primary btn-sm" onclick="switchTraderTab('builder')">+ New Strategy</button>
        </div>
        <div id="sbStrategiesList"><div class="empty-state"><p>No strategies yet. Create one in the Strategy Builder.</p></div></div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- SETTINGS PAGE                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-settings">
    <div class="section-title">⚙️ Settings</div>
    <div class="section-desc">Customize your PumpIQ experience</div>

    <!-- Appearance -->
    <div class="card" style="margin-top:20px">
        <h3 style="margin-bottom:16px;font-size:16px">🎨 Appearance</h3>
        <div class="settings-grid">
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">Theme</label>
                <select id="settTheme" onchange="applyTheme(this.value)" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
                    <option value="dark" selected>🌙 Dark (Default)</option>
                    <option value="light">☀️ Light</option>
                    <option value="midnight">🌑 Midnight</option>
                </select>
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">Accent Color</label>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="color-swatch active" onclick="setAccent(this,'#6c5ce7')" style="width:36px;height:36px;border-radius:50%;border:2px solid transparent;background:#6c5ce7;cursor:pointer"></button>
                    <button class="color-swatch" onclick="setAccent(this,'#00b894')" style="width:36px;height:36px;border-radius:50%;border:2px solid transparent;background:#00b894;cursor:pointer"></button>
                    <button class="color-swatch" onclick="setAccent(this,'#0984e3')" style="width:36px;height:36px;border-radius:50%;border:2px solid transparent;background:#0984e3;cursor:pointer"></button>
                    <button class="color-swatch" onclick="setAccent(this,'#e17055')" style="width:36px;height:36px;border-radius:50%;border:2px solid transparent;background:#e17055;cursor:pointer"></button>
                    <button class="color-swatch" onclick="setAccent(this,'#fdcb6e')" style="width:36px;height:36px;border-radius:50%;border:2px solid transparent;background:#fdcb6e;cursor:pointer"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="card" style="margin-top:16px">
        <h3 style="margin-bottom:16px;font-size:16px">🔔 Notifications</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">Price Alerts</span>
                <input type="checkbox" id="settPriceAlerts" checked style="accent-color:var(--primary);width:18px;height:18px">
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">AI Recommendation Alerts</span>
                <input type="checkbox" id="settAIAlerts" checked style="accent-color:var(--primary);width:18px;height:18px">
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">Trade Execution Alerts</span>
                <input type="checkbox" id="settTradeAlerts" checked style="accent-color:var(--primary);width:18px;height:18px">
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">Whale Movement Alerts</span>
                <input type="checkbox" id="settWhaleAlerts" style="accent-color:var(--primary);width:18px;height:18px">
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">Portfolio Daily Summary</span>
                <input type="checkbox" id="settDailySummary" checked style="accent-color:var(--primary);width:18px;height:18px">
            </label>
        </div>
    </div>

    <!-- Trading Defaults -->
    <div class="card" style="margin-top:16px">
        <h3 style="margin-bottom:16px;font-size:16px">📈 Trading Defaults</h3>
        <div class="settings-grid">
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">Default Exchange</label>
                <select id="settDefaultExchange" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
                    <option value="binance">Binance</option>
                    <option value="bybit">Bybit</option>
                    <option value="okx">OKX</option>
                    <option value="coinbase">Coinbase</option>
                    <option value="kraken">Kraken</option>
                    <option value="kucoin">KuCoin</option>
                </select>
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">Default Stablecoin</label>
                <select id="settDefaultStable" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
                    <option value="USDT">USDT (Tether)</option>
                    <option value="USDC">USDC (Circle)</option>
                    <option value="BUSD">BUSD (Binance)</option>
                </select>
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">Default Leverage</label>
                <select id="settDefaultLeverage" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
                    <option value="1">1x (No Leverage)</option>
                    <option value="2">2x</option>
                    <option value="5" selected>5x</option>
                    <option value="10">10x</option>
                    <option value="25">25x</option>
                </select>
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">Risk Level</label>
                <select id="settRiskLevel" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
                    <option value="conservative">🟢 Conservative</option>
                    <option value="moderate" selected>🟡 Moderate</option>
                    <option value="aggressive">🔴 Aggressive</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Data & Privacy -->
    <div class="card" style="margin-top:16px">
        <h3 style="margin-bottom:16px;font-size:16px">🔒 Data & Privacy</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">Show portfolio on leaderboard</span>
                <input type="checkbox" id="settShowPortfolio" style="accent-color:var(--primary);width:18px;height:18px">
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">Share trade history for AI training</span>
                <input type="checkbox" id="settShareData" checked style="accent-color:var(--primary);width:18px;height:18px">
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                <span style="color:var(--text-primary);font-size:14px">Enable analytics cookies</span>
                <input type="checkbox" id="settAnalytics" checked style="accent-color:var(--primary);width:18px;height:18px">
            </label>
        </div>
    </div>

    <!-- API Keys -->
    <div class="card" style="margin-top:16px">
        <h3 style="margin-bottom:16px;font-size:16px">🔑 API Keys</h3>
        <div class="section-desc" style="margin-bottom:12px">Connect your exchange API keys for live trading</div>
        <div id="settApiKeysList" style="margin-bottom:12px"></div>
        <div class="settings-grid">
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">Exchange</label>
                <select id="settApiExchange" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
                    <option>Binance</option><option>Bybit</option><option>OKX</option><option>Coinbase</option><option>Kraken</option><option>KuCoin</option>
                </select>
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">API Key</label>
                <input type="password" id="settApiKey" placeholder="Enter API Key" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:13px;display:block;margin-bottom:6px">API Secret</label>
                <input type="password" id="settApiSecret" placeholder="Enter API Secret" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px">
            </div>
            <div style="display:flex;align-items:flex-end">
                <button class="btn btn-primary" onclick="saveApiKey()" style="width:100%">Save API Key</button>
            </div>
        </div>
        <div style="margin-top:8px;color:var(--text-muted);font-size:12px">⚠️ Keys are encrypted and stored securely. Use read-only keys for safety.</div>
    </div>

    <!-- Save Button -->
    <div style="margin-top:24px;display:flex;gap:12px">
        <button class="btn btn-primary" onclick="saveSettings()" style="flex:1">💾 Save Settings</button>
        <button class="btn btn-outline" onclick="resetSettings()">Reset to Default</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- PROFILE PAGE (visible when logged in)                      -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="page" id="page-profile">
    <div class="section-title" id="profileTitle">My Profile</div>
    <div class="section-desc" id="profileEmail"></div>

    <!-- Wallet Balance Card -->
    <div class="balance-card" style="margin-top:20px">
        <div class="balance-label">Wallet Balance</div>
        <div class="balance-amount"><span class="currency">$</span><span id="walletBalanceDisplay">0.00</span></div>
        <div class="balance-actions">
            <button class="btn btn-primary" onclick="showDepositModal()">+ Add Money</button>
            <button class="btn btn-outline" onclick="showWithdrawModal()">Withdraw</button>
            <button class="btn btn-outline" onclick="showTransactionsModal()">History</button>
        </div>
    </div>

    <!-- Bank Accounts -->
    <div style="margin-top:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:18px">🏦 Linked Bank Accounts</h3>
            <button class="btn btn-outline btn-sm" onclick="showBankModal()">+ Add Bank</button>
        </div>
        <div id="bankList"></div>
    </div>

    <!-- Wallets -->
    <div style="margin-top:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:18px">Connected Wallets</h3>
            <button class="btn btn-outline btn-sm" onclick="showWalletModal()">+ Add Wallet</button>
        </div>
        <div id="walletList"></div>
    </div>

    <!-- Portfolio -->
    <div style="margin-top:32px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:18px">Portfolio</h3>
            <button class="btn btn-outline btn-sm" onclick="showPortfolioModal()">+ Add Position</button>
        </div>
        <table class="portfolio-table">
            <thead><tr><th>Coin</th><th>Amount</th><th>Avg Price</th><th>Current</th><th>PnL</th></tr></thead>
            <tbody id="portfolioBody"></tbody>
        </table>
    </div>

    <!-- Watchlist -->
    <div style="margin-top:32px">
        <h3 style="font-size:18px;margin-bottom:12px">Watchlist</h3>
        <div id="watchlistArea"></div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- AUTH MODAL                                                 -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="authModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
        <h2 id="authTitle">Login</h2>
        <div id="authError" class="form-error"></div>

        <div id="registerFields" style="display:none">
            <div class="form-group">
                <label>Username</label>
                <input class="form-input" id="regUsername" placeholder="Choose a username">
            </div>
        </div>
        <div class="form-group">
            <label>Email</label>
            <input class="form-input" id="authEmail" type="email" placeholder="you@example.com">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input class="form-input" id="authPassword" type="password" placeholder="Min 6 characters" onkeydown="if(event.key==='Enter')submitAuth()">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px;transition:opacity 0.2s" id="authSubmitBtn" onclick="submitAuth()">Login</button>

        <p id="forgotPassLink" style="text-align:right;margin-top:8px;font-size:13px;">
            <a href="#" style="color:#7c5cff" onclick="showForgotPassword(event)">Forgot password?</a>
        </p>

        <div class="form-divider">or</div>
        <p style="text-align:center;font-size:13px;color:var(--text-secondary)">
            <span id="authToggleText">Don't have an account?</span>
            <a href="#" id="authToggleLink" onclick="toggleAuthMode(event)">Register</a>
        </p>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- FORGOT PASSWORD MODAL                                      -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="forgotModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('forgotModal')">&times;</button>
        <h2>Reset Password</h2>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Enter your email and we'll send you a reset link.</p>
        <div id="forgotError" class="form-error"></div>
        <div id="forgotSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>
        <div class="form-group">
            <label>Email</label>
            <input class="form-input" id="forgotEmail" type="email" placeholder="you@example.com">
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="submitForgotPassword()">Send Reset Link</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- WALLET ADD MODAL                                           -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="walletModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('walletModal')">&times;</button>
        <h2>Connect Wallet</h2>
        <div class="form-group">
            <label>Wallet Address</label>
            <input class="form-input" id="walletAddr" placeholder="0x... or SOL address">
        </div>
        <div class="form-group">
            <label>Chain</label>
            <select class="form-input" id="walletChain">
                <option value="ethereum">Ethereum</option>
                <option value="solana">Solana</option>
                <option value="base">Base</option>
                <option value="polygon">Polygon</option>
                <option value="bsc">BSC</option>
            </select>
        </div>
        <div class="form-group">
            <label>Label (optional)</label>
            <input class="form-input" id="walletLabel" placeholder="e.g. My MetaMask">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addWallet()">Add Wallet</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- ADD BANK ACCOUNT MODAL                                     -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="bankModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('bankModal')">&times;</button>
        <h2>🏦 Link Bank Account</h2>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Your bank details are verified instantly and stored securely.</p>

        <div class="verify-steps" id="bankSteps">
            <div class="verify-step active" id="bankStep1">1. Details</div>
            <div class="verify-step" id="bankStep2">2. Send OTP</div>
            <div class="verify-step" id="bankStep3">3. Verify OTP</div>
            <div class="verify-step" id="bankStep4">4. Linked ✓</div>
        </div>

        <div id="bankError" class="form-error"></div>
        <div id="bankSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>

        <div id="bankFormFields">
            <div class="form-group">
                <label>Account Holder Name</label>
                <input class="form-input" id="bankHolder" placeholder="As on bank passbook">
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input class="form-input" id="bankAccNum" placeholder="9-18 digit account number" maxlength="18">
            </div>
            <div class="form-group">
                <label>Confirm Account Number</label>
                <input class="form-input" id="bankAccNumConfirm" placeholder="Re-enter account number" maxlength="18">
            </div>
            <div class="form-group">
                <label>IFSC Code</label>
                <input class="form-input" id="bankIFSC" placeholder="e.g. SBIN0001234" maxlength="11" style="text-transform:uppercase">
            </div>
            <div class="form-group">
                <label>Bank Name</label>
                <input class="form-input" id="bankName" placeholder="e.g. State Bank of India">
            </div>
            <div class="form-group">
                <label>📱 Phone Number (linked to bank account)</label>
                <input class="form-input" id="bankPhone" placeholder="e.g. 9876543210" maxlength="13">
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px">OTP will be sent to this number for verification</div>
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="sendBankOTP()">📲 Send OTP to Verify Phone</button>
        </div>

        <!-- OTP Verification Step for Bank -->
        <div id="bankOTPStep" style="display:none">
            <div style="text-align:center;padding:12px 0">
                <div style="font-size:36px;margin-bottom:8px">📲</div>
                <p style="color:var(--text-secondary);font-size:13px">Enter the 6-digit OTP sent to <strong id="bankOTPPhone">••••••••</strong></p>
                <input class="form-input" id="bankOTPCode" placeholder="Enter 6-digit OTP" maxlength="6"
                       style="text-align:center;font-size:24px;letter-spacing:8px;margin:12px auto;max-width:240px">
                <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                    <button class="btn btn-primary" style="flex:1;max-width:200px" onclick="verifyBankOTPAndAdd()">✅ Verify & Link</button>
                </div>
                <button class="btn btn-outline btn-sm" style="margin-top:12px" onclick="resendBankOTP()">🔄 Resend OTP</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- DEPOSIT MODAL                                              -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="depositModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('depositModal')">&times;</button>
        <h2>💰 Add Money to Wallet</h2>
        <div id="depositError" class="form-error"></div>
        <div id="depositSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>

        <div id="depositNoBanks" style="display:none;text-align:center;padding:20px;color:var(--text-muted);">
            <p>No bank account linked yet.</p>
            <button class="btn btn-primary" style="margin-top:12px" onclick="closeModal('depositModal');showBankModal()">Link Bank Account</button>
        </div>

        <div id="depositFields">
            <div class="form-group">
                <label>Select Bank Account</label>
                <select class="form-input" id="depositBank"></select>
            </div>
            <div class="form-group">
                <label>Amount ($)</label>
                <input class="form-input" id="depositAmount" type="number" min="1" step="any" placeholder="Enter amount">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(500)">$500</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(1000)">$1,000</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(5000)">$5,000</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(10000)">$10,000</button>
                <button class="btn btn-outline btn-sm" onclick="setDepositAmount(50000)">$50,000</button>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="sendDepositOTP()">Send OTP & Proceed</button>
        </div>

        <!-- OTP Step -->
        <div id="depositOTPStep" style="display:none">
            <div style="text-align:center;padding:16px 0;margin-bottom:16px;background:var(--bg-secondary);border-radius:var(--radius)">
                <div style="font-size:32px;margin-bottom:8px">🔐</div>
                <div style="font-size:14px;color:var(--text-secondary)">OTP sent to</div>
                <div id="depositOTPPhone" style="font-size:18px;font-weight:700;margin-top:4px">••••••••00</div>
            </div>
            <div class="form-group">
                <label>Enter 6-digit OTP</label>
                <input class="form-input" id="depositOTP" type="text" maxlength="6" placeholder="000000" style="text-align:center;font-size:24px;letter-spacing:8px;font-weight:700">
            </div>
            <div style="display:flex;gap:8px">
                <button class="btn btn-primary" style="flex:1" onclick="submitDeposit()">✅ Verify & Deposit</button>
                <button class="btn btn-outline" onclick="resendOTP('deposit')">🔄 Resend</button>
            </div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center">OTP expires in 5 minutes</div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- WITHDRAW MODAL                                             -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="withdrawModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('withdrawModal')">&times;</button>
        <h2>📤 Withdraw to Bank</h2>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">Available: <strong>$<span id="withdrawAvailable">0.00</span></strong></p>
        <div id="withdrawError" class="form-error"></div>
        <div id="withdrawSuccess" style="display:none;color:#00d4aa;background:#0a2a1a;padding:12px;border-radius:8px;margin-bottom:12px;"></div>

        <div id="withdrawFields">
            <div class="form-group">
                <label>Select Bank Account</label>
                <select class="form-input" id="withdrawBank"></select>
            </div>
            <div class="form-group">
                <label>Amount ($)</label>
                <input class="form-input" id="withdrawAmount" type="number" min="1" step="any" placeholder="Enter amount">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="sendWithdrawOTP()">Send OTP & Proceed</button>
        </div>

        <!-- OTP Step -->
        <div id="withdrawOTPStep" style="display:none">
            <div style="text-align:center;padding:16px 0;margin-bottom:16px;background:var(--bg-secondary);border-radius:var(--radius)">
                <div style="font-size:32px;margin-bottom:8px">🔐</div>
                <div style="font-size:14px;color:var(--text-secondary)">OTP sent to</div>
                <div id="withdrawOTPPhone" style="font-size:18px;font-weight:700;margin-top:4px">••••••••00</div>
            </div>
            <div class="form-group">
                <label>Enter 6-digit OTP</label>
                <input class="form-input" id="withdrawOTP" type="text" maxlength="6" placeholder="000000" style="text-align:center;font-size:24px;letter-spacing:8px;font-weight:700">
            </div>
            <div style="display:flex;gap:8px">
                <button class="btn btn-primary" style="flex:1" onclick="submitWithdraw()">✅ Verify & Withdraw</button>
                <button class="btn btn-outline" onclick="resendOTP('withdraw')">🔄 Resend</button>
            </div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center">OTP expires in 5 minutes</div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- TRANSACTIONS MODAL                                         -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="transactionsModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('transactionsModal')">&times;</button>
        <h2>📋 Transaction History</h2>
        <div id="transactionsList" style="max-height:400px;overflow-y:auto;"></div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- PORTFOLIO ADD MODAL                                        -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="portfolioModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('portfolioModal')">&times;</button>
        <h2>Add Position</h2>
        <div class="form-group">
            <label>Coin ID (e.g. bitcoin, solana)</label>
            <input class="form-input" id="pfCoinId" placeholder="bitcoin">
        </div>
        <div class="form-group">
            <label>Amount</label>
            <input class="form-input" id="pfAmount" type="number" step="any" placeholder="0.5">
        </div>
        <div class="form-group">
            <label>Avg Buy Price ($)</label>
            <input class="form-input" id="pfPrice" type="number" step="any" placeholder="65000">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addPortfolioItem()">Add Position</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════ -->
<!-- TOKEN DETAIL MODAL                                         -->
<!-- ═══════════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="detailModal">
    <div class="modal modal-lg">
        <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
        <div id="detailContent"><div class="loader"><div class="spinner"></div></div></div>
    </div>
</div>


<!-- ═══════════════════════════════════════════════════════════ -->
<!-- JAVASCRIPT                                                 -->
<!-- ═══════════════════════════════════════════════════════════ -->
<script>
// ── State ─────────────────────────────────────────────────────
let currentUser = null;
let authToken = localStorage.getItem('pumpiq_token') || null;
let currentPage = 'home';
let feedSort = 'volume';
let feedStatus = 'all';
let feedData = [];

const API = '';

// ── TradingView Symbol Mapping ────────────────────────────────
const TV_SYMBOL_MAP = {
    'bitcoin': 'BINANCE:BTCUSDT',
    'ethereum': 'BINANCE:ETHUSDT',
    'solana': 'BINANCE:SOLUSDT',
    'ripple': 'BINANCE:XRPUSDT',
    'dogecoin': 'BINANCE:DOGEUSDT',
    'cardano': 'BINANCE:ADAUSDT',
    'avalanche-2': 'BINANCE:AVAXUSDT',
    'chainlink': 'BINANCE:LINKUSDT',
    'polkadot': 'BINANCE:DOTUSDT',
    'matic-network': 'BINANCE:MATICUSDT',
    'litecoin': 'BINANCE:LTCUSDT',
    'uniswap': 'BINANCE:UNIUSDT',
    'shiba-inu': 'BINANCE:SHIBUSDT',
    'tron': 'BINANCE:TRXUSDT',
    'stellar': 'BINANCE:XLMUSDT',
    'cosmos': 'BINANCE:ATOMUSDT',
    'monero': 'BINANCE:XMRUSDT',
    'near': 'BINANCE:NEARUSDT',
    'aptos': 'BINANCE:APTUSDT',
    'arbitrum': 'BINANCE:ARBUSDT',
    'optimism': 'BINANCE:OPUSDT',
    'filecoin': 'BINANCE:FILUSDT',
    'aave': 'BINANCE:AAVEUSDT',
    'the-graph': 'BINANCE:GRTUSDT',
    'render-token': 'BINANCE:RENDERUSDT',
    'injective-protocol': 'BINANCE:INJUSDT',
    'sui': 'BINANCE:SUIUSDT',
    'pepe': 'BINANCE:PEPEUSDT',
    'bitcoin-cash': 'BINANCE:BCHUSDT',
    'internet-computer': 'BINANCE:ICPUSDT',
    'hedera-hashgraph': 'BINANCE:HBARUSDT',
    'vechain': 'BINANCE:VETUSDT',
    'fantom': 'BINANCE:FTMUSDT',
    'algorand': 'BINANCE:ALGOUSDT',
    'sei-network': 'BINANCE:SEIUSDT',
    'bonk': 'BINANCE:BONKUSDT',
    'floki': 'BINANCE:FLOKIUSDT',
    'celestia': 'BINANCE:TIAUSDT',
    'jupiter': 'BINANCE:JUPUSDT',
    'ondo-finance': 'BINANCE:ONDOUSDT',
};

let currentInsightSymbol = '';
let currentInsightTF = 'D';

function getTVSymbol(coinId, symbol) {
    if (TV_SYMBOL_MAP[coinId]) return TV_SYMBOL_MAP[coinId];
    // Fallback: try constructing from symbol
    if (symbol) return 'BINANCE:' + symbol.toUpperCase() + 'USDT';
    return null;
}

function renderTVAdvancedChart(containerId, symbol, interval) {
    const container = document.getElementById(containerId);
    if (!container || !symbol) return;
    container.innerHTML = '<div class="tv-loading"><div class="spinner"></div><div>Loading chart...</div></div>';

    const frameId = 'tv_' + containerId + '_' + Date.now();
    const params = new URLSearchParams({
        frameElementId: frameId,
        symbol: symbol,
        interval: interval || 'D',
        theme: 'dark',
        style: '1',
        locale: 'en',
        allow_symbol_change: '1',
        calendar: '0',
        save_image: '0',
        hide_volume: '0',
        backgroundColor: 'rgba(26, 31, 46, 1)',
        gridColor: 'rgba(255, 255, 255, 0.04)',
        utm_source: location.hostname,
        utm_medium: 'widget_new',
        utm_campaign: 'chart'
    });

    const iframe = document.createElement('iframe');
    iframe.id = frameId;
    iframe.src = 'https://s.tradingview.com/widgetembed/?' + params.toString();
    iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
    iframe.setAttribute('frameborder', '0');
    iframe.setAttribute('allowtransparency', 'true');
    iframe.setAttribute('allowfullscreen', '');

    const loadTimeout = setTimeout(() => {
        if (container.querySelector('.tv-loading')) {
            container.innerHTML = `<div class="tv-error">
                <div class="tv-error-icon">📊</div>
                <div>Chart is taking longer than usual to load</div>
                <button class="tv-retry-btn" onclick="renderTVAdvancedChart('${containerId}','${symbol}','${interval || 'D'}')">↻ Retry</button>
            </div>`;
        }
    }, 20000);

    iframe.onload = () => {
        clearTimeout(loadTimeout);
        const loading = container.querySelector('.tv-loading');
        if (loading) loading.remove();
    };

    container.innerHTML = '';
    container.appendChild(iframe);
}

function renderTVTechnicalAnalysis(containerId, symbol) {
    const container = document.getElementById(containerId);
    if (!container || !symbol) return;
    container.innerHTML = '<div class="tv-loading"><div class="spinner"></div><div>Loading analysis...</div></div>';

    const config = JSON.stringify({
        interval: '1D', width: '100%', isTransparent: true, height: '100%',
        symbol: symbol, showIntervalTabs: true, displayMode: 'single',
        locale: 'en', colorTheme: 'dark'
    });

    const iframe = document.createElement('iframe');
    iframe.src = 'https://s.tradingview.com/embed-widget/technical-analysis/?locale=en#' + encodeURIComponent(config);
    iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
    iframe.setAttribute('frameborder', '0');
    iframe.setAttribute('allowtransparency', 'true');

    const loadTimeout = setTimeout(() => {
        if (container.querySelector('.tv-loading')) {
            container.innerHTML = `<div class="tv-error">
                <div class="tv-error-icon">🔮</div>
                <div>Technical analysis unavailable</div>
                <button class="tv-retry-btn" onclick="renderTVTechnicalAnalysis('${containerId}','${symbol}')">↻ Retry</button>
            </div>`;
        }
    }, 20000);

    iframe.onload = () => {
        clearTimeout(loadTimeout);
        const loading = container.querySelector('.tv-loading');
        if (loading) loading.remove();
    };

    container.innerHTML = '';
    container.appendChild(iframe);
}

function renderTVMiniChart(containerId, symbol) {
    const container = document.getElementById(containerId);
    if (!container || !symbol) return;
    container.innerHTML = '';

    const config = JSON.stringify({
        symbol: symbol, width: '100%', height: '100%', locale: 'en',
        dateRange: '1M', colorTheme: 'dark', isTransparent: true, autosize: true
    });

    const iframe = document.createElement('iframe');
    iframe.src = 'https://s.tradingview.com/embed-widget/mini-symbol-overview/?locale=en#' + encodeURIComponent(config);
    iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
    iframe.setAttribute('frameborder', '0');
    iframe.setAttribute('allowtransparency', 'true');
    container.appendChild(iframe);
}

function switchInsightTF(tf, btn) {
    currentInsightTF = tf;
    document.querySelectorAll('.tv-tf-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    if (currentInsightSymbol) {
        renderTVAdvancedChart('insightTVChartWidget', currentInsightSymbol, tf);
    }
}

async function api(path, opts = {}) {
    const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
    if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

    // Retry once on 500 (handles Vercel cold-start / init race)
    for (let attempt = 0; attempt < 2; attempt++) {
        try {
            const resp = await fetch(API + path, { ...opts, headers });
            if (resp.status === 500 && attempt === 0) {
                await new Promise(r => setTimeout(r, 1500));
                continue;  // retry once
            }
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({}));
                throw new Error(err.detail || resp.statusText || 'Server error');
            }
            return resp.json();
        } catch (e) {
            if (attempt === 0 && (e.message === 'Failed to fetch' || e.message === 'Load failed')) {
                await new Promise(r => setTimeout(r, 2000));
                continue;  // retry once on network error (cold start)
            }
            throw e;
        }
    }
}

// ── UI Helpers ────────────────────────────────────────────────
function skeletonRows(cols, rows = 5) {
    const sizes = ['w-sm','w-md','w-lg','w-md','w-md','w-sm'];
    return Array.from({length: rows}, () =>
        `<tr>${Array.from({length: cols}, (_, i) =>
            `<td><div class="skeleton skeleton-cell ${sizes[i % sizes.length]}" style="height:14px">&nbsp;</div></td>`
        ).join('')}</tr>`
    ).join('');
}

function errorWithRetry(message, retryFn) {
    return `<div class="error-state">
        <div class="error-icon">⚠️</div>
        <div class="error-msg">${message}</div>
        <button class="retry-btn" onclick="${retryFn}">↻ Retry</button>
    </div>`;
}

function debounce(fn, ms = 300) {
    let timer;
    return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); };
}

function fmt(n) {
    if (n == null || isNaN(n)) return '-';
    if (n >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
    if (n >= 1e3) return '$' + (n/1e3).toFixed(2) + 'K';
    if (n >= 1) return '$' + n.toFixed(2);
    if (n >= 0.001) return '$' + n.toFixed(4);
    return '$' + n.toFixed(8);
}

function fmtPct(n) {
    if (n == null) return '-';
    const cls = n >= 0 ? 'price-positive' : 'price-negative';
    const arrow = n >= 0 ? '▲' : '▼';
    return `<span class="${cls}">${arrow} ${Math.abs(n).toFixed(2)}%</span>`;
}

function scoreColor(s) {
    if (s >= 7) return 'green'; if (s >= 4) return 'yellow'; return 'red';
}

// ── Navigation ────────────────────────────────────────────────
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => navigate(tab.dataset.page));
});

function navigate(page) {
    if (page === 'profile' && !currentUser) {
        showAuthModal('login');
        return;
    }
    currentPage = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page)?.classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.page === page);
    });

    // Load data for page
    if (page === 'home') { loadHomeData(); }
    else if (page === 'feed') { loadFeed(); }
    else if (page === 'ai') { loadAIGlobal(); }
    else if (page === 'insights') { /* ready for user search */ }
    else if (page === 'learning') { loadLearningStats(); }
    else if (page === 'leaderboard') { loadLeaderboard(); }
    else if (page === 'market') { loadMarket(); }
    else if (page === 'trader') { loadTraderDashboard(); }
    else if (page === 'settings') { loadSettings(); }
    else if (page === 'profile') { loadProfile(); }
}

// ── Auth ──────────────────────────────────────────────────────
let authMode = 'login';

function showAuthModal(mode) {
    authMode = mode;
    document.getElementById('authTitle').textContent = mode === 'login' ? 'Login' : 'Create Account';
    document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Login' : 'Register';
    document.getElementById('registerFields').style.display = mode === 'register' ? 'block' : 'none';
    document.getElementById('forgotPassLink').style.display = mode === 'login' ? 'block' : 'none';
    document.getElementById('authToggleText').textContent = mode === 'login' ? "Don't have an account?" : "Already have an account?";
    document.getElementById('authToggleLink').textContent = mode === 'login' ? 'Register' : 'Login';
    document.getElementById('authError').style.display = 'none';
    document.getElementById('authModal').classList.add('active');
    // Focus first visible input
    setTimeout(() => {
        if (mode === 'register') document.getElementById('regUsername').focus();
        else document.getElementById('authEmail').focus();
    }, 100);
}

function toggleAuthMode(e) {
    e.preventDefault();
    showAuthModal(authMode === 'login' ? 'register' : 'login');
}

async function submitAuth() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const errEl = document.getElementById('authError');
    const btn = document.getElementById('authSubmitBtn');

    // Validation
    if (!email) { errEl.textContent = 'Please enter your email'; errEl.style.display = 'block'; return; }
    if (!password || password.length < 6) { errEl.textContent = 'Password must be at least 6 characters'; errEl.style.display = 'block'; return; }
    if (authMode === 'register') {
        const username = document.getElementById('regUsername').value.trim();
        if (!username) { errEl.textContent = 'Please enter a username'; errEl.style.display = 'block'; return; }
    }

    // Show loading state
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = authMode === 'login' ? 'Logging in...' : 'Creating account...';
    btn.style.opacity = '0.7';
    errEl.style.display = 'none';

    try {
        let data;
        if (authMode === 'login') {
            data = await api('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password }),
            });
        } else {
            const username = document.getElementById('regUsername').value.trim();
            data = await api('/api/auth/register', {
                method: 'POST',
                body: JSON.stringify({ email, password, username }),
            });
        }

        authToken = data.access_token;
        localStorage.setItem('pumpiq_token', authToken);
        currentUser = data.user;
        updateAuthUI();
        closeModal('authModal');
    } catch (e) {
        errEl.style.color = '#ff4d4d';
        errEl.textContent = e.message || 'Something went wrong. Please try again.';
        errEl.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        btn.style.opacity = '1';
    }
}

// ── Forgot Password ──────────────────────────────────────────
function showForgotPassword(e) {
    e.preventDefault();
    closeModal('authModal');
    document.getElementById('forgotError').style.display = 'none';
    document.getElementById('forgotSuccess').style.display = 'none';
    document.getElementById('forgotEmail').value = document.getElementById('authEmail').value || '';
    document.getElementById('forgotModal').classList.add('active');
}

async function submitForgotPassword() {
    const email = document.getElementById('forgotEmail').value;
    const errEl = document.getElementById('forgotError');
    const succEl = document.getElementById('forgotSuccess');
    errEl.style.display = 'none';
    succEl.style.display = 'none';

    if (!email) { errEl.textContent = 'Please enter your email'; errEl.style.display = 'block'; return; }

    try {
        const data = await api('/api/auth/forgot-password', {
            method: 'POST',
            body: JSON.stringify({ email }),
        });
        succEl.textContent = data.message;
        succEl.style.display = 'block';
    } catch (e) {
        errEl.textContent = e.message;
        errEl.style.display = 'block';
    }
}

// ── Resend Verification ──────────────────────────────────────
async function resendVerification() {
    try {
        const data = await api('/api/auth/resend-verification', { method: 'POST' });
        alert(data.message || 'Verification email sent!');
    } catch (e) {
        alert(e.message || 'Failed to send verification email');
    }
}

async function resendVerificationFromLogin(email) {
    const errEl = document.getElementById('authError');
    try {
        const data = await api('/api/auth/resend-verification-by-email', {
            method: 'POST',
            body: JSON.stringify({ email }),
        });
        errEl.style.color = '#00d4aa';
        errEl.innerHTML = data.message || 'Verification email sent! Check your inbox.';
    } catch (e) {
        errEl.innerHTML = e.message || 'Failed to resend';
    }
}

function logout() {
    authToken = null;
    currentUser = null;
    localStorage.removeItem('pumpiq_token');
    updateAuthUI();
    navigate('home');
}

function updateAuthUI() {
    const area = document.getElementById('authArea');
    if (currentUser) {
        const initials = (currentUser.username || currentUser.email).slice(0, 2).toUpperCase();
        area.innerHTML = `
            <div class="user-badge" onclick="navigate('profile')">
                <div class="user-avatar">${initials}</div>
                <span>${currentUser.username || currentUser.email}</span>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()">Logout</button>
        `;
    } else {
        area.innerHTML = '<button class="btn btn-primary" onclick="showAuthModal(\'login\')">Login</button>';
    }
}

async function checkAuth() {
    if (!authToken) return;
    try {
        currentUser = await api('/api/auth/me');
        updateAuthUI();
    } catch {
        authToken = null;
        localStorage.removeItem('pumpiq_token');
    }
}

// ── Modals ────────────────────────────────────────────────────
function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// Close modals on backdrop click
document.querySelectorAll('.modal-overlay').forEach(ov => {
    ov.addEventListener('click', e => {
        if (e.target === ov) ov.classList.remove('active');
    });
});

// ── Wallet ────────────────────────────────────────────────────
function showWalletModal() {
    document.getElementById('walletModal').classList.add('active');
}

async function addWallet() {
    const address = document.getElementById('walletAddr').value;
    const chain = document.getElementById('walletChain').value;
    const label = document.getElementById('walletLabel').value;
    if (!address) return;
    try {
        await api('/api/wallet/add', {
            method: 'POST',
            body: JSON.stringify({ address, chain, label }),
        });
        closeModal('walletModal');
        loadProfile();
    } catch (e) {
        alert(e.message);
    }
}

async function removeWallet(addr, chain) {
    try {
        await api(`/api/wallet/${encodeURIComponent(addr)}?chain=${chain}`, { method: 'DELETE' });
        loadProfile();
    } catch (e) {
        alert(e.message);
    }
}

// ── Bank Accounts ──────────────────────────────────────────────
function showBankModal() {
    document.getElementById('bankError').style.display = 'none';
    document.getElementById('bankSuccess').style.display = 'none';
    document.getElementById('bankFormFields').style.display = 'block';
    document.getElementById('bankOTPStep').style.display = 'none';
    document.getElementById('bankStep1').className = 'verify-step active';
    document.getElementById('bankStep2').className = 'verify-step';
    document.getElementById('bankStep3').className = 'verify-step';
    document.getElementById('bankStep4').className = 'verify-step';
    ['bankHolder','bankAccNum','bankAccNumConfirm','bankIFSC','bankName','bankPhone'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('bankModal').classList.add('active');
}

// Auto-detect bank from IFSC
document.addEventListener('DOMContentLoaded', () => {
    const ifscEl = document.getElementById('bankIFSC');
    if (ifscEl) {
        ifscEl.addEventListener('input', function() {
            const prefix = this.value.toUpperCase().substring(0, 4);
            const banks = {
                'SBIN':'State Bank of India','HDFC':'HDFC Bank','ICIC':'ICICI Bank',
                'UTIB':'Axis Bank','PUNB':'Punjab National Bank','CNRB':'Canara Bank',
                'UBIN':'Union Bank of India','BARB':'Bank of Baroda','KKBK':'Kotak Mahindra Bank',
                'YESB':'Yes Bank','INDB':'IndusInd Bank','FDRL':'Federal Bank',
                'IOBA':'Indian Overseas Bank','IDIB':'Indian Bank','BKID':'Bank of India',
            };
            if (banks[prefix]) document.getElementById('bankName').value = banks[prefix];
        });
    }
});

// Cached bank form data for OTP step
let pendingBankData = null;

async function sendBankOTP() {
    const holder = document.getElementById('bankHolder').value.trim();
    const accNum = document.getElementById('bankAccNum').value.trim();
    const accConfirm = document.getElementById('bankAccNumConfirm').value.trim();
    const ifsc = document.getElementById('bankIFSC').value.trim().toUpperCase();
    const bankName = document.getElementById('bankName').value.trim();
    const phone = document.getElementById('bankPhone').value.trim();
    const errEl = document.getElementById('bankError');
    errEl.style.display = 'none';

    // Client-side checks
    if (!holder || !accNum || !ifsc || !bankName) {
        errEl.textContent = 'All fields are required'; errEl.style.display = 'block'; return;
    }
    if (accNum !== accConfirm) {
        errEl.textContent = 'Account numbers do not match'; errEl.style.display = 'block'; return;
    }
    if (!phone || phone.replace(/[\s\-]/g, '').length < 10) {
        errEl.textContent = 'A valid 10-digit phone number is required'; errEl.style.display = 'block'; return;
    }

    // Step 2: Sending OTP
    document.getElementById('bankStep1').className = 'verify-step done';
    document.getElementById('bankStep2').className = 'verify-step active';

    try {
        // First verify bank details format
        const verifyResult = await api('/api/bank/verify', {
            method: 'POST',
            body: JSON.stringify({ account_holder: holder, account_number: accNum, ifsc_code: ifsc, bank_name: bankName, phone_number: phone }),
        });
        if (!verifyResult.verified) {
            document.getElementById('bankStep2').className = 'verify-step';
            document.getElementById('bankStep1').className = 'verify-step active';
            errEl.textContent = verifyResult.errors.join(', '); errEl.style.display = 'block'; return;
        }

        // Send OTP to phone
        const otpResult = await api('/api/bank/send-otp', {
            method: 'POST',
            body: JSON.stringify({ phone_number: phone, action: 'bank_verify' }),
        });

        // Cache form data
        pendingBankData = { holder, accNum, ifsc, bankName, phone };

        // Show OTP step
        document.getElementById('bankStep2').className = 'verify-step done';
        document.getElementById('bankStep3').className = 'verify-step active';
        document.getElementById('bankFormFields').style.display = 'none';
        document.getElementById('bankOTPPhone').textContent = '••••••' + (otpResult.phone_last4 || phone.slice(-4));
        document.getElementById('bankOTPCode').value = '';
        document.getElementById('bankOTPStep').style.display = 'block';

        // Auto-fill OTP in demo mode
        if (otpResult.otp_code_debug) {
            document.getElementById('bankOTPCode').value = otpResult.otp_code_debug;
        }
    } catch (e) {
        document.getElementById('bankStep2').className = 'verify-step';
        document.getElementById('bankStep1').className = 'verify-step active';
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function verifyBankOTPAndAdd() {
    if (!pendingBankData) return;
    const otp_code = document.getElementById('bankOTPCode').value.trim();
    const errEl = document.getElementById('bankError');
    const successEl = document.getElementById('bankSuccess');
    errEl.style.display = 'none';

    if (!otp_code || otp_code.length !== 6) {
        errEl.textContent = 'Enter the 6-digit OTP'; errEl.style.display = 'block'; return;
    }

    try {
        const addResult = await api('/api/bank/add', {
            method: 'POST',
            body: JSON.stringify({
                account_holder: pendingBankData.holder,
                account_number: pendingBankData.accNum,
                ifsc_code: pendingBankData.ifsc,
                bank_name: pendingBankData.bankName,
                phone_number: pendingBankData.phone,
                otp_code: otp_code,
            }),
        });

        document.getElementById('bankStep3').className = 'verify-step done';
        document.getElementById('bankStep4').className = 'verify-step done';
        document.getElementById('bankOTPStep').style.display = 'none';
        successEl.innerHTML = `✅ <strong>${addResult.bank_name}</strong> account ending in ****${addResult.last4} linked successfully!<br><span style="font-size:12px;color:var(--text-muted)">📱 OTP verified for ••••••${addResult.phone_last4 || pendingBankData.phone.slice(-4)}</span>`;
        successEl.style.display = 'block';
        pendingBankData = null;

        // Refresh profile after delay
        setTimeout(() => { closeModal('bankModal'); loadProfile(); }, 2000);
    } catch (e) {
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function resendBankOTP() {
    if (!pendingBankData) return;
    try {
        const res = await api('/api/bank/send-otp', {
            method: 'POST',
            body: JSON.stringify({ phone_number: pendingBankData.phone, action: 'bank_verify' }),
        });
        document.getElementById('bankOTPCode').value = '';
        alert('New OTP sent!');
        // Auto-fill in demo mode
        if (res.otp_code_debug) {
            document.getElementById('bankOTPCode').value = res.otp_code_debug;
        }
    } catch (e) {
        alert('Failed to resend: ' + e.message);
    }
}

async function removeBank(bankId) {
    if (!confirm('Remove this bank account?')) return;
    try {
        await api(`/api/bank/${bankId}`, { method: 'DELETE' });
        loadProfile();
    } catch (e) { alert(e.message); }
}

// ── Deposit / Withdraw ─────────────────────────────────────────
function populateBankSelect(selectId) {
    const sel = document.getElementById(selectId);
    const banks = (currentUser && currentUser.bank_accounts) || [];
    sel.innerHTML = banks.filter(b => b.verified)
        .map(b => `<option value="${b.id}">${b.bank_name} ••••${b.account_last4}</option>`)
        .join('');
    return banks.filter(b => b.verified).length;
}

function showDepositModal() {
    document.getElementById('depositError').style.display = 'none';
    document.getElementById('depositSuccess').style.display = 'none';
    document.getElementById('depositAmount').value = '';
    document.getElementById('depositOTPStep').style.display = 'none';
    const count = populateBankSelect('depositBank');
    document.getElementById('depositNoBanks').style.display = count === 0 ? 'block' : 'none';
    document.getElementById('depositFields').style.display = count > 0 ? 'block' : 'none';
    document.getElementById('depositModal').classList.add('active');
}

function showWithdrawModal() {
    document.getElementById('withdrawError').style.display = 'none';
    document.getElementById('withdrawSuccess').style.display = 'none';
    document.getElementById('withdrawAmount').value = '';
    document.getElementById('withdrawOTPStep').style.display = 'none';
    document.getElementById('withdrawAvailable').textContent = formatUSD(currentUser?.wallet_balance || 0);
    populateBankSelect('withdrawBank');
    document.getElementById('withdrawFields').style.display = 'block';
    document.getElementById('withdrawModal').classList.add('active');
}

function setDepositAmount(amt) {
    document.getElementById('depositAmount').value = amt;
}

function formatUSD(n) {
    return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// ── OTP Flow ──────────────────────────────────────────────────
let pendingDepositData = null;
let pendingWithdrawData = null;

async function sendDepositOTP() {
    const amount = parseFloat(document.getElementById('depositAmount').value);
    const bank_id = parseInt(document.getElementById('depositBank').value);
    const errEl = document.getElementById('depositError');
    errEl.style.display = 'none';

    if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; errEl.style.display = 'block'; return; }

    try {
        const res = await api('/api/otp/send', {
            method: 'POST',
            body: JSON.stringify({ bank_id, action: 'deposit' }),
        });
        pendingDepositData = { amount, bank_id };
        document.getElementById('depositFields').style.display = 'none';
        document.getElementById('depositOTPPhone').textContent = '••••••' + (res.phone_last4 || '••');
        document.getElementById('depositOTP').value = '';
        document.getElementById('depositOTPStep').style.display = 'block';

        // Auto-fill OTP in demo mode
        if (res.otp_code_debug) {
            document.getElementById('depositOTP').value = res.otp_code_debug;
        }
    } catch (e) {
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function sendWithdrawOTP() {
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    const bank_id = parseInt(document.getElementById('withdrawBank').value);
    const errEl = document.getElementById('withdrawError');
    errEl.style.display = 'none';

    if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; errEl.style.display = 'block'; return; }

    try {
        const res = await api('/api/otp/send', {
            method: 'POST',
            body: JSON.stringify({ bank_id, action: 'withdraw' }),
        });
        pendingWithdrawData = { amount, bank_id };
        document.getElementById('withdrawFields').style.display = 'none';
        document.getElementById('withdrawOTPPhone').textContent = '••••••' + (res.phone_last4 || '••');
        document.getElementById('withdrawOTP').value = '';
        document.getElementById('withdrawOTPStep').style.display = 'block';

        // Auto-fill OTP in demo mode
        if (res.otp_code_debug) {
            document.getElementById('withdrawOTP').value = res.otp_code_debug;
        }
    } catch (e) {
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function resendOTP(action) {
    const bank_id = action === 'deposit'
        ? parseInt(document.getElementById('depositBank').value)
        : parseInt(document.getElementById('withdrawBank').value);
    try {
        const res = await api('/api/otp/send', {
            method: 'POST',
            body: JSON.stringify({ bank_id, action }),
        });
        const phoneEl = document.getElementById(action === 'deposit' ? 'depositOTPPhone' : 'withdrawOTPPhone');
        phoneEl.textContent = '••••••' + (res.phone_last4 || '••');
        alert('New OTP sent!');
        // Auto-fill in demo mode
        if (res.otp_code_debug) {
            document.getElementById(action === 'deposit' ? 'depositOTP' : 'withdrawOTP').value = res.otp_code_debug;
        }
    } catch (e) {
        alert('Failed to resend: ' + e.message);
    }
}

async function submitDeposit() {
    if (!pendingDepositData) return;
    const otp_code = document.getElementById('depositOTP').value.trim();
    const errEl = document.getElementById('depositError');
    const successEl = document.getElementById('depositSuccess');
    errEl.style.display = 'none'; successEl.style.display = 'none';

    if (!otp_code || otp_code.length !== 6) { errEl.textContent = 'Enter the 6-digit OTP'; errEl.style.display = 'block'; return; }

    try {
        const res = await api('/api/wallet/deposit', {
            method: 'POST',
            body: JSON.stringify({ amount: pendingDepositData.amount, bank_id: pendingDepositData.bank_id, otp_code }),
        });
        const hashInfo = res.tx_hash ? `<br><span style="font-family:monospace;font-size:11px;color:var(--primary);cursor:pointer" title="${res.tx_hash}" onclick="copyHash('${res.tx_hash}')">🔗 TX: ${res.tx_hash.slice(0,10)}…${res.tx_hash.slice(-8)} 📋</span>` : '';
        successEl.innerHTML = `✅ $${formatUSD(pendingDepositData.amount)} deposited successfully! New balance: <strong>$${formatUSD(res.new_balance)}</strong>${hashInfo}`;
        successEl.style.display = 'block';
        document.getElementById('depositOTPStep').style.display = 'none';
        // Update local state
        if (currentUser) currentUser.wallet_balance = res.new_balance;
        document.getElementById('walletBalanceDisplay').textContent = formatUSD(res.new_balance);
        pendingDepositData = null;
        setTimeout(() => { closeModal('depositModal'); document.getElementById('depositFields').style.display = 'block'; }, 4000);
    } catch (e) {
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function submitWithdraw() {
    if (!pendingWithdrawData) return;
    const otp_code = document.getElementById('withdrawOTP').value.trim();
    const errEl = document.getElementById('withdrawError');
    const successEl = document.getElementById('withdrawSuccess');
    errEl.style.display = 'none'; successEl.style.display = 'none';

    if (!otp_code || otp_code.length !== 6) { errEl.textContent = 'Enter the 6-digit OTP'; errEl.style.display = 'block'; return; }

    try {
        const res = await api('/api/wallet/withdraw', {
            method: 'POST',
            body: JSON.stringify({ amount: pendingWithdrawData.amount, bank_id: pendingWithdrawData.bank_id, otp_code }),
        });
        const wdHashInfo = res.tx_hash ? `<br><span style="font-family:monospace;font-size:11px;color:var(--primary);cursor:pointer" title="${res.tx_hash}" onclick="copyHash('${res.tx_hash}')">🔗 TX: ${res.tx_hash.slice(0,10)}…${res.tx_hash.slice(-8)} 📋</span>` : '';
        successEl.innerHTML = `✅ $${formatUSD(pendingWithdrawData.amount)} withdrawal initiated. New balance: <strong>$${formatUSD(res.new_balance)}</strong>${wdHashInfo}`;
        successEl.style.display = 'block';
        document.getElementById('withdrawOTPStep').style.display = 'none';
        if (currentUser) currentUser.wallet_balance = res.new_balance;
        document.getElementById('walletBalanceDisplay').textContent = formatUSD(res.new_balance);
        pendingWithdrawData = null;
        setTimeout(() => { closeModal('withdrawModal'); document.getElementById('withdrawFields').style.display = 'block'; }, 4000);
    } catch (e) {
        errEl.textContent = e.message; errEl.style.display = 'block';
    }
}

async function showTransactionsModal() {
    document.getElementById('transactionsModal').classList.add('active');
    const list = document.getElementById('transactionsList');
    list.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
    try {
        const txns = await api('/api/wallet/transactions?limit=30');
        if (txns.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No transactions yet</p></div>';
            return;
        }
        list.innerHTML = txns.map(t => {
            const hash = t.tx_hash || '';
            const shortHash = hash ? hash.slice(0,8) + '…' + hash.slice(-6) : '';
            const typeLabel = t.type === 'deposit' ? '⬆ Deposit' : t.type === 'signup_bonus' ? '🎁 Bonus' : '⬇ Withdraw';
            const typeCls = t.type === 'deposit' || t.type === 'signup_bonus' ? 'txn-deposit' : 'txn-withdraw';
            return `
            <div class="txn-item">
                <div>
                    <span class="txn-type ${typeCls}">${typeLabel}</span>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${t.description}</div>
                    <div style="font-size:11px;color:var(--text-muted)">${new Date(t.created_at).toLocaleString()}</div>
                    ${hash ? `<div style="font-size:11px;font-family:monospace;margin-top:3px">
                        🔗 <span title="${hash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${hash}')">${shortHash}</span>
                        <span data-hash="${hash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${hash}')">📋</span>
                    </div>` : ''}
                </div>
                <div class="txn-amount" style="color:${t.type === 'deposit' || t.type === 'signup_bonus' ? '#00d4aa' : '#ff6b6b'}">
                    ${t.type === 'withdraw' ? '-' : '+'}$${formatUSD(t.amount)}
                </div>
            </div>`;
        }).join('');
    } catch (e) {
        list.innerHTML = `<div class="empty-state"><p>Error loading transactions</p></div>`;
    }
}

// ── Portfolio ─────────────────────────────────────────────────
function showPortfolioModal() {
    document.getElementById('portfolioModal').classList.add('active');
}

async function addPortfolioItem() {
    const coin_id = document.getElementById('pfCoinId').value;
    const amount = parseFloat(document.getElementById('pfAmount').value);
    const avg_price = parseFloat(document.getElementById('pfPrice').value);
    if (!coin_id || isNaN(amount)) return;
    try {
        await api(`/api/portfolio?coin_id=${encodeURIComponent(coin_id)}&amount=${amount}&avg_price=${avg_price}`, {
            method: 'POST',
        });
        closeModal('portfolioModal');
        loadProfile();
    } catch (e) {
        alert(e.message);
    }
}

// ── Profile ───────────────────────────────────────────────────
async function loadProfile() {
    if (!currentUser) return;
    document.getElementById('profileTitle').textContent = currentUser.username + "'s Profile";
    document.getElementById('profileEmail').textContent = currentUser.email;

    // Email verification banner
    let verifyBanner = document.getElementById('verifyBanner');
    if (!verifyBanner) {
        verifyBanner = document.createElement('div');
        verifyBanner.id = 'verifyBanner';
        document.getElementById('profileEmail').after(verifyBanner);
    }
    if (currentUser.email_verified) {
        verifyBanner.innerHTML = '<span style="color:#00d4aa;font-size:13px;">\u2705 Email verified</span>';
    } else {
        verifyBanner.innerHTML = '<div style="background:#2a1a00;border:1px solid #ff9900;border-radius:8px;padding:10px 16px;margin-top:8px;font-size:13px;color:#ffcc00;">'
            + '\u26A0\uFE0F Email not verified &mdash; <a href="#" style="color:#7c5cff;" onclick="resendVerification()">Resend verification email</a></div>';
    }

    // Wallet Balance
    document.getElementById('walletBalanceDisplay').textContent = formatUSD(currentUser.wallet_balance || 0);

    // Bank Accounts
    const banks = currentUser.bank_accounts || [];
    const bl = document.getElementById('bankList');
    if (banks.length === 0) {
        bl.innerHTML = '<div class="empty-state" style="padding:20px"><p>No bank accounts linked yet</p><p style="font-size:12px;margin-top:4px">Link a bank account to add money to your wallet</p></div>';
    } else {
        bl.innerHTML = banks.map(b => `
            <div class="bank-card">
                <div class="bank-info">
                    <div class="bank-icon">${b.bank_name.charAt(0)}</div>
                    <div>
                        <div class="bank-name">${b.bank_name}</div>
                        <div class="bank-detail">${b.account_holder} &bull; ****${b.account_last4} &bull; ${b.ifsc_code}</div>
                        <span class="bank-verified">${b.verified ? '\u2705 Verified' : '\u23f3 Pending'}</span>
                    </div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeBank(${b.id})">Remove</button>
            </div>
        `).join('');
    }

    // Wallets
    const wallets = currentUser.wallets || [];
    const wl = document.getElementById('walletList');
    if (wallets.length === 0) {
        wl.innerHTML = '<div class="empty-state"><p>No wallets connected yet</p></div>';
    } else {
        wl.innerHTML = wallets.map(w => `
            <div class="wallet-card">
                <div>
                    <span class="wallet-addr">${w.address}</span>
                    <span class="wallet-chain">${w.chain}</span>
                    ${w.label ? '<span style="color:var(--text-muted);font-size:12px;margin-left:8px">' + w.label + '</span>' : ''}
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeWallet('${w.address}','${w.chain}')">Remove</button>
            </div>
        `).join('');
    }

    // Portfolio
    try {
        const portfolio = await api('/api/portfolio');
        const pb = document.getElementById('portfolioBody');
        if (portfolio.length === 0) {
            pb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px">No positions yet</td></tr>';
        } else {
            pb.innerHTML = portfolio.map(p => `
                <tr>
                    <td style="font-weight:600">${p.coin_id.toUpperCase()}</td>
                    <td>${p.amount}</td>
                    <td>${fmt(p.avg_buy_price)}</td>
                    <td>${fmt(p.current_price)}</td>
                    <td class="${p.pnl >= 0 ? 'price-positive' : 'price-negative'}">${p.pnl >= 0 ? '+' : ''}${fmt(p.pnl)} (${p.pnl_pct.toFixed(1)}%)</td>
                </tr>
            `).join('');
        }
    } catch (e) {
        console.error('Portfolio error:', e);
    }

    // Watchlist
    const wlArea = document.getElementById('watchlistArea');
    const wlist = currentUser.watchlist || [];
    if (wlist.length === 0) {
        wlArea.innerHTML = '<div class="empty-state"><p>Watchlist empty — click ★ on any token to add</p></div>';
    } else {
        wlArea.innerHTML = wlist.map(c => `
            <span class="filter-pill" style="cursor:pointer" onclick="openToken('${c}','${c}')">${c}</span>
        `).join(' ');
    }
}

// ── Home Data ─────────────────────────────────────────────────
async function loadHomeData() {
    const body = document.getElementById('homeMarketBody');
    body.innerHTML = skeletonRows(6, 8);
    try {
        const [coins, trending] = await Promise.all([
            api('/api/market/top?limit=10'),
            api('/api/market/trending'),
        ]);

        // Trending bar
        const bar = document.getElementById('trendingBar');
        bar.innerHTML = trending.map(t => `
            <div class="filter-pill" style="cursor:pointer" onclick="openToken('${t.coin_id}','${t.name}')">
                🔥 ${t.name} <span style="color:var(--text-muted)">${t.symbol}</span>
            </div>
        `).join('');

        // Market table
        body.innerHTML = coins.map(c => `
            <tr style="cursor:pointer" onclick="openToken('${c.coin_id}','${c.name}')">
                <td>${c.rank || '-'}</td>
                <td>
                    <div class="token-info">
                        <div class="token-icon">${c.symbol.slice(0,2)}</div>
                        <div><div class="token-name">${c.name}</div><div class="token-symbol">${c.symbol}</div></div>
                    </div>
                </td>
                <td>${fmt(c.price)}</td>
                <td>${fmtPct(c.price_change_24h)}</td>
                <td>${fmt(c.market_cap)}</td>
                <td>${fmt(c.volume_24h)}</td>
            </tr>
        `).join('');
    } catch (e) {
        console.error('Home data error:', e);
        body.innerHTML = `<tr><td colspan="6">${errorWithRetry('Failed to load market data — ' + e.message, 'loadHomeData()')}</td></tr>`;
    }
}

// ── Token Feed ────────────────────────────────────────────────
function setFeedSort(el) {
    document.querySelectorAll('[data-sort]').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    feedSort = el.dataset.sort;
    loadFeed();
}

function setFeedStatus(el) {
    document.querySelectorAll('[data-status]').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    feedStatus = el.dataset.status;
    loadFeed();
}

async function loadFeed() {
    const body = document.getElementById('feedBody');
    body.innerHTML = skeletonRows(7, 10);

    try {
        feedData = await api(`/api/feed/tokens?sort=${feedSort}&status=${feedStatus}&limit=50`);
        document.getElementById('feedCount').textContent = `${feedData.length} tokens on DexScreener`;
        renderFeed(feedData);
    } catch (e) {
        body.innerHTML = `<tr><td colspan="7">${errorWithRetry('Failed to load feed — ' + e.message, 'loadFeed()')}</td></tr>`;
    }
}

function renderFeed(data) {
    const body = document.getElementById('feedBody');
    body.innerHTML = data.map(t => `
        <tr style="cursor:pointer" onclick="window.open('https://dexscreener.com/solana/${t.address}','_blank')">
            <td>
                <div class="token-info">
                    <div class="token-icon">${t.symbol.slice(0,2)}</div>
                    <div>
                        <div class="token-name">${t.name}</div>
                        <div class="token-symbol">$${t.symbol}</div>
                    </div>
                </div>
            </td>
            <td>${fmt(t.price)}</td>
            <td>${fmtPct(t.price_change_24h)}</td>
            <td>${fmt(t.volume_24h)}</td>
            <td>${fmt(t.liquidity)}</td>
            <td>${t.trades_count}</td>
            <td style="color:var(--text-muted)">${t.age || '-'}</td>
        </tr>
    `).join('');
}

const filterFeedLocal = debounce(function(q) {
    if (!q) return renderFeed(feedData);
    const f = feedData.filter(t => t.name.toLowerCase().includes(q.toLowerCase()) || t.symbol.toLowerCase().includes(q.toLowerCase()));
    renderFeed(f);
}, 200);

// ── AI Recommendations ────────────────────────────────────────
async function loadAIGlobal() {
    try {
        const coins = await api('/api/market/top?limit=3');
        const txt = coins.map(c => `${c.name}: ${fmt(c.price)} (${c.price_change_24h >= 0 ? '+' : ''}${c.price_change_24h.toFixed(2)}%)`).join(' | ');
        document.getElementById('aiMarketGlobal').textContent = txt;
    } catch {
        document.getElementById('aiMarketGlobal').innerHTML = '<span style="color:var(--red)">Failed to load market data.</span>';
    }
}

function toggleSwitch(el) {
    el.classList.toggle('off');
}

async function loadAIRecs() {
    const onchain = !document.getElementById('toggleOnchain').classList.contains('off');
    const technical = !document.getElementById('toggleTechnical').classList.contains('off');
    const cards = document.getElementById('aiCards');
    cards.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
    document.getElementById('aiSummaryBox').style.display = 'none';

    try {
        const data = await api(`/api/ai/recommendations?enable_onchain=${onchain}&enable_technical=${technical}`);

        document.getElementById('aiTimestamp').textContent = `Results from ${new Date(data.timestamp).toLocaleString()}`;
        document.getElementById('aiSummaryText').textContent = data.market_summary;
        document.getElementById('aiSummaryBox').style.display = 'block';

        cards.innerHTML = data.tokens.map(t => {
            const sColor = t.score >= 70 ? 'score-green' : (t.score >= 40 ? 'score-yellow' : 'score-red');
            const vClass = 'verdict-' + t.verdict.replace(' ', '_');

            let barsHtml = '';
            if (t.on_chain && Object.keys(t.on_chain).length) {
                barsHtml = '<div class="on-chain-bars">';
                for (const [k, v] of Object.entries(t.on_chain)) {
                    const pct = Math.min(100, (v / 25) * 100);
                    barsHtml += `
                        <div class="bar-row">
                            <div class="bar-label">${k.replace(/_/g,' ')}</div>
                            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
                        </div>`;
                }
                barsHtml += '</div>';
            }

            return `
                <div class="score-card">
                    <div class="score-circle ${sColor}">${t.score}</div>
                    <div class="score-card-name">${t.name}</div>
                    <div class="score-card-sym">$${t.symbol}</div>
                    <div class="score-card-summary">${t.summary}</div>
                    <span class="verdict-badge ${vClass}">${t.verdict}</span>
                    ${t.risk_flags.length ? '<div style="margin-top:8px;font-size:12px;color:var(--red)">⚠ ' + t.risk_flags.join(', ') + '</div>' : ''}
                    ${barsHtml}
                </div>
            `;
        }).join('');
    } catch (e) {
        cards.innerHTML = errorWithRetry('AI analysis failed \u2014 ' + e.message, 'loadAIRecs()');
    }
}

// ── Leaderboard ───────────────────────────────────────────────
async function loadLeaderboard() {
    const body = document.getElementById('lbBody');
    body.innerHTML = skeletonRows(7, 15);

    try {
        const entries = await api('/api/leaderboard?limit=25');
        body.innerHTML = entries.map(e => `
            <tr>
                <td>${e.rank}</td>
                <td class="trader-addr">${e.trader}</td>
                <td class="${e.pnl >= 0 ? 'price-positive' : 'price-negative'}" style="font-weight:600">
                    ${e.pnl >= 0 ? '+' : ''}${fmt(e.pnl)}
                </td>
                <td>${fmt(e.spent)}</td>
                <td>${fmt(e.received)}</td>
                <td>${e.trades}</td>
                <td>${e.win_rate}%</td>
            </tr>
        `).join('');
    } catch (e) {
        body.innerHTML = `<tr><td colspan="7">${errorWithRetry('Failed to load leaderboard \u2014 ' + e.message, 'loadLeaderboard()')}</td></tr>`;
    }
}

// ── Market Page ───────────────────────────────────────────────
let marketTVInitialized = false;
function initMarketTVWidgets() {
    if (marketTVInitialized) return;
    marketTVInitialized = true;

    // Market Overview
    const overviewCfg = {colorTheme:"dark",dateRange:"1D",showChart:true,locale:"en",width:"100%",height:"400",largeChartUrl:"",isTransparent:true,showSymbolLogo:true,showFloatingTooltip:true,tabs:[{title:"Crypto",symbols:[{s:"BINANCE:BTCUSDT",d:"Bitcoin"},{s:"BINANCE:ETHUSDT",d:"Ethereum"},{s:"BINANCE:SOLUSDT",d:"Solana"},{s:"BINANCE:XRPUSDT",d:"XRP"},{s:"BINANCE:DOGEUSDT",d:"Doge"},{s:"BINANCE:ADAUSDT",d:"Cardano"},{s:"BINANCE:AVAXUSDT",d:"AVAX"},{s:"BINANCE:LINKUSDT",d:"Chainlink"},{s:"BINANCE:DOTUSDT",d:"Polkadot"},{s:"BINANCE:MATICUSDT",d:"Polygon"}],originalTitle:"Crypto"}]};
    const f1 = document.getElementById('tvMarketOverview');
    if (f1) f1.src = 'https://s.tradingview.com/embed-widget/market-overview/?locale=en#' + encodeURIComponent(JSON.stringify(overviewCfg));

    // Heatmap
    const heatCfg = {dataSource:"Crypto",blockSize:"market_cap_calc",blockColor:"change",locale:"en",symbolUrl:"",colorTheme:"dark",hasTopBar:false,isZoomEnabled:true,hasSymbolTooltip:true,isMonoSize:false,width:"100%",height:"350"};
    const f2 = document.getElementById('tvHeatmap');
    if (f2) f2.src = 'https://s.tradingview.com/embed-widget/crypto-coins-heatmap/?locale=en#' + encodeURIComponent(JSON.stringify(heatCfg));
}

async function loadMarket() {
    initMarketTVWidgets();
    const body = document.getElementById('marketBody');
    body.innerHTML = '<tr><td colspan="6"><div class="loader"><div class="spinner"></div></div></td></tr>';

    try {
        const [coins, trending] = await Promise.all([
            api('/api/market/top?limit=50'),
            api('/api/market/trending'),
        ]);

        // Trending
        document.getElementById('trendingMarket').innerHTML = trending.map(t => `
            <div class="filter-pill" style="cursor:pointer" onclick="openToken('${t.coin_id}','${t.name}')">
                🔥 ${t.name}
            </div>
        `).join('');

        body.innerHTML = coins.map(c => `
            <tr style="cursor:pointer" onclick="openToken('${c.coin_id}','${c.name}')">
                <td>${c.rank || '-'}</td>
                <td>
                    <div class="token-info">
                        <div class="token-icon">${c.symbol.slice(0,2)}</div>
                        <div><div class="token-name">${c.name}</div><div class="token-symbol">${c.symbol}</div></div>
                    </div>
                </td>
                <td>${fmt(c.price)}</td>
                <td>${fmtPct(c.price_change_24h)}</td>
                <td>${fmt(c.market_cap)}</td>
                <td>${fmt(c.volume_24h)}</td>
            </tr>
        `).join('');
    } catch (e) {
        body.innerHTML = `<tr><td colspan="6" class="empty-state">${e.message}</td></tr>`;
    }
}

// ── Insights Page ─────────────────────────────────────────────
function quickInsight(coinId) {
    document.getElementById('insightSearch').value = coinId;
    loadInsightAnalysis();
}

async function loadInsightAnalysis() {
    const coinId = document.getElementById('insightSearch').value.trim().toLowerCase();
    if (!coinId) { showToast('Enter a coin name (e.g. bitcoin, ethereum)', 'error'); return; }

    document.getElementById('insightEmpty').style.display = 'none';
    const resultEl = document.getElementById('insightResult');
    resultEl.style.display = 'block';

    // Show loading
    let loadingOverlay = document.getElementById('insightLoading');
    if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'insightLoading';
        loadingOverlay.innerHTML = '<div class="loader"><div class="spinner"></div></div><div style="margin-top:16px;font-size:14px;color:var(--text-muted)">Analyzing ' + coinId + '...</div>';
        loadingOverlay.style.cssText = 'position:absolute;inset:0;background:var(--bg-primary);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;border-radius:var(--radius);min-height:300px';
        resultEl.style.position = 'relative';
        resultEl.appendChild(loadingOverlay);
    } else {
        loadingOverlay.innerHTML = '<div class="loader"><div class="spinner"></div></div><div style="margin-top:16px;font-size:14px;color:var(--text-muted)">Analyzing ' + coinId + '...</div>';
    }
    loadingOverlay.style.display = 'flex';

    // Highlight active chip
    document.querySelectorAll('.insight-chip').forEach(c => c.style.borderColor = 'rgba(255,255,255,0.08)');
    document.querySelectorAll('.insight-chip').forEach(c => {
        if (c.getAttribute('onclick')?.includes(coinId)) c.style.borderColor = 'var(--purple)';
    });

    try {
        const d = await api('/api/token/' + encodeURIComponent(coinId));

        // Token header
        const img = document.getElementById('insightTokenImg');
        if (d.image) { img.src = d.image; img.style.display = 'block'; }
        else { img.style.display = 'none'; }
        document.getElementById('insightTokenName').textContent = d.name;
        document.getElementById('insightTokenSymbol').textContent = d.symbol + (d.rank ? ' • Rank #' + d.rank : '');
        document.getElementById('insightTokenPrice').textContent = fmt(d.price);
        const chgEl = document.getElementById('insightTokenChange');
        const ch24 = d.price_change_24h || 0;
        chgEl.innerHTML = `<span style="color:${ch24 >= 0 ? 'var(--green)' : 'var(--red)'}">${ch24 >= 0 ? '▲' : '▼'} ${Math.abs(ch24).toFixed(2)}% (24h)</span>`;

        // TradingView Chart
        const tvSymbol = getTVSymbol(coinId, d.symbol);
        if (tvSymbol) {
            currentInsightSymbol = tvSymbol;
            currentInsightTF = 'D';
            document.getElementById('insightTVChart').style.display = 'block';
            document.querySelectorAll('.tv-tf-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.tv-tf-btn[onclick*="\'D\'"]')?.classList.add('active');
            renderTVAdvancedChart('insightTVChartWidget', tvSymbol, 'D');

            // TradingView Technical Analysis widget
            document.getElementById('insightTVTA').style.display = 'block';
            renderTVTechnicalAnalysis('insightTVTAWidget', tvSymbol);
        } else {
            document.getElementById('insightTVChart').style.display = 'none';
            document.getElementById('insightTVTA').style.display = 'none';
        }

        // Score cards
        const taScore = d.ta_score || 0;
        const rsi = d.ta_rsi || 0;
        document.getElementById('insightTAScore').textContent = taScore.toFixed(1);
        document.getElementById('insightTAScore').style.color = taScore >= 7 ? 'var(--green)' : taScore >= 4 ? 'var(--yellow)' : 'var(--red)';
        document.getElementById('insightTABar').style.width = (taScore * 10) + '%';
        document.getElementById('insightTABar').style.background = taScore >= 7 ? 'var(--green)' : taScore >= 4 ? 'var(--yellow)' : 'var(--red)';

        document.getElementById('insightRSI').textContent = rsi.toFixed(1);
        document.getElementById('insightRSI').style.color = rsi > 70 ? 'var(--red)' : rsi < 30 ? 'var(--green)' : 'var(--text-primary)';
        document.getElementById('insightRSIBar').style.width = rsi + '%';
        document.getElementById('insightRSIBar').style.background = rsi > 70 ? 'var(--red)' : rsi < 30 ? 'var(--green)' : 'var(--accent)';

        const trend = d.ta_trend || 'unknown';
        document.getElementById('insightTrend').textContent = trend;
        document.getElementById('insightTrend').style.color = trend.toLowerCase().includes('bull') || trend.toLowerCase().includes('up') ? 'var(--green)' :
            trend.toLowerCase().includes('bear') || trend.toLowerCase().includes('down') ? 'var(--red)' : 'var(--yellow)';
        document.getElementById('insightTrendBar').style.background = trend.toLowerCase().includes('bull') ? 'var(--green)' :
            trend.toLowerCase().includes('bear') ? 'var(--red)' : 'var(--purple)';

        const sentimentVal = d.news_sentiment;
        document.getElementById('insightNewsSentiment').textContent = sentimentVal != null ? (sentimentVal >= 0 ? '+' : '') + sentimentVal.toFixed(2) : '--';
        document.getElementById('insightNewsSentiment').style.color = sentimentVal > 0 ? 'var(--green)' : sentimentVal < 0 ? 'var(--red)' : 'var(--text-primary)';
        document.getElementById('insightSentBar').style.width = Math.min(100, Math.max(10, (sentimentVal + 1) * 50)) + '%';
        document.getElementById('insightSentBar').style.background = sentimentVal > 0 ? 'var(--green)' : sentimentVal < 0 ? 'var(--red)' : 'var(--yellow)';

        // Technical indicators - enhanced rows
        const taRows = [
            { label: 'RSI (14)', value: rsi.toFixed(1), badge: d.ta_rsi_label || '', badgeColor: rsi > 70 ? 'var(--red)' : rsi < 30 ? 'var(--green)' : 'var(--accent)' },
            { label: 'Trend', value: trend, badge: '', badgeColor: '' },
            { label: 'MACD', value: d.ta_macd || '--', badge: '', badgeColor: '' },
            { label: 'Pattern', value: d.ta_pattern || 'None', badge: '', badgeColor: '' },
            { label: 'Support', value: d.ta_support ? '$' + d.ta_support.toLocaleString(undefined, {maximumFractionDigits:6}) : '--', badge: '', badgeColor: '' },
            { label: 'Resistance', value: d.ta_resistance ? '$' + d.ta_resistance.toLocaleString(undefined, {maximumFractionDigits:6}) : '--', badge: '', badgeColor: '' },
            { label: 'TA Score', value: taScore.toFixed(1) + ' / 10', badge: taScore >= 7 ? 'STRONG' : taScore >= 4 ? 'MODERATE' : 'WEAK',
                badgeColor: taScore >= 7 ? 'var(--green)' : taScore >= 4 ? 'var(--yellow)' : 'var(--red)' },
        ];
        document.getElementById('insightTAContent').innerHTML = taRows.map(r => `
            <div class="insight-ta-row">
                <span class="insight-ta-label">${r.label}</span>
                <div style="display:flex;align-items:center;gap:8px">
                    <span class="insight-ta-value">${r.value}</span>
                    ${r.badge ? `<span class="insight-ta-badge" style="background:${r.badgeColor}22;color:${r.badgeColor}">${r.badge}</span>` : ''}
                </div>
            </div>
        `).join('');

        // News
        document.getElementById('insightNewsNarrative').textContent = d.news_narrative || 'No narrative available at this time.';
        const headlines = d.news_headlines || [];
        document.getElementById('insightHeadlines').innerHTML = headlines.length
            ? headlines.map(h => {
                const sentColor = 'var(--accent)';
                return `<div class="insight-news-item"><div class="insight-news-dot" style="background:${sentColor}"></div><span>${h}</span></div>`;
            }).join('')
            : '<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:13px">No recent headlines found</div>';

        // AI Recommendation
        if (d.ai_available && d.ai_recommendation) {
            document.getElementById('insightAIBox').style.display = 'block';
            document.getElementById('insightAIText').textContent = d.ai_recommendation;
        } else {
            document.getElementById('insightAIBox').style.display = 'none';
        }

        // Market data table - enhanced
        const mCapStr = d.market_cap ? '$' + (d.market_cap >= 1e9 ? (d.market_cap/1e9).toFixed(2) + 'B' : d.market_cap >= 1e6 ? (d.market_cap/1e6).toFixed(2) + 'M' : d.market_cap.toLocaleString()) : '--';
        const volStr = d.volume_24h ? '$' + (d.volume_24h >= 1e9 ? (d.volume_24h/1e9).toFixed(2) + 'B' : d.volume_24h >= 1e6 ? (d.volume_24h/1e6).toFixed(2) + 'M' : d.volume_24h.toLocaleString()) : '--';
        const mktRows = [
            { label: 'Market Cap', value: mCapStr, icon: '💎' },
            { label: '24h Volume', value: volStr, icon: '📊' },
            { label: 'All-Time High', value: d.ath ? '$' + d.ath.toLocaleString(undefined, {maximumFractionDigits:6}) : '--', icon: '🏔️' },
            { label: 'Circulating Supply', value: d.circulating_supply ? d.circulating_supply.toLocaleString() + ' ' + d.symbol : '--', icon: '🔄' },
            { label: 'Rank', value: d.rank ? '#' + d.rank : '--', icon: '🏆' },
            { label: '24h Change', value: `<span style="color:${ch24 >= 0 ? 'var(--green)' : 'var(--red)'}">${ch24 >= 0 ? '+' : ''}${ch24.toFixed(2)}%</span>`, icon: '📈' },
            { label: '7d Change', value: d.price_change_7d != null ? `<span style="color:${d.price_change_7d >= 0 ? 'var(--green)' : 'var(--red)'}">${d.price_change_7d >= 0 ? '+' : ''}${d.price_change_7d.toFixed(2)}%</span>` : '--', icon: '📅' },
        ];
        document.getElementById('insightMarketContent').innerHTML = mktRows.map(r => `
            <div class="insight-market-row">
                <span style="color:var(--text-muted);font-size:13px;display:flex;align-items:center;gap:8px"><span>${r.icon}</span>${r.label}</span>
                <span style="font-weight:700;font-size:14px">${r.value}</span>
            </div>
        `).join('');

        // Hide loading
        const overlay = document.getElementById('insightLoading');
        if (overlay) overlay.style.display = 'none';
    } catch (e) {
        const overlay = document.getElementById('insightLoading');
        if (overlay) overlay.style.display = 'none';
        document.getElementById('insightResult').innerHTML = `
            <div class="insight-empty" style="padding:48px">
                <div class="insight-empty-icon">❌</div>
                <div class="insight-empty-title">${e.message || 'Token not found'}</div>
                <div class="insight-empty-desc">Try using the CoinGecko ID (e.g. "bitcoin", "ethereum", "solana"). The name must match exactly.</div>
            </div>`;
        document.getElementById('insightResult').style.display = 'block';
    }
}

// Allow Enter key in insight search
document.addEventListener('DOMContentLoaded', () => {
    const el2 = document.getElementById('learningTokenSearch');
    if (el2) el2.addEventListener('keydown', e => { if (e.key === 'Enter') loadTokenTrackRecord(); });
});

// ── Learning Page ─────────────────────────────────────────────
async function loadLearningStats() {
    try {
        const stats = await api('/api/ai/learning/stats');

        // Stats values
        const total = stats.total_predictions || 0;
        const eval24 = stats.evaluated_24h || 0;
        const eval7d = stats.evaluated_7d || 0;
        document.getElementById('learnTotalPreds').textContent = total;
        document.getElementById('learnEvaluated24h').textContent = eval24;
        document.getElementById('learnEvaluated7d').textContent = eval7d;
        const avgPnl = stats.avg_pnl_24h || 0;
        document.getElementById('learnAvgPnl').textContent = (avgPnl >= 0 ? '+' : '') + avgPnl.toFixed(2) + '%';
        document.getElementById('learnAvgPnl').style.color = avgPnl >= 0 ? 'var(--green)' : 'var(--red)';
        document.getElementById('learnConfCorrect').textContent = (stats.avg_confidence_correct || 0).toFixed(1);
        document.getElementById('learnConfIncorrect').textContent = (stats.avg_confidence_incorrect || 0).toFixed(1);

        // Animate stat bars
        const pctEval = total > 0 ? (eval24 / total * 100) : 0;
        document.getElementById('learnBarTotal').style.width = '100%';
        document.getElementById('learnBar24h').style.width = pctEval.toFixed(0) + '%';
        document.getElementById('learnBar7d').style.width = (total > 0 ? eval7d / total * 100 : 0).toFixed(0) + '%';

        // 24h Accuracy ring
        const acc24 = stats.accuracy_24h || 0;
        document.getElementById('learningAccuracyPct').textContent = acc24.toFixed(1) + '%';
        document.getElementById('learningAccuracyRing').style.setProperty('--pct', acc24 + '%');
        document.getElementById('learningAccSub24').textContent = `${eval24} predictions evaluated — ${acc24 >= 55 ? 'AI is performing well' : acc24 >= 45 ? 'Average accuracy' : 'Below target, adjusting...'}`;

        // 7d Accuracy ring
        const acc7d = stats.accuracy_7d || 0;
        document.getElementById('learningAccuracyPct7d').textContent = acc7d.toFixed(1) + '%';
        document.getElementById('learningAccuracyRing7d').style.setProperty('--pct', acc7d + '%');
        document.getElementById('learningAccSub7d').textContent = `${eval7d} predictions evaluated over 7 days`;

        // Regime accuracy — enhanced cards
        const regimeDiv = document.getElementById('learningRegimeStats');
        const regimes = stats.regime_accuracy || {};
        if (Object.keys(regimes).length === 0) {
            regimeDiv.innerHTML = '<div class="empty-state"><p>No regime data available yet. The AI needs more evaluated predictions to analyze market regime performance.</p></div>';
        } else {
            regimeDiv.innerHTML = '<div class="regime-grid">' +
                Object.entries(regimes).map(([regime, data]) => {
                    const color = data.accuracy >= 55 ? 'var(--green)' : data.accuracy >= 45 ? 'var(--yellow)' : 'var(--red)';
                    const emoji = regime === 'bullish' ? '📈' : regime === 'bearish' ? '📉' : regime === 'volatile' ? '🌊' : regime === 'sideways' ? '➡️' : regime === 'accumulation' ? '🔄' : '📊';
                    return `
                        <div class="regime-card">
                            <div class="regime-name">${emoji} ${regime}</div>
                            <div class="regime-pct" style="color:${color}">${data.accuracy}%</div>
                            <div class="regime-detail">${data.correct}/${data.total} correct predictions</div>
                            <div class="regime-bar">
                                <div class="regime-bar-fill" style="width:${data.accuracy}%;background:${color}"></div>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }

        // Best predictions — enhanced cards
        const bestDiv = document.getElementById('learningBest');
        const best = stats.best_predictions || [];
        bestDiv.innerHTML = best.length ? best.map((b, i) => `
            <div class="prediction-row">
                <span style="color:var(--text-muted);font-size:12px;width:20px">${i + 1}.</span>
                <span class="prediction-ticker">${b.token_ticker}</span>
                <span class="prediction-verdict" style="background:rgba(16,185,129,0.12);color:var(--green)">${b.verdict || 'Buy'}</span>
                <span class="prediction-pnl" style="color:var(--green)">${b.pnl_pct_7d != null ? '+' + b.pnl_pct_7d.toFixed(2) + '%' : '--'}</span>
            </div>
        `).join('') : '<div class="empty-state" style="padding:24px"><p>No 7d data yet — predictions need 7 days to evaluate</p></div>';

        // Worst predictions
        const worstDiv = document.getElementById('learningWorst');
        const worst = stats.worst_predictions || [];
        worstDiv.innerHTML = worst.length ? worst.map((w, i) => `
            <div class="prediction-row">
                <span style="color:var(--text-muted);font-size:12px;width:20px">${i + 1}.</span>
                <span class="prediction-ticker">${w.token_ticker}</span>
                <span class="prediction-verdict" style="background:rgba(239,68,68,0.12);color:var(--red)">${w.verdict || 'Buy'}</span>
                <span class="prediction-pnl" style="color:var(--red)">${w.pnl_pct_7d != null ? w.pnl_pct_7d.toFixed(2) + '%' : '--'}</span>
            </div>
        `).join('') : '<div class="empty-state" style="padding:24px"><p>No 7d data yet</p></div>';

    } catch (e) {
        console.error('Learning stats error:', e);
        document.getElementById('learnTotalPreds').textContent = '0';
        document.getElementById('learningRegimeStats').innerHTML =
            '<div class="empty-state"><p style="color:var(--red)">⚠️ ' + (e.message || 'Could not load learning stats') + '</p></div>';
    }
}

async function triggerLearningEvaluation() {
    try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '⏳ Evaluating...';
        const result = await api('/api/ai/learning/evaluate', { method: 'POST' });
        const msg = result.message || `Evaluated ${(result.evaluated_24h || 0)} (24h) and ${(result.evaluated_7d || 0)} (7d) predictions`;
        btn.textContent = '✅ Done!';
        setTimeout(() => { btn.textContent = '⚡ Evaluate Predictions'; btn.disabled = false; }, 2000);
        loadLearningStats();
        showToast(msg, 'success');
    } catch (e) {
        event.target.textContent = '⚡ Evaluate Predictions';
        event.target.disabled = false;
        showToast('Evaluation error: ' + (e.message || 'Unknown error'), 'error');
    }
}

async function loadStrategyAdjustments() {
    const div = document.getElementById('learningAdjustments');
    div.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
    div.scrollIntoView({ behavior: 'smooth', block: 'center' });

    try {
        const result = await api('/api/ai/learning/adjustments');
        const adjustments = result.adjustments || [];
        if (adjustments.length === 0) {
            div.innerHTML = `
                <div class="empty-state" style="padding:36px;text-align:center">
                    <div style="font-size:48px;margin-bottom:16px">✅</div>
                    <p style="font-size:18px;font-weight:700;margin-bottom:8px">All Systems Optimal</p>
                    <p style="font-size:13px;color:var(--text-muted);max-width:400px;margin:0 auto;line-height:1.6">
                        AI performance is on track. Adjustments appear when the AI detects patterns like low accuracy in specific market regimes or poor confidence calibration.
                    </p>
                    <p style="font-size:12px;color:var(--text-muted);margin-top:16px;opacity:0.7">
                        The AI needs at least 5-10 evaluated predictions to generate meaningful strategy adjustments.
                    </p>
                </div>`;
            return;
        }
        div.innerHTML = adjustments.map(a => {
            const typeClass = a.type.includes('reduction') ? 'adj-decrease' : a.type.includes('increase') ? 'adj-increase' : 'adj-hold';
            const badgeClass = a.type.includes('reduction') ? 'decrease' : a.type.includes('increase') ? 'increase' : 'hold';
            const icon = badgeClass === 'decrease' ? '⬇️' : badgeClass === 'increase' ? '⬆️' : '🔄';
            return `
                <div class="adjustment-card ${typeClass}">
                    <div class="adjustment-header">
                        <span>${icon}</span>
                        <span class="adjustment-type ${badgeClass}">${a.type.replace(/_/g, ' ')}</span>
                        ${a.market_regime ? '<span style="font-size:11px;color:var(--text-muted);margin-left:auto">Regime: ' + a.market_regime + '</span>' : ''}
                    </div>
                    <div class="adjustment-detail">${a.description}</div>
                    <div class="adjustment-reason">💡 ${a.reason}</div>
                </div>
            `;
        }).join('');
    } catch (e) {
        div.innerHTML = '<div class="empty-state"><p style="color:var(--red)">⚠️ ' + (e.message || 'Could not load adjustments') + '</p></div>';
    }
}

async function loadTokenTrackRecord() {
    const ticker = document.getElementById('learningTokenSearch').value.trim().toUpperCase();
    if (!ticker) { showToast('Enter a token ticker (e.g. BTC, ETH)', 'error'); return; }
    const div = document.getElementById('learningTokenResult');
    div.innerHTML = '<div class="loader"><div class="spinner"></div></div>';

    try {
        const result = await api('/api/ai/learning/token/' + encodeURIComponent(ticker));
        const r = result.track_record || result;
        if (!r || r.predictions === 0) {
            div.innerHTML = `<div class="empty-state" style="padding:24px;text-align:center">
                <div style="font-size:36px;margin-bottom:12px">🔍</div>
                <p>No predictions found for <strong>${ticker}</strong></p>
                <p style="font-size:12px;color:var(--text-muted);margin-top:8px">Try BTC, ETH, SOL, XRP, or other tracked tokens</p>
            </div>`;
            return;
        }
        const accColor = (r.accuracy || 0) >= 55 ? 'var(--green)' : (r.accuracy || 0) >= 45 ? 'var(--yellow)' : 'var(--red)';
        const pnlVal = r.avg_pnl_24h || 0;
        div.innerHTML = `
            <div style="margin-top:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <span style="font-size:24px;font-weight:800">${ticker}</span>
                    <span style="font-size:13px;color:var(--text-muted)">Track record across all predictions</span>
                </div>
                <div class="learning-grid" style="grid-template-columns:repeat(4,1fr)">
                    <div class="learning-stat">
                        <div class="learning-stat-icon">🔮</div>
                        <div class="learning-stat-value">${r.predictions}</div>
                        <div class="learning-stat-label">Predictions</div>
                    </div>
                    <div class="learning-stat">
                        <div class="learning-stat-icon">✅</div>
                        <div class="learning-stat-value">${r.evaluated || 0}</div>
                        <div class="learning-stat-label">Evaluated</div>
                    </div>
                    <div class="learning-stat">
                        <div class="learning-stat-icon">🎯</div>
                        <div class="learning-stat-value" style="color:${accColor}">${r.accuracy != null ? r.accuracy + '%' : '--'}</div>
                        <div class="learning-stat-label">Accuracy</div>
                    </div>
                    <div class="learning-stat">
                        <div class="learning-stat-icon">${pnlVal >= 0 ? '📈' : '📉'}</div>
                        <div class="learning-stat-value" style="color:${pnlVal >= 0 ? 'var(--green)' : 'var(--red)'}">${pnlVal >= 0 ? '+' : ''}${pnlVal.toFixed(2)}%</div>
                        <div class="learning-stat-label">Avg P&L 24h</div>
                    </div>
                </div>
                ${r.recent && r.recent.length > 0 ? `
                <div class="learning-panel" style="margin-top:16px">
                    <div class="learning-panel-header">📋 Recent Predictions</div>
                    <div class="learning-panel-body">
                        ${r.recent.map(p => {
                            const pnl = p.pnl_pct_24h;
                            const correct = p.direction_correct_24h;
                            return `<div class="prediction-row">
                                <span style="font-size:12px;color:var(--text-muted);width:130px">${new Date(p.created_at).toLocaleDateString()}</span>
                                <span class="prediction-verdict" style="background:${p.verdict?.includes('Buy') ? 'rgba(16,185,129,0.12)' : 'rgba(239,68,68,0.12)'};color:${p.verdict?.includes('Buy') ? 'var(--green)' : 'var(--red)'}">${p.verdict || '--'}</span>
                                <span style="font-size:12px;color:var(--text-muted)">Conf: ${(p.confidence||0).toFixed(1)}</span>
                                <span style="font-size:12px;color:var(--text-muted)">$${(p.price_at_prediction||0).toLocaleString()}</span>
                                <span class="prediction-pnl" style="color:${pnl != null ? (pnl >= 0 ? 'var(--green)' : 'var(--red)') : 'var(--text-muted)'}">${pnl != null ? (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + '%' : 'Pending'}</span>
                                <span style="font-size:16px">${correct === 1 ? '✅' : correct === 0 ? '❌' : '⏳'}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    } catch (e) {
        div.innerHTML = '<div class="empty-state"><p style="color:var(--red)">⚠️ ' + (e.message || 'Error looking up token') + '</p></div>';
    }
}

// ── Token Detail ──────────────────────────────────────────────
async function openToken(coinId, name) {
    const modal = document.getElementById('detailModal');
    const content = document.getElementById('detailContent');
    modal.classList.add('active');
    content.innerHTML = '<div class="loader"><div class="spinner"></div></div>';

    try {
        const d = await api('/api/token/' + encodeURIComponent(coinId));
        const chgCls = d.price_change_24h >= 0 ? 'price-positive' : 'price-negative';

        let html = `
        <div class="detail-header">
            <div class="detail-avatar">${d.symbol.slice(0,2)}</div>
            <div>
                <div class="detail-name">${d.name}</div>
                <div class="detail-symbol">${d.symbol}${d.rank ? ' · Rank #' + d.rank : ''}</div>
            </div>
            ${currentUser ? '<button class="btn btn-sm btn-outline" style="margin-left:auto" onclick="addWatchlist(\'' + coinId + '\')">★ Watch</button>' : ''}
        </div>

        <div class="detail-price-row">
            <span class="detail-price">${fmt(d.price)}</span>
            <span class="${chgCls}" style="font-size:18px;font-weight:600">
                ${d.price_change_24h >= 0 ? '▲' : '▼'} ${Math.abs(d.price_change_24h).toFixed(2)}% (24h)
            </span>
        </div>

        <div class="metrics-grid">
            <div class="metric-box"><div class="metric-label">Market Cap</div><div class="metric-value">${fmt(d.market_cap)}</div></div>
            <div class="metric-box"><div class="metric-label">Volume 24h</div><div class="metric-value">${fmt(d.volume_24h)}</div></div>
            <div class="metric-box"><div class="metric-label">All-Time High</div><div class="metric-value">${fmt(d.ath)}</div></div>
        </div>`;

        // TradingView Chart in Modal
        const modalTVSymbol = getTVSymbol(coinId, d.symbol);
        if (modalTVSymbol) {
            html += `
            <div class="tv-modal-chart-wrap">
                <div class="tv-chart-header" style="border-radius:12px 12px 0 0;margin-bottom:0">
                    <span class="tv-chart-label">📈 Live Chart — ${d.symbol}</span>
                    <div class="tv-chart-timeframes" style="gap:4px">
                        <button class="tv-tf-btn tv-tf-sm" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','15')">15m</button>
                        <button class="tv-tf-btn tv-tf-sm" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','60')">1H</button>
                        <button class="tv-tf-btn tv-tf-sm active" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','D')">1D</button>
                        <button class="tv-tf-btn tv-tf-sm" onclick="renderTVAdvancedChart('modalTVChart','${modalTVSymbol}','W')">1W</button>
                    </div>
                </div>
                <div id="modalTVChart" style="height:350px;border-radius:0 0 12px 12px;overflow:hidden"></div>
            </div>`;
        }

        // TA
        if (d.ta_trend && d.ta_trend !== 'unknown') {
            const taColor = scoreColor(d.ta_score);
            html += `
            <div class="analysis-section">
                <div class="analysis-title">📊 Technical Analysis</div>
                <div class="analysis-row"><span>Score</span><span>${d.ta_score.toFixed(1)} / 10</span></div>
                <div class="score-bar-container"><div class="score-bar ${taColor}" style="width:${d.ta_score*10}%"></div></div>
                <div class="analysis-row" style="margin-top:10px"><span>Trend</span><span>${d.ta_trend}</span></div>
                <div class="analysis-row"><span>RSI (14)</span><span>${d.ta_rsi.toFixed(1)} (${d.ta_rsi_label})</span></div>
                <div class="analysis-row"><span>MACD</span><span>${d.ta_macd}</span></div>
                <div class="analysis-row"><span>Pattern</span><span>${d.ta_pattern || 'None'}</span></div>
                <div class="analysis-row"><span>Support</span><span>${fmt(d.ta_support)}</span></div>
                <div class="analysis-row"><span>Resistance</span><span>${fmt(d.ta_resistance)}</span></div>
            </div>`;
        }

        // News
        const newsColor = scoreColor(d.news_score);
        html += `
        <div class="analysis-section">
            <div class="analysis-title">📰 News & Sentiment</div>
            <div class="analysis-row"><span>Score</span><span>${d.news_score.toFixed(1)} / 10</span></div>
            <div class="score-bar-container"><div class="score-bar ${newsColor}" style="width:${d.news_score*10}%"></div></div>
            <div class="analysis-row" style="margin-top:10px"><span>Narrative</span><span>${d.news_narrative || 'Neutral'}</span></div>
        </div>`;

        if (d.news_headlines?.length) {
            html += '<div class="analysis-section"><div class="analysis-title">📌 Headlines</div>';
            d.news_headlines.forEach(h => {
                html += `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0;border-bottom:1px solid var(--border)">• ${h}</div>`;
            });
            html += '</div>';
        }

        // AI
        if (d.ai_available && d.ai_recommendation) {
            html += `
            <div class="ai-box">
                <div class="ai-box-title">🤖 AI Recommendation <span class="ai-badge">GEMINI</span></div>
                <div class="ai-text">${d.ai_recommendation}</div>
            </div>`;
        } else {
            html += `
            <div class="ai-box" style="opacity:0.6">
                <div class="ai-box-title">🤖 AI Recommendation <span class="ai-badge" style="background:var(--text-muted)">OFFLINE</span></div>
                <div class="ai-text">AI analysis unavailable. Set a GEMINI_API_KEY with quota to enable.</div>
            </div>`;
        }

        content.innerHTML = html;

        // Render TradingView chart inside modal after DOM update
        if (modalTVSymbol && document.getElementById('modalTVChart')) {
            setTimeout(() => renderTVAdvancedChart('modalTVChart', modalTVSymbol, 'D'), 100);
        }
    } catch (e) {
        content.innerHTML = `<div class="empty-state"><h3>Error loading token</h3><p>${e.message}</p></div>`;
    }
}

async function addWatchlist(coinId) {
    if (!currentUser) return showAuthModal('login');
    try {
        const data = await api(`/api/watchlist/${coinId}`, { method: 'POST' });
        currentUser.watchlist = data.watchlist;
        alert('Added to watchlist!');
    } catch (e) {
        alert(e.message);
    }
}

// ── Search ────────────────────────────────────────────────────
async function doSearch() {
    const q = document.getElementById('globalSearch').value.trim();
    if (!q) return;

    // Try to open as CoinGecko token first
    navigate('market');
    openToken(q.toLowerCase(), q);
}

// ══════════════════════════════════════════════════════════════
// TOAST NOTIFICATIONS
// ══════════════════════════════════════════════════════════════

function showToast(message, type = 'info') {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 4000);
}

// ══════════════════════════════════════════════════════════════
// AUTO TRADER FUNCTIONS
// ══════════════════════════════════════════════════════════════

async function loadTraderDashboard() {
    if (!currentUser) { showAuthModal('login'); return; }
    loadBlockchainStatus();
    try {
        const [perf, positions] = await Promise.all([
            api('/api/trader/performance'),
            api('/api/trader/positions'),
        ]);

        // Stats
        document.getElementById('traderBalance').textContent = '$' + formatUSD(perf.wallet_balance);
        const totalPnl = (perf.realized_pnl || 0) + (perf.unrealized_pnl || 0);
        const retCls = totalPnl >= 0 ? 'color:var(--green)' : 'color:var(--red)';
        document.getElementById('traderReturn').innerHTML = `<span style="${retCls}">P&L: $${formatUSD(totalPnl)}</span>`;
        
        const pnlCls = perf.realized_pnl >= 0 ? 'color:var(--green)' : 'color:var(--red)';
        document.getElementById('traderPnl').innerHTML = `<span style="${pnlCls}">$${formatUSD(perf.realized_pnl)}</span>`;
        document.getElementById('traderWinRate').textContent = `Win rate: ${perf.win_rate}% (${perf.winning_trades}W / ${perf.losing_trades}L)`;

        document.getElementById('traderOpenCount').textContent = perf.open_positions;
        document.getElementById('traderInvested').textContent = `$${formatUSD(perf.invested_in_positions)} invested`;

        document.getElementById('traderTradeCount').textContent = perf.total_trades;
        document.getElementById('traderBestWorst').textContent = `Best: $${formatUSD(perf.best_trade)} | Worst: $${formatUSD(perf.worst_trade)}`;

        // Toggle state
        const settings = await api('/api/trader/settings');
        document.getElementById('autoTradeToggle').checked = !!settings.auto_trade_enabled;
        const badge = document.getElementById('traderStatusBadge');
        if (settings.auto_trade_enabled) {
            badge.className = 'trader-status active';
            badge.textContent = '● Active';
        } else {
            badge.className = 'trader-status inactive';
            badge.textContent = '● Inactive';
        }

        // Open Positions
        renderTraderPositions(positions.open || []);

    } catch(e) {
        console.error('Trader load failed:', e);
    }
}

function renderTraderPositions(positions) {
    const el = document.getElementById('traderPositions');
    if (!positions.length) {
        el.innerHTML = '<div class="empty-state" style="padding:20px"><p>No open positions — the bot will buy when it finds opportunities</p></div>';
        return;
    }
    el.innerHTML = positions.map(p => {
        const pnlCls = p.pnl >= 0 ? 'profit' : 'loss';
        const pnlSign = p.pnl >= 0 ? '+' : '';
        const posHash = p.tx_hash || '';
        const posShortHash = posHash ? posHash.slice(0,8) + '…' + posHash.slice(-6) : '';
        return `
        <div class="position-card">
            <div class="position-header">
                <div class="position-coin">${p.symbol} <span style="color:var(--text-muted);font-weight:400;font-size:13px">${p.coin_name}</span></div>
                <div style="display:flex;align-items:center;gap:10px">
                    <span class="position-badge ${pnlCls}">${pnlSign}$${Math.abs(p.pnl).toFixed(2)} (${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%)</span>
                    <button class="btn btn-sm btn-danger" onclick="sellPosition(${p.id})">Sell</button>
                </div>
            </div>
            <div class="position-details">
                <div><span>Entry Price</span><strong>$${p.entry_price.toFixed(2)}</strong></div>
                <div><span>Current</span><strong>$${p.current_price.toFixed(2)}</strong></div>
                <div><span>Quantity</span><strong>${p.quantity.toFixed(6)}</strong></div>
                <div><span>Invested</span><strong>$${formatUSD(p.invested_amount)}</strong></div>
                <div><span>Stop Loss</span><strong>$${p.stop_loss.toFixed(2)}</strong></div>
                <div><span>Take Profit</span><strong>$${p.take_profit.toFixed(2)}</strong></div>
            </div>
            ${posHash ? `<div style="margin-top:6px;font-family:monospace;font-size:11px;color:var(--text-muted)">
                🔗 <span title="${posHash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${posHash}')">${posShortHash}</span>
                <span data-hash="${posHash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${posHash}')">📋</span>
            </div>` : ''}
            <div style="margin-top:8px;padding:8px;background:var(--bg-primary);border-radius:6px;font-size:12px;color:var(--text-secondary);line-height:1.5">
                <strong style="color:var(--accent)">🤖 AI Analysis:</strong> ${p.ai_reasoning}
            </div>
        </div>`;
    }).join('');
}

async function toggleAutoTrade() {
    if (!currentUser) return;
    const badge = document.getElementById('traderStatusBadge');
    const toggle = document.getElementById('autoTradeToggle');
    const isEnabling = toggle.checked;

    if (isEnabling) {
        badge.className = 'trader-status active';
        badge.textContent = '⏳ Starting...';
    }

    try {
        const data = await api('/api/trader/toggle', { method: 'POST' });

        if (data.auto_trade_enabled) {
            badge.className = 'trader-status active';
            badge.textContent = '● Active';

            // Update wallet balance immediately
            if (data.wallet_balance !== undefined) {
                document.getElementById('traderBalance').textContent = '$' + formatUSD(data.wallet_balance);
            }

            // Show first cycle results
            if (data.cycle) {
                const cycle = data.cycle;
                if (cycle.status === 'no_funds') {
                    showToast('⚠️ Wallet is empty — deposit funds to start auto-trading', 'warning');
                } else if (cycle.actions?.length) {
                    showToast(`🤖 Auto Trader active! ${cycle.actions.length} trade(s) executed`, 'success');
                } else if (cycle.new_trades === 0 && cycle.positions_updated >= 0) {
                    showToast('🤖 Auto Trader active! Monitoring markets for opportunities...', 'success');
                } else {
                    showToast('🤖 Auto Trader is now running!', 'success');
                }
            }

            // Refresh entire dashboard with latest data
            loadTraderDashboard();
        } else {
            badge.className = 'trader-status inactive';
            badge.textContent = '● Inactive';
            showToast('Auto Trader stopped', 'info');
        }
    } catch(e) {
        // Revert toggle on error
        toggle.checked = !isEnabling;
        badge.className = isEnabling ? 'trader-status inactive' : 'trader-status active';
        badge.textContent = isEnabling ? '● Inactive' : '● Active';
        alert(e.message);
    }
}

async function runTradeCycle() {
    if (!currentUser) return showAuthModal('login');
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '⏳ Running...';
    try {
        const result = await api('/api/trader/run-cycle', { method: 'POST' });
        let msg = `Status: ${result.status || 'done'}\n`;
        if (result.actions?.length) {
            msg += result.actions.join('\n');
        } else if (result.message) {
            msg += result.message;
        } else {
            msg += `Positions updated: ${result.positions_updated || 0}, New trades: ${result.new_trades || 0}`;
        }
        alert(msg);
        loadTraderDashboard();
    } catch(e) { alert('Error: ' + e.message); }
    finally {
        btn.disabled = false;
        btn.textContent = '⚡ Run Trade Cycle';
    }
}

async function runResearch() {
    if (!currentUser) return showAuthModal('login');
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '🔍 Researching...';
    try {
        const data = await api('/api/trader/research');
        const el = document.getElementById('traderOpportunities');
        if (!data.opportunities?.length) {
            el.innerHTML = '<div class="empty-state"><p>No opportunities found right now</p></div>';
            return;
        }
        el.innerHTML = data.opportunities.map(o => {
            const scoreCls = o.score >= 60 ? 'high' : o.score >= 35 ? 'mid' : 'low';
            return `
            <div class="opp-card">
                <div class="opp-info">
                    <div class="opp-name">${o.symbol} <span style="color:var(--text-muted);font-weight:400">${o.name}</span></div>
                    <div class="opp-detail">$${o.price.toFixed(4)} | 24h: ${o.change_24h >= 0 ? '+' : ''}${o.change_24h.toFixed(1)}% | Vol: $${(o.volume_24h/1000).toFixed(0)}K</div>
                    <div class="opp-detail" style="margin-top:4px">💡 ${o.reasoning}</div>
                </div>
                <div class="opp-score ${scoreCls}">${o.score}</div>
            </div>`;
        }).join('');
    } catch(e) { alert('Research failed: ' + e.message); }
    finally {
        btn.disabled = false;
        btn.textContent = '🔍 Research Market';
    }
}

async function sellPosition(posId) {
    if (!confirm('Sell this position?')) return;
    try {
        const result = await api(`/api/trader/sell/${posId}`, { method: 'POST' });
        const hashLine = result.tx_hash ? `\n\n🔗 TX Hash:\n${result.tx_hash}` : '';
        alert(`Sold! P&L: $${result.pnl.toFixed(2)} (${result.pnl_pct >= 0 ? '+' : ''}${result.pnl_pct.toFixed(1)}%)${hashLine}`);
        loadTraderDashboard();
    } catch(e) { alert(e.message); }
}

function showManualBuyModal() {
    if (!currentUser) return showAuthModal('login');
    const html = `
        <h2>🛒 Buy Crypto</h2>
        <div class="form-group"><label>Coin ID (e.g. bitcoin, ethereum, solana)</label>
            <input class="form-input" id="manualBuyCoin" placeholder="bitcoin"></div>
        <div class="form-group"><label>Amount ($)</label>
            <input class="form-input" id="manualBuyAmount" type="number" placeholder="5000">
            <div style="display:flex;gap:6px;margin-top:6px">
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=1000">$1K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=5000">$5K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=10000">$10K</button>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('manualBuyAmount').value=20000">$20K</button>
            </div>
        </div>
        <button class="btn btn-green" style="width:100%;margin-top:8px" onclick="submitManualBuy()">Buy Now</button>
    `;
    showDynamicModal(html);
}

async function submitManualBuy() {
    const coin_id = document.getElementById('manualBuyCoin').value.trim().toLowerCase();
    const amount = parseFloat(document.getElementById('manualBuyAmount').value);
    if (!coin_id || !amount || amount <= 0) return alert('Enter coin and amount');
    try {
        const result = await api('/api/trader/buy', {
            method: 'POST',
            body: JSON.stringify({ coin_id, amount }),
        });
        closeDynamicModal();
        const hashLine = result.tx_hash ? `\n\n🔗 TX Hash:\n${result.tx_hash}` : '';
        alert(`✅ Buy order placed for $${amount.toLocaleString()}${hashLine}`);
        loadTraderDashboard();
    } catch(e) { alert(e.message); }
}

function showDynamicModal(html) {
    let overlay = document.getElementById('dynamicModal');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'dynamicModal';
        overlay.className = 'modal-overlay';
        overlay.innerHTML = '<div class="modal" id="dynamicModalContent"></div>';
        overlay.addEventListener('click', e => { if (e.target === overlay) closeDynamicModal(); });
        document.body.appendChild(overlay);
    }
    document.getElementById('dynamicModalContent').innerHTML = `<button class="modal-close" onclick="closeDynamicModal()">&times;</button>` + html;
    overlay.classList.add('active');
}
function closeDynamicModal() {
    document.getElementById('dynamicModal')?.classList.remove('active');
}

function showTraderSettings() {
    if (!currentUser) return showAuthModal('login');
    api('/api/trader/settings').then(s => {
        const html = `
            <h2>⚙️ Trading Settings</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Max Trade Size (%)</div>
                    <input class="setting-input" id="setMaxTrade" type="number" value="${s.max_trade_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Daily Loss Limit (%)</div>
                    <input class="setting-input" id="setDailyLoss" type="number" value="${s.daily_loss_limit_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Max Open Positions</div>
                    <input class="setting-input" id="setMaxPos" type="number" value="${s.max_open_positions}" min="1" max="20">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Stop Loss (%)</div>
                    <input class="setting-input" id="setStopLoss" type="number" value="${s.stop_loss_pct}" min="1" max="50">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Take Profit (%)</div>
                    <input class="setting-input" id="setTakeProfit" type="number" value="${s.take_profit_pct}" min="5" max="200">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Cooldown (minutes)</div>
                    <input class="setting-input" id="setCooldown" type="number" value="${s.cooldown_minutes}" min="1" max="60">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Min Market Cap ($)</div>
                    <input class="setting-input" id="setMinMcap" type="number" value="${s.min_market_cap}">
                </div>
                <div class="setting-item">
                    <div class="setting-label">Risk Level</div>
                    <select class="setting-input" id="setRiskLevel">
                        <option value="conservative" ${s.risk_level==='conservative'?'selected':''}>Conservative</option>
                        <option value="moderate" ${s.risk_level==='moderate'?'selected':''}>Moderate</option>
                        <option value="aggressive" ${s.risk_level==='aggressive'?'selected':''}>Aggressive</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="saveTraderSettings()">Save Settings</button>
        `;
        showDynamicModal(html);
    });
}

async function saveTraderSettings() {
    try {
        await api('/api/trader/settings', {
            method: 'POST',
            body: JSON.stringify({
                max_trade_pct: parseFloat(document.getElementById('setMaxTrade').value),
                daily_loss_limit_pct: parseFloat(document.getElementById('setDailyLoss').value),
                max_open_positions: parseInt(document.getElementById('setMaxPos').value),
                stop_loss_pct: parseFloat(document.getElementById('setStopLoss').value),
                take_profit_pct: parseFloat(document.getElementById('setTakeProfit').value),
                cooldown_minutes: parseInt(document.getElementById('setCooldown').value),
                min_market_cap: parseFloat(document.getElementById('setMinMcap').value),
                risk_level: document.getElementById('setRiskLevel').value,
            }),
        });
        closeDynamicModal();
        alert('Settings saved!');
    } catch(e) { alert(e.message); }
}

async function resetTrading() {
    if (!confirm('Reset trading? This will close all open positions and refund invested amounts to your wallet.')) return;
    try {
        await api('/api/trader/reset', { method: 'POST' });
        alert('Trading stats reset! Open positions refunded to wallet.');
        loadTraderDashboard();
    } catch(e) { alert(e.message); }
}

function copyHash(hash) {
    navigator.clipboard.writeText(hash).then(() => {
        const btn = document.querySelector(`[data-hash="${hash}"]`);
        if (btn) { btn.textContent = '✓'; setTimeout(() => btn.textContent = '📋', 1200); }
    });
}

async function verifyHash(hash) {
    try {
        const res = await api(`/api/verify-tx/${hash}`);
        let msg = '';
        if (res.found && res.verified) {
            msg = `✅ VERIFIED (Local)\n\nSource: ${res.source}\nHash: ${hash}\n\nThis transaction is authentic and has not been tampered with.`;
        } else if (res.found) {
            msg = `⚠️ INTEGRITY WARNING\n\nHash: ${hash}\nThe hash does not match the transaction data.`;
        } else {
            msg = `❌ NOT FOUND\n\nHash: ${hash}\nNo transaction found with this hash.`;
        }
        // Show on-chain status
        if (res.on_chain && res.on_chain.exists) {
            msg += `\n\n⛓ ON-CHAIN VERIFIED (${res.on_chain.network})\nRecorder: ${res.on_chain.recorder}\nType: ${res.on_chain.tx_type}\nSymbol: ${res.on_chain.symbol}\nAmount: $${res.on_chain.amount_usd.toFixed(2)}`;
            if (res.on_chain.explorer_url) msg += `\nExplorer: ${res.on_chain.explorer_url}`;
        } else if (res.on_chain && !res.on_chain.exists) {
            msg += `\n\n⏳ Not yet recorded on-chain (${res.on_chain.network})`;
        } else {
            msg += `\n\n🔗 Blockchain: Not configured (local hash only)`;
        }
        alert(msg);
    } catch(e) { alert('Error verifying: ' + e.message); }
}

async function loadBlockchainStatus() {
    try {
        const status = await api('/api/blockchain/status');
        const el = document.getElementById('blockchainStatusBadge');
        if (!el) return;
        if (status.enabled) {
            el.innerHTML = `<span style="color:var(--green);font-size:12px">⛓ ${status.network} · ${status.on_chain_tx_count || 0} on-chain</span>`;
        } else {
            el.innerHTML = `<span style="color:var(--text-muted);font-size:12px">⛓ Local hashes only</span>`;
        }
    } catch(e) {}
}

async function loadTraderHistory() {
    try {
        const trades = await api('/api/trader/history?limit=25');
        const el = document.getElementById('traderHistoryArea');
        if (!trades.length) { el.innerHTML = '<div class="empty-state"><p>No trades yet</p></div>'; return; }
        el.innerHTML = `<table class="feed-table"><thead><tr><th>Time</th><th>Action</th><th>Coin</th><th>Price</th><th>Amount</th><th>Score</th><th>TX Hash</th></tr></thead><tbody>` +
            trades.map(t => {
                const actionCls = t.action === 'BUY' ? 'color:var(--green)' : 'color:var(--red)';
                const hash = t.tx_hash || '';
                const shortHash = hash ? hash.slice(0,8) + '…' + hash.slice(-6) : 'N/A';
                return `<tr>
                    <td style="font-size:12px">${new Date(t.created_at).toLocaleString()}</td>
                    <td style="${actionCls};font-weight:600">${t.action}</td>
                    <td>${t.symbol}</td>
                    <td>$${t.price.toFixed(2)}</td>
                    <td>$${formatUSD(t.amount)}</td>
                    <td>${t.ai_score}/100</td>
                    <td style="font-family:monospace;font-size:11px">
                        ${hash ? `<span title="${hash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${hash}')">${shortHash}</span>
                        <span data-hash="${hash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${hash}')">📋</span>` : 'N/A'}
                    </td>
                </tr>`;
            }).join('') + '</tbody></table>';
    } catch(e) { console.error(e); }
}

async function loadTraderLog() {
    try {
        const logs = await api('/api/trader/log?limit=30');
        const el = document.getElementById('traderHistoryArea');
        if (!logs.length) { el.innerHTML = '<div class="empty-state"><p>No log entries yet</p></div>'; return; }
        el.innerHTML = logs.map(l => `
            <div class="log-item">
                <span class="log-time">${new Date(l.created_at).toLocaleString()}</span>
                <span class="log-event">[${l.event}]</span>
                <span>${l.details}</span>
            </div>
        `).join('');
    } catch(e) { console.error(e); }
}

async function loadClosedPositions() {
    try {
        const data = await api('/api/trader/positions');
        const closed = data.closed || [];
        const el = document.getElementById('traderHistoryArea');
        if (!closed.length) { el.innerHTML = '<div class="empty-state"><p>No closed positions yet</p></div>'; return; }
        el.innerHTML = closed.map(p => {
            const pnlCls = p.pnl >= 0 ? 'profit' : 'loss';
            const sign = p.pnl >= 0 ? '+' : '';
            const clHash = p.tx_hash || '';
            const clShortHash = clHash ? clHash.slice(0,8) + '…' + clHash.slice(-6) : '';
            return `
            <div class="position-card">
                <div class="position-header">
                    <div class="position-coin">${p.symbol} <span style="color:var(--text-muted);font-weight:400;font-size:13px">${p.coin_name}</span></div>
                    <span class="position-badge ${pnlCls}">${sign}$${Math.abs(p.pnl).toFixed(2)} (${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%)</span>
                </div>
                <div class="position-details">
                    <div><span>Entry</span><strong>$${p.entry_price.toFixed(2)}</strong></div>
                    <div><span>Exit</span><strong>$${p.current_price.toFixed(2)}</strong></div>
                    <div><span>Invested</span><strong>$${formatUSD(p.invested_amount)}</strong></div>
                </div>
                <div style="margin-top:6px;font-size:11px;color:var(--text-muted)">Closed: ${new Date(p.closed_at).toLocaleString()}</div>
                ${clHash ? `<div style="font-family:monospace;font-size:11px;margin-top:3px;color:var(--text-muted)">
                    🔗 <span title="${clHash}" style="cursor:pointer;color:var(--primary)" onclick="verifyHash('${clHash}')">${clShortHash}</span>
                    <span data-hash="${clHash}" style="cursor:pointer;margin-left:4px" onclick="copyHash('${clHash}')">📋</span>
                </div>` : ''}
            </div>`;
        }).join('');
    } catch(e) { console.error(e); }
}

// ══════════════════════════════════════════════════════════════
// SETTINGS FUNCTIONS
// ══════════════════════════════════════════════════════════════

function loadSettings() {
    const saved = JSON.parse(localStorage.getItem('pumpiq_settings') || '{}');
    if (saved.theme) { document.getElementById('settTheme').value = saved.theme; }
    if (saved.defaultExchange) document.getElementById('settDefaultExchange').value = saved.defaultExchange;
    if (saved.defaultStable) document.getElementById('settDefaultStable').value = saved.defaultStable;
    if (saved.defaultLeverage) document.getElementById('settDefaultLeverage').value = saved.defaultLeverage;
    if (saved.riskLevel) document.getElementById('settRiskLevel').value = saved.riskLevel;
    if (saved.notifications) {
        const n = saved.notifications;
        document.getElementById('settPriceAlerts').checked = n.priceAlerts !== false;
        document.getElementById('settAIAlerts').checked = n.aiAlerts !== false;
        document.getElementById('settTradeAlerts').checked = n.tradeAlerts !== false;
        document.getElementById('settWhaleAlerts').checked = n.whaleAlerts || false;
        document.getElementById('settDailySummary').checked = n.dailySummary !== false;
    }
    if (saved.privacy) {
        document.getElementById('settShowPortfolio').checked = saved.privacy.showPortfolio || false;
        document.getElementById('settShareData').checked = saved.privacy.shareData !== false;
        document.getElementById('settAnalytics').checked = saved.privacy.analytics !== false;
    }
    // Load saved API keys display
    loadApiKeysDisplay();
    // Set active accent swatch
    const accent = saved.accent || '#6c5ce7';
    document.querySelectorAll('.color-swatch').forEach(s => {
        s.style.borderColor = s.style.backgroundColor === accent || rgbToHex(s.style.backgroundColor) === accent ? 'white' : 'transparent';
        s.classList.toggle('active', rgbToHex(s.style.backgroundColor) === accent);
    });
}

function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb;
    const m = rgb.match(/\d+/g);
    if (!m) return rgb;
    return '#' + m.slice(0,3).map(x => parseInt(x).toString(16).padStart(2,'0')).join('');
}

function applyTheme(theme) {
    const root = document.documentElement;
    if (theme === 'light') {
        root.style.setProperty('--bg-primary', '#f5f5f7');
        root.style.setProperty('--bg-secondary', '#ffffff');
        root.style.setProperty('--bg-card', '#ffffff');
        root.style.setProperty('--text-primary', '#1a1a2e');
        root.style.setProperty('--text-secondary', '#4a4a5a');
        root.style.setProperty('--text-muted', '#7a7a8a');
        root.style.setProperty('--border', '#e0e0e5');
    } else if (theme === 'midnight') {
        root.style.setProperty('--bg-primary', '#0a0a14');
        root.style.setProperty('--bg-secondary', '#0f0f1e');
        root.style.setProperty('--bg-card', '#111128');
        root.style.setProperty('--text-primary', '#e8e8f0');
        root.style.setProperty('--text-secondary', '#a0a0b8');
        root.style.setProperty('--text-muted', '#6a6a82');
        root.style.setProperty('--border', '#1e1e3a');
    } else {
        // dark (default) - reset to original
        root.style.setProperty('--bg-primary', '#0f1117');
        root.style.setProperty('--bg-secondary', '#1a1d27');
        root.style.setProperty('--bg-card', '#1e2230');
        root.style.setProperty('--text-primary', '#e8e8f0');
        root.style.setProperty('--text-secondary', '#a0a4b8');
        root.style.setProperty('--text-muted', '#6b7080');
        root.style.setProperty('--border', '#2a2e3e');
    }
}

function setAccent(el, color) {
    document.documentElement.style.setProperty('--primary', color);
    document.querySelectorAll('.color-swatch').forEach(s => {
        s.classList.remove('active');
        s.style.borderColor = 'transparent';
    });
    el.classList.add('active');
    el.style.borderColor = 'white';
}

function saveSettings() {
    const settings = {
        theme: document.getElementById('settTheme').value,
        accent: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
        defaultExchange: document.getElementById('settDefaultExchange').value,
        defaultStable: document.getElementById('settDefaultStable').value,
        defaultLeverage: document.getElementById('settDefaultLeverage').value,
        riskLevel: document.getElementById('settRiskLevel').value,
        notifications: {
            priceAlerts: document.getElementById('settPriceAlerts').checked,
            aiAlerts: document.getElementById('settAIAlerts').checked,
            tradeAlerts: document.getElementById('settTradeAlerts').checked,
            whaleAlerts: document.getElementById('settWhaleAlerts').checked,
            dailySummary: document.getElementById('settDailySummary').checked,
        },
        privacy: {
            showPortfolio: document.getElementById('settShowPortfolio').checked,
            shareData: document.getElementById('settShareData').checked,
            analytics: document.getElementById('settAnalytics').checked,
        },
    };
    localStorage.setItem('pumpiq_settings', JSON.stringify(settings));
    showToast('Settings saved!', 'success');
}

function resetSettings() {
    localStorage.removeItem('pumpiq_settings');
    applyTheme('dark');
    document.documentElement.style.setProperty('--primary', '#6c5ce7');
    loadSettings();
    showToast('Settings reset to defaults', 'info');
}

function saveApiKey() {
    const exchange = document.getElementById('settApiExchange').value;
    const key = document.getElementById('settApiKey').value.trim();
    const secret = document.getElementById('settApiSecret').value.trim();
    if (!key || !secret) { showToast('Enter both API Key and Secret', 'error'); return; }
    const keys = JSON.parse(localStorage.getItem('pumpiq_api_keys') || '[]');
    const existing = keys.findIndex(k => k.exchange === exchange);
    const entry = { exchange, key: key.slice(0,6) + '...' + key.slice(-4), added: new Date().toISOString() };
    if (existing >= 0) keys[existing] = entry; else keys.push(entry);
    localStorage.setItem('pumpiq_api_keys', JSON.stringify(keys));
    document.getElementById('settApiKey').value = '';
    document.getElementById('settApiSecret').value = '';
    loadApiKeysDisplay();
    showToast(`${exchange} API key saved`, 'success');
}

function loadApiKeysDisplay() {
    const keys = JSON.parse(localStorage.getItem('pumpiq_api_keys') || '[]');
    const container = document.getElementById('settApiKeysList');
    if (!keys.length) { container.innerHTML = '<div style="color:var(--text-muted);font-size:13px">No API keys configured</div>'; return; }
    container.innerHTML = keys.map(k => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg-secondary);border-radius:6px;margin-bottom:6px">
            <span style="font-size:13px;color:var(--text-primary)"><strong>${k.exchange}</strong> — ${k.key}</span>
            <button onclick="removeApiKey('${k.exchange}')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px">🗑</button>
        </div>
    `).join('');
}

function removeApiKey(exchange) {
    let keys = JSON.parse(localStorage.getItem('pumpiq_api_keys') || '[]');
    keys = keys.filter(k => k.exchange !== exchange);
    localStorage.setItem('pumpiq_api_keys', JSON.stringify(keys));
    loadApiKeysDisplay();
    showToast(`${exchange} API key removed`, 'info');
}

// Apply saved settings on page load
(function initSettings() {
    const saved = JSON.parse(localStorage.getItem('pumpiq_settings') || '{}');
    if (saved.theme) applyTheme(saved.theme);
    if (saved.accent) document.documentElement.style.setProperty('--primary', saved.accent);
})();

// ══════════════════════════════════════════════════════════════
// STRATEGY BUILDER FUNCTIONS (Crypto-Native)
// ══════════════════════════════════════════════════════════════

function switchTraderTab(tab) {
    document.querySelectorAll('.trader-subtab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.trader-subpage').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('traderSub-' + tab)?.classList.add('active');
    if (tab === 'strategies') sbLoadStrategies();
}

// ── Generic pill picker ──
function sbPickPill(el, groupName) {
    const parent = el.closest('.sb-pills') || el.parentElement;
    parent.querySelectorAll('.sb-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    const radio = el.querySelector('input[type=radio]');
    if (radio) radio.checked = true;
}

// ── Exchange picker ──
function sbPickExchange(el) {
    document.querySelectorAll('.sb-exchange-opt').forEach(e => e.classList.remove('active'));
    el.classList.add('active');
}

// ── Market type toggle (show/hide futures config) ──
function sbMarketChanged() {
    const mkt = document.querySelector('input[name="sbMkt"]:checked')?.value;
    const fc = document.getElementById('sbFuturesConfig');
    if (fc) fc.style.display = mkt === 'futures' ? 'block' : 'none';
}

// ── Leverage ──
function sbLeverageChanged() {
    const val = document.getElementById('sbLeverage').value;
    document.getElementById('sbLevVal').textContent = val + 'x';
    // Update preset highlights
    document.querySelectorAll('.sb-leverage-presets button').forEach(b => {
        b.classList.toggle('active', b.textContent === val + 'x');
    });
    // Estimated liquidation
    const posSize = parseFloat(document.getElementById('sbPosSize')?.value) || 100;
    const liqDist = (100 / val).toFixed(1);
    document.getElementById('sbLiqPrice').textContent =
        `Est. Liquidation: ~${liqDist}% from entry (${val}x leverage on $${posSize})`;
}

function sbSetLev(val) {
    document.getElementById('sbLeverage').value = val;
    sbLeverageChanged();
}

// ── Template hints ──
const SB_TEMPLATE_HINTS = {
    custom: 'Build your own custom trading strategy from scratch',
    grid: 'Place buy/sell orders at set intervals — works great in ranging markets',
    dca: 'Dollar-cost average into positions at regular intervals or on dips',
    momentum: 'Follow strong trends using RSI, MACD and volume breakouts',
    mean_reversion: 'Trade price bounces back to mean using Bollinger Bands',
    scalping: 'Quick in/out trades on 1m–5m charts with tight stops',
    swing: 'Multi-day positions based on 4h/1D chart patterns',
    funding_farm: 'Earn funding fees by longing when funding is negative',
    breakout: 'Enter on price breakouts above resistance with volume confirmation',
};
function sbTemplateChanged() {
    const t = document.getElementById('sbStratType').value;
    document.getElementById('sbTemplateHint').textContent = SB_TEMPLATE_HINTS[t] || '';
}

// ── Indicator toggle ──
function sbToggleIndicator(el) {
    el.classList.toggle('active');
}

// ── Add entry/exit condition ──
function sbAddCondition(type) {
    const container = document.getElementById(type === 'entry' ? 'sbEntryConditions' : 'sbExitConditions');
    const action = type === 'entry' ? '→ BUY' : '→ SELL';
    const html = `<div class="sb-condition">
        <select><option>RSI</option><option>MACD</option><option>EMA</option><option>Volume</option><option>Funding Rate</option><option>Price</option><option>BTC Dom</option><option>Fear & Greed</option>${type==='exit'?'<option>Time</option>':''}</select>
        <select><option>crosses above</option><option>crosses below</option><option>is above</option><option>is below</option><option>increases by</option><option>decreases by</option></select>
        <input type="number" value="" style="width:60px" placeholder="val">
        <span style="color:var(--text-muted)">${action}</span>
        <button class="sb-cond-remove" onclick="this.closest('.sb-condition').remove()">×</button>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}

// ── Instrument Management ──
function sbToggleInstrDD() {
    const dd = document.getElementById('sbInstrDD');
    dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
}

function sbSelectInstr(el) {
    const pair = el.getAttribute('data-pair');
    const chips = document.getElementById('sbInstrumentChips');
    if (chips.querySelector(`[data-pair="${pair}"]`)) return;
    const chip = document.createElement('span');
    chip.className = 'sb-pill active';
    chip.setAttribute('data-pair', pair);
    chip.innerHTML = `${pair} <button onclick="sbRemoveInstr(this)" style="background:none;border:none;color:inherit;cursor:pointer;margin-left:4px;font-size:14px">&times;</button>`;
    chips.insertBefore(chip, document.getElementById('sbAddInstrBtn'));
    el.style.opacity = '0.4';
}

function sbRemoveInstr(btn) {
    const chip = btn.parentElement;
    const pair = chip.getAttribute('data-pair');
    chip.remove();
    const item = document.querySelector(`#sbInstrList [data-pair="${pair}"]`);
    if (item) item.style.opacity = '1';
}

function sbFilterInstr(q) {
    q = q.toLowerCase();
    document.querySelectorAll('#sbInstrList .sb-instr-item').forEach(i => {
        i.style.display = i.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
}

// ── Qty helper ──
function sbQty(btn, delta) {
    const inp = btn.parentElement.querySelector('input');
    inp.value = Math.max(0, (parseFloat(inp.value) || 0) + delta);
}

// ── Save Strategy (crypto-native) ──
async function sbSaveStrategy() {
    if (!currentUser) { showAuthModal('login'); return; }
    const name = document.getElementById('sbStratName').value.trim();
    if (!name) { showToast('Enter a strategy name', 'error'); return; }

    // Collect instruments
    const instrChips = document.querySelectorAll('#sbInstrumentChips .sb-pill[data-pair]');
    const instruments = Array.from(instrChips).map(c => c.getAttribute('data-pair'));

    // Strategy type & template
    const strategyType = document.getElementById('sbStratType').value;
    const timeframe = document.querySelector('input[name="sbTf"]:checked')?.value || '15m';

    // Exchange & market
    const exchange = document.querySelector('.sb-exchange-opt.active')?.getAttribute('data-exchange') || 'binance';
    const marketType = document.querySelector('input[name="sbMkt"]:checked')?.value || 'spot';
    const orderType = document.querySelector('input[name="sbOrder"]:checked')?.value || 'market';
    const stablecoinBase = document.querySelector('input[name="sbBase"]:checked')?.value || 'USDT';

    // Position config
    const positionSide = document.querySelector('input[name="sbSide"]:checked')?.value || 'long';
    const positionSize = parseFloat(document.getElementById('sbPosSize')?.value) || 100;
    const leverage = parseInt(document.getElementById('sbLeverage')?.value) || 1;
    const marginMode = document.querySelector('input[name="sbMargin"]:checked')?.value || 'isolated';

    // Entry indicators
    const activeIndicators = Array.from(document.querySelectorAll('.sb-indicator.active')).map(i => i.getAttribute('data-ind'));

    // Entry/exit conditions
    const entryConditions = [];
    document.querySelectorAll('#sbEntryConditions .sb-condition').forEach(c => {
        const sels = c.querySelectorAll('select');
        const inp = c.querySelector('input');
        entryConditions.push({
            indicator: sels[0]?.value, operator: sels[1]?.value,
            value: parseFloat(inp?.value) || 0
        });
    });
    const exitConditions = [];
    document.querySelectorAll('#sbExitConditions .sb-condition').forEach(c => {
        const sels = c.querySelectorAll('select');
        const inp = c.querySelector('input');
        exitConditions.push({
            indicator: sels[0]?.value, operator: sels[1]?.value,
            value: parseFloat(inp?.value) || 0
        });
    });

    // SL/TP
    const slMethod = document.querySelector('input[name="sbSL"]:checked')?.value || 'percent';
    const slVal = parseFloat(document.getElementById('sbSLVal')?.value) || 3;
    const tpVal = parseFloat(document.getElementById('sbTPVal')?.value) || 6;
    const trailVal = parseFloat(document.getElementById('sbTrailVal')?.value) || 1;

    // Risk management
    const riskConfig = {
        max_drawdown: parseFloat(document.getElementById('sbMaxDD')?.value) || 10,
        daily_loss_limit: parseFloat(document.getElementById('sbDailyLoss')?.value) || 5,
        max_open_positions: parseInt(document.getElementById('sbMaxPos')?.value) || 3,
        max_position_size_pct: parseFloat(document.getElementById('sbMaxPosSize')?.value) || 25,
        max_daily_trades: parseInt(document.getElementById('sbMaxTrades')?.value) || 10,
        cooldown_min: parseInt(document.getElementById('sbCooldown')?.value) || 5,
        volatility_filter: document.getElementById('sbVolFilter')?.checked || false,
        volatility_threshold: parseFloat(document.getElementById('sbVolThreshold')?.value) || 5,
    };

    // Kill switches
    const killSwitches = {
        flash_crash: document.getElementById('sbKillFlash')?.checked || false,
        flash_crash_pct: parseFloat(document.getElementById('sbKillFlashVal')?.value) || 15,
        circuit_breaker: document.getElementById('sbKillCircuit')?.checked || false,
        circuit_breaker_pct: parseFloat(document.getElementById('sbKillCircuitVal')?.value) || 10,
        stablecoin_depeg: document.getElementById('sbKillDepeg')?.checked || false,
        depeg_threshold: parseFloat(document.getElementById('sbKillDepegVal')?.value) || 0.98,
    };

    // Schedule
    const sessions = Array.from(document.querySelectorAll('.sb-session.active')).map(s => s.querySelector('.sb-session-name')?.textContent?.trim());
    const activeDays = Array.from(document.querySelectorAll('.sb-day.active')).map((d, i) => ['MON','TUE','WED','THU','FRI','SAT','SUN'][i]);
    const regimes = Array.from(document.querySelectorAll('.sb-regime.active')).map(r => r.getAttribute('data-regime'));
    const sleepEnabled = document.getElementById('sbSleepEnabled')?.checked || false;
    const sleepFrom = document.getElementById('sbSleepFrom')?.value || '';
    const sleepTo = document.getElementById('sbSleepTo')?.value || '';

    // Cycle awareness
    const cycleConfig = {
        halving: document.getElementById('sbHalving')?.checked || false,
        alt_season: document.getElementById('sbAltSeason')?.checked || false,
        fear_greed_filter: document.getElementById('sbFearGreed')?.checked || false,
        btc_correlation: document.getElementById('sbBtcCorr')?.checked || false,
    };

    // Advanced features
    const advancedConfig = {
        dca: document.getElementById('sbDCA')?.checked || false,
        martingale: document.getElementById('sbMartingale')?.checked || false,
        grid_mode: document.getElementById('sbGridMode')?.checked || false,
        funding_farm: document.getElementById('sbFundingFarm')?.checked || false,
        pairs_hedge: document.getElementById('sbPairsHedge')?.checked || false,
        btc_dom_rotate: document.getElementById('sbBtcDomRotate')?.checked || false,
        auto_deleverage: document.getElementById('sbAutoDeleverage')?.checked || false,
        slippage_model: document.getElementById('sbSlippageModel')?.checked || false,
        move_sl_to_cost: document.getElementById('sbMoveSlCost')?.checked || false,
        re_entry: document.getElementById('sbReEntry')?.checked || false,
    };

    // Build legs array (single leg from position config)
    const legs = [{
        leg_number: 1,
        position: positionSide,
        market_type: marketType,
        leverage: leverage,
        margin_mode: marginMode,
        qty: positionSize,
        sl_method: slMethod,
        stop_loss: slVal,
        take_profit: tpVal,
        trail_distance: trailVal,
        entry_conditions: entryConditions,
        exit_conditions: exitConditions,
        indicators: activeIndicators,
    }];

    const body = {
        name,
        description: SB_TEMPLATE_HINTS[strategyType] || '',
        instruments,
        legs,
        strategy_type: strategyType,
        order_type: orderType,
        risk_config: { ...riskConfig, kill_switches: killSwitches, sessions, active_days: activeDays, market_regimes: regimes, sleep: { enabled: sleepEnabled, from: sleepFrom, to: sleepTo }, cycle: cycleConfig },
        advanced_config: { ...advancedConfig, exchange, stablecoin_base: stablecoinBase, timeframe },
    };

    try {
        const res = await fetch('/api/algo/strategies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            body: JSON.stringify(body),
        });
        if (!res.ok) { const err = await res.json().catch(()=>({})); showToast(err.detail || 'Failed to save', 'error'); return; }
        showToast(`Strategy "${name}" saved!`, 'success');
        document.getElementById('sbStratName').value = '';
        // Switch to My Strategies tab
        document.querySelectorAll('.trader-subtab').forEach(t => t.classList.toggle('active', t.textContent.includes('My Strategies')));
        document.querySelectorAll('.trader-subpage').forEach(p => p.classList.remove('active'));
        document.getElementById('traderSub-strategies')?.classList.add('active');
        sbLoadStrategies();
    } catch(e) { console.error(e); showToast('Failed to save strategy', 'error'); }
}

async function sbDeployStrategy() {
    showToast('Save your strategy first, then deploy from My Strategies', 'info');
}

// ── Load & Manage Strategies ──
async function sbLoadStrategies() {
    if (!currentUser) return;
    try {
        const res = await fetch('/api/algo/strategies', {
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        });
        if (!res.ok) return;
        const strategies = await res.json();
        const container = document.getElementById('sbStrategiesList');
        if (!strategies.length) {
            container.innerHTML = '<div class="empty-state"><p>No strategies yet. Create one in the Strategy Builder.</p></div>';
            return;
        }
        container.innerHTML = strategies.map(s => {
            const legsArr = typeof s.legs === 'string' ? JSON.parse(s.legs || '[]') : (s.legs || []);
            const advConfig = typeof s.advanced_config === 'string' ? JSON.parse(s.advanced_config || '{}') : (s.advanced_config || {});
            return `
            <div class="strat-card">
                <div class="strat-info">
                    <div class="strat-name">${s.name}</div>
                    <div class="strat-meta">
                        ${advConfig.exchange ? advConfig.exchange.toUpperCase() + ' · ' : ''}
                        ${s.instruments || ''} · ${s.strategy_type || 'custom'} · ${advConfig.timeframe || '15m'}
                        ${legsArr[0]?.leverage > 1 ? ' · ' + legsArr[0].leverage + 'x' : ''}
                    </div>
                </div>
                <div class="strat-actions">
                    <span class="strat-status-badge ${s.status === 'active' ? 'active' : 'paused'}">${s.status || 'draft'}</span>
                    <button class="btn btn-sm btn-outline" onclick="sbToggleStrat(${s.id},'${s.status}')">${s.status === 'active' ? '⏸ Pause' : '▶ Activate'}</button>
                    <button class="btn btn-sm btn-danger" onclick="sbDeleteStrat(${s.id})">🗑</button>
                </div>
            </div>`;
        }).join('');
    } catch(e) { console.error(e); }
}

async function sbToggleStrat(id, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'paused' : 'active';
    try {
        await fetch('/api/algo/strategies/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            body: JSON.stringify({ status: newStatus }),
        });
        showToast(`Strategy ${newStatus}`, 'success');
        sbLoadStrategies();
    } catch(e) { showToast('Failed to update', 'error'); }
}

async function sbDeleteStrat(id) {
    if (!confirm('Delete this strategy?')) return;
    try {
        await fetch('/api/algo/strategies/' + id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        });
        showToast('Strategy deleted', 'info');
        sbLoadStrategies();
    } catch(e) { showToast('Failed to delete', 'error'); }
}

// Close dropdowns on outside click
document.addEventListener('click', e => {
    if (!e.target.closest('#sbInstrDD') && !e.target.closest('#sbAddInstrBtn')) {
        const dd = document.getElementById('sbInstrDD');
        if (dd) dd.style.display = 'none';
    }
});

// ── Init ──────────────────────────────────────────────────────
checkAuth();
loadHomeData();

// Keyboard shortcut
document.addEventListener('keydown', e => {
    if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        document.getElementById('globalSearch').focus();
    }
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    }
});

// ══════════════════════════════════════════════════════════════
// PUMPIQ WEB INSIGHT BOT
// ══════════════════════════════════════════════════════════════

const BOT_SUGGESTIONS = [
    "How is the crypto market today?",
    "Analyze Bitcoin right now",
    "What's trending in crypto?",
    "Should I look at Solana?",
    "ETH price analysis",
    "Top gainers today",
];

function toggleBotWindow() {
    const win = document.getElementById('botWindow');
    const isOpen = win.classList.contains('open');
    if (isOpen) {
        win.classList.remove('open');
    } else {
        if (!currentUser) { showAuthModal('login'); return; }
        win.classList.add('open');
        const msgs = document.getElementById('botMessages');
        if (msgs.children.length === 0) {
            appendBotMessage(
                "Hey! 👋 I'm **PumpIQ Bot** — your crypto intelligence assistant.\n\n" +
                "I fetch **live data** from CoinGecko, DexScreener & news to answer your questions. Try asking about any coin, market trends, or trading insights!",
                []
            );
            renderBotSuggestions();
        }
        setTimeout(() => document.getElementById('botInput').focus(), 100);
    }
}

function renderBotSuggestions() {
    const el = document.getElementById('botSuggestions');
    el.innerHTML = BOT_SUGGESTIONS.map(s =>
        `<div class="bot-chip" onclick="askBotFromChip(this)">${s}</div>`
    ).join('');
}

function askBotFromChip(chip) {
    const q = chip.textContent;
    document.getElementById('botInput').value = q;
    document.getElementById('botSuggestions').innerHTML = '';
    sendBotMessage();
}

function appendUserMessage(text) {
    const msgs = document.getElementById('botMessages');
    const div = document.createElement('div');
    div.className = 'bot-msg user';
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
}

function appendBotMessage(text, sources, mode) {
    const msgs = document.getElementById('botMessages');
    const div = document.createElement('div');
    div.className = 'bot-msg bot';

    // ── Rich Markdown → HTML Renderer ──
    let html = '';
    const blocks = text.split('\n');
    let inTable = false;
    let tableRows = [];

    function flushTable() {
        if (!tableRows.length) return '';
        // tableRows[0] = header, tableRows[1] = separator, rest = body
        let t = '<table><thead><tr>';
        const headers = tableRows[0].split('|').map(c => c.trim()).filter(Boolean);
        headers.forEach(h => { t += `<th>${formatInline(h)}</th>`; });
        t += '</tr></thead><tbody>';
        for (let i = 2; i < tableRows.length; i++) {
            const cells = tableRows[i].split('|').map(c => c.trim()).filter(Boolean);
            t += '<tr>';
            cells.forEach(c => { t += `<td>${formatInline(c)}</td>`; });
            t += '</tr>';
        }
        t += '</tbody></table>';
        tableRows = [];
        return t;
    }

    function formatInline(s) {
        return s
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            // Color price changes: 🟢 +X% green, 🔴 -X% red
            .replace(/🟢\s*([+\-]?[\d.]+%)/g, '<span class="price-up">▲ $1</span>')
            .replace(/🔴\s*([+\-]?[\d.]+%)/g, '<span class="price-down">▼ $1</span>');
    }

    for (let i = 0; i < blocks.length; i++) {
        const line = blocks[i];

        // Table row detection
        if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
            if (!inTable) inTable = true;
            tableRows.push(line.trim());
            continue;
        } else if (inTable) {
            html += flushTable();
            inTable = false;
        }

        // Horizontal rule
        if (line.trim() === '---') {
            html += '<hr>';
            continue;
        }

        // H3 headers
        if (line.trim().startsWith('### ')) {
            const hText = line.trim().slice(4);
            html += `<h3>${formatInline(hText)}</h3>`;
            continue;
        }

        // Empty line
        if (!line.trim()) {
            continue;
        }

        // Bullet points
        if (/^[•\-]\s/.test(line.trim())) {
            html += `<div style="padding:2px 0 2px 6px;">${formatInline(line.trim())}</div>`;
            continue;
        }

        // Regular paragraph
        html += `<div style="padding:2px 0;">${formatInline(line)}</div>`;
    }

    // Flush any remaining table
    if (inTable) html += flushTable();

    // Mode badge
    if (mode === 'data') {
        html += '<div style="margin-top:10px;"><span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;background:rgba(245,158,11,0.12);color:#f59e0b;border:1px solid rgba(245,158,11,0.25);letter-spacing:0.3px;">📊 Live Data Mode</span></div>';
    } else if (mode === 'ai') {
        html += '<div style="margin-top:10px;"><span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;background:rgba(124,92,255,0.12);color:#7c5cff;border:1px solid rgba(124,92,255,0.25);letter-spacing:0.3px;">🤖 AI + Live Data</span></div>';
    }

    if (sources && sources.length) {
        html += '<div class="bot-sources">📡 Sources: ' +
            sources.map(s => s.replace(/^[📊📈🔥📰🔗]\s?/, '')).slice(0, 3).join(' · ') +
            '</div>';
    }
    div.innerHTML = html;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
}

function showBotTyping(show) {
    const el = document.getElementById('botTyping');
    el.classList.toggle('show', show);
    if (show) {
        const msgs = document.getElementById('botMessages');
        msgs.scrollTop = msgs.scrollHeight;
    }
}

async function sendBotMessage() {
    const input = document.getElementById('botInput');
    const btn = document.getElementById('botSendBtn');
    const question = input.value.trim();
    if (!question || !currentUser) return;

    input.value = '';
    btn.disabled = true;
    document.getElementById('botSuggestions').innerHTML = '';

    appendUserMessage(question);
    showBotTyping(true);

    try {
        const data = await api('/api/bot/ask', {
            method: 'POST',
            body: JSON.stringify({ question }),
        });
        showBotTyping(false);
        appendBotMessage(data.answer, data.sources || [], data.mode);
    } catch(e) {
        showBotTyping(false);
        appendBotMessage('❌ ' + (e.message || 'Something went wrong. Please try again.'), []);
    } finally {
        btn.disabled = false;
        input.focus();
    }
}

</script>

<!-- PumpIQ Bot Widget -->
<button class="bot-fab has-dot" onclick="toggleBotWindow()" title="PumpIQ Bot">🤖</button>
<div class="bot-window" id="botWindow">
    <div class="bot-header">
        <div class="bot-header-icon">🤖</div>
        <div class="bot-header-info">
            <h3>PumpIQ Bot</h3>
            <p>● Online — Live Web Insights</p>
        </div>
        <button class="bot-close" onclick="toggleBotWindow()">✕</button>
    </div>
    <div class="bot-messages" id="botMessages">
    </div>
    <div class="bot-typing" id="botTyping">
        <span></span><span></span><span></span>
    </div>
    <div class="bot-suggestions" id="botSuggestions"></div>
    <div class="bot-input-area">
        <input type="text" id="botInput" placeholder="Ask about any crypto..." autocomplete="off"
               onkeydown="if(event.key==='Enter')sendBotMessage()">
        <button class="bot-send" id="botSendBtn" onclick="sendBotMessage()">➤</button>
    </div>
</div>

</body>
</html>
