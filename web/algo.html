<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PumpIQ AlgoTrader — Crypto Algorithmic Trading Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ══════════════════════════════════════════════════════════════════
   CSS RESET & VARIABLES
   ══════════════════════════════════════════════════════════════════ */
:root {
    --bg: #f5f7fb;
    --bg-white: #ffffff;
    --bg-sidebar: #ffffff;
    --bg-card: #ffffff;
    --bg-hover: #f0f2f8;
    --border: #e2e8f0;
    --border-light: #edf2f7;
    --text-primary: #1a202c;
    --text-secondary: #4a5568;
    --text-muted: #a0aec0;
    --accent: #4361ee;
    --accent-light: #e8ecff;
    --accent-dark: #3651d4;
    --green: #10b981;
    --green-light: #d1fae5;
    --red: #ef4444;
    --red-light: #fee2e2;
    --yellow: #f59e0b;
    --yellow-light: #fef3c7;
    --purple: #8b5cf6;
    --purple-light: #ede9fe;
    --gradient: linear-gradient(135deg, #4361ee 0%, #7c3aed 100%);
    --gradient-card: linear-gradient(135deg, #4361ee 0%, #06b6d4 100%);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow: 0 4px 14px rgba(0,0,0,0.08);
    --shadow-lg: 0 10px 30px rgba(0,0,0,0.1);
    --radius: 12px;
    --radius-sm: 8px;
    --radius-xs: 6px;
    --sidebar-width: 240px;
    --header-height: 56px;
}

/* Dark theme */
.dark {
    --bg: #0f172a;
    --bg-white: #1e293b;
    --bg-sidebar: #1e293b;
    --bg-card: #1e293b;
    --bg-hover: #334155;
    --border: #334155;
    --border-light: #2d3748;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent-light: rgba(67,97,238,0.15);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
    --shadow: 0 4px 14px rgba(0,0,0,0.3);
    --shadow-lg: 0 10px 30px rgba(0,0,0,0.4);
    --green-light: rgba(16,185,129,0.15);
    --red-light: rgba(239,68,68,0.15);
    --yellow-light: rgba(245,158,11,0.15);
    --purple-light: rgba(139,92,246,0.15);
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    min-height: 100vh;
    display: flex;
}

a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ── Scrollbar ────────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ══════════════════════════════════════════════════════════════════
   SIDEBAR
   ══════════════════════════════════════════════════════════════════ */
.sidebar {
    width: var(--sidebar-width);
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    height: 100vh;
    position: fixed;
    left: 0; top: 0;
    display: flex;
    flex-direction: column;
    z-index: 100;
    transition: transform 0.3s;
}
.sidebar-header {
    padding: 20px 20px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid var(--border);
}
.sidebar-logo {
    width: 36px; height: 36px;
    background: var(--gradient);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-weight: 800; font-size: 16px;
}
.sidebar-brand {
    font-size: 20px; font-weight: 800;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.sidebar-toggle {
    margin-left: auto;
    width: 24px; height: 24px;
    border: none; background: none;
    cursor: pointer; color: var(--text-muted);
    display: flex; align-items: center; justify-content: center;
    border-radius: 6px;
}
.sidebar-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }

.sidebar-nav {
    flex: 1;
    padding: 12px 10px;
    overflow-y: auto;
}
.nav-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 14px; border-radius: var(--radius-sm);
    color: var(--text-secondary); cursor: pointer;
    font-size: 14px; font-weight: 500;
    transition: all 0.15s; margin-bottom: 2px;
    position: relative;
}
.nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.nav-item.active {
    background: var(--accent);
    color: #fff;
    font-weight: 600;
}
.nav-item .nav-icon {
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.nav-item .nav-icon svg { width: 20px; height: 20px; }
.nav-item .nav-arrow {
    margin-left: auto;
    transition: transform 0.2s;
}
.nav-item .nav-arrow.open { transform: rotate(180deg); }

.nav-sub {
    display: none;
    padding-left: 20px;
}
.nav-sub.open { display: block; }
.nav-sub .nav-item {
    font-size: 13px;
    padding: 8px 14px;
    color: var(--accent);
}
.nav-sub .nav-item::before {
    content: '•';
    margin-right: 8px;
    color: var(--accent);
}

.sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
}
.sidebar-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--gradient);
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 14px; font-weight: 700;
    overflow: hidden;
}
.sidebar-avatar img { width: 100%; height: 100%; object-fit: cover; }
.sidebar-user-id { font-size: 11px; color: var(--text-muted); }
.sidebar-user-name { font-size: 13px; font-weight: 600; }

/* ══════════════════════════════════════════════════════════════════
   MAIN CONTENT
   ══════════════════════════════════════════════════════════════════ */
.main {
    margin-left: var(--sidebar-width);
    flex: 1;
    min-height: 100vh;
}

/* ── Top Bar ──────────────────────────────────────────────── */
.topbar {
    height: var(--header-height);
    background: var(--bg-white);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
    justify-content: flex-end;
    padding: 0 24px;
    position: sticky; top: 0;
    z-index: 50;
    gap: 12px;
}
.topbar-badge {
    padding: 4px 10px; border-radius: 6px;
    background: var(--accent); color: #fff;
    font-size: 11px; font-weight: 700;
    letter-spacing: 0.5px;
}
.version-toggle {
    display: flex; align-items: center; gap: 4px;
    font-size: 12px; font-weight: 600;
}
.version-toggle span { color: var(--text-muted); }
.version-toggle .active-v { color: var(--accent); }
.vtoggle {
    width: 36px; height: 20px;
    background: var(--accent);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
}
.vtoggle::after {
    content: '';
    position: absolute;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: #fff;
    top: 2px; left: 18px;
    transition: left 0.2s;
}
.topbar-icon-btn {
    width: 36px; height: 36px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-white);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
}
.topbar-icon-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
.topbar-icon-btn svg { width: 18px; height: 18px; }

/* ══════════════════════════════════════════════════════════════════
   PAGES / SECTIONS
   ══════════════════════════════════════════════════════════════════ */
.page { display: none; padding: 24px; }
.page.active { display: block; }

/* ── Section Heading ──────────────────────────────────────── */
.section-heading {
    font-size: 22px; font-weight: 700;
    margin-bottom: 20px;
}
.section-subheading {
    font-size: 14px; color: var(--text-secondary);
    margin-top: -14px; margin-bottom: 20px;
}

/* ══════════════════════════════════════════════════════════════════
   BUTTONS
   ══════════════════════════════════════════════════════════════════ */
.btn {
    padding: 10px 20px; border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 600; cursor: pointer;
    border: none; transition: all 0.15s;
    display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-dark); }
.btn-outline {
    background: transparent; color: var(--accent);
    border: 1.5px solid var(--accent);
}
.btn-outline:hover { background: var(--accent-light); }
.btn-green { background: var(--green); color: #fff; }
.btn-green:hover { opacity: 0.9; }
.btn-red { background: var(--red); color: #fff; }
.btn-red:hover { opacity: 0.9; }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-lg { padding: 12px 28px; font-size: 15px; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-ghost {
    background: none; border: none; color: var(--text-secondary);
    padding: 8px 12px; cursor: pointer;
}
.btn-ghost:hover { color: var(--text-primary); background: var(--bg-hover); border-radius: var(--radius-sm); }

/* ══════════════════════════════════════════════════════════════════
   CARDS
   ══════════════════════════════════════════════════════════════════ */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow-sm);
}
.card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px;
}
.card-title { font-size: 16px; font-weight: 700; }
.card-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }

/* ══════════════════════════════════════════════════════════════════
   FORM ELEMENTS
   ══════════════════════════════════════════════════════════════════ */
.form-group { margin-bottom: 16px; }
.form-label {
    display: block; font-size: 13px; font-weight: 600;
    color: var(--text-secondary); margin-bottom: 6px;
}
.form-input, .form-select {
    width: 100%; padding: 10px 14px;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border);
    background: var(--bg-white);
    color: var(--text-primary);
    font-size: 14px; font-family: inherit;
    outline: none; transition: border 0.15s;
}
.form-input:focus, .form-select:focus { border-color: var(--accent); }
.form-select { cursor: pointer; appearance: auto; }

/* Checkbox / Radio */
.checkbox-group, .radio-group {
    display: flex; flex-direction: column; gap: 10px;
}
.check-item, .radio-item {
    display: flex; align-items: center; gap: 8px;
    font-size: 14px; cursor: pointer;
}
.check-item input, .radio-item input {
    width: 18px; height: 18px;
    accent-color: var(--accent);
    cursor: pointer;
}

/* Pill Selectors */
.pill-group {
    display: flex; gap: 6px; flex-wrap: wrap;
}
.pill {
    padding: 6px 16px; border-radius: 20px;
    font-size: 13px; font-weight: 500;
    border: 1.5px solid var(--border);
    background: var(--bg-white);
    color: var(--text-secondary);
    cursor: pointer; transition: all 0.15s;
}
.pill:hover { border-color: var(--accent); color: var(--accent); }
.pill.active {
    background: var(--accent); color: #fff;
    border-color: var(--accent);
}

/* Number Input with +/- */
.num-input {
    display: flex; align-items: center; gap: 0;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}
.num-input button {
    width: 36px; height: 38px;
    border: none; background: var(--bg);
    color: var(--text-secondary); font-size: 18px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.num-input button:hover { background: var(--border); }
.num-input input {
    width: 60px; height: 38px;
    border: none; background: var(--bg-white);
    color: var(--text-primary); text-align: center;
    font-size: 14px; font-family: inherit; outline: none;
}

/* Tab Selector */
.tab-pair {
    display: flex; border-radius: var(--radius-sm);
    overflow: hidden; border: 1.5px solid var(--border);
}
.tab-pair .tab-opt {
    flex: 1; padding: 8px 16px;
    text-align: center; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
    color: var(--text-secondary);
    background: var(--bg-white);
    border: none;
}
.tab-pair .tab-opt:not(:last-child) { border-right: 1.5px solid var(--border); }
.tab-pair .tab-opt.active { background: var(--accent); color: #fff; }
.tab-pair .tab-opt.active-green { background: var(--green); color: #fff; }
.tab-pair .tab-opt.active-red { background: var(--red); color: #fff; }

/* Time input */
.time-input {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-white);
    font-size: 14px;
}
.time-input input {
    border: none; background: none;
    color: var(--text-primary);
    font-size: 14px; font-family: inherit;
    outline: none; width: 50px;
}

/* Toggle Switch */
.toggle-switch {
    position: relative; width: 44px; height: 24px; cursor: pointer;
}
.toggle-switch input { display: none; }
.toggle-slider {
    position: absolute; inset: 0;
    background: var(--border);
    border-radius: 12px;
    transition: background 0.2s;
}
.toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px; height: 18px;
    left: 3px; top: 3px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.toggle-switch input:checked + .toggle-slider {
    background: var(--accent);
}
.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
}

/* ══════════════════════════════════════════════════════════════════
   DASHBOARD PAGE
   ══════════════════════════════════════════════════════════════════ */
.dash-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
}
.dash-connect {
    background: var(--gradient-card);
    border-radius: var(--radius);
    padding: 28px;
    color: #fff;
    position: relative; overflow: hidden;
}
.dash-connect::after {
    content: '';
    position: absolute; top: -60px; right: -60px;
    width: 200px; height: 200px;
    border-radius: 50%;
    background: rgba(255,255,255,0.06);
}
.dash-connect h3 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
.dash-connect p { font-size: 14px; opacity: 0.85; margin-bottom: 16px; }
.dash-connect .btn {
    background: #fff; color: var(--accent);
    font-weight: 700;
}
.dash-connect .user-tag {
    margin-top: 16px; font-size: 14px; font-weight: 600;
}
.dash-deploy {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center; gap: 12px;
}
.dash-deploy .deploy-icon {
    width: 64px; height: 64px;
    background: var(--bg); border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 4px;
}
.dash-deploy .deploy-icon svg { width: 32px; height: 32px; color: var(--text-muted); }
.dash-deploy h4 { font-size: 16px; font-weight: 700; }
.dash-deploy p { font-size: 13px; color: var(--text-secondary); }

.deploy-stats-row {
    display: flex;
    gap: 20px;
    margin-bottom: 12px;
}
.deploy-stat { text-align: center; }
.deploy-stat-num { font-size: 28px; font-weight: 800; }
.deploy-stat-lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

.dash-header-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px;
}
.dash-header-row h3 { font-size: 18px; font-weight: 700; }
.dash-header-row .pager {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; color: var(--text-muted);
}
.dash-header-row .pager button {
    width: 28px; height: 28px;
    border: 1px solid var(--border); border-radius: 6px;
    background: var(--bg-white); cursor: pointer;
    color: var(--text-secondary);
    display: flex; align-items: center; justify-content: center;
}
.see-all { color: var(--accent); font-size: 13px; font-weight: 600; cursor: pointer; }

.template-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 32px;
}
.template-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    background: var(--bg-card);
}
.template-card h4 { font-size: 14px; font-weight: 600; margin-bottom: 14px; }
.template-card .btn { width: 100%; justify-content: center; }

.dash-bottom {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}
.join-section h3, .support-section h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
.join-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid var(--border-light);
}
.join-item:last-child { border-bottom: none; }
.join-left { display: flex; align-items: center; gap: 12px; }
.join-icon {
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 18px;
}
.join-icon.telegram { background: #229ED9; }
.join-icon.youtube { background: #FF0000; }
.join-icon.instagram { background: linear-gradient(135deg, #833AB4, #FD1D1D, #F77737); }
.join-icon.discord { background: #5865F2; }
.join-icon.twitter { background: #1DA1F2; }

.support-card {
    background: var(--gradient);
    border-radius: var(--radius);
    padding: 24px; color: #fff;
}
.support-card h4 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.support-card p { font-size: 13px; opacity: 0.85; margin-bottom: 16px; }
.support-card .support-btns { display: flex; gap: 10px; }
.support-card .btn { background: rgba(255,255,255,0.2); color: #fff; }
.support-card .btn:hover { background: rgba(255,255,255,0.3); }

/* ══════════════════════════════════════════════════════════════════
   EXCHANGE PAGE
   ══════════════════════════════════════════════════════════════════ */
.exchange-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px;
}
.exchange-empty {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 80px 20px; text-align: center;
}
.exchange-empty .empty-icon {
    width: 100px; height: 100px;
    background: var(--bg);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 16px;
}
.exchange-empty .empty-icon svg { width: 48px; height: 48px; color: var(--text-muted); }
.exchange-empty p { color: var(--text-secondary); font-size: 14px; }

.exchange-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
}
.exchange-card {
    border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; background: var(--bg-card);
    display: flex; align-items: center; gap: 16px;
}
.exchange-logo {
    width: 48px; height: 48px; border-radius: 12px;
    background: var(--bg); display: flex; align-items: center; justify-content: center;
    font-size: 20px; font-weight: 700; flex-shrink: 0;
}
.exchange-info h4 { font-size: 14px; font-weight: 600; }
.exchange-info p { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.exchange-status {
    margin-left: auto;
    padding: 4px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
}
.exchange-status.connected { background: var(--green-light); color: var(--green); }
.exchange-status.disconnected { background: var(--red-light); color: var(--red); }

/* Portfolio Summary */
.portfolio-summary-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 24px; margin-top: 24px;
}
.portfolio-summary-card h4 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
.portfolio-stats {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 16px;
}
.pstat {
    text-align: center; padding: 16px;
    background: var(--bg); border-radius: var(--radius-sm);
}
.pstat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
.pstat-value { font-size: 20px; font-weight: 700; }

/* ══════════════════════════════════════════════════════════════════
   STRATEGY BUILDER PAGE
   ══════════════════════════════════════════════════════════════════ */
.builder-top-row {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 20px;
    margin-bottom: 20px;
}
.builder-mid-row {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 20px;
    margin-bottom: 20px;
}
.builder-bot-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
.builder-actions {
    display: flex; gap: 12px; justify-content: flex-end;
}

/* Instrument chips */
.instrument-chips {
    display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;
    min-height: 80px; padding: 12px;
    border: 1.5px dashed var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    align-items: flex-start; align-content: flex-start;
}
.instrument-chip {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 12px 5px 10px;
    background: var(--accent-light); color: var(--accent);
    border-radius: 20px; font-size: 12px; font-weight: 600;
}
.instrument-chip .chip-remove {
    width: 16px; height: 16px; border-radius: 50%;
    border: none; background: rgba(67,97,238,0.2);
    color: var(--accent); font-size: 11px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    line-height: 1;
}
.instrument-chip .chip-remove:hover { background: var(--accent); color: #fff; }
.instrument-add-btn {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 5px 14px; border-radius: 20px;
    border: 1.5px dashed var(--border);
    background: var(--bg-white); color: var(--text-muted);
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: all 0.15s;
}
.instrument-add-btn:hover { border-color: var(--accent); color: var(--accent); }

/* Instrument dropdown */
.instrument-dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--bg-white); border: 1.5px solid var(--border);
    border-radius: var(--radius-sm); box-shadow: var(--shadow-lg);
    max-height: 220px; overflow-y: auto; z-index: 50;
    display: none;
}
.instrument-dropdown.open { display: block; }
.instrument-dropdown-item {
    padding: 10px 14px; font-size: 13px;
    cursor: pointer; transition: background 0.1s;
    display: flex; justify-content: space-between;
}
.instrument-dropdown-item:hover { background: var(--bg-hover); }
.instrument-dropdown-item.selected { background: var(--accent-light); color: var(--accent); font-weight: 600; }
.instrument-dropdown-search {
    padding: 10px 14px; border: none; border-bottom: 1px solid var(--border);
    width: 100%; font-size: 13px; font-family: inherit;
    background: var(--bg-white); color: var(--text-primary); outline: none;
}

.leg-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
}
.leg-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px; padding-bottom: 12px;
    border-bottom: 1px solid var(--border-light);
}
.leg-title { font-size: 15px; font-weight: 700; }
.leg-title span { font-size: 13px; margin-left: 8px; }
.leg-title .buy-tag { color: var(--green); }
.leg-title .sell-tag { color: var(--red); }
.leg-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.leg-badge {
    padding: 4px 12px; border-radius: 12px;
    font-size: 11px; font-weight: 700;
    background: var(--green-light); color: var(--green);
    letter-spacing: 0.5px;
}

.leg-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 14px;
}
.leg-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
}
.leg-grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
}

.leg-field label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--text-muted); margin-bottom: 6px;
    text-transform: uppercase; letter-spacing: 0.3px;
}

.leg-section-divider {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px;
    margin: 16px 0 8px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border-light);
}

.leg-actions {
    display: flex; justify-content: flex-end; gap: 8px;
    margin-top: 16px; padding-top: 12px;
    border-top: 1px solid var(--border-light);
}
.leg-actions button {
    width: 34px; height: 34px;
    border: 1px solid var(--border); border-radius: 8px;
    background: var(--bg-white); cursor: pointer;
    color: var(--text-muted); display: flex; align-items: center; justify-content: center;
    font-size: 16px; transition: all 0.15s;
}
.leg-actions button:hover { color: var(--text-primary); background: var(--bg-hover); }
.leg-actions button.delete { color: var(--red); }
.leg-actions button.delete:hover { background: var(--red-light); }

/* Risk Management */
.risk-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
}
.risk-input {
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    color: var(--text-primary);
    font-size: 14px; font-family: inherit;
    width: 100%; outline: none;
    transition: border 0.15s;
}
.risk-input:focus { border-color: var(--accent); }
.risk-input::placeholder { color: var(--text-muted); }

/* Advanced Features */
.adv-grid {
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
}
.adv-item {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; color: var(--text-secondary);
    padding: 6px 0;
}
.adv-item input { accent-color: var(--accent); width: 16px; height: 16px; }

/* Day Selector */
.day-selector { display: flex; gap: 6px; flex-wrap: wrap; }
.day-pill {
    padding: 6px 14px; border-radius: 20px;
    font-size: 12px; font-weight: 600;
    border: 1.5px solid var(--accent);
    background: var(--accent-light);
    color: var(--accent);
    cursor: pointer; transition: all 0.15s;
    user-select: none;
}
.day-pill.active { background: var(--accent); color: #fff; }
.day-pill:hover { background: var(--accent); color: #fff; }

/* Order type radio pills */
.order-type-pills {
    display: flex; gap: 0;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}
.order-type-pill {
    flex: 1; padding: 10px 0; text-align: center;
    font-size: 13px; font-weight: 600;
    cursor: pointer; background: var(--bg-white);
    color: var(--text-secondary); border: none;
    transition: all 0.15s;
}
.order-type-pill:not(:last-child) { border-right: 1.5px solid var(--border); }
.order-type-pill input { display: none; }
.order-type-pill.active { background: var(--accent); color: #fff; }

/* Time inputs row */
.time-row {
    display: flex; gap: 16px; margin-top: 16px;
    align-items: flex-end;
}
.time-row > div { flex: 1; }

/* ══════════════════════════════════════════════════════════════════
   STRATEGIES PAGE
   ══════════════════════════════════════════════════════════════════ */
.strat-tabs {
    display: flex; gap: 0; border-bottom: 2px solid var(--border);
    margin-bottom: 20px;
}
.strat-tab {
    padding: 12px 20px; font-size: 14px; font-weight: 600;
    color: var(--text-muted); cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px; transition: all 0.15s;
}
.strat-tab:hover { color: var(--text-primary); }
.strat-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.strat-topbar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px;
}
.strat-search {
    padding: 10px 16px; border-radius: var(--radius-sm);
    border: 1.5px solid var(--border); background: var(--bg-white);
    color: var(--text-primary); font-size: 13px; width: 300px;
    outline: none; font-family: inherit;
}
.strat-search:focus { border-color: var(--accent); }

.strat-type-toggle {
    display: flex; border-radius: var(--radius-sm);
    overflow: hidden; border: 1.5px solid var(--border);
}
.strat-type-btn {
    padding: 8px 18px; font-size: 13px; font-weight: 600;
    cursor: pointer; border: none;
    background: var(--bg-white); color: var(--text-secondary);
    transition: all 0.15s;
}
.strat-type-btn.active { background: var(--accent); color: #fff; }

.strat-empty {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 80px 20px; text-align: center;
}
.strat-empty .empty-folder {
    width: 120px; height: 120px;
    background: var(--bg);
    border-radius: 24px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 20px; position: relative;
}
.strat-empty .empty-folder svg { width: 48px; height: 48px; color: var(--text-muted); }
.strat-empty .empty-folder::after {
    content: '+'; position: absolute;
    bottom: 10px; right: 10px;
    width: 28px; height: 28px;
    border-radius: 50%; background: var(--border);
    color: var(--text-muted); font-size: 18px;
    display: flex; align-items: center; justify-content: center;
}

/* Strategy Card */
.strat-list { display: flex; flex-direction: column; gap: 12px; }
.strat-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    display: flex; justify-content: space-between; align-items: center;
    transition: all 0.15s;
}
.strat-card:hover { border-color: var(--accent); box-shadow: var(--shadow); }
.strat-card-info h4 { font-size: 14px; font-weight: 600; }
.strat-card-info p { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.strat-card-meta { display: flex; align-items: center; gap: 12px; }
.strat-card-meta .strat-status {
    padding: 4px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
}
.strat-status.running { background: var(--green-light); color: var(--green); }
.strat-status.paused { background: var(--yellow-light); color: var(--yellow); }
.strat-status.stopped { background: var(--red-light); color: var(--red); }

/* ══════════════════════════════════════════════════════════════════
   BACKTESTING PAGE
   ══════════════════════════════════════════════════════════════════ */
.bt-header {
    margin-bottom: 24px;
}
.bt-header h2 { font-size: 20px; font-weight: 700; }
.bt-header p { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

.bt-controls {
    display: flex; align-items: center; gap: 16px;
    margin-bottom: 20px; flex-wrap: wrap;
}
.bt-select {
    min-width: 280px; padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-white);
    color: var(--text-primary); font-size: 14px;
    font-family: inherit; cursor: pointer; outline: none;
}
.bt-select:focus { border-color: var(--accent); }

.bt-range { display: flex; gap: 6px; flex: 1; justify-content: flex-end; }
.bt-range .pill { font-size: 12px; }

.bt-credit {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 20px;
}
.bt-credit span { font-size: 14px; font-weight: 600; }
.bt-credit strong { color: var(--accent); }

.bt-empty {
    text-align: center; padding: 60px 20px;
    color: var(--accent); font-size: 14px;
}

/* Backtest Results */
.bt-results {
    display: none;
}
.bt-results.active { display: block; }
.bt-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 20px;
}
.bt-stat {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px; text-align: center;
}
.bt-stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
.bt-stat-value { font-size: 22px; font-weight: 700; }
.bt-stat-value.positive { color: var(--green); }
.bt-stat-value.negative { color: var(--red); }

.bt-chart-placeholder {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    height: 300px;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); font-size: 14px;
}

/* ══════════════════════════════════════════════════════════════════
   REPORTS PAGE
   ══════════════════════════════════════════════════════════════════ */
.report-tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--border);
    margin-bottom: 20px;
}
.report-tab {
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
}
.report-tab:hover { color: var(--text-primary); }
.report-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.report-tab-content { display: none; }
.report-tab-content.active { display: block; }

.report-filters-row {
    display: flex;
    gap: 16px;
    align-items: flex-end;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.report-filter-group { display: flex; flex-direction: column; gap: 4px; }
.report-filter-group .form-label { margin-bottom: 0; }

.report-mode-toggle {
    display: flex;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1.5px solid var(--border);
}
.mode-btn {
    padding: 9px 18px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: var(--bg-white);
    color: var(--text-secondary);
    transition: all 0.15s;
}
.mode-btn.active { background: var(--accent); color: #fff; }
.mode-btn:not(:last-child) { border-right: 1.5px solid var(--border); }

.report-stats-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}
.report-stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    text-align: center;
}
.report-stat-card.green { border-left: 3px solid var(--green); }
.report-stat-card.red { border-left: 3px solid var(--red); }
.report-stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px; }
.report-stat-value { font-size: 20px; font-weight: 700; }
.report-stat-value.accent { color: var(--accent); }

.report-chart-row {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 20px;
    margin-bottom: 0;
}
.report-donut-card { min-height: 300px; }
.donut-container {
    display: flex;
    align-items: center;
    gap: 24px;
    margin-top: 16px;
    justify-content: center;
}
.donut-legend { display: flex; flex-direction: column; gap: 10px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
.legend-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }

.report-pnl-card { min-height: 300px; }
.pnl-chart-area { margin-top: 16px; height: 220px; position: relative; }

/* Engine Logs */
.engine-log-container {
    max-height: 500px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 12px;
}
.engine-log-entry {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-light);
    transition: background 0.1s;
}
.engine-log-entry:hover { background: var(--bg-hover); }
.log-time { color: var(--text-muted); white-space: nowrap; min-width: 80px; }
.log-severity {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    min-width: 50px;
    text-align: center;
}
.log-severity.info { background: var(--accent-light); color: var(--accent); }
.log-severity.warn { background: var(--yellow-light); color: var(--yellow); }
.log-severity.error { background: var(--red-light); color: var(--red); }
.log-severity.trade { background: var(--green-light); color: var(--green); }
.log-message { color: var(--text-primary); word-break: break-word; }

.report-filters {
    display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
}
.report-table {
    width: 100%; border-collapse: collapse;
    background: var(--bg-card);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
}
.report-table th {
    text-align: left; padding: 12px 16px;
    font-size: 12px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
}
.report-table td {
    padding: 14px 16px; font-size: 13px;
    border-bottom: 1px solid var(--border-light);
}
.report-table tr:hover { background: var(--bg-hover); }
.report-table tr:last-child td { border-bottom: none; }

/* ══════════════════════════════════════════════════════════════════
   SUBSCRIPTION PAGE
   ══════════════════════════════════════════════════════════════════ */
.pricing-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    max-width: 900px;
    margin: 0 auto;
}
.pricing-card {
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    text-align: center;
    transition: all 0.2s;
    position: relative;
}
.pricing-card:hover { border-color: var(--accent); box-shadow: var(--shadow-lg); }
.pricing-card.popular { border-color: var(--accent); }
.pricing-card.popular::before {
    content: 'MOST POPULAR';
    position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: #fff;
    padding: 4px 16px; border-radius: 12px;
    font-size: 10px; font-weight: 700; letter-spacing: 1px;
}
.pricing-name { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.pricing-price { font-size: 36px; font-weight: 800; margin-bottom: 4px; }
.pricing-price span { font-size: 14px; font-weight: 500; color: var(--text-muted); }
.pricing-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; }
.pricing-features {
    list-style: none; text-align: left;
    margin-bottom: 24px;
}
.pricing-features li {
    padding: 8px 0; font-size: 13px;
    color: var(--text-secondary);
    display: flex; align-items: center; gap: 8px;
}
.pricing-features li::before {
    content: '✓'; color: var(--green);
    font-weight: 700; font-size: 14px;
}
.pricing-card .btn { width: 100%; justify-content: center; }

/* Pricing Limits Table */
.pricing-limits {
    border-top: 1px solid var(--border);
    margin: 16px 0;
    padding-top: 12px;
}
.pricing-limit-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 13px;
}
.pricing-limit-row span { color: var(--text-secondary); }
.pricing-limit-row strong { color: var(--accent); }

/* Billing Toggle */
.billing-toggle {
    display: inline-flex;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1.5px solid var(--border);
    background: var(--bg-white);
}
.billing-btn {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    transition: all 0.15s;
    position: relative;
}
.billing-btn.active { background: var(--accent); color: #fff; }
.billing-btn:not(:last-child) { border-right: 1.5px solid var(--border); }
.save-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 8px;
    font-size: 9px;
    background: var(--green);
    color: #fff;
    font-weight: 700;
    margin-left: 4px;
    vertical-align: middle;
}
.billing-btn.active .save-badge { background: rgba(255,255,255,0.3); }

/* FAQ Section */
.faq-list { display: flex; flex-direction: column; gap: 8px; }
.faq-item {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}
.faq-question {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
}
.faq-question:hover { background: var(--bg-hover); }
.faq-arrow {
    font-size: 12px;
    color: var(--text-muted);
    transition: transform 0.2s;
}
.faq-item.open .faq-arrow { transform: rotate(180deg); }
.faq-answer {
    display: none;
    padding: 0 20px 16px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
}
.faq-item.open .faq-answer { display: block; }

/* ══════════════════════════════════════════════════════════════════
   MODALS
   ══════════════════════════════════════════════════════════════════ */
.modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    z-index: 200;
    justify-content: center;
    align-items: center;
    padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
    background: var(--bg-white);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 100%; max-width: 520px;
    padding: 28px;
    box-shadow: var(--shadow-lg);
    position: relative;
}
.modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
.modal-close {
    position: absolute; top: 16px; right: 16px;
    width: 32px; height: 32px;
    border: none; background: var(--bg);
    border-radius: 8px; cursor: pointer;
    color: var(--text-muted); font-size: 18px;
    display: flex; align-items: center; justify-content: center;
}
.modal-close:hover { background: var(--border); color: var(--text-primary); }

/* Exchange Logos */
.exchange-options {
    display: grid; grid-template-columns: repeat(2, 1fr);
    gap: 12px; margin-bottom: 20px;
}
.exchange-option {
    display: flex; align-items: center; gap: 12px;
    padding: 14px; border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer; transition: all 0.15s;
}
.exchange-option:hover { border-color: var(--accent); background: var(--accent-light); }
.exchange-option.selected { border-color: var(--accent); background: var(--accent-light); }
.exchange-option .exo-icon {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; font-weight: 700;
}
.exchange-option .exo-name { font-size: 14px; font-weight: 600; }

/* ══════════════════════════════════════════════════════════════════
   RESPONSIVE
   ══════════════════════════════════════════════════════════════════ */
@media (max-width: 1024px) {
    .builder-layout { grid-template-columns: 1fr; }
    .dash-grid { grid-template-columns: 1fr; }
    .template-grid { grid-template-columns: repeat(2, 1fr); }
    .pricing-grid { grid-template-columns: 1fr; max-width: 400px; }
    .bt-stats { grid-template-columns: repeat(2, 1fr); }
    .portfolio-stats { grid-template-columns: repeat(2, 1fr); }
    .report-stats-grid { grid-template-columns: repeat(3, 1fr); }
    .report-chart-row { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main { margin-left: 0; }
    .template-grid { grid-template-columns: 1fr; }
    .dash-bottom { grid-template-columns: 1fr; }
    .leg-grid { grid-template-columns: 1fr; }
    .leg-grid-4 { grid-template-columns: 1fr 1fr; }
    .adv-grid { grid-template-columns: 1fr 1fr; }
    .risk-grid { grid-template-columns: 1fr; }
    .report-stats-grid { grid-template-columns: repeat(2, 1fr); }
    .report-filters-row { flex-direction: column; align-items: stretch; }
    .report-filter-group .form-input,
    .report-filter-group .form-select { width: 100% !important; }
    .billing-toggle { flex-direction: column; }
}

/* ══════════════════════════════════════════════════════════════════
   TOAST
   ══════════════════════════════════════════════════════════════════ */
.toast-container {
    position: fixed; top: 16px; right: 16px;
    z-index: 1000;
    display: flex; flex-direction: column; gap: 8px;
}
.toast {
    padding: 12px 20px; border-radius: 10px;
    font-size: 13px; color: #fff;
    box-shadow: var(--shadow);
    animation: toastSlide 0.3s ease;
}
.toast.success { background: var(--green); }
.toast.error { background: var(--red); }
.toast.info { background: var(--accent); }
@keyframes toastSlide {
    from { opacity: 0; transform: translateX(40px); }
    to { opacity: 1; transform: translateX(0); }
}

/* ══════════════════════════════════════════════════════════════════
   SIMULATOR
   ══════════════════════════════════════════════════════════════════ */
.sim-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.sim-chart {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    height: 400px;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted);
}
.sim-controls { display: flex; flex-direction: column; gap: 16px; }
.sim-order-book {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
}
</style>
</head>
<body>

<!-- ══════════════════ SIDEBAR ══════════════════ -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">P</div>
        <span class="sidebar-brand">PumpIQ</span>
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </button>
    </div>

    <nav class="sidebar-nav">
        <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
            <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span>
            Dashboard
        </div>
        <div class="nav-item" data-page="exchange" onclick="showPage('exchange')">
            <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg></span>
            Exchange
        </div>
        <div class="nav-item" data-page="builder" onclick="showPage('builder')">
            <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>
            Strategy Builder
        </div>
        <div class="nav-item" data-page="strategies" onclick="showPage('strategies')">
            <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg></span>
            Strategies
        </div>
        <div class="nav-item" data-page="backtesting" onclick="toggleBacktest()">
            <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>
            Backtesting
            <span class="nav-arrow" id="btArrow">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </span>
        </div>
        <div class="nav-sub" id="btSub">
            <div class="nav-item" data-page="backtest" onclick="showPage('backtest')">Strategy Backtest</div>
            <div class="nav-item" data-page="simulator" onclick="showPage('simulator')">Simulator</div>
        </div>
        <div class="nav-item" data-page="reports" onclick="showPage('reports')">
            <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></span>
            Reports
        </div>
        <div class="nav-item" data-page="subscription" onclick="showPage('subscription')">
            <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/><path d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/></svg></span>
            Subscription
        </div>
    </nav>

    <div class="sidebar-footer">
        <div class="sidebar-avatar" id="sidebarAvatar">CB</div>
        <div>
            <div class="sidebar-user-id" id="sidebarUserId">PQ-001</div>
            <div class="sidebar-user-name" id="sidebarUserName">Crypto Trader</div>
        </div>
    </div>
</aside>

<!-- ══════════════════ MAIN CONTENT ══════════════════ -->
<div class="main">
    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-badge">BETA</div>
        <div class="version-toggle">
            <span>V1</span>
            <div class="vtoggle"></div>
            <span class="active-v">V2</span>
        </div>
        <button class="topbar-icon-btn" title="Notifications">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        </button>
        <button class="topbar-icon-btn" id="themeToggle" title="Toggle theme" onclick="toggleTheme()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        </button>
    </div>

    <!-- ════════════ DASHBOARD PAGE ════════════ -->
    <div class="page active" id="page-dashboard">
        <div class="section-heading">My Dashboard</div>

        <div class="dash-grid">
            <div class="dash-connect">
                <h3>Connect to your exchange</h3>
                <p>Deploy, Manage & Track Your Crypto Strategies, All From One Exchange Account.</p>
                <button class="btn" onclick="openModal('exchangeModal')">+ Add Exchange</button>
                <div class="user-tag" id="dashUserTag">Crypto Trader</div>
            </div>
            <div class="card dash-deploy">
                <h4 style="font-size:18px;">Strategy Deployed</h4>
                <div style="font-size:13px; color:var(--text-muted); margin-bottom:8px;">
                    <select class="form-select" style="width:auto;display:inline;padding:4px 10px;font-size:12px;border-radius:6px;" id="dashExchangeSelect">
                        <option>No exchange selected</option>
                    </select>
                </div>
                <div class="deploy-stats-row" id="deployStatsRow">
                    <div class="deploy-stat">
                        <div class="deploy-stat-num" id="deployedCount">0</div>
                        <div class="deploy-stat-lbl">Deployed</div>
                    </div>
                    <div class="deploy-stat">
                        <div class="deploy-stat-num" style="color:var(--green);" id="runningCount">0</div>
                        <div class="deploy-stat-lbl">Running</div>
                    </div>
                    <div class="deploy-stat">
                        <div class="deploy-stat-num" style="color:var(--red);" id="stoppedCount">0</div>
                        <div class="deploy-stat-lbl">Stopped</div>
                    </div>
                </div>
                <div class="deploy-icon" id="deployEmptyIcon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                </div>
                <h4 id="deployEmptyTitle">No Strategies Deployed</h4>
                <p id="deployEmptyDesc">You haven't deployed any trading strategies yet.</p>
                <button class="btn btn-primary" onclick="showPage('builder')">Create Strategy</button>
            </div>
        </div>

        <div class="dash-header-row">
            <h3>Strategy Templates</h3>
            <div style="display:flex;align-items:center;gap:16px;">
                <div class="pager">
                    <button>‹</button>
                    <span>1</span>
                    <button>›</button>
                </div>
                <span class="see-all">See All</span>
            </div>
        </div>
        <div class="template-grid">
            <div class="template-card">
                <h4>BTC Moving Average Crossover</h4>
                <button class="btn btn-primary" onclick="addTemplate('BTC Moving Average Crossover')">Add to my strategy</button>
            </div>
            <div class="template-card">
                <h4>ETH RSI Swing Trading</h4>
                <button class="btn btn-primary" onclick="addTemplate('ETH RSI Swing Trading')">Add to my strategy</button>
            </div>
            <div class="template-card">
                <h4>SOL Momentum Scalper</h4>
                <button class="btn btn-primary" onclick="addTemplate('SOL Momentum Scalper')">Add to my strategy</button>
            </div>
            <div class="template-card">
                <h4>DCA Bitcoin Weekly</h4>
                <button class="btn btn-primary" onclick="addTemplate('DCA Bitcoin Weekly')">Add to my strategy</button>
            </div>
            <div class="template-card">
                <h4>Altcoin Breakout Hunter</h4>
                <button class="btn btn-primary" onclick="addTemplate('Altcoin Breakout Hunter')">Add to my strategy</button>
            </div>
            <div class="template-card">
                <h4>Grid Trading BTC/USDT</h4>
                <button class="btn btn-primary" onclick="addTemplate('Grid Trading BTC/USDT')">Add to my strategy</button>
            </div>
        </div>

        <div class="dash-bottom">
            <div class="join-section">
                <h3>Join Us</h3>
                <div class="join-item">
                    <div class="join-left">
                        <div class="join-icon telegram">✈</div>
                        <span>Telegram Channel</span>
                    </div>
                    <button class="btn btn-primary btn-sm">Join</button>
                </div>
                <div class="join-item">
                    <div class="join-left">
                        <div class="join-icon youtube">▶</div>
                        <span>Youtube Channel</span>
                    </div>
                    <button class="btn btn-primary btn-sm">Join</button>
                </div>
                <div class="join-item">
                    <div class="join-left">
                        <div class="join-icon discord">🎮</div>
                        <span>Discord Server</span>
                    </div>
                    <button class="btn btn-primary btn-sm">Join</button>
                </div>
                <div class="join-item">
                    <div class="join-left">
                        <div class="join-icon twitter">𝕏</div>
                        <span>Twitter / X</span>
                    </div>
                    <button class="btn btn-primary btn-sm">Join</button>
                </div>
            </div>
            <div class="support-section">
                <h3>Support</h3>
                <div class="support-card">
                    <h4>Need Help? We're Here for You!</h4>
                    <p>Have questions or facing issues? Our support team is ready to assist you with any queries or concerns.</p>
                    <div class="support-btns">
                        <button class="btn">💬 Telegram</button>
                        <button class="btn">📧 Email Us</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ════════════ EXCHANGE PAGE ════════════ -->
    <div class="page" id="page-exchange">
        <div class="exchange-header">
            <div class="section-heading" style="margin-bottom:0;">Connected Exchanges</div>
            <button class="btn btn-primary" onclick="openModal('exchangeModal')">+ Add Exchange</button>
        </div>

        <div id="exchangeList">
            <!-- Populated by JS -->
        </div>

        <div class="exchange-empty" id="exchangeEmpty">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/><circle cx="17" cy="15" r="1"/></svg>
            </div>
            <p>No Portfolio summary. Connect an Exchange!</p>
        </div>

        <div class="portfolio-summary-card" id="portfolioSummary" style="display:none;">
            <h4>Portfolio Summary</h4>
            <div class="portfolio-stats">
                <div class="pstat">
                    <div class="pstat-label">Total Value</div>
                    <div class="pstat-value" id="psTotalValue">$0.00</div>
                </div>
                <div class="pstat">
                    <div class="pstat-label">24h P&L</div>
                    <div class="pstat-value" id="psPnl" style="color:var(--green);">+$0.00</div>
                </div>
                <div class="pstat">
                    <div class="pstat-label">Open Positions</div>
                    <div class="pstat-value" id="psPositions">0</div>
                </div>
                <div class="pstat">
                    <div class="pstat-label">Available Balance</div>
                    <div class="pstat-value" id="psBalance">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ════════════ STRATEGY BUILDER PAGE ════════════ -->
    <div class="page" id="page-builder">
        <div class="section-heading">Strategy Builder</div>

        <!-- ROW 1: Strategy Type + Select Instruments -->
        <div class="builder-top-row">
            <div class="card">
                <div class="card-title">Strategy Type</div>
                <div class="card-subtitle">Choose your strategy approach</div>
                <div class="checkbox-group" style="margin-top:12px;">
                    <label class="check-item"><input type="checkbox" checked id="chkTimeBased"> Time Based</label>
                    <label class="check-item"><input type="checkbox" id="chkIndicator"> Indicator Based</label>
                    <label class="check-item"><input type="checkbox" id="chkPriceAction"> Price Action Based</label>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Select Instruments</div>
                <div class="card-subtitle">Choose crypto pairs to trade</div>
                <div class="instrument-chips" id="instrumentChips">
                    <span class="instrument-chip" data-pair="BTC/USDT">BTC/USDT <button class="chip-remove" onclick="removeInstrument(this)">×</button></span>
                </div>
                <div style="position:relative;margin-top:8px;">
                    <button class="instrument-add-btn" onclick="toggleInstrumentDropdown()">+ Add</button>
                    <div class="instrument-dropdown" id="instrumentDropdown">
                        <input class="instrument-dropdown-search" placeholder="Search pairs..." oninput="filterInstruments(this.value)">
                        <div id="instrumentDropdownList">
                            <div class="instrument-dropdown-item selected" data-pair="BTC/USDT" onclick="toggleInstrumentSelect(this)">BTC/USDT <span style='font-size:11px;color:var(--text-muted)'>Bitcoin</span></div>
                            <div class="instrument-dropdown-item" data-pair="ETH/USDT" onclick="toggleInstrumentSelect(this)">ETH/USDT <span style='font-size:11px;color:var(--text-muted)'>Ethereum</span></div>
                            <div class="instrument-dropdown-item" data-pair="SOL/USDT" onclick="toggleInstrumentSelect(this)">SOL/USDT <span style='font-size:11px;color:var(--text-muted)'>Solana</span></div>
                            <div class="instrument-dropdown-item" data-pair="BNB/USDT" onclick="toggleInstrumentSelect(this)">BNB/USDT <span style='font-size:11px;color:var(--text-muted)'>BNB</span></div>
                            <div class="instrument-dropdown-item" data-pair="XRP/USDT" onclick="toggleInstrumentSelect(this)">XRP/USDT <span style='font-size:11px;color:var(--text-muted)'>Ripple</span></div>
                            <div class="instrument-dropdown-item" data-pair="ADA/USDT" onclick="toggleInstrumentSelect(this)">ADA/USDT <span style='font-size:11px;color:var(--text-muted)'>Cardano</span></div>
                            <div class="instrument-dropdown-item" data-pair="DOGE/USDT" onclick="toggleInstrumentSelect(this)">DOGE/USDT <span style='font-size:11px;color:var(--text-muted)'>Dogecoin</span></div>
                            <div class="instrument-dropdown-item" data-pair="AVAX/USDT" onclick="toggleInstrumentSelect(this)">AVAX/USDT <span style='font-size:11px;color:var(--text-muted)'>Avalanche</span></div>
                            <div class="instrument-dropdown-item" data-pair="DOT/USDT" onclick="toggleInstrumentSelect(this)">DOT/USDT <span style='font-size:11px;color:var(--text-muted)'>Polkadot</span></div>
                            <div class="instrument-dropdown-item" data-pair="LINK/USDT" onclick="toggleInstrumentSelect(this)">LINK/USDT <span style='font-size:11px;color:var(--text-muted)'>Chainlink</span></div>
                            <div class="instrument-dropdown-item" data-pair="MATIC/USDT" onclick="toggleInstrumentSelect(this)">MATIC/USDT <span style='font-size:11px;color:var(--text-muted)'>Polygon</span></div>
                            <div class="instrument-dropdown-item" data-pair="SHIB/USDT" onclick="toggleInstrumentSelect(this)">SHIB/USDT <span style='font-size:11px;color:var(--text-muted)'>Shiba Inu</span></div>
                            <div class="instrument-dropdown-item" data-pair="ARB/USDT" onclick="toggleInstrumentSelect(this)">ARB/USDT <span style='font-size:11px;color:var(--text-muted)'>Arbitrum</span></div>
                            <div class="instrument-dropdown-item" data-pair="OP/USDT" onclick="toggleInstrumentSelect(this)">OP/USDT <span style='font-size:11px;color:var(--text-muted)'>Optimism</span></div>
                            <div class="instrument-dropdown-item" data-pair="NEAR/USDT" onclick="toggleInstrumentSelect(this)">NEAR/USDT <span style='font-size:11px;color:var(--text-muted)'>NEAR</span></div>
                        </div>
                    </div>
                </div>
                <!-- Hidden select for form compat -->
                <select id="instrumentSelect" multiple style="display:none;"><option value="BTC/USDT" selected>BTC/USDT</option></select>
            </div>
        </div>

        <!-- ROW 2: Order Type + Strategy Legs -->
        <div class="builder-mid-row">
            <div class="card">
                <div class="card-title">Order Type</div>
                <div class="card-subtitle">Select your type</div>
                <div class="order-type-pills" style="margin-top:12px;">
                    <label class="order-type-pill active" onclick="selectOrderType(this)">
                        <input type="radio" name="orderType" value="market" checked> Market
                    </label>
                    <label class="order-type-pill" onclick="selectOrderType(this)">
                        <input type="radio" name="orderType" value="limit"> Limit
                    </label>
                    <label class="order-type-pill" onclick="selectOrderType(this)">
                        <input type="radio" name="orderType" value="stop-limit"> Stop-Limit
                    </label>
                </div>

                <div class="time-row">
                    <div>
                        <label class="form-label">Start Time</label>
                        <div class="time-input">
                            <input type="text" value="00:00" id="builderStartTime" style="width:50px;"> 🕐
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Square Off</label>
                        <div class="time-input">
                            <input type="text" value="23:59" id="builderEndTime" style="width:50px;"> 🕐
                        </div>
                    </div>
                </div>

                <div style="margin-top:14px;">
                    <label class="form-label">Active Days</label>
                    <div class="day-selector">
                        <div class="day-pill active">MON</div>
                        <div class="day-pill active">TUE</div>
                        <div class="day-pill active">WED</div>
                        <div class="day-pill active">THU</div>
                        <div class="day-pill active">FRI</div>
                        <div class="day-pill">SAT</div>
                        <div class="day-pill">SUN</div>
                    </div>
                </div>

                <div style="margin-top:16px;">
                    <label class="form-label">No Trade After</label>
                    <div class="time-input" style="width:fit-content;">
                        <input type="text" value="23:59" id="builderNoTradeAfter" style="width:50px;"> 🕐
                    </div>
                </div>
            </div>

            <div>
                <!-- Strategy Legs Header -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="font-size:18px;font-weight:700;">Strategy Legs</h3>
                    <button class="btn btn-primary" onclick="addLeg()">+ Add Leg</button>
                </div>

                <!-- Leg 1 -->
                <div class="leg-card" id="leg-1">
                    <div class="leg-header">
                        <div>
                            <span class="leg-title">Leg 1 <span class="buy-tag">BUY CE</span></span>
                            <div class="leg-subtitle">BUY CE • Strike ATM</div>
                        </div>
                        <span class="leg-badge">ACTIVE</span>
                    </div>

                    <div class="leg-grid">
                        <div class="leg-field">
                            <label>Qty</label>
                            <div class="num-input">
                                <button onclick="adjustQty(this,-1)">−</button>
                                <input type="number" value="0" min="0">
                                <button onclick="adjustQty(this,1)">+</button>
                            </div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Multiples of lot (-)</div>
                        </div>
                        <div class="leg-field">
                            <label>Position</label>
                            <div class="tab-pair">
                                <button class="tab-opt active-green">BUY</button>
                                <button class="tab-opt" onclick="toggleTabPair(this)">SELL</button>
                            </div>
                        </div>
                        <div class="leg-field">
                            <label>Option Type</label>
                            <div class="tab-pair">
                                <button class="tab-opt active">Call</button>
                                <button class="tab-opt" onclick="toggleTabPair(this)">Put</button>
                            </div>
                        </div>
                    </div>

                    <div class="leg-grid" style="margin-top:14px;">
                        <div class="leg-field">
                            <label>Expiry</label>
                            <select class="form-select">
                                <option selected>WEEKLY</option>
                                <option>MONTHLY</option>
                                <option>NEXT WEEK</option>
                                <option>NEXT MONTH</option>
                            </select>
                        </div>
                        <div class="leg-field">
                            <label>Strike Criteria</label>
                            <select class="form-select">
                                <option selected>ATM pt</option>
                                <option>ATM %</option>
                                <option>ATM + Straddle Width</option>
                                <option>Closest Premium</option>
                            </select>
                        </div>
                        <div class="leg-field">
                            <label>Strike Type</label>
                            <select class="form-select">
                                <option selected>ATM</option>
                                <option>ITM 1</option>
                                <option>ITM 2</option>
                                <option>ITM 3</option>
                                <option>OTM 1</option>
                                <option>OTM 2</option>
                                <option>OTM 3</option>
                            </select>
                        </div>
                    </div>

                    <div class="leg-grid" style="margin-top:14px;">
                        <div class="leg-field">
                            <label>SL Type</label>
                            <select class="form-select">
                                <option selected>SL%</option>
                                <option>SL Price</option>
                                <option>Trailing SL%</option>
                            </select>
                        </div>
                        <div class="leg-field">
                            <label>SL</label>
                            <input class="form-input" type="number" placeholder="">
                        </div>
                        <div class="leg-field">
                            <label>On Price</label>
                            <select class="form-select">
                                <option selected>On Price</option>
                                <option>On % Change</option>
                            </select>
                        </div>
                    </div>

                    <div class="leg-grid" style="margin-top:14px;">
                        <div class="leg-field">
                            <label>TP Type</label>
                            <select class="form-select">
                                <option selected>TP%</option>
                                <option>TP Price</option>
                                <option>Trailing TP%</option>
                            </select>
                        </div>
                        <div class="leg-field">
                            <label>TP</label>
                            <input class="form-input" type="number" placeholder="">
                        </div>
                        <div class="leg-field">
                            <label>On Price</label>
                            <select class="form-select">
                                <option selected>On Price</option>
                                <option>On % Change</option>
                            </select>
                        </div>
                    </div>

                    <div class="leg-actions">
                        <button class="delete" onclick="removeLeg(1)" title="Delete Leg">🗑</button>
                        <button title="Clone Leg" onclick="cloneLeg(1)">📋</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3: Risk Management + Advanced Features -->
        <div class="builder-bot-row">
            <div class="card">
                <div class="card-title">Risk Management</div>
                <div class="card-subtitle">Control your trading outcomes by setting global limits on losses and profits on the strategy, and automating how gains are protected (trailing).</div>
                <div class="risk-grid" style="margin-top:14px;">
                    <div>
                        <label class="form-label">Exit When Over All Profit In Amount (USDT)</label>
                        <input class="risk-input" type="number" placeholder="" id="riskProfit">
                    </div>
                    <div>
                        <label class="form-label">Exit When Over All Loss In Amount (USDT)</label>
                        <input class="risk-input" type="number" placeholder="" id="riskLoss">
                    </div>
                </div>
                <div style="margin-top:14px;">
                    <label class="form-label">No Trade After</label>
                    <div class="time-input" style="width:fit-content;">
                        <input type="text" value="23:59" id="riskNoTradeAfter" style="width:50px;"> 🕐
                    </div>
                </div>
                <div class="risk-grid" style="margin-top:14px;">
                    <div>
                        <label class="form-label">Max Daily Trades</label>
                        <input class="risk-input" type="number" placeholder="e.g. 10" id="riskMaxTrades">
                    </div>
                    <div>
                        <label class="form-label">Max Open Positions</label>
                        <input class="risk-input" type="number" placeholder="e.g. 5" id="riskMaxPos">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Advance Features <span style="display:inline-flex;width:18px;height:18px;border-radius:50%;background:var(--border);align-items:center;justify-content:center;font-size:11px;color:var(--text-muted);vertical-align:middle;cursor:help;" title="Advanced execution controls">ℹ</span></div>
                <div class="card-subtitle">Utilize advanced execution controls for dynamic stop-loss movement, conditional entry/re-entry, and strategy-wide exit synchronization.</div>
                <div class="adv-grid" style="margin-top:14px;">
                    <label class="adv-item"><input type="checkbox"> Move SL to Cost</label>
                    <label class="adv-item"><input type="checkbox"> Exit All on SL/Tgt</label>
                    <label class="adv-item"><input type="checkbox"> Pre Punch SL</label>
                    <label class="adv-item"><input type="checkbox"> Wait & Trade</label>
                    <label class="adv-item"><input type="checkbox"> Premium Difference</label>
                    <label class="adv-item"><input type="checkbox"> Re Entry/Execute</label>
                    <label class="adv-item"><input type="checkbox"> Trail SL</label>
                    <label class="adv-item"><input type="checkbox"> DCA on Dip</label>
                    <label class="adv-item"><input type="checkbox"> Martingale</label>
                </div>
            </div>
        </div>

        <!-- Save / Deploy buttons -->
        <div class="builder-actions">
            <button class="btn btn-outline" onclick="resetBuilder()">Reset</button>
            <button class="btn btn-primary btn-lg" onclick="saveStrategy()">💾 Save Strategy</button>
            <button class="btn btn-green btn-lg" onclick="deployStrategy()">🚀 Deploy Strategy</button>
        </div>
    </div>

    <!-- ════════════ STRATEGIES PAGE ════════════ -->
    <div class="page" id="page-strategies">
        <div class="strat-tabs">
            <div class="strat-tab active" onclick="switchStratTab(this, 'my')">My Strategies</div>
            <div class="strat-tab" onclick="switchStratTab(this, 'deployed')">Deployed Strategies</div>
            <div class="strat-tab" onclick="switchStratTab(this, 'templates')">Strategy Templates</div>
        </div>

        <div class="strat-topbar">
            <input class="strat-search" placeholder="🔍 Search strategies..." oninput="searchStrategies(this.value)">
            <div class="strat-type-toggle">
                <button class="strat-type-btn active">Strategies</button>
                <button class="strat-type-btn" onclick="this.classList.toggle('active');this.previousElementSibling.classList.toggle('active')">TradingView Signals</button>
            </div>
        </div>

        <div id="stratList" class="strat-list">
            <!-- Populated by JS -->
        </div>

        <div class="strat-empty" id="stratEmpty">
            <div class="empty-folder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            </div>
            <button class="btn btn-primary btn-lg" onclick="showPage('builder')">+ Create Strategy</button>
        </div>
    </div>

    <!-- ════════════ BACKTEST PAGE ════════════ -->
    <div class="page" id="page-backtest">
        <div class="bt-header">
            <h2>Choose Strategies to Backtest</h2>
            <p>Pick one or more of your strategies, select a time range, and run a backtest to view performance.</p>
        </div>

        <div class="bt-controls">
            <select class="bt-select" id="btStratSelect">
                <option value="">Select Strategies</option>
            </select>
            <div class="bt-range">
                <div class="pill active" onclick="setBtRange(this,'1M')">1 Month</div>
                <div class="pill" onclick="setBtRange(this,'3M')">3 Months</div>
                <div class="pill" onclick="setBtRange(this,'6M')">6 Months</div>
                <div class="pill" onclick="setBtRange(this,'1Y')">1 Year</div>
                <div class="pill" onclick="setBtRange(this,'2Y')">2 Years</div>
                <div class="pill" onclick="setBtRange(this,'custom')">Custom Range</div>
            </div>
        </div>

        <!-- Custom Date Range (hidden by default) -->
        <div class="bt-custom-range" id="btCustomRange" style="display:none;">
            <div class="report-filter-group">
                <label class="form-label">From</label>
                <input type="date" class="form-input" id="btDateFrom" style="width:160px;">
            </div>
            <div class="report-filter-group">
                <label class="form-label">To</label>
                <input type="date" class="form-input" id="btDateTo" style="width:160px;">
            </div>
        </div>

        <div class="bt-credit">
            <span>Backtest Credit: <strong id="btCredits">50/50</strong></span>
            <button class="btn btn-primary" onclick="runBacktest()">Run Backtest</button>
        </div>

        <div class="bt-empty" id="btEmpty">Select strategies to start</div>

        <div class="bt-results" id="btResults">
            <div class="bt-stats">
                <div class="bt-stat">
                    <div class="bt-stat-label">Total Return</div>
                    <div class="bt-stat-value positive" id="btReturn">+24.5%</div>
                </div>
                <div class="bt-stat">
                    <div class="bt-stat-label">Max Drawdown</div>
                    <div class="bt-stat-value negative" id="btDrawdown">-8.3%</div>
                </div>
                <div class="bt-stat">
                    <div class="bt-stat-label">Win Rate</div>
                    <div class="bt-stat-value" id="btWinRate">62.4%</div>
                </div>
                <div class="bt-stat">
                    <div class="bt-stat-label">Sharpe Ratio</div>
                    <div class="bt-stat-value" id="btSharpe">1.85</div>
                </div>
            </div>

            <!-- Backtest equity curve chart -->
            <div class="card" style="margin-top:16px;">
                <div class="card-title">Equity Curve</div>
                <div style="margin-top:12px;height:260px;position:relative;">
                    <canvas id="btEquityChart" width="700" height="260"></canvas>
                </div>
            </div>

            <!-- Backtest trade breakdown -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
                <div class="card">
                    <div class="card-title">Trade Distribution</div>
                    <div style="margin-top:12px;" id="btTradeDistro">
                        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                            <div style="text-align:center;">
                                <div style="font-size:28px;font-weight:800;color:var(--green);" id="btWinCount">0</div>
                                <div style="font-size:11px;color:var(--text-muted);">WINS</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:28px;font-weight:800;color:var(--red);" id="btLoseCount">0</div>
                                <div style="font-size:11px;color:var(--text-muted);">LOSSES</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:28px;font-weight:800;" id="btTotalTrades">0</div>
                                <div style="font-size:11px;color:var(--text-muted);">TOTAL</div>
                            </div>
                        </div>
                        <div style="height:8px;border-radius:4px;overflow:hidden;display:flex;">
                            <div id="btWinBar" style="background:var(--green);width:60%;transition:width 0.5s;"></div>
                            <div id="btLoseBar" style="background:var(--red);width:40%;transition:width 0.5s;"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Key Metrics</div>
                    <div style="margin-top:12px;">
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);">
                            <span style="font-size:13px;color:var(--text-secondary);">Avg Win</span>
                            <strong style="color:var(--green);" id="btAvgWin">$0.00</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);">
                            <span style="font-size:13px;color:var(--text-secondary);">Avg Loss</span>
                            <strong style="color:var(--red);" id="btAvgLoss">$0.00</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);">
                            <span style="font-size:13px;color:var(--text-secondary);">Profit Factor</span>
                            <strong id="btProfitFactor">—</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:8px 0;">
                            <span style="font-size:13px;color:var(--text-secondary);">Max Consecutive Wins</span>
                            <strong id="btMaxConsecWins">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ════════════ SIMULATOR PAGE ════════════ -->
    <div class="page" id="page-simulator">
        <div class="section-heading">Paper Trading Simulator</div>
        <p class="section-subheading" style="margin-top:-14px;margin-bottom:20px;">Practice trading with virtual funds — no risk involved.</p>

        <div class="sim-layout">
            <div class="sim-chart">
                <div style="text-align:center;">
                    <div style="font-size:48px;margin-bottom:8px;">📊</div>
                    <div style="font-size:16px;font-weight:600;">Live Price Chart</div>
                    <div style="font-size:24px;font-weight:800;margin-top:8px;" id="simPrice">$97,432.50</div>
                    <div style="font-size:12px;margin-top:4px;color:var(--green);" id="simPriceChange">+2.34% (24h)</div>
                </div>
            </div>
            <div class="sim-controls">
                <div class="card">
                    <div class="card-title">Virtual Account</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px;">
                        <div>
                            <div class="form-label">Balance</div>
                            <div style="font-size:18px;font-weight:700;" id="simBalance">$100,000.00</div>
                        </div>
                        <div>
                            <div class="form-label">Unrealized P&L</div>
                            <div style="font-size:18px;font-weight:700;color:var(--green);" id="simPnl">+$0.00</div>
                        </div>
                        <div>
                            <div class="form-label">Total Trades</div>
                            <div style="font-size:18px;font-weight:700;" id="simTradeCount">0</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Place Order</div>
                    <div class="form-group" style="margin-top:12px;">
                        <label class="form-label">Pair</label>
                        <select class="form-select" id="simPair" onchange="updateSimPrice()">
                            <option value="BTC/USDT" data-price="97432.50">BTC/USDT</option>
                            <option value="ETH/USDT" data-price="3412.80">ETH/USDT</option>
                            <option value="SOL/USDT" data-price="142.55">SOL/USDT</option>
                            <option value="BNB/USDT" data-price="612.30">BNB/USDT</option>
                            <option value="XRP/USDT" data-price="2.18">XRP/USDT</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <div class="form-group" style="flex:1;">
                            <label class="form-label">Amount (USDT)</label>
                            <input class="form-input" type="number" value="1000" id="simAmount">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label class="form-label">Leverage</label>
                            <select class="form-select" id="simLeverage">
                                <option>1x</option>
                                <option selected>5x</option>
                                <option>10x</option>
                                <option>20x</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <div class="form-group" style="flex:1;">
                            <label class="form-label">Stop Loss %</label>
                            <input class="form-input" type="number" value="5" id="simSL">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label class="form-label">Take Profit %</label>
                            <input class="form-input" type="number" value="10" id="simTP">
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-green" style="flex:1;justify-content:center;" onclick="simBuy()">BUY / LONG</button>
                        <button class="btn btn-red" style="flex:1;justify-content:center;" onclick="simSell()">SELL / SHORT</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" style="margin-bottom:8px;">
                        <div class="card-title">Open Positions</div>
                        <button class="btn btn-sm btn-ghost" onclick="simCloseAll()">Close All</button>
                    </div>
                    <div id="simPositions" style="max-height:200px;overflow-y:auto;">
                        <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;" id="simPosEmpty">No open positions</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sim Trade History -->
        <div class="card" style="margin-top:20px;">
            <div class="card-header">
                <div class="card-title">Simulation Trade History</div>
                <button class="btn btn-sm btn-outline" onclick="simClearHistory()">Clear History</button>
            </div>
            <div id="simHistory" style="max-height:300px;overflow-y:auto;">
                <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">No trades yet. Place a buy or sell order to start.</div>
            </div>
        </div>
    </div>

    <!-- ════════════ REPORTS PAGE ════════════ -->
    <div class="page" id="page-reports">
        <div class="section-heading">Reports & Analytics</div>

        <!-- Report / Trade Engine Logs Tabs -->
        <div class="report-tabs">
            <div class="report-tab active" onclick="switchReportTab(this, 'report')">Report</div>
            <div class="report-tab" onclick="switchReportTab(this, 'engine-logs')">Trade Engine Logs</div>
        </div>

        <!-- REPORT TAB CONTENT -->
        <div class="report-tab-content active" id="reportTabReport">
            <!-- Filters Row -->
            <div class="report-filters-row">
                <div class="report-filter-group">
                    <label class="form-label">From</label>
                    <input type="date" class="form-input" id="rptDateFrom" style="width:160px;">
                </div>
                <div class="report-filter-group">
                    <label class="form-label">To</label>
                    <input type="date" class="form-input" id="rptDateTo" style="width:160px;">
                </div>
                <div class="report-filter-group">
                    <label class="form-label">Select Exchange</label>
                    <select class="form-select" id="rptExchangeSelect" style="width:180px;">
                        <option value="">All Exchanges</option>
                    </select>
                </div>
                <div class="report-filter-group">
                    <label class="form-label">Mode</label>
                    <div class="report-mode-toggle">
                        <button class="mode-btn active" onclick="setReportMode(this,'live')">Live</button>
                        <button class="mode-btn" onclick="setReportMode(this,'forward')">Forward</button>
                    </div>
                </div>
                <div class="report-filter-group" style="align-self:flex-end;">
                    <button class="btn btn-primary" onclick="getReports()">Get Reports</button>
                </div>
                <div class="report-filter-group" style="align-self:flex-end;">
                    <button class="btn btn-outline btn-sm" onclick="exportReports()">📥 Export CSV</button>
                </div>
            </div>

            <!-- Summary Stats Row -->
            <div class="report-stats-grid">
                <div class="report-stat-card">
                    <div class="report-stat-label">MTM (Realized P&L)</div>
                    <div class="report-stat-value" id="rptMTM">$0.00</div>
                </div>
                <div class="report-stat-card">
                    <div class="report-stat-label">Brokerage / Fees</div>
                    <div class="report-stat-value" id="rptBrokerage">$0.00</div>
                </div>
                <div class="report-stat-card">
                    <div class="report-stat-label">Net P&L</div>
                    <div class="report-stat-value accent" id="rptNetPnl">$0.00</div>
                </div>
                <div class="report-stat-card">
                    <div class="report-stat-label">No. of Trades</div>
                    <div class="report-stat-value" id="rptTotalTrades">0</div>
                </div>
                <div class="report-stat-card green">
                    <div class="report-stat-label">Winning Trades</div>
                    <div class="report-stat-value" id="rptWinTrades">0</div>
                </div>
                <div class="report-stat-card red">
                    <div class="report-stat-label">Losing Trades</div>
                    <div class="report-stat-value" id="rptLoseTrades">0</div>
                </div>
            </div>

            <!-- Chart + Breakdown Row -->
            <div class="report-chart-row">
                <div class="card report-donut-card">
                    <div class="card-title">Strategy Breakdown</div>
                    <div class="donut-container">
                        <canvas id="strategyDonutChart" width="220" height="220"></canvas>
                        <div class="donut-legend" id="donutLegend">
                            <div class="legend-item"><span class="legend-dot" style="background:#4361ee;"></span> No data yet</div>
                        </div>
                    </div>
                </div>
                <div class="card report-pnl-card">
                    <div class="card-title">P&L Over Time</div>
                    <div class="pnl-chart-area" id="pnlChartArea">
                        <canvas id="pnlLineChart" width="500" height="220"></canvas>
                    </div>
                </div>
            </div>

            <!-- Trade History Table -->
            <div class="card" style="margin-top:20px;">
                <div class="card-header">
                    <div class="card-title">Trade History</div>
                    <div style="font-size:12px;color:var(--text-muted);" id="rptTradeCount">0 trades</div>
                </div>
                <div style="overflow-x:auto;">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Strategy</th>
                                <th>Pair</th>
                                <th>Action</th>
                                <th>Qty</th>
                                <th>Buy Price</th>
                                <th>Sell Price</th>
                                <th>P&L</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr>
                                <td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted);">No trade reports yet. Deploy a strategy to generate reports.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRADE ENGINE LOGS TAB CONTENT -->
        <div class="report-tab-content" id="reportTabLogs">
            <div class="report-filters-row">
                <div class="report-filter-group">
                    <label class="form-label">From</label>
                    <input type="date" class="form-input" id="logDateFrom" style="width:160px;">
                </div>
                <div class="report-filter-group">
                    <label class="form-label">To</label>
                    <input type="date" class="form-input" id="logDateTo" style="width:160px;">
                </div>
                <div class="report-filter-group">
                    <label class="form-label">Severity</label>
                    <select class="form-select" id="logSeverity" style="width:140px;">
                        <option value="">All</option>
                        <option value="INFO">Info</option>
                        <option value="WARN">Warning</option>
                        <option value="ERROR">Error</option>
                        <option value="TRADE">Trade</option>
                    </select>
                </div>
                <div class="report-filter-group" style="align-self:flex-end;">
                    <button class="btn btn-primary" onclick="getEngineLogs()">Get Logs</button>
                </div>
            </div>

            <div class="card" style="margin-top:16px;">
                <div class="card-header">
                    <div class="card-title">Trade Engine Logs</div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-sm btn-outline" onclick="clearLogs()">Clear</button>
                        <button class="btn btn-sm btn-outline" onclick="exportLogs()">📥 Export</button>
                    </div>
                </div>
                <div class="engine-log-container" id="engineLogContainer">
                    <div class="engine-log-entry info">
                        <span class="log-time">—</span>
                        <span class="log-severity info">INFO</span>
                        <span class="log-message">Trade engine initialized. Waiting for deployed strategies.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ════════════ SUBSCRIPTION PAGE ════════════ -->
    <div class="page" id="page-subscription">
        <div style="text-align:center;margin-bottom:32px;">
            <div class="section-heading" style="margin-bottom:4px;">Choose Your Plan</div>
            <p style="color:var(--text-secondary);font-size:14px;">Unlock the full power of PumpIQ AlgoTrader</p>
            <!-- Billing Period Toggle -->
            <div class="billing-toggle" style="margin-top:16px;">
                <button class="billing-btn active" onclick="switchBilling(this,'monthly')">Monthly</button>
                <button class="billing-btn" onclick="switchBilling(this,'quarterly')">Quarterly <span class="save-badge">Save 15%</span></button>
                <button class="billing-btn" onclick="switchBilling(this,'yearly')">Yearly <span class="save-badge">Save 30%</span></button>
            </div>
        </div>

        <div class="pricing-grid">
            <div class="pricing-card">
                <div class="pricing-name">Free</div>
                <div class="pricing-price" data-monthly="0" data-quarterly="0" data-yearly="0">Free <span>/ forever</span></div>
                <div class="pricing-desc">Perfect for learning and paper trading</div>
                <ul class="pricing-features">
                    <li>Paper Trading Simulator</li>
                    <li>3 Strategy Templates</li>
                    <li>50 Backtest Credits / month</li>
                    <li>Basic Reports</li>
                    <li>1 Exchange Connection</li>
                    <li>Community Support</li>
                </ul>
                <div class="pricing-limits">
                    <div class="pricing-limit-row">
                        <span>Max Backtesting Credits</span>
                        <strong>50</strong>
                    </div>
                    <div class="pricing-limit-row">
                        <span>Max Strategy</span>
                        <strong>3</strong>
                    </div>
                    <div class="pricing-limit-row">
                        <span>Deploy Strategy</span>
                        <strong>1</strong>
                    </div>
                </div>
                <button class="btn btn-outline" style="width:100%;">Current Plan</button>
            </div>
            <div class="pricing-card popular">
                <div class="pricing-name">Pro Trader</div>
                <div class="pricing-price" data-monthly="29" data-quarterly="74" data-yearly="244">$29 <span>/ month</span></div>
                <div class="pricing-desc">For active traders who want an edge</div>
                <ul class="pricing-features">
                    <li>Everything in Free</li>
                    <li>Unlimited Strategies</li>
                    <li>500 Backtest Credits / month</li>
                    <li>AI Strategy Suggestions</li>
                    <li>5 Exchange Connections</li>
                    <li>Advanced Risk Management</li>
                </ul>
                <div class="pricing-limits">
                    <div class="pricing-limit-row">
                        <span>Max Backtesting Credits</span>
                        <strong>500</strong>
                    </div>
                    <div class="pricing-limit-row">
                        <span>Max Strategy</span>
                        <strong>Unlimited</strong>
                    </div>
                    <div class="pricing-limit-row">
                        <span>Deploy Strategy</span>
                        <strong>10</strong>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="selectPlan('pro')">Upgrade to Pro</button>
            </div>
            <div class="pricing-card">
                <div class="pricing-name">Institutional</div>
                <div class="pricing-price" data-monthly="99" data-quarterly="252" data-yearly="832">$99 <span>/ month</span></div>
                <div class="pricing-desc">For teams and professional funds</div>
                <ul class="pricing-features">
                    <li>Everything in Pro</li>
                    <li>Unlimited Backtests</li>
                    <li>API Access</li>
                    <li>Priority Support</li>
                    <li>Unlimited Exchanges</li>
                    <li>White-label Options</li>
                </ul>
                <div class="pricing-limits">
                    <div class="pricing-limit-row">
                        <span>Max Backtesting Credits</span>
                        <strong>Unlimited</strong>
                    </div>
                    <div class="pricing-limit-row">
                        <span>Max Strategy</span>
                        <strong>Unlimited</strong>
                    </div>
                    <div class="pricing-limit-row">
                        <span>Deploy Strategy</span>
                        <strong>Unlimited</strong>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="selectPlan('institutional')">Contact Sales</button>
            </div>
        </div>

        <!-- FAQ Section -->
        <div class="faq-section" style="margin-top:48px;max-width:700px;margin-left:auto;margin-right:auto;">
            <h3 style="text-align:center;font-size:22px;font-weight:700;margin-bottom:24px;">Frequently Asked Questions</h3>
            <div class="faq-list">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>What is PumpIQ AlgoTrader?</span>
                        <span class="faq-arrow">▼</span>
                    </div>
                    <div class="faq-answer">PumpIQ AlgoTrader is a professional crypto algorithmic trading platform that lets you build, backtest, and deploy automated trading strategies across multiple exchanges — all without coding.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>How do backtest credits work?</span>
                        <span class="faq-arrow">▼</span>
                    </div>
                    <div class="faq-answer">Each backtest run consumes 1 credit. Credits reset monthly based on your plan. Free users get 50 credits, Pro gets 500, and Institutional has unlimited backtests.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Is my API key safe?</span>
                        <span class="faq-arrow">▼</span>
                    </div>
                    <div class="faq-answer">Yes. We use read-only API permissions by default and your keys are encrypted with AES-256. We never store plain-text credentials. You can enable trading permissions separately when you're ready.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Can I cancel my subscription anytime?</span>
                        <span class="faq-arrow">▼</span>
                    </div>
                    <div class="faq-answer">Absolutely! You can cancel or change your plan at any time. Your access continues until the end of your current billing period. No questions asked.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Which exchanges are supported?</span>
                        <span class="faq-arrow">▼</span>
                    </div>
                    <div class="faq-answer">We support Binance, Coinbase, Bybit, OKX, KuCoin, Kraken, Gate.io, and HTX (Huobi). More exchanges are being added regularly. Request new exchange support via our Discord.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>What happens if a strategy fails?</span>
                        <span class="faq-arrow">▼</span>
                    </div>
                    <div class="faq-answer">Our risk management system automatically applies stop-loss limits. If a strategy encounters errors, the Trade Engine pauses execution and sends you an alert. All errors are logged in the Trade Engine Logs for review.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ══════════════════ MODALS ══════════════════ -->

<!-- Add Exchange Modal -->
<div class="modal-overlay" id="exchangeModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('exchangeModal')">✕</button>
        <h3>Connect Exchange</h3>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Select your crypto exchange and enter API credentials.</p>

        <div class="exchange-options" id="exchangeOptions">
            <div class="exchange-option" onclick="selectExchange(this, 'Binance')">
                <div class="exo-icon" style="background:#F0B90B;color:#000;">B</div>
                <span class="exo-name">Binance</span>
            </div>
            <div class="exchange-option" onclick="selectExchange(this, 'Coinbase')">
                <div class="exo-icon" style="background:#0052FF;color:#fff;">C</div>
                <span class="exo-name">Coinbase</span>
            </div>
            <div class="exchange-option" onclick="selectExchange(this, 'Bybit')">
                <div class="exo-icon" style="background:#F7A600;color:#000;">BY</div>
                <span class="exo-name">Bybit</span>
            </div>
            <div class="exchange-option" onclick="selectExchange(this, 'OKX')">
                <div class="exo-icon" style="background:#000;color:#fff;">OK</div>
                <span class="exo-name">OKX</span>
            </div>
            <div class="exchange-option" onclick="selectExchange(this, 'KuCoin')">
                <div class="exo-icon" style="background:#24AE8F;color:#fff;">K</div>
                <span class="exo-name">KuCoin</span>
            </div>
            <div class="exchange-option" onclick="selectExchange(this, 'Kraken')">
                <div class="exo-icon" style="background:#5741D9;color:#fff;">Kr</div>
                <span class="exo-name">Kraken</span>
            </div>
            <div class="exchange-option" onclick="selectExchange(this, 'Gate.io')">
                <div class="exo-icon" style="background:#2354E6;color:#fff;">G</div>
                <span class="exo-name">Gate.io</span>
            </div>
            <div class="exchange-option" onclick="selectExchange(this, 'HTX')">
                <div class="exo-icon" style="background:#1B76E8;color:#fff;">H</div>
                <span class="exo-name">HTX (Huobi)</span>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">API Key</label>
            <input class="form-input" type="text" placeholder="Enter your API key" id="exApiKey">
        </div>
        <div class="form-group">
            <label class="form-label">API Secret</label>
            <input class="form-input" type="password" placeholder="Enter your API secret" id="exApiSecret">
        </div>
        <div class="form-group">
            <label class="form-label">Passphrase (if required)</label>
            <input class="form-input" type="password" placeholder="Optional passphrase" id="exPassphrase">
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
            <input type="checkbox" id="exReadOnly" checked style="accent-color:var(--accent);">
            <label for="exReadOnly" style="font-size:13px;color:var(--text-secondary);">Read-only permissions (recommended for safety)</label>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="connectExchange()">Connect Exchange</button>
    </div>
</div>

<!-- Save Strategy Modal -->
<div class="modal-overlay" id="saveStratModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('saveStratModal')">✕</button>
        <h3>Save Strategy</h3>
        <div class="form-group">
            <label class="form-label">Strategy Name</label>
            <input class="form-input" type="text" placeholder="e.g. BTC Momentum Scalper" id="stratName">
        </div>
        <div class="form-group">
            <label class="form-label">Description (optional)</label>
            <textarea class="form-input" rows="3" placeholder="Describe your strategy..." id="stratDesc" style="resize:vertical;"></textarea>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="confirmSaveStrategy()">Save Strategy</button>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- ══════════════════ JAVASCRIPT ══════════════════ -->
<script>
// ── State ──
const state = {
    strategies: [],
    exchanges: [],
    selectedExchange: null,
    legCounter: 1,
    currentStratTab: 'my',
    btCredits: 50,
    user: null,
    theme: localStorage.getItem('piq_theme') || 'light',
};

function authHeaders() {
    const token = localStorage.getItem('pumpiq_token');
    return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
}

async function loadStrategiesFromAPI() {
    try {
        const res = await fetch('/api/algo/strategies', { headers: authHeaders() });
        if (res.ok) {
            const data = await res.json();
            state.strategies = data.map(s => ({
                ...s,
                instruments: typeof s.instruments === 'string' ? JSON.parse(s.instruments) : (s.instruments || []),
                legs: typeof s.legs === 'string' ? JSON.parse(s.legs) : (s.legs || []),
                risk_config: typeof s.risk_config === 'string' ? JSON.parse(s.risk_config) : (s.risk_config || {}),
                advanced_config: typeof s.advanced_config === 'string' ? JSON.parse(s.advanced_config) : (s.advanced_config || {}),
                createdAt: s.created_at || s.createdAt,
            }));
        }
    } catch (e) { console.warn('Failed to load strategies from API, using localStorage fallback', e); state.strategies = JSON.parse(localStorage.getItem('piq_strategies') || '[]'); }
}

async function loadExchangesFromAPI() {
    try {
        const res = await fetch('/api/algo/exchanges', { headers: authHeaders() });
        if (res.ok) {
            const data = await res.json();
            state.exchanges = data.map(ex => ({
                ...ex,
                apiKeyLast4: ex.api_key_last4 || ex.apiKeyLast4 || '',
                connectedAt: ex.connected_at || ex.connectedAt || '',
            }));
        }
    } catch (e) { console.warn('Failed to load exchanges from API', e); state.exchanges = JSON.parse(localStorage.getItem('piq_exchanges') || '[]'); }
}

// ── Init ──
document.addEventListener('DOMContentLoaded', async () => {
    applyTheme();
    loadUserInfo();
    await Promise.all([loadStrategiesFromAPI(), loadExchangesFromAPI()]);
    renderExchanges();
    renderStrategies();
    updateBtSelect();
    initReportDefaults();
    updateDashboardStats();

    // Day pill toggles
    document.querySelectorAll('.day-pill').forEach(pill => {
        pill.addEventListener('click', () => pill.classList.toggle('active'));
    });
});

// ── Theme ──
function toggleTheme() {
    state.theme = state.theme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('piq_theme', state.theme);
    applyTheme();
}
function applyTheme() {
    document.body.classList.toggle('dark', state.theme === 'dark');
}

// ── User Info ──
function loadUserInfo() {
    const token = localStorage.getItem('pumpiq_token');
    if (!token) return;
    fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` } })
        .then(r => r.ok ? r.json() : null)
        .then(user => {
            if (!user) return;
            state.user = user;
            const name = user.username || 'Trader';
            const initials = name.slice(0, 2).toUpperCase();
            document.getElementById('sidebarUserName').textContent = name;
            document.getElementById('sidebarUserId').textContent = `PQ-${String(user.id).padStart(3, '0')}`;
            document.getElementById('sidebarAvatar').textContent = initials;
            document.getElementById('dashUserTag').textContent = name;
        })
        .catch(() => {});
}

// ── Navigation ──
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const page = document.getElementById(`page-${pageId}`);
    if (page) page.classList.add('active');

    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
    if (navItem) navItem.classList.add('active');
}

function toggleBacktest() {
    const sub = document.getElementById('btSub');
    const arrow = document.getElementById('btArrow');
    sub.classList.toggle('open');
    arrow.classList.toggle('open');
    if (sub.classList.contains('open')) {
        showPage('backtest');
    }
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
}

// ── Strategy Builder ──
function addLeg() {
    state.legCounter++;
    const legId = state.legCounter;
    const legHtml = `
    <div class="leg-card" id="leg-${legId}">
        <div class="leg-header">
            <div>
                <span class="leg-title">Leg ${legId} <span class="buy-tag">BUY CE</span></span>
                <div class="leg-subtitle">BUY CE • Strike ATM</div>
            </div>
            <span class="leg-badge">ACTIVE</span>
        </div>
        <div class="leg-grid">
            <div class="leg-field">
                <label>Qty</label>
                <div class="num-input">
                    <button onclick="adjustQty(this,-1)">−</button>
                    <input type="number" value="0" min="0">
                    <button onclick="adjustQty(this,1)">+</button>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Multiples of lot (-)</div>
            </div>
            <div class="leg-field">
                <label>Position</label>
                <div class="tab-pair">
                    <button class="tab-opt active-green">BUY</button>
                    <button class="tab-opt" onclick="toggleTabPair(this)">SELL</button>
                </div>
            </div>
            <div class="leg-field">
                <label>Option Type</label>
                <div class="tab-pair">
                    <button class="tab-opt active">Call</button>
                    <button class="tab-opt" onclick="toggleTabPair(this)">Put</button>
                </div>
            </div>
        </div>
        <div class="leg-grid" style="margin-top:14px;">
            <div class="leg-field">
                <label>Expiry</label>
                <select class="form-select"><option selected>WEEKLY</option><option>MONTHLY</option><option>NEXT WEEK</option><option>NEXT MONTH</option></select>
            </div>
            <div class="leg-field">
                <label>Strike Criteria</label>
                <select class="form-select"><option selected>ATM pt</option><option>ATM %</option><option>ATM + Straddle Width</option><option>Closest Premium</option></select>
            </div>
            <div class="leg-field">
                <label>Strike Type</label>
                <select class="form-select"><option selected>ATM</option><option>ITM 1</option><option>ITM 2</option><option>ITM 3</option><option>OTM 1</option><option>OTM 2</option><option>OTM 3</option></select>
            </div>
        </div>
        <div class="leg-grid" style="margin-top:14px;">
            <div class="leg-field">
                <label>SL Type</label>
                <select class="form-select"><option selected>SL%</option><option>SL Price</option><option>Trailing SL%</option></select>
            </div>
            <div class="leg-field">
                <label>SL</label>
                <input class="form-input" type="number" placeholder="">
            </div>
            <div class="leg-field">
                <label>On Price</label>
                <select class="form-select"><option selected>On Price</option><option>On % Change</option></select>
            </div>
        </div>
        <div class="leg-grid" style="margin-top:14px;">
            <div class="leg-field">
                <label>TP Type</label>
                <select class="form-select"><option selected>TP%</option><option>TP Price</option><option>Trailing TP%</option></select>
            </div>
            <div class="leg-field">
                <label>TP</label>
                <input class="form-input" type="number" placeholder="">
            </div>
            <div class="leg-field">
                <label>On Price</label>
                <select class="form-select"><option selected>On Price</option><option>On % Change</option></select>
            </div>
        </div>
        <div class="leg-actions">
            <button class="delete" onclick="removeLeg(${legId})" title="Delete Leg">🗑</button>
            <button title="Clone Leg" onclick="cloneLeg(${legId})">📋</button>
        </div>
    </div>`;
    document.getElementById(`leg-1`).parentElement.insertAdjacentHTML('beforeend', legHtml);
    toast('Leg ' + legId + ' added', 'info');
}

function removeLeg(id) {
    const leg = document.getElementById(`leg-${id}`);
    if (leg) { leg.remove(); toast('Leg removed', 'info'); }
}

function cloneLeg(id) {
    addLeg();
    toast('Leg cloned', 'info');
}

function adjustQty(btn, delta) {
    const input = btn.parentElement.querySelector('input');
    const val = parseFloat(input.value) || 0;
    input.value = Math.max(0, val + delta);
}

function toggleTabPair(btn) {
    const parent = btn.parentElement;
    parent.querySelectorAll('.tab-opt').forEach(t => {
        t.classList.remove('active', 'active-green', 'active-red');
    });
    if (btn.textContent === 'BUY') btn.classList.add('active-green');
    else if (btn.textContent === 'SELL') btn.classList.add('active-red');
    else btn.classList.add('active');
}

// ── Instrument Chip Management ──
function getSelectedInstruments() {
    const chips = document.querySelectorAll('#instrumentChips .instrument-chip');
    return Array.from(chips).map(c => c.getAttribute('data-pair'));
}

function syncInstrumentSelect() {
    const sel = document.getElementById('instrumentSelect');
    const selected = getSelectedInstruments();
    Array.from(sel.options).forEach(opt => { opt.selected = selected.includes(opt.value); });
    // Sync dropdown highlights
    document.querySelectorAll('#instrumentDropdownList .instrument-dropdown-item').forEach(item => {
        item.classList.toggle('selected', selected.includes(item.getAttribute('data-pair')));
    });
}

function toggleInstrumentDropdown() {
    const dd = document.getElementById('instrumentDropdown');
    dd.classList.toggle('open');
    if (dd.classList.contains('open')) {
        dd.querySelector('.instrument-dropdown-search').focus();
    }
}

function toggleInstrumentSelect(el) {
    const pair = el.getAttribute('data-pair');
    const chips = document.getElementById('instrumentChips');
    const existing = chips.querySelector(`[data-pair="${pair}"]`);
    if (existing) {
        existing.remove();
        el.classList.remove('selected');
    } else {
        const chip = document.createElement('span');
        chip.className = 'instrument-chip';
        chip.setAttribute('data-pair', pair);
        chip.innerHTML = `${pair} <button class="chip-remove" onclick="removeInstrument(this)">×</button>`;
        chips.appendChild(chip);
        el.classList.add('selected');
    }
    syncInstrumentSelect();
}

function removeInstrument(btn) {
    const chip = btn.closest('.instrument-chip');
    const pair = chip.getAttribute('data-pair');
    chip.remove();
    const ddItem = document.querySelector(`#instrumentDropdownList [data-pair="${pair}"]`);
    if (ddItem) ddItem.classList.remove('selected');
    syncInstrumentSelect();
}

function filterInstruments(query) {
    const items = document.querySelectorAll('#instrumentDropdownList .instrument-dropdown-item');
    const q = query.toLowerCase();
    items.forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
}

function selectOrderType(el) {
    document.querySelectorAll('.order-type-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    el.querySelector('input').checked = true;
}

// Close instrument dropdown on outside click
document.addEventListener('click', (e) => {
    const dd = document.getElementById('instrumentDropdown');
    if (dd && !e.target.closest('.instrument-dropdown') && !e.target.closest('.instrument-add-btn')) {
        dd.classList.remove('open');
    }
});

function resetBuilder() {
    document.querySelectorAll('.leg-card:not(#leg-1)').forEach(l => l.remove());
    state.legCounter = 1;
    toast('Builder reset', 'info');
}

function saveStrategy() {
    openModal('saveStratModal');
}

async function confirmSaveStrategy() {
    const name = document.getElementById('stratName').value.trim();
    if (!name) { toast('Please enter a strategy name', 'error'); return; }

    const desc = document.getElementById('stratDesc').value.trim();
    const instruments = Array.from(document.getElementById('instrumentSelect').selectedOptions).map(o => o.value);

    // Collect strategy type
    const stratTypes = [];
    if (document.getElementById('chkTimeBased')?.checked) stratTypes.push('time_based');
    if (document.getElementById('chkIndicator')?.checked) stratTypes.push('indicator');
    if (document.getElementById('chkPriceAction')?.checked) stratTypes.push('price_action');
    const strategyType = stratTypes.join(',') || 'time_based';

    // Collect order type
    const orderTypeEl = document.querySelector('input[name="orderType"]:checked');
    const orderType = orderTypeEl ? orderTypeEl.value : 'market';

    // Collect legs data from the builder
    const legCards = document.querySelectorAll('.leg-card');
    const legsData = [];
    legCards.forEach((card, idx) => {
        const selects = card.querySelectorAll('.form-select');
        const inputs = card.querySelectorAll('.form-input, .num-input input');
        const tabPairs = card.querySelectorAll('.tab-pair');
        const leg = {
            leg_number: idx + 1,
            qty: parseFloat(inputs[0]?.value) || 0,
            position: tabPairs[0]?.querySelector('.active-green, .active-red')?.textContent || 'BUY',
            option_type: tabPairs[1]?.querySelector('.active')?.textContent || 'Call',
            expiry: selects[0]?.value || 'WEEKLY',
            strike_criteria: selects[1]?.value || 'ATM pt',
            strike_type: selects[2]?.value || 'ATM',
            sl_type: selects[3]?.value || 'SL%',
            stop_loss: parseFloat(inputs[1]?.value) || 0,
            sl_on: selects[4]?.value || 'On Price',
            tp_type: selects[5]?.value || 'TP%',
            take_profit: parseFloat(inputs[2]?.value) || 0,
            tp_on: selects[6]?.value || 'On Price',
        };
        legsData.push(leg);
    });

    // Collect risk config
    const riskConfig = {
        max_profit: parseFloat(document.getElementById('riskProfit')?.value) || 0,
        max_loss: parseFloat(document.getElementById('riskLoss')?.value) || 0,
        max_daily_trades: parseInt(document.getElementById('riskMaxTrades')?.value) || 0,
        max_open_positions: parseInt(document.getElementById('riskMaxPos')?.value) || 0,
    };

    // Collect advanced config
    const advCheckboxes = document.querySelectorAll('.adv-grid input[type="checkbox"]');
    const advLabels = ['move_sl_to_cost', 'exit_all_on_sl_tp', 'preset_sl_order', 'wait_confirm', 'premium_diff', 're_entry', 'trail_sl', 'dca_on_dip', 'martingale'];
    const advancedConfig = {};
    advCheckboxes.forEach((cb, i) => { advancedConfig[advLabels[i] || `adv_${i}`] = cb.checked; });

    // Collect active days & time
    const activeDays = Array.from(document.querySelectorAll('.day-pill.active')).map(p => p.textContent.trim());
    riskConfig.active_days = activeDays;

    const body = {
        name, description: desc, instruments,
        legs: legsData, strategy_type: strategyType,
        order_type: orderType, risk_config: riskConfig,
        advanced_config: advancedConfig,
    };

    try {
        const res = await fetch('/api/algo/strategies', {
            method: 'POST', headers: authHeaders(), body: JSON.stringify(body),
        });
        if (!res.ok) { const err = await res.json().catch(() => ({})); toast(err.detail || 'Failed to save strategy', 'error'); return; }
        const saved = await res.json();
        toast(`Strategy "${name}" saved!`, 'success');
        closeModal('saveStratModal');
        await loadStrategiesFromAPI();
        renderStrategies();
        updateBtSelect();
        updateDashboardStats();
        document.getElementById('stratName').value = '';
        document.getElementById('stratDesc').value = '';
    } catch (e) {
        console.error('Save strategy error:', e);
        toast('Failed to save strategy', 'error');
    }
}

async function deployStrategy() {
    if (state.exchanges.length === 0) {
        toast('Connect an exchange first!', 'error');
        return;
    }
    // Save first, then deploy the newly saved strategy
    const name = document.getElementById('stratName')?.value?.trim();
    if (!name && state.strategies.length === 0) {
        toast('Save a strategy first!', 'error');
        return;
    }
    // If there's a name typed, save first
    if (name) {
        await confirmSaveStrategy();
    }
    // Deploy the most recent strategy
    const latest = state.strategies[0];
    if (!latest) { toast('No strategy to deploy', 'error'); return; }
    try {
        const res = await fetch(`/api/algo/strategies/${latest.id}/deploy`, {
            method: 'POST', headers: authHeaders(),
        });
        if (!res.ok) { const err = await res.json().catch(() => ({})); toast(err.detail || 'Deploy failed', 'error'); return; }
        toast('Strategy deployed! 🚀', 'success');
        await loadStrategiesFromAPI();
        renderStrategies();
        updateDashboardStats();
    } catch (e) {
        toast('Deploy failed', 'error');
    }
}

async function addTemplate(name) {
    const templates = {
        'BTC Moving Average Crossover': { instruments: ['BTC/USDT'], strategy_type: 'indicator', order_type: 'market', legs: [{leg_number:1, position:'BUY', market_type:'Spot', leverage:'1x', entry_trigger:'Market Price', timeframe:'4h', sl_type:'SL%', stop_loss:3, tp_type:'TP%', take_profit:6, qty:200}], risk_config: {max_loss:500, max_daily_trades:5}, description: 'Classic MA crossover strategy on BTC with 4h timeframe' },
        'ETH RSI Swing Trading': { instruments: ['ETH/USDT'], strategy_type: 'indicator', order_type: 'limit', legs: [{leg_number:1, position:'BUY', market_type:'Spot', leverage:'2x', entry_trigger:'Limit Price', timeframe:'1h', sl_type:'SL%', stop_loss:4, tp_type:'TP%', take_profit:8, qty:150}], risk_config: {max_loss:300, max_daily_trades:8}, description: 'RSI-based swing trading on ETH' },
        'SOL Momentum Scalper': { instruments: ['SOL/USDT'], strategy_type: 'price_action', order_type: 'market', legs: [{leg_number:1, position:'BUY', market_type:'Futures', leverage:'10x', entry_trigger:'Market Price', timeframe:'5m', sl_type:'SL%', stop_loss:1.5, tp_type:'TP%', take_profit:3, qty:100}], risk_config: {max_loss:200, max_daily_trades:20}, description: 'Fast scalping on SOL momentum moves' },
        'DCA Bitcoin Weekly': { instruments: ['BTC/USDT'], strategy_type: 'time_based', order_type: 'market', legs: [{leg_number:1, position:'BUY', market_type:'Spot', leverage:'1x', entry_trigger:'Market Price', timeframe:'1d', sl_type:'SL%', stop_loss:0, tp_type:'TP%', take_profit:0, qty:50}], risk_config: {max_daily_trades:1, active_days:['MON']}, description: 'Dollar cost average into BTC every week' },
        'Altcoin Breakout Hunter': { instruments: ['SOL/USDT','AVAX/USDT','LINK/USDT','ARB/USDT'], strategy_type: 'price_action', order_type: 'stop-limit', legs: [{leg_number:1, position:'BUY', market_type:'Spot', leverage:'3x', entry_trigger:'% Above Market', timeframe:'1h', sl_type:'SL%', stop_loss:5, tp_type:'TP%', take_profit:15, qty:100}], risk_config: {max_loss:400, max_daily_trades:10}, description: 'Catch breakouts on promising altcoins' },
        'Grid Trading BTC/USDT': { instruments: ['BTC/USDT'], strategy_type: 'time_based,price_action', order_type: 'limit', legs: [{leg_number:1, position:'BUY', market_type:'Spot', leverage:'1x', entry_trigger:'% Below Market', timeframe:'15m', sl_type:'SL%', stop_loss:2, tp_type:'TP%', take_profit:2, qty:50},{leg_number:2, position:'SELL', market_type:'Spot', leverage:'1x', entry_trigger:'% Above Market', timeframe:'15m', sl_type:'SL%', stop_loss:2, tp_type:'TP%', take_profit:2, qty:50}], risk_config: {max_loss:300, max_daily_trades:50}, description: 'Grid bot placing buy/sell orders in a range' },
    };
    const tmpl = templates[name] || { instruments: ['BTC/USDT'], legs: [], description: 'Template strategy' };
    const body = {
        name, description: tmpl.description || 'Template strategy',
        instruments: tmpl.instruments, legs: tmpl.legs || [],
        strategy_type: tmpl.strategy_type || 'time_based',
        order_type: tmpl.order_type || 'market',
        risk_config: tmpl.risk_config || {},
        advanced_config: {},
    };
    try {
        const res = await fetch('/api/algo/strategies', {
            method: 'POST', headers: authHeaders(), body: JSON.stringify(body),
        });
        if (!res.ok) { toast('Failed to add template', 'error'); return; }
        toast(`"${name}" added to your strategies!`, 'success');
        await loadStrategiesFromAPI();
        renderStrategies();
        updateBtSelect();
        updateDashboardStats();
    } catch (e) { toast('Failed to add template', 'error'); }
}

// ── Strategies Page ──
function renderStrategies() {
    const list = document.getElementById('stratList');
    const empty = document.getElementById('stratEmpty');
    const strategies = state.strategies.filter(s => {
        if (state.currentStratTab === 'deployed') return s.status === 'running';
        if (state.currentStratTab === 'templates') return false;
        return true;
    });

    if (strategies.length === 0) {
        list.style.display = 'none';
        empty.style.display = 'flex';
        return;
    }
    list.style.display = 'flex';
    empty.style.display = 'none';

    list.innerHTML = strategies.map(s => `
        <div class="strat-card">
            <div class="strat-card-info">
                <h4>${s.name}</h4>
                <p>${s.instruments?.join(', ') || 'BTC/USDT'} • ${s.legs} leg(s) • Created ${new Date(s.createdAt).toLocaleDateString()}</p>
            </div>
            <div class="strat-card-meta">
                <span class="strat-status ${s.status}">${s.status === 'running' ? 'Running' : s.status === 'paused' ? 'Paused' : 'Stopped'}</span>
                <button class="btn btn-sm ${s.status === 'running' ? 'btn-red' : 'btn-green'}" onclick="toggleStratStatus(${s.id})">
                    ${s.status === 'running' ? '⏹ Stop' : '▶ Start'}
                </button>
                <button class="btn btn-sm btn-ghost" onclick="deleteStrategy(${s.id})">🗑</button>
            </div>
        </div>
    `).join('');
}

async function toggleStratStatus(id) {
    const s = state.strategies.find(x => x.id === id);
    if (!s) return;
    const newStatus = s.status === 'running' ? 'stopped' : 'running';
    if (newStatus === 'running' && state.exchanges.length === 0) {
        toast('Connect an exchange first!', 'error'); return;
    }
    try {
        if (newStatus === 'running') {
            const res = await fetch(`/api/algo/strategies/${id}/deploy`, {
                method: 'POST', headers: authHeaders(),
            });
            if (!res.ok) { const err = await res.json().catch(() => ({})); toast(err.detail || 'Failed to start', 'error'); return; }
        } else {
            const res = await fetch(`/api/algo/strategies/${id}`, {
                method: 'PUT', headers: authHeaders(),
                body: JSON.stringify({ status: 'stopped' }),
            });
            if (!res.ok) { toast('Failed to stop', 'error'); return; }
        }
        toast(`Strategy ${newStatus === 'running' ? 'started' : 'stopped'}`, newStatus === 'running' ? 'success' : 'info');
        await loadStrategiesFromAPI();
        renderStrategies();
        updateDashboardStats();
    } catch (e) { toast('Failed to update strategy', 'error'); }
}

async function deleteStrategy(id) {
    if (!confirm('Delete this strategy?')) return;
    try {
        const res = await fetch(`/api/algo/strategies/${id}`, {
            method: 'DELETE', headers: authHeaders(),
        });
        if (!res.ok) { toast('Failed to delete', 'error'); return; }
        toast('Strategy deleted', 'info');
        await loadStrategiesFromAPI();
        renderStrategies();
        updateBtSelect();
        updateDashboardStats();
    } catch (e) { toast('Failed to delete strategy', 'error'); }
}

function switchStratTab(el, tab) {
    document.querySelectorAll('.strat-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    state.currentStratTab = tab;
    renderStrategies();
}

function searchStrategies(q) {
    const list = document.getElementById('stratList');
    const cards = list.querySelectorAll('.strat-card');
    cards.forEach(card => {
        const name = card.querySelector('h4').textContent.toLowerCase();
        card.style.display = name.includes(q.toLowerCase()) ? 'flex' : 'none';
    });
}

function updateDashboardStats() {
    const deployed = state.strategies.filter(s => s.status === 'running' || s.status === 'paused');
    const running = state.strategies.filter(s => s.status === 'running');
    const stopped = state.strategies.filter(s => s.status === 'stopped');

    document.getElementById('deployedCount').textContent = deployed.length;
    document.getElementById('runningCount').textContent = running.length;
    document.getElementById('stoppedCount').textContent = stopped.length;

    const emptyIcon = document.getElementById('deployEmptyIcon');
    const emptyTitle = document.getElementById('deployEmptyTitle');
    const emptyDesc = document.getElementById('deployEmptyDesc');
    const statsRow = document.getElementById('deployStatsRow');

    if (deployed.length > 0) {
        emptyIcon.style.display = 'none';
        emptyTitle.textContent = `${deployed.length} Strategies Active`;
        emptyDesc.textContent = `${running.length} running, ${stopped.length} stopped`;
        statsRow.style.display = 'flex';
    } else {
        emptyIcon.style.display = 'flex';
        emptyTitle.textContent = 'No Strategies Deployed';
        emptyDesc.textContent = "You haven't deployed any trading strategies yet.";
        statsRow.style.display = 'flex';
    }

    // Update exchange selector on dashboard
    const dashExSel = document.getElementById('dashExchangeSelect');
    dashExSel.innerHTML = state.exchanges.length === 0
        ? '<option>No exchange selected</option>'
        : state.exchanges.map(ex => `<option>${ex.name}</option>`).join('');
}

// ── Exchange ──
function selectExchange(el, name) {
    document.querySelectorAll('.exchange-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    state.selectedExchange = name;
}

async function connectExchange() {
    if (!state.selectedExchange) { toast('Select an exchange first', 'error'); return; }
    const apiKey = document.getElementById('exApiKey').value.trim();
    const apiSecret = document.getElementById('exApiSecret').value.trim();
    const passphrase = document.getElementById('exPassphrase')?.value?.trim() || '';
    if (!apiKey || !apiSecret) { toast('Enter API credentials', 'error'); return; }

    try {
        const res = await fetch('/api/algo/exchanges', {
            method: 'POST', headers: authHeaders(),
            body: JSON.stringify({ name: state.selectedExchange, api_key: apiKey, api_secret: apiSecret, passphrase }),
        });
        if (!res.ok) { const err = await res.json().catch(() => ({})); toast(err.detail || 'Failed to connect', 'error'); return; }
        toast(`${state.selectedExchange} connected!`, 'success');
        closeModal('exchangeModal');
        await loadExchangesFromAPI();
        renderExchanges();
        updateDashboardStats();
        // Clear form
        document.getElementById('exApiKey').value = '';
        document.getElementById('exApiSecret').value = '';
        if (document.getElementById('exPassphrase')) document.getElementById('exPassphrase').value = '';
        state.selectedExchange = null;
        document.querySelectorAll('.exchange-option').forEach(o => o.classList.remove('selected'));
    } catch (e) { toast('Failed to connect exchange', 'error'); }
}

function renderExchanges() {
    const list = document.getElementById('exchangeList');
    const empty = document.getElementById('exchangeEmpty');
    const summary = document.getElementById('portfolioSummary');

    if (state.exchanges.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'flex';
        summary.style.display = 'none';
        return;
    }

    empty.style.display = 'none';
    summary.style.display = 'block';

    const colors = {
        'Binance': '#F0B90B', 'Coinbase': '#0052FF', 'Bybit': '#F7A600',
        'OKX': '#000', 'KuCoin': '#24AE8F', 'Kraken': '#5741D9',
        'Gate.io': '#2354E6', 'HTX': '#1B76E8',
    };

    list.innerHTML = '<div class="exchange-grid">' + state.exchanges.map(ex => `
        <div class="exchange-card">
            <div class="exchange-logo" style="background:${colors[ex.name] || '#666'};color:#fff;">${ex.name.slice(0, 2)}</div>
            <div class="exchange-info">
                <h4>${ex.name}</h4>
                <p>API ····${ex.apiKeyLast4} • Connected ${new Date(ex.connectedAt).toLocaleDateString()}</p>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <span class="exchange-status connected">Connected</span>
                <button class="btn btn-sm btn-ghost" onclick="disconnectExchange(${ex.id})">✕</button>
            </div>
        </div>
    `).join('') + '</div>';
}

async function disconnectExchange(id) {
    if (!confirm('Disconnect this exchange?')) return;
    try {
        const res = await fetch(`/api/algo/exchanges/${id}`, {
            method: 'DELETE', headers: authHeaders(),
        });
        if (!res.ok) { toast('Failed to disconnect', 'error'); return; }
        toast('Exchange disconnected', 'info');
        await loadExchangesFromAPI();
        renderExchanges();
        updateDashboardStats();
    } catch (e) { toast('Failed to disconnect exchange', 'error'); }
}

// ── Backtesting ──
function updateBtSelect() {
    const sel = document.getElementById('btStratSelect');
    sel.innerHTML = '<option value="">Select Strategies</option>' +
        state.strategies.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}

function setBtRange(el, range) {
    el.parentElement.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    const customDiv = document.getElementById('btCustomRange');
    if (range === 'custom') {
        customDiv.style.display = 'flex';
        customDiv.style.gap = '16px';
        customDiv.style.marginBottom = '16px';
    } else {
        customDiv.style.display = 'none';
    }
}

function runBacktest() {
    const sel = document.getElementById('btStratSelect');
    if (!sel.value) { toast('Select a strategy first', 'error'); return; }
    if (state.btCredits <= 0) { toast('No backtest credits remaining', 'error'); return; }

    state.btCredits--;
    document.getElementById('btCredits').textContent = `${state.btCredits}/50`;

    // Show simulated results
    document.getElementById('btEmpty').style.display = 'none';
    const results = document.getElementById('btResults');
    results.classList.add('active');

    // Random results for demo
    const ret = (Math.random() * 50 - 10).toFixed(1);
    const dd = -(Math.random() * 15 + 2).toFixed(1);
    const wr = (Math.random() * 30 + 40).toFixed(1);
    const sharpe = (Math.random() * 2 + 0.5).toFixed(2);
    const totalTrades = Math.floor(Math.random() * 100) + 20;
    const wins = Math.floor(totalTrades * (wr / 100));
    const losses = totalTrades - wins;

    document.getElementById('btReturn').textContent = (ret > 0 ? '+' : '') + ret + '%';
    document.getElementById('btReturn').className = `bt-stat-value ${ret > 0 ? 'positive' : 'negative'}`;
    document.getElementById('btDrawdown').textContent = dd + '%';
    document.getElementById('btWinRate').textContent = wr + '%';
    document.getElementById('btSharpe').textContent = sharpe;

    // Trade distribution
    document.getElementById('btWinCount').textContent = wins;
    document.getElementById('btLoseCount').textContent = losses;
    document.getElementById('btTotalTrades').textContent = totalTrades;
    document.getElementById('btWinBar').style.width = `${wr}%`;
    document.getElementById('btLoseBar').style.width = `${100 - wr}%`;

    // Key metrics
    const avgWin = (Math.random() * 200 + 50).toFixed(2);
    const avgLoss = (Math.random() * 100 + 20).toFixed(2);
    const pf = (parseFloat(avgWin) * wins / (parseFloat(avgLoss) * losses || 1)).toFixed(2);
    document.getElementById('btAvgWin').textContent = `+$${avgWin}`;
    document.getElementById('btAvgLoss').textContent = `-$${avgLoss}`;
    document.getElementById('btProfitFactor').textContent = pf;
    document.getElementById('btMaxConsecWins').textContent = Math.floor(Math.random() * 8) + 2;

    // Draw equity chart
    drawBtEquityChart(totalTrades, ret);

    toast('Backtest complete!', 'success');
}

function drawBtEquityChart(trades, totalReturn) {
    const canvas = document.getElementById('btEquityChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    const points = Math.min(trades, 60);
    const data = [0];
    for (let i = 1; i < points; i++) {
        data.push(data[i - 1] + (Math.random() - 0.4) * (parseFloat(totalReturn) / points * 3));
    }

    const maxV = Math.max(...data.map(Math.abs), 1);
    const padL = 55, padR = 10, padT = 15, padB = 25;
    const chartW = W - padL - padR, chartH = H - padT - padB;

    // Grid
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border').trim() || '#e2e8f0';
    ctx.lineWidth = 0.5;
    for (let i = 0; i <= 4; i++) {
        const y = padT + (chartH * i / 4);
        ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
        const val = (maxV - (2 * maxV * i / 4)).toFixed(0);
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#a0aec0';
        ctx.font = '10px Inter'; ctx.textAlign = 'right';
        ctx.fillText(`${val}%`, padL - 6, y + 3);
    }

    // Line
    ctx.beginPath();
    data.forEach((val, i) => {
        const x = padL + (i / (points - 1)) * chartW;
        const y = padT + ((maxV - val) / (2 * maxV)) * chartH;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    const finalVal = data[data.length - 1];
    ctx.strokeStyle = finalVal >= 0 ? '#10b981' : '#ef4444';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Fill
    ctx.lineTo(padL + chartW, padT + chartH);
    ctx.lineTo(padL, padT + chartH);
    ctx.closePath();
    const grad = ctx.createLinearGradient(0, padT, 0, padT + chartH);
    grad.addColorStop(0, finalVal >= 0 ? 'rgba(16,185,129,0.12)' : 'rgba(239,68,68,0.12)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.fill();
}

// ── Simulator (Enhanced) ──
const simState = {
    balance: 100000,
    positions: [],
    history: [],
    tradeCount: 0,
};

function updateSimPrice() {
    const sel = document.getElementById('simPair');
    const opt = sel.options[sel.selectedIndex];
    const price = parseFloat(opt.getAttribute('data-price'));
    document.getElementById('simPrice').textContent = `$${price.toLocaleString()}`;
}

function getSimCurrentPrice() {
    const sel = document.getElementById('simPair');
    const opt = sel.options[sel.selectedIndex];
    return parseFloat(opt.getAttribute('data-price'));
}

function simBuy() {
    const pair = document.getElementById('simPair').value;
    const amount = parseFloat(document.getElementById('simAmount').value) || 0;
    const leverage = parseInt(document.getElementById('simLeverage').value) || 1;
    const sl = parseFloat(document.getElementById('simSL').value) || 5;
    const tp = parseFloat(document.getElementById('simTP').value) || 10;
    const price = getSimCurrentPrice();

    if (amount <= 0 || amount > simState.balance) { toast('Invalid amount or insufficient balance', 'error'); return; }

    simState.balance -= amount;
    simState.tradeCount++;
    const pos = { id: Date.now(), pair, side: 'LONG', amount, leverage, entryPrice: price, sl, tp, time: new Date() };
    simState.positions.push(pos);
    renderSimPositions();
    updateSimDisplay();
    toast(`Paper BUY: ${pair} @ $${price.toLocaleString()} (${leverage}x)`, 'success');
}

function simSell() {
    const pair = document.getElementById('simPair').value;
    const amount = parseFloat(document.getElementById('simAmount').value) || 0;
    const leverage = parseInt(document.getElementById('simLeverage').value) || 1;
    const sl = parseFloat(document.getElementById('simSL').value) || 5;
    const tp = parseFloat(document.getElementById('simTP').value) || 10;
    const price = getSimCurrentPrice();

    if (amount <= 0 || amount > simState.balance) { toast('Invalid amount or insufficient balance', 'error'); return; }

    simState.balance -= amount;
    simState.tradeCount++;
    const pos = { id: Date.now(), pair, side: 'SHORT', amount, leverage, entryPrice: price, sl, tp, time: new Date() };
    simState.positions.push(pos);
    renderSimPositions();
    updateSimDisplay();
    toast(`Paper SELL: ${pair} @ $${price.toLocaleString()} (${leverage}x)`, 'success');
}

function simClosePosition(id) {
    const idx = simState.positions.findIndex(p => p.id === id);
    if (idx === -1) return;
    const pos = simState.positions[idx];
    const currentPrice = getSimCurrentPrice();
    const priceDiff = pos.side === 'LONG' ? currentPrice - pos.entryPrice : pos.entryPrice - currentPrice;
    const pnlPct = (priceDiff / pos.entryPrice) * 100 * pos.leverage;
    const pnlAmt = (pos.amount * pnlPct / 100);

    simState.balance += pos.amount + pnlAmt;
    simState.history.unshift({ ...pos, exitPrice: currentPrice, pnl: pnlAmt, closedAt: new Date() });
    simState.positions.splice(idx, 1);
    renderSimPositions();
    renderSimHistory();
    updateSimDisplay();
    toast(`Closed ${pos.pair} ${pos.side}: ${pnlAmt >= 0 ? '+' : ''}$${pnlAmt.toFixed(2)}`, pnlAmt >= 0 ? 'success' : 'error');
}

function simCloseAll() {
    if (simState.positions.length === 0) { toast('No positions to close', 'info'); return; }
    [...simState.positions].forEach(p => simClosePosition(p.id));
}

function renderSimPositions() {
    const container = document.getElementById('simPositions');
    const empty = document.getElementById('simPosEmpty');
    if (simState.positions.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;" id="simPosEmpty">No open positions</div>';
        return;
    }
    container.innerHTML = simState.positions.map(p => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-light);">
            <div>
                <div style="font-size:13px;font-weight:600;">${p.pair} <span style="color:${p.side === 'LONG' ? 'var(--green)' : 'var(--red)'};">${p.side}</span></div>
                <div style="font-size:11px;color:var(--text-muted);">$${p.amount.toFixed(2)} @ $${p.entryPrice.toLocaleString()} • ${p.leverage}x</div>
            </div>
            <button class="btn btn-sm btn-ghost" onclick="simClosePosition(${p.id})" style="font-size:11px;">Close</button>
        </div>
    `).join('');
}

function renderSimHistory() {
    const container = document.getElementById('simHistory');
    if (simState.history.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">No trades yet.</div>';
        return;
    }
    container.innerHTML = simState.history.map(h => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border-light);">
            <div>
                <div style="font-size:13px;font-weight:600;">${h.pair} <span style="color:${h.side === 'LONG' ? 'var(--green)' : 'var(--red)'};">${h.side}</span></div>
                <div style="font-size:11px;color:var(--text-muted);">Entry: $${h.entryPrice.toLocaleString()} → Exit: $${h.exitPrice.toLocaleString()} • ${h.leverage}x</div>
            </div>
            <div style="font-size:14px;font-weight:700;color:${h.pnl >= 0 ? 'var(--green)' : 'var(--red)'};">${h.pnl >= 0 ? '+' : ''}$${h.pnl.toFixed(2)}</div>
        </div>
    `).join('');
}

function updateSimDisplay() {
    document.getElementById('simBalance').textContent = `$${simState.balance.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
    const totalPnl = simState.history.reduce((sum, h) => sum + h.pnl, 0);
    document.getElementById('simPnl').textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}`;
    document.getElementById('simPnl').style.color = totalPnl >= 0 ? 'var(--green)' : 'var(--red)';
    document.getElementById('simTradeCount').textContent = simState.tradeCount;
}

function simClearHistory() {
    simState.history = [];
    renderSimHistory();
    toast('History cleared', 'info');
}

// ── Subscription ──
function selectPlan(plan) { toast(`${plan} plan selected — payment integration coming soon!`, 'info'); }

function switchBilling(el, period) {
    document.querySelectorAll('.billing-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    const cards = document.querySelectorAll('.pricing-price');
    const labels = { monthly: 'month', quarterly: 'quarter', yearly: 'year' };
    cards.forEach(card => {
        const price = card.getAttribute(`data-${period}`);
        if (price !== null) {
            if (price === '0') card.innerHTML = `Free <span>/ forever</span>`;
            else card.innerHTML = `$${price} <span>/ ${labels[period]}</span>`;
        }
    });
}

function toggleFaq(el) {
    const item = el.closest('.faq-item');
    const wasOpen = item.classList.contains('open');
    // Close all
    document.querySelectorAll('.faq-item').forEach(f => f.classList.remove('open'));
    // Toggle current
    if (!wasOpen) item.classList.add('open');
}

// ── Reports Page ──
function switchReportTab(el, tab) {
    document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.report-tab-content').forEach(c => c.classList.remove('active'));
    if (tab === 'report') document.getElementById('reportTabReport').classList.add('active');
    else document.getElementById('reportTabLogs').classList.add('active');
}

function setReportMode(el, mode) {
    el.parentElement.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}

function getReports() {
    const from = document.getElementById('rptDateFrom').value;
    const to = document.getElementById('rptDateTo').value;
    // Generate demo data
    const trades = Math.floor(Math.random() * 50) + 10;
    const wins = Math.floor(trades * (0.4 + Math.random() * 0.3));
    const losses = trades - wins;
    const netPnl = ((Math.random() * 2000) - 500).toFixed(2);
    const brokerage = (trades * 1.50).toFixed(2);
    const mtm = (parseFloat(netPnl) + parseFloat(brokerage)).toFixed(2);

    document.getElementById('rptMTM').textContent = `$${mtm}`;
    document.getElementById('rptBrokerage').textContent = `$${brokerage}`;
    document.getElementById('rptNetPnl').textContent = `$${netPnl}`;
    document.getElementById('rptNetPnl').style.color = netPnl >= 0 ? 'var(--green)' : 'var(--red)';
    document.getElementById('rptTotalTrades').textContent = trades;
    document.getElementById('rptWinTrades').textContent = wins;
    document.getElementById('rptLoseTrades').textContent = losses;
    document.getElementById('rptTradeCount').textContent = `${trades} trades`;

    // Generate trade rows
    const pairs = ['BTC/USDT', 'ETH/USDT', 'SOL/USDT', 'BNB/USDT', 'XRP/USDT', 'ADA/USDT'];
    const stratNames = ['MA Crossover', 'RSI Swing', 'SOL Momentum', 'DCA Weekly', 'Breakout', 'Grid Bot'];
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    for (let i = 0; i < Math.min(trades, 20); i++) {
        const date = new Date(Date.now() - Math.random() * 30 * 86400000);
        const pair = pairs[Math.floor(Math.random() * pairs.length)];
        const strat = stratNames[Math.floor(Math.random() * stratNames.length)];
        const action = Math.random() > 0.5 ? 'BUY' : 'SELL';
        const qty = (Math.random() * 5 + 0.01).toFixed(4);
        const buyP = (20000 + Math.random() * 80000).toFixed(2);
        const sellP = (parseFloat(buyP) * (0.95 + Math.random() * 0.1)).toFixed(2);
        const pnl = (parseFloat(sellP) - parseFloat(buyP)).toFixed(2);
        const won = pnl >= 0;
        tbody.innerHTML += `<tr>
            <td>${date.toLocaleDateString()}</td>
            <td>${strat}</td>
            <td>${pair}</td>
            <td><span style="color:${action === 'BUY' ? 'var(--green)' : 'var(--red)'}; font-weight:600;">${action}</span></td>
            <td>${qty}</td>
            <td>$${buyP}</td>
            <td>$${sellP}</td>
            <td style="color:${won ? 'var(--green)' : 'var(--red)'}; font-weight:600;">${won ? '+' : ''}$${pnl}</td>
            <td><span class="strat-status ${won ? 'running' : 'stopped'}" style="font-size:11px;padding:3px 10px;border-radius:12px;">${won ? 'Win' : 'Loss'}</span></td>
        </tr>`;
    }

    drawDonutChart();
    drawPnlChart();
    toast('Reports generated!', 'success');
}

function drawDonutChart() {
    const canvas = document.getElementById('strategyDonutChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const cx = W / 2, cy = H / 2, r = 80, inner = 50;

    ctx.clearRect(0, 0, W, H);

    const stratNames = state.strategies.length > 0
        ? state.strategies.map(s => s.name)
        : ['MA Crossover', 'RSI Swing', 'SOL Momentum', 'Grid Bot'];
    const colors = ['#4361ee', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4'];
    const data = stratNames.map(() => Math.random() * 100 + 10);
    const total = data.reduce((a, b) => a + b, 0);

    let startAngle = -Math.PI / 2;
    data.forEach((val, i) => {
        const sliceAngle = (val / total) * 2 * Math.PI;
        ctx.beginPath();
        ctx.arc(cx, cy, r, startAngle, startAngle + sliceAngle);
        ctx.arc(cx, cy, inner, startAngle + sliceAngle, startAngle, true);
        ctx.closePath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        startAngle += sliceAngle;
    });

    // Center text
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary').trim() || '#1a202c';
    ctx.font = '700 18px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(stratNames.length, cx, cy - 8);
    ctx.font = '400 11px Inter';
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#a0aec0';
    ctx.fillText('Strategies', cx, cy + 10);

    // Legend
    const legend = document.getElementById('donutLegend');
    legend.innerHTML = stratNames.map((name, i) =>
        `<div class="legend-item"><span class="legend-dot" style="background:${colors[i % colors.length]};"></span> ${name} (${((data[i] / total) * 100).toFixed(0)}%)</div>`
    ).join('');
}

function drawPnlChart() {
    const canvas = document.getElementById('pnlLineChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    const points = 30;
    const data = [];
    let cumPnl = 0;
    for (let i = 0; i < points; i++) {
        cumPnl += (Math.random() - 0.4) * 100;
        data.push(cumPnl);
    }

    const maxV = Math.max(...data.map(Math.abs), 1);
    const padL = 50, padR = 10, padT = 20, padB = 30;
    const chartW = W - padL - padR;
    const chartH = H - padT - padB;

    // Grid lines
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border').trim() || '#e2e8f0';
    ctx.lineWidth = 0.5;
    for (let i = 0; i <= 4; i++) {
        const y = padT + (chartH * i / 4);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(W - padR, y);
        ctx.stroke();
        const label = (maxV - (2 * maxV * i / 4)).toFixed(0);
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#a0aec0';
        ctx.font = '10px Inter';
        ctx.textAlign = 'right';
        ctx.fillText(`$${label}`, padL - 6, y + 3);
    }

    // Draw line
    ctx.beginPath();
    data.forEach((val, i) => {
        const x = padL + (i / (points - 1)) * chartW;
        const y = padT + ((maxV - val) / (2 * maxV)) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.strokeStyle = '#4361ee';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Fill area under line
    const lastX = padL + chartW;
    const lastY = padT + ((maxV - data[data.length - 1]) / (2 * maxV)) * chartH;
    ctx.lineTo(lastX, padT + chartH);
    ctx.lineTo(padL, padT + chartH);
    ctx.closePath();
    const gradient = ctx.createLinearGradient(0, padT, 0, padT + chartH);
    gradient.addColorStop(0, 'rgba(67, 97, 238, 0.15)');
    gradient.addColorStop(1, 'rgba(67, 97, 238, 0.01)');
    ctx.fillStyle = gradient;
    ctx.fill();

    // X-axis labels
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#a0aec0';
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    for (let i = 0; i < points; i += 5) {
        const x = padL + (i / (points - 1)) * chartW;
        const d = new Date(Date.now() - (points - i) * 86400000);
        ctx.fillText(`${d.getMonth() + 1}/${d.getDate()}`, x, H - 8);
    }
}

function exportReports() {
    const rows = document.querySelectorAll('#reportTableBody tr');
    if (rows.length === 0 || rows[0].cells.length <= 1) {
        toast('No data to export', 'error'); return;
    }
    let csv = 'Date,Strategy,Pair,Action,Qty,Buy Price,Sell Price,P&L,Status\n';
    rows.forEach(row => {
        const cells = Array.from(row.cells).map(c => c.textContent.trim());
        csv += cells.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'pumpiq_report.csv'; a.click();
    URL.revokeObjectURL(url);
    toast('Report exported!', 'success');
}

// Trade Engine Logs
function getEngineLogs() {
    const container = document.getElementById('engineLogContainer');
    const logTypes = [
        { severity: 'info', messages: ['Strategy "MA Crossover" initialized', 'Connected to Binance API', 'Market data feed active', 'Portfolio sync complete', 'Risk limits loaded'] },
        { severity: 'trade', messages: ['BUY 0.05 BTC @ $96,432.50', 'SELL 2.5 ETH @ $3,412.80', 'BUY 10 SOL @ $142.55', 'Limit order placed: SELL 0.1 BTC @ $98,000', 'DCA order executed: BUY 0.002 BTC'] },
        { severity: 'warn', messages: ['High volatility detected on ETH/USDT', 'Approaching daily loss limit (80%)', 'API rate limit warning (90%)', 'Slippage exceeded 0.5% on last trade', 'Low liquidity on ARB/USDT pair'] },
        { severity: 'error', messages: ['Order rejected: Insufficient balance', 'Exchange API timeout (retry 1/3)', 'Strategy paused: Max drawdown reached', 'WebSocket disconnected, reconnecting...'] },
    ];

    container.innerHTML = '';
    const numLogs = 25 + Math.floor(Math.random() * 15);
    for (let i = 0; i < numLogs; i++) {
        const typeIdx = Math.random() < 0.4 ? 0 : Math.random() < 0.65 ? 1 : Math.random() < 0.85 ? 2 : 3;
        const type = logTypes[typeIdx];
        const msg = type.messages[Math.floor(Math.random() * type.messages.length)];
        const time = new Date(Date.now() - i * (Math.random() * 300000 + 60000));
        container.innerHTML += `
            <div class="engine-log-entry ${type.severity}">
                <span class="log-time">${time.toLocaleTimeString()}</span>
                <span class="log-severity ${type.severity}">${type.severity.toUpperCase()}</span>
                <span class="log-message">${msg}</span>
            </div>`;
    }
    toast('Engine logs loaded', 'success');
}

function clearLogs() {
    document.getElementById('engineLogContainer').innerHTML = `
        <div class="engine-log-entry info">
            <span class="log-time">${new Date().toLocaleTimeString()}</span>
            <span class="log-severity info">INFO</span>
            <span class="log-message">Logs cleared.</span>
        </div>`;
    toast('Logs cleared', 'info');
}

function exportLogs() {
    const entries = document.querySelectorAll('.engine-log-entry');
    let csv = 'Time,Severity,Message\n';
    entries.forEach(e => {
        const time = e.querySelector('.log-time').textContent;
        const sev = e.querySelector('.log-severity').textContent;
        const msg = e.querySelector('.log-message').textContent;
        csv += `"${time}","${sev}","${msg}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'pumpiq_engine_logs.csv'; a.click();
    URL.revokeObjectURL(url);
    toast('Logs exported!', 'success');
}

function initReportDefaults() {
    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setMonth(monthAgo.getMonth() - 1);
    const fmt = d => d.toISOString().split('T')[0];
    document.getElementById('rptDateFrom').value = fmt(monthAgo);
    document.getElementById('rptDateTo').value = fmt(today);
    document.getElementById('logDateFrom').value = fmt(monthAgo);
    document.getElementById('logDateTo').value = fmt(today);

    // Populate exchange select in reports
    const sel = document.getElementById('rptExchangeSelect');
    state.exchanges.forEach(ex => {
        const opt = document.createElement('option');
        opt.value = ex.name; opt.textContent = ex.name;
        sel.appendChild(opt);
    });
}

// ── Modals ──
function openModal(id) {
    document.getElementById(id).classList.add('active');
}
function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});

// ── Toast ──
function toast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = message;
    container.appendChild(el);
    setTimeout(() => el.remove(), 4000);
}
</script>

</body>
</html>
